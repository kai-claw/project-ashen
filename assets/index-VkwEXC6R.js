(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const Cd="182",x0=0,Mu=1,b0=2,ml=1,Wf=2,Do=3,Xs=0,wi=1,lt=2,qs=0,ta=1,ui=2,Su=3,Tu=4,w0=5,Kn=100,_0=101,M0=102,S0=103,T0=104,E0=200,C0=201,A0=202,R0=203,xh=204,bh=205,I0=206,k0=207,P0=208,D0=209,L0=210,O0=211,N0=212,B0=213,z0=214,wh=0,_h=1,Mh=2,Wa=3,Sh=4,Th=5,Eh=6,Ch=7,Vf=0,F0=1,U0=2,Ws=0,Hl=1,Ad=2,Rd=3,Id=4,kd=5,Pd=6,Dd=7,Eu="attached",G0="detached",$f=300,aa=301,Va=302,Ah=303,Rh=304,ql=306,Ys=1e3,Us=1001,Al=1002,xi=1003,Xf=1004,Lo=1005,bi=1006,gl=1007,un=1008,ls=1009,Yf=1010,Qf=1011,Qo=1012,Ld=1013,Qs=1014,vs=1015,cs=1016,Od=1017,Nd=1018,jo=1020,jf=35902,Kf=35899,Zf=1021,Jf=1022,xs=1023,yn=1026,ea=1027,Bd=1028,zd=1029,$a=1030,Fd=1031,Ud=1033,yl=33776,vl=33777,xl=33778,bl=33779,Ih=35840,kh=35841,Ph=35842,Dh=35843,Lh=36196,Oh=37492,Nh=37496,Bh=37488,zh=37489,Fh=37490,Uh=37491,Gh=37808,Hh=37809,qh=37810,Wh=37811,Vh=37812,$h=37813,Xh=37814,Yh=37815,Qh=37816,jh=37817,Kh=37818,Zh=37819,Jh=37820,ed=37821,td=36492,id=36494,sd=36495,nd=36283,ad=36284,od=36285,rd=36286,em=2200,tm=2201,H0=2202,Ko=2300,Zo=2301,sc=2302,Ua=2400,Ga=2401,Rl=2402,Gd=2500,q0=2501,W0=0,im=1,ld=2,V0=3200,sm=0,$0=1,In="",pi="srgb",zi="srgb-linear",Il="linear",Gt="srgb",ua=7680,Cu=519,X0=512,Y0=513,Q0=514,Hd=515,j0=516,K0=517,qd=518,Z0=519,cd=35044,Au="300 es",Gs=2e3,kl=2001;function nm(l){for(let e=l.length-1;e>=0;--e)if(l[e]>=65535)return!0;return!1}function J0(l){return ArrayBuffer.isView(l)&&!(l instanceof DataView)}function Jo(l){return document.createElementNS("http://www.w3.org/1999/xhtml",l)}function eg(){const l=Jo("canvas");return l.style.display="block",l}const Ru={};function Pl(...l){const e="THREE."+l.shift();console.log(e,...l)}function Qe(...l){const e="THREE."+l.shift();console.warn(e,...l)}function rt(...l){const e="THREE."+l.shift();console.error(e,...l)}function er(...l){const e=l.join(" ");e in Ru||(Ru[e]=!0,Qe(...l))}function tg(l,e,t){return new Promise(function(i,s){function n(){switch(l.clientWaitSync(e,l.SYNC_FLUSH_COMMANDS_BIT,0)){case l.WAIT_FAILED:s();break;case l.TIMEOUT_EXPIRED:setTimeout(n,t);break;default:i()}}setTimeout(n,t)})}class la{addEventListener(e,t){this._listeners===void 0&&(this._listeners={});const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){const i=this._listeners;return i===void 0?!1:i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){const i=this._listeners;if(i===void 0)return;const s=i[e];if(s!==void 0){const n=s.indexOf(t);n!==-1&&s.splice(n,1)}}dispatchEvent(e){const t=this._listeners;if(t===void 0)return;const i=t[e.type];if(i!==void 0){e.target=this;const s=i.slice(0);for(let n=0,a=s.length;n<a;n++)s[n].call(this,e);e.target=null}}}const ki=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let Iu=1234567;const Uo=Math.PI/180,Xa=180/Math.PI;function bs(){const l=Math.random()*4294967295|0,e=Math.random()*4294967295|0,t=Math.random()*4294967295|0,i=Math.random()*4294967295|0;return(ki[l&255]+ki[l>>8&255]+ki[l>>16&255]+ki[l>>24&255]+"-"+ki[e&255]+ki[e>>8&255]+"-"+ki[e>>16&15|64]+ki[e>>24&255]+"-"+ki[t&63|128]+ki[t>>8&255]+"-"+ki[t>>16&255]+ki[t>>24&255]+ki[i&255]+ki[i>>8&255]+ki[i>>16&255]+ki[i>>24&255]).toLowerCase()}function St(l,e,t){return Math.max(e,Math.min(t,l))}function Wd(l,e){return(l%e+e)%e}function ig(l,e,t,i,s){return i+(l-e)*(s-i)/(t-e)}function sg(l,e,t){return l!==e?(t-l)/(e-l):0}function Go(l,e,t){return(1-t)*l+t*e}function ng(l,e,t,i){return Go(l,e,1-Math.exp(-t*i))}function ag(l,e=1){return e-Math.abs(Wd(l,e*2)-e)}function og(l,e,t){return l<=e?0:l>=t?1:(l=(l-e)/(t-e),l*l*(3-2*l))}function rg(l,e,t){return l<=e?0:l>=t?1:(l=(l-e)/(t-e),l*l*l*(l*(l*6-15)+10))}function lg(l,e){return l+Math.floor(Math.random()*(e-l+1))}function cg(l,e){return l+Math.random()*(e-l)}function hg(l){return l*(.5-Math.random())}function dg(l){l!==void 0&&(Iu=l);let e=Iu+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}function ug(l){return l*Uo}function pg(l){return l*Xa}function fg(l){return(l&l-1)===0&&l!==0}function mg(l){return Math.pow(2,Math.ceil(Math.log(l)/Math.LN2))}function gg(l){return Math.pow(2,Math.floor(Math.log(l)/Math.LN2))}function yg(l,e,t,i,s){const n=Math.cos,a=Math.sin,o=n(t/2),r=a(t/2),c=n((e+i)/2),h=a((e+i)/2),d=n((e-i)/2),u=a((e-i)/2),p=n((i-e)/2),f=a((i-e)/2);switch(s){case"XYX":l.set(o*h,r*d,r*u,o*c);break;case"YZY":l.set(r*u,o*h,r*d,o*c);break;case"ZXZ":l.set(r*d,r*u,o*h,o*c);break;case"XZX":l.set(o*h,r*f,r*p,o*c);break;case"YXY":l.set(r*p,o*h,r*f,o*c);break;case"ZYZ":l.set(r*f,r*p,o*h,o*c);break;default:Qe("MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+s)}}function Es(l,e){switch(e.constructor){case Float32Array:return l;case Uint32Array:return l/4294967295;case Uint16Array:return l/65535;case Uint8Array:return l/255;case Int32Array:return Math.max(l/2147483647,-1);case Int16Array:return Math.max(l/32767,-1);case Int8Array:return Math.max(l/127,-1);default:throw new Error("Invalid component type.")}}function Vt(l,e){switch(e.constructor){case Float32Array:return l;case Uint32Array:return Math.round(l*4294967295);case Uint16Array:return Math.round(l*65535);case Uint8Array:return Math.round(l*255);case Int32Array:return Math.round(l*2147483647);case Int16Array:return Math.round(l*32767);case Int8Array:return Math.round(l*127);default:throw new Error("Invalid component type.")}}const gt={DEG2RAD:Uo,RAD2DEG:Xa,generateUUID:bs,clamp:St,euclideanModulo:Wd,mapLinear:ig,inverseLerp:sg,lerp:Go,damp:ng,pingpong:ag,smoothstep:og,smootherstep:rg,randInt:lg,randFloat:cg,randFloatSpread:hg,seededRandom:dg,degToRad:ug,radToDeg:pg,isPowerOfTwo:fg,ceilPowerOfTwo:mg,floorPowerOfTwo:gg,setQuaternionFromProperEuler:yg,normalize:Vt,denormalize:Es};class le{constructor(e=0,t=0){le.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,i=this.y,s=e.elements;return this.x=s[0]*t+s[3]*i+s[6],this.y=s[1]*t+s[4]*i+s[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=St(this.x,e.x,t.x),this.y=St(this.y,e.y,t.y),this}clampScalar(e,t){return this.x=St(this.x,e,t),this.y=St(this.y,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(St(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(t===0)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(St(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y;return t*t+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const i=Math.cos(t),s=Math.sin(t),n=this.x-e.x,a=this.y-e.y;return this.x=n*i-a*s+e.x,this.y=n*s+a*i+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Cs{constructor(e=0,t=0,i=0,s=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=i,this._w=s}static slerpFlat(e,t,i,s,n,a,o){let r=i[s+0],c=i[s+1],h=i[s+2],d=i[s+3],u=n[a+0],p=n[a+1],f=n[a+2],y=n[a+3];if(o<=0){e[t+0]=r,e[t+1]=c,e[t+2]=h,e[t+3]=d;return}if(o>=1){e[t+0]=u,e[t+1]=p,e[t+2]=f,e[t+3]=y;return}if(d!==y||r!==u||c!==p||h!==f){let m=r*u+c*p+h*f+d*y;m<0&&(u=-u,p=-p,f=-f,y=-y,m=-m);let g=1-o;if(m<.9995){const x=Math.acos(m),v=Math.sin(x);g=Math.sin(g*x)/v,o=Math.sin(o*x)/v,r=r*g+u*o,c=c*g+p*o,h=h*g+f*o,d=d*g+y*o}else{r=r*g+u*o,c=c*g+p*o,h=h*g+f*o,d=d*g+y*o;const x=1/Math.sqrt(r*r+c*c+h*h+d*d);r*=x,c*=x,h*=x,d*=x}}e[t]=r,e[t+1]=c,e[t+2]=h,e[t+3]=d}static multiplyQuaternionsFlat(e,t,i,s,n,a){const o=i[s],r=i[s+1],c=i[s+2],h=i[s+3],d=n[a],u=n[a+1],p=n[a+2],f=n[a+3];return e[t]=o*f+h*d+r*p-c*u,e[t+1]=r*f+h*u+c*d-o*p,e[t+2]=c*f+h*p+o*u-r*d,e[t+3]=h*f-o*d-r*u-c*p,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,i,s){return this._x=e,this._y=t,this._z=i,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const i=e._x,s=e._y,n=e._z,a=e._order,o=Math.cos,r=Math.sin,c=o(i/2),h=o(s/2),d=o(n/2),u=r(i/2),p=r(s/2),f=r(n/2);switch(a){case"XYZ":this._x=u*h*d+c*p*f,this._y=c*p*d-u*h*f,this._z=c*h*f+u*p*d,this._w=c*h*d-u*p*f;break;case"YXZ":this._x=u*h*d+c*p*f,this._y=c*p*d-u*h*f,this._z=c*h*f-u*p*d,this._w=c*h*d+u*p*f;break;case"ZXY":this._x=u*h*d-c*p*f,this._y=c*p*d+u*h*f,this._z=c*h*f+u*p*d,this._w=c*h*d-u*p*f;break;case"ZYX":this._x=u*h*d-c*p*f,this._y=c*p*d+u*h*f,this._z=c*h*f-u*p*d,this._w=c*h*d+u*p*f;break;case"YZX":this._x=u*h*d+c*p*f,this._y=c*p*d+u*h*f,this._z=c*h*f-u*p*d,this._w=c*h*d-u*p*f;break;case"XZY":this._x=u*h*d-c*p*f,this._y=c*p*d-u*h*f,this._z=c*h*f+u*p*d,this._w=c*h*d+u*p*f;break;default:Qe("Quaternion: .setFromEuler() encountered an unknown order: "+a)}return t===!0&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const i=t/2,s=Math.sin(i);return this._x=e.x*s,this._y=e.y*s,this._z=e.z*s,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,i=t[0],s=t[4],n=t[8],a=t[1],o=t[5],r=t[9],c=t[2],h=t[6],d=t[10],u=i+o+d;if(u>0){const p=.5/Math.sqrt(u+1);this._w=.25/p,this._x=(h-r)*p,this._y=(n-c)*p,this._z=(a-s)*p}else if(i>o&&i>d){const p=2*Math.sqrt(1+i-o-d);this._w=(h-r)/p,this._x=.25*p,this._y=(s+a)/p,this._z=(n+c)/p}else if(o>d){const p=2*Math.sqrt(1+o-i-d);this._w=(n-c)/p,this._x=(s+a)/p,this._y=.25*p,this._z=(r+h)/p}else{const p=2*Math.sqrt(1+d-i-o);this._w=(a-s)/p,this._x=(n+c)/p,this._y=(r+h)/p,this._z=.25*p}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let i=e.dot(t)+1;return i<1e-8?(i=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=i):(this._x=0,this._y=-e.z,this._z=e.y,this._w=i)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=i),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(St(this.dot(e),-1,1)))}rotateTowards(e,t){const i=this.angleTo(e);if(i===0)return this;const s=Math.min(1,t/i);return this.slerp(e,s),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return e===0?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const i=e._x,s=e._y,n=e._z,a=e._w,o=t._x,r=t._y,c=t._z,h=t._w;return this._x=i*h+a*o+s*c-n*r,this._y=s*h+a*r+n*o-i*c,this._z=n*h+a*c+i*r-s*o,this._w=a*h-i*o-s*r-n*c,this._onChangeCallback(),this}slerp(e,t){if(t<=0)return this;if(t>=1)return this.copy(e);let i=e._x,s=e._y,n=e._z,a=e._w,o=this.dot(e);o<0&&(i=-i,s=-s,n=-n,a=-a,o=-o);let r=1-t;if(o<.9995){const c=Math.acos(o),h=Math.sin(c);r=Math.sin(r*c)/h,t=Math.sin(t*c)/h,this._x=this._x*r+i*t,this._y=this._y*r+s*t,this._z=this._z*r+n*t,this._w=this._w*r+a*t,this._onChangeCallback()}else this._x=this._x*r+i*t,this._y=this._y*r+s*t,this._z=this._z*r+n*t,this._w=this._w*r+a*t,this.normalize();return this}slerpQuaternions(e,t,i){return this.copy(e).slerp(t,i)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),i=Math.random(),s=Math.sqrt(1-i),n=Math.sqrt(i);return this.set(s*Math.sin(e),s*Math.cos(e),n*Math.sin(t),n*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class T{constructor(e=0,t=0,i=0){T.prototype.isVector3=!0,this.x=e,this.y=t,this.z=i}set(e,t,i){return i===void 0&&(i=this.z),this.x=e,this.y=t,this.z=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(ku.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(ku.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,i=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[3]*i+n[6]*s,this.y=n[1]*t+n[4]*i+n[7]*s,this.z=n[2]*t+n[5]*i+n[8]*s,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,i=this.y,s=this.z,n=e.elements,a=1/(n[3]*t+n[7]*i+n[11]*s+n[15]);return this.x=(n[0]*t+n[4]*i+n[8]*s+n[12])*a,this.y=(n[1]*t+n[5]*i+n[9]*s+n[13])*a,this.z=(n[2]*t+n[6]*i+n[10]*s+n[14])*a,this}applyQuaternion(e){const t=this.x,i=this.y,s=this.z,n=e.x,a=e.y,o=e.z,r=e.w,c=2*(a*s-o*i),h=2*(o*t-n*s),d=2*(n*i-a*t);return this.x=t+r*c+a*d-o*h,this.y=i+r*h+o*c-n*d,this.z=s+r*d+n*h-a*c,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,i=this.y,s=this.z,n=e.elements;return this.x=n[0]*t+n[4]*i+n[8]*s,this.y=n[1]*t+n[5]*i+n[9]*s,this.z=n[2]*t+n[6]*i+n[10]*s,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=St(this.x,e.x,t.x),this.y=St(this.y,e.y,t.y),this.z=St(this.z,e.z,t.z),this}clampScalar(e,t){return this.x=St(this.x,e,t),this.y=St(this.y,e,t),this.z=St(this.z,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(St(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const i=e.x,s=e.y,n=e.z,a=t.x,o=t.y,r=t.z;return this.x=s*r-n*o,this.y=n*a-i*r,this.z=i*o-s*a,this}projectOnVector(e){const t=e.lengthSq();if(t===0)return this.set(0,0,0);const i=e.dot(this)/t;return this.copy(e).multiplyScalar(i)}projectOnPlane(e){return nc.copy(this).projectOnVector(e),this.sub(nc)}reflect(e){return this.sub(nc.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(t===0)return Math.PI/2;const i=this.dot(e)/t;return Math.acos(St(i,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,i=this.y-e.y,s=this.z-e.z;return t*t+i*i+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,i){const s=Math.sin(t)*e;return this.x=s*Math.sin(i),this.y=Math.cos(t)*e,this.z=s*Math.cos(i),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,i){return this.x=e*Math.sin(t),this.y=i,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),s=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=s,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,t*4)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,t*3)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=Math.random()*2-1,i=Math.sqrt(1-t*t);return this.x=i*Math.cos(e),this.y=t,this.z=i*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const nc=new T,ku=new Cs;class yt{constructor(e,t,i,s,n,a,o,r,c){yt.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],e!==void 0&&this.set(e,t,i,s,n,a,o,r,c)}set(e,t,i,s,n,a,o,r,c){const h=this.elements;return h[0]=e,h[1]=s,h[2]=o,h[3]=t,h[4]=n,h[5]=r,h[6]=i,h[7]=a,h[8]=c,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this}extractBasis(e,t,i){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,s=t.elements,n=this.elements,a=i[0],o=i[3],r=i[6],c=i[1],h=i[4],d=i[7],u=i[2],p=i[5],f=i[8],y=s[0],m=s[3],g=s[6],x=s[1],v=s[4],b=s[7],_=s[2],S=s[5],A=s[8];return n[0]=a*y+o*x+r*_,n[3]=a*m+o*v+r*S,n[6]=a*g+o*b+r*A,n[1]=c*y+h*x+d*_,n[4]=c*m+h*v+d*S,n[7]=c*g+h*b+d*A,n[2]=u*y+p*x+f*_,n[5]=u*m+p*v+f*S,n[8]=u*g+p*b+f*A,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],a=e[4],o=e[5],r=e[6],c=e[7],h=e[8];return t*a*h-t*o*c-i*n*h+i*o*r+s*n*c-s*a*r}invert(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],a=e[4],o=e[5],r=e[6],c=e[7],h=e[8],d=h*a-o*c,u=o*r-h*n,p=c*n-a*r,f=t*d+i*u+s*p;if(f===0)return this.set(0,0,0,0,0,0,0,0,0);const y=1/f;return e[0]=d*y,e[1]=(s*c-h*i)*y,e[2]=(o*i-s*a)*y,e[3]=u*y,e[4]=(h*t-s*r)*y,e[5]=(s*n-o*t)*y,e[6]=p*y,e[7]=(i*r-c*t)*y,e[8]=(a*t-i*n)*y,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,i,s,n,a,o){const r=Math.cos(n),c=Math.sin(n);return this.set(i*r,i*c,-i*(r*a+c*o)+a+e,-s*c,s*r,-s*(-c*a+r*o)+o+t,0,0,1),this}scale(e,t){return this.premultiply(ac.makeScale(e,t)),this}rotate(e){return this.premultiply(ac.makeRotation(-e)),this}translate(e,t){return this.premultiply(ac.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,i,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,i=e.elements;for(let s=0;s<9;s++)if(t[s]!==i[s])return!1;return!0}fromArray(e,t=0){for(let i=0;i<9;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}clone(){return new this.constructor().fromArray(this.elements)}}const ac=new yt,Pu=new yt().set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),Du=new yt().set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function vg(){const l={enabled:!0,workingColorSpace:zi,spaces:{},convert:function(s,n,a){return this.enabled===!1||n===a||!n||!a||(this.spaces[n].transfer===Gt&&(s.r=mn(s.r),s.g=mn(s.g),s.b=mn(s.b)),this.spaces[n].primaries!==this.spaces[a].primaries&&(s.applyMatrix3(this.spaces[n].toXYZ),s.applyMatrix3(this.spaces[a].fromXYZ)),this.spaces[a].transfer===Gt&&(s.r=Ha(s.r),s.g=Ha(s.g),s.b=Ha(s.b))),s},workingToColorSpace:function(s,n){return this.convert(s,this.workingColorSpace,n)},colorSpaceToWorking:function(s,n){return this.convert(s,n,this.workingColorSpace)},getPrimaries:function(s){return this.spaces[s].primaries},getTransfer:function(s){return s===In?Il:this.spaces[s].transfer},getToneMappingMode:function(s){return this.spaces[s].outputColorSpaceConfig.toneMappingMode||"standard"},getLuminanceCoefficients:function(s,n=this.workingColorSpace){return s.fromArray(this.spaces[n].luminanceCoefficients)},define:function(s){Object.assign(this.spaces,s)},_getMatrix:function(s,n,a){return s.copy(this.spaces[n].toXYZ).multiply(this.spaces[a].fromXYZ)},_getDrawingBufferColorSpace:function(s){return this.spaces[s].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(s=this.workingColorSpace){return this.spaces[s].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(s,n){return er("ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),l.workingToColorSpace(s,n)},toWorkingColorSpace:function(s,n){return er("ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),l.colorSpaceToWorking(s,n)}},e=[.64,.33,.3,.6,.15,.06],t=[.2126,.7152,.0722],i=[.3127,.329];return l.define({[zi]:{primaries:e,whitePoint:i,transfer:Il,toXYZ:Pu,fromXYZ:Du,luminanceCoefficients:t,workingColorSpaceConfig:{unpackColorSpace:pi},outputColorSpaceConfig:{drawingBufferColorSpace:pi}},[pi]:{primaries:e,whitePoint:i,transfer:Gt,toXYZ:Pu,fromXYZ:Du,luminanceCoefficients:t,outputColorSpaceConfig:{drawingBufferColorSpace:pi}}}),l}const Rt=vg();function mn(l){return l<.04045?l*.0773993808:Math.pow(l*.9478672986+.0521327014,2.4)}function Ha(l){return l<.0031308?l*12.92:1.055*Math.pow(l,.41666)-.055}let pa;class xg{static getDataURL(e,t="image/png"){if(/^data:/i.test(e.src)||typeof HTMLCanvasElement>"u")return e.src;let i;if(e instanceof HTMLCanvasElement)i=e;else{pa===void 0&&(pa=Jo("canvas")),pa.width=e.width,pa.height=e.height;const s=pa.getContext("2d");e instanceof ImageData?s.putImageData(e,0,0):s.drawImage(e,0,0,e.width,e.height),i=pa}return i.toDataURL(t)}static sRGBToLinear(e){if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&e instanceof ImageBitmap){const t=Jo("canvas");t.width=e.width,t.height=e.height;const i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);const s=i.getImageData(0,0,e.width,e.height),n=s.data;for(let a=0;a<n.length;a++)n[a]=mn(n[a]/255)*255;return i.putImageData(s,0,0),t}else if(e.data){const t=e.data.slice(0);for(let i=0;i<t.length;i++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[i]=Math.floor(mn(t[i]/255)*255):t[i]=mn(t[i]);return{data:t,width:e.width,height:e.height}}else return Qe("ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let bg=0;class Vd{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:bg++}),this.uuid=bs(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){const t=this.data;return typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement?e.set(t.videoWidth,t.videoHeight,0):typeof VideoFrame<"u"&&t instanceof VideoFrame?e.set(t.displayHeight,t.displayWidth,0):t!==null?e.set(t.width,t.height,t.depth||0):e.set(0,0,0),e}set needsUpdate(e){e===!0&&this.version++}toJSON(e){const t=e===void 0||typeof e=="string";if(!t&&e.images[this.uuid]!==void 0)return e.images[this.uuid];const i={uuid:this.uuid,url:""},s=this.data;if(s!==null){let n;if(Array.isArray(s)){n=[];for(let a=0,o=s.length;a<o;a++)s[a].isDataTexture?n.push(oc(s[a].image)):n.push(oc(s[a]))}else n=oc(s);i.url=n}return t||(e.images[this.uuid]=i),i}}function oc(l){return typeof HTMLImageElement<"u"&&l instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&l instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&l instanceof ImageBitmap?xg.getDataURL(l):l.data?{data:Array.from(l.data),width:l.width,height:l.height,type:l.data.constructor.name}:(Qe("Texture: Unable to serialize Texture."),{})}let wg=0;const rc=new T;class _i extends la{constructor(e=_i.DEFAULT_IMAGE,t=_i.DEFAULT_MAPPING,i=Us,s=Us,n=bi,a=un,o=xs,r=ls,c=_i.DEFAULT_ANISOTROPY,h=In){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:wg++}),this.uuid=bs(),this.name="",this.source=new Vd(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=i,this.wrapT=s,this.magFilter=n,this.minFilter=a,this.anisotropy=c,this.format=o,this.internalFormat=null,this.type=r,this.offset=new le(0,0),this.repeat=new le(1,1),this.center=new le(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new yt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=h,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(e&&e.depth&&e.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(rc).x}get height(){return this.source.getSize(rc).y}get depth(){return this.source.getSize(rc).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return new this.constructor().copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(const t in e){const i=e[t];if(i===void 0){Qe(`Texture.setValues(): parameter '${t}' has value of undefined.`);continue}const s=this[t];if(s===void 0){Qe(`Texture.setValues(): property '${t}' does not exist.`);continue}s&&i&&s.isVector2&&i.isVector2||s&&i&&s.isVector3&&i.isVector3||s&&i&&s.isMatrix3&&i.isMatrix3?s.copy(i):this[t]=i}}toJSON(e){const t=e===void 0||typeof e=="string";if(!t&&e.textures[this.uuid]!==void 0)return e.textures[this.uuid];const i={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),t||(e.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==$f)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case Ys:e.x=e.x-Math.floor(e.x);break;case Us:e.x=e.x<0?0:1;break;case Al:Math.abs(Math.floor(e.x)%2)===1?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x);break}if(e.y<0||e.y>1)switch(this.wrapT){case Ys:e.y=e.y-Math.floor(e.y);break;case Us:e.y=e.y<0?0:1;break;case Al:Math.abs(Math.floor(e.y)%2)===1?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y);break}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){e===!0&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){e===!0&&this.pmremVersion++}}_i.DEFAULT_IMAGE=null;_i.DEFAULT_MAPPING=$f;_i.DEFAULT_ANISOTROPY=1;class ni{constructor(e=0,t=0,i=0,s=1){ni.prototype.isVector4=!0,this.x=e,this.y=t,this.z=i,this.w=s}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==void 0?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,i=this.y,s=this.z,n=this.w,a=e.elements;return this.x=a[0]*t+a[4]*i+a[8]*s+a[12]*n,this.y=a[1]*t+a[5]*i+a[9]*s+a[13]*n,this.z=a[2]*t+a[6]*i+a[10]*s+a[14]*n,this.w=a[3]*t+a[7]*i+a[11]*s+a[15]*n,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,i,s,n;const r=e.elements,c=r[0],h=r[4],d=r[8],u=r[1],p=r[5],f=r[9],y=r[2],m=r[6],g=r[10];if(Math.abs(h-u)<.01&&Math.abs(d-y)<.01&&Math.abs(f-m)<.01){if(Math.abs(h+u)<.1&&Math.abs(d+y)<.1&&Math.abs(f+m)<.1&&Math.abs(c+p+g-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;const v=(c+1)/2,b=(p+1)/2,_=(g+1)/2,S=(h+u)/4,A=(d+y)/4,R=(f+m)/4;return v>b&&v>_?v<.01?(i=0,s=.707106781,n=.707106781):(i=Math.sqrt(v),s=S/i,n=A/i):b>_?b<.01?(i=.707106781,s=0,n=.707106781):(s=Math.sqrt(b),i=S/s,n=R/s):_<.01?(i=.707106781,s=.707106781,n=0):(n=Math.sqrt(_),i=A/n,s=R/n),this.set(i,s,n,t),this}let x=Math.sqrt((m-f)*(m-f)+(d-y)*(d-y)+(u-h)*(u-h));return Math.abs(x)<.001&&(x=1),this.x=(m-f)/x,this.y=(d-y)/x,this.z=(u-h)/x,this.w=Math.acos((c+p+g-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=St(this.x,e.x,t.x),this.y=St(this.y,e.y,t.y),this.z=St(this.z,e.z,t.z),this.w=St(this.w,e.w,t.w),this}clampScalar(e,t){return this.x=St(this.x,e,t),this.y=St(this.y,e,t),this.z=St(this.z,e,t),this.w=St(this.w,e,t),this}clampLength(e,t){const i=this.length();return this.divideScalar(i||1).multiplyScalar(St(i,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,i){return this.x=e.x+(t.x-e.x)*i,this.y=e.y+(t.y-e.y)*i,this.z=e.z+(t.z-e.z)*i,this.w=e.w+(t.w-e.w)*i,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class _g extends la{constructor(e=1,t=1,i={}){super(),i=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:bi,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},i),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=i.depth,this.scissor=new ni(0,0,e,t),this.scissorTest=!1,this.viewport=new ni(0,0,e,t);const s={width:e,height:t,depth:i.depth},n=new _i(s);this.textures=[];const a=i.count;for(let o=0;o<a;o++)this.textures[o]=n.clone(),this.textures[o].isRenderTargetTexture=!0,this.textures[o].renderTarget=this;this._setTextureOptions(i),this.depthBuffer=i.depthBuffer,this.stencilBuffer=i.stencilBuffer,this.resolveDepthBuffer=i.resolveDepthBuffer,this.resolveStencilBuffer=i.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=i.depthTexture,this.samples=i.samples,this.multiview=i.multiview}_setTextureOptions(e={}){const t={minFilter:bi,generateMipmaps:!1,flipY:!1,internalFormat:null};e.mapping!==void 0&&(t.mapping=e.mapping),e.wrapS!==void 0&&(t.wrapS=e.wrapS),e.wrapT!==void 0&&(t.wrapT=e.wrapT),e.wrapR!==void 0&&(t.wrapR=e.wrapR),e.magFilter!==void 0&&(t.magFilter=e.magFilter),e.minFilter!==void 0&&(t.minFilter=e.minFilter),e.format!==void 0&&(t.format=e.format),e.type!==void 0&&(t.type=e.type),e.anisotropy!==void 0&&(t.anisotropy=e.anisotropy),e.colorSpace!==void 0&&(t.colorSpace=e.colorSpace),e.flipY!==void 0&&(t.flipY=e.flipY),e.generateMipmaps!==void 0&&(t.generateMipmaps=e.generateMipmaps),e.internalFormat!==void 0&&(t.internalFormat=e.internalFormat);for(let i=0;i<this.textures.length;i++)this.textures[i].setValues(t)}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){this._depthTexture!==null&&(this._depthTexture.renderTarget=null),e!==null&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,i=1){if(this.width!==e||this.height!==t||this.depth!==i){this.width=e,this.height=t,this.depth=i;for(let s=0,n=this.textures.length;s<n;s++)this.textures[s].image.width=e,this.textures[s].image.height=t,this.textures[s].image.depth=i,this.textures[s].isData3DTexture!==!0&&(this.textures[s].isArrayTexture=this.textures[s].image.depth>1);this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return new this.constructor().copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,i=e.textures.length;t<i;t++){this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;const s=Object.assign({},e.textures[t].image);this.textures[t].source=new Vd(s)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,e.depthTexture!==null&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class ji extends _g{constructor(e=1,t=1,i={}){super(e,t,i),this.isWebGLRenderTarget=!0}}class am extends _i{constructor(e=null,t=1,i=1,s=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:i,depth:s},this.magFilter=xi,this.minFilter=xi,this.wrapR=Us,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class Mg extends _i{constructor(e=null,t=1,i=1,s=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:i,depth:s},this.magFilter=xi,this.minFilter=xi,this.wrapR=Us,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Qi{constructor(e=new T(1/0,1/0,1/0),t=new T(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t+=3)this.expandByPoint(ws.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,i=e.count;t<i;t++)this.expandByPoint(ws.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const i=ws.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(i),this.max.copy(e).add(i),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return new this.constructor().copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const i=e.geometry;if(i!==void 0){const n=i.getAttribute("position");if(t===!0&&n!==void 0&&e.isInstancedMesh!==!0)for(let a=0,o=n.count;a<o;a++)e.isMesh===!0?e.getVertexPosition(a,ws):ws.fromBufferAttribute(n,a),ws.applyMatrix4(e.matrixWorld),this.expandByPoint(ws);else e.boundingBox!==void 0?(e.boundingBox===null&&e.computeBoundingBox(),br.copy(e.boundingBox)):(i.boundingBox===null&&i.computeBoundingBox(),br.copy(i.boundingBox)),br.applyMatrix4(e.matrixWorld),this.union(br)}const s=e.children;for(let n=0,a=s.length;n<a;n++)this.expandByObject(s[n],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,ws),ws.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=-e.constant&&i>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(fo),wr.subVectors(this.max,fo),fa.subVectors(e.a,fo),ma.subVectors(e.b,fo),ga.subVectors(e.c,fo),bn.subVectors(ma,fa),wn.subVectors(ga,ma),Fn.subVectors(fa,ga);let t=[0,-bn.z,bn.y,0,-wn.z,wn.y,0,-Fn.z,Fn.y,bn.z,0,-bn.x,wn.z,0,-wn.x,Fn.z,0,-Fn.x,-bn.y,bn.x,0,-wn.y,wn.x,0,-Fn.y,Fn.x,0];return!lc(t,fa,ma,ga,wr)||(t=[1,0,0,0,1,0,0,0,1],!lc(t,fa,ma,ga,wr))?!1:(_r.crossVectors(bn,wn),t=[_r.x,_r.y,_r.z],lc(t,fa,ma,ga,wr))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,ws).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=this.getSize(ws).length()*.5),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()?this:(sn[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),sn[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),sn[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),sn[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),sn[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),sn[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),sn[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),sn[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(sn),this)}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}}const sn=[new T,new T,new T,new T,new T,new T,new T,new T],ws=new T,br=new Qi,fa=new T,ma=new T,ga=new T,bn=new T,wn=new T,Fn=new T,fo=new T,wr=new T,_r=new T,Un=new T;function lc(l,e,t,i,s){for(let n=0,a=l.length-3;n<=a;n+=3){Un.fromArray(l,n);const o=s.x*Math.abs(Un.x)+s.y*Math.abs(Un.y)+s.z*Math.abs(Un.z),r=e.dot(Un),c=t.dot(Un),h=i.dot(Un);if(Math.max(-Math.max(r,c,h),Math.min(r,c,h))>o)return!1}return!0}const Sg=new Qi,mo=new T,cc=new T;class Zs{constructor(e=new T,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const i=this.center;t!==void 0?i.copy(t):Sg.setFromPoints(e).getCenter(i);let s=0;for(let n=0,a=e.length;n<a;n++)s=Math.max(s,i.distanceToSquared(e[n]));return this.radius=Math.sqrt(s),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const i=this.center.distanceToSquared(e);return t.copy(e),i>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;mo.subVectors(e,this.center);const t=mo.lengthSq();if(t>this.radius*this.radius){const i=Math.sqrt(t),s=(i-this.radius)*.5;this.center.addScaledVector(mo,s/i),this.radius+=s}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(this.center.equals(e.center)===!0?this.radius=Math.max(this.radius,e.radius):(cc.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(mo.copy(e.center).add(cc)),this.expandByPoint(mo.copy(e.center).sub(cc))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return new this.constructor().copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}}const nn=new T,hc=new T,Mr=new T,_n=new T,dc=new T,Sr=new T,uc=new T;class Wl{constructor(e=new T,t=new T(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,nn)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const i=t.dot(this.direction);return i<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,i)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=nn.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(nn.copy(this.origin).addScaledVector(this.direction,t),nn.distanceToSquared(e))}distanceSqToSegment(e,t,i,s){hc.copy(e).add(t).multiplyScalar(.5),Mr.copy(t).sub(e).normalize(),_n.copy(this.origin).sub(hc);const n=e.distanceTo(t)*.5,a=-this.direction.dot(Mr),o=_n.dot(this.direction),r=-_n.dot(Mr),c=_n.lengthSq(),h=Math.abs(1-a*a);let d,u,p,f;if(h>0)if(d=a*r-o,u=a*o-r,f=n*h,d>=0)if(u>=-f)if(u<=f){const y=1/h;d*=y,u*=y,p=d*(d+a*u+2*o)+u*(a*d+u+2*r)+c}else u=n,d=Math.max(0,-(a*u+o)),p=-d*d+u*(u+2*r)+c;else u=-n,d=Math.max(0,-(a*u+o)),p=-d*d+u*(u+2*r)+c;else u<=-f?(d=Math.max(0,-(-a*n+o)),u=d>0?-n:Math.min(Math.max(-n,-r),n),p=-d*d+u*(u+2*r)+c):u<=f?(d=0,u=Math.min(Math.max(-n,-r),n),p=u*(u+2*r)+c):(d=Math.max(0,-(a*n+o)),u=d>0?n:Math.min(Math.max(-n,-r),n),p=-d*d+u*(u+2*r)+c);else u=a>0?-n:n,d=Math.max(0,-(a*u+o)),p=-d*d+u*(u+2*r)+c;return i&&i.copy(this.origin).addScaledVector(this.direction,d),s&&s.copy(hc).addScaledVector(Mr,u),p}intersectSphere(e,t){nn.subVectors(e.center,this.origin);const i=nn.dot(this.direction),s=nn.dot(nn)-i*i,n=e.radius*e.radius;if(s>n)return null;const a=Math.sqrt(n-s),o=i-a,r=i+a;return r<0?null:o<0?this.at(r,t):this.at(o,t)}intersectsSphere(e){return e.radius<0?!1:this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(t===0)return e.distanceToPoint(this.origin)===0?0:null;const i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null}intersectPlane(e,t){const i=this.distanceToPlane(e);return i===null?null:this.at(i,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);return t===0||e.normal.dot(this.direction)*t<0}intersectBox(e,t){let i,s,n,a,o,r;const c=1/this.direction.x,h=1/this.direction.y,d=1/this.direction.z,u=this.origin;return c>=0?(i=(e.min.x-u.x)*c,s=(e.max.x-u.x)*c):(i=(e.max.x-u.x)*c,s=(e.min.x-u.x)*c),h>=0?(n=(e.min.y-u.y)*h,a=(e.max.y-u.y)*h):(n=(e.max.y-u.y)*h,a=(e.min.y-u.y)*h),i>a||n>s||((n>i||isNaN(i))&&(i=n),(a<s||isNaN(s))&&(s=a),d>=0?(o=(e.min.z-u.z)*d,r=(e.max.z-u.z)*d):(o=(e.max.z-u.z)*d,r=(e.min.z-u.z)*d),i>r||o>s)||((o>i||i!==i)&&(i=o),(r<s||s!==s)&&(s=r),s<0)?null:this.at(i>=0?i:s,t)}intersectsBox(e){return this.intersectBox(e,nn)!==null}intersectTriangle(e,t,i,s,n){dc.subVectors(t,e),Sr.subVectors(i,e),uc.crossVectors(dc,Sr);let a=this.direction.dot(uc),o;if(a>0){if(s)return null;o=1}else if(a<0)o=-1,a=-a;else return null;_n.subVectors(this.origin,e);const r=o*this.direction.dot(Sr.crossVectors(_n,Sr));if(r<0)return null;const c=o*this.direction.dot(dc.cross(_n));if(c<0||r+c>a)return null;const h=-o*_n.dot(uc);return h<0?null:this.at(h/a,n)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return new this.constructor().copy(this)}}class ut{constructor(e,t,i,s,n,a,o,r,c,h,d,u,p,f,y,m){ut.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e!==void 0&&this.set(e,t,i,s,n,a,o,r,c,h,d,u,p,f,y,m)}set(e,t,i,s,n,a,o,r,c,h,d,u,p,f,y,m){const g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=s,g[1]=n,g[5]=a,g[9]=o,g[13]=r,g[2]=c,g[6]=h,g[10]=d,g[14]=u,g[3]=p,g[7]=f,g[11]=y,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return new ut().fromArray(this.elements)}copy(e){const t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this}copyPosition(e){const t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,i){return this.determinant()===0?(e.set(1,0,0),t.set(0,1,0),i.set(0,0,1),this):(e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this)}makeBasis(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this}extractRotation(e){if(e.determinant()===0)return this.identity();const t=this.elements,i=e.elements,s=1/ya.setFromMatrixColumn(e,0).length(),n=1/ya.setFromMatrixColumn(e,1).length(),a=1/ya.setFromMatrixColumn(e,2).length();return t[0]=i[0]*s,t[1]=i[1]*s,t[2]=i[2]*s,t[3]=0,t[4]=i[4]*n,t[5]=i[5]*n,t[6]=i[6]*n,t[7]=0,t[8]=i[8]*a,t[9]=i[9]*a,t[10]=i[10]*a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,i=e.x,s=e.y,n=e.z,a=Math.cos(i),o=Math.sin(i),r=Math.cos(s),c=Math.sin(s),h=Math.cos(n),d=Math.sin(n);if(e.order==="XYZ"){const u=a*h,p=a*d,f=o*h,y=o*d;t[0]=r*h,t[4]=-r*d,t[8]=c,t[1]=p+f*c,t[5]=u-y*c,t[9]=-o*r,t[2]=y-u*c,t[6]=f+p*c,t[10]=a*r}else if(e.order==="YXZ"){const u=r*h,p=r*d,f=c*h,y=c*d;t[0]=u+y*o,t[4]=f*o-p,t[8]=a*c,t[1]=a*d,t[5]=a*h,t[9]=-o,t[2]=p*o-f,t[6]=y+u*o,t[10]=a*r}else if(e.order==="ZXY"){const u=r*h,p=r*d,f=c*h,y=c*d;t[0]=u-y*o,t[4]=-a*d,t[8]=f+p*o,t[1]=p+f*o,t[5]=a*h,t[9]=y-u*o,t[2]=-a*c,t[6]=o,t[10]=a*r}else if(e.order==="ZYX"){const u=a*h,p=a*d,f=o*h,y=o*d;t[0]=r*h,t[4]=f*c-p,t[8]=u*c+y,t[1]=r*d,t[5]=y*c+u,t[9]=p*c-f,t[2]=-c,t[6]=o*r,t[10]=a*r}else if(e.order==="YZX"){const u=a*r,p=a*c,f=o*r,y=o*c;t[0]=r*h,t[4]=y-u*d,t[8]=f*d+p,t[1]=d,t[5]=a*h,t[9]=-o*h,t[2]=-c*h,t[6]=p*d+f,t[10]=u-y*d}else if(e.order==="XZY"){const u=a*r,p=a*c,f=o*r,y=o*c;t[0]=r*h,t[4]=-d,t[8]=c*h,t[1]=u*d+y,t[5]=a*h,t[9]=p*d-f,t[2]=f*d-p,t[6]=o*h,t[10]=y*d+u}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Tg,e,Eg)}lookAt(e,t,i){const s=this.elements;return ns.subVectors(e,t),ns.lengthSq()===0&&(ns.z=1),ns.normalize(),Mn.crossVectors(i,ns),Mn.lengthSq()===0&&(Math.abs(i.z)===1?ns.x+=1e-4:ns.z+=1e-4,ns.normalize(),Mn.crossVectors(i,ns)),Mn.normalize(),Tr.crossVectors(ns,Mn),s[0]=Mn.x,s[4]=Tr.x,s[8]=ns.x,s[1]=Mn.y,s[5]=Tr.y,s[9]=ns.y,s[2]=Mn.z,s[6]=Tr.z,s[10]=ns.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const i=e.elements,s=t.elements,n=this.elements,a=i[0],o=i[4],r=i[8],c=i[12],h=i[1],d=i[5],u=i[9],p=i[13],f=i[2],y=i[6],m=i[10],g=i[14],x=i[3],v=i[7],b=i[11],_=i[15],S=s[0],A=s[4],R=s[8],M=s[12],C=s[1],k=s[5],L=s[9],O=s[13],W=s[2],U=s[6],$=s[10],G=s[14],ee=s[3],pe=s[7],me=s[11],ve=s[15];return n[0]=a*S+o*C+r*W+c*ee,n[4]=a*A+o*k+r*U+c*pe,n[8]=a*R+o*L+r*$+c*me,n[12]=a*M+o*O+r*G+c*ve,n[1]=h*S+d*C+u*W+p*ee,n[5]=h*A+d*k+u*U+p*pe,n[9]=h*R+d*L+u*$+p*me,n[13]=h*M+d*O+u*G+p*ve,n[2]=f*S+y*C+m*W+g*ee,n[6]=f*A+y*k+m*U+g*pe,n[10]=f*R+y*L+m*$+g*me,n[14]=f*M+y*O+m*G+g*ve,n[3]=x*S+v*C+b*W+_*ee,n[7]=x*A+v*k+b*U+_*pe,n[11]=x*R+v*L+b*$+_*me,n[15]=x*M+v*O+b*G+_*ve,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],i=e[4],s=e[8],n=e[12],a=e[1],o=e[5],r=e[9],c=e[13],h=e[2],d=e[6],u=e[10],p=e[14],f=e[3],y=e[7],m=e[11],g=e[15],x=r*p-c*u,v=o*p-c*d,b=o*u-r*d,_=a*p-c*h,S=a*u-r*h,A=a*d-o*h;return t*(y*x-m*v+g*b)-i*(f*x-m*_+g*S)+s*(f*v-y*_+g*A)-n*(f*b-y*S+m*A)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,i){const s=this.elements;return e.isVector3?(s[12]=e.x,s[13]=e.y,s[14]=e.z):(s[12]=e,s[13]=t,s[14]=i),this}invert(){const e=this.elements,t=e[0],i=e[1],s=e[2],n=e[3],a=e[4],o=e[5],r=e[6],c=e[7],h=e[8],d=e[9],u=e[10],p=e[11],f=e[12],y=e[13],m=e[14],g=e[15],x=d*m*c-y*u*c+y*r*p-o*m*p-d*r*g+o*u*g,v=f*u*c-h*m*c-f*r*p+a*m*p+h*r*g-a*u*g,b=h*y*c-f*d*c+f*o*p-a*y*p-h*o*g+a*d*g,_=f*d*r-h*y*r-f*o*u+a*y*u+h*o*m-a*d*m,S=t*x+i*v+s*b+n*_;if(S===0)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const A=1/S;return e[0]=x*A,e[1]=(y*u*n-d*m*n-y*s*p+i*m*p+d*s*g-i*u*g)*A,e[2]=(o*m*n-y*r*n+y*s*c-i*m*c-o*s*g+i*r*g)*A,e[3]=(d*r*n-o*u*n-d*s*c+i*u*c+o*s*p-i*r*p)*A,e[4]=v*A,e[5]=(h*m*n-f*u*n+f*s*p-t*m*p-h*s*g+t*u*g)*A,e[6]=(f*r*n-a*m*n-f*s*c+t*m*c+a*s*g-t*r*g)*A,e[7]=(a*u*n-h*r*n+h*s*c-t*u*c-a*s*p+t*r*p)*A,e[8]=b*A,e[9]=(f*d*n-h*y*n-f*i*p+t*y*p+h*i*g-t*d*g)*A,e[10]=(a*y*n-f*o*n+f*i*c-t*y*c-a*i*g+t*o*g)*A,e[11]=(h*o*n-a*d*n-h*i*c+t*d*c+a*i*p-t*o*p)*A,e[12]=_*A,e[13]=(h*y*s-f*d*s+f*i*u-t*y*u-h*i*m+t*d*m)*A,e[14]=(f*o*s-a*y*s-f*i*r+t*y*r+a*i*m-t*o*m)*A,e[15]=(a*d*s-h*o*s+h*i*r-t*d*r-a*i*u+t*o*u)*A,this}scale(e){const t=this.elements,i=e.x,s=e.y,n=e.z;return t[0]*=i,t[4]*=s,t[8]*=n,t[1]*=i,t[5]*=s,t[9]*=n,t[2]*=i,t[6]*=s,t[10]*=n,t[3]*=i,t[7]*=s,t[11]*=n,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],s=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,s))}makeTranslation(e,t,i){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const i=Math.cos(t),s=Math.sin(t),n=1-i,a=e.x,o=e.y,r=e.z,c=n*a,h=n*o;return this.set(c*a+i,c*o-s*r,c*r+s*o,0,c*o+s*r,h*o+i,h*r-s*a,0,c*r-s*o,h*r+s*a,n*r*r+i,0,0,0,0,1),this}makeScale(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this}makeShear(e,t,i,s,n,a){return this.set(1,i,n,0,e,1,a,0,t,s,1,0,0,0,0,1),this}compose(e,t,i){const s=this.elements,n=t._x,a=t._y,o=t._z,r=t._w,c=n+n,h=a+a,d=o+o,u=n*c,p=n*h,f=n*d,y=a*h,m=a*d,g=o*d,x=r*c,v=r*h,b=r*d,_=i.x,S=i.y,A=i.z;return s[0]=(1-(y+g))*_,s[1]=(p+b)*_,s[2]=(f-v)*_,s[3]=0,s[4]=(p-b)*S,s[5]=(1-(u+g))*S,s[6]=(m+x)*S,s[7]=0,s[8]=(f+v)*A,s[9]=(m-x)*A,s[10]=(1-(u+y))*A,s[11]=0,s[12]=e.x,s[13]=e.y,s[14]=e.z,s[15]=1,this}decompose(e,t,i){const s=this.elements;if(e.x=s[12],e.y=s[13],e.z=s[14],this.determinant()===0)return i.set(1,1,1),t.identity(),this;let n=ya.set(s[0],s[1],s[2]).length();const a=ya.set(s[4],s[5],s[6]).length(),o=ya.set(s[8],s[9],s[10]).length();this.determinant()<0&&(n=-n),_s.copy(this);const c=1/n,h=1/a,d=1/o;return _s.elements[0]*=c,_s.elements[1]*=c,_s.elements[2]*=c,_s.elements[4]*=h,_s.elements[5]*=h,_s.elements[6]*=h,_s.elements[8]*=d,_s.elements[9]*=d,_s.elements[10]*=d,t.setFromRotationMatrix(_s),i.x=n,i.y=a,i.z=o,this}makePerspective(e,t,i,s,n,a,o=Gs,r=!1){const c=this.elements,h=2*n/(t-e),d=2*n/(i-s),u=(t+e)/(t-e),p=(i+s)/(i-s);let f,y;if(r)f=n/(a-n),y=a*n/(a-n);else if(o===Gs)f=-(a+n)/(a-n),y=-2*a*n/(a-n);else if(o===kl)f=-a/(a-n),y=-a*n/(a-n);else throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);return c[0]=h,c[4]=0,c[8]=u,c[12]=0,c[1]=0,c[5]=d,c[9]=p,c[13]=0,c[2]=0,c[6]=0,c[10]=f,c[14]=y,c[3]=0,c[7]=0,c[11]=-1,c[15]=0,this}makeOrthographic(e,t,i,s,n,a,o=Gs,r=!1){const c=this.elements,h=2/(t-e),d=2/(i-s),u=-(t+e)/(t-e),p=-(i+s)/(i-s);let f,y;if(r)f=1/(a-n),y=a/(a-n);else if(o===Gs)f=-2/(a-n),y=-(a+n)/(a-n);else if(o===kl)f=-1/(a-n),y=-n/(a-n);else throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);return c[0]=h,c[4]=0,c[8]=0,c[12]=u,c[1]=0,c[5]=d,c[9]=0,c[13]=p,c[2]=0,c[6]=0,c[10]=f,c[14]=y,c[3]=0,c[7]=0,c[11]=0,c[15]=1,this}equals(e){const t=this.elements,i=e.elements;for(let s=0;s<16;s++)if(t[s]!==i[s])return!1;return!0}fromArray(e,t=0){for(let i=0;i<16;i++)this.elements[i]=e[i+t];return this}toArray(e=[],t=0){const i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}const ya=new T,_s=new ut,Tg=new T(0,0,0),Eg=new T(1,1,1),Mn=new T,Tr=new T,ns=new T,Lu=new ut,Ou=new Cs;class nt{constructor(e=0,t=0,i=0,s=nt.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=i,this._order=s}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,i,s=this._order){return this._x=e,this._y=t,this._z=i,this._order=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,i=!0){const s=e.elements,n=s[0],a=s[4],o=s[8],r=s[1],c=s[5],h=s[9],d=s[2],u=s[6],p=s[10];switch(t){case"XYZ":this._y=Math.asin(St(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-a,n)):(this._x=Math.atan2(u,c),this._z=0);break;case"YXZ":this._x=Math.asin(-St(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(o,p),this._z=Math.atan2(r,c)):(this._y=Math.atan2(-d,n),this._z=0);break;case"ZXY":this._x=Math.asin(St(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-d,p),this._z=Math.atan2(-a,c)):(this._y=0,this._z=Math.atan2(r,n));break;case"ZYX":this._y=Math.asin(-St(d,-1,1)),Math.abs(d)<.9999999?(this._x=Math.atan2(u,p),this._z=Math.atan2(r,n)):(this._x=0,this._z=Math.atan2(-a,c));break;case"YZX":this._z=Math.asin(St(r,-1,1)),Math.abs(r)<.9999999?(this._x=Math.atan2(-h,c),this._y=Math.atan2(-d,n)):(this._x=0,this._y=Math.atan2(o,p));break;case"XZY":this._z=Math.asin(-St(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(u,c),this._y=Math.atan2(o,n)):(this._x=Math.atan2(-h,p),this._y=0);break;default:Qe("Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,i===!0&&this._onChangeCallback(),this}setFromQuaternion(e,t,i){return Lu.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Lu,t,i)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Ou.setFromEuler(this),this.setFromQuaternion(Ou,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],e[3]!==void 0&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}nt.DEFAULT_ORDER="XYZ";class om{constructor(){this.mask=1}set(e){this.mask=(1<<e|0)>>>0}enable(e){this.mask|=1<<e|0}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e|0}disable(e){this.mask&=~(1<<e|0)}disableAll(){this.mask=0}test(e){return(this.mask&e.mask)!==0}isEnabled(e){return(this.mask&(1<<e|0))!==0}}let Cg=0;const Nu=new T,va=new Cs,an=new ut,Er=new T,go=new T,Ag=new T,Rg=new Cs,Bu=new T(1,0,0),zu=new T(0,1,0),Fu=new T(0,0,1),Uu={type:"added"},Ig={type:"removed"},xa={type:"childadded",child:null},pc={type:"childremoved",child:null};class ai extends la{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Cg++}),this.uuid=bs(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=ai.DEFAULT_UP.clone();const e=new T,t=new nt,i=new Cs,s=new T(1,1,1);function n(){i.setFromEuler(t,!1)}function a(){t.setFromQuaternion(i,void 0,!1)}t._onChange(n),i._onChange(a),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:s},modelViewMatrix:{value:new ut},normalMatrix:{value:new yt}}),this.matrix=new ut,this.matrixWorld=new ut,this.matrixAutoUpdate=ai.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=ai.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new om,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return va.setFromAxisAngle(e,t),this.quaternion.multiply(va),this}rotateOnWorldAxis(e,t){return va.setFromAxisAngle(e,t),this.quaternion.premultiply(va),this}rotateX(e){return this.rotateOnAxis(Bu,e)}rotateY(e){return this.rotateOnAxis(zu,e)}rotateZ(e){return this.rotateOnAxis(Fu,e)}translateOnAxis(e,t){return Nu.copy(e).applyQuaternion(this.quaternion),this.position.add(Nu.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Bu,e)}translateY(e){return this.translateOnAxis(zu,e)}translateZ(e){return this.translateOnAxis(Fu,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(an.copy(this.matrixWorld).invert())}lookAt(e,t,i){e.isVector3?Er.copy(e):Er.set(e,t,i);const s=this.parent;this.updateWorldMatrix(!0,!1),go.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?an.lookAt(go,Er,this.up):an.lookAt(Er,go,this.up),this.quaternion.setFromRotationMatrix(an),s&&(an.extractRotation(s.matrixWorld),va.setFromRotationMatrix(an),this.quaternion.premultiply(va.invert()))}add(e){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(rt("Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(Uu),xa.child=e,this.dispatchEvent(xa),xa.child=null):rt("Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.remove(arguments[i]);return this}const t=this.children.indexOf(e);return t!==-1&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(Ig),pc.child=e,this.dispatchEvent(pc),pc.child=null),this}removeFromParent(){const e=this.parent;return e!==null&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),an.copy(this.matrixWorld).invert(),e.parent!==null&&(e.parent.updateWorldMatrix(!0,!1),an.multiply(e.parent.matrixWorld)),e.applyMatrix4(an),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(Uu),xa.child=e,this.dispatchEvent(xa),xa.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let i=0,s=this.children.length;i<s;i++){const a=this.children[i].getObjectByProperty(e,t);if(a!==void 0)return a}}getObjectsByProperty(e,t,i=[]){this[e]===t&&i.push(this);const s=this.children;for(let n=0,a=s.length;n<a;n++)s[n].getObjectsByProperty(e,t,i);return i}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(go,e,Ag),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(go,Rg,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].traverse(e)}traverseVisible(e){if(this.visible===!1)return;e(this);const t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].traverseVisible(e)}traverseAncestors(e){const t=this.parent;t!==null&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let i=0,s=t.length;i<s;i++)t[i].updateMatrixWorld(e)}updateWorldMatrix(e,t){const i=this.parent;if(e===!0&&i!==null&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldAutoUpdate===!0&&(this.parent===null?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),t===!0){const s=this.children;for(let n=0,a=s.length;n<a;n++)s[n].updateWorldMatrix(!1,!0)}}toJSON(e){const t=e===void 0||typeof e=="string",i={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const s={};s.uuid=this.uuid,s.type=this.type,this.name!==""&&(s.name=this.name),this.castShadow===!0&&(s.castShadow=!0),this.receiveShadow===!0&&(s.receiveShadow=!0),this.visible===!1&&(s.visible=!1),this.frustumCulled===!1&&(s.frustumCulled=!1),this.renderOrder!==0&&(s.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(s.userData=this.userData),s.layers=this.layers.mask,s.matrix=this.matrix.toArray(),s.up=this.up.toArray(),this.matrixAutoUpdate===!1&&(s.matrixAutoUpdate=!1),this.isInstancedMesh&&(s.type="InstancedMesh",s.count=this.count,s.instanceMatrix=this.instanceMatrix.toJSON(),this.instanceColor!==null&&(s.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(s.type="BatchedMesh",s.perObjectFrustumCulled=this.perObjectFrustumCulled,s.sortObjects=this.sortObjects,s.drawRanges=this._drawRanges,s.reservedRanges=this._reservedRanges,s.geometryInfo=this._geometryInfo.map(o=>({...o,boundingBox:o.boundingBox?o.boundingBox.toJSON():void 0,boundingSphere:o.boundingSphere?o.boundingSphere.toJSON():void 0})),s.instanceInfo=this._instanceInfo.map(o=>({...o})),s.availableInstanceIds=this._availableInstanceIds.slice(),s.availableGeometryIds=this._availableGeometryIds.slice(),s.nextIndexStart=this._nextIndexStart,s.nextVertexStart=this._nextVertexStart,s.geometryCount=this._geometryCount,s.maxInstanceCount=this._maxInstanceCount,s.maxVertexCount=this._maxVertexCount,s.maxIndexCount=this._maxIndexCount,s.geometryInitialized=this._geometryInitialized,s.matricesTexture=this._matricesTexture.toJSON(e),s.indirectTexture=this._indirectTexture.toJSON(e),this._colorsTexture!==null&&(s.colorsTexture=this._colorsTexture.toJSON(e)),this.boundingSphere!==null&&(s.boundingSphere=this.boundingSphere.toJSON()),this.boundingBox!==null&&(s.boundingBox=this.boundingBox.toJSON()));function n(o,r){return o[r.uuid]===void 0&&(o[r.uuid]=r.toJSON(e)),r.uuid}if(this.isScene)this.background&&(this.background.isColor?s.background=this.background.toJSON():this.background.isTexture&&(s.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&this.environment.isRenderTargetTexture!==!0&&(s.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){s.geometry=n(e.geometries,this.geometry);const o=this.geometry.parameters;if(o!==void 0&&o.shapes!==void 0){const r=o.shapes;if(Array.isArray(r))for(let c=0,h=r.length;c<h;c++){const d=r[c];n(e.shapes,d)}else n(e.shapes,r)}}if(this.isSkinnedMesh&&(s.bindMode=this.bindMode,s.bindMatrix=this.bindMatrix.toArray(),this.skeleton!==void 0&&(n(e.skeletons,this.skeleton),s.skeleton=this.skeleton.uuid)),this.material!==void 0)if(Array.isArray(this.material)){const o=[];for(let r=0,c=this.material.length;r<c;r++)o.push(n(e.materials,this.material[r]));s.material=o}else s.material=n(e.materials,this.material);if(this.children.length>0){s.children=[];for(let o=0;o<this.children.length;o++)s.children.push(this.children[o].toJSON(e).object)}if(this.animations.length>0){s.animations=[];for(let o=0;o<this.animations.length;o++){const r=this.animations[o];s.animations.push(n(e.animations,r))}}if(t){const o=a(e.geometries),r=a(e.materials),c=a(e.textures),h=a(e.images),d=a(e.shapes),u=a(e.skeletons),p=a(e.animations),f=a(e.nodes);o.length>0&&(i.geometries=o),r.length>0&&(i.materials=r),c.length>0&&(i.textures=c),h.length>0&&(i.images=h),d.length>0&&(i.shapes=d),u.length>0&&(i.skeletons=u),p.length>0&&(i.animations=p),f.length>0&&(i.nodes=f)}return i.object=s,i;function a(o){const r=[];for(const c in o){const h=o[c];delete h.metadata,r.push(h)}return r}}clone(e){return new this.constructor().copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),t===!0)for(let i=0;i<e.children.length;i++){const s=e.children[i];this.add(s.clone())}return this}}ai.DEFAULT_UP=new T(0,1,0);ai.DEFAULT_MATRIX_AUTO_UPDATE=!0;ai.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Ms=new T,on=new T,fc=new T,rn=new T,ba=new T,wa=new T,Gu=new T,mc=new T,gc=new T,yc=new T,vc=new ni,xc=new ni,bc=new ni;class ys{constructor(e=new T,t=new T,i=new T){this.a=e,this.b=t,this.c=i}static getNormal(e,t,i,s){s.subVectors(i,t),Ms.subVectors(e,t),s.cross(Ms);const n=s.lengthSq();return n>0?s.multiplyScalar(1/Math.sqrt(n)):s.set(0,0,0)}static getBarycoord(e,t,i,s,n){Ms.subVectors(s,t),on.subVectors(i,t),fc.subVectors(e,t);const a=Ms.dot(Ms),o=Ms.dot(on),r=Ms.dot(fc),c=on.dot(on),h=on.dot(fc),d=a*c-o*o;if(d===0)return n.set(0,0,0),null;const u=1/d,p=(c*r-o*h)*u,f=(a*h-o*r)*u;return n.set(1-p-f,f,p)}static containsPoint(e,t,i,s){return this.getBarycoord(e,t,i,s,rn)===null?!1:rn.x>=0&&rn.y>=0&&rn.x+rn.y<=1}static getInterpolation(e,t,i,s,n,a,o,r){return this.getBarycoord(e,t,i,s,rn)===null?(r.x=0,r.y=0,"z"in r&&(r.z=0),"w"in r&&(r.w=0),null):(r.setScalar(0),r.addScaledVector(n,rn.x),r.addScaledVector(a,rn.y),r.addScaledVector(o,rn.z),r)}static getInterpolatedAttribute(e,t,i,s,n,a){return vc.setScalar(0),xc.setScalar(0),bc.setScalar(0),vc.fromBufferAttribute(e,t),xc.fromBufferAttribute(e,i),bc.fromBufferAttribute(e,s),a.setScalar(0),a.addScaledVector(vc,n.x),a.addScaledVector(xc,n.y),a.addScaledVector(bc,n.z),a}static isFrontFacing(e,t,i,s){return Ms.subVectors(i,t),on.subVectors(e,t),Ms.cross(on).dot(s)<0}set(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this}setFromPointsAndIndices(e,t,i,s){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[s]),this}setFromAttributeAndIndices(e,t,i,s){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,i),this.c.fromBufferAttribute(e,s),this}clone(){return new this.constructor().copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return Ms.subVectors(this.c,this.b),on.subVectors(this.a,this.b),Ms.cross(on).length()*.5}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return ys.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return ys.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,i,s,n){return ys.getInterpolation(e,this.a,this.b,this.c,t,i,s,n)}containsPoint(e){return ys.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return ys.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const i=this.a,s=this.b,n=this.c;let a,o;ba.subVectors(s,i),wa.subVectors(n,i),mc.subVectors(e,i);const r=ba.dot(mc),c=wa.dot(mc);if(r<=0&&c<=0)return t.copy(i);gc.subVectors(e,s);const h=ba.dot(gc),d=wa.dot(gc);if(h>=0&&d<=h)return t.copy(s);const u=r*d-h*c;if(u<=0&&r>=0&&h<=0)return a=r/(r-h),t.copy(i).addScaledVector(ba,a);yc.subVectors(e,n);const p=ba.dot(yc),f=wa.dot(yc);if(f>=0&&p<=f)return t.copy(n);const y=p*c-r*f;if(y<=0&&c>=0&&f<=0)return o=c/(c-f),t.copy(i).addScaledVector(wa,o);const m=h*f-p*d;if(m<=0&&d-h>=0&&p-f>=0)return Gu.subVectors(n,s),o=(d-h)/(d-h+(p-f)),t.copy(s).addScaledVector(Gu,o);const g=1/(m+y+u);return a=y*g,o=u*g,t.copy(i).addScaledVector(ba,a).addScaledVector(wa,o)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const rm={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Sn={h:0,s:0,l:0},Cr={h:0,s:0,l:0};function wc(l,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?l+(e-l)*6*t:t<1/2?e:t<2/3?l+(e-l)*6*(2/3-t):l}class H{constructor(e,t,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,i)}set(e,t,i){if(t===void 0&&i===void 0){const s=e;s&&s.isColor?this.copy(s):typeof s=="number"?this.setHex(s):typeof s=="string"&&this.setStyle(s)}else this.setRGB(e,t,i);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=pi){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,Rt.colorSpaceToWorking(this,t),this}setRGB(e,t,i,s=Rt.workingColorSpace){return this.r=e,this.g=t,this.b=i,Rt.colorSpaceToWorking(this,s),this}setHSL(e,t,i,s=Rt.workingColorSpace){if(e=Wd(e,1),t=St(t,0,1),i=St(i,0,1),t===0)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+t):i+t-i*t,a=2*i-n;this.r=wc(a,n,e+1/3),this.g=wc(a,n,e),this.b=wc(a,n,e-1/3)}return Rt.colorSpaceToWorking(this,s),this}setStyle(e,t=pi){function i(n){n!==void 0&&parseFloat(n)<1&&Qe("Color: Alpha component of "+e+" will be ignored.")}let s;if(s=/^(\w+)\(([^\)]*)\)/.exec(e)){let n;const a=s[1],o=s[2];switch(a){case"rgb":case"rgba":if(n=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return i(n[4]),this.setRGB(Math.min(255,parseInt(n[1],10))/255,Math.min(255,parseInt(n[2],10))/255,Math.min(255,parseInt(n[3],10))/255,t);if(n=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return i(n[4]),this.setRGB(Math.min(100,parseInt(n[1],10))/100,Math.min(100,parseInt(n[2],10))/100,Math.min(100,parseInt(n[3],10))/100,t);break;case"hsl":case"hsla":if(n=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return i(n[4]),this.setHSL(parseFloat(n[1])/360,parseFloat(n[2])/100,parseFloat(n[3])/100,t);break;default:Qe("Color: Unknown color model "+e)}}else if(s=/^\#([A-Fa-f\d]+)$/.exec(e)){const n=s[1],a=n.length;if(a===3)return this.setRGB(parseInt(n.charAt(0),16)/15,parseInt(n.charAt(1),16)/15,parseInt(n.charAt(2),16)/15,t);if(a===6)return this.setHex(parseInt(n,16),t);Qe("Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=pi){const i=rm[e.toLowerCase()];return i!==void 0?this.setHex(i,t):Qe("Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=mn(e.r),this.g=mn(e.g),this.b=mn(e.b),this}copyLinearToSRGB(e){return this.r=Ha(e.r),this.g=Ha(e.g),this.b=Ha(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=pi){return Rt.workingToColorSpace(Pi.copy(this),e),Math.round(St(Pi.r*255,0,255))*65536+Math.round(St(Pi.g*255,0,255))*256+Math.round(St(Pi.b*255,0,255))}getHexString(e=pi){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=Rt.workingColorSpace){Rt.workingToColorSpace(Pi.copy(this),t);const i=Pi.r,s=Pi.g,n=Pi.b,a=Math.max(i,s,n),o=Math.min(i,s,n);let r,c;const h=(o+a)/2;if(o===a)r=0,c=0;else{const d=a-o;switch(c=h<=.5?d/(a+o):d/(2-a-o),a){case i:r=(s-n)/d+(s<n?6:0);break;case s:r=(n-i)/d+2;break;case n:r=(i-s)/d+4;break}r/=6}return e.h=r,e.s=c,e.l=h,e}getRGB(e,t=Rt.workingColorSpace){return Rt.workingToColorSpace(Pi.copy(this),t),e.r=Pi.r,e.g=Pi.g,e.b=Pi.b,e}getStyle(e=pi){Rt.workingToColorSpace(Pi.copy(this),e);const t=Pi.r,i=Pi.g,s=Pi.b;return e!==pi?`color(${e} ${t.toFixed(3)} ${i.toFixed(3)} ${s.toFixed(3)})`:`rgb(${Math.round(t*255)},${Math.round(i*255)},${Math.round(s*255)})`}offsetHSL(e,t,i){return this.getHSL(Sn),this.setHSL(Sn.h+e,Sn.s+t,Sn.l+i)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,i){return this.r=e.r+(t.r-e.r)*i,this.g=e.g+(t.g-e.g)*i,this.b=e.b+(t.b-e.b)*i,this}lerpHSL(e,t){this.getHSL(Sn),e.getHSL(Cr);const i=Go(Sn.h,Cr.h,t),s=Go(Sn.s,Cr.s,t),n=Go(Sn.l,Cr.l,t);return this.setHSL(i,s,n),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,i=this.g,s=this.b,n=e.elements;return this.r=n[0]*t+n[3]*i+n[6]*s,this.g=n[1]*t+n[4]*i+n[7]*s,this.b=n[2]*t+n[5]*i+n[8]*s,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Pi=new H;H.NAMES=rm;let kg=0;class As extends la{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:kg++}),this.uuid=bs(),this.name="",this.type="Material",this.blending=ta,this.side=Xs,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=xh,this.blendDst=bh,this.blendEquation=Kn,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new H(0,0,0),this.blendAlpha=0,this.depthFunc=Wa,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=Cu,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=ua,this.stencilZFail=ua,this.stencilZPass=ua,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(e!==void 0)for(const t in e){const i=e[t];if(i===void 0){Qe(`Material: parameter '${t}' has value of undefined.`);continue}const s=this[t];if(s===void 0){Qe(`Material: '${t}' is not a property of THREE.${this.type}.`);continue}s&&s.isColor?s.set(i):s&&s.isVector3&&i&&i.isVector3?s.copy(i):this[t]=i}}toJSON(e){const t=e===void 0||typeof e=="string";t&&(e={textures:{},images:{}});const i={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};i.uuid=this.uuid,i.type=this.type,this.name!==""&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),this.roughness!==void 0&&(i.roughness=this.roughness),this.metalness!==void 0&&(i.metalness=this.metalness),this.sheen!==void 0&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),this.sheenRoughness!==void 0&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),this.emissiveIntensity!==void 0&&this.emissiveIntensity!==1&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),this.specularIntensity!==void 0&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),this.shininess!==void 0&&(i.shininess=this.shininess),this.clearcoat!==void 0&&(i.clearcoat=this.clearcoat),this.clearcoatRoughness!==void 0&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.sheenColorMap&&this.sheenColorMap.isTexture&&(i.sheenColorMap=this.sheenColorMap.toJSON(e).uuid),this.sheenRoughnessMap&&this.sheenRoughnessMap.isTexture&&(i.sheenRoughnessMap=this.sheenRoughnessMap.toJSON(e).uuid),this.dispersion!==void 0&&(i.dispersion=this.dispersion),this.iridescence!==void 0&&(i.iridescence=this.iridescence),this.iridescenceIOR!==void 0&&(i.iridescenceIOR=this.iridescenceIOR),this.iridescenceThicknessRange!==void 0&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),this.anisotropy!==void 0&&(i.anisotropy=this.anisotropy),this.anisotropyRotation!==void 0&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(e).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(e).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(e).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(e).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(e).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(e).uuid,this.combine!==void 0&&(i.combine=this.combine)),this.envMapRotation!==void 0&&(i.envMapRotation=this.envMapRotation.toArray()),this.envMapIntensity!==void 0&&(i.envMapIntensity=this.envMapIntensity),this.reflectivity!==void 0&&(i.reflectivity=this.reflectivity),this.refractionRatio!==void 0&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(e).uuid),this.transmission!==void 0&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(e).uuid),this.thickness!==void 0&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(e).uuid),this.attenuationDistance!==void 0&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),this.attenuationColor!==void 0&&(i.attenuationColor=this.attenuationColor.getHex()),this.size!==void 0&&(i.size=this.size),this.shadowSide!==null&&(i.shadowSide=this.shadowSide),this.sizeAttenuation!==void 0&&(i.sizeAttenuation=this.sizeAttenuation),this.blending!==ta&&(i.blending=this.blending),this.side!==Xs&&(i.side=this.side),this.vertexColors===!0&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),this.transparent===!0&&(i.transparent=!0),this.blendSrc!==xh&&(i.blendSrc=this.blendSrc),this.blendDst!==bh&&(i.blendDst=this.blendDst),this.blendEquation!==Kn&&(i.blendEquation=this.blendEquation),this.blendSrcAlpha!==null&&(i.blendSrcAlpha=this.blendSrcAlpha),this.blendDstAlpha!==null&&(i.blendDstAlpha=this.blendDstAlpha),this.blendEquationAlpha!==null&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),this.blendAlpha!==0&&(i.blendAlpha=this.blendAlpha),this.depthFunc!==Wa&&(i.depthFunc=this.depthFunc),this.depthTest===!1&&(i.depthTest=this.depthTest),this.depthWrite===!1&&(i.depthWrite=this.depthWrite),this.colorWrite===!1&&(i.colorWrite=this.colorWrite),this.stencilWriteMask!==255&&(i.stencilWriteMask=this.stencilWriteMask),this.stencilFunc!==Cu&&(i.stencilFunc=this.stencilFunc),this.stencilRef!==0&&(i.stencilRef=this.stencilRef),this.stencilFuncMask!==255&&(i.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==ua&&(i.stencilFail=this.stencilFail),this.stencilZFail!==ua&&(i.stencilZFail=this.stencilZFail),this.stencilZPass!==ua&&(i.stencilZPass=this.stencilZPass),this.stencilWrite===!0&&(i.stencilWrite=this.stencilWrite),this.rotation!==void 0&&this.rotation!==0&&(i.rotation=this.rotation),this.polygonOffset===!0&&(i.polygonOffset=!0),this.polygonOffsetFactor!==0&&(i.polygonOffsetFactor=this.polygonOffsetFactor),this.polygonOffsetUnits!==0&&(i.polygonOffsetUnits=this.polygonOffsetUnits),this.linewidth!==void 0&&this.linewidth!==1&&(i.linewidth=this.linewidth),this.dashSize!==void 0&&(i.dashSize=this.dashSize),this.gapSize!==void 0&&(i.gapSize=this.gapSize),this.scale!==void 0&&(i.scale=this.scale),this.dithering===!0&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),this.alphaHash===!0&&(i.alphaHash=!0),this.alphaToCoverage===!0&&(i.alphaToCoverage=!0),this.premultipliedAlpha===!0&&(i.premultipliedAlpha=!0),this.forceSinglePass===!0&&(i.forceSinglePass=!0),this.allowOverride===!1&&(i.allowOverride=!1),this.wireframe===!0&&(i.wireframe=!0),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),this.wireframeLinecap!=="round"&&(i.wireframeLinecap=this.wireframeLinecap),this.wireframeLinejoin!=="round"&&(i.wireframeLinejoin=this.wireframeLinejoin),this.flatShading===!0&&(i.flatShading=!0),this.visible===!1&&(i.visible=!1),this.toneMapped===!1&&(i.toneMapped=!1),this.fog===!1&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData);function s(n){const a=[];for(const o in n){const r=n[o];delete r.metadata,a.push(r)}return a}if(t){const n=s(e.textures),a=s(e.images);n.length>0&&(i.textures=n),a.length>0&&(i.images=a)}return i}clone(){return new this.constructor().copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let i=null;if(t!==null){const s=t.length;i=new Array(s);for(let n=0;n!==s;++n)i[n]=t[n].clone()}return this.clippingPlanes=i,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.allowOverride=e.allowOverride,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){e===!0&&this.version++}}class B extends As{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new H(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new nt,this.combine=Vf,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const yi=new T,Ar=new le;let Pg=0;class Je{constructor(e,t,i=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:Pg++}),this.name="",this.array=e,this.itemSize=t,this.count=e!==void 0?e.length/t:0,this.normalized=i,this.usage=cd,this.updateRanges=[],this.gpuType=vs,this.version=0}onUploadCallback(){}set needsUpdate(e){e===!0&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,i){e*=this.itemSize,i*=t.itemSize;for(let s=0,n=this.itemSize;s<n;s++)this.array[e+s]=t.array[i+s];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(this.itemSize===2)for(let t=0,i=this.count;t<i;t++)Ar.fromBufferAttribute(this,t),Ar.applyMatrix3(e),this.setXY(t,Ar.x,Ar.y);else if(this.itemSize===3)for(let t=0,i=this.count;t<i;t++)yi.fromBufferAttribute(this,t),yi.applyMatrix3(e),this.setXYZ(t,yi.x,yi.y,yi.z);return this}applyMatrix4(e){for(let t=0,i=this.count;t<i;t++)yi.fromBufferAttribute(this,t),yi.applyMatrix4(e),this.setXYZ(t,yi.x,yi.y,yi.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)yi.fromBufferAttribute(this,t),yi.applyNormalMatrix(e),this.setXYZ(t,yi.x,yi.y,yi.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)yi.fromBufferAttribute(this,t),yi.transformDirection(e),this.setXYZ(t,yi.x,yi.y,yi.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let i=this.array[e*this.itemSize+t];return this.normalized&&(i=Es(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=Vt(i,this.array)),this.array[e*this.itemSize+t]=i,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=Es(t,this.array)),t}setX(e,t){return this.normalized&&(t=Vt(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=Es(t,this.array)),t}setY(e,t){return this.normalized&&(t=Vt(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=Es(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Vt(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=Es(t,this.array)),t}setW(e,t){return this.normalized&&(t=Vt(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,i){return e*=this.itemSize,this.normalized&&(t=Vt(t,this.array),i=Vt(i,this.array)),this.array[e+0]=t,this.array[e+1]=i,this}setXYZ(e,t,i,s){return e*=this.itemSize,this.normalized&&(t=Vt(t,this.array),i=Vt(i,this.array),s=Vt(s,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=s,this}setXYZW(e,t,i,s,n){return e*=this.itemSize,this.normalized&&(t=Vt(t,this.array),i=Vt(i,this.array),s=Vt(s,this.array),n=Vt(n,this.array)),this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=s,this.array[e+3]=n,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return this.name!==""&&(e.name=this.name),this.usage!==cd&&(e.usage=this.usage),e}}class lm extends Je{constructor(e,t,i){super(new Uint16Array(e),t,i)}}class cm extends Je{constructor(e,t,i){super(new Uint32Array(e),t,i)}}class Tt extends Je{constructor(e,t,i){super(new Float32Array(e),t,i)}}let Dg=0;const us=new ut,_c=new ai,_a=new T,as=new Qi,yo=new Qi,Ti=new T;class mt extends la{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:Dg++}),this.uuid=bs(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.indirectOffset=0,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(nm(e)?cm:lm)(e,1):this.index=e,this}setIndirect(e,t=0){return this.indirect=e,this.indirectOffset=t,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return this.attributes[e]!==void 0}addGroup(e,t,i=0){this.groups.push({start:e,count:t,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;t!==void 0&&(t.applyMatrix4(e),t.needsUpdate=!0);const i=this.attributes.normal;if(i!==void 0){const n=new yt().getNormalMatrix(e);i.applyNormalMatrix(n),i.needsUpdate=!0}const s=this.attributes.tangent;return s!==void 0&&(s.transformDirection(e),s.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}applyQuaternion(e){return us.makeRotationFromQuaternion(e),this.applyMatrix4(us),this}rotateX(e){return us.makeRotationX(e),this.applyMatrix4(us),this}rotateY(e){return us.makeRotationY(e),this.applyMatrix4(us),this}rotateZ(e){return us.makeRotationZ(e),this.applyMatrix4(us),this}translate(e,t,i){return us.makeTranslation(e,t,i),this.applyMatrix4(us),this}scale(e,t,i){return us.makeScale(e,t,i),this.applyMatrix4(us),this}lookAt(e){return _c.lookAt(e),_c.updateMatrix(),this.applyMatrix4(_c.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(_a).negate(),this.translate(_a.x,_a.y,_a.z),this}setFromPoints(e){const t=this.getAttribute("position");if(t===void 0){const i=[];for(let s=0,n=e.length;s<n;s++){const a=e[s];i.push(a.x,a.y,a.z||0)}this.setAttribute("position",new Tt(i,3))}else{const i=Math.min(e.length,t.count);for(let s=0;s<i;s++){const n=e[s];t.setXYZ(s,n.x,n.y,n.z||0)}e.length>t.count&&Qe("BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),t.needsUpdate=!0}return this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new Qi);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){rt("BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),this.boundingBox.set(new T(-1/0,-1/0,-1/0),new T(1/0,1/0,1/0));return}if(e!==void 0){if(this.boundingBox.setFromBufferAttribute(e),t)for(let i=0,s=t.length;i<s;i++){const n=t[i];as.setFromBufferAttribute(n),this.morphTargetsRelative?(Ti.addVectors(this.boundingBox.min,as.min),this.boundingBox.expandByPoint(Ti),Ti.addVectors(this.boundingBox.max,as.max),this.boundingBox.expandByPoint(Ti)):(this.boundingBox.expandByPoint(as.min),this.boundingBox.expandByPoint(as.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&rt('BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new Zs);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute){rt("BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),this.boundingSphere.set(new T,1/0);return}if(e){const i=this.boundingSphere.center;if(as.setFromBufferAttribute(e),t)for(let n=0,a=t.length;n<a;n++){const o=t[n];yo.setFromBufferAttribute(o),this.morphTargetsRelative?(Ti.addVectors(as.min,yo.min),as.expandByPoint(Ti),Ti.addVectors(as.max,yo.max),as.expandByPoint(Ti)):(as.expandByPoint(yo.min),as.expandByPoint(yo.max))}as.getCenter(i);let s=0;for(let n=0,a=e.count;n<a;n++)Ti.fromBufferAttribute(e,n),s=Math.max(s,i.distanceToSquared(Ti));if(t)for(let n=0,a=t.length;n<a;n++){const o=t[n],r=this.morphTargetsRelative;for(let c=0,h=o.count;c<h;c++)Ti.fromBufferAttribute(o,c),r&&(_a.fromBufferAttribute(e,c),Ti.add(_a)),s=Math.max(s,i.distanceToSquared(Ti))}this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&rt('BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(e===null||t.position===void 0||t.normal===void 0||t.uv===void 0){rt("BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");return}const i=t.position,s=t.normal,n=t.uv;this.hasAttribute("tangent")===!1&&this.setAttribute("tangent",new Je(new Float32Array(4*i.count),4));const a=this.getAttribute("tangent"),o=[],r=[];for(let R=0;R<i.count;R++)o[R]=new T,r[R]=new T;const c=new T,h=new T,d=new T,u=new le,p=new le,f=new le,y=new T,m=new T;function g(R,M,C){c.fromBufferAttribute(i,R),h.fromBufferAttribute(i,M),d.fromBufferAttribute(i,C),u.fromBufferAttribute(n,R),p.fromBufferAttribute(n,M),f.fromBufferAttribute(n,C),h.sub(c),d.sub(c),p.sub(u),f.sub(u);const k=1/(p.x*f.y-f.x*p.y);isFinite(k)&&(y.copy(h).multiplyScalar(f.y).addScaledVector(d,-p.y).multiplyScalar(k),m.copy(d).multiplyScalar(p.x).addScaledVector(h,-f.x).multiplyScalar(k),o[R].add(y),o[M].add(y),o[C].add(y),r[R].add(m),r[M].add(m),r[C].add(m))}let x=this.groups;x.length===0&&(x=[{start:0,count:e.count}]);for(let R=0,M=x.length;R<M;++R){const C=x[R],k=C.start,L=C.count;for(let O=k,W=k+L;O<W;O+=3)g(e.getX(O+0),e.getX(O+1),e.getX(O+2))}const v=new T,b=new T,_=new T,S=new T;function A(R){_.fromBufferAttribute(s,R),S.copy(_);const M=o[R];v.copy(M),v.sub(_.multiplyScalar(_.dot(M))).normalize(),b.crossVectors(S,M);const k=b.dot(r[R])<0?-1:1;a.setXYZW(R,v.x,v.y,v.z,k)}for(let R=0,M=x.length;R<M;++R){const C=x[R],k=C.start,L=C.count;for(let O=k,W=k+L;O<W;O+=3)A(e.getX(O+0)),A(e.getX(O+1)),A(e.getX(O+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(t!==void 0){let i=this.getAttribute("normal");if(i===void 0)i=new Je(new Float32Array(t.count*3),3),this.setAttribute("normal",i);else for(let u=0,p=i.count;u<p;u++)i.setXYZ(u,0,0,0);const s=new T,n=new T,a=new T,o=new T,r=new T,c=new T,h=new T,d=new T;if(e)for(let u=0,p=e.count;u<p;u+=3){const f=e.getX(u+0),y=e.getX(u+1),m=e.getX(u+2);s.fromBufferAttribute(t,f),n.fromBufferAttribute(t,y),a.fromBufferAttribute(t,m),h.subVectors(a,n),d.subVectors(s,n),h.cross(d),o.fromBufferAttribute(i,f),r.fromBufferAttribute(i,y),c.fromBufferAttribute(i,m),o.add(h),r.add(h),c.add(h),i.setXYZ(f,o.x,o.y,o.z),i.setXYZ(y,r.x,r.y,r.z),i.setXYZ(m,c.x,c.y,c.z)}else for(let u=0,p=t.count;u<p;u+=3)s.fromBufferAttribute(t,u+0),n.fromBufferAttribute(t,u+1),a.fromBufferAttribute(t,u+2),h.subVectors(a,n),d.subVectors(s,n),h.cross(d),i.setXYZ(u+0,h.x,h.y,h.z),i.setXYZ(u+1,h.x,h.y,h.z),i.setXYZ(u+2,h.x,h.y,h.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,i=e.count;t<i;t++)Ti.fromBufferAttribute(e,t),Ti.normalize(),e.setXYZ(t,Ti.x,Ti.y,Ti.z)}toNonIndexed(){function e(o,r){const c=o.array,h=o.itemSize,d=o.normalized,u=new c.constructor(r.length*h);let p=0,f=0;for(let y=0,m=r.length;y<m;y++){o.isInterleavedBufferAttribute?p=r[y]*o.data.stride+o.offset:p=r[y]*h;for(let g=0;g<h;g++)u[f++]=c[p++]}return new Je(u,h,d)}if(this.index===null)return Qe("BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new mt,i=this.index.array,s=this.attributes;for(const o in s){const r=s[o],c=e(r,i);t.setAttribute(o,c)}const n=this.morphAttributes;for(const o in n){const r=[],c=n[o];for(let h=0,d=c.length;h<d;h++){const u=c[h],p=e(u,i);r.push(p)}t.morphAttributes[o]=r}t.morphTargetsRelative=this.morphTargetsRelative;const a=this.groups;for(let o=0,r=a.length;o<r;o++){const c=a[o];t.addGroup(c.start,c.count,c.materialIndex)}return t}toJSON(){const e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,this.name!==""&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),this.parameters!==void 0){const r=this.parameters;for(const c in r)r[c]!==void 0&&(e[c]=r[c]);return e}e.data={attributes:{}};const t=this.index;t!==null&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const i=this.attributes;for(const r in i){const c=i[r];e.data.attributes[r]=c.toJSON(e.data)}const s={};let n=!1;for(const r in this.morphAttributes){const c=this.morphAttributes[r],h=[];for(let d=0,u=c.length;d<u;d++){const p=c[d];h.push(p.toJSON(e.data))}h.length>0&&(s[r]=h,n=!0)}n&&(e.data.morphAttributes=s,e.data.morphTargetsRelative=this.morphTargetsRelative);const a=this.groups;a.length>0&&(e.data.groups=JSON.parse(JSON.stringify(a)));const o=this.boundingSphere;return o!==null&&(e.data.boundingSphere=o.toJSON()),e}clone(){return new this.constructor().copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const i=e.index;i!==null&&this.setIndex(i.clone());const s=e.attributes;for(const c in s){const h=s[c];this.setAttribute(c,h.clone(t))}const n=e.morphAttributes;for(const c in n){const h=[],d=n[c];for(let u=0,p=d.length;u<p;u++)h.push(d[u].clone(t));this.morphAttributes[c]=h}this.morphTargetsRelative=e.morphTargetsRelative;const a=e.groups;for(let c=0,h=a.length;c<h;c++){const d=a[c];this.addGroup(d.start,d.count,d.materialIndex)}const o=e.boundingBox;o!==null&&(this.boundingBox=o.clone());const r=e.boundingSphere;return r!==null&&(this.boundingSphere=r.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const Hu=new ut,Gn=new Wl,Rr=new Zs,qu=new T,Ir=new T,kr=new T,Pr=new T,Mc=new T,Dr=new T,Wu=new T,Lr=new T;class w extends ai{constructor(e=new mt,t=new B){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),e.morphTargetInfluences!==void 0&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),e.morphTargetDictionary!==void 0&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const t=this.geometry.morphAttributes,i=Object.keys(t);if(i.length>0){const s=t[i[0]];if(s!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let n=0,a=s.length;n<a;n++){const o=s[n].name||String(n);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=n}}}}getVertexPosition(e,t){const i=this.geometry,s=i.attributes.position,n=i.morphAttributes.position,a=i.morphTargetsRelative;t.fromBufferAttribute(s,e);const o=this.morphTargetInfluences;if(n&&o){Dr.set(0,0,0);for(let r=0,c=n.length;r<c;r++){const h=o[r],d=n[r];h!==0&&(Mc.fromBufferAttribute(d,e),a?Dr.addScaledVector(Mc,h):Dr.addScaledVector(Mc.sub(t),h))}t.add(Dr)}return t}raycast(e,t){const i=this.geometry,s=this.material,n=this.matrixWorld;s!==void 0&&(i.boundingSphere===null&&i.computeBoundingSphere(),Rr.copy(i.boundingSphere),Rr.applyMatrix4(n),Gn.copy(e.ray).recast(e.near),!(Rr.containsPoint(Gn.origin)===!1&&(Gn.intersectSphere(Rr,qu)===null||Gn.origin.distanceToSquared(qu)>(e.far-e.near)**2))&&(Hu.copy(n).invert(),Gn.copy(e.ray).applyMatrix4(Hu),!(i.boundingBox!==null&&Gn.intersectsBox(i.boundingBox)===!1)&&this._computeIntersections(e,t,Gn)))}_computeIntersections(e,t,i){let s;const n=this.geometry,a=this.material,o=n.index,r=n.attributes.position,c=n.attributes.uv,h=n.attributes.uv1,d=n.attributes.normal,u=n.groups,p=n.drawRange;if(o!==null)if(Array.isArray(a))for(let f=0,y=u.length;f<y;f++){const m=u[f],g=a[m.materialIndex],x=Math.max(m.start,p.start),v=Math.min(o.count,Math.min(m.start+m.count,p.start+p.count));for(let b=x,_=v;b<_;b+=3){const S=o.getX(b),A=o.getX(b+1),R=o.getX(b+2);s=Or(this,g,e,i,c,h,d,S,A,R),s&&(s.faceIndex=Math.floor(b/3),s.face.materialIndex=m.materialIndex,t.push(s))}}else{const f=Math.max(0,p.start),y=Math.min(o.count,p.start+p.count);for(let m=f,g=y;m<g;m+=3){const x=o.getX(m),v=o.getX(m+1),b=o.getX(m+2);s=Or(this,a,e,i,c,h,d,x,v,b),s&&(s.faceIndex=Math.floor(m/3),t.push(s))}}else if(r!==void 0)if(Array.isArray(a))for(let f=0,y=u.length;f<y;f++){const m=u[f],g=a[m.materialIndex],x=Math.max(m.start,p.start),v=Math.min(r.count,Math.min(m.start+m.count,p.start+p.count));for(let b=x,_=v;b<_;b+=3){const S=b,A=b+1,R=b+2;s=Or(this,g,e,i,c,h,d,S,A,R),s&&(s.faceIndex=Math.floor(b/3),s.face.materialIndex=m.materialIndex,t.push(s))}}else{const f=Math.max(0,p.start),y=Math.min(r.count,p.start+p.count);for(let m=f,g=y;m<g;m+=3){const x=m,v=m+1,b=m+2;s=Or(this,a,e,i,c,h,d,x,v,b),s&&(s.faceIndex=Math.floor(m/3),t.push(s))}}}}function Lg(l,e,t,i,s,n,a,o){let r;if(e.side===wi?r=i.intersectTriangle(a,n,s,!0,o):r=i.intersectTriangle(s,n,a,e.side===Xs,o),r===null)return null;Lr.copy(o),Lr.applyMatrix4(l.matrixWorld);const c=t.ray.origin.distanceTo(Lr);return c<t.near||c>t.far?null:{distance:c,point:Lr.clone(),object:l}}function Or(l,e,t,i,s,n,a,o,r,c){l.getVertexPosition(o,Ir),l.getVertexPosition(r,kr),l.getVertexPosition(c,Pr);const h=Lg(l,e,t,i,Ir,kr,Pr,Wu);if(h){const d=new T;ys.getBarycoord(Wu,Ir,kr,Pr,d),s&&(h.uv=ys.getInterpolatedAttribute(s,o,r,c,d,new le)),n&&(h.uv1=ys.getInterpolatedAttribute(n,o,r,c,d,new le)),a&&(h.normal=ys.getInterpolatedAttribute(a,o,r,c,d,new T),h.normal.dot(i.direction)>0&&h.normal.multiplyScalar(-1));const u={a:o,b:r,c,normal:new T,materialIndex:0};ys.getNormal(Ir,kr,Pr,u.normal),h.face=u,h.barycoord=d}return h}class ie extends mt{constructor(e=1,t=1,i=1,s=1,n=1,a=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:s,heightSegments:n,depthSegments:a};const o=this;s=Math.floor(s),n=Math.floor(n),a=Math.floor(a);const r=[],c=[],h=[],d=[];let u=0,p=0;f("z","y","x",-1,-1,i,t,e,a,n,0),f("z","y","x",1,-1,i,t,-e,a,n,1),f("x","z","y",1,1,e,i,t,s,a,2),f("x","z","y",1,-1,e,i,-t,s,a,3),f("x","y","z",1,-1,e,t,i,s,n,4),f("x","y","z",-1,-1,e,t,-i,s,n,5),this.setIndex(r),this.setAttribute("position",new Tt(c,3)),this.setAttribute("normal",new Tt(h,3)),this.setAttribute("uv",new Tt(d,2));function f(y,m,g,x,v,b,_,S,A,R,M){const C=b/A,k=_/R,L=b/2,O=_/2,W=S/2,U=A+1,$=R+1;let G=0,ee=0;const pe=new T;for(let me=0;me<$;me++){const ve=me*k-O;for(let tt=0;tt<U;tt++){const je=tt*C-L;pe[y]=je*x,pe[m]=ve*v,pe[g]=W,c.push(pe.x,pe.y,pe.z),pe[y]=0,pe[m]=0,pe[g]=S>0?1:-1,h.push(pe.x,pe.y,pe.z),d.push(tt/A),d.push(1-me/R),G+=1}}for(let me=0;me<R;me++)for(let ve=0;ve<A;ve++){const tt=u+ve+U*me,je=u+ve+U*(me+1),Ot=u+(ve+1)+U*(me+1),Nt=u+(ve+1)+U*me;r.push(tt,je,Nt),r.push(je,Ot,Nt),ee+=6}o.addGroup(p,ee,M),p+=ee,u+=G}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ie(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function Ya(l){const e={};for(const t in l){e[t]={};for(const i in l[t]){const s=l[t][i];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture||s.isQuaternion)?s.isRenderTargetTexture?(Qe("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),e[t][i]=null):e[t][i]=s.clone():Array.isArray(s)?e[t][i]=s.slice():e[t][i]=s}}return e}function Hi(l){const e={};for(let t=0;t<l.length;t++){const i=Ya(l[t]);for(const s in i)e[s]=i[s]}return e}function Og(l){const e=[];for(let t=0;t<l.length;t++)e.push(l[t].clone());return e}function hm(l){const e=l.getRenderTarget();return e===null?l.outputColorSpace:e.isXRRenderTarget===!0?e.texture.colorSpace:Rt.workingColorSpace}const tr={clone:Ya,merge:Hi};var Ng=`void main() {
	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
}`,Bg=`void main() {
	gl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );
}`;class Ci extends As{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader=Ng,this.fragmentShader=Bg,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,e!==void 0&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Ya(e.uniforms),this.uniformsGroups=Og(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this.defaultAttributeValues=Object.assign({},e.defaultAttributeValues),this.index0AttributeName=e.index0AttributeName,this.uniformsNeedUpdate=e.uniformsNeedUpdate,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const s in this.uniforms){const a=this.uniforms[s].value;a&&a.isTexture?t.uniforms[s]={type:"t",value:a.toJSON(e).uuid}:a&&a.isColor?t.uniforms[s]={type:"c",value:a.getHex()}:a&&a.isVector2?t.uniforms[s]={type:"v2",value:a.toArray()}:a&&a.isVector3?t.uniforms[s]={type:"v3",value:a.toArray()}:a&&a.isVector4?t.uniforms[s]={type:"v4",value:a.toArray()}:a&&a.isMatrix3?t.uniforms[s]={type:"m3",value:a.toArray()}:a&&a.isMatrix4?t.uniforms[s]={type:"m4",value:a.toArray()}:t.uniforms[s]={value:a}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const i={};for(const s in this.extensions)this.extensions[s]===!0&&(i[s]=!0);return Object.keys(i).length>0&&(t.extensions=i),t}}class dm extends ai{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new ut,this.projectionMatrix=new ut,this.projectionMatrixInverse=new ut,this.coordinateSystem=Gs,this._reversedDepth=!1}get reversedDepth(){return this._reversedDepth}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return new this.constructor().copy(this)}}const Tn=new T,Vu=new le,$u=new le;class Wi extends dm{constructor(e=50,t=1,i=.1,s=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=i,this.far=s,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=e.view===null?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=Xa*2*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(Uo*.5*this.fov);return .5*this.getFilmHeight()/e}getEffectiveFOV(){return Xa*2*Math.atan(Math.tan(Uo*.5*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,i){Tn.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(Tn.x,Tn.y).multiplyScalar(-e/Tn.z),Tn.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(Tn.x,Tn.y).multiplyScalar(-e/Tn.z)}getViewSize(e,t){return this.getViewBounds(e,Vu,$u),t.subVectors($u,Vu)}setViewOffset(e,t,i,s,n,a){this.aspect=e/t,this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=s,this.view.width=n,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(Uo*.5*this.fov)/this.zoom,i=2*t,s=this.aspect*i,n=-.5*s;const a=this.view;if(this.view!==null&&this.view.enabled){const r=a.fullWidth,c=a.fullHeight;n+=a.offsetX*s/r,t-=a.offsetY*i/c,s*=a.width/r,i*=a.height/c}const o=this.filmOffset;o!==0&&(n+=e*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+s,t,t-i,e,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,this.view!==null&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const Ma=-90,Sa=1;class zg extends ai{constructor(e,t,i){super(),this.type="CubeCamera",this.renderTarget=i,this.coordinateSystem=null,this.activeMipmapLevel=0;const s=new Wi(Ma,Sa,e,t);s.layers=this.layers,this.add(s);const n=new Wi(Ma,Sa,e,t);n.layers=this.layers,this.add(n);const a=new Wi(Ma,Sa,e,t);a.layers=this.layers,this.add(a);const o=new Wi(Ma,Sa,e,t);o.layers=this.layers,this.add(o);const r=new Wi(Ma,Sa,e,t);r.layers=this.layers,this.add(r);const c=new Wi(Ma,Sa,e,t);c.layers=this.layers,this.add(c)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[i,s,n,a,o,r]=t;for(const c of t)this.remove(c);if(e===Gs)i.up.set(0,1,0),i.lookAt(1,0,0),s.up.set(0,1,0),s.lookAt(-1,0,0),n.up.set(0,0,-1),n.lookAt(0,1,0),a.up.set(0,0,1),a.lookAt(0,-1,0),o.up.set(0,1,0),o.lookAt(0,0,1),r.up.set(0,1,0),r.lookAt(0,0,-1);else if(e===kl)i.up.set(0,-1,0),i.lookAt(-1,0,0),s.up.set(0,-1,0),s.lookAt(1,0,0),n.up.set(0,0,1),n.lookAt(0,1,0),a.up.set(0,0,-1),a.lookAt(0,-1,0),o.up.set(0,-1,0),o.lookAt(0,0,1),r.up.set(0,-1,0),r.lookAt(0,0,-1);else throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);for(const c of t)this.add(c),c.updateMatrixWorld()}update(e,t){this.parent===null&&this.updateMatrixWorld();const{renderTarget:i,activeMipmapLevel:s}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[n,a,o,r,c,h]=this.children,d=e.getRenderTarget(),u=e.getActiveCubeFace(),p=e.getActiveMipmapLevel(),f=e.xr.enabled;e.xr.enabled=!1;const y=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,e.setRenderTarget(i,0,s),e.render(t,n),e.setRenderTarget(i,1,s),e.render(t,a),e.setRenderTarget(i,2,s),e.render(t,o),e.setRenderTarget(i,3,s),e.render(t,r),e.setRenderTarget(i,4,s),e.render(t,c),i.texture.generateMipmaps=y,e.setRenderTarget(i,5,s),e.render(t,h),e.setRenderTarget(d,u,p),e.xr.enabled=f,i.texture.needsPMREMUpdate=!0}}class um extends _i{constructor(e=[],t=aa,i,s,n,a,o,r,c,h){super(e,t,i,s,n,a,o,r,c,h),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class pm extends ji{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const i={width:e,height:e,depth:1},s=[i,i,i,i,i,i];this.texture=new um(s),this._setTextureOptions(t),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i={uniforms:{tEquirect:{value:null}},vertexShader:`

				varying vec3 vWorldDirection;

				vec3 transformDirection( in vec3 dir, in mat4 matrix ) {

					return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );

				}

				void main() {

					vWorldDirection = transformDirection( position, modelMatrix );

					#include <begin_vertex>
					#include <project_vertex>

				}
			`,fragmentShader:`

				uniform sampler2D tEquirect;

				varying vec3 vWorldDirection;

				#include <common>

				void main() {

					vec3 direction = normalize( vWorldDirection );

					vec2 sampleUV = equirectUv( direction );

					gl_FragColor = texture2D( tEquirect, sampleUV );

				}
			`},s=new ie(5,5,5),n=new Ci({name:"CubemapFromEquirect",uniforms:Ya(i.uniforms),vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,side:wi,blending:qs});n.uniforms.tEquirect.value=t;const a=new w(s,n),o=t.minFilter;return t.minFilter===un&&(t.minFilter=bi),new zg(1,10,this).update(e,a),t.minFilter=o,a.geometry.dispose(),a.material.dispose(),this}clear(e,t=!0,i=!0,s=!0){const n=e.getRenderTarget();for(let a=0;a<6;a++)e.setRenderTarget(this,a),e.clear(t,i,s);e.setRenderTarget(n)}}class ne extends ai{constructor(){super(),this.isGroup=!0,this.type="Group"}}const Fg={type:"move"};class Sc{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return this._hand===null&&(this._hand=new ne,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return this._targetRay===null&&(this._targetRay=new ne,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new T,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new T),this._targetRay}getGripSpace(){return this._grip===null&&(this._grip=new ne,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new T,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new T),this._grip}dispatchEvent(e){return this._targetRay!==null&&this._targetRay.dispatchEvent(e),this._grip!==null&&this._grip.dispatchEvent(e),this._hand!==null&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const i of e.hand.values())this._getHandJoint(t,i)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),this._targetRay!==null&&(this._targetRay.visible=!1),this._grip!==null&&(this._grip.visible=!1),this._hand!==null&&(this._hand.visible=!1),this}update(e,t,i){let s=null,n=null,a=null;const o=this._targetRay,r=this._grip,c=this._hand;if(e&&t.session.visibilityState!=="visible-blurred"){if(c&&e.hand){a=!0;for(const y of e.hand.values()){const m=t.getJointPose(y,i),g=this._getHandJoint(c,y);m!==null&&(g.matrix.fromArray(m.transform.matrix),g.matrix.decompose(g.position,g.rotation,g.scale),g.matrixWorldNeedsUpdate=!0,g.jointRadius=m.radius),g.visible=m!==null}const h=c.joints["index-finger-tip"],d=c.joints["thumb-tip"],u=h.position.distanceTo(d.position),p=.02,f=.005;c.inputState.pinching&&u>p+f?(c.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!c.inputState.pinching&&u<=p-f&&(c.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else r!==null&&e.gripSpace&&(n=t.getPose(e.gripSpace,i),n!==null&&(r.matrix.fromArray(n.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.matrixWorldNeedsUpdate=!0,n.linearVelocity?(r.hasLinearVelocity=!0,r.linearVelocity.copy(n.linearVelocity)):r.hasLinearVelocity=!1,n.angularVelocity?(r.hasAngularVelocity=!0,r.angularVelocity.copy(n.angularVelocity)):r.hasAngularVelocity=!1));o!==null&&(s=t.getPose(e.targetRaySpace,i),s===null&&n!==null&&(s=n),s!==null&&(o.matrix.fromArray(s.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,s.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(s.linearVelocity)):o.hasLinearVelocity=!1,s.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(s.angularVelocity)):o.hasAngularVelocity=!1,this.dispatchEvent(Fg)))}return o!==null&&(o.visible=s!==null),r!==null&&(r.visible=n!==null),c!==null&&(c.visible=a!==null),this}_getHandJoint(e,t){if(e.joints[t.jointName]===void 0){const i=new ne;i.matrixAutoUpdate=!1,i.visible=!1,e.joints[t.jointName]=i,e.add(i)}return e.joints[t.jointName]}}class hr{constructor(e,t=25e-5){this.isFogExp2=!0,this.name="",this.color=new H(e),this.density=t}clone(){return new hr(this.color,this.density)}toJSON(){return{type:"FogExp2",name:this.name,color:this.color.getHex(),density:this.density}}}class Ug extends ai{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new nt,this.environmentIntensity=1,this.environmentRotation=new nt,this.overrideMaterial=null,typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),e.background!==null&&(this.background=e.background.clone()),e.environment!==null&&(this.environment=e.environment.clone()),e.fog!==null&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),e.overrideMaterial!==null&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return this.fog!==null&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),this.backgroundIntensity!==1&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),this.environmentIntensity!==1&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}class $d{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=e!==void 0?e.length/t:0,this.usage=cd,this.updateRanges=[],this.version=0,this.uuid=bs()}onUploadCallback(){}set needsUpdate(e){e===!0&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,i){e*=this.stride,i*=t.stride;for(let s=0,n=this.stride;s<n;s++)this.array[e+s]=t.array[i+s];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){e.arrayBuffers===void 0&&(e.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=bs()),e.arrayBuffers[this.array.buffer._uuid]===void 0&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),i=new this.constructor(t,this.stride);return i.setUsage(this.usage),i}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return e.arrayBuffers===void 0&&(e.arrayBuffers={}),this.array.buffer._uuid===void 0&&(this.array.buffer._uuid=bs()),e.arrayBuffers[this.array.buffer._uuid]===void 0&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const Gi=new T;class Qa{constructor(e,t,i,s=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=t,this.offset=i,this.normalized=s}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,i=this.data.count;t<i;t++)Gi.fromBufferAttribute(this,t),Gi.applyMatrix4(e),this.setXYZ(t,Gi.x,Gi.y,Gi.z);return this}applyNormalMatrix(e){for(let t=0,i=this.count;t<i;t++)Gi.fromBufferAttribute(this,t),Gi.applyNormalMatrix(e),this.setXYZ(t,Gi.x,Gi.y,Gi.z);return this}transformDirection(e){for(let t=0,i=this.count;t<i;t++)Gi.fromBufferAttribute(this,t),Gi.transformDirection(e),this.setXYZ(t,Gi.x,Gi.y,Gi.z);return this}getComponent(e,t){let i=this.array[e*this.data.stride+this.offset+t];return this.normalized&&(i=Es(i,this.array)),i}setComponent(e,t,i){return this.normalized&&(i=Vt(i,this.array)),this.data.array[e*this.data.stride+this.offset+t]=i,this}setX(e,t){return this.normalized&&(t=Vt(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=Vt(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=Vt(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=Vt(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=Es(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=Es(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=Es(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=Es(t,this.array)),t}setXY(e,t,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=Vt(t,this.array),i=Vt(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this}setXYZ(e,t,i,s){return e=e*this.data.stride+this.offset,this.normalized&&(t=Vt(t,this.array),i=Vt(i,this.array),s=Vt(s,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=s,this}setXYZW(e,t,i,s,n){return e=e*this.data.stride+this.offset,this.normalized&&(t=Vt(t,this.array),i=Vt(i,this.array),s=Vt(s,this.array),n=Vt(n,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=s,this.data.array[e+3]=n,this}clone(e){if(e===void 0){Pl("InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");const t=[];for(let i=0;i<this.count;i++){const s=i*this.data.stride+this.offset;for(let n=0;n<this.itemSize;n++)t.push(this.data.array[s+n])}return new Je(new this.array.constructor(t),this.itemSize,this.normalized)}else return e.interleavedBuffers===void 0&&(e.interleavedBuffers={}),e.interleavedBuffers[this.data.uuid]===void 0&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new Qa(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(e===void 0){Pl("InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");const t=[];for(let i=0;i<this.count;i++){const s=i*this.data.stride+this.offset;for(let n=0;n<this.itemSize;n++)t.push(this.data.array[s+n])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:t,normalized:this.normalized}}else return e.interleavedBuffers===void 0&&(e.interleavedBuffers={}),e.interleavedBuffers[this.data.uuid]===void 0&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}class Xd extends As{constructor(e){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new H(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}let Ta;const vo=new T,Ea=new T,Ca=new T,Aa=new le,xo=new le,fm=new ut,Nr=new T,bo=new T,Br=new T,Xu=new le,Tc=new le,Yu=new le;class mm extends ai{constructor(e=new Xd){if(super(),this.isSprite=!0,this.type="Sprite",Ta===void 0){Ta=new mt;const t=new Float32Array([-.5,-.5,0,0,0,.5,-.5,0,1,0,.5,.5,0,1,1,-.5,.5,0,0,1]),i=new $d(t,5);Ta.setIndex([0,1,2,0,2,3]),Ta.setAttribute("position",new Qa(i,3,0,!1)),Ta.setAttribute("uv",new Qa(i,2,3,!1))}this.geometry=Ta,this.material=e,this.center=new le(.5,.5),this.count=1}raycast(e,t){e.camera===null&&rt('Sprite: "Raycaster.camera" needs to be set in order to raycast against sprites.'),Ea.setFromMatrixScale(this.matrixWorld),fm.copy(e.camera.matrixWorld),this.modelViewMatrix.multiplyMatrices(e.camera.matrixWorldInverse,this.matrixWorld),Ca.setFromMatrixPosition(this.modelViewMatrix),e.camera.isPerspectiveCamera&&this.material.sizeAttenuation===!1&&Ea.multiplyScalar(-Ca.z);const i=this.material.rotation;let s,n;i!==0&&(n=Math.cos(i),s=Math.sin(i));const a=this.center;zr(Nr.set(-.5,-.5,0),Ca,a,Ea,s,n),zr(bo.set(.5,-.5,0),Ca,a,Ea,s,n),zr(Br.set(.5,.5,0),Ca,a,Ea,s,n),Xu.set(0,0),Tc.set(1,0),Yu.set(1,1);let o=e.ray.intersectTriangle(Nr,bo,Br,!1,vo);if(o===null&&(zr(bo.set(-.5,.5,0),Ca,a,Ea,s,n),Tc.set(0,1),o=e.ray.intersectTriangle(Nr,Br,bo,!1,vo),o===null))return;const r=e.ray.origin.distanceTo(vo);r<e.near||r>e.far||t.push({distance:r,point:vo.clone(),uv:ys.getInterpolation(vo,Nr,bo,Br,Xu,Tc,Yu,new le),face:null,object:this})}copy(e,t){return super.copy(e,t),e.center!==void 0&&this.center.copy(e.center),this.material=e.material,this}}function zr(l,e,t,i,s,n){Aa.subVectors(l,t).addScalar(.5).multiply(i),s!==void 0?(xo.x=n*Aa.x-s*Aa.y,xo.y=s*Aa.x+n*Aa.y):xo.copy(Aa),l.copy(e),l.x+=xo.x,l.y+=xo.y,l.applyMatrix4(fm)}const Qu=new T,ju=new ni,Ku=new ni,Gg=new T,Zu=new ut,Fr=new T,Ec=new Zs,Ju=new ut,Cc=new Wl;class Hg extends w{constructor(e,t){super(e,t),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=Eu,this.bindMatrix=new ut,this.bindMatrixInverse=new ut,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const e=this.geometry;this.boundingBox===null&&(this.boundingBox=new Qi),this.boundingBox.makeEmpty();const t=e.getAttribute("position");for(let i=0;i<t.count;i++)this.getVertexPosition(i,Fr),this.boundingBox.expandByPoint(Fr)}computeBoundingSphere(){const e=this.geometry;this.boundingSphere===null&&(this.boundingSphere=new Zs),this.boundingSphere.makeEmpty();const t=e.getAttribute("position");for(let i=0;i<t.count;i++)this.getVertexPosition(i,Fr),this.boundingSphere.expandByPoint(Fr)}copy(e,t){return super.copy(e,t),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,e.boundingBox!==null&&(this.boundingBox=e.boundingBox.clone()),e.boundingSphere!==null&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,t){const i=this.material,s=this.matrixWorld;i!==void 0&&(this.boundingSphere===null&&this.computeBoundingSphere(),Ec.copy(this.boundingSphere),Ec.applyMatrix4(s),e.ray.intersectsSphere(Ec)!==!1&&(Ju.copy(s).invert(),Cc.copy(e.ray).applyMatrix4(Ju),!(this.boundingBox!==null&&Cc.intersectsBox(this.boundingBox)===!1)&&this._computeIntersections(e,t,Cc)))}getVertexPosition(e,t){return super.getVertexPosition(e,t),this.applyBoneTransform(e,t),t}bind(e,t){this.skeleton=e,t===void 0&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new ni,t=this.geometry.attributes.skinWeight;for(let i=0,s=t.count;i<s;i++){e.fromBufferAttribute(t,i);const n=1/e.manhattanLength();n!==1/0?e.multiplyScalar(n):e.set(1,0,0,0),t.setXYZW(i,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode===Eu?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode===G0?this.bindMatrixInverse.copy(this.bindMatrix).invert():Qe("SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(e,t){const i=this.skeleton,s=this.geometry;ju.fromBufferAttribute(s.attributes.skinIndex,e),Ku.fromBufferAttribute(s.attributes.skinWeight,e),Qu.copy(t).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let n=0;n<4;n++){const a=Ku.getComponent(n);if(a!==0){const o=ju.getComponent(n);Zu.multiplyMatrices(i.bones[o].matrixWorld,i.boneInverses[o]),t.addScaledVector(Gg.copy(Qu).applyMatrix4(Zu),a)}}return t.applyMatrix4(this.bindMatrixInverse)}}class gm extends ai{constructor(){super(),this.isBone=!0,this.type="Bone"}}class Yd extends _i{constructor(e=null,t=1,i=1,s,n,a,o,r,c=xi,h=xi,d,u){super(null,a,o,r,c,h,s,n,d,u),this.isDataTexture=!0,this.image={data:e,width:t,height:i},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}const ep=new ut,qg=new ut;class Qd{constructor(e=[],t=[]){this.uuid=bs(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.previousBoneMatrices=null,this.boneTexture=null,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(e.length*16),t.length===0)this.calculateInverses();else if(e.length!==t.length){Qe("Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let i=0,s=this.bones.length;i<s;i++)this.boneInverses.push(new ut)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const i=new ut;this.bones[e]&&i.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(i)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const i=this.bones[e];i&&i.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const i=this.bones[e];i&&(i.parent&&i.parent.isBone?(i.matrix.copy(i.parent.matrixWorld).invert(),i.matrix.multiply(i.matrixWorld)):i.matrix.copy(i.matrixWorld),i.matrix.decompose(i.position,i.quaternion,i.scale))}}update(){const e=this.bones,t=this.boneInverses,i=this.boneMatrices,s=this.boneTexture;for(let n=0,a=e.length;n<a;n++){const o=e[n]?e[n].matrixWorld:qg;ep.multiplyMatrices(o,t[n]),ep.toArray(i,n*16)}s!==null&&(s.needsUpdate=!0)}clone(){return new Qd(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(this.bones.length*4);e=Math.ceil(e/4)*4,e=Math.max(e,4);const t=new Float32Array(e*e*4);t.set(this.boneMatrices);const i=new Yd(t,e,e,xs,vs);return i.needsUpdate=!0,this.boneMatrices=t,this.boneTexture=i,this}getBoneByName(e){for(let t=0,i=this.bones.length;t<i;t++){const s=this.bones[t];if(s.name===e)return s}}dispose(){this.boneTexture!==null&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let i=0,s=e.bones.length;i<s;i++){const n=e.bones[i];let a=t[n];a===void 0&&(Qe("Skeleton: No bone found with UUID:",n),a=new gm),this.bones.push(a),this.boneInverses.push(new ut().fromArray(e.boneInverses[i]))}return this.init(),this}toJSON(){const e={metadata:{version:4.7,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,i=this.boneInverses;for(let s=0,n=t.length;s<n;s++){const a=t[s];e.bones.push(a.uuid);const o=i[s];e.boneInverses.push(o.toArray())}return e}}class hd extends Je{constructor(e,t,i,s=1){super(e,t,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=s}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}const Ra=new ut,tp=new ut,Ur=[],ip=new Qi,Wg=new ut,wo=new w,_o=new Zs;class Qn extends w{constructor(e,t,i){super(e,t),this.isInstancedMesh=!0,this.instanceMatrix=new hd(new Float32Array(i*16),16),this.instanceColor=null,this.morphTexture=null,this.count=i,this.boundingBox=null,this.boundingSphere=null;for(let s=0;s<i;s++)this.setMatrixAt(s,Wg)}computeBoundingBox(){const e=this.geometry,t=this.count;this.boundingBox===null&&(this.boundingBox=new Qi),e.boundingBox===null&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,Ra),ip.copy(e.boundingBox).applyMatrix4(Ra),this.boundingBox.union(ip)}computeBoundingSphere(){const e=this.geometry,t=this.count;this.boundingSphere===null&&(this.boundingSphere=new Zs),e.boundingSphere===null&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let i=0;i<t;i++)this.getMatrixAt(i,Ra),_o.copy(e.boundingSphere).applyMatrix4(Ra),this.boundingSphere.union(_o)}copy(e,t){return super.copy(e,t),this.instanceMatrix.copy(e.instanceMatrix),e.morphTexture!==null&&(this.morphTexture=e.morphTexture.clone()),e.instanceColor!==null&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,e.boundingBox!==null&&(this.boundingBox=e.boundingBox.clone()),e.boundingSphere!==null&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,t){t.fromArray(this.instanceColor.array,e*3)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,e*16)}getMorphAt(e,t){const i=t.morphTargetInfluences,s=this.morphTexture.source.data.data,n=i.length+1,a=e*n+1;for(let o=0;o<i.length;o++)i[o]=s[a+o]}raycast(e,t){const i=this.matrixWorld,s=this.count;if(wo.geometry=this.geometry,wo.material=this.material,wo.material!==void 0&&(this.boundingSphere===null&&this.computeBoundingSphere(),_o.copy(this.boundingSphere),_o.applyMatrix4(i),e.ray.intersectsSphere(_o)!==!1))for(let n=0;n<s;n++){this.getMatrixAt(n,Ra),tp.multiplyMatrices(i,Ra),wo.matrixWorld=tp,wo.raycast(e,Ur);for(let a=0,o=Ur.length;a<o;a++){const r=Ur[a];r.instanceId=n,r.object=this,t.push(r)}Ur.length=0}}setColorAt(e,t){this.instanceColor===null&&(this.instanceColor=new hd(new Float32Array(this.instanceMatrix.count*3).fill(1),3)),t.toArray(this.instanceColor.array,e*3)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,e*16)}setMorphAt(e,t){const i=t.morphTargetInfluences,s=i.length+1;this.morphTexture===null&&(this.morphTexture=new Yd(new Float32Array(s*this.count),s,this.count,Bd,vs));const n=this.morphTexture.source.data.data;let a=0;for(let c=0;c<i.length;c++)a+=i[c];const o=this.geometry.morphTargetsRelative?1:1-a,r=s*e;n[r]=o,n.set(i,r+1)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"}),this.morphTexture!==null&&(this.morphTexture.dispose(),this.morphTexture=null)}}const Ac=new T,Vg=new T,$g=new yt;class jn{constructor(e=new T(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,i,s){return this.normal.set(e,t,i),this.constant=s,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,i){const s=Ac.subVectors(i,t).cross(Vg.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(s,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const i=e.delta(Ac),s=this.normal.dot(i);if(s===0)return this.distanceToPoint(e.start)===0?t.copy(e.start):null;const n=-(e.start.dot(this.normal)+this.constant)/s;return n<0||n>1?null:t.copy(e.start).addScaledVector(i,n)}intersectsLine(e){const t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const i=t||$g.getNormalMatrix(e),s=this.coplanarPoint(Ac).applyMatrix4(e),n=this.normal.applyMatrix3(i).normalize();return this.constant=-s.dot(n),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return new this.constructor().copy(this)}}const Hn=new Zs,Xg=new le(.5,.5),Gr=new T;class jd{constructor(e=new jn,t=new jn,i=new jn,s=new jn,n=new jn,a=new jn){this.planes=[e,t,i,s,n,a]}set(e,t,i,s,n,a){const o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(i),o[3].copy(s),o[4].copy(n),o[5].copy(a),this}copy(e){const t=this.planes;for(let i=0;i<6;i++)t[i].copy(e.planes[i]);return this}setFromProjectionMatrix(e,t=Gs,i=!1){const s=this.planes,n=e.elements,a=n[0],o=n[1],r=n[2],c=n[3],h=n[4],d=n[5],u=n[6],p=n[7],f=n[8],y=n[9],m=n[10],g=n[11],x=n[12],v=n[13],b=n[14],_=n[15];if(s[0].setComponents(c-a,p-h,g-f,_-x).normalize(),s[1].setComponents(c+a,p+h,g+f,_+x).normalize(),s[2].setComponents(c+o,p+d,g+y,_+v).normalize(),s[3].setComponents(c-o,p-d,g-y,_-v).normalize(),i)s[4].setComponents(r,u,m,b).normalize(),s[5].setComponents(c-r,p-u,g-m,_-b).normalize();else if(s[4].setComponents(c-r,p-u,g-m,_-b).normalize(),t===Gs)s[5].setComponents(c+r,p+u,g+m,_+b).normalize();else if(t===kl)s[5].setComponents(r,u,m,b).normalize();else throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);return this}intersectsObject(e){if(e.boundingSphere!==void 0)e.boundingSphere===null&&e.computeBoundingSphere(),Hn.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;t.boundingSphere===null&&t.computeBoundingSphere(),Hn.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(Hn)}intersectsSprite(e){Hn.center.set(0,0,0);const t=Xg.distanceTo(e.center);return Hn.radius=.7071067811865476+t,Hn.applyMatrix4(e.matrixWorld),this.intersectsSphere(Hn)}intersectsSphere(e){const t=this.planes,i=e.center,s=-e.radius;for(let n=0;n<6;n++)if(t[n].distanceToPoint(i)<s)return!1;return!0}intersectsBox(e){const t=this.planes;for(let i=0;i<6;i++){const s=t[i];if(Gr.x=s.normal.x>0?e.max.x:e.min.x,Gr.y=s.normal.y>0?e.max.y:e.min.y,Gr.z=s.normal.z>0?e.max.z:e.min.z,s.distanceToPoint(Gr)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}clone(){return new this.constructor().copy(this)}}class Kd extends As{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new H(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const Dl=new T,Ll=new T,sp=new ut,Mo=new Wl,Hr=new Zs,Rc=new T,np=new T;class Vl extends ai{constructor(e=new mt,t=new Kd){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(e.index===null){const t=e.attributes.position,i=[0];for(let s=1,n=t.count;s<n;s++)Dl.fromBufferAttribute(t,s-1),Ll.fromBufferAttribute(t,s),i[s]=i[s-1],i[s]+=Dl.distanceTo(Ll);e.setAttribute("lineDistance",new Tt(i,1))}else Qe("Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const i=this.geometry,s=this.matrixWorld,n=e.params.Line.threshold,a=i.drawRange;if(i.boundingSphere===null&&i.computeBoundingSphere(),Hr.copy(i.boundingSphere),Hr.applyMatrix4(s),Hr.radius+=n,e.ray.intersectsSphere(Hr)===!1)return;sp.copy(s).invert(),Mo.copy(e.ray).applyMatrix4(sp);const o=n/((this.scale.x+this.scale.y+this.scale.z)/3),r=o*o,c=this.isLineSegments?2:1,h=i.index,u=i.attributes.position;if(h!==null){const p=Math.max(0,a.start),f=Math.min(h.count,a.start+a.count);for(let y=p,m=f-1;y<m;y+=c){const g=h.getX(y),x=h.getX(y+1),v=qr(this,e,Mo,r,g,x,y);v&&t.push(v)}if(this.isLineLoop){const y=h.getX(f-1),m=h.getX(p),g=qr(this,e,Mo,r,y,m,f-1);g&&t.push(g)}}else{const p=Math.max(0,a.start),f=Math.min(u.count,a.start+a.count);for(let y=p,m=f-1;y<m;y+=c){const g=qr(this,e,Mo,r,y,y+1,y);g&&t.push(g)}if(this.isLineLoop){const y=qr(this,e,Mo,r,f-1,p,f-1);y&&t.push(y)}}}updateMorphTargets(){const t=this.geometry.morphAttributes,i=Object.keys(t);if(i.length>0){const s=t[i[0]];if(s!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let n=0,a=s.length;n<a;n++){const o=s[n].name||String(n);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=n}}}}}function qr(l,e,t,i,s,n,a){const o=l.geometry.attributes.position;if(Dl.fromBufferAttribute(o,s),Ll.fromBufferAttribute(o,n),t.distanceSqToSegment(Dl,Ll,Rc,np)>i)return;Rc.applyMatrix4(l.matrixWorld);const c=e.ray.origin.distanceTo(Rc);if(!(c<e.near||c>e.far))return{distance:c,point:np.clone().applyMatrix4(l.matrixWorld),index:a,face:null,faceIndex:null,barycoord:null,object:l}}const ap=new T,op=new T;class Yg extends Vl{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(e.index===null){const t=e.attributes.position,i=[];for(let s=0,n=t.count;s<n;s+=2)ap.fromBufferAttribute(t,s),op.fromBufferAttribute(t,s+1),i[s]=s===0?0:i[s-1],i[s+1]=i[s]+ap.distanceTo(op);e.setAttribute("lineDistance",new Tt(i,1))}else Qe("LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class Qg extends Vl{constructor(e,t){super(e,t),this.isLineLoop=!0,this.type="LineLoop"}}class Ri extends As{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new H(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}const rp=new ut,dd=new Wl,Wr=new Zs,Vr=new T;class Bi extends ai{constructor(e=new mt,t=new Ri){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,t){const i=this.geometry,s=this.matrixWorld,n=e.params.Points.threshold,a=i.drawRange;if(i.boundingSphere===null&&i.computeBoundingSphere(),Wr.copy(i.boundingSphere),Wr.applyMatrix4(s),Wr.radius+=n,e.ray.intersectsSphere(Wr)===!1)return;rp.copy(s).invert(),dd.copy(e.ray).applyMatrix4(rp);const o=n/((this.scale.x+this.scale.y+this.scale.z)/3),r=o*o,c=i.index,d=i.attributes.position;if(c!==null){const u=Math.max(0,a.start),p=Math.min(c.count,a.start+a.count);for(let f=u,y=p;f<y;f++){const m=c.getX(f);Vr.fromBufferAttribute(d,m),lp(Vr,m,r,s,e,t,this)}}else{const u=Math.max(0,a.start),p=Math.min(d.count,a.start+a.count);for(let f=u,y=p;f<y;f++)Vr.fromBufferAttribute(d,f),lp(Vr,f,r,s,e,t,this)}}updateMorphTargets(){const t=this.geometry.morphAttributes,i=Object.keys(t);if(i.length>0){const s=t[i[0]];if(s!==void 0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let n=0,a=s.length;n<a;n++){const o=s[n].name||String(n);this.morphTargetInfluences.push(0),this.morphTargetDictionary[o]=n}}}}}function lp(l,e,t,i,s,n,a){const o=dd.distanceSqToPoint(l);if(o<t){const r=new T;dd.closestPointToPoint(l,r),r.applyMatrix4(i);const c=s.ray.origin.distanceTo(r);if(c<s.near||c>s.far)return;n.push({distance:c,distanceToRay:Math.sqrt(o),point:r,index:e,face:null,faceIndex:null,barycoord:null,object:a})}}class Zd extends _i{constructor(e,t,i,s,n,a,o,r,c){super(e,t,i,s,n,a,o,r,c),this.isCanvasTexture=!0,this.needsUpdate=!0}}class ir extends _i{constructor(e,t,i=Qs,s,n,a,o=xi,r=xi,c,h=yn,d=1){if(h!==yn&&h!==ea)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");const u={width:e,height:t,depth:d};super(u,s,n,a,o,r,h,i,c),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new Vd(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return this.compareFunction!==null&&(t.compareFunction=this.compareFunction),t}}class jg extends ir{constructor(e,t=Qs,i=aa,s,n,a=xi,o=xi,r,c=yn){const h={width:e,height:e,depth:1},d=[h,h,h,h,h,h];super(e,e,t,i,s,n,a,o,r,c),this.image=d,this.isCubeDepthTexture=!0,this.isCubeTexture=!0}get images(){return this.image}set images(e){this.image=e}}class ym extends _i{constructor(e=null){super(),this.sourceTexture=e,this.isExternalTexture=!0}copy(e){return super.copy(e),this.sourceTexture=e.sourceTexture,this}}class Pt extends mt{constructor(e=1,t=1,i=4,s=8,n=1){super(),this.type="CapsuleGeometry",this.parameters={radius:e,height:t,capSegments:i,radialSegments:s,heightSegments:n},t=Math.max(0,t),i=Math.max(1,Math.floor(i)),s=Math.max(3,Math.floor(s)),n=Math.max(1,Math.floor(n));const a=[],o=[],r=[],c=[],h=t/2,d=Math.PI/2*e,u=t,p=2*d+u,f=i*2+n,y=s+1,m=new T,g=new T;for(let x=0;x<=f;x++){let v=0,b=0,_=0,S=0;if(x<=i){const M=x/i,C=M*Math.PI/2;b=-h-e*Math.cos(C),_=e*Math.sin(C),S=-e*Math.cos(C),v=M*d}else if(x<=i+n){const M=(x-i)/n;b=-h+M*t,_=e,S=0,v=d+M*u}else{const M=(x-i-n)/i,C=M*Math.PI/2;b=h+e*Math.sin(C),_=e*Math.cos(C),S=e*Math.sin(C),v=d+u+M*d}const A=Math.max(0,Math.min(1,v/p));let R=0;x===0?R=.5/s:x===f&&(R=-.5/s);for(let M=0;M<=s;M++){const C=M/s,k=C*Math.PI*2,L=Math.sin(k),O=Math.cos(k);g.x=-_*O,g.y=b,g.z=_*L,o.push(g.x,g.y,g.z),m.set(-_*O,S,_*L),m.normalize(),r.push(m.x,m.y,m.z),c.push(C+R,A)}if(x>0){const M=(x-1)*y;for(let C=0;C<s;C++){const k=M+C,L=M+C+1,O=x*y+C,W=x*y+C+1;a.push(k,L,O),a.push(L,W,O)}}}this.setIndex(a),this.setAttribute("position",new Tt(o,3)),this.setAttribute("normal",new Tt(r,3)),this.setAttribute("uv",new Tt(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Pt(e.radius,e.height,e.capSegments,e.radialSegments,e.heightSegments)}}class Zi extends mt{constructor(e=1,t=32,i=0,s=Math.PI*2){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:s},t=Math.max(3,t);const n=[],a=[],o=[],r=[],c=new T,h=new le;a.push(0,0,0),o.push(0,0,1),r.push(.5,.5);for(let d=0,u=3;d<=t;d++,u+=3){const p=i+d/t*s;c.x=e*Math.cos(p),c.y=e*Math.sin(p),a.push(c.x,c.y,c.z),o.push(0,0,1),h.x=(a[u]/e+1)/2,h.y=(a[u+1]/e+1)/2,r.push(h.x,h.y)}for(let d=1;d<=t;d++)n.push(d,d+1,0);this.setIndex(n),this.setAttribute("position",new Tt(a,3)),this.setAttribute("normal",new Tt(o,3)),this.setAttribute("uv",new Tt(r,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Zi(e.radius,e.segments,e.thetaStart,e.thetaLength)}}class ce extends mt{constructor(e=1,t=1,i=1,s=32,n=1,a=!1,o=0,r=Math.PI*2){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:s,heightSegments:n,openEnded:a,thetaStart:o,thetaLength:r};const c=this;s=Math.floor(s),n=Math.floor(n);const h=[],d=[],u=[],p=[];let f=0;const y=[],m=i/2;let g=0;x(),a===!1&&(e>0&&v(!0),t>0&&v(!1)),this.setIndex(h),this.setAttribute("position",new Tt(d,3)),this.setAttribute("normal",new Tt(u,3)),this.setAttribute("uv",new Tt(p,2));function x(){const b=new T,_=new T;let S=0;const A=(t-e)/i;for(let R=0;R<=n;R++){const M=[],C=R/n,k=C*(t-e)+e;for(let L=0;L<=s;L++){const O=L/s,W=O*r+o,U=Math.sin(W),$=Math.cos(W);_.x=k*U,_.y=-C*i+m,_.z=k*$,d.push(_.x,_.y,_.z),b.set(U,A,$).normalize(),u.push(b.x,b.y,b.z),p.push(O,1-C),M.push(f++)}y.push(M)}for(let R=0;R<s;R++)for(let M=0;M<n;M++){const C=y[M][R],k=y[M+1][R],L=y[M+1][R+1],O=y[M][R+1];(e>0||M!==0)&&(h.push(C,k,O),S+=3),(t>0||M!==n-1)&&(h.push(k,L,O),S+=3)}c.addGroup(g,S,0),g+=S}function v(b){const _=f,S=new le,A=new T;let R=0;const M=b===!0?e:t,C=b===!0?1:-1;for(let L=1;L<=s;L++)d.push(0,m*C,0),u.push(0,C,0),p.push(.5,.5),f++;const k=f;for(let L=0;L<=s;L++){const W=L/s*r+o,U=Math.cos(W),$=Math.sin(W);A.x=M*$,A.y=m*C,A.z=M*U,d.push(A.x,A.y,A.z),u.push(0,C,0),S.x=U*.5+.5,S.y=$*.5*C+.5,p.push(S.x,S.y),f++}for(let L=0;L<s;L++){const O=_+L,W=k+L;b===!0?h.push(W,W+1,O):h.push(W+1,W,O),R+=3}c.addGroup(g,R,b===!0?1:2),g+=R}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new ce(e.radiusTop,e.radiusBottom,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class wt extends ce{constructor(e=1,t=1,i=32,s=1,n=!1,a=0,o=Math.PI*2){super(0,e,t,i,s,n,a,o),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:s,openEnded:n,thetaStart:a,thetaLength:o}}static fromJSON(e){return new wt(e.radius,e.height,e.radialSegments,e.heightSegments,e.openEnded,e.thetaStart,e.thetaLength)}}class so extends mt{constructor(e=[],t=[],i=1,s=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:s};const n=[],a=[];o(s),c(i),h(),this.setAttribute("position",new Tt(n,3)),this.setAttribute("normal",new Tt(n.slice(),3)),this.setAttribute("uv",new Tt(a,2)),s===0?this.computeVertexNormals():this.normalizeNormals();function o(x){const v=new T,b=new T,_=new T;for(let S=0;S<t.length;S+=3)p(t[S+0],v),p(t[S+1],b),p(t[S+2],_),r(v,b,_,x)}function r(x,v,b,_){const S=_+1,A=[];for(let R=0;R<=S;R++){A[R]=[];const M=x.clone().lerp(b,R/S),C=v.clone().lerp(b,R/S),k=S-R;for(let L=0;L<=k;L++)L===0&&R===S?A[R][L]=M:A[R][L]=M.clone().lerp(C,L/k)}for(let R=0;R<S;R++)for(let M=0;M<2*(S-R)-1;M++){const C=Math.floor(M/2);M%2===0?(u(A[R][C+1]),u(A[R+1][C]),u(A[R][C])):(u(A[R][C+1]),u(A[R+1][C+1]),u(A[R+1][C]))}}function c(x){const v=new T;for(let b=0;b<n.length;b+=3)v.x=n[b+0],v.y=n[b+1],v.z=n[b+2],v.normalize().multiplyScalar(x),n[b+0]=v.x,n[b+1]=v.y,n[b+2]=v.z}function h(){const x=new T;for(let v=0;v<n.length;v+=3){x.x=n[v+0],x.y=n[v+1],x.z=n[v+2];const b=m(x)/2/Math.PI+.5,_=g(x)/Math.PI+.5;a.push(b,1-_)}f(),d()}function d(){for(let x=0;x<a.length;x+=6){const v=a[x+0],b=a[x+2],_=a[x+4],S=Math.max(v,b,_),A=Math.min(v,b,_);S>.9&&A<.1&&(v<.2&&(a[x+0]+=1),b<.2&&(a[x+2]+=1),_<.2&&(a[x+4]+=1))}}function u(x){n.push(x.x,x.y,x.z)}function p(x,v){const b=x*3;v.x=e[b+0],v.y=e[b+1],v.z=e[b+2]}function f(){const x=new T,v=new T,b=new T,_=new T,S=new le,A=new le,R=new le;for(let M=0,C=0;M<n.length;M+=9,C+=6){x.set(n[M+0],n[M+1],n[M+2]),v.set(n[M+3],n[M+4],n[M+5]),b.set(n[M+6],n[M+7],n[M+8]),S.set(a[C+0],a[C+1]),A.set(a[C+2],a[C+3]),R.set(a[C+4],a[C+5]),_.copy(x).add(v).add(b).divideScalar(3);const k=m(_);y(S,C+0,x,k),y(A,C+2,v,k),y(R,C+4,b,k)}}function y(x,v,b,_){_<0&&x.x===1&&(a[v]=x.x-1),b.x===0&&b.z===0&&(a[v]=_/2/Math.PI+.5)}function m(x){return Math.atan2(x.z,-x.x)}function g(x){return Math.atan2(-x.y,Math.sqrt(x.x*x.x+x.z*x.z))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new so(e.vertices,e.indices,e.radius,e.detail)}}class js extends so{constructor(e=1,t=0){const i=(1+Math.sqrt(5))/2,s=1/i,n=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-s,-i,0,-s,i,0,s,-i,0,s,i,-s,-i,0,-s,i,0,s,-i,0,s,i,0,-i,0,-s,i,0,-s,-i,0,s,i,0,s],a=[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9];super(n,a,e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new js(e.radius,e.detail)}}class Js{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){Qe("Curve: .getPoint() not implemented.")}getPointAt(e,t){const i=this.getUtoTmapping(e);return this.getPoint(i,t)}getPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return t}getSpacedPoints(e=5){const t=[];for(let i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let i,s=this.getPoint(0),n=0;t.push(0);for(let a=1;a<=e;a++)i=this.getPoint(a/e),n+=i.distanceTo(s),t.push(n),s=i;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t=null){const i=this.getLengths();let s=0;const n=i.length;let a;t?a=t:a=e*i[n-1];let o=0,r=n-1,c;for(;o<=r;)if(s=Math.floor(o+(r-o)/2),c=i[s]-a,c<0)o=s+1;else if(c>0)r=s-1;else{r=s;break}if(s=r,i[s]===a)return s/(n-1);const h=i[s],u=i[s+1]-h,p=(a-h)/u;return(s+p)/(n-1)}getTangent(e,t){let s=e-1e-4,n=e+1e-4;s<0&&(s=0),n>1&&(n=1);const a=this.getPoint(s),o=this.getPoint(n),r=t||(a.isVector2?new le:new T);return r.copy(o).sub(a).normalize(),r}getTangentAt(e,t){const i=this.getUtoTmapping(e);return this.getTangent(i,t)}computeFrenetFrames(e,t=!1){const i=new T,s=[],n=[],a=[],o=new T,r=new ut;for(let p=0;p<=e;p++){const f=p/e;s[p]=this.getTangentAt(f,new T)}n[0]=new T,a[0]=new T;let c=Number.MAX_VALUE;const h=Math.abs(s[0].x),d=Math.abs(s[0].y),u=Math.abs(s[0].z);h<=c&&(c=h,i.set(1,0,0)),d<=c&&(c=d,i.set(0,1,0)),u<=c&&i.set(0,0,1),o.crossVectors(s[0],i).normalize(),n[0].crossVectors(s[0],o),a[0].crossVectors(s[0],n[0]);for(let p=1;p<=e;p++){if(n[p]=n[p-1].clone(),a[p]=a[p-1].clone(),o.crossVectors(s[p-1],s[p]),o.length()>Number.EPSILON){o.normalize();const f=Math.acos(St(s[p-1].dot(s[p]),-1,1));n[p].applyMatrix4(r.makeRotationAxis(o,f))}a[p].crossVectors(s[p],n[p])}if(t===!0){let p=Math.acos(St(n[0].dot(n[e]),-1,1));p/=e,s[0].dot(o.crossVectors(n[0],n[e]))>0&&(p=-p);for(let f=1;f<=e;f++)n[f].applyMatrix4(r.makeRotationAxis(s[f],p*f)),a[f].crossVectors(s[f],n[f])}return{tangents:s,normals:n,binormals:a}}clone(){return new this.constructor().copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}}class Jd extends Js{constructor(e=0,t=0,i=1,s=1,n=0,a=Math.PI*2,o=!1,r=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=s,this.aStartAngle=n,this.aEndAngle=a,this.aClockwise=o,this.aRotation=r}getPoint(e,t=new le){const i=t,s=Math.PI*2;let n=this.aEndAngle-this.aStartAngle;const a=Math.abs(n)<Number.EPSILON;for(;n<0;)n+=s;for(;n>s;)n-=s;n<Number.EPSILON&&(a?n=0:n=s),this.aClockwise===!0&&!a&&(n===s?n=-s:n=n-s);const o=this.aStartAngle+e*n;let r=this.aX+this.xRadius*Math.cos(o),c=this.aY+this.yRadius*Math.sin(o);if(this.aRotation!==0){const h=Math.cos(this.aRotation),d=Math.sin(this.aRotation),u=r-this.aX,p=c-this.aY;r=u*h-p*d+this.aX,c=u*d+p*h+this.aY}return i.set(r,c)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}}class Kg extends Jd{constructor(e,t,i,s,n,a){super(e,t,i,i,s,n,a),this.isArcCurve=!0,this.type="ArcCurve"}}function eu(){let l=0,e=0,t=0,i=0;function s(n,a,o,r){l=n,e=o,t=-3*n+3*a-2*o-r,i=2*n-2*a+o+r}return{initCatmullRom:function(n,a,o,r,c){s(a,o,c*(o-n),c*(r-a))},initNonuniformCatmullRom:function(n,a,o,r,c,h,d){let u=(a-n)/c-(o-n)/(c+h)+(o-a)/h,p=(o-a)/h-(r-a)/(h+d)+(r-o)/d;u*=h,p*=h,s(a,o,u,p)},calc:function(n){const a=n*n,o=a*n;return l+e*n+t*a+i*o}}}const $r=new T,Ic=new eu,kc=new eu,Pc=new eu;class Zg extends Js{constructor(e=[],t=!1,i="centripetal",s=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=i,this.tension=s}getPoint(e,t=new T){const i=t,s=this.points,n=s.length,a=(n-(this.closed?0:1))*e;let o=Math.floor(a),r=a-o;this.closed?o+=o>0?0:(Math.floor(Math.abs(o)/n)+1)*n:r===0&&o===n-1&&(o=n-2,r=1);let c,h;this.closed||o>0?c=s[(o-1)%n]:($r.subVectors(s[0],s[1]).add(s[0]),c=$r);const d=s[o%n],u=s[(o+1)%n];if(this.closed||o+2<n?h=s[(o+2)%n]:($r.subVectors(s[n-1],s[n-2]).add(s[n-1]),h=$r),this.curveType==="centripetal"||this.curveType==="chordal"){const p=this.curveType==="chordal"?.5:.25;let f=Math.pow(c.distanceToSquared(d),p),y=Math.pow(d.distanceToSquared(u),p),m=Math.pow(u.distanceToSquared(h),p);y<1e-4&&(y=1),f<1e-4&&(f=y),m<1e-4&&(m=y),Ic.initNonuniformCatmullRom(c.x,d.x,u.x,h.x,f,y,m),kc.initNonuniformCatmullRom(c.y,d.y,u.y,h.y,f,y,m),Pc.initNonuniformCatmullRom(c.z,d.z,u.z,h.z,f,y,m)}else this.curveType==="catmullrom"&&(Ic.initCatmullRom(c.x,d.x,u.x,h.x,this.tension),kc.initCatmullRom(c.y,d.y,u.y,h.y,this.tension),Pc.initCatmullRom(c.z,d.z,u.z,h.z,this.tension));return i.set(Ic.calc(r),kc.calc(r),Pc.calc(r)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const s=e.points[t];this.points.push(s.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const s=this.points[t];e.points.push(s.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const s=e.points[t];this.points.push(new T().fromArray(s))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}}function cp(l,e,t,i,s){const n=(i-e)*.5,a=(s-t)*.5,o=l*l,r=l*o;return(2*t-2*i+n+a)*r+(-3*t+3*i-2*n-a)*o+n*l+t}function Jg(l,e){const t=1-l;return t*t*e}function ey(l,e){return 2*(1-l)*l*e}function ty(l,e){return l*l*e}function Ho(l,e,t,i){return Jg(l,e)+ey(l,t)+ty(l,i)}function iy(l,e){const t=1-l;return t*t*t*e}function sy(l,e){const t=1-l;return 3*t*t*l*e}function ny(l,e){return 3*(1-l)*l*l*e}function ay(l,e){return l*l*l*e}function qo(l,e,t,i,s){return iy(l,e)+sy(l,t)+ny(l,i)+ay(l,s)}class vm extends Js{constructor(e=new le,t=new le,i=new le,s=new le){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=i,this.v3=s}getPoint(e,t=new le){const i=t,s=this.v0,n=this.v1,a=this.v2,o=this.v3;return i.set(qo(e,s.x,n.x,a.x,o.x),qo(e,s.y,n.y,a.y,o.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class oy extends Js{constructor(e=new T,t=new T,i=new T,s=new T){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=i,this.v3=s}getPoint(e,t=new T){const i=t,s=this.v0,n=this.v1,a=this.v2,o=this.v3;return i.set(qo(e,s.x,n.x,a.x,o.x),qo(e,s.y,n.y,a.y,o.y),qo(e,s.z,n.z,a.z,o.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}}class xm extends Js{constructor(e=new le,t=new le){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new le){const i=t;return e===1?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new le){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class ry extends Js{constructor(e=new T,t=new T){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=e,this.v2=t}getPoint(e,t=new T){const i=t;return e===1?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(e).add(this.v1)),i}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new T){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class bm extends Js{constructor(e=new le,t=new le,i=new le){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new le){const i=t,s=this.v0,n=this.v1,a=this.v2;return i.set(Ho(e,s.x,n.x,a.x),Ho(e,s.y,n.y,a.y)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class ly extends Js{constructor(e=new T,t=new T,i=new T){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=i}getPoint(e,t=new T){const i=t,s=this.v0,n=this.v1,a=this.v2;return i.set(Ho(e,s.x,n.x,a.x),Ho(e,s.y,n.y,a.y),Ho(e,s.z,n.z,a.z)),i}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}}class wm extends Js{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,t=new le){const i=t,s=this.points,n=(s.length-1)*e,a=Math.floor(n),o=n-a,r=s[a===0?a:a-1],c=s[a],h=s[a>s.length-2?s.length-1:a+1],d=s[a>s.length-3?s.length-1:a+2];return i.set(cp(o,r.x,c.x,h.x,d.x),cp(o,r.y,c.y,h.y,d.y)),i}copy(e){super.copy(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const s=e.points[t];this.points.push(s.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,i=this.points.length;t<i;t++){const s=this.points[t];e.points.push(s.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,i=e.points.length;t<i;t++){const s=e.points[t];this.points.push(new le().fromArray(s))}return this}}var ud=Object.freeze({__proto__:null,ArcCurve:Kg,CatmullRomCurve3:Zg,CubicBezierCurve:vm,CubicBezierCurve3:oy,EllipseCurve:Jd,LineCurve:xm,LineCurve3:ry,QuadraticBezierCurve:bm,QuadraticBezierCurve3:ly,SplineCurve:wm});class cy extends Js{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);if(!e.equals(t)){const i=e.isVector2===!0?"LineCurve":"LineCurve3";this.curves.push(new ud[i](t,e))}return this}getPoint(e,t){const i=e*this.getLength(),s=this.getCurveLengths();let n=0;for(;n<s.length;){if(s[n]>=i){const a=s[n]-i,o=this.curves[n],r=o.getLength(),c=r===0?0:1-a/r;return o.getPointAt(c,t)}n++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let i=0,s=this.curves.length;i<s;i++)t+=this.curves[i].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let i;for(let s=0,n=this.curves;s<n.length;s++){const a=n[s],o=a.isEllipseCurve?e*2:a.isLineCurve||a.isLineCurve3?1:a.isSplineCurve?e*a.points.length:e,r=a.getPoints(o);for(let c=0;c<r.length;c++){const h=r[c];i&&i.equals(h)||(t.push(h),i=h)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){const s=e.curves[t];this.curves.push(s.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,i=this.curves.length;t<i;t++){const s=this.curves[t];e.curves.push(s.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,i=e.curves.length;t<i;t++){const s=e.curves[t];this.curves.push(new ud[s.type]().fromJSON(s))}return this}}class hp extends cy{constructor(e){super(),this.type="Path",this.currentPoint=new le,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){const i=new xm(this.currentPoint.clone(),new le(e,t));return this.curves.push(i),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,i,s){const n=new bm(this.currentPoint.clone(),new le(e,t),new le(i,s));return this.curves.push(n),this.currentPoint.set(i,s),this}bezierCurveTo(e,t,i,s,n,a){const o=new vm(this.currentPoint.clone(),new le(e,t),new le(i,s),new le(n,a));return this.curves.push(o),this.currentPoint.set(n,a),this}splineThru(e){const t=[this.currentPoint.clone()].concat(e),i=new wm(t);return this.curves.push(i),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,i,s,n,a){const o=this.currentPoint.x,r=this.currentPoint.y;return this.absarc(e+o,t+r,i,s,n,a),this}absarc(e,t,i,s,n,a){return this.absellipse(e,t,i,i,s,n,a),this}ellipse(e,t,i,s,n,a,o,r){const c=this.currentPoint.x,h=this.currentPoint.y;return this.absellipse(e+c,t+h,i,s,n,a,o,r),this}absellipse(e,t,i,s,n,a,o,r){const c=new Jd(e,t,i,s,n,a,o,r);if(this.curves.length>0){const d=c.getPoint(0);d.equals(this.currentPoint)||this.lineTo(d.x,d.y)}this.curves.push(c);const h=c.getPoint(1);return this.currentPoint.copy(h),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}}class ia extends hp{constructor(e){super(e),this.uuid=bs(),this.type="Shape",this.holes=[]}getPointsHoles(e){const t=[];for(let i=0,s=this.holes.length;i<s;i++)t[i]=this.holes[i].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){const s=e.holes[t];this.holes.push(s.clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,i=this.holes.length;t<i;t++){const s=this.holes[t];e.holes.push(s.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,i=e.holes.length;t<i;t++){const s=e.holes[t];this.holes.push(new hp().fromJSON(s))}return this}}function hy(l,e,t=2){const i=e&&e.length,s=i?e[0]*t:l.length;let n=_m(l,0,s,t,!0);const a=[];if(!n||n.next===n.prev)return a;let o,r,c;if(i&&(n=my(l,e,n,t)),l.length>80*t){o=l[0],r=l[1];let h=o,d=r;for(let u=t;u<s;u+=t){const p=l[u],f=l[u+1];p<o&&(o=p),f<r&&(r=f),p>h&&(h=p),f>d&&(d=f)}c=Math.max(h-o,d-r),c=c!==0?32767/c:0}return sr(n,a,t,o,r,c,0),a}function _m(l,e,t,i,s){let n;if(s===Ey(l,e,t,i)>0)for(let a=e;a<t;a+=i)n=dp(a/i|0,l[a],l[a+1],n);else for(let a=t-i;a>=e;a-=i)n=dp(a/i|0,l[a],l[a+1],n);return n&&ja(n,n.next)&&(ar(n),n=n.next),n}function oa(l,e){if(!l)return l;e||(e=l);let t=l,i;do if(i=!1,!t.steiner&&(ja(t,t.next)||ci(t.prev,t,t.next)===0)){if(ar(t),t=e=t.prev,t===t.next)break;i=!0}else t=t.next;while(i||t!==e);return e}function sr(l,e,t,i,s,n,a){if(!l)return;!a&&n&&by(l,i,s,n);let o=l;for(;l.prev!==l.next;){const r=l.prev,c=l.next;if(n?uy(l,i,s,n):dy(l)){e.push(r.i,l.i,c.i),ar(l),l=c.next,o=c.next;continue}if(l=c,l===o){a?a===1?(l=py(oa(l),e),sr(l,e,t,i,s,n,2)):a===2&&fy(l,e,t,i,s,n):sr(oa(l),e,t,i,s,n,1);break}}}function dy(l){const e=l.prev,t=l,i=l.next;if(ci(e,t,i)>=0)return!1;const s=e.x,n=t.x,a=i.x,o=e.y,r=t.y,c=i.y,h=Math.min(s,n,a),d=Math.min(o,r,c),u=Math.max(s,n,a),p=Math.max(o,r,c);let f=i.next;for(;f!==e;){if(f.x>=h&&f.x<=u&&f.y>=d&&f.y<=p&&Oo(s,o,n,r,a,c,f.x,f.y)&&ci(f.prev,f,f.next)>=0)return!1;f=f.next}return!0}function uy(l,e,t,i){const s=l.prev,n=l,a=l.next;if(ci(s,n,a)>=0)return!1;const o=s.x,r=n.x,c=a.x,h=s.y,d=n.y,u=a.y,p=Math.min(o,r,c),f=Math.min(h,d,u),y=Math.max(o,r,c),m=Math.max(h,d,u),g=pd(p,f,e,t,i),x=pd(y,m,e,t,i);let v=l.prevZ,b=l.nextZ;for(;v&&v.z>=g&&b&&b.z<=x;){if(v.x>=p&&v.x<=y&&v.y>=f&&v.y<=m&&v!==s&&v!==a&&Oo(o,h,r,d,c,u,v.x,v.y)&&ci(v.prev,v,v.next)>=0||(v=v.prevZ,b.x>=p&&b.x<=y&&b.y>=f&&b.y<=m&&b!==s&&b!==a&&Oo(o,h,r,d,c,u,b.x,b.y)&&ci(b.prev,b,b.next)>=0))return!1;b=b.nextZ}for(;v&&v.z>=g;){if(v.x>=p&&v.x<=y&&v.y>=f&&v.y<=m&&v!==s&&v!==a&&Oo(o,h,r,d,c,u,v.x,v.y)&&ci(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;b&&b.z<=x;){if(b.x>=p&&b.x<=y&&b.y>=f&&b.y<=m&&b!==s&&b!==a&&Oo(o,h,r,d,c,u,b.x,b.y)&&ci(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function py(l,e){let t=l;do{const i=t.prev,s=t.next.next;!ja(i,s)&&Sm(i,t,t.next,s)&&nr(i,s)&&nr(s,i)&&(e.push(i.i,t.i,s.i),ar(t),ar(t.next),t=l=s),t=t.next}while(t!==l);return oa(t)}function fy(l,e,t,i,s,n){let a=l;do{let o=a.next.next;for(;o!==a.prev;){if(a.i!==o.i&&My(a,o)){let r=Tm(a,o);a=oa(a,a.next),r=oa(r,r.next),sr(a,e,t,i,s,n,0),sr(r,e,t,i,s,n,0);return}o=o.next}a=a.next}while(a!==l)}function my(l,e,t,i){const s=[];for(let n=0,a=e.length;n<a;n++){const o=e[n]*i,r=n<a-1?e[n+1]*i:l.length,c=_m(l,o,r,i,!1);c===c.next&&(c.steiner=!0),s.push(_y(c))}s.sort(gy);for(let n=0;n<s.length;n++)t=yy(s[n],t);return t}function gy(l,e){let t=l.x-e.x;if(t===0&&(t=l.y-e.y,t===0)){const i=(l.next.y-l.y)/(l.next.x-l.x),s=(e.next.y-e.y)/(e.next.x-e.x);t=i-s}return t}function yy(l,e){const t=vy(l,e);if(!t)return e;const i=Tm(t,l);return oa(i,i.next),oa(t,t.next)}function vy(l,e){let t=e;const i=l.x,s=l.y;let n=-1/0,a;if(ja(l,t))return t;do{if(ja(l,t.next))return t.next;if(s<=t.y&&s>=t.next.y&&t.next.y!==t.y){const d=t.x+(s-t.y)*(t.next.x-t.x)/(t.next.y-t.y);if(d<=i&&d>n&&(n=d,a=t.x<t.next.x?t:t.next,d===i))return a}t=t.next}while(t!==e);if(!a)return null;const o=a,r=a.x,c=a.y;let h=1/0;t=a;do{if(i>=t.x&&t.x>=r&&i!==t.x&&Mm(s<c?i:n,s,r,c,s<c?n:i,s,t.x,t.y)){const d=Math.abs(s-t.y)/(i-t.x);nr(t,l)&&(d<h||d===h&&(t.x>a.x||t.x===a.x&&xy(a,t)))&&(a=t,h=d)}t=t.next}while(t!==o);return a}function xy(l,e){return ci(l.prev,l,e.prev)<0&&ci(e.next,l,l.next)<0}function by(l,e,t,i){let s=l;do s.z===0&&(s.z=pd(s.x,s.y,e,t,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next;while(s!==l);s.prevZ.nextZ=null,s.prevZ=null,wy(s)}function wy(l){let e,t=1;do{let i=l,s;l=null;let n=null;for(e=0;i;){e++;let a=i,o=0;for(let c=0;c<t&&(o++,a=a.nextZ,!!a);c++);let r=t;for(;o>0||r>0&&a;)o!==0&&(r===0||!a||i.z<=a.z)?(s=i,i=i.nextZ,o--):(s=a,a=a.nextZ,r--),n?n.nextZ=s:l=s,s.prevZ=n,n=s;i=a}n.nextZ=null,t*=2}while(e>1);return l}function pd(l,e,t,i,s){return l=(l-t)*s|0,e=(e-i)*s|0,l=(l|l<<8)&16711935,l=(l|l<<4)&252645135,l=(l|l<<2)&858993459,l=(l|l<<1)&1431655765,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,l|e<<1}function _y(l){let e=l,t=l;do(e.x<t.x||e.x===t.x&&e.y<t.y)&&(t=e),e=e.next;while(e!==l);return t}function Mm(l,e,t,i,s,n,a,o){return(s-a)*(e-o)>=(l-a)*(n-o)&&(l-a)*(i-o)>=(t-a)*(e-o)&&(t-a)*(n-o)>=(s-a)*(i-o)}function Oo(l,e,t,i,s,n,a,o){return!(l===a&&e===o)&&Mm(l,e,t,i,s,n,a,o)}function My(l,e){return l.next.i!==e.i&&l.prev.i!==e.i&&!Sy(l,e)&&(nr(l,e)&&nr(e,l)&&Ty(l,e)&&(ci(l.prev,l,e.prev)||ci(l,e.prev,e))||ja(l,e)&&ci(l.prev,l,l.next)>0&&ci(e.prev,e,e.next)>0)}function ci(l,e,t){return(e.y-l.y)*(t.x-e.x)-(e.x-l.x)*(t.y-e.y)}function ja(l,e){return l.x===e.x&&l.y===e.y}function Sm(l,e,t,i){const s=Yr(ci(l,e,t)),n=Yr(ci(l,e,i)),a=Yr(ci(t,i,l)),o=Yr(ci(t,i,e));return!!(s!==n&&a!==o||s===0&&Xr(l,t,e)||n===0&&Xr(l,i,e)||a===0&&Xr(t,l,i)||o===0&&Xr(t,e,i))}function Xr(l,e,t){return e.x<=Math.max(l.x,t.x)&&e.x>=Math.min(l.x,t.x)&&e.y<=Math.max(l.y,t.y)&&e.y>=Math.min(l.y,t.y)}function Yr(l){return l>0?1:l<0?-1:0}function Sy(l,e){let t=l;do{if(t.i!==l.i&&t.next.i!==l.i&&t.i!==e.i&&t.next.i!==e.i&&Sm(t,t.next,l,e))return!0;t=t.next}while(t!==l);return!1}function nr(l,e){return ci(l.prev,l,l.next)<0?ci(l,e,l.next)>=0&&ci(l,l.prev,e)>=0:ci(l,e,l.prev)<0||ci(l,l.next,e)<0}function Ty(l,e){let t=l,i=!1;const s=(l.x+e.x)/2,n=(l.y+e.y)/2;do t.y>n!=t.next.y>n&&t.next.y!==t.y&&s<(t.next.x-t.x)*(n-t.y)/(t.next.y-t.y)+t.x&&(i=!i),t=t.next;while(t!==l);return i}function Tm(l,e){const t=fd(l.i,l.x,l.y),i=fd(e.i,e.x,e.y),s=l.next,n=e.prev;return l.next=e,e.prev=l,t.next=s,s.prev=t,i.next=t,t.prev=i,n.next=i,i.prev=n,i}function dp(l,e,t,i){const s=fd(l,e,t);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function ar(l){l.next.prev=l.prev,l.prev.next=l.next,l.prevZ&&(l.prevZ.nextZ=l.nextZ),l.nextZ&&(l.nextZ.prevZ=l.prevZ)}function fd(l,e,t){return{i:l,x:e,y:t,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Ey(l,e,t,i){let s=0;for(let n=e,a=t-i;n<t;n+=i)s+=(l[a]-l[n])*(l[n+1]+l[a+1]),a=n;return s}class Cy{static triangulate(e,t,i=2){return hy(e,t,i)}}class pn{static area(e){const t=e.length;let i=0;for(let s=t-1,n=0;n<t;s=n++)i+=e[s].x*e[n].y-e[n].x*e[s].y;return i*.5}static isClockWise(e){return pn.area(e)<0}static triangulateShape(e,t){const i=[],s=[],n=[];up(e),pp(i,e);let a=e.length;t.forEach(up);for(let r=0;r<t.length;r++)s.push(a),a+=t[r].length,pp(i,t[r]);const o=Cy.triangulate(i,s);for(let r=0;r<o.length;r+=3)n.push(o.slice(r,r+3));return n}}function up(l){const e=l.length;e>2&&l[e-1].equals(l[0])&&l.pop()}function pp(l,e){for(let t=0;t<e.length;t++)l.push(e[t].x),l.push(e[t].y)}class Wo extends mt{constructor(e=new ia([new le(.5,.5),new le(-.5,.5),new le(-.5,-.5),new le(.5,-.5)]),t={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];const i=this,s=[],n=[];for(let o=0,r=e.length;o<r;o++){const c=e[o];a(c)}this.setAttribute("position",new Tt(s,3)),this.setAttribute("uv",new Tt(n,2)),this.computeVertexNormals();function a(o){const r=[],c=t.curveSegments!==void 0?t.curveSegments:12,h=t.steps!==void 0?t.steps:1,d=t.depth!==void 0?t.depth:1;let u=t.bevelEnabled!==void 0?t.bevelEnabled:!0,p=t.bevelThickness!==void 0?t.bevelThickness:.2,f=t.bevelSize!==void 0?t.bevelSize:p-.1,y=t.bevelOffset!==void 0?t.bevelOffset:0,m=t.bevelSegments!==void 0?t.bevelSegments:3;const g=t.extrudePath,x=t.UVGenerator!==void 0?t.UVGenerator:Ay;let v,b=!1,_,S,A,R;if(g){v=g.getSpacedPoints(h),b=!0,u=!1;const J=g.isCatmullRomCurve3?g.closed:!1;_=g.computeFrenetFrames(h,J),S=new T,A=new T,R=new T}u||(m=0,p=0,f=0,y=0);const M=o.extractPoints(c);let C=M.shape;const k=M.holes;if(!pn.isClockWise(C)){C=C.reverse();for(let J=0,he=k.length;J<he;J++){const oe=k[J];pn.isClockWise(oe)&&(k[J]=oe.reverse())}}function O(J){const oe=10000000000000001e-36;let Se=J[0];for(let D=1;D<=J.length;D++){const Ke=D%J.length,Ae=J[Ke],et=Ae.x-Se.x,ge=Ae.y-Se.y,P=et*et+ge*ge,E=Math.max(Math.abs(Ae.x),Math.abs(Ae.y),Math.abs(Se.x),Math.abs(Se.y)),N=oe*E*E;if(P<=N){J.splice(Ke,1),D--;continue}Se=Ae}}O(C),k.forEach(O);const W=k.length,U=C;for(let J=0;J<W;J++){const he=k[J];C=C.concat(he)}function $(J,he,oe){return he||rt("ExtrudeGeometry: vec does not exist"),J.clone().addScaledVector(he,oe)}const G=C.length;function ee(J,he,oe){let Se,D,Ke;const Ae=J.x-he.x,et=J.y-he.y,ge=oe.x-J.x,P=oe.y-J.y,E=Ae*Ae+et*et,N=Ae*P-et*ge;if(Math.abs(N)>Number.EPSILON){const Y=Math.sqrt(E),te=Math.sqrt(ge*ge+P*P),K=he.x-et/Y,He=he.y+Ae/Y,we=oe.x-P/te,Ue=oe.y+ge/te,at=((we-K)*P-(Ue-He)*ge)/(Ae*P-et*ge);Se=K+Ae*at-J.x,D=He+et*at-J.y;const de=Se*Se+D*D;if(de<=2)return new le(Se,D);Ke=Math.sqrt(de/2)}else{let Y=!1;Ae>Number.EPSILON?ge>Number.EPSILON&&(Y=!0):Ae<-Number.EPSILON?ge<-Number.EPSILON&&(Y=!0):Math.sign(et)===Math.sign(P)&&(Y=!0),Y?(Se=-et,D=Ae,Ke=Math.sqrt(E)):(Se=Ae,D=et,Ke=Math.sqrt(E/2))}return new le(Se/Ke,D/Ke)}const pe=[];for(let J=0,he=U.length,oe=he-1,Se=J+1;J<he;J++,oe++,Se++)oe===he&&(oe=0),Se===he&&(Se=0),pe[J]=ee(U[J],U[oe],U[Se]);const me=[];let ve,tt=pe.concat();for(let J=0,he=W;J<he;J++){const oe=k[J];ve=[];for(let Se=0,D=oe.length,Ke=D-1,Ae=Se+1;Se<D;Se++,Ke++,Ae++)Ke===D&&(Ke=0),Ae===D&&(Ae=0),ve[Se]=ee(oe[Se],oe[Ke],oe[Ae]);me.push(ve),tt=tt.concat(ve)}let je;if(m===0)je=pn.triangulateShape(U,k);else{const J=[],he=[];for(let oe=0;oe<m;oe++){const Se=oe/m,D=p*Math.cos(Se*Math.PI/2),Ke=f*Math.sin(Se*Math.PI/2)+y;for(let Ae=0,et=U.length;Ae<et;Ae++){const ge=$(U[Ae],pe[Ae],Ke);Ze(ge.x,ge.y,-D),Se===0&&J.push(ge)}for(let Ae=0,et=W;Ae<et;Ae++){const ge=k[Ae];ve=me[Ae];const P=[];for(let E=0,N=ge.length;E<N;E++){const Y=$(ge[E],ve[E],Ke);Ze(Y.x,Y.y,-D),Se===0&&P.push(Y)}Se===0&&he.push(P)}}je=pn.triangulateShape(J,he)}const Ot=je.length,Nt=f+y;for(let J=0;J<G;J++){const he=u?$(C[J],tt[J],Nt):C[J];b?(A.copy(_.normals[0]).multiplyScalar(he.x),S.copy(_.binormals[0]).multiplyScalar(he.y),R.copy(v[0]).add(A).add(S),Ze(R.x,R.y,R.z)):Ze(he.x,he.y,0)}for(let J=1;J<=h;J++)for(let he=0;he<G;he++){const oe=u?$(C[he],tt[he],Nt):C[he];b?(A.copy(_.normals[J]).multiplyScalar(oe.x),S.copy(_.binormals[J]).multiplyScalar(oe.y),R.copy(v[J]).add(A).add(S),Ze(R.x,R.y,R.z)):Ze(oe.x,oe.y,d/h*J)}for(let J=m-1;J>=0;J--){const he=J/m,oe=p*Math.cos(he*Math.PI/2),Se=f*Math.sin(he*Math.PI/2)+y;for(let D=0,Ke=U.length;D<Ke;D++){const Ae=$(U[D],pe[D],Se);Ze(Ae.x,Ae.y,d+oe)}for(let D=0,Ke=k.length;D<Ke;D++){const Ae=k[D];ve=me[D];for(let et=0,ge=Ae.length;et<ge;et++){const P=$(Ae[et],ve[et],Se);b?Ze(P.x,P.y+v[h-1].y,v[h-1].x+oe):Ze(P.x,P.y,d+oe)}}}Z(),se();function Z(){const J=s.length/3;if(u){let he=0,oe=G*he;for(let Se=0;Se<Ot;Se++){const D=je[Se];Le(D[2]+oe,D[1]+oe,D[0]+oe)}he=h+m*2,oe=G*he;for(let Se=0;Se<Ot;Se++){const D=je[Se];Le(D[0]+oe,D[1]+oe,D[2]+oe)}}else{for(let he=0;he<Ot;he++){const oe=je[he];Le(oe[2],oe[1],oe[0])}for(let he=0;he<Ot;he++){const oe=je[he];Le(oe[0]+G*h,oe[1]+G*h,oe[2]+G*h)}}i.addGroup(J,s.length/3-J,0)}function se(){const J=s.length/3;let he=0;Pe(U,he),he+=U.length;for(let oe=0,Se=k.length;oe<Se;oe++){const D=k[oe];Pe(D,he),he+=D.length}i.addGroup(J,s.length/3-J,1)}function Pe(J,he){let oe=J.length;for(;--oe>=0;){const Se=oe;let D=oe-1;D<0&&(D=J.length-1);for(let Ke=0,Ae=h+m*2;Ke<Ae;Ke++){const et=G*Ke,ge=G*(Ke+1),P=he+Se+et,E=he+D+et,N=he+D+ge,Y=he+Se+ge;Ct(P,E,N,Y)}}}function Ze(J,he,oe){r.push(J),r.push(he),r.push(oe)}function Le(J,he,oe){Bt(J),Bt(he),Bt(oe);const Se=s.length/3,D=x.generateTopUV(i,s,Se-3,Se-2,Se-1);ht(D[0]),ht(D[1]),ht(D[2])}function Ct(J,he,oe,Se){Bt(J),Bt(he),Bt(Se),Bt(he),Bt(oe),Bt(Se);const D=s.length/3,Ke=x.generateSideWallUV(i,s,D-6,D-3,D-2,D-1);ht(Ke[0]),ht(Ke[1]),ht(Ke[3]),ht(Ke[1]),ht(Ke[2]),ht(Ke[3])}function Bt(J){s.push(r[J*3+0]),s.push(r[J*3+1]),s.push(r[J*3+2])}function ht(J){n.push(J.x),n.push(J.y)}}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON(),t=this.parameters.shapes,i=this.parameters.options;return Ry(t,i,e)}static fromJSON(e,t){const i=[];for(let n=0,a=e.shapes.length;n<a;n++){const o=t[e.shapes[n]];i.push(o)}const s=e.options.extrudePath;return s!==void 0&&(e.options.extrudePath=new ud[s.type]().fromJSON(s)),new Wo(i,e.options)}}const Ay={generateTopUV:function(l,e,t,i,s){const n=e[t*3],a=e[t*3+1],o=e[i*3],r=e[i*3+1],c=e[s*3],h=e[s*3+1];return[new le(n,a),new le(o,r),new le(c,h)]},generateSideWallUV:function(l,e,t,i,s,n){const a=e[t*3],o=e[t*3+1],r=e[t*3+2],c=e[i*3],h=e[i*3+1],d=e[i*3+2],u=e[s*3],p=e[s*3+1],f=e[s*3+2],y=e[n*3],m=e[n*3+1],g=e[n*3+2];return Math.abs(o-h)<Math.abs(a-c)?[new le(a,1-r),new le(c,1-d),new le(u,1-f),new le(y,1-g)]:[new le(o,1-r),new le(h,1-d),new le(p,1-f),new le(m,1-g)]}};function Ry(l,e,t){if(t.shapes=[],Array.isArray(l))for(let i=0,s=l.length;i<s;i++){const n=l[i];t.shapes.push(n.uuid)}else t.shapes.push(l.uuid);return t.options=Object.assign({},e),e.extrudePath!==void 0&&(t.options.extrudePath=e.extrudePath.toJSON()),t}class Ni extends so{constructor(e=1,t=0){const i=(1+Math.sqrt(5))/2,s=[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],n=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];super(s,n,e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new Ni(e.radius,e.detail)}}class Ji extends so{constructor(e=1,t=0){const i=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],s=[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2];super(i,s,e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new Ji(e.radius,e.detail)}}class Dt extends mt{constructor(e=1,t=1,i=1,s=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:s};const n=e/2,a=t/2,o=Math.floor(i),r=Math.floor(s),c=o+1,h=r+1,d=e/o,u=t/r,p=[],f=[],y=[],m=[];for(let g=0;g<h;g++){const x=g*u-a;for(let v=0;v<c;v++){const b=v*d-n;f.push(b,-x,0),y.push(0,0,1),m.push(v/o),m.push(1-g/r)}}for(let g=0;g<r;g++)for(let x=0;x<o;x++){const v=x+c*g,b=x+c*(g+1),_=x+1+c*(g+1),S=x+1+c*g;p.push(v,b,S),p.push(b,_,S)}this.setIndex(p),this.setAttribute("position",new Tt(f,3)),this.setAttribute("normal",new Tt(y,3)),this.setAttribute("uv",new Tt(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Dt(e.width,e.height,e.widthSegments,e.heightSegments)}}class Ki extends mt{constructor(e=.5,t=1,i=32,s=1,n=0,a=Math.PI*2){super(),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:s,thetaStart:n,thetaLength:a},i=Math.max(3,i),s=Math.max(1,s);const o=[],r=[],c=[],h=[];let d=e;const u=(t-e)/s,p=new T,f=new le;for(let y=0;y<=s;y++){for(let m=0;m<=i;m++){const g=n+m/i*a;p.x=d*Math.cos(g),p.y=d*Math.sin(g),r.push(p.x,p.y,p.z),c.push(0,0,1),f.x=(p.x/t+1)/2,f.y=(p.y/t+1)/2,h.push(f.x,f.y)}d+=u}for(let y=0;y<s;y++){const m=y*(i+1);for(let g=0;g<i;g++){const x=g+m,v=x,b=x+i+1,_=x+i+2,S=x+1;o.push(v,b,S),o.push(b,_,S)}}this.setIndex(o),this.setAttribute("position",new Tt(r,3)),this.setAttribute("normal",new Tt(c,3)),this.setAttribute("uv",new Tt(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Ki(e.innerRadius,e.outerRadius,e.thetaSegments,e.phiSegments,e.thetaStart,e.thetaLength)}}class Ol extends mt{constructor(e=new ia([new le(0,.5),new le(-.5,-.5),new le(.5,-.5)]),t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};const i=[],s=[],n=[],a=[];let o=0,r=0;if(Array.isArray(e)===!1)c(e);else for(let h=0;h<e.length;h++)c(e[h]),this.addGroup(o,r,h),o+=r,r=0;this.setIndex(i),this.setAttribute("position",new Tt(s,3)),this.setAttribute("normal",new Tt(n,3)),this.setAttribute("uv",new Tt(a,2));function c(h){const d=s.length/3,u=h.extractPoints(t);let p=u.shape;const f=u.holes;pn.isClockWise(p)===!1&&(p=p.reverse());for(let m=0,g=f.length;m<g;m++){const x=f[m];pn.isClockWise(x)===!0&&(f[m]=x.reverse())}const y=pn.triangulateShape(p,f);for(let m=0,g=f.length;m<g;m++){const x=f[m];p=p.concat(x)}for(let m=0,g=p.length;m<g;m++){const x=p[m];s.push(x.x,x.y,0),n.push(0,0,1),a.push(x.x,x.y)}for(let m=0,g=y.length;m<g;m++){const x=y[m],v=x[0]+d,b=x[1]+d,_=x[2]+d;i.push(v,b,_),r+=3}}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON(),t=this.parameters.shapes;return Iy(t,e)}static fromJSON(e,t){const i=[];for(let s=0,n=e.shapes.length;s<n;s++){const a=t[e.shapes[s]];i.push(a)}return new Ol(i,e.curveSegments)}}function Iy(l,e){if(e.shapes=[],Array.isArray(l))for(let t=0,i=l.length;t<i;t++){const s=l[t];e.shapes.push(s.uuid)}else e.shapes.push(l.uuid);return e}class re extends mt{constructor(e=1,t=32,i=16,s=0,n=Math.PI*2,a=0,o=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:s,phiLength:n,thetaStart:a,thetaLength:o},t=Math.max(3,Math.floor(t)),i=Math.max(2,Math.floor(i));const r=Math.min(a+o,Math.PI);let c=0;const h=[],d=new T,u=new T,p=[],f=[],y=[],m=[];for(let g=0;g<=i;g++){const x=[],v=g/i;let b=0;g===0&&a===0?b=.5/t:g===i&&r===Math.PI&&(b=-.5/t);for(let _=0;_<=t;_++){const S=_/t;d.x=-e*Math.cos(s+S*n)*Math.sin(a+v*o),d.y=e*Math.cos(a+v*o),d.z=e*Math.sin(s+S*n)*Math.sin(a+v*o),f.push(d.x,d.y,d.z),u.copy(d).normalize(),y.push(u.x,u.y,u.z),m.push(S+b,1-v),x.push(c++)}h.push(x)}for(let g=0;g<i;g++)for(let x=0;x<t;x++){const v=h[g][x+1],b=h[g][x],_=h[g+1][x],S=h[g+1][x+1];(g!==0||a>0)&&p.push(v,b,S),(g!==i-1||r<Math.PI)&&p.push(b,_,S)}this.setIndex(p),this.setAttribute("position",new Tt(f,3)),this.setAttribute("normal",new Tt(y,3)),this.setAttribute("uv",new Tt(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new re(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class tu extends so{constructor(e=1,t=0){const i=[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],s=[2,1,0,0,3,2,1,3,0,2,3,1];super(i,s,e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(e){return new tu(e.radius,e.detail)}}class Ai extends mt{constructor(e=1,t=.4,i=12,s=48,n=Math.PI*2){super(),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:s,arc:n},i=Math.floor(i),s=Math.floor(s);const a=[],o=[],r=[],c=[],h=new T,d=new T,u=new T;for(let p=0;p<=i;p++)for(let f=0;f<=s;f++){const y=f/s*n,m=p/i*Math.PI*2;d.x=(e+t*Math.cos(m))*Math.cos(y),d.y=(e+t*Math.cos(m))*Math.sin(y),d.z=t*Math.sin(m),o.push(d.x,d.y,d.z),h.x=e*Math.cos(y),h.y=e*Math.sin(y),u.subVectors(d,h).normalize(),r.push(u.x,u.y,u.z),c.push(f/s),c.push(p/i)}for(let p=1;p<=i;p++)for(let f=1;f<=s;f++){const y=(s+1)*p+f-1,m=(s+1)*(p-1)+f-1,g=(s+1)*(p-1)+f,x=(s+1)*p+f;a.push(y,m,x),a.push(m,g,x)}this.setIndex(a),this.setAttribute("position",new Tt(o,3)),this.setAttribute("normal",new Tt(r,3)),this.setAttribute("uv",new Tt(c,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Ai(e.radius,e.tube,e.radialSegments,e.tubularSegments,e.arc)}}class Em extends Ci{constructor(e){super(e),this.isRawShaderMaterial=!0,this.type="RawShaderMaterial"}}class X extends As{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new H(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new H(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=sm,this.normalScale=new le(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new nt,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class en extends X{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new le(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return St(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(t){this.ior=(1+.4*t)/(1-.4*t)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new H(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new H(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new H(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class ky extends As{constructor(e){super(),this.isMeshDepthMaterial=!0,this.type="MeshDepthMaterial",this.depthPacking=V0,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class Py extends As{constructor(e){super(),this.isMeshDistanceMaterial=!0,this.type="MeshDistanceMaterial",this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}function Qr(l,e){return!l||l.constructor===e?l:typeof e.BYTES_PER_ELEMENT=="number"?new e(l):Array.prototype.slice.call(l)}function Dy(l){function e(s,n){return l[s]-l[n]}const t=l.length,i=new Array(t);for(let s=0;s!==t;++s)i[s]=s;return i.sort(e),i}function fp(l,e,t){const i=l.length,s=new l.constructor(i);for(let n=0,a=0;a!==i;++n){const o=t[n]*e;for(let r=0;r!==e;++r)s[a++]=l[o+r]}return s}function Cm(l,e,t,i){let s=1,n=l[0];for(;n!==void 0&&n[i]===void 0;)n=l[s++];if(n===void 0)return;let a=n[i];if(a!==void 0)if(Array.isArray(a))do a=n[i],a!==void 0&&(e.push(n.time),t.push(...a)),n=l[s++];while(n!==void 0);else if(a.toArray!==void 0)do a=n[i],a!==void 0&&(e.push(n.time),a.toArray(t,t.length)),n=l[s++];while(n!==void 0);else do a=n[i],a!==void 0&&(e.push(n.time),t.push(a)),n=l[s++];while(n!==void 0)}class dr{constructor(e,t,i,s){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=s!==void 0?s:new t.constructor(i),this.sampleValues=t,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let i=this._cachedIndex,s=t[i],n=t[i-1];e:{t:{let a;i:{s:if(!(e<s)){for(let o=i+2;;){if(s===void 0){if(e<n)break s;return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}if(i===o)break;if(n=s,s=t[++i],e<s)break t}a=t.length;break i}if(!(e>=n)){const o=t[1];e<o&&(i=2,n=o);for(let r=i-2;;){if(n===void 0)return this._cachedIndex=0,this.copySampleValue_(0);if(i===r)break;if(s=n,n=t[--i-1],e>=n)break t}a=i,i=0;break i}break e}for(;i<a;){const o=i+a>>>1;e<t[o]?a=o:i=o+1}if(s=t[i],n=t[i-1],n===void 0)return this._cachedIndex=0,this.copySampleValue_(0);if(s===void 0)return i=t.length,this._cachedIndex=i,this.copySampleValue_(i-1)}this._cachedIndex=i,this.intervalChanged_(i,n,s)}return this.interpolate_(i,n,e,s)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,n=e*s;for(let a=0;a!==s;++a)t[a]=i[n+a];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class Ly extends dr{constructor(e,t,i,s){super(e,t,i,s),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:Ua,endingEnd:Ua}}intervalChanged_(e,t,i){const s=this.parameterPositions;let n=e-2,a=e+1,o=s[n],r=s[a];if(o===void 0)switch(this.getSettings_().endingStart){case Ga:n=e,o=2*t-i;break;case Rl:n=s.length-2,o=t+s[n]-s[n+1];break;default:n=e,o=i}if(r===void 0)switch(this.getSettings_().endingEnd){case Ga:a=e,r=2*i-t;break;case Rl:a=1,r=i+s[1]-s[0];break;default:a=e-1,r=t}const c=(i-t)*.5,h=this.valueSize;this._weightPrev=c/(t-o),this._weightNext=c/(r-i),this._offsetPrev=n*h,this._offsetNext=a*h}interpolate_(e,t,i,s){const n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,r=e*o,c=r-o,h=this._offsetPrev,d=this._offsetNext,u=this._weightPrev,p=this._weightNext,f=(i-t)/(s-t),y=f*f,m=y*f,g=-u*m+2*u*y-u*f,x=(1+u)*m+(-1.5-2*u)*y+(-.5+u)*f+1,v=(-1-p)*m+(1.5+p)*y+.5*f,b=p*m-p*y;for(let _=0;_!==o;++_)n[_]=g*a[h+_]+x*a[c+_]+v*a[r+_]+b*a[d+_];return n}}class Am extends dr{constructor(e,t,i,s){super(e,t,i,s)}interpolate_(e,t,i,s){const n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,r=e*o,c=r-o,h=(i-t)/(s-t),d=1-h;for(let u=0;u!==o;++u)n[u]=a[c+u]*d+a[r+u]*h;return n}}class Oy extends dr{constructor(e,t,i,s){super(e,t,i,s)}interpolate_(e){return this.copySampleValue_(e-1)}}class Rs{constructor(e,t,i,s){if(e===void 0)throw new Error("THREE.KeyframeTrack: track name is undefined");if(t===void 0||t.length===0)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=Qr(t,this.TimeBufferType),this.values=Qr(i,this.ValueBufferType),this.setInterpolation(s||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let i;if(t.toJSON!==this.toJSON)i=t.toJSON(e);else{i={name:e.name,times:Qr(e.times,Array),values:Qr(e.values,Array)};const s=e.getInterpolation();s!==e.DefaultInterpolation&&(i.interpolation=s)}return i.type=e.ValueTypeName,i}InterpolantFactoryMethodDiscrete(e){return new Oy(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new Am(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new Ly(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case Ko:t=this.InterpolantFactoryMethodDiscrete;break;case Zo:t=this.InterpolantFactoryMethodLinear;break;case sc:t=this.InterpolantFactoryMethodSmooth;break}if(t===void 0){const i="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(this.createInterpolant===void 0)if(e!==this.DefaultInterpolation)this.setInterpolation(this.DefaultInterpolation);else throw new Error(i);return Qe("KeyframeTrack:",i),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return Ko;case this.InterpolantFactoryMethodLinear:return Zo;case this.InterpolantFactoryMethodSmooth:return sc}}getValueSize(){return this.values.length/this.times.length}shift(e){if(e!==0){const t=this.times;for(let i=0,s=t.length;i!==s;++i)t[i]+=e}return this}scale(e){if(e!==1){const t=this.times;for(let i=0,s=t.length;i!==s;++i)t[i]*=e}return this}trim(e,t){const i=this.times,s=i.length;let n=0,a=s-1;for(;n!==s&&i[n]<e;)++n;for(;a!==-1&&i[a]>t;)--a;if(++a,n!==0||a!==s){n>=a&&(a=Math.max(a,1),n=a-1);const o=this.getValueSize();this.times=i.slice(n,a),this.values=this.values.slice(n*o,a*o)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!==0&&(rt("KeyframeTrack: Invalid value size in track.",this),e=!1);const i=this.times,s=this.values,n=i.length;n===0&&(rt("KeyframeTrack: Track is empty.",this),e=!1);let a=null;for(let o=0;o!==n;o++){const r=i[o];if(typeof r=="number"&&isNaN(r)){rt("KeyframeTrack: Time is not a valid number.",this,o,r),e=!1;break}if(a!==null&&a>r){rt("KeyframeTrack: Out of order keys.",this,o,r,a),e=!1;break}a=r}if(s!==void 0&&J0(s))for(let o=0,r=s.length;o!==r;++o){const c=s[o];if(isNaN(c)){rt("KeyframeTrack: Value is not a valid number.",this,o,c),e=!1;break}}return e}optimize(){const e=this.times.slice(),t=this.values.slice(),i=this.getValueSize(),s=this.getInterpolation()===sc,n=e.length-1;let a=1;for(let o=1;o<n;++o){let r=!1;const c=e[o],h=e[o+1];if(c!==h&&(o!==1||c!==e[0]))if(s)r=!0;else{const d=o*i,u=d-i,p=d+i;for(let f=0;f!==i;++f){const y=t[d+f];if(y!==t[u+f]||y!==t[p+f]){r=!0;break}}}if(r){if(o!==a){e[a]=e[o];const d=o*i,u=a*i;for(let p=0;p!==i;++p)t[u+p]=t[d+p]}++a}}if(n>0){e[a]=e[n];for(let o=n*i,r=a*i,c=0;c!==i;++c)t[r+c]=t[o+c];++a}return a!==e.length?(this.times=e.slice(0,a),this.values=t.slice(0,a*i)):(this.times=e,this.values=t),this}clone(){const e=this.times.slice(),t=this.values.slice(),i=this.constructor,s=new i(this.name,e,t);return s.createInterpolant=this.createInterpolant,s}}Rs.prototype.ValueTypeName="";Rs.prototype.TimeBufferType=Float32Array;Rs.prototype.ValueBufferType=Float32Array;Rs.prototype.DefaultInterpolation=Zo;class no extends Rs{constructor(e,t,i){super(e,t,i)}}no.prototype.ValueTypeName="bool";no.prototype.ValueBufferType=Array;no.prototype.DefaultInterpolation=Ko;no.prototype.InterpolantFactoryMethodLinear=void 0;no.prototype.InterpolantFactoryMethodSmooth=void 0;class Rm extends Rs{constructor(e,t,i,s){super(e,t,i,s)}}Rm.prototype.ValueTypeName="color";class Ka extends Rs{constructor(e,t,i,s){super(e,t,i,s)}}Ka.prototype.ValueTypeName="number";class Ny extends dr{constructor(e,t,i,s){super(e,t,i,s)}interpolate_(e,t,i,s){const n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,r=(i-t)/(s-t);let c=e*o;for(let h=c+o;c!==h;c+=4)Cs.slerpFlat(n,0,a,c-o,a,c,r);return n}}class Za extends Rs{constructor(e,t,i,s){super(e,t,i,s)}InterpolantFactoryMethodLinear(e){return new Ny(this.times,this.values,this.getValueSize(),e)}}Za.prototype.ValueTypeName="quaternion";Za.prototype.InterpolantFactoryMethodSmooth=void 0;class ao extends Rs{constructor(e,t,i){super(e,t,i)}}ao.prototype.ValueTypeName="string";ao.prototype.ValueBufferType=Array;ao.prototype.DefaultInterpolation=Ko;ao.prototype.InterpolantFactoryMethodLinear=void 0;ao.prototype.InterpolantFactoryMethodSmooth=void 0;class Ja extends Rs{constructor(e,t,i,s){super(e,t,i,s)}}Ja.prototype.ValueTypeName="vector";class md{constructor(e="",t=-1,i=[],s=Gd){this.name=e,this.tracks=i,this.duration=t,this.blendMode=s,this.uuid=bs(),this.userData={},this.duration<0&&this.resetDuration()}static parse(e){const t=[],i=e.tracks,s=1/(e.fps||1);for(let a=0,o=i.length;a!==o;++a)t.push(zy(i[a]).scale(s));const n=new this(e.name,e.duration,t,e.blendMode);return n.uuid=e.uuid,n.userData=JSON.parse(e.userData||"{}"),n}static toJSON(e){const t=[],i=e.tracks,s={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode,userData:JSON.stringify(e.userData)};for(let n=0,a=i.length;n!==a;++n)t.push(Rs.toJSON(i[n]));return s}static CreateFromMorphTargetSequence(e,t,i,s){const n=t.length,a=[];for(let o=0;o<n;o++){let r=[],c=[];r.push((o+n-1)%n,o,(o+1)%n),c.push(0,1,0);const h=Dy(r);r=fp(r,1,h),c=fp(c,1,h),!s&&r[0]===0&&(r.push(n),c.push(c[0])),a.push(new Ka(".morphTargetInfluences["+t[o].name+"]",r,c).scale(1/i))}return new this(e,-1,a)}static findByName(e,t){let i=e;if(!Array.isArray(e)){const s=e;i=s.geometry&&s.geometry.animations||s.animations}for(let s=0;s<i.length;s++)if(i[s].name===t)return i[s];return null}static CreateClipsFromMorphTargetSequences(e,t,i){const s={},n=/^([\w-]*?)([\d]+)$/;for(let o=0,r=e.length;o<r;o++){const c=e[o],h=c.name.match(n);if(h&&h.length>1){const d=h[1];let u=s[d];u||(s[d]=u=[]),u.push(c)}}const a=[];for(const o in s)a.push(this.CreateFromMorphTargetSequence(o,s[o],t,i));return a}static parseAnimation(e,t){if(Qe("AnimationClip: parseAnimation() is deprecated and will be removed with r185"),!e)return rt("AnimationClip: No animation in JSONLoader data."),null;const i=function(d,u,p,f,y){if(p.length!==0){const m=[],g=[];Cm(p,m,g,f),m.length!==0&&y.push(new d(u,m,g))}},s=[],n=e.name||"default",a=e.fps||30,o=e.blendMode;let r=e.length||-1;const c=e.hierarchy||[];for(let d=0;d<c.length;d++){const u=c[d].keys;if(!(!u||u.length===0))if(u[0].morphTargets){const p={};let f;for(f=0;f<u.length;f++)if(u[f].morphTargets)for(let y=0;y<u[f].morphTargets.length;y++)p[u[f].morphTargets[y]]=-1;for(const y in p){const m=[],g=[];for(let x=0;x!==u[f].morphTargets.length;++x){const v=u[f];m.push(v.time),g.push(v.morphTarget===y?1:0)}s.push(new Ka(".morphTargetInfluence["+y+"]",m,g))}r=p.length*a}else{const p=".bones["+t[d].name+"]";i(Ja,p+".position",u,"pos",s),i(Za,p+".quaternion",u,"rot",s),i(Ja,p+".scale",u,"scl",s)}}return s.length===0?null:new this(n,r,s,o)}resetDuration(){const e=this.tracks;let t=0;for(let i=0,s=e.length;i!==s;++i){const n=this.tracks[i];t=Math.max(t,n.times[n.times.length-1])}return this.duration=t,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let i=0;i<this.tracks.length;i++)e.push(this.tracks[i].clone());const t=new this.constructor(this.name,this.duration,e,this.blendMode);return t.userData=JSON.parse(JSON.stringify(this.userData)),t}toJSON(){return this.constructor.toJSON(this)}}function By(l){switch(l.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Ka;case"vector":case"vector2":case"vector3":case"vector4":return Ja;case"color":return Rm;case"quaternion":return Za;case"bool":case"boolean":return no;case"string":return ao}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+l)}function zy(l){if(l.type===void 0)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const e=By(l.type);if(l.times===void 0){const t=[],i=[];Cm(l.keys,t,i,"value"),l.times=t,l.values=i}return e.parse!==void 0?e.parse(l):new e(l.name,l.times,l.values,l.interpolation)}const fn={enabled:!1,files:{},add:function(l,e){this.enabled!==!1&&(this.files[l]=e)},get:function(l){if(this.enabled!==!1)return this.files[l]},remove:function(l){delete this.files[l]},clear:function(){this.files={}}};class Fy{constructor(e,t,i){const s=this;let n=!1,a=0,o=0,r;const c=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this._abortController=null,this.itemStart=function(h){o++,n===!1&&s.onStart!==void 0&&s.onStart(h,a,o),n=!0},this.itemEnd=function(h){a++,s.onProgress!==void 0&&s.onProgress(h,a,o),a===o&&(n=!1,s.onLoad!==void 0&&s.onLoad())},this.itemError=function(h){s.onError!==void 0&&s.onError(h)},this.resolveURL=function(h){return r?r(h):h},this.setURLModifier=function(h){return r=h,this},this.addHandler=function(h,d){return c.push(h,d),this},this.removeHandler=function(h){const d=c.indexOf(h);return d!==-1&&c.splice(d,2),this},this.getHandler=function(h){for(let d=0,u=c.length;d<u;d+=2){const p=c[d],f=c[d+1];if(p.global&&(p.lastIndex=0),p.test(h))return f}return null},this.abort=function(){return this.abortController.abort(),this._abortController=null,this}}get abortController(){return this._abortController||(this._abortController=new AbortController),this._abortController}}const Uy=new Fy;class ca{constructor(e){this.manager=e!==void 0?e:Uy,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise(function(s,n){i.load(e,s,t,n)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}abort(){return this}}ca.DEFAULT_MATERIAL_NAME="__DEFAULT";const ln={};class Gy extends Error{constructor(e,t){super(e),this.response=t}}class Nl extends ca{constructor(e){super(e),this.mimeType="",this.responseType="",this._abortController=new AbortController}load(e,t,i,s){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const n=fn.get(`file:${e}`);if(n!==void 0)return this.manager.itemStart(e),setTimeout(()=>{t&&t(n),this.manager.itemEnd(e)},0),n;if(ln[e]!==void 0){ln[e].push({onLoad:t,onProgress:i,onError:s});return}ln[e]=[],ln[e].push({onLoad:t,onProgress:i,onError:s});const a=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin",signal:typeof AbortSignal.any=="function"?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal}),o=this.mimeType,r=this.responseType;fetch(a).then(c=>{if(c.status===200||c.status===0){if(c.status===0&&Qe("FileLoader: HTTP Status 0 received."),typeof ReadableStream>"u"||c.body===void 0||c.body.getReader===void 0)return c;const h=ln[e],d=c.body.getReader(),u=c.headers.get("X-File-Size")||c.headers.get("Content-Length"),p=u?parseInt(u):0,f=p!==0;let y=0;const m=new ReadableStream({start(g){x();function x(){d.read().then(({done:v,value:b})=>{if(v)g.close();else{y+=b.byteLength;const _=new ProgressEvent("progress",{lengthComputable:f,loaded:y,total:p});for(let S=0,A=h.length;S<A;S++){const R=h[S];R.onProgress&&R.onProgress(_)}g.enqueue(b),x()}},v=>{g.error(v)})}}});return new Response(m)}else throw new Gy(`fetch for "${c.url}" responded with ${c.status}: ${c.statusText}`,c)}).then(c=>{switch(r){case"arraybuffer":return c.arrayBuffer();case"blob":return c.blob();case"document":return c.text().then(h=>new DOMParser().parseFromString(h,o));case"json":return c.json();default:if(o==="")return c.text();{const d=/charset="?([^;"\s]*)"?/i.exec(o),u=d&&d[1]?d[1].toLowerCase():void 0,p=new TextDecoder(u);return c.arrayBuffer().then(f=>p.decode(f))}}}).then(c=>{fn.add(`file:${e}`,c);const h=ln[e];delete ln[e];for(let d=0,u=h.length;d<u;d++){const p=h[d];p.onLoad&&p.onLoad(c)}}).catch(c=>{const h=ln[e];if(h===void 0)throw this.manager.itemError(e),c;delete ln[e];for(let d=0,u=h.length;d<u;d++){const p=h[d];p.onError&&p.onError(c)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}}const Ia=new WeakMap;class Hy extends ca{constructor(e){super(e)}load(e,t,i,s){this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const n=this,a=fn.get(`image:${e}`);if(a!==void 0){if(a.complete===!0)n.manager.itemStart(e),setTimeout(function(){t&&t(a),n.manager.itemEnd(e)},0);else{let d=Ia.get(a);d===void 0&&(d=[],Ia.set(a,d)),d.push({onLoad:t,onError:s})}return a}const o=Jo("img");function r(){h(),t&&t(this);const d=Ia.get(this)||[];for(let u=0;u<d.length;u++){const p=d[u];p.onLoad&&p.onLoad(this)}Ia.delete(this),n.manager.itemEnd(e)}function c(d){h(),s&&s(d),fn.remove(`image:${e}`);const u=Ia.get(this)||[];for(let p=0;p<u.length;p++){const f=u[p];f.onError&&f.onError(d)}Ia.delete(this),n.manager.itemError(e),n.manager.itemEnd(e)}function h(){o.removeEventListener("load",r,!1),o.removeEventListener("error",c,!1)}return o.addEventListener("load",r,!1),o.addEventListener("error",c,!1),e.slice(0,5)!=="data:"&&this.crossOrigin!==void 0&&(o.crossOrigin=this.crossOrigin),fn.add(`image:${e}`,o),n.manager.itemStart(e),o.src=e,o}}class Im extends ca{constructor(e){super(e)}load(e,t,i,s){const n=new _i,a=new Hy(this.manager);return a.setCrossOrigin(this.crossOrigin),a.setPath(this.path),a.load(e,function(o){n.image=o,n.needsUpdate=!0,t!==void 0&&t(n)},i,s),n}}class oo extends ai{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new H(e),this.intensity=t}dispose(){this.dispatchEvent({type:"dispose"})}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,t}}class qy extends oo{constructor(e,t,i){super(e,i),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(ai.DEFAULT_UP),this.updateMatrix(),this.groundColor=new H(t)}copy(e,t){return super.copy(e,t),this.groundColor.copy(e.groundColor),this}toJSON(e){const t=super.toJSON(e);return t.object.groundColor=this.groundColor.getHex(),t}}const Dc=new ut,mp=new T,gp=new T;class iu{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new le(512,512),this.mapType=ls,this.map=null,this.mapPass=null,this.matrix=new ut,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new jd,this._frameExtents=new le(1,1),this._viewportCount=1,this._viewports=[new ni(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,i=this.matrix;mp.setFromMatrixPosition(e.matrixWorld),t.position.copy(mp),gp.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(gp),t.updateMatrixWorld(),Dc.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Dc,t.coordinateSystem,t.reversedDepth),t.reversedDepth?i.set(.5,0,0,.5,0,.5,0,.5,0,0,1,0,0,0,0,1):i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(Dc)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.autoUpdate=e.autoUpdate,this.needsUpdate=e.needsUpdate,this.normalBias=e.normalBias,this.blurSamples=e.blurSamples,this.mapSize.copy(e.mapSize),this}clone(){return new this.constructor().copy(this)}toJSON(){const e={};return this.intensity!==1&&(e.intensity=this.intensity),this.bias!==0&&(e.bias=this.bias),this.normalBias!==0&&(e.normalBias=this.normalBias),this.radius!==1&&(e.radius=this.radius),(this.mapSize.x!==512||this.mapSize.y!==512)&&(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class Wy extends iu{constructor(){super(new Wi(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1,this.aspect=1}updateMatrices(e){const t=this.camera,i=Xa*2*e.angle*this.focus,s=this.mapSize.width/this.mapSize.height*this.aspect,n=e.distance||t.far;(i!==t.fov||s!==t.aspect||n!==t.far)&&(t.fov=i,t.aspect=s,t.far=n,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class Vy extends oo{constructor(e,t,i=0,s=Math.PI/3,n=0,a=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(ai.DEFAULT_UP),this.updateMatrix(),this.target=new ai,this.distance=i,this.angle=s,this.penumbra=n,this.decay=a,this.map=null,this.shadow=new Wy}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){super.dispose(),this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.map=e.map,this.shadow=e.shadow.clone(),this}toJSON(e){const t=super.toJSON(e);return t.object.distance=this.distance,t.object.angle=this.angle,t.object.decay=this.decay,t.object.penumbra=this.penumbra,t.object.target=this.target.uuid,this.map&&this.map.isTexture&&(t.object.map=this.map.toJSON(e).uuid),t.object.shadow=this.shadow.toJSON(),t}}class $y extends iu{constructor(){super(new Wi(90,1,.5,500)),this.isPointLightShadow=!0}}class We extends oo{constructor(e,t,i=0,s=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=i,this.decay=s,this.shadow=new $y}get power(){return this.intensity*4*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){super.dispose(),this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}toJSON(e){const t=super.toJSON(e);return t.object.distance=this.distance,t.object.decay=this.decay,t.object.shadow=this.shadow.toJSON(),t}}class ur extends dm{constructor(e=-1,t=1,i=1,s=-1,n=.1,a=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=s,this.near=n,this.far=a,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=e.view===null?null:Object.assign({},e.view),this}setViewOffset(e,t,i,s,n,a){this.view===null&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=i,this.view.offsetY=s,this.view.width=n,this.view.height=a,this.updateProjectionMatrix()}clearViewOffset(){this.view!==null&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,s=(this.top+this.bottom)/2;let n=i-e,a=i+e,o=s+t,r=s-t;if(this.view!==null&&this.view.enabled){const c=(this.right-this.left)/this.view.fullWidth/this.zoom,h=(this.top-this.bottom)/this.view.fullHeight/this.zoom;n+=c*this.view.offsetX,a=n+c*this.view.width,o-=h*this.view.offsetY,r=o-h*this.view.height}this.projectionMatrix.makeOrthographic(n,a,o,r,this.near,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,this.view!==null&&(t.object.view=Object.assign({},this.view)),t}}class Xy extends iu{constructor(){super(new ur(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class gd extends oo{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(ai.DEFAULT_UP),this.updateMatrix(),this.target=new ai,this.shadow=new Xy}dispose(){super.dispose(),this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}toJSON(e){const t=super.toJSON(e);return t.object.shadow=this.shadow.toJSON(),t.object.target=this.target.uuid,t}}class Vo extends oo{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class Yy extends oo{constructor(e,t,i=10,s=10){super(e,t),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=i,this.height=s}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}}class $o{static extractUrlBase(e){const t=e.lastIndexOf("/");return t===-1?"./":e.slice(0,t+1)}static resolveURL(e,t){return typeof e!="string"||e===""?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}}const Lc=new WeakMap;class Qy extends ca{constructor(e){super(e),this.isImageBitmapLoader=!0,typeof createImageBitmap>"u"&&Qe("ImageBitmapLoader: createImageBitmap() not supported."),typeof fetch>"u"&&Qe("ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"},this._abortController=new AbortController}setOptions(e){return this.options=e,this}load(e,t,i,s){e===void 0&&(e=""),this.path!==void 0&&(e=this.path+e),e=this.manager.resolveURL(e);const n=this,a=fn.get(`image-bitmap:${e}`);if(a!==void 0){if(n.manager.itemStart(e),a.then){a.then(c=>{if(Lc.has(a)===!0)s&&s(Lc.get(a)),n.manager.itemError(e),n.manager.itemEnd(e);else return t&&t(c),n.manager.itemEnd(e),c});return}return setTimeout(function(){t&&t(a),n.manager.itemEnd(e)},0),a}const o={};o.credentials=this.crossOrigin==="anonymous"?"same-origin":"include",o.headers=this.requestHeader,o.signal=typeof AbortSignal.any=="function"?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal;const r=fetch(e,o).then(function(c){return c.blob()}).then(function(c){return createImageBitmap(c,Object.assign(n.options,{colorSpaceConversion:"none"}))}).then(function(c){return fn.add(`image-bitmap:${e}`,c),t&&t(c),n.manager.itemEnd(e),c}).catch(function(c){s&&s(c),Lc.set(r,c),fn.remove(`image-bitmap:${e}`),n.manager.itemError(e),n.manager.itemEnd(e)});fn.add(`image-bitmap:${e}`,r),n.manager.itemStart(e)}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}}class jy extends Wi{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}}class km{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=performance.now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=performance.now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}class Ky{constructor(e,t,i){this.binding=e,this.valueSize=i;let s,n,a;switch(t){case"quaternion":s=this._slerp,n=this._slerpAdditive,a=this._setAdditiveIdentityQuaternion,this.buffer=new Float64Array(i*6),this._workIndex=5;break;case"string":case"bool":s=this._select,n=this._select,a=this._setAdditiveIdentityOther,this.buffer=new Array(i*5);break;default:s=this._lerp,n=this._lerpAdditive,a=this._setAdditiveIdentityNumeric,this.buffer=new Float64Array(i*5)}this._mixBufferRegion=s,this._mixBufferRegionAdditive=n,this._setIdentity=a,this._origIndex=3,this._addIndex=4,this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,this.useCount=0,this.referenceCount=0}accumulate(e,t){const i=this.buffer,s=this.valueSize,n=e*s+s;let a=this.cumulativeWeight;if(a===0){for(let o=0;o!==s;++o)i[n+o]=i[o];a=t}else{a+=t;const o=t/a;this._mixBufferRegion(i,n,0,o,s)}this.cumulativeWeight=a}accumulateAdditive(e){const t=this.buffer,i=this.valueSize,s=i*this._addIndex;this.cumulativeWeightAdditive===0&&this._setIdentity(),this._mixBufferRegionAdditive(t,s,0,e,i),this.cumulativeWeightAdditive+=e}apply(e){const t=this.valueSize,i=this.buffer,s=e*t+t,n=this.cumulativeWeight,a=this.cumulativeWeightAdditive,o=this.binding;if(this.cumulativeWeight=0,this.cumulativeWeightAdditive=0,n<1){const r=t*this._origIndex;this._mixBufferRegion(i,s,r,1-n,t)}a>0&&this._mixBufferRegionAdditive(i,s,this._addIndex*t,1,t);for(let r=t,c=t+t;r!==c;++r)if(i[r]!==i[r+t]){o.setValue(i,s);break}}saveOriginalState(){const e=this.binding,t=this.buffer,i=this.valueSize,s=i*this._origIndex;e.getValue(t,s);for(let n=i,a=s;n!==a;++n)t[n]=t[s+n%i];this._setIdentity(),this.cumulativeWeight=0,this.cumulativeWeightAdditive=0}restoreOriginalState(){const e=this.valueSize*3;this.binding.setValue(this.buffer,e)}_setAdditiveIdentityNumeric(){const e=this._addIndex*this.valueSize,t=e+this.valueSize;for(let i=e;i<t;i++)this.buffer[i]=0}_setAdditiveIdentityQuaternion(){this._setAdditiveIdentityNumeric(),this.buffer[this._addIndex*this.valueSize+3]=1}_setAdditiveIdentityOther(){const e=this._origIndex*this.valueSize,t=this._addIndex*this.valueSize;for(let i=0;i<this.valueSize;i++)this.buffer[t+i]=this.buffer[e+i]}_select(e,t,i,s,n){if(s>=.5)for(let a=0;a!==n;++a)e[t+a]=e[i+a]}_slerp(e,t,i,s){Cs.slerpFlat(e,t,e,t,e,i,s)}_slerpAdditive(e,t,i,s,n){const a=this._workIndex*n;Cs.multiplyQuaternionsFlat(e,a,e,t,e,i),Cs.slerpFlat(e,t,e,t,e,a,s)}_lerp(e,t,i,s,n){const a=1-s;for(let o=0;o!==n;++o){const r=t+o;e[r]=e[r]*a+e[i+o]*s}}_lerpAdditive(e,t,i,s,n){for(let a=0;a!==n;++a){const o=t+a;e[o]=e[o]+e[i+a]*s}}}const su="\\[\\]\\.:\\/",Zy=new RegExp("["+su+"]","g"),nu="[^"+su+"]",Jy="[^"+su.replace("\\.","")+"]",ev=/((?:WC+[\/:])*)/.source.replace("WC",nu),tv=/(WCOD+)?/.source.replace("WCOD",Jy),iv=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",nu),sv=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",nu),nv=new RegExp("^"+ev+tv+iv+sv+"$"),av=["material","materials","bones","map"];class ov{constructor(e,t,i){const s=i||Ht.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,s)}getValue(e,t){this.bind();const i=this._targetGroup.nCachedObjects_,s=this._bindings[i];s!==void 0&&s.getValue(e,t)}setValue(e,t){const i=this._bindings;for(let s=this._targetGroup.nCachedObjects_,n=i.length;s!==n;++s)i[s].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}}class Ht{constructor(e,t,i){this.path=t,this.parsedPath=i||Ht.parseTrackName(t),this.node=Ht.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,i){return e&&e.isAnimationObjectGroup?new Ht.Composite(e,t,i):new Ht(e,t,i)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(Zy,"")}static parseTrackName(e){const t=nv.exec(e);if(t===null)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},s=i.nodeName&&i.nodeName.lastIndexOf(".");if(s!==void 0&&s!==-1){const n=i.nodeName.substring(s+1);av.indexOf(n)!==-1&&(i.nodeName=i.nodeName.substring(0,s),i.objectName=n)}if(i.propertyName===null||i.propertyName.length===0)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i}static findNode(e,t){if(t===void 0||t===""||t==="."||t===-1||t===e.name||t===e.uuid)return e;if(e.skeleton){const i=e.skeleton.getBoneByName(t);if(i!==void 0)return i}if(e.children){const i=function(n){for(let a=0;a<n.length;a++){const o=n[a];if(o.name===t||o.uuid===t)return o;const r=i(o.children);if(r)return r}return null},s=i(e.children);if(s)return s}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){const i=this.resolvedProperty;for(let s=0,n=i.length;s!==n;++s)e[t++]=i[s]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const i=this.resolvedProperty;for(let s=0,n=i.length;s!==n;++s)i[s]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const i=this.resolvedProperty;for(let s=0,n=i.length;s!==n;++s)i[s]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const i=this.resolvedProperty;for(let s=0,n=i.length;s!==n;++s)i[s]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node;const t=this.parsedPath,i=t.objectName,s=t.propertyName;let n=t.propertyIndex;if(e||(e=Ht.findNode(this.rootNode,t.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e){Qe("PropertyBinding: No target node found for track: "+this.path+".");return}if(i){let c=t.objectIndex;switch(i){case"materials":if(!e.material){rt("PropertyBinding: Can not bind to material as node does not have a material.",this);return}if(!e.material.materials){rt("PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);return}e=e.material.materials;break;case"bones":if(!e.skeleton){rt("PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);return}e=e.skeleton.bones;for(let h=0;h<e.length;h++)if(e[h].name===c){c=h;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material){rt("PropertyBinding: Can not bind to material as node does not have a material.",this);return}if(!e.material.map){rt("PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);return}e=e.material.map;break;default:if(e[i]===void 0){rt("PropertyBinding: Can not bind to objectName of node undefined.",this);return}e=e[i]}if(c!==void 0){if(e[c]===void 0){rt("PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);return}e=e[c]}}const a=e[s];if(a===void 0){const c=t.nodeName;rt("PropertyBinding: Trying to update property for track: "+c+"."+s+" but it wasn't found.",e);return}let o=this.Versioning.None;this.targetObject=e,e.isMaterial===!0?o=this.Versioning.NeedsUpdate:e.isObject3D===!0&&(o=this.Versioning.MatrixWorldNeedsUpdate);let r=this.BindingType.Direct;if(n!==void 0){if(s==="morphTargetInfluences"){if(!e.geometry){rt("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);return}if(!e.geometry.morphAttributes){rt("PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);return}e.morphTargetDictionary[n]!==void 0&&(n=e.morphTargetDictionary[n])}r=this.BindingType.ArrayElement,this.resolvedProperty=a,this.propertyIndex=n}else a.fromArray!==void 0&&a.toArray!==void 0?(r=this.BindingType.HasFromToArray,this.resolvedProperty=a):Array.isArray(a)?(r=this.BindingType.EntireArray,this.resolvedProperty=a):this.propertyName=s;this.getValue=this.GetterByBindingType[r],this.setValue=this.SetterByBindingTypeAndVersioning[r][o]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}Ht.Composite=ov;Ht.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3};Ht.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2};Ht.prototype.GetterByBindingType=[Ht.prototype._getValue_direct,Ht.prototype._getValue_array,Ht.prototype._getValue_arrayElement,Ht.prototype._getValue_toArray];Ht.prototype.SetterByBindingTypeAndVersioning=[[Ht.prototype._setValue_direct,Ht.prototype._setValue_direct_setNeedsUpdate,Ht.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[Ht.prototype._setValue_array,Ht.prototype._setValue_array_setNeedsUpdate,Ht.prototype._setValue_array_setMatrixWorldNeedsUpdate],[Ht.prototype._setValue_arrayElement,Ht.prototype._setValue_arrayElement_setNeedsUpdate,Ht.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[Ht.prototype._setValue_fromArray,Ht.prototype._setValue_fromArray_setNeedsUpdate,Ht.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];class rv{constructor(e,t,i=null,s=t.blendMode){this._mixer=e,this._clip=t,this._localRoot=i,this.blendMode=s;const n=t.tracks,a=n.length,o=new Array(a),r={endingStart:Ua,endingEnd:Ua};for(let c=0;c!==a;++c){const h=n[c].createInterpolant(null);o[c]=h,h.settings=r}this._interpolantSettings=r,this._interpolants=o,this._propertyBindings=new Array(a),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=tm,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}play(){return this._mixer._activateAction(this),this}stop(){return this._mixer._deactivateAction(this),this.reset()}reset(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()}isRunning(){return this.enabled&&!this.paused&&this.timeScale!==0&&this._startTime===null&&this._mixer._isActiveAction(this)}isScheduled(){return this._mixer._isActiveAction(this)}startAt(e){return this._startTime=e,this}setLoop(e,t){return this.loop=e,this.repetitions=t,this}setEffectiveWeight(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()}getEffectiveWeight(){return this._effectiveWeight}fadeIn(e){return this._scheduleFading(e,0,1)}fadeOut(e){return this._scheduleFading(e,1,0)}crossFadeFrom(e,t,i=!1){if(e.fadeOut(t),this.fadeIn(t),i===!0){const s=this._clip.duration,n=e._clip.duration,a=n/s,o=s/n;e.warp(1,a,t),this.warp(o,1,t)}return this}crossFadeTo(e,t,i=!1){return e.crossFadeFrom(this,t,i)}stopFading(){const e=this._weightInterpolant;return e!==null&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}setEffectiveTimeScale(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()}getEffectiveTimeScale(){return this._effectiveTimeScale}setDuration(e){return this.timeScale=this._clip.duration/e,this.stopWarping()}syncWith(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()}halt(e){return this.warp(this._effectiveTimeScale,0,e)}warp(e,t,i){const s=this._mixer,n=s.time,a=this.timeScale;let o=this._timeScaleInterpolant;o===null&&(o=s._lendControlInterpolant(),this._timeScaleInterpolant=o);const r=o.parameterPositions,c=o.sampleValues;return r[0]=n,r[1]=n+i,c[0]=e/a,c[1]=t/a,this}stopWarping(){const e=this._timeScaleInterpolant;return e!==null&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this}getMixer(){return this._mixer}getClip(){return this._clip}getRoot(){return this._localRoot||this._mixer._root}_update(e,t,i,s){if(!this.enabled){this._updateWeight(e);return}const n=this._startTime;if(n!==null){const r=(e-n)*i;r<0||i===0?t=0:(this._startTime=null,t=i*r)}t*=this._updateTimeScale(e);const a=this._updateTime(t),o=this._updateWeight(e);if(o>0){const r=this._interpolants,c=this._propertyBindings;switch(this.blendMode){case q0:for(let h=0,d=r.length;h!==d;++h)r[h].evaluate(a),c[h].accumulateAdditive(o);break;case Gd:default:for(let h=0,d=r.length;h!==d;++h)r[h].evaluate(a),c[h].accumulate(s,o)}}}_updateWeight(e){let t=0;if(this.enabled){t=this.weight;const i=this._weightInterpolant;if(i!==null){const s=i.evaluate(e)[0];t*=s,e>i.parameterPositions[1]&&(this.stopFading(),s===0&&(this.enabled=!1))}}return this._effectiveWeight=t,t}_updateTimeScale(e){let t=0;if(!this.paused){t=this.timeScale;const i=this._timeScaleInterpolant;if(i!==null){const s=i.evaluate(e)[0];t*=s,e>i.parameterPositions[1]&&(this.stopWarping(),t===0?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t}_updateTime(e){const t=this._clip.duration,i=this.loop;let s=this.time+e,n=this._loopCount;const a=i===H0;if(e===0)return n===-1?s:a&&(n&1)===1?t-s:s;if(i===em){n===-1&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(s>=t)s=t;else if(s<0)s=0;else{this.time=s;break e}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this.time=s,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{if(n===-1&&(e>=0?(n=0,this._setEndings(!0,this.repetitions===0,a)):this._setEndings(this.repetitions===0,!0,a)),s>=t||s<0){const o=Math.floor(s/t);s-=t*o,n+=Math.abs(o);const r=this.repetitions-n;if(r<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,s=e>0?t:0,this.time=s,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(r===1){const c=e<0;this._setEndings(c,!c,a)}else this._setEndings(!1,!1,a);this._loopCount=n,this.time=s,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:o})}}else this.time=s;if(a&&(n&1)===1)return t-s}return s}_setEndings(e,t,i){const s=this._interpolantSettings;i?(s.endingStart=Ga,s.endingEnd=Ga):(e?s.endingStart=this.zeroSlopeAtStart?Ga:Ua:s.endingStart=Rl,t?s.endingEnd=this.zeroSlopeAtEnd?Ga:Ua:s.endingEnd=Rl)}_scheduleFading(e,t,i){const s=this._mixer,n=s.time;let a=this._weightInterpolant;a===null&&(a=s._lendControlInterpolant(),this._weightInterpolant=a);const o=a.parameterPositions,r=a.sampleValues;return o[0]=n,r[0]=t,o[1]=n+e,r[1]=i,this}}const lv=new Float32Array(1);class Pm extends la{constructor(e){super(),this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}_bindAction(e,t){const i=e._localRoot||this._root,s=e._clip.tracks,n=s.length,a=e._propertyBindings,o=e._interpolants,r=i.uuid,c=this._bindingsByRootAndName;let h=c[r];h===void 0&&(h={},c[r]=h);for(let d=0;d!==n;++d){const u=s[d],p=u.name;let f=h[p];if(f!==void 0)++f.referenceCount,a[d]=f;else{if(f=a[d],f!==void 0){f._cacheIndex===null&&(++f.referenceCount,this._addInactiveBinding(f,r,p));continue}const y=t&&t._propertyBindings[d].binding.parsedPath;f=new Ky(Ht.create(i,p,y),u.ValueTypeName,u.getValueSize()),++f.referenceCount,this._addInactiveBinding(f,r,p),a[d]=f}o[d].resultBuffer=f.buffer}}_activateAction(e){if(!this._isActiveAction(e)){if(e._cacheIndex===null){const i=(e._localRoot||this._root).uuid,s=e._clip.uuid,n=this._actionsByClip[s];this._bindAction(e,n&&n.knownActions[0]),this._addInactiveAction(e,s,i)}const t=e._propertyBindings;for(let i=0,s=t.length;i!==s;++i){const n=t[i];n.useCount++===0&&(this._lendBinding(n),n.saveOriginalState())}this._lendAction(e)}}_deactivateAction(e){if(this._isActiveAction(e)){const t=e._propertyBindings;for(let i=0,s=t.length;i!==s;++i){const n=t[i];--n.useCount===0&&(n.restoreOriginalState(),this._takeBackBinding(n))}this._takeBackAction(e)}}_initMemoryManager(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;const e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}}_isActiveAction(e){const t=e._cacheIndex;return t!==null&&t<this._nActiveActions}_addInactiveAction(e,t,i){const s=this._actions,n=this._actionsByClip;let a=n[t];if(a===void 0)a={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,n[t]=a;else{const o=a.knownActions;e._byClipCacheIndex=o.length,o.push(e)}e._cacheIndex=s.length,s.push(e),a.actionByRoot[i]=e}_removeInactiveAction(e){const t=this._actions,i=t[t.length-1],s=e._cacheIndex;i._cacheIndex=s,t[s]=i,t.pop(),e._cacheIndex=null;const n=e._clip.uuid,a=this._actionsByClip,o=a[n],r=o.knownActions,c=r[r.length-1],h=e._byClipCacheIndex;c._byClipCacheIndex=h,r[h]=c,r.pop(),e._byClipCacheIndex=null;const d=o.actionByRoot,u=(e._localRoot||this._root).uuid;delete d[u],r.length===0&&delete a[n],this._removeInactiveBindingsForAction(e)}_removeInactiveBindingsForAction(e){const t=e._propertyBindings;for(let i=0,s=t.length;i!==s;++i){const n=t[i];--n.referenceCount===0&&this._removeInactiveBinding(n)}}_lendAction(e){const t=this._actions,i=e._cacheIndex,s=this._nActiveActions++,n=t[s];e._cacheIndex=s,t[s]=e,n._cacheIndex=i,t[i]=n}_takeBackAction(e){const t=this._actions,i=e._cacheIndex,s=--this._nActiveActions,n=t[s];e._cacheIndex=s,t[s]=e,n._cacheIndex=i,t[i]=n}_addInactiveBinding(e,t,i){const s=this._bindingsByRootAndName,n=this._bindings;let a=s[t];a===void 0&&(a={},s[t]=a),a[i]=e,e._cacheIndex=n.length,n.push(e)}_removeInactiveBinding(e){const t=this._bindings,i=e.binding,s=i.rootNode.uuid,n=i.path,a=this._bindingsByRootAndName,o=a[s],r=t[t.length-1],c=e._cacheIndex;r._cacheIndex=c,t[c]=r,t.pop(),delete o[n],Object.keys(o).length===0&&delete a[s]}_lendBinding(e){const t=this._bindings,i=e._cacheIndex,s=this._nActiveBindings++,n=t[s];e._cacheIndex=s,t[s]=e,n._cacheIndex=i,t[i]=n}_takeBackBinding(e){const t=this._bindings,i=e._cacheIndex,s=--this._nActiveBindings,n=t[s];e._cacheIndex=s,t[s]=e,n._cacheIndex=i,t[i]=n}_lendControlInterpolant(){const e=this._controlInterpolants,t=this._nActiveControlInterpolants++;let i=e[t];return i===void 0&&(i=new Am(new Float32Array(2),new Float32Array(2),1,lv),i.__cacheIndex=t,e[t]=i),i}_takeBackControlInterpolant(e){const t=this._controlInterpolants,i=e.__cacheIndex,s=--this._nActiveControlInterpolants,n=t[s];e.__cacheIndex=s,t[s]=e,n.__cacheIndex=i,t[i]=n}clipAction(e,t,i){const s=t||this._root,n=s.uuid;let a=typeof e=="string"?md.findByName(s,e):e;const o=a!==null?a.uuid:e,r=this._actionsByClip[o];let c=null;if(i===void 0&&(a!==null?i=a.blendMode:i=Gd),r!==void 0){const d=r.actionByRoot[n];if(d!==void 0&&d.blendMode===i)return d;c=r.knownActions[0],a===null&&(a=c._clip)}if(a===null)return null;const h=new rv(this,a,t,i);return this._bindAction(h,c),this._addInactiveAction(h,o,n),h}existingAction(e,t){const i=t||this._root,s=i.uuid,n=typeof e=="string"?md.findByName(i,e):e,a=n?n.uuid:e,o=this._actionsByClip[a];return o!==void 0&&o.actionByRoot[s]||null}stopAllAction(){const e=this._actions,t=this._nActiveActions;for(let i=t-1;i>=0;--i)e[i].stop();return this}update(e){e*=this.timeScale;const t=this._actions,i=this._nActiveActions,s=this.time+=e,n=Math.sign(e),a=this._accuIndex^=1;for(let c=0;c!==i;++c)t[c]._update(s,e,n,a);const o=this._bindings,r=this._nActiveBindings;for(let c=0;c!==r;++c)o[c].apply(a);return this}setTime(e){this.time=0;for(let t=0;t<this._actions.length;t++)this._actions[t].time=0;return this.update(e)}getRoot(){return this._root}uncacheClip(e){const t=this._actions,i=e.uuid,s=this._actionsByClip,n=s[i];if(n!==void 0){const a=n.knownActions;for(let o=0,r=a.length;o!==r;++o){const c=a[o];this._deactivateAction(c);const h=c._cacheIndex,d=t[t.length-1];c._cacheIndex=null,c._byClipCacheIndex=null,d._cacheIndex=h,t[h]=d,t.pop(),this._removeInactiveBindingsForAction(c)}delete s[i]}}uncacheRoot(e){const t=e.uuid,i=this._actionsByClip;for(const a in i){const o=i[a].actionByRoot,r=o[t];r!==void 0&&(this._deactivateAction(r),this._removeInactiveAction(r))}const s=this._bindingsByRootAndName,n=s[t];if(n!==void 0)for(const a in n){const o=n[a];o.restoreOriginalState(),this._removeInactiveBinding(o)}}uncacheAction(e,t){const i=this.existingAction(e,t);i!==null&&(this._deactivateAction(i),this._removeInactiveAction(i))}}function yp(l,e,t,i){const s=cv(i);switch(t){case Zf:return l*e;case Bd:return l*e/s.components*s.byteLength;case zd:return l*e/s.components*s.byteLength;case $a:return l*e*2/s.components*s.byteLength;case Fd:return l*e*2/s.components*s.byteLength;case Jf:return l*e*3/s.components*s.byteLength;case xs:return l*e*4/s.components*s.byteLength;case Ud:return l*e*4/s.components*s.byteLength;case yl:case vl:return Math.floor((l+3)/4)*Math.floor((e+3)/4)*8;case xl:case bl:return Math.floor((l+3)/4)*Math.floor((e+3)/4)*16;case kh:case Dh:return Math.max(l,16)*Math.max(e,8)/4;case Ih:case Ph:return Math.max(l,8)*Math.max(e,8)/2;case Lh:case Oh:case Bh:case zh:return Math.floor((l+3)/4)*Math.floor((e+3)/4)*8;case Nh:case Fh:case Uh:return Math.floor((l+3)/4)*Math.floor((e+3)/4)*16;case Gh:return Math.floor((l+3)/4)*Math.floor((e+3)/4)*16;case Hh:return Math.floor((l+4)/5)*Math.floor((e+3)/4)*16;case qh:return Math.floor((l+4)/5)*Math.floor((e+4)/5)*16;case Wh:return Math.floor((l+5)/6)*Math.floor((e+4)/5)*16;case Vh:return Math.floor((l+5)/6)*Math.floor((e+5)/6)*16;case $h:return Math.floor((l+7)/8)*Math.floor((e+4)/5)*16;case Xh:return Math.floor((l+7)/8)*Math.floor((e+5)/6)*16;case Yh:return Math.floor((l+7)/8)*Math.floor((e+7)/8)*16;case Qh:return Math.floor((l+9)/10)*Math.floor((e+4)/5)*16;case jh:return Math.floor((l+9)/10)*Math.floor((e+5)/6)*16;case Kh:return Math.floor((l+9)/10)*Math.floor((e+7)/8)*16;case Zh:return Math.floor((l+9)/10)*Math.floor((e+9)/10)*16;case Jh:return Math.floor((l+11)/12)*Math.floor((e+9)/10)*16;case ed:return Math.floor((l+11)/12)*Math.floor((e+11)/12)*16;case td:case id:case sd:return Math.ceil(l/4)*Math.ceil(e/4)*16;case nd:case ad:return Math.ceil(l/4)*Math.ceil(e/4)*8;case od:case rd:return Math.ceil(l/4)*Math.ceil(e/4)*16}throw new Error(`Unable to determine texture byte length for ${t} format.`)}function cv(l){switch(l){case ls:case Yf:return{byteLength:1,components:1};case Qo:case Qf:case cs:return{byteLength:2,components:1};case Od:case Nd:return{byteLength:2,components:4};case Qs:case Ld:case vs:return{byteLength:4,components:1};case jf:case Kf:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${l}.`)}typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:Cd}}));typeof window<"u"&&(window.__THREE__?Qe("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=Cd);function Dm(){let l=null,e=!1,t=null,i=null;function s(n,a){t(n,a),i=l.requestAnimationFrame(s)}return{start:function(){e!==!0&&t!==null&&(i=l.requestAnimationFrame(s),e=!0)},stop:function(){l.cancelAnimationFrame(i),e=!1},setAnimationLoop:function(n){t=n},setContext:function(n){l=n}}}function hv(l){const e=new WeakMap;function t(o,r){const c=o.array,h=o.usage,d=c.byteLength,u=l.createBuffer();l.bindBuffer(r,u),l.bufferData(r,c,h),o.onUploadCallback();let p;if(c instanceof Float32Array)p=l.FLOAT;else if(typeof Float16Array<"u"&&c instanceof Float16Array)p=l.HALF_FLOAT;else if(c instanceof Uint16Array)o.isFloat16BufferAttribute?p=l.HALF_FLOAT:p=l.UNSIGNED_SHORT;else if(c instanceof Int16Array)p=l.SHORT;else if(c instanceof Uint32Array)p=l.UNSIGNED_INT;else if(c instanceof Int32Array)p=l.INT;else if(c instanceof Int8Array)p=l.BYTE;else if(c instanceof Uint8Array)p=l.UNSIGNED_BYTE;else if(c instanceof Uint8ClampedArray)p=l.UNSIGNED_BYTE;else throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+c);return{buffer:u,type:p,bytesPerElement:c.BYTES_PER_ELEMENT,version:o.version,size:d}}function i(o,r,c){const h=r.array,d=r.updateRanges;if(l.bindBuffer(c,o),d.length===0)l.bufferSubData(c,0,h);else{d.sort((p,f)=>p.start-f.start);let u=0;for(let p=1;p<d.length;p++){const f=d[u],y=d[p];y.start<=f.start+f.count+1?f.count=Math.max(f.count,y.start+y.count-f.start):(++u,d[u]=y)}d.length=u+1;for(let p=0,f=d.length;p<f;p++){const y=d[p];l.bufferSubData(c,y.start*h.BYTES_PER_ELEMENT,h,y.start,y.count)}r.clearUpdateRanges()}r.onUploadCallback()}function s(o){return o.isInterleavedBufferAttribute&&(o=o.data),e.get(o)}function n(o){o.isInterleavedBufferAttribute&&(o=o.data);const r=e.get(o);r&&(l.deleteBuffer(r.buffer),e.delete(o))}function a(o,r){if(o.isInterleavedBufferAttribute&&(o=o.data),o.isGLBufferAttribute){const h=e.get(o);(!h||h.version<o.version)&&e.set(o,{buffer:o.buffer,type:o.type,bytesPerElement:o.elementSize,version:o.version});return}const c=e.get(o);if(c===void 0)e.set(o,t(o,r));else if(c.version<o.version){if(c.size!==o.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");i(c.buffer,o,r),c.version=o.version}}return{get:s,remove:n,update:a}}var dv=`#ifdef USE_ALPHAHASH
	if ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;
#endif`,uv=`#ifdef USE_ALPHAHASH
	const float ALPHA_HASH_SCALE = 0.05;
	float hash2D( vec2 value ) {
		return fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );
	}
	float hash3D( vec3 value ) {
		return hash2D( vec2( hash2D( value.xy ), value.z ) );
	}
	float getAlphaHashThreshold( vec3 position ) {
		float maxDeriv = max(
			length( dFdx( position.xyz ) ),
			length( dFdy( position.xyz ) )
		);
		float pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );
		vec2 pixScales = vec2(
			exp2( floor( log2( pixScale ) ) ),
			exp2( ceil( log2( pixScale ) ) )
		);
		vec2 alpha = vec2(
			hash3D( floor( pixScales.x * position.xyz ) ),
			hash3D( floor( pixScales.y * position.xyz ) )
		);
		float lerpFactor = fract( log2( pixScale ) );
		float x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;
		float a = min( lerpFactor, 1.0 - lerpFactor );
		vec3 cases = vec3(
			x * x / ( 2.0 * a * ( 1.0 - a ) ),
			( x - 0.5 * a ) / ( 1.0 - a ),
			1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )
		);
		float threshold = ( x < ( 1.0 - a ) )
			? ( ( x < a ) ? cases.x : cases.y )
			: cases.z;
		return clamp( threshold , 1.0e-6, 1.0 );
	}
#endif`,pv=`#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;
#endif`,fv=`#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,mv=`#ifdef USE_ALPHATEST
	#ifdef ALPHA_TO_COVERAGE
	diffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );
	if ( diffuseColor.a == 0.0 ) discard;
	#else
	if ( diffuseColor.a < alphaTest ) discard;
	#endif
#endif`,gv=`#ifdef USE_ALPHATEST
	uniform float alphaTest;
#endif`,yv=`#ifdef USE_AOMAP
	float ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;
	reflectedLight.indirectDiffuse *= ambientOcclusion;
	#if defined( USE_CLEARCOAT ) 
		clearcoatSpecularIndirect *= ambientOcclusion;
	#endif
	#if defined( USE_SHEEN ) 
		sheenSpecularIndirect *= ambientOcclusion;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD )
		float dotNV = saturate( dot( geometryNormal, geometryViewDir ) );
		reflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );
	#endif
#endif`,vv=`#ifdef USE_AOMAP
	uniform sampler2D aoMap;
	uniform float aoMapIntensity;
#endif`,xv=`#ifdef USE_BATCHING
	#if ! defined( GL_ANGLE_multi_draw )
	#define gl_DrawID _gl_DrawID
	uniform int _gl_DrawID;
	#endif
	uniform highp sampler2D batchingTexture;
	uniform highp usampler2D batchingIdTexture;
	mat4 getBatchingMatrix( const in float i ) {
		int size = textureSize( batchingTexture, 0 ).x;
		int j = int( i ) * 4;
		int x = j % size;
		int y = j / size;
		vec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );
		vec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );
		vec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );
		vec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );
		return mat4( v1, v2, v3, v4 );
	}
	float getIndirectIndex( const in int i ) {
		int size = textureSize( batchingIdTexture, 0 ).x;
		int x = i % size;
		int y = i / size;
		return float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );
	}
#endif
#ifdef USE_BATCHING_COLOR
	uniform sampler2D batchingColorTexture;
	vec3 getBatchingColor( const in float i ) {
		int size = textureSize( batchingColorTexture, 0 ).x;
		int j = int( i );
		int x = j % size;
		int y = j / size;
		return texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;
	}
#endif`,bv=`#ifdef USE_BATCHING
	mat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );
#endif`,wv=`vec3 transformed = vec3( position );
#ifdef USE_ALPHAHASH
	vPosition = vec3( position );
#endif`,_v=`vec3 objectNormal = vec3( normal );
#ifdef USE_TANGENT
	vec3 objectTangent = vec3( tangent.xyz );
#endif`,Mv=`float G_BlinnPhong_Implicit( ) {
	return 0.25;
}
float D_BlinnPhong( const in float shininess, const in float dotNH ) {
	return RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );
}
vec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( specularColor, 1.0, dotVH );
	float G = G_BlinnPhong_Implicit( );
	float D = D_BlinnPhong( shininess, dotNH );
	return F * ( G * D );
} // validated`,Sv=`#ifdef USE_IRIDESCENCE
	const mat3 XYZ_TO_REC709 = mat3(
		 3.2404542, -0.9692660,  0.0556434,
		-1.5371385,  1.8760108, -0.2040259,
		-0.4985314,  0.0415560,  1.0572252
	);
	vec3 Fresnel0ToIor( vec3 fresnel0 ) {
		vec3 sqrtF0 = sqrt( fresnel0 );
		return ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );
	}
	vec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {
		return pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );
	}
	float IorToFresnel0( float transmittedIor, float incidentIor ) {
		return pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));
	}
	vec3 evalSensitivity( float OPD, vec3 shift ) {
		float phase = 2.0 * PI * OPD * 1.0e-9;
		vec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );
		vec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );
		vec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );
		vec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );
		xyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );
		xyz /= 1.0685e-7;
		vec3 rgb = XYZ_TO_REC709 * xyz;
		return rgb;
	}
	vec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {
		vec3 I;
		float iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );
		float sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );
		float cosTheta2Sq = 1.0 - sinTheta2Sq;
		if ( cosTheta2Sq < 0.0 ) {
			return vec3( 1.0 );
		}
		float cosTheta2 = sqrt( cosTheta2Sq );
		float R0 = IorToFresnel0( iridescenceIOR, outsideIOR );
		float R12 = F_Schlick( R0, 1.0, cosTheta1 );
		float T121 = 1.0 - R12;
		float phi12 = 0.0;
		if ( iridescenceIOR < outsideIOR ) phi12 = PI;
		float phi21 = PI - phi12;
		vec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );		vec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );
		vec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );
		vec3 phi23 = vec3( 0.0 );
		if ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;
		if ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;
		if ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;
		float OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;
		vec3 phi = vec3( phi21 ) + phi23;
		vec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );
		vec3 r123 = sqrt( R123 );
		vec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );
		vec3 C0 = R12 + Rs;
		I = C0;
		vec3 Cm = Rs - T121;
		for ( int m = 1; m <= 2; ++ m ) {
			Cm *= r123;
			vec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );
			I += Cm * Sm;
		}
		return max( I, vec3( 0.0 ) );
	}
#endif`,Tv=`#ifdef USE_BUMPMAP
	uniform sampler2D bumpMap;
	uniform float bumpScale;
	vec2 dHdxy_fwd() {
		vec2 dSTdx = dFdx( vBumpMapUv );
		vec2 dSTdy = dFdy( vBumpMapUv );
		float Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;
		float dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;
		float dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;
		return vec2( dBx, dBy );
	}
	vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {
		vec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );
		vec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );
		vec3 vN = surf_norm;
		vec3 R1 = cross( vSigmaY, vN );
		vec3 R2 = cross( vN, vSigmaX );
		float fDet = dot( vSigmaX, R1 ) * faceDirection;
		vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );
		return normalize( abs( fDet ) * surf_norm - vGrad );
	}
#endif`,Ev=`#if NUM_CLIPPING_PLANES > 0
	vec4 plane;
	#ifdef ALPHA_TO_COVERAGE
		float distanceToPlane, distanceGradient;
		float clipOpacity = 1.0;
		#pragma unroll_loop_start
		for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			distanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;
			distanceGradient = fwidth( distanceToPlane ) / 2.0;
			clipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );
			if ( clipOpacity == 0.0 ) discard;
		}
		#pragma unroll_loop_end
		#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
			float unionClipOpacity = 1.0;
			#pragma unroll_loop_start
			for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
				plane = clippingPlanes[ i ];
				distanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;
				distanceGradient = fwidth( distanceToPlane ) / 2.0;
				unionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );
			}
			#pragma unroll_loop_end
			clipOpacity *= 1.0 - unionClipOpacity;
		#endif
		diffuseColor.a *= clipOpacity;
		if ( diffuseColor.a == 0.0 ) discard;
	#else
		#pragma unroll_loop_start
		for ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {
			plane = clippingPlanes[ i ];
			if ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;
		}
		#pragma unroll_loop_end
		#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES
			bool clipped = true;
			#pragma unroll_loop_start
			for ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {
				plane = clippingPlanes[ i ];
				clipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;
			}
			#pragma unroll_loop_end
			if ( clipped ) discard;
		#endif
	#endif
#endif`,Cv=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
	uniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];
#endif`,Av=`#if NUM_CLIPPING_PLANES > 0
	varying vec3 vClipPosition;
#endif`,Rv=`#if NUM_CLIPPING_PLANES > 0
	vClipPosition = - mvPosition.xyz;
#endif`,Iv=`#if defined( USE_COLOR_ALPHA )
	diffuseColor *= vColor;
#elif defined( USE_COLOR )
	diffuseColor.rgb *= vColor;
#endif`,kv=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR )
	varying vec3 vColor;
#endif`,Pv=`#if defined( USE_COLOR_ALPHA )
	varying vec4 vColor;
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )
	varying vec3 vColor;
#endif`,Dv=`#if defined( USE_COLOR_ALPHA )
	vColor = vec4( 1.0 );
#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )
	vColor = vec3( 1.0 );
#endif
#ifdef USE_COLOR
	vColor *= color;
#endif
#ifdef USE_INSTANCING_COLOR
	vColor.xyz *= instanceColor.xyz;
#endif
#ifdef USE_BATCHING_COLOR
	vec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );
	vColor.xyz *= batchingColor.xyz;
#endif`,Lv=`#define PI 3.141592653589793
#define PI2 6.283185307179586
#define PI_HALF 1.5707963267948966
#define RECIPROCAL_PI 0.3183098861837907
#define RECIPROCAL_PI2 0.15915494309189535
#define EPSILON 1e-6
#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
#define whiteComplement( a ) ( 1.0 - saturate( a ) )
float pow2( const in float x ) { return x*x; }
vec3 pow2( const in vec3 x ) { return x*x; }
float pow3( const in float x ) { return x*x*x; }
float pow4( const in float x ) { float x2 = x*x; return x2*x2; }
float max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }
float average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }
highp float rand( const in vec2 uv ) {
	const highp float a = 12.9898, b = 78.233, c = 43758.5453;
	highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );
	return fract( sin( sn ) * c );
}
#ifdef HIGH_PRECISION
	float precisionSafeLength( vec3 v ) { return length( v ); }
#else
	float precisionSafeLength( vec3 v ) {
		float maxComponent = max3( abs( v ) );
		return length( v / maxComponent ) * maxComponent;
	}
#endif
struct IncidentLight {
	vec3 color;
	vec3 direction;
	bool visible;
};
struct ReflectedLight {
	vec3 directDiffuse;
	vec3 directSpecular;
	vec3 indirectDiffuse;
	vec3 indirectSpecular;
};
#ifdef USE_ALPHAHASH
	varying vec3 vPosition;
#endif
vec3 transformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );
}
vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
	return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
}
bool isPerspectiveMatrix( mat4 m ) {
	return m[ 2 ][ 3 ] == - 1.0;
}
vec2 equirectUv( in vec3 dir ) {
	float u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;
	float v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;
	return vec2( u, v );
}
vec3 BRDF_Lambert( const in vec3 diffuseColor ) {
	return RECIPROCAL_PI * diffuseColor;
}
vec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
}
float F_Schlick( const in float f0, const in float f90, const in float dotVH ) {
	float fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );
	return f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );
} // validated`,Ov=`#ifdef ENVMAP_TYPE_CUBE_UV
	#define cubeUV_minMipLevel 4.0
	#define cubeUV_minTileSize 16.0
	float getFace( vec3 direction ) {
		vec3 absDirection = abs( direction );
		float face = - 1.0;
		if ( absDirection.x > absDirection.z ) {
			if ( absDirection.x > absDirection.y )
				face = direction.x > 0.0 ? 0.0 : 3.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		} else {
			if ( absDirection.z > absDirection.y )
				face = direction.z > 0.0 ? 2.0 : 5.0;
			else
				face = direction.y > 0.0 ? 1.0 : 4.0;
		}
		return face;
	}
	vec2 getUV( vec3 direction, float face ) {
		vec2 uv;
		if ( face == 0.0 ) {
			uv = vec2( direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 1.0 ) {
			uv = vec2( - direction.x, - direction.z ) / abs( direction.y );
		} else if ( face == 2.0 ) {
			uv = vec2( - direction.x, direction.y ) / abs( direction.z );
		} else if ( face == 3.0 ) {
			uv = vec2( - direction.z, direction.y ) / abs( direction.x );
		} else if ( face == 4.0 ) {
			uv = vec2( - direction.x, direction.z ) / abs( direction.y );
		} else {
			uv = vec2( direction.x, direction.y ) / abs( direction.z );
		}
		return 0.5 * ( uv + 1.0 );
	}
	vec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {
		float face = getFace( direction );
		float filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );
		mipInt = max( mipInt, cubeUV_minMipLevel );
		float faceSize = exp2( mipInt );
		highp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;
		if ( face > 2.0 ) {
			uv.y += faceSize;
			face -= 3.0;
		}
		uv.x += face * faceSize;
		uv.x += filterInt * 3.0 * cubeUV_minTileSize;
		uv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );
		uv.x *= CUBEUV_TEXEL_WIDTH;
		uv.y *= CUBEUV_TEXEL_HEIGHT;
		#ifdef texture2DGradEXT
			return texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;
		#else
			return texture2D( envMap, uv ).rgb;
		#endif
	}
	#define cubeUV_r0 1.0
	#define cubeUV_m0 - 2.0
	#define cubeUV_r1 0.8
	#define cubeUV_m1 - 1.0
	#define cubeUV_r4 0.4
	#define cubeUV_m4 2.0
	#define cubeUV_r5 0.305
	#define cubeUV_m5 3.0
	#define cubeUV_r6 0.21
	#define cubeUV_m6 4.0
	float roughnessToMip( float roughness ) {
		float mip = 0.0;
		if ( roughness >= cubeUV_r1 ) {
			mip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;
		} else if ( roughness >= cubeUV_r4 ) {
			mip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;
		} else if ( roughness >= cubeUV_r5 ) {
			mip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;
		} else if ( roughness >= cubeUV_r6 ) {
			mip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;
		} else {
			mip = - 2.0 * log2( 1.16 * roughness );		}
		return mip;
	}
	vec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {
		float mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );
		float mipF = fract( mip );
		float mipInt = floor( mip );
		vec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );
		if ( mipF == 0.0 ) {
			return vec4( color0, 1.0 );
		} else {
			vec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );
			return vec4( mix( color0, color1, mipF ), 1.0 );
		}
	}
#endif`,Nv=`vec3 transformedNormal = objectNormal;
#ifdef USE_TANGENT
	vec3 transformedTangent = objectTangent;
#endif
#ifdef USE_BATCHING
	mat3 bm = mat3( batchingMatrix );
	transformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );
	transformedNormal = bm * transformedNormal;
	#ifdef USE_TANGENT
		transformedTangent = bm * transformedTangent;
	#endif
#endif
#ifdef USE_INSTANCING
	mat3 im = mat3( instanceMatrix );
	transformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );
	transformedNormal = im * transformedNormal;
	#ifdef USE_TANGENT
		transformedTangent = im * transformedTangent;
	#endif
#endif
transformedNormal = normalMatrix * transformedNormal;
#ifdef FLIP_SIDED
	transformedNormal = - transformedNormal;
#endif
#ifdef USE_TANGENT
	transformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;
	#ifdef FLIP_SIDED
		transformedTangent = - transformedTangent;
	#endif
#endif`,Bv=`#ifdef USE_DISPLACEMENTMAP
	uniform sampler2D displacementMap;
	uniform float displacementScale;
	uniform float displacementBias;
#endif`,zv=`#ifdef USE_DISPLACEMENTMAP
	transformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );
#endif`,Fv=`#ifdef USE_EMISSIVEMAP
	vec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );
	#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE
		emissiveColor = sRGBTransferEOTF( emissiveColor );
	#endif
	totalEmissiveRadiance *= emissiveColor.rgb;
#endif`,Uv=`#ifdef USE_EMISSIVEMAP
	uniform sampler2D emissiveMap;
#endif`,Gv="gl_FragColor = linearToOutputTexel( gl_FragColor );",Hv=`vec4 LinearTransferOETF( in vec4 value ) {
	return value;
}
vec4 sRGBTransferEOTF( in vec4 value ) {
	return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
}
vec4 sRGBTransferOETF( in vec4 value ) {
	return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );
}`,qv=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vec3 cameraToFrag;
		if ( isOrthographic ) {
			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToFrag = normalize( vWorldPosition - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vec3 reflectVec = reflect( cameraToFrag, worldNormal );
		#else
			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );
		#endif
	#else
		vec3 reflectVec = vReflect;
	#endif
	#ifdef ENVMAP_TYPE_CUBE
		vec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );
	#else
		vec4 envColor = vec4( 0.0 );
	#endif
	#ifdef ENVMAP_BLENDING_MULTIPLY
		outgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_MIX )
		outgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );
	#elif defined( ENVMAP_BLENDING_ADD )
		outgoingLight += envColor.xyz * specularStrength * reflectivity;
	#endif
#endif`,Wv=`#ifdef USE_ENVMAP
	uniform float envMapIntensity;
	uniform float flipEnvMap;
	uniform mat3 envMapRotation;
	#ifdef ENVMAP_TYPE_CUBE
		uniform samplerCube envMap;
	#else
		uniform sampler2D envMap;
	#endif
#endif`,Vv=`#ifdef USE_ENVMAP
	uniform float reflectivity;
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif
#endif`,$v=`#ifdef USE_ENVMAP
	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )
		#define ENV_WORLDPOS
	#endif
	#ifdef ENV_WORLDPOS
		
		varying vec3 vWorldPosition;
	#else
		varying vec3 vReflect;
		uniform float refractionRatio;
	#endif
#endif`,Xv=`#ifdef USE_ENVMAP
	#ifdef ENV_WORLDPOS
		vWorldPosition = worldPosition.xyz;
	#else
		vec3 cameraToVertex;
		if ( isOrthographic ) {
			cameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );
		} else {
			cameraToVertex = normalize( worldPosition.xyz - cameraPosition );
		}
		vec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
		#ifdef ENVMAP_MODE_REFLECTION
			vReflect = reflect( cameraToVertex, worldNormal );
		#else
			vReflect = refract( cameraToVertex, worldNormal, refractionRatio );
		#endif
	#endif
#endif`,Yv=`#ifdef USE_FOG
	vFogDepth = - mvPosition.z;
#endif`,Qv=`#ifdef USE_FOG
	varying float vFogDepth;
#endif`,jv=`#ifdef USE_FOG
	#ifdef FOG_EXP2
		float fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );
	#else
		float fogFactor = smoothstep( fogNear, fogFar, vFogDepth );
	#endif
	gl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );
#endif`,Kv=`#ifdef USE_FOG
	uniform vec3 fogColor;
	varying float vFogDepth;
	#ifdef FOG_EXP2
		uniform float fogDensity;
	#else
		uniform float fogNear;
		uniform float fogFar;
	#endif
#endif`,Zv=`#ifdef USE_GRADIENTMAP
	uniform sampler2D gradientMap;
#endif
vec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {
	float dotNL = dot( normal, lightDirection );
	vec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );
	#ifdef USE_GRADIENTMAP
		return vec3( texture2D( gradientMap, coord ).r );
	#else
		vec2 fw = fwidth( coord ) * 0.5;
		return mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );
	#endif
}`,Jv=`#ifdef USE_LIGHTMAP
	uniform sampler2D lightMap;
	uniform float lightMapIntensity;
#endif`,ex=`LambertMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularStrength = specularStrength;`,tx=`varying vec3 vViewPosition;
struct LambertMaterial {
	vec3 diffuseColor;
	float specularStrength;
};
void RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Lambert
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Lambert`,ix=`uniform bool receiveShadow;
uniform vec3 ambientLightColor;
#if defined( USE_LIGHT_PROBES )
	uniform vec3 lightProbe[ 9 ];
#endif
vec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {
	float x = normal.x, y = normal.y, z = normal.z;
	vec3 result = shCoefficients[ 0 ] * 0.886227;
	result += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;
	result += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;
	result += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;
	result += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;
	result += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;
	result += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );
	result += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;
	result += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );
	return result;
}
vec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {
	vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
	vec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );
	return irradiance;
}
vec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {
	vec3 irradiance = ambientLightColor;
	return irradiance;
}
float getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {
	float distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );
	if ( cutoffDistance > 0.0 ) {
		distanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );
	}
	return distanceFalloff;
}
float getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {
	return smoothstep( coneCosine, penumbraCosine, angleCosine );
}
#if NUM_DIR_LIGHTS > 0
	struct DirectionalLight {
		vec3 direction;
		vec3 color;
	};
	uniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];
	void getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {
		light.color = directionalLight.color;
		light.direction = directionalLight.direction;
		light.visible = true;
	}
#endif
#if NUM_POINT_LIGHTS > 0
	struct PointLight {
		vec3 position;
		vec3 color;
		float distance;
		float decay;
	};
	uniform PointLight pointLights[ NUM_POINT_LIGHTS ];
	void getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {
		vec3 lVector = pointLight.position - geometryPosition;
		light.direction = normalize( lVector );
		float lightDistance = length( lVector );
		light.color = pointLight.color;
		light.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );
		light.visible = ( light.color != vec3( 0.0 ) );
	}
#endif
#if NUM_SPOT_LIGHTS > 0
	struct SpotLight {
		vec3 position;
		vec3 direction;
		vec3 color;
		float distance;
		float decay;
		float coneCos;
		float penumbraCos;
	};
	uniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];
	void getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {
		vec3 lVector = spotLight.position - geometryPosition;
		light.direction = normalize( lVector );
		float angleCos = dot( light.direction, spotLight.direction );
		float spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );
		if ( spotAttenuation > 0.0 ) {
			float lightDistance = length( lVector );
			light.color = spotLight.color * spotAttenuation;
			light.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );
			light.visible = ( light.color != vec3( 0.0 ) );
		} else {
			light.color = vec3( 0.0 );
			light.visible = false;
		}
	}
#endif
#if NUM_RECT_AREA_LIGHTS > 0
	struct RectAreaLight {
		vec3 color;
		vec3 position;
		vec3 halfWidth;
		vec3 halfHeight;
	};
	uniform sampler2D ltc_1;	uniform sampler2D ltc_2;
	uniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];
#endif
#if NUM_HEMI_LIGHTS > 0
	struct HemisphereLight {
		vec3 direction;
		vec3 skyColor;
		vec3 groundColor;
	};
	uniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];
	vec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {
		float dotNL = dot( normal, hemiLight.direction );
		float hemiDiffuseWeight = 0.5 * dotNL + 0.5;
		vec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );
		return irradiance;
	}
#endif`,sx=`#ifdef USE_ENVMAP
	vec3 getIBLIrradiance( const in vec3 normal ) {
		#ifdef ENVMAP_TYPE_CUBE_UV
			vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );
			return PI * envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	vec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {
		#ifdef ENVMAP_TYPE_CUBE_UV
			vec3 reflectVec = reflect( - viewDir, normal );
			reflectVec = normalize( mix( reflectVec, normal, pow4( roughness ) ) );
			reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
			vec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );
			return envMapColor.rgb * envMapIntensity;
		#else
			return vec3( 0.0 );
		#endif
	}
	#ifdef USE_ANISOTROPY
		vec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {
			#ifdef ENVMAP_TYPE_CUBE_UV
				vec3 bentNormal = cross( bitangent, viewDir );
				bentNormal = normalize( cross( bentNormal, bitangent ) );
				bentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );
				return getIBLRadiance( viewDir, bentNormal, roughness );
			#else
				return vec3( 0.0 );
			#endif
		}
	#endif
#endif`,nx=`ToonMaterial material;
material.diffuseColor = diffuseColor.rgb;`,ax=`varying vec3 vViewPosition;
struct ToonMaterial {
	vec3 diffuseColor;
};
void RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	vec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
void RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_Toon
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Toon`,ox=`BlinnPhongMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.specularColor = specular;
material.specularShininess = shininess;
material.specularStrength = specularStrength;`,rx=`varying vec3 vViewPosition;
struct BlinnPhongMaterial {
	vec3 diffuseColor;
	vec3 specularColor;
	float specularShininess;
	float specularStrength;
};
void RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
	reflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;
}
void RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {
	reflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );
}
#define RE_Direct				RE_Direct_BlinnPhong
#define RE_IndirectDiffuse		RE_IndirectDiffuse_BlinnPhong`,lx=`PhysicalMaterial material;
material.diffuseColor = diffuseColor.rgb;
material.diffuseContribution = diffuseColor.rgb * ( 1.0 - metalnessFactor );
material.metalness = metalnessFactor;
vec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );
float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );
material.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;
material.roughness = min( material.roughness, 1.0 );
#ifdef IOR
	material.ior = ior;
	#ifdef USE_SPECULAR
		float specularIntensityFactor = specularIntensity;
		vec3 specularColorFactor = specularColor;
		#ifdef USE_SPECULAR_COLORMAP
			specularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;
		#endif
		#ifdef USE_SPECULAR_INTENSITYMAP
			specularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;
		#endif
		material.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );
	#else
		float specularIntensityFactor = 1.0;
		vec3 specularColorFactor = vec3( 1.0 );
		material.specularF90 = 1.0;
	#endif
	material.specularColor = min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor;
	material.specularColorBlended = mix( material.specularColor, diffuseColor.rgb, metalnessFactor );
#else
	material.specularColor = vec3( 0.04 );
	material.specularColorBlended = mix( material.specularColor, diffuseColor.rgb, metalnessFactor );
	material.specularF90 = 1.0;
#endif
#ifdef USE_CLEARCOAT
	material.clearcoat = clearcoat;
	material.clearcoatRoughness = clearcoatRoughness;
	material.clearcoatF0 = vec3( 0.04 );
	material.clearcoatF90 = 1.0;
	#ifdef USE_CLEARCOATMAP
		material.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;
	#endif
	#ifdef USE_CLEARCOAT_ROUGHNESSMAP
		material.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;
	#endif
	material.clearcoat = saturate( material.clearcoat );	material.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );
	material.clearcoatRoughness += geometryRoughness;
	material.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );
#endif
#ifdef USE_DISPERSION
	material.dispersion = dispersion;
#endif
#ifdef USE_IRIDESCENCE
	material.iridescence = iridescence;
	material.iridescenceIOR = iridescenceIOR;
	#ifdef USE_IRIDESCENCEMAP
		material.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;
	#endif
	#ifdef USE_IRIDESCENCE_THICKNESSMAP
		material.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;
	#else
		material.iridescenceThickness = iridescenceThicknessMaximum;
	#endif
#endif
#ifdef USE_SHEEN
	material.sheenColor = sheenColor;
	#ifdef USE_SHEEN_COLORMAP
		material.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;
	#endif
	material.sheenRoughness = clamp( sheenRoughness, 0.0001, 1.0 );
	#ifdef USE_SHEEN_ROUGHNESSMAP
		material.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;
	#endif
#endif
#ifdef USE_ANISOTROPY
	#ifdef USE_ANISOTROPYMAP
		mat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );
		vec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;
		vec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;
	#else
		vec2 anisotropyV = anisotropyVector;
	#endif
	material.anisotropy = length( anisotropyV );
	if( material.anisotropy == 0.0 ) {
		anisotropyV = vec2( 1.0, 0.0 );
	} else {
		anisotropyV /= material.anisotropy;
		material.anisotropy = saturate( material.anisotropy );
	}
	material.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );
	material.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;
	material.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;
#endif`,cx=`uniform sampler2D dfgLUT;
struct PhysicalMaterial {
	vec3 diffuseColor;
	vec3 diffuseContribution;
	vec3 specularColor;
	vec3 specularColorBlended;
	float roughness;
	float metalness;
	float specularF90;
	float dispersion;
	#ifdef USE_CLEARCOAT
		float clearcoat;
		float clearcoatRoughness;
		vec3 clearcoatF0;
		float clearcoatF90;
	#endif
	#ifdef USE_IRIDESCENCE
		float iridescence;
		float iridescenceIOR;
		float iridescenceThickness;
		vec3 iridescenceFresnel;
		vec3 iridescenceF0;
		vec3 iridescenceFresnelDielectric;
		vec3 iridescenceFresnelMetallic;
	#endif
	#ifdef USE_SHEEN
		vec3 sheenColor;
		float sheenRoughness;
	#endif
	#ifdef IOR
		float ior;
	#endif
	#ifdef USE_TRANSMISSION
		float transmission;
		float transmissionAlpha;
		float thickness;
		float attenuationDistance;
		vec3 attenuationColor;
	#endif
	#ifdef USE_ANISOTROPY
		float anisotropy;
		float alphaT;
		vec3 anisotropyT;
		vec3 anisotropyB;
	#endif
};
vec3 clearcoatSpecularDirect = vec3( 0.0 );
vec3 clearcoatSpecularIndirect = vec3( 0.0 );
vec3 sheenSpecularDirect = vec3( 0.0 );
vec3 sheenSpecularIndirect = vec3(0.0 );
vec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {
    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );
    float x2 = x * x;
    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );
    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );
}
float V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {
	float a2 = pow2( alpha );
	float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );
	float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );
	return 0.5 / max( gv + gl, EPSILON );
}
float D_GGX( const in float alpha, const in float dotNH ) {
	float a2 = pow2( alpha );
	float denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;
	return RECIPROCAL_PI * a2 / pow2( denom );
}
#ifdef USE_ANISOTROPY
	float V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {
		float gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );
		float gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );
		float v = 0.5 / ( gv + gl );
		return v;
	}
	float D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {
		float a2 = alphaT * alphaB;
		highp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );
		highp float v2 = dot( v, v );
		float w2 = a2 / v2;
		return RECIPROCAL_PI * a2 * pow2 ( w2 );
	}
#endif
#ifdef USE_CLEARCOAT
	vec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {
		vec3 f0 = material.clearcoatF0;
		float f90 = material.clearcoatF90;
		float roughness = material.clearcoatRoughness;
		float alpha = pow2( roughness );
		vec3 halfDir = normalize( lightDir + viewDir );
		float dotNL = saturate( dot( normal, lightDir ) );
		float dotNV = saturate( dot( normal, viewDir ) );
		float dotNH = saturate( dot( normal, halfDir ) );
		float dotVH = saturate( dot( viewDir, halfDir ) );
		vec3 F = F_Schlick( f0, f90, dotVH );
		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
		float D = D_GGX( alpha, dotNH );
		return F * ( V * D );
	}
#endif
vec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {
	vec3 f0 = material.specularColorBlended;
	float f90 = material.specularF90;
	float roughness = material.roughness;
	float alpha = pow2( roughness );
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float dotVH = saturate( dot( viewDir, halfDir ) );
	vec3 F = F_Schlick( f0, f90, dotVH );
	#ifdef USE_IRIDESCENCE
		F = mix( F, material.iridescenceFresnel, material.iridescence );
	#endif
	#ifdef USE_ANISOTROPY
		float dotTL = dot( material.anisotropyT, lightDir );
		float dotTV = dot( material.anisotropyT, viewDir );
		float dotTH = dot( material.anisotropyT, halfDir );
		float dotBL = dot( material.anisotropyB, lightDir );
		float dotBV = dot( material.anisotropyB, viewDir );
		float dotBH = dot( material.anisotropyB, halfDir );
		float V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );
		float D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );
	#else
		float V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );
		float D = D_GGX( alpha, dotNH );
	#endif
	return F * ( V * D );
}
vec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {
	const float LUT_SIZE = 64.0;
	const float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;
	const float LUT_BIAS = 0.5 / LUT_SIZE;
	float dotNV = saturate( dot( N, V ) );
	vec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );
	uv = uv * LUT_SCALE + LUT_BIAS;
	return uv;
}
float LTC_ClippedSphereFormFactor( const in vec3 f ) {
	float l = length( f );
	return max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );
}
vec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {
	float x = dot( v1, v2 );
	float y = abs( x );
	float a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;
	float b = 3.4175940 + ( 4.1616724 + y ) * y;
	float v = a / b;
	float theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;
	return cross( v1, v2 ) * theta_sintheta;
}
vec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {
	vec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];
	vec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];
	vec3 lightNormal = cross( v1, v2 );
	if( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );
	vec3 T1, T2;
	T1 = normalize( V - N * dot( V, N ) );
	T2 = - cross( N, T1 );
	mat3 mat = mInv * transpose( mat3( T1, T2, N ) );
	vec3 coords[ 4 ];
	coords[ 0 ] = mat * ( rectCoords[ 0 ] - P );
	coords[ 1 ] = mat * ( rectCoords[ 1 ] - P );
	coords[ 2 ] = mat * ( rectCoords[ 2 ] - P );
	coords[ 3 ] = mat * ( rectCoords[ 3 ] - P );
	coords[ 0 ] = normalize( coords[ 0 ] );
	coords[ 1 ] = normalize( coords[ 1 ] );
	coords[ 2 ] = normalize( coords[ 2 ] );
	coords[ 3 ] = normalize( coords[ 3 ] );
	vec3 vectorFormFactor = vec3( 0.0 );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );
	vectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );
	float result = LTC_ClippedSphereFormFactor( vectorFormFactor );
	return vec3( result );
}
#if defined( USE_SHEEN )
float D_Charlie( float roughness, float dotNH ) {
	float alpha = pow2( roughness );
	float invAlpha = 1.0 / alpha;
	float cos2h = dotNH * dotNH;
	float sin2h = max( 1.0 - cos2h, 0.0078125 );
	return ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );
}
float V_Neubelt( float dotNV, float dotNL ) {
	return saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );
}
vec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {
	vec3 halfDir = normalize( lightDir + viewDir );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	float dotNH = saturate( dot( normal, halfDir ) );
	float D = D_Charlie( sheenRoughness, dotNH );
	float V = V_Neubelt( dotNV, dotNL );
	return sheenColor * ( D * V );
}
#endif
float IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	float r2 = roughness * roughness;
	float rInv = 1.0 / ( roughness + 0.1 );
	float a = -1.9362 + 1.0678 * roughness + 0.4573 * r2 - 0.8469 * rInv;
	float b = -0.6014 + 0.5538 * roughness - 0.4670 * r2 - 0.1255 * rInv;
	float DG = exp( a * dotNV + b );
	return saturate( DG );
}
vec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {
	float dotNV = saturate( dot( normal, viewDir ) );
	vec2 fab = texture2D( dfgLUT, vec2( roughness, dotNV ) ).rg;
	return specularColor * fab.x + specularF90 * fab.y;
}
#ifdef USE_IRIDESCENCE
void computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#else
void computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {
#endif
	float dotNV = saturate( dot( normal, viewDir ) );
	vec2 fab = texture2D( dfgLUT, vec2( roughness, dotNV ) ).rg;
	#ifdef USE_IRIDESCENCE
		vec3 Fr = mix( specularColor, iridescenceF0, iridescence );
	#else
		vec3 Fr = specularColor;
	#endif
	vec3 FssEss = Fr * fab.x + specularF90 * fab.y;
	float Ess = fab.x + fab.y;
	float Ems = 1.0 - Ess;
	vec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;	vec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );
	singleScatter += FssEss;
	multiScatter += Fms * Ems;
}
vec3 BRDF_GGX_Multiscatter( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {
	vec3 singleScatter = BRDF_GGX( lightDir, viewDir, normal, material );
	float dotNL = saturate( dot( normal, lightDir ) );
	float dotNV = saturate( dot( normal, viewDir ) );
	vec2 dfgV = texture2D( dfgLUT, vec2( material.roughness, dotNV ) ).rg;
	vec2 dfgL = texture2D( dfgLUT, vec2( material.roughness, dotNL ) ).rg;
	vec3 FssEss_V = material.specularColorBlended * dfgV.x + material.specularF90 * dfgV.y;
	vec3 FssEss_L = material.specularColorBlended * dfgL.x + material.specularF90 * dfgL.y;
	float Ess_V = dfgV.x + dfgV.y;
	float Ess_L = dfgL.x + dfgL.y;
	float Ems_V = 1.0 - Ess_V;
	float Ems_L = 1.0 - Ess_L;
	vec3 Favg = material.specularColorBlended + ( 1.0 - material.specularColorBlended ) * 0.047619;
	vec3 Fms = FssEss_V * FssEss_L * Favg / ( 1.0 - Ems_V * Ems_L * Favg + EPSILON );
	float compensationFactor = Ems_V * Ems_L;
	vec3 multiScatter = Fms * compensationFactor;
	return singleScatter + multiScatter;
}
#if NUM_RECT_AREA_LIGHTS > 0
	void RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
		vec3 normal = geometryNormal;
		vec3 viewDir = geometryViewDir;
		vec3 position = geometryPosition;
		vec3 lightPos = rectAreaLight.position;
		vec3 halfWidth = rectAreaLight.halfWidth;
		vec3 halfHeight = rectAreaLight.halfHeight;
		vec3 lightColor = rectAreaLight.color;
		float roughness = material.roughness;
		vec3 rectCoords[ 4 ];
		rectCoords[ 0 ] = lightPos + halfWidth - halfHeight;		rectCoords[ 1 ] = lightPos - halfWidth - halfHeight;
		rectCoords[ 2 ] = lightPos - halfWidth + halfHeight;
		rectCoords[ 3 ] = lightPos + halfWidth + halfHeight;
		vec2 uv = LTC_Uv( normal, viewDir, roughness );
		vec4 t1 = texture2D( ltc_1, uv );
		vec4 t2 = texture2D( ltc_2, uv );
		mat3 mInv = mat3(
			vec3( t1.x, 0, t1.y ),
			vec3(    0, 1,    0 ),
			vec3( t1.z, 0, t1.w )
		);
		vec3 fresnel = ( material.specularColorBlended * t2.x + ( vec3( 1.0 ) - material.specularColorBlended ) * t2.y );
		reflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );
		reflectedLight.directDiffuse += lightColor * material.diffuseContribution * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );
	}
#endif
void RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	float dotNL = saturate( dot( geometryNormal, directLight.direction ) );
	vec3 irradiance = dotNL * directLight.color;
	#ifdef USE_CLEARCOAT
		float dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );
		vec3 ccIrradiance = dotNLcc * directLight.color;
		clearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );
	#endif
	#ifdef USE_SHEEN
 
 		sheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );
 
 		float sheenAlbedoV = IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );
 		float sheenAlbedoL = IBLSheenBRDF( geometryNormal, directLight.direction, material.sheenRoughness );
 
 		float sheenEnergyComp = 1.0 - max3( material.sheenColor ) * max( sheenAlbedoV, sheenAlbedoL );
 
 		irradiance *= sheenEnergyComp;
 
 	#endif
	reflectedLight.directSpecular += irradiance * BRDF_GGX_Multiscatter( directLight.direction, geometryViewDir, geometryNormal, material );
	reflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseContribution );
}
void RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {
	vec3 diffuse = irradiance * BRDF_Lambert( material.diffuseContribution );
	#ifdef USE_SHEEN
		float sheenAlbedo = IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );
		float sheenEnergyComp = 1.0 - max3( material.sheenColor ) * sheenAlbedo;
		diffuse *= sheenEnergyComp;
	#endif
	reflectedLight.indirectDiffuse += diffuse;
}
void RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {
	#ifdef USE_CLEARCOAT
		clearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );
	#endif
	#ifdef USE_SHEEN
		sheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness ) * RECIPROCAL_PI;
 	#endif
	vec3 singleScatteringDielectric = vec3( 0.0 );
	vec3 multiScatteringDielectric = vec3( 0.0 );
	vec3 singleScatteringMetallic = vec3( 0.0 );
	vec3 multiScatteringMetallic = vec3( 0.0 );
	#ifdef USE_IRIDESCENCE
		computeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnelDielectric, material.roughness, singleScatteringDielectric, multiScatteringDielectric );
		computeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.diffuseColor, material.specularF90, material.iridescence, material.iridescenceFresnelMetallic, material.roughness, singleScatteringMetallic, multiScatteringMetallic );
	#else
		computeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScatteringDielectric, multiScatteringDielectric );
		computeMultiscattering( geometryNormal, geometryViewDir, material.diffuseColor, material.specularF90, material.roughness, singleScatteringMetallic, multiScatteringMetallic );
	#endif
	vec3 singleScattering = mix( singleScatteringDielectric, singleScatteringMetallic, material.metalness );
	vec3 multiScattering = mix( multiScatteringDielectric, multiScatteringMetallic, material.metalness );
	vec3 totalScatteringDielectric = singleScatteringDielectric + multiScatteringDielectric;
	vec3 diffuse = material.diffuseContribution * ( 1.0 - totalScatteringDielectric );
	vec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;
	vec3 indirectSpecular = radiance * singleScattering;
	indirectSpecular += multiScattering * cosineWeightedIrradiance;
	vec3 indirectDiffuse = diffuse * cosineWeightedIrradiance;
	#ifdef USE_SHEEN
		float sheenAlbedo = IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );
		float sheenEnergyComp = 1.0 - max3( material.sheenColor ) * sheenAlbedo;
		indirectSpecular *= sheenEnergyComp;
		indirectDiffuse *= sheenEnergyComp;
	#endif
	reflectedLight.indirectSpecular += indirectSpecular;
	reflectedLight.indirectDiffuse += indirectDiffuse;
}
#define RE_Direct				RE_Direct_Physical
#define RE_Direct_RectArea		RE_Direct_RectArea_Physical
#define RE_IndirectDiffuse		RE_IndirectDiffuse_Physical
#define RE_IndirectSpecular		RE_IndirectSpecular_Physical
float computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {
	return saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );
}`,hx=`
vec3 geometryPosition = - vViewPosition;
vec3 geometryNormal = normal;
vec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );
vec3 geometryClearcoatNormal = vec3( 0.0 );
#ifdef USE_CLEARCOAT
	geometryClearcoatNormal = clearcoatNormal;
#endif
#ifdef USE_IRIDESCENCE
	float dotNVi = saturate( dot( normal, geometryViewDir ) );
	if ( material.iridescenceThickness == 0.0 ) {
		material.iridescence = 0.0;
	} else {
		material.iridescence = saturate( material.iridescence );
	}
	if ( material.iridescence > 0.0 ) {
		material.iridescenceFresnelDielectric = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );
		material.iridescenceFresnelMetallic = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.diffuseColor );
		material.iridescenceFresnel = mix( material.iridescenceFresnelDielectric, material.iridescenceFresnelMetallic, material.metalness );
		material.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );
	}
#endif
IncidentLight directLight;
#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )
	PointLight pointLight;
	#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0
	PointLightShadow pointLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {
		pointLight = pointLights[ i ];
		getPointLightInfo( pointLight, geometryPosition, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS ) && ( defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_BASIC ) )
		pointLightShadow = pointLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )
	SpotLight spotLight;
	vec4 spotColor;
	vec3 spotLightCoord;
	bool inSpotLightMap;
	#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {
		spotLight = spotLights[ i ];
		getSpotLightInfo( spotLight, geometryPosition, directLight );
		#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX
		#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS
		#else
		#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )
		#endif
		#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )
			spotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;
			inSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );
			spotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );
			directLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;
		#endif
		#undef SPOT_LIGHT_MAP_INDEX
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
		spotLightShadow = spotLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )
	DirectionalLight directionalLight;
	#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLightShadow;
	#endif
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {
		directionalLight = directionalLights[ i ];
		getDirectionalLightInfo( directionalLight, directLight );
		#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )
		directionalLightShadow = directionalLightShadows[ i ];
		directLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
		#endif
		RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )
	RectAreaLight rectAreaLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {
		rectAreaLight = rectAreaLights[ i ];
		RE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
	}
	#pragma unroll_loop_end
#endif
#if defined( RE_IndirectDiffuse )
	vec3 iblIrradiance = vec3( 0.0 );
	vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );
	#if defined( USE_LIGHT_PROBES )
		irradiance += getLightProbeIrradiance( lightProbe, geometryNormal );
	#endif
	#if ( NUM_HEMI_LIGHTS > 0 )
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {
			irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );
		}
		#pragma unroll_loop_end
	#endif
#endif
#if defined( RE_IndirectSpecular )
	vec3 radiance = vec3( 0.0 );
	vec3 clearcoatRadiance = vec3( 0.0 );
#endif`,dx=`#if defined( RE_IndirectDiffuse )
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		vec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;
		irradiance += lightMapIrradiance;
	#endif
	#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )
		iblIrradiance += getIBLIrradiance( geometryNormal );
	#endif
#endif
#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )
	#ifdef USE_ANISOTROPY
		radiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );
	#else
		radiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );
	#endif
	#ifdef USE_CLEARCOAT
		clearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );
	#endif
#endif`,ux=`#if defined( RE_IndirectDiffuse )
	RE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
#endif
#if defined( RE_IndirectSpecular )
	RE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );
#endif`,px=`#if defined( USE_LOGARITHMIC_DEPTH_BUFFER )
	gl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;
#endif`,fx=`#if defined( USE_LOGARITHMIC_DEPTH_BUFFER )
	uniform float logDepthBufFC;
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,mx=`#ifdef USE_LOGARITHMIC_DEPTH_BUFFER
	varying float vFragDepth;
	varying float vIsPerspective;
#endif`,gx=`#ifdef USE_LOGARITHMIC_DEPTH_BUFFER
	vFragDepth = 1.0 + gl_Position.w;
	vIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );
#endif`,yx=`#ifdef USE_MAP
	vec4 sampledDiffuseColor = texture2D( map, vMapUv );
	#ifdef DECODE_VIDEO_TEXTURE
		sampledDiffuseColor = sRGBTransferEOTF( sampledDiffuseColor );
	#endif
	diffuseColor *= sampledDiffuseColor;
#endif`,vx=`#ifdef USE_MAP
	uniform sampler2D map;
#endif`,xx=`#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
	#if defined( USE_POINTS_UV )
		vec2 uv = vUv;
	#else
		vec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;
	#endif
#endif
#ifdef USE_MAP
	diffuseColor *= texture2D( map, uv );
#endif
#ifdef USE_ALPHAMAP
	diffuseColor.a *= texture2D( alphaMap, uv ).g;
#endif`,bx=`#if defined( USE_POINTS_UV )
	varying vec2 vUv;
#else
	#if defined( USE_MAP ) || defined( USE_ALPHAMAP )
		uniform mat3 uvTransform;
	#endif
#endif
#ifdef USE_MAP
	uniform sampler2D map;
#endif
#ifdef USE_ALPHAMAP
	uniform sampler2D alphaMap;
#endif`,wx=`float metalnessFactor = metalness;
#ifdef USE_METALNESSMAP
	vec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );
	metalnessFactor *= texelMetalness.b;
#endif`,_x=`#ifdef USE_METALNESSMAP
	uniform sampler2D metalnessMap;
#endif`,Mx=`#ifdef USE_INSTANCING_MORPH
	float morphTargetInfluences[ MORPHTARGETS_COUNT ];
	float morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		morphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;
	}
#endif`,Sx=`#if defined( USE_MORPHCOLORS )
	vColor *= morphTargetBaseInfluence;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		#if defined( USE_COLOR_ALPHA )
			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];
		#elif defined( USE_COLOR )
			if ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];
		#endif
	}
#endif`,Tx=`#ifdef USE_MORPHNORMALS
	objectNormal *= morphTargetBaseInfluence;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		if ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];
	}
#endif`,Ex=`#ifdef USE_MORPHTARGETS
	#ifndef USE_INSTANCING_MORPH
		uniform float morphTargetBaseInfluence;
		uniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];
	#endif
	uniform sampler2DArray morphTargetsTexture;
	uniform ivec2 morphTargetsTextureSize;
	vec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {
		int texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;
		int y = texelIndex / morphTargetsTextureSize.x;
		int x = texelIndex - y * morphTargetsTextureSize.x;
		ivec3 morphUV = ivec3( x, y, morphTargetIndex );
		return texelFetch( morphTargetsTexture, morphUV, 0 );
	}
#endif`,Cx=`#ifdef USE_MORPHTARGETS
	transformed *= morphTargetBaseInfluence;
	for ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {
		if ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];
	}
#endif`,Ax=`float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;
#ifdef FLAT_SHADED
	vec3 fdx = dFdx( vViewPosition );
	vec3 fdy = dFdy( vViewPosition );
	vec3 normal = normalize( cross( fdx, fdy ) );
#else
	vec3 normal = normalize( vNormal );
	#ifdef DOUBLE_SIDED
		normal *= faceDirection;
	#endif
#endif
#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )
	#ifdef USE_TANGENT
		mat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );
	#else
		mat3 tbn = getTangentFrame( - vViewPosition, normal,
		#if defined( USE_NORMALMAP )
			vNormalMapUv
		#elif defined( USE_CLEARCOAT_NORMALMAP )
			vClearcoatNormalMapUv
		#else
			vUv
		#endif
		);
	#endif
	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )
		tbn[0] *= faceDirection;
		tbn[1] *= faceDirection;
	#endif
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	#ifdef USE_TANGENT
		mat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );
	#else
		mat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );
	#endif
	#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )
		tbn2[0] *= faceDirection;
		tbn2[1] *= faceDirection;
	#endif
#endif
vec3 nonPerturbedNormal = normal;`,Rx=`#ifdef USE_NORMALMAP_OBJECTSPACE
	normal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;
	#ifdef FLIP_SIDED
		normal = - normal;
	#endif
	#ifdef DOUBLE_SIDED
		normal = normal * faceDirection;
	#endif
	normal = normalize( normalMatrix * normal );
#elif defined( USE_NORMALMAP_TANGENTSPACE )
	vec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;
	mapN.xy *= normalScale;
	normal = normalize( tbn * mapN );
#elif defined( USE_BUMPMAP )
	normal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );
#endif`,Ix=`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,kx=`#ifndef FLAT_SHADED
	varying vec3 vNormal;
	#ifdef USE_TANGENT
		varying vec3 vTangent;
		varying vec3 vBitangent;
	#endif
#endif`,Px=`#ifndef FLAT_SHADED
	vNormal = normalize( transformedNormal );
	#ifdef USE_TANGENT
		vTangent = normalize( transformedTangent );
		vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
	#endif
#endif`,Dx=`#ifdef USE_NORMALMAP
	uniform sampler2D normalMap;
	uniform vec2 normalScale;
#endif
#ifdef USE_NORMALMAP_OBJECTSPACE
	uniform mat3 normalMatrix;
#endif
#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )
	mat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {
		vec3 q0 = dFdx( eye_pos.xyz );
		vec3 q1 = dFdy( eye_pos.xyz );
		vec2 st0 = dFdx( uv.st );
		vec2 st1 = dFdy( uv.st );
		vec3 N = surf_norm;
		vec3 q1perp = cross( q1, N );
		vec3 q0perp = cross( N, q0 );
		vec3 T = q1perp * st0.x + q0perp * st1.x;
		vec3 B = q1perp * st0.y + q0perp * st1.y;
		float det = max( dot( T, T ), dot( B, B ) );
		float scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );
		return mat3( T * scale, B * scale, N );
	}
#endif`,Lx=`#ifdef USE_CLEARCOAT
	vec3 clearcoatNormal = nonPerturbedNormal;
#endif`,Ox=`#ifdef USE_CLEARCOAT_NORMALMAP
	vec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;
	clearcoatMapN.xy *= clearcoatNormalScale;
	clearcoatNormal = normalize( tbn2 * clearcoatMapN );
#endif`,Nx=`#ifdef USE_CLEARCOATMAP
	uniform sampler2D clearcoatMap;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform sampler2D clearcoatNormalMap;
	uniform vec2 clearcoatNormalScale;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform sampler2D clearcoatRoughnessMap;
#endif`,Bx=`#ifdef USE_IRIDESCENCEMAP
	uniform sampler2D iridescenceMap;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	uniform sampler2D iridescenceThicknessMap;
#endif`,zx=`#ifdef OPAQUE
diffuseColor.a = 1.0;
#endif
#ifdef USE_TRANSMISSION
diffuseColor.a *= material.transmissionAlpha;
#endif
gl_FragColor = vec4( outgoingLight, diffuseColor.a );`,Fx=`vec3 packNormalToRGB( const in vec3 normal ) {
	return normalize( normal ) * 0.5 + 0.5;
}
vec3 unpackRGBToNormal( const in vec3 rgb ) {
	return 2.0 * rgb.xyz - 1.0;
}
const float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;const float ShiftRight8 = 1. / 256.;
const float Inv255 = 1. / 255.;
const vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );
const vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );
const vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );
const vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );
vec4 packDepthToRGBA( const in float v ) {
	if( v <= 0.0 )
		return vec4( 0., 0., 0., 0. );
	if( v >= 1.0 )
		return vec4( 1., 1., 1., 1. );
	float vuf;
	float af = modf( v * PackFactors.a, vuf );
	float bf = modf( vuf * ShiftRight8, vuf );
	float gf = modf( vuf * ShiftRight8, vuf );
	return vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );
}
vec3 packDepthToRGB( const in float v ) {
	if( v <= 0.0 )
		return vec3( 0., 0., 0. );
	if( v >= 1.0 )
		return vec3( 1., 1., 1. );
	float vuf;
	float bf = modf( v * PackFactors.b, vuf );
	float gf = modf( vuf * ShiftRight8, vuf );
	return vec3( vuf * Inv255, gf * PackUpscale, bf );
}
vec2 packDepthToRG( const in float v ) {
	if( v <= 0.0 )
		return vec2( 0., 0. );
	if( v >= 1.0 )
		return vec2( 1., 1. );
	float vuf;
	float gf = modf( v * 256., vuf );
	return vec2( vuf * Inv255, gf );
}
float unpackRGBAToDepth( const in vec4 v ) {
	return dot( v, UnpackFactors4 );
}
float unpackRGBToDepth( const in vec3 v ) {
	return dot( v, UnpackFactors3 );
}
float unpackRGToDepth( const in vec2 v ) {
	return v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;
}
vec4 pack2HalfToRGBA( const in vec2 v ) {
	vec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );
	return vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );
}
vec2 unpackRGBATo2Half( const in vec4 v ) {
	return vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );
}
float viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {
	return ( viewZ + near ) / ( near - far );
}
float orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {
	return depth * ( near - far ) - near;
}
float viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {
	return ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );
}
float perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {
	return ( near * far ) / ( ( far - near ) * depth - far );
}`,Ux=`#ifdef PREMULTIPLIED_ALPHA
	gl_FragColor.rgb *= gl_FragColor.a;
#endif`,Gx=`vec4 mvPosition = vec4( transformed, 1.0 );
#ifdef USE_BATCHING
	mvPosition = batchingMatrix * mvPosition;
#endif
#ifdef USE_INSTANCING
	mvPosition = instanceMatrix * mvPosition;
#endif
mvPosition = modelViewMatrix * mvPosition;
gl_Position = projectionMatrix * mvPosition;`,Hx=`#ifdef DITHERING
	gl_FragColor.rgb = dithering( gl_FragColor.rgb );
#endif`,qx=`#ifdef DITHERING
	vec3 dithering( vec3 color ) {
		float grid_position = rand( gl_FragCoord.xy );
		vec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );
		dither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );
		return color + dither_shift_RGB;
	}
#endif`,Wx=`float roughnessFactor = roughness;
#ifdef USE_ROUGHNESSMAP
	vec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );
	roughnessFactor *= texelRoughness.g;
#endif`,Vx=`#ifdef USE_ROUGHNESSMAP
	uniform sampler2D roughnessMap;
#endif`,$x=`#if NUM_SPOT_LIGHT_COORDS > 0
	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];
#endif
#if NUM_SPOT_LIGHT_MAPS > 0
	uniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];
#endif
#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		#if defined( SHADOWMAP_TYPE_PCF )
			uniform sampler2DShadow directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		#else
			uniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];
		#endif
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		#if defined( SHADOWMAP_TYPE_PCF )
			uniform sampler2DShadow spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];
		#else
			uniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];
		#endif
		struct SpotLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		#if defined( SHADOWMAP_TYPE_PCF )
			uniform samplerCubeShadow pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		#elif defined( SHADOWMAP_TYPE_BASIC )
			uniform samplerCube pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];
		#endif
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
	#if defined( SHADOWMAP_TYPE_PCF )
		float interleavedGradientNoise( vec2 position ) {
			return fract( 52.9829189 * fract( dot( position, vec2( 0.06711056, 0.00583715 ) ) ) );
		}
		vec2 vogelDiskSample( int sampleIndex, int samplesCount, float phi ) {
			const float goldenAngle = 2.399963229728653;
			float r = sqrt( ( float( sampleIndex ) + 0.5 ) / float( samplesCount ) );
			float theta = float( sampleIndex ) * goldenAngle + phi;
			return vec2( cos( theta ), sin( theta ) ) * r;
		}
	#endif
	#if defined( SHADOWMAP_TYPE_PCF )
		float getShadow( sampler2DShadow shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
			float shadow = 1.0;
			shadowCoord.xyz /= shadowCoord.w;
			shadowCoord.z += shadowBias;
			bool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;
			bool frustumTest = inFrustum && shadowCoord.z <= 1.0;
			if ( frustumTest ) {
				vec2 texelSize = vec2( 1.0 ) / shadowMapSize;
				float radius = shadowRadius * texelSize.x;
				float phi = interleavedGradientNoise( gl_FragCoord.xy ) * 6.28318530718;
				shadow = (
					texture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 0, 5, phi ) * radius, shadowCoord.z ) ) +
					texture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 1, 5, phi ) * radius, shadowCoord.z ) ) +
					texture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 2, 5, phi ) * radius, shadowCoord.z ) ) +
					texture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 3, 5, phi ) * radius, shadowCoord.z ) ) +
					texture( shadowMap, vec3( shadowCoord.xy + vogelDiskSample( 4, 5, phi ) * radius, shadowCoord.z ) )
				) * 0.2;
			}
			return mix( 1.0, shadow, shadowIntensity );
		}
	#elif defined( SHADOWMAP_TYPE_VSM )
		float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
			float shadow = 1.0;
			shadowCoord.xyz /= shadowCoord.w;
			shadowCoord.z += shadowBias;
			bool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;
			bool frustumTest = inFrustum && shadowCoord.z <= 1.0;
			if ( frustumTest ) {
				vec2 distribution = texture2D( shadowMap, shadowCoord.xy ).rg;
				float mean = distribution.x;
				float variance = distribution.y * distribution.y;
				#ifdef USE_REVERSED_DEPTH_BUFFER
					float hard_shadow = step( mean, shadowCoord.z );
				#else
					float hard_shadow = step( shadowCoord.z, mean );
				#endif
				if ( hard_shadow == 1.0 ) {
					shadow = 1.0;
				} else {
					variance = max( variance, 0.0000001 );
					float d = shadowCoord.z - mean;
					float p_max = variance / ( variance + d * d );
					p_max = clamp( ( p_max - 0.3 ) / 0.65, 0.0, 1.0 );
					shadow = max( hard_shadow, p_max );
				}
			}
			return mix( 1.0, shadow, shadowIntensity );
		}
	#else
		float getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {
			float shadow = 1.0;
			shadowCoord.xyz /= shadowCoord.w;
			shadowCoord.z += shadowBias;
			bool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;
			bool frustumTest = inFrustum && shadowCoord.z <= 1.0;
			if ( frustumTest ) {
				float depth = texture2D( shadowMap, shadowCoord.xy ).r;
				#ifdef USE_REVERSED_DEPTH_BUFFER
					shadow = step( depth, shadowCoord.z );
				#else
					shadow = step( shadowCoord.z, depth );
				#endif
			}
			return mix( 1.0, shadow, shadowIntensity );
		}
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
	#if defined( SHADOWMAP_TYPE_PCF )
	float getPointShadow( samplerCubeShadow shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {
		float shadow = 1.0;
		vec3 lightToPosition = shadowCoord.xyz;
		vec3 bd3D = normalize( lightToPosition );
		vec3 absVec = abs( lightToPosition );
		float viewSpaceZ = max( max( absVec.x, absVec.y ), absVec.z );
		if ( viewSpaceZ - shadowCameraFar <= 0.0 && viewSpaceZ - shadowCameraNear >= 0.0 ) {
			float dp = ( shadowCameraFar * ( viewSpaceZ - shadowCameraNear ) ) / ( viewSpaceZ * ( shadowCameraFar - shadowCameraNear ) );
			dp += shadowBias;
			float texelSize = shadowRadius / shadowMapSize.x;
			vec3 absDir = abs( bd3D );
			vec3 tangent = absDir.x > absDir.z ? vec3( 0.0, 1.0, 0.0 ) : vec3( 1.0, 0.0, 0.0 );
			tangent = normalize( cross( bd3D, tangent ) );
			vec3 bitangent = cross( bd3D, tangent );
			float phi = interleavedGradientNoise( gl_FragCoord.xy ) * 6.28318530718;
			shadow = (
				texture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 0, 5, phi ).x + bitangent * vogelDiskSample( 0, 5, phi ).y ) * texelSize, dp ) ) +
				texture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 1, 5, phi ).x + bitangent * vogelDiskSample( 1, 5, phi ).y ) * texelSize, dp ) ) +
				texture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 2, 5, phi ).x + bitangent * vogelDiskSample( 2, 5, phi ).y ) * texelSize, dp ) ) +
				texture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 3, 5, phi ).x + bitangent * vogelDiskSample( 3, 5, phi ).y ) * texelSize, dp ) ) +
				texture( shadowMap, vec4( bd3D + ( tangent * vogelDiskSample( 4, 5, phi ).x + bitangent * vogelDiskSample( 4, 5, phi ).y ) * texelSize, dp ) )
			) * 0.2;
		}
		return mix( 1.0, shadow, shadowIntensity );
	}
	#elif defined( SHADOWMAP_TYPE_BASIC )
	float getPointShadow( samplerCube shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {
		float shadow = 1.0;
		vec3 lightToPosition = shadowCoord.xyz;
		vec3 bd3D = normalize( lightToPosition );
		vec3 absVec = abs( lightToPosition );
		float viewSpaceZ = max( max( absVec.x, absVec.y ), absVec.z );
		if ( viewSpaceZ - shadowCameraFar <= 0.0 && viewSpaceZ - shadowCameraNear >= 0.0 ) {
			float dp = ( shadowCameraFar * ( viewSpaceZ - shadowCameraNear ) ) / ( viewSpaceZ * ( shadowCameraFar - shadowCameraNear ) );
			dp += shadowBias;
			float depth = textureCube( shadowMap, bd3D ).r;
			#ifdef USE_REVERSED_DEPTH_BUFFER
				shadow = step( depth, dp );
			#else
				shadow = step( dp, depth );
			#endif
		}
		return mix( 1.0, shadow, shadowIntensity );
	}
	#endif
	#endif
#endif`,Xx=`#if NUM_SPOT_LIGHT_COORDS > 0
	uniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];
	varying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];
#endif
#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
		uniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];
		varying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];
		struct DirectionalLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
		struct SpotLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
		};
		uniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		uniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];
		varying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];
		struct PointLightShadow {
			float shadowIntensity;
			float shadowBias;
			float shadowNormalBias;
			float shadowRadius;
			vec2 shadowMapSize;
			float shadowCameraNear;
			float shadowCameraFar;
		};
		uniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];
	#endif
#endif`,Yx=`#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )
	vec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );
	vec4 shadowWorldPosition;
#endif
#if defined( USE_SHADOWMAP )
	#if NUM_DIR_LIGHT_SHADOWS > 0
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );
			vDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;
		}
		#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0
		#pragma unroll_loop_start
		for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
			shadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );
			vPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;
		}
		#pragma unroll_loop_end
	#endif
#endif
#if NUM_SPOT_LIGHT_COORDS > 0
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {
		shadowWorldPosition = worldPosition;
		#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )
			shadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;
		#endif
		vSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;
	}
	#pragma unroll_loop_end
#endif`,Qx=`float getShadowMask() {
	float shadow = 1.0;
	#ifdef USE_SHADOWMAP
	#if NUM_DIR_LIGHT_SHADOWS > 0
	DirectionalLightShadow directionalLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {
		directionalLight = directionalLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_SPOT_LIGHT_SHADOWS > 0
	SpotLightShadow spotLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {
		spotLight = spotLightShadows[ i ];
		shadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#if NUM_POINT_LIGHT_SHADOWS > 0 && ( defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_BASIC ) )
	PointLightShadow pointLight;
	#pragma unroll_loop_start
	for ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {
		pointLight = pointLightShadows[ i ];
		shadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;
	}
	#pragma unroll_loop_end
	#endif
	#endif
	return shadow;
}`,jx=`#ifdef USE_SKINNING
	mat4 boneMatX = getBoneMatrix( skinIndex.x );
	mat4 boneMatY = getBoneMatrix( skinIndex.y );
	mat4 boneMatZ = getBoneMatrix( skinIndex.z );
	mat4 boneMatW = getBoneMatrix( skinIndex.w );
#endif`,Kx=`#ifdef USE_SKINNING
	uniform mat4 bindMatrix;
	uniform mat4 bindMatrixInverse;
	uniform highp sampler2D boneTexture;
	mat4 getBoneMatrix( const in float i ) {
		int size = textureSize( boneTexture, 0 ).x;
		int j = int( i ) * 4;
		int x = j % size;
		int y = j / size;
		vec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );
		vec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );
		vec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );
		vec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );
		return mat4( v1, v2, v3, v4 );
	}
#endif`,Zx=`#ifdef USE_SKINNING
	vec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );
	vec4 skinned = vec4( 0.0 );
	skinned += boneMatX * skinVertex * skinWeight.x;
	skinned += boneMatY * skinVertex * skinWeight.y;
	skinned += boneMatZ * skinVertex * skinWeight.z;
	skinned += boneMatW * skinVertex * skinWeight.w;
	transformed = ( bindMatrixInverse * skinned ).xyz;
#endif`,Jx=`#ifdef USE_SKINNING
	mat4 skinMatrix = mat4( 0.0 );
	skinMatrix += skinWeight.x * boneMatX;
	skinMatrix += skinWeight.y * boneMatY;
	skinMatrix += skinWeight.z * boneMatZ;
	skinMatrix += skinWeight.w * boneMatW;
	skinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;
	objectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;
	#ifdef USE_TANGENT
		objectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;
	#endif
#endif`,eb=`float specularStrength;
#ifdef USE_SPECULARMAP
	vec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );
	specularStrength = texelSpecular.r;
#else
	specularStrength = 1.0;
#endif`,tb=`#ifdef USE_SPECULARMAP
	uniform sampler2D specularMap;
#endif`,ib=`#if defined( TONE_MAPPING )
	gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );
#endif`,sb=`#ifndef saturate
#define saturate( a ) clamp( a, 0.0, 1.0 )
#endif
uniform float toneMappingExposure;
vec3 LinearToneMapping( vec3 color ) {
	return saturate( toneMappingExposure * color );
}
vec3 ReinhardToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	return saturate( color / ( vec3( 1.0 ) + color ) );
}
vec3 CineonToneMapping( vec3 color ) {
	color *= toneMappingExposure;
	color = max( vec3( 0.0 ), color - 0.004 );
	return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );
}
vec3 RRTAndODTFit( vec3 v ) {
	vec3 a = v * ( v + 0.0245786 ) - 0.000090537;
	vec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;
	return a / b;
}
vec3 ACESFilmicToneMapping( vec3 color ) {
	const mat3 ACESInputMat = mat3(
		vec3( 0.59719, 0.07600, 0.02840 ),		vec3( 0.35458, 0.90834, 0.13383 ),
		vec3( 0.04823, 0.01566, 0.83777 )
	);
	const mat3 ACESOutputMat = mat3(
		vec3(  1.60475, -0.10208, -0.00327 ),		vec3( -0.53108,  1.10813, -0.07276 ),
		vec3( -0.07367, -0.00605,  1.07602 )
	);
	color *= toneMappingExposure / 0.6;
	color = ACESInputMat * color;
	color = RRTAndODTFit( color );
	color = ACESOutputMat * color;
	return saturate( color );
}
const mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(
	vec3( 1.6605, - 0.1246, - 0.0182 ),
	vec3( - 0.5876, 1.1329, - 0.1006 ),
	vec3( - 0.0728, - 0.0083, 1.1187 )
);
const mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(
	vec3( 0.6274, 0.0691, 0.0164 ),
	vec3( 0.3293, 0.9195, 0.0880 ),
	vec3( 0.0433, 0.0113, 0.8956 )
);
vec3 agxDefaultContrastApprox( vec3 x ) {
	vec3 x2 = x * x;
	vec3 x4 = x2 * x2;
	return + 15.5 * x4 * x2
		- 40.14 * x4 * x
		+ 31.96 * x4
		- 6.868 * x2 * x
		+ 0.4298 * x2
		+ 0.1191 * x
		- 0.00232;
}
vec3 AgXToneMapping( vec3 color ) {
	const mat3 AgXInsetMatrix = mat3(
		vec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),
		vec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),
		vec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )
	);
	const mat3 AgXOutsetMatrix = mat3(
		vec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),
		vec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),
		vec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )
	);
	const float AgxMinEv = - 12.47393;	const float AgxMaxEv = 4.026069;
	color *= toneMappingExposure;
	color = LINEAR_SRGB_TO_LINEAR_REC2020 * color;
	color = AgXInsetMatrix * color;
	color = max( color, 1e-10 );	color = log2( color );
	color = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );
	color = clamp( color, 0.0, 1.0 );
	color = agxDefaultContrastApprox( color );
	color = AgXOutsetMatrix * color;
	color = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );
	color = LINEAR_REC2020_TO_LINEAR_SRGB * color;
	color = clamp( color, 0.0, 1.0 );
	return color;
}
vec3 NeutralToneMapping( vec3 color ) {
	const float StartCompression = 0.8 - 0.04;
	const float Desaturation = 0.15;
	color *= toneMappingExposure;
	float x = min( color.r, min( color.g, color.b ) );
	float offset = x < 0.08 ? x - 6.25 * x * x : 0.04;
	color -= offset;
	float peak = max( color.r, max( color.g, color.b ) );
	if ( peak < StartCompression ) return color;
	float d = 1. - StartCompression;
	float newPeak = 1. - d * d / ( peak + d - StartCompression );
	color *= newPeak / peak;
	float g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );
	return mix( color, vec3( newPeak ), g );
}
vec3 CustomToneMapping( vec3 color ) { return color; }`,nb=`#ifdef USE_TRANSMISSION
	material.transmission = transmission;
	material.transmissionAlpha = 1.0;
	material.thickness = thickness;
	material.attenuationDistance = attenuationDistance;
	material.attenuationColor = attenuationColor;
	#ifdef USE_TRANSMISSIONMAP
		material.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;
	#endif
	#ifdef USE_THICKNESSMAP
		material.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;
	#endif
	vec3 pos = vWorldPosition;
	vec3 v = normalize( cameraPosition - pos );
	vec3 n = inverseTransformDirection( normal, viewMatrix );
	vec4 transmitted = getIBLVolumeRefraction(
		n, v, material.roughness, material.diffuseContribution, material.specularColorBlended, material.specularF90,
		pos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,
		material.attenuationColor, material.attenuationDistance );
	material.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );
	totalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );
#endif`,ab=`#ifdef USE_TRANSMISSION
	uniform float transmission;
	uniform float thickness;
	uniform float attenuationDistance;
	uniform vec3 attenuationColor;
	#ifdef USE_TRANSMISSIONMAP
		uniform sampler2D transmissionMap;
	#endif
	#ifdef USE_THICKNESSMAP
		uniform sampler2D thicknessMap;
	#endif
	uniform vec2 transmissionSamplerSize;
	uniform sampler2D transmissionSamplerMap;
	uniform mat4 modelMatrix;
	uniform mat4 projectionMatrix;
	varying vec3 vWorldPosition;
	float w0( float a ) {
		return ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );
	}
	float w1( float a ) {
		return ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );
	}
	float w2( float a ){
		return ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );
	}
	float w3( float a ) {
		return ( 1.0 / 6.0 ) * ( a * a * a );
	}
	float g0( float a ) {
		return w0( a ) + w1( a );
	}
	float g1( float a ) {
		return w2( a ) + w3( a );
	}
	float h0( float a ) {
		return - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );
	}
	float h1( float a ) {
		return 1.0 + w3( a ) / ( w2( a ) + w3( a ) );
	}
	vec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {
		uv = uv * texelSize.zw + 0.5;
		vec2 iuv = floor( uv );
		vec2 fuv = fract( uv );
		float g0x = g0( fuv.x );
		float g1x = g1( fuv.x );
		float h0x = h0( fuv.x );
		float h1x = h1( fuv.x );
		float h0y = h0( fuv.y );
		float h1y = h1( fuv.y );
		vec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;
		vec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;
		vec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;
		return g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +
			g1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );
	}
	vec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {
		vec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );
		vec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );
		vec2 fLodSizeInv = 1.0 / fLodSize;
		vec2 cLodSizeInv = 1.0 / cLodSize;
		vec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );
		vec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );
		return mix( fSample, cSample, fract( lod ) );
	}
	vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {
		vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
		vec3 modelScale;
		modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
		modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
		modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
		return normalize( refractionVector ) * thickness * modelScale;
	}
	float applyIorToRoughness( const in float roughness, const in float ior ) {
		return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
	}
	vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {
		float lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );
		return textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );
	}
	vec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {
		if ( isinf( attenuationDistance ) ) {
			return vec3( 1.0 );
		} else {
			vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
			vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );			return transmittance;
		}
	}
	vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,
		const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,
		const in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,
		const in vec3 attenuationColor, const in float attenuationDistance ) {
		vec4 transmittedLight;
		vec3 transmittance;
		#ifdef USE_DISPERSION
			float halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;
			vec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );
			for ( int i = 0; i < 3; i ++ ) {
				vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );
				vec3 refractedRayExit = position + transmissionRay;
				vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
				vec2 refractionCoords = ndcPos.xy / ndcPos.w;
				refractionCoords += 1.0;
				refractionCoords /= 2.0;
				vec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );
				transmittedLight[ i ] = transmissionSample[ i ];
				transmittedLight.a += transmissionSample.a;
				transmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];
			}
			transmittedLight.a /= 3.0;
		#else
			vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
			vec3 refractedRayExit = position + transmissionRay;
			vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
			vec2 refractionCoords = ndcPos.xy / ndcPos.w;
			refractionCoords += 1.0;
			refractionCoords /= 2.0;
			transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
			transmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );
		#endif
		vec3 attenuatedColor = transmittance * transmittedLight.rgb;
		vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
		float transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;
		return vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );
	}
#endif`,ob=`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	varying vec2 vUv;
#endif
#ifdef USE_MAP
	varying vec2 vMapUv;
#endif
#ifdef USE_ALPHAMAP
	varying vec2 vAlphaMapUv;
#endif
#ifdef USE_LIGHTMAP
	varying vec2 vLightMapUv;
#endif
#ifdef USE_AOMAP
	varying vec2 vAoMapUv;
#endif
#ifdef USE_BUMPMAP
	varying vec2 vBumpMapUv;
#endif
#ifdef USE_NORMALMAP
	varying vec2 vNormalMapUv;
#endif
#ifdef USE_EMISSIVEMAP
	varying vec2 vEmissiveMapUv;
#endif
#ifdef USE_METALNESSMAP
	varying vec2 vMetalnessMapUv;
#endif
#ifdef USE_ROUGHNESSMAP
	varying vec2 vRoughnessMapUv;
#endif
#ifdef USE_ANISOTROPYMAP
	varying vec2 vAnisotropyMapUv;
#endif
#ifdef USE_CLEARCOATMAP
	varying vec2 vClearcoatMapUv;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	varying vec2 vClearcoatNormalMapUv;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	varying vec2 vClearcoatRoughnessMapUv;
#endif
#ifdef USE_IRIDESCENCEMAP
	varying vec2 vIridescenceMapUv;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	varying vec2 vIridescenceThicknessMapUv;
#endif
#ifdef USE_SHEEN_COLORMAP
	varying vec2 vSheenColorMapUv;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	varying vec2 vSheenRoughnessMapUv;
#endif
#ifdef USE_SPECULARMAP
	varying vec2 vSpecularMapUv;
#endif
#ifdef USE_SPECULAR_COLORMAP
	varying vec2 vSpecularColorMapUv;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	varying vec2 vSpecularIntensityMapUv;
#endif
#ifdef USE_TRANSMISSIONMAP
	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;
#endif
#ifdef USE_THICKNESSMAP
	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;
#endif`,rb=`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	varying vec2 vUv;
#endif
#ifdef USE_MAP
	uniform mat3 mapTransform;
	varying vec2 vMapUv;
#endif
#ifdef USE_ALPHAMAP
	uniform mat3 alphaMapTransform;
	varying vec2 vAlphaMapUv;
#endif
#ifdef USE_LIGHTMAP
	uniform mat3 lightMapTransform;
	varying vec2 vLightMapUv;
#endif
#ifdef USE_AOMAP
	uniform mat3 aoMapTransform;
	varying vec2 vAoMapUv;
#endif
#ifdef USE_BUMPMAP
	uniform mat3 bumpMapTransform;
	varying vec2 vBumpMapUv;
#endif
#ifdef USE_NORMALMAP
	uniform mat3 normalMapTransform;
	varying vec2 vNormalMapUv;
#endif
#ifdef USE_DISPLACEMENTMAP
	uniform mat3 displacementMapTransform;
	varying vec2 vDisplacementMapUv;
#endif
#ifdef USE_EMISSIVEMAP
	uniform mat3 emissiveMapTransform;
	varying vec2 vEmissiveMapUv;
#endif
#ifdef USE_METALNESSMAP
	uniform mat3 metalnessMapTransform;
	varying vec2 vMetalnessMapUv;
#endif
#ifdef USE_ROUGHNESSMAP
	uniform mat3 roughnessMapTransform;
	varying vec2 vRoughnessMapUv;
#endif
#ifdef USE_ANISOTROPYMAP
	uniform mat3 anisotropyMapTransform;
	varying vec2 vAnisotropyMapUv;
#endif
#ifdef USE_CLEARCOATMAP
	uniform mat3 clearcoatMapTransform;
	varying vec2 vClearcoatMapUv;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	uniform mat3 clearcoatNormalMapTransform;
	varying vec2 vClearcoatNormalMapUv;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	uniform mat3 clearcoatRoughnessMapTransform;
	varying vec2 vClearcoatRoughnessMapUv;
#endif
#ifdef USE_SHEEN_COLORMAP
	uniform mat3 sheenColorMapTransform;
	varying vec2 vSheenColorMapUv;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	uniform mat3 sheenRoughnessMapTransform;
	varying vec2 vSheenRoughnessMapUv;
#endif
#ifdef USE_IRIDESCENCEMAP
	uniform mat3 iridescenceMapTransform;
	varying vec2 vIridescenceMapUv;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	uniform mat3 iridescenceThicknessMapTransform;
	varying vec2 vIridescenceThicknessMapUv;
#endif
#ifdef USE_SPECULARMAP
	uniform mat3 specularMapTransform;
	varying vec2 vSpecularMapUv;
#endif
#ifdef USE_SPECULAR_COLORMAP
	uniform mat3 specularColorMapTransform;
	varying vec2 vSpecularColorMapUv;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	uniform mat3 specularIntensityMapTransform;
	varying vec2 vSpecularIntensityMapUv;
#endif
#ifdef USE_TRANSMISSIONMAP
	uniform mat3 transmissionMapTransform;
	varying vec2 vTransmissionMapUv;
#endif
#ifdef USE_THICKNESSMAP
	uniform mat3 thicknessMapTransform;
	varying vec2 vThicknessMapUv;
#endif`,lb=`#if defined( USE_UV ) || defined( USE_ANISOTROPY )
	vUv = vec3( uv, 1 ).xy;
#endif
#ifdef USE_MAP
	vMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ALPHAMAP
	vAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_LIGHTMAP
	vLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_AOMAP
	vAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_BUMPMAP
	vBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_NORMALMAP
	vNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_DISPLACEMENTMAP
	vDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_EMISSIVEMAP
	vEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_METALNESSMAP
	vMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ROUGHNESSMAP
	vRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_ANISOTROPYMAP
	vAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOATMAP
	vClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOAT_NORMALMAP
	vClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP
	vClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_IRIDESCENCEMAP
	vIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP
	vIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SHEEN_COLORMAP
	vSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SHEEN_ROUGHNESSMAP
	vSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULARMAP
	vSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULAR_COLORMAP
	vSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_SPECULAR_INTENSITYMAP
	vSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_TRANSMISSIONMAP
	vTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;
#endif
#ifdef USE_THICKNESSMAP
	vThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;
#endif`,cb=`#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0
	vec4 worldPosition = vec4( transformed, 1.0 );
	#ifdef USE_BATCHING
		worldPosition = batchingMatrix * worldPosition;
	#endif
	#ifdef USE_INSTANCING
		worldPosition = instanceMatrix * worldPosition;
	#endif
	worldPosition = modelMatrix * worldPosition;
#endif`;const hb=`varying vec2 vUv;
uniform mat3 uvTransform;
void main() {
	vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	gl_Position = vec4( position.xy, 1.0, 1.0 );
}`,db=`uniform sampler2D t2D;
uniform float backgroundIntensity;
varying vec2 vUv;
void main() {
	vec4 texColor = texture2D( t2D, vUv );
	#ifdef DECODE_VIDEO_TEXTURE
		texColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );
	#endif
	texColor.rgb *= backgroundIntensity;
	gl_FragColor = texColor;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,ub=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,pb=`#ifdef ENVMAP_TYPE_CUBE
	uniform samplerCube envMap;
#elif defined( ENVMAP_TYPE_CUBE_UV )
	uniform sampler2D envMap;
#endif
uniform float flipEnvMap;
uniform float backgroundBlurriness;
uniform float backgroundIntensity;
uniform mat3 backgroundRotation;
varying vec3 vWorldDirection;
#include <cube_uv_reflection_fragment>
void main() {
	#ifdef ENVMAP_TYPE_CUBE
		vec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );
	#elif defined( ENVMAP_TYPE_CUBE_UV )
		vec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );
	#else
		vec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );
	#endif
	texColor.rgb *= backgroundIntensity;
	gl_FragColor = texColor;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,fb=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
	gl_Position.z = gl_Position.w;
}`,mb=`uniform samplerCube tCube;
uniform float tFlip;
uniform float opacity;
varying vec3 vWorldDirection;
void main() {
	vec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );
	gl_FragColor = texColor;
	gl_FragColor.a *= opacity;
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,gb=`#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
varying vec2 vHighPrecisionZW;
void main() {
	#include <uv_vertex>
	#include <batching_vertex>
	#include <skinbase_vertex>
	#include <morphinstance_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vHighPrecisionZW = gl_Position.zw;
}`,yb=`#if DEPTH_PACKING == 3200
	uniform float opacity;
#endif
#include <common>
#include <packing>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
varying vec2 vHighPrecisionZW;
void main() {
	vec4 diffuseColor = vec4( 1.0 );
	#include <clipping_planes_fragment>
	#if DEPTH_PACKING == 3200
		diffuseColor.a = opacity;
	#endif
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <logdepthbuf_fragment>
	#ifdef USE_REVERSED_DEPTH_BUFFER
		float fragCoordZ = vHighPrecisionZW[ 0 ] / vHighPrecisionZW[ 1 ];
	#else
		float fragCoordZ = 0.5 * vHighPrecisionZW[ 0 ] / vHighPrecisionZW[ 1 ] + 0.5;
	#endif
	#if DEPTH_PACKING == 3200
		gl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );
	#elif DEPTH_PACKING == 3201
		gl_FragColor = packDepthToRGBA( fragCoordZ );
	#elif DEPTH_PACKING == 3202
		gl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );
	#elif DEPTH_PACKING == 3203
		gl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );
	#endif
}`,vb=`#define DISTANCE
varying vec3 vWorldPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <batching_vertex>
	#include <skinbase_vertex>
	#include <morphinstance_vertex>
	#ifdef USE_DISPLACEMENTMAP
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <worldpos_vertex>
	#include <clipping_planes_vertex>
	vWorldPosition = worldPosition.xyz;
}`,xb=`#define DISTANCE
uniform vec3 referencePosition;
uniform float nearDistance;
uniform float farDistance;
varying vec3 vWorldPosition;
#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <clipping_planes_pars_fragment>
void main () {
	vec4 diffuseColor = vec4( 1.0 );
	#include <clipping_planes_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	float dist = length( vWorldPosition - referencePosition );
	dist = ( dist - nearDistance ) / ( farDistance - nearDistance );
	dist = saturate( dist );
	gl_FragColor = vec4( dist, 0.0, 0.0, 1.0 );
}`,bb=`varying vec3 vWorldDirection;
#include <common>
void main() {
	vWorldDirection = transformDirection( position, modelMatrix );
	#include <begin_vertex>
	#include <project_vertex>
}`,wb=`uniform sampler2D tEquirect;
varying vec3 vWorldDirection;
#include <common>
void main() {
	vec3 direction = normalize( vWorldDirection );
	vec2 sampleUV = equirectUv( direction );
	gl_FragColor = texture2D( tEquirect, sampleUV );
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
}`,_b=`uniform float scale;
attribute float lineDistance;
varying float vLineDistance;
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	vLineDistance = scale * lineDistance;
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,Mb=`uniform vec3 diffuse;
uniform float opacity;
uniform float dashSize;
uniform float totalSize;
varying float vLineDistance;
#include <common>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	if ( mod( vLineDistance, totalSize ) > dashSize ) {
		discard;
	}
	vec3 outgoingLight = vec3( 0.0 );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,Sb=`#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>
	#endif
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <fog_vertex>
}`,Tb=`uniform vec3 diffuse;
uniform float opacity;
#ifndef FLAT_SHADED
	varying vec3 vNormal;
#endif
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	#ifdef USE_LIGHTMAP
		vec4 lightMapTexel = texture2D( lightMap, vLightMapUv );
		reflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;
	#else
		reflectedLight.indirectDiffuse += vec3( 1.0 );
	#endif
	#include <aomap_fragment>
	reflectedLight.indirectDiffuse *= diffuseColor.rgb;
	vec3 outgoingLight = reflectedLight.indirectDiffuse;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Eb=`#define LAMBERT
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,Cb=`#define LAMBERT
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_lambert_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_lambert_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Ab=`#define MATCAP
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <displacementmap_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
	vViewPosition = - mvPosition.xyz;
}`,Rb=`#define MATCAP
uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D matcap;
varying vec3 vViewPosition;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	vec3 viewDir = normalize( vViewPosition );
	vec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );
	vec3 y = cross( viewDir, x );
	vec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;
	#ifdef USE_MATCAP
		vec4 matcapColor = texture2D( matcap, uv );
	#else
		vec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );
	#endif
	vec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Ib=`#define NORMAL
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	varying vec3 vViewPosition;
#endif
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphinstance_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	vViewPosition = - mvPosition.xyz;
#endif
}`,kb=`#define NORMAL
uniform float opacity;
#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )
	varying vec3 vViewPosition;
#endif
#include <uv_pars_fragment>
#include <normal_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );
	#include <clipping_planes_fragment>
	#include <logdepthbuf_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	gl_FragColor = vec4( normalize( normal ) * 0.5 + 0.5, diffuseColor.a );
	#ifdef OPAQUE
		gl_FragColor.a = 1.0;
	#endif
}`,Pb=`#define PHONG
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <envmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphinstance_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <envmap_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,Db=`#define PHONG
uniform vec3 diffuse;
uniform vec3 emissive;
uniform vec3 specular;
uniform float shininess;
uniform float opacity;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_phong_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <specularmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <specularmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_phong_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
	#include <envmap_fragment>
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Lb=`#define STANDARD
varying vec3 vViewPosition;
#ifdef USE_TRANSMISSION
	varying vec3 vWorldPosition;
#endif
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
#ifdef USE_TRANSMISSION
	vWorldPosition = worldPosition.xyz;
#endif
}`,Ob=`#define STANDARD
#ifdef PHYSICAL
	#define IOR
	#define USE_SPECULAR
#endif
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;
#ifdef IOR
	uniform float ior;
#endif
#ifdef USE_SPECULAR
	uniform float specularIntensity;
	uniform vec3 specularColor;
	#ifdef USE_SPECULAR_COLORMAP
		uniform sampler2D specularColorMap;
	#endif
	#ifdef USE_SPECULAR_INTENSITYMAP
		uniform sampler2D specularIntensityMap;
	#endif
#endif
#ifdef USE_CLEARCOAT
	uniform float clearcoat;
	uniform float clearcoatRoughness;
#endif
#ifdef USE_DISPERSION
	uniform float dispersion;
#endif
#ifdef USE_IRIDESCENCE
	uniform float iridescence;
	uniform float iridescenceIOR;
	uniform float iridescenceThicknessMinimum;
	uniform float iridescenceThicknessMaximum;
#endif
#ifdef USE_SHEEN
	uniform vec3 sheenColor;
	uniform float sheenRoughness;
	#ifdef USE_SHEEN_COLORMAP
		uniform sampler2D sheenColorMap;
	#endif
	#ifdef USE_SHEEN_ROUGHNESSMAP
		uniform sampler2D sheenRoughnessMap;
	#endif
#endif
#ifdef USE_ANISOTROPY
	uniform vec2 anisotropyVector;
	#ifdef USE_ANISOTROPYMAP
		uniform sampler2D anisotropyMap;
	#endif
#endif
varying vec3 vViewPosition;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <iridescence_fragment>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_physical_pars_fragment>
#include <transmission_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <iridescence_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <roughnessmap_fragment>
	#include <metalnessmap_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <clearcoat_normal_fragment_begin>
	#include <clearcoat_normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_physical_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
	vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;
	#include <transmission_fragment>
	vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
	#ifdef USE_SHEEN
 
		outgoingLight = outgoingLight + sheenSpecularDirect + sheenSpecularIndirect;
 
 	#endif
	#ifdef USE_CLEARCOAT
		float dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );
		vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );
		outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;
	#endif
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,Nb=`#define TOON
varying vec3 vViewPosition;
#include <common>
#include <batching_pars_vertex>
#include <uv_pars_vertex>
#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	vViewPosition = - mvPosition.xyz;
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,Bb=`#define TOON
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float opacity;
#include <common>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <gradientmap_pars_fragment>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_toon_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
	vec3 totalEmissiveRadiance = emissive;
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <color_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	#include <normal_fragment_begin>
	#include <normal_fragment_maps>
	#include <emissivemap_fragment>
	#include <lights_toon_fragment>
	#include <lights_fragment_begin>
	#include <lights_fragment_maps>
	#include <lights_fragment_end>
	#include <aomap_fragment>
	vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
	#include <dithering_fragment>
}`,zb=`uniform float size;
uniform float scale;
#include <common>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
#ifdef USE_POINTS_UV
	varying vec2 vUv;
	uniform mat3 uvTransform;
#endif
void main() {
	#ifdef USE_POINTS_UV
		vUv = ( uvTransform * vec3( uv, 1 ) ).xy;
	#endif
	#include <color_vertex>
	#include <morphinstance_vertex>
	#include <morphcolor_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <project_vertex>
	gl_PointSize = size;
	#ifdef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );
	#endif
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <worldpos_vertex>
	#include <fog_vertex>
}`,Fb=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <color_pars_fragment>
#include <map_particle_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	#include <logdepthbuf_fragment>
	#include <map_particle_fragment>
	#include <color_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
	#include <premultiplied_alpha_fragment>
}`,Ub=`#include <common>
#include <batching_pars_vertex>
#include <fog_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <shadowmap_pars_vertex>
void main() {
	#include <batching_vertex>
	#include <beginnormal_vertex>
	#include <morphinstance_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>
	#include <defaultnormal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <project_vertex>
	#include <logdepthbuf_vertex>
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
}`,Gb=`uniform vec3 color;
uniform float opacity;
#include <common>
#include <fog_pars_fragment>
#include <bsdfs>
#include <lights_pars_begin>
#include <logdepthbuf_pars_fragment>
#include <shadowmap_pars_fragment>
#include <shadowmask_pars_fragment>
void main() {
	#include <logdepthbuf_fragment>
	gl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
}`,Hb=`uniform float rotation;
uniform vec2 center;
#include <common>
#include <uv_pars_vertex>
#include <fog_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>
void main() {
	#include <uv_vertex>
	vec4 mvPosition = modelViewMatrix[ 3 ];
	vec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );
	#ifndef USE_SIZEATTENUATION
		bool isPerspective = isPerspectiveMatrix( projectionMatrix );
		if ( isPerspective ) scale *= - mvPosition.z;
	#endif
	vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;
	vec2 rotatedPosition;
	rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
	rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
	mvPosition.xy += rotatedPosition;
	gl_Position = projectionMatrix * mvPosition;
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	#include <fog_vertex>
}`,qb=`uniform vec3 diffuse;
uniform float opacity;
#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <alphahash_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
void main() {
	vec4 diffuseColor = vec4( diffuse, opacity );
	#include <clipping_planes_fragment>
	vec3 outgoingLight = vec3( 0.0 );
	#include <logdepthbuf_fragment>
	#include <map_fragment>
	#include <alphamap_fragment>
	#include <alphatest_fragment>
	#include <alphahash_fragment>
	outgoingLight = diffuseColor.rgb;
	#include <opaque_fragment>
	#include <tonemapping_fragment>
	#include <colorspace_fragment>
	#include <fog_fragment>
}`,xt={alphahash_fragment:dv,alphahash_pars_fragment:uv,alphamap_fragment:pv,alphamap_pars_fragment:fv,alphatest_fragment:mv,alphatest_pars_fragment:gv,aomap_fragment:yv,aomap_pars_fragment:vv,batching_pars_vertex:xv,batching_vertex:bv,begin_vertex:wv,beginnormal_vertex:_v,bsdfs:Mv,iridescence_fragment:Sv,bumpmap_pars_fragment:Tv,clipping_planes_fragment:Ev,clipping_planes_pars_fragment:Cv,clipping_planes_pars_vertex:Av,clipping_planes_vertex:Rv,color_fragment:Iv,color_pars_fragment:kv,color_pars_vertex:Pv,color_vertex:Dv,common:Lv,cube_uv_reflection_fragment:Ov,defaultnormal_vertex:Nv,displacementmap_pars_vertex:Bv,displacementmap_vertex:zv,emissivemap_fragment:Fv,emissivemap_pars_fragment:Uv,colorspace_fragment:Gv,colorspace_pars_fragment:Hv,envmap_fragment:qv,envmap_common_pars_fragment:Wv,envmap_pars_fragment:Vv,envmap_pars_vertex:$v,envmap_physical_pars_fragment:sx,envmap_vertex:Xv,fog_vertex:Yv,fog_pars_vertex:Qv,fog_fragment:jv,fog_pars_fragment:Kv,gradientmap_pars_fragment:Zv,lightmap_pars_fragment:Jv,lights_lambert_fragment:ex,lights_lambert_pars_fragment:tx,lights_pars_begin:ix,lights_toon_fragment:nx,lights_toon_pars_fragment:ax,lights_phong_fragment:ox,lights_phong_pars_fragment:rx,lights_physical_fragment:lx,lights_physical_pars_fragment:cx,lights_fragment_begin:hx,lights_fragment_maps:dx,lights_fragment_end:ux,logdepthbuf_fragment:px,logdepthbuf_pars_fragment:fx,logdepthbuf_pars_vertex:mx,logdepthbuf_vertex:gx,map_fragment:yx,map_pars_fragment:vx,map_particle_fragment:xx,map_particle_pars_fragment:bx,metalnessmap_fragment:wx,metalnessmap_pars_fragment:_x,morphinstance_vertex:Mx,morphcolor_vertex:Sx,morphnormal_vertex:Tx,morphtarget_pars_vertex:Ex,morphtarget_vertex:Cx,normal_fragment_begin:Ax,normal_fragment_maps:Rx,normal_pars_fragment:Ix,normal_pars_vertex:kx,normal_vertex:Px,normalmap_pars_fragment:Dx,clearcoat_normal_fragment_begin:Lx,clearcoat_normal_fragment_maps:Ox,clearcoat_pars_fragment:Nx,iridescence_pars_fragment:Bx,opaque_fragment:zx,packing:Fx,premultiplied_alpha_fragment:Ux,project_vertex:Gx,dithering_fragment:Hx,dithering_pars_fragment:qx,roughnessmap_fragment:Wx,roughnessmap_pars_fragment:Vx,shadowmap_pars_fragment:$x,shadowmap_pars_vertex:Xx,shadowmap_vertex:Yx,shadowmask_pars_fragment:Qx,skinbase_vertex:jx,skinning_pars_vertex:Kx,skinning_vertex:Zx,skinnormal_vertex:Jx,specularmap_fragment:eb,specularmap_pars_fragment:tb,tonemapping_fragment:ib,tonemapping_pars_fragment:sb,transmission_fragment:nb,transmission_pars_fragment:ab,uv_pars_fragment:ob,uv_pars_vertex:rb,uv_vertex:lb,worldpos_vertex:cb,background_vert:hb,background_frag:db,backgroundCube_vert:ub,backgroundCube_frag:pb,cube_vert:fb,cube_frag:mb,depth_vert:gb,depth_frag:yb,distance_vert:vb,distance_frag:xb,equirect_vert:bb,equirect_frag:wb,linedashed_vert:_b,linedashed_frag:Mb,meshbasic_vert:Sb,meshbasic_frag:Tb,meshlambert_vert:Eb,meshlambert_frag:Cb,meshmatcap_vert:Ab,meshmatcap_frag:Rb,meshnormal_vert:Ib,meshnormal_frag:kb,meshphong_vert:Pb,meshphong_frag:Db,meshphysical_vert:Lb,meshphysical_frag:Ob,meshtoon_vert:Nb,meshtoon_frag:Bb,points_vert:zb,points_frag:Fb,shadow_vert:Ub,shadow_frag:Gb,sprite_vert:Hb,sprite_frag:qb},Ce={common:{diffuse:{value:new H(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new yt},alphaMap:{value:null},alphaMapTransform:{value:new yt},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new yt}},envmap:{envMap:{value:null},envMapRotation:{value:new yt},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98},dfgLUT:{value:null}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new yt}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new yt}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new yt},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new yt},normalScale:{value:new le(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new yt},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new yt}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new yt}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new yt}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new H(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new H(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new yt},alphaTest:{value:0},uvTransform:{value:new yt}},sprite:{diffuse:{value:new H(16777215)},opacity:{value:1},center:{value:new le(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new yt},alphaMap:{value:null},alphaMapTransform:{value:new yt},alphaTest:{value:0}}},Bs={basic:{uniforms:Hi([Ce.common,Ce.specularmap,Ce.envmap,Ce.aomap,Ce.lightmap,Ce.fog]),vertexShader:xt.meshbasic_vert,fragmentShader:xt.meshbasic_frag},lambert:{uniforms:Hi([Ce.common,Ce.specularmap,Ce.envmap,Ce.aomap,Ce.lightmap,Ce.emissivemap,Ce.bumpmap,Ce.normalmap,Ce.displacementmap,Ce.fog,Ce.lights,{emissive:{value:new H(0)}}]),vertexShader:xt.meshlambert_vert,fragmentShader:xt.meshlambert_frag},phong:{uniforms:Hi([Ce.common,Ce.specularmap,Ce.envmap,Ce.aomap,Ce.lightmap,Ce.emissivemap,Ce.bumpmap,Ce.normalmap,Ce.displacementmap,Ce.fog,Ce.lights,{emissive:{value:new H(0)},specular:{value:new H(1118481)},shininess:{value:30}}]),vertexShader:xt.meshphong_vert,fragmentShader:xt.meshphong_frag},standard:{uniforms:Hi([Ce.common,Ce.envmap,Ce.aomap,Ce.lightmap,Ce.emissivemap,Ce.bumpmap,Ce.normalmap,Ce.displacementmap,Ce.roughnessmap,Ce.metalnessmap,Ce.fog,Ce.lights,{emissive:{value:new H(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:xt.meshphysical_vert,fragmentShader:xt.meshphysical_frag},toon:{uniforms:Hi([Ce.common,Ce.aomap,Ce.lightmap,Ce.emissivemap,Ce.bumpmap,Ce.normalmap,Ce.displacementmap,Ce.gradientmap,Ce.fog,Ce.lights,{emissive:{value:new H(0)}}]),vertexShader:xt.meshtoon_vert,fragmentShader:xt.meshtoon_frag},matcap:{uniforms:Hi([Ce.common,Ce.bumpmap,Ce.normalmap,Ce.displacementmap,Ce.fog,{matcap:{value:null}}]),vertexShader:xt.meshmatcap_vert,fragmentShader:xt.meshmatcap_frag},points:{uniforms:Hi([Ce.points,Ce.fog]),vertexShader:xt.points_vert,fragmentShader:xt.points_frag},dashed:{uniforms:Hi([Ce.common,Ce.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:xt.linedashed_vert,fragmentShader:xt.linedashed_frag},depth:{uniforms:Hi([Ce.common,Ce.displacementmap]),vertexShader:xt.depth_vert,fragmentShader:xt.depth_frag},normal:{uniforms:Hi([Ce.common,Ce.bumpmap,Ce.normalmap,Ce.displacementmap,{opacity:{value:1}}]),vertexShader:xt.meshnormal_vert,fragmentShader:xt.meshnormal_frag},sprite:{uniforms:Hi([Ce.sprite,Ce.fog]),vertexShader:xt.sprite_vert,fragmentShader:xt.sprite_frag},background:{uniforms:{uvTransform:{value:new yt},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:xt.background_vert,fragmentShader:xt.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new yt}},vertexShader:xt.backgroundCube_vert,fragmentShader:xt.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:xt.cube_vert,fragmentShader:xt.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:xt.equirect_vert,fragmentShader:xt.equirect_frag},distance:{uniforms:Hi([Ce.common,Ce.displacementmap,{referencePosition:{value:new T},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:xt.distance_vert,fragmentShader:xt.distance_frag},shadow:{uniforms:Hi([Ce.lights,Ce.fog,{color:{value:new H(0)},opacity:{value:1}}]),vertexShader:xt.shadow_vert,fragmentShader:xt.shadow_frag}};Bs.physical={uniforms:Hi([Bs.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new yt},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new yt},clearcoatNormalScale:{value:new le(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new yt},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new yt},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new yt},sheen:{value:0},sheenColor:{value:new H(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new yt},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new yt},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new yt},transmissionSamplerSize:{value:new le},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new yt},attenuationDistance:{value:0},attenuationColor:{value:new H(0)},specularColor:{value:new H(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new yt},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new yt},anisotropyVector:{value:new le},anisotropyMap:{value:null},anisotropyMapTransform:{value:new yt}}]),vertexShader:xt.meshphysical_vert,fragmentShader:xt.meshphysical_frag};const jr={r:0,b:0,g:0},qn=new nt,Wb=new ut;function Vb(l,e,t,i,s,n,a){const o=new H(0);let r=n===!0?0:1,c,h,d=null,u=0,p=null;function f(v){let b=v.isScene===!0?v.background:null;return b&&b.isTexture&&(b=(v.backgroundBlurriness>0?t:e).get(b)),b}function y(v){let b=!1;const _=f(v);_===null?g(o,r):_&&_.isColor&&(g(_,1),b=!0);const S=l.xr.getEnvironmentBlendMode();S==="additive"?i.buffers.color.setClear(0,0,0,1,a):S==="alpha-blend"&&i.buffers.color.setClear(0,0,0,0,a),(l.autoClear||b)&&(i.buffers.depth.setTest(!0),i.buffers.depth.setMask(!0),i.buffers.color.setMask(!0),l.clear(l.autoClearColor,l.autoClearDepth,l.autoClearStencil))}function m(v,b){const _=f(b);_&&(_.isCubeTexture||_.mapping===ql)?(h===void 0&&(h=new w(new ie(1,1,1),new Ci({name:"BackgroundCubeMaterial",uniforms:Ya(Bs.backgroundCube.uniforms),vertexShader:Bs.backgroundCube.vertexShader,fragmentShader:Bs.backgroundCube.fragmentShader,side:wi,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),h.geometry.deleteAttribute("normal"),h.geometry.deleteAttribute("uv"),h.onBeforeRender=function(S,A,R){this.matrixWorld.copyPosition(R.matrixWorld)},Object.defineProperty(h.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),s.update(h)),qn.copy(b.backgroundRotation),qn.x*=-1,qn.y*=-1,qn.z*=-1,_.isCubeTexture&&_.isRenderTargetTexture===!1&&(qn.y*=-1,qn.z*=-1),h.material.uniforms.envMap.value=_,h.material.uniforms.flipEnvMap.value=_.isCubeTexture&&_.isRenderTargetTexture===!1?-1:1,h.material.uniforms.backgroundBlurriness.value=b.backgroundBlurriness,h.material.uniforms.backgroundIntensity.value=b.backgroundIntensity,h.material.uniforms.backgroundRotation.value.setFromMatrix4(Wb.makeRotationFromEuler(qn)),h.material.toneMapped=Rt.getTransfer(_.colorSpace)!==Gt,(d!==_||u!==_.version||p!==l.toneMapping)&&(h.material.needsUpdate=!0,d=_,u=_.version,p=l.toneMapping),h.layers.enableAll(),v.unshift(h,h.geometry,h.material,0,0,null)):_&&_.isTexture&&(c===void 0&&(c=new w(new Dt(2,2),new Ci({name:"BackgroundMaterial",uniforms:Ya(Bs.background.uniforms),vertexShader:Bs.background.vertexShader,fragmentShader:Bs.background.fragmentShader,side:Xs,depthTest:!1,depthWrite:!1,fog:!1,allowOverride:!1})),c.geometry.deleteAttribute("normal"),Object.defineProperty(c.material,"map",{get:function(){return this.uniforms.t2D.value}}),s.update(c)),c.material.uniforms.t2D.value=_,c.material.uniforms.backgroundIntensity.value=b.backgroundIntensity,c.material.toneMapped=Rt.getTransfer(_.colorSpace)!==Gt,_.matrixAutoUpdate===!0&&_.updateMatrix(),c.material.uniforms.uvTransform.value.copy(_.matrix),(d!==_||u!==_.version||p!==l.toneMapping)&&(c.material.needsUpdate=!0,d=_,u=_.version,p=l.toneMapping),c.layers.enableAll(),v.unshift(c,c.geometry,c.material,0,0,null))}function g(v,b){v.getRGB(jr,hm(l)),i.buffers.color.setClear(jr.r,jr.g,jr.b,b,a)}function x(){h!==void 0&&(h.geometry.dispose(),h.material.dispose(),h=void 0),c!==void 0&&(c.geometry.dispose(),c.material.dispose(),c=void 0)}return{getClearColor:function(){return o},setClearColor:function(v,b=1){o.set(v),r=b,g(o,r)},getClearAlpha:function(){return r},setClearAlpha:function(v){r=v,g(o,r)},render:y,addToRenderList:m,dispose:x}}function $b(l,e){const t=l.getParameter(l.MAX_VERTEX_ATTRIBS),i={},s=u(null);let n=s,a=!1;function o(C,k,L,O,W){let U=!1;const $=d(O,L,k);n!==$&&(n=$,c(n.object)),U=p(C,O,L,W),U&&f(C,O,L,W),W!==null&&e.update(W,l.ELEMENT_ARRAY_BUFFER),(U||a)&&(a=!1,b(C,k,L,O),W!==null&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,e.get(W).buffer))}function r(){return l.createVertexArray()}function c(C){return l.bindVertexArray(C)}function h(C){return l.deleteVertexArray(C)}function d(C,k,L){const O=L.wireframe===!0;let W=i[C.id];W===void 0&&(W={},i[C.id]=W);let U=W[k.id];U===void 0&&(U={},W[k.id]=U);let $=U[O];return $===void 0&&($=u(r()),U[O]=$),$}function u(C){const k=[],L=[],O=[];for(let W=0;W<t;W++)k[W]=0,L[W]=0,O[W]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:k,enabledAttributes:L,attributeDivisors:O,object:C,attributes:{},index:null}}function p(C,k,L,O){const W=n.attributes,U=k.attributes;let $=0;const G=L.getAttributes();for(const ee in G)if(G[ee].location>=0){const me=W[ee];let ve=U[ee];if(ve===void 0&&(ee==="instanceMatrix"&&C.instanceMatrix&&(ve=C.instanceMatrix),ee==="instanceColor"&&C.instanceColor&&(ve=C.instanceColor)),me===void 0||me.attribute!==ve||ve&&me.data!==ve.data)return!0;$++}return n.attributesNum!==$||n.index!==O}function f(C,k,L,O){const W={},U=k.attributes;let $=0;const G=L.getAttributes();for(const ee in G)if(G[ee].location>=0){let me=U[ee];me===void 0&&(ee==="instanceMatrix"&&C.instanceMatrix&&(me=C.instanceMatrix),ee==="instanceColor"&&C.instanceColor&&(me=C.instanceColor));const ve={};ve.attribute=me,me&&me.data&&(ve.data=me.data),W[ee]=ve,$++}n.attributes=W,n.attributesNum=$,n.index=O}function y(){const C=n.newAttributes;for(let k=0,L=C.length;k<L;k++)C[k]=0}function m(C){g(C,0)}function g(C,k){const L=n.newAttributes,O=n.enabledAttributes,W=n.attributeDivisors;L[C]=1,O[C]===0&&(l.enableVertexAttribArray(C),O[C]=1),W[C]!==k&&(l.vertexAttribDivisor(C,k),W[C]=k)}function x(){const C=n.newAttributes,k=n.enabledAttributes;for(let L=0,O=k.length;L<O;L++)k[L]!==C[L]&&(l.disableVertexAttribArray(L),k[L]=0)}function v(C,k,L,O,W,U,$){$===!0?l.vertexAttribIPointer(C,k,L,W,U):l.vertexAttribPointer(C,k,L,O,W,U)}function b(C,k,L,O){y();const W=O.attributes,U=L.getAttributes(),$=k.defaultAttributeValues;for(const G in U){const ee=U[G];if(ee.location>=0){let pe=W[G];if(pe===void 0&&(G==="instanceMatrix"&&C.instanceMatrix&&(pe=C.instanceMatrix),G==="instanceColor"&&C.instanceColor&&(pe=C.instanceColor)),pe!==void 0){const me=pe.normalized,ve=pe.itemSize,tt=e.get(pe);if(tt===void 0)continue;const je=tt.buffer,Ot=tt.type,Nt=tt.bytesPerElement,Z=Ot===l.INT||Ot===l.UNSIGNED_INT||pe.gpuType===Ld;if(pe.isInterleavedBufferAttribute){const se=pe.data,Pe=se.stride,Ze=pe.offset;if(se.isInstancedInterleavedBuffer){for(let Le=0;Le<ee.locationSize;Le++)g(ee.location+Le,se.meshPerAttribute);C.isInstancedMesh!==!0&&O._maxInstanceCount===void 0&&(O._maxInstanceCount=se.meshPerAttribute*se.count)}else for(let Le=0;Le<ee.locationSize;Le++)m(ee.location+Le);l.bindBuffer(l.ARRAY_BUFFER,je);for(let Le=0;Le<ee.locationSize;Le++)v(ee.location+Le,ve/ee.locationSize,Ot,me,Pe*Nt,(Ze+ve/ee.locationSize*Le)*Nt,Z)}else{if(pe.isInstancedBufferAttribute){for(let se=0;se<ee.locationSize;se++)g(ee.location+se,pe.meshPerAttribute);C.isInstancedMesh!==!0&&O._maxInstanceCount===void 0&&(O._maxInstanceCount=pe.meshPerAttribute*pe.count)}else for(let se=0;se<ee.locationSize;se++)m(ee.location+se);l.bindBuffer(l.ARRAY_BUFFER,je);for(let se=0;se<ee.locationSize;se++)v(ee.location+se,ve/ee.locationSize,Ot,me,ve*Nt,ve/ee.locationSize*se*Nt,Z)}}else if($!==void 0){const me=$[G];if(me!==void 0)switch(me.length){case 2:l.vertexAttrib2fv(ee.location,me);break;case 3:l.vertexAttrib3fv(ee.location,me);break;case 4:l.vertexAttrib4fv(ee.location,me);break;default:l.vertexAttrib1fv(ee.location,me)}}}}x()}function _(){R();for(const C in i){const k=i[C];for(const L in k){const O=k[L];for(const W in O)h(O[W].object),delete O[W];delete k[L]}delete i[C]}}function S(C){if(i[C.id]===void 0)return;const k=i[C.id];for(const L in k){const O=k[L];for(const W in O)h(O[W].object),delete O[W];delete k[L]}delete i[C.id]}function A(C){for(const k in i){const L=i[k];if(L[C.id]===void 0)continue;const O=L[C.id];for(const W in O)h(O[W].object),delete O[W];delete L[C.id]}}function R(){M(),a=!0,n!==s&&(n=s,c(n.object))}function M(){s.geometry=null,s.program=null,s.wireframe=!1}return{setup:o,reset:R,resetDefaultState:M,dispose:_,releaseStatesOfGeometry:S,releaseStatesOfProgram:A,initAttributes:y,enableAttribute:m,disableUnusedAttributes:x}}function Xb(l,e,t){let i;function s(c){i=c}function n(c,h){l.drawArrays(i,c,h),t.update(h,i,1)}function a(c,h,d){d!==0&&(l.drawArraysInstanced(i,c,h,d),t.update(h,i,d))}function o(c,h,d){if(d===0)return;e.get("WEBGL_multi_draw").multiDrawArraysWEBGL(i,c,0,h,0,d);let p=0;for(let f=0;f<d;f++)p+=h[f];t.update(p,i,1)}function r(c,h,d,u){if(d===0)return;const p=e.get("WEBGL_multi_draw");if(p===null)for(let f=0;f<c.length;f++)a(c[f],h[f],u[f]);else{p.multiDrawArraysInstancedWEBGL(i,c,0,h,0,u,0,d);let f=0;for(let y=0;y<d;y++)f+=h[y]*u[y];t.update(f,i,1)}}this.setMode=s,this.render=n,this.renderInstances=a,this.renderMultiDraw=o,this.renderMultiDrawInstances=r}function Yb(l,e,t,i){let s;function n(){if(s!==void 0)return s;if(e.has("EXT_texture_filter_anisotropic")===!0){const A=e.get("EXT_texture_filter_anisotropic");s=l.getParameter(A.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else s=0;return s}function a(A){return!(A!==xs&&i.convert(A)!==l.getParameter(l.IMPLEMENTATION_COLOR_READ_FORMAT))}function o(A){const R=A===cs&&(e.has("EXT_color_buffer_half_float")||e.has("EXT_color_buffer_float"));return!(A!==ls&&i.convert(A)!==l.getParameter(l.IMPLEMENTATION_COLOR_READ_TYPE)&&A!==vs&&!R)}function r(A){if(A==="highp"){if(l.getShaderPrecisionFormat(l.VERTEX_SHADER,l.HIGH_FLOAT).precision>0&&l.getShaderPrecisionFormat(l.FRAGMENT_SHADER,l.HIGH_FLOAT).precision>0)return"highp";A="mediump"}return A==="mediump"&&l.getShaderPrecisionFormat(l.VERTEX_SHADER,l.MEDIUM_FLOAT).precision>0&&l.getShaderPrecisionFormat(l.FRAGMENT_SHADER,l.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let c=t.precision!==void 0?t.precision:"highp";const h=r(c);h!==c&&(Qe("WebGLRenderer:",c,"not supported, using",h,"instead."),c=h);const d=t.logarithmicDepthBuffer===!0,u=t.reversedDepthBuffer===!0&&e.has("EXT_clip_control"),p=l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS),f=l.getParameter(l.MAX_VERTEX_TEXTURE_IMAGE_UNITS),y=l.getParameter(l.MAX_TEXTURE_SIZE),m=l.getParameter(l.MAX_CUBE_MAP_TEXTURE_SIZE),g=l.getParameter(l.MAX_VERTEX_ATTRIBS),x=l.getParameter(l.MAX_VERTEX_UNIFORM_VECTORS),v=l.getParameter(l.MAX_VARYING_VECTORS),b=l.getParameter(l.MAX_FRAGMENT_UNIFORM_VECTORS),_=l.getParameter(l.MAX_SAMPLES),S=l.getParameter(l.SAMPLES);return{isWebGL2:!0,getMaxAnisotropy:n,getMaxPrecision:r,textureFormatReadable:a,textureTypeReadable:o,precision:c,logarithmicDepthBuffer:d,reversedDepthBuffer:u,maxTextures:p,maxVertexTextures:f,maxTextureSize:y,maxCubemapSize:m,maxAttributes:g,maxVertexUniforms:x,maxVaryings:v,maxFragmentUniforms:b,maxSamples:_,samples:S}}function Qb(l){const e=this;let t=null,i=0,s=!1,n=!1;const a=new jn,o=new yt,r={value:null,needsUpdate:!1};this.uniform=r,this.numPlanes=0,this.numIntersection=0,this.init=function(d,u){const p=d.length!==0||u||i!==0||s;return s=u,i=d.length,p},this.beginShadows=function(){n=!0,h(null)},this.endShadows=function(){n=!1},this.setGlobalState=function(d,u){t=h(d,u,0)},this.setState=function(d,u,p){const f=d.clippingPlanes,y=d.clipIntersection,m=d.clipShadows,g=l.get(d);if(!s||f===null||f.length===0||n&&!m)n?h(null):c();else{const x=n?0:i,v=x*4;let b=g.clippingState||null;r.value=b,b=h(f,u,v,p);for(let _=0;_!==v;++_)b[_]=t[_];g.clippingState=b,this.numIntersection=y?this.numPlanes:0,this.numPlanes+=x}};function c(){r.value!==t&&(r.value=t,r.needsUpdate=i>0),e.numPlanes=i,e.numIntersection=0}function h(d,u,p,f){const y=d!==null?d.length:0;let m=null;if(y!==0){if(m=r.value,f!==!0||m===null){const g=p+y*4,x=u.matrixWorldInverse;o.getNormalMatrix(x),(m===null||m.length<g)&&(m=new Float32Array(g));for(let v=0,b=p;v!==y;++v,b+=4)a.copy(d[v]).applyMatrix4(x,o),a.normal.toArray(m,b),m[b+3]=a.constant}r.value=m,r.needsUpdate=!0}return e.numPlanes=y,e.numIntersection=0,m}}function jb(l){let e=new WeakMap;function t(a,o){return o===Ah?a.mapping=aa:o===Rh&&(a.mapping=Va),a}function i(a){if(a&&a.isTexture){const o=a.mapping;if(o===Ah||o===Rh)if(e.has(a)){const r=e.get(a).texture;return t(r,a.mapping)}else{const r=a.image;if(r&&r.height>0){const c=new pm(r.height);return c.fromEquirectangularTexture(l,a),e.set(a,c),a.addEventListener("dispose",s),t(c.texture,a.mapping)}else return null}}return a}function s(a){const o=a.target;o.removeEventListener("dispose",s);const r=e.get(o);r!==void 0&&(e.delete(o),r.dispose())}function n(){e=new WeakMap}return{get:i,dispose:n}}const kn=4,vp=[.125,.215,.35,.446,.526,.582],Zn=20,Kb=256,So=new ur,xp=new H;let Oc=null,Nc=0,Bc=0,zc=!1;const Zb=new T;class bp{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._backgroundBox=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._blurMaterial=null,this._ggxMaterial=null}fromScene(e,t=0,i=.1,s=100,n={}){const{size:a=256,position:o=Zb}=n;Oc=this._renderer.getRenderTarget(),Nc=this._renderer.getActiveCubeFace(),Bc=this._renderer.getActiveMipmapLevel(),zc=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(a);const r=this._allocateTargets();return r.depthBuffer=!0,this._sceneToCubeUV(e,i,s,r,o),t>0&&this._blur(r,0,0,t),this._applyPMREM(r),this._cleanup(r),r}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){this._cubemapMaterial===null&&(this._cubemapMaterial=Mp(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){this._equirectMaterial===null&&(this._equirectMaterial=_p(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),this._cubemapMaterial!==null&&this._cubemapMaterial.dispose(),this._equirectMaterial!==null&&this._equirectMaterial.dispose(),this._backgroundBox!==null&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){this._blurMaterial!==null&&this._blurMaterial.dispose(),this._ggxMaterial!==null&&this._ggxMaterial.dispose(),this._pingPongRenderTarget!==null&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodMeshes.length;e++)this._lodMeshes[e].geometry.dispose()}_cleanup(e){this._renderer.setRenderTarget(Oc,Nc,Bc),this._renderer.xr.enabled=zc,e.scissorTest=!1,ka(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===aa||e.mapping===Va?this._setSize(e.image.length===0?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),Oc=this._renderer.getRenderTarget(),Nc=this._renderer.getActiveCubeFace(),Bc=this._renderer.getActiveMipmapLevel(),zc=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const i=t||this._allocateTargets();return this._textureToCubeUV(e,i),this._applyPMREM(i),this._cleanup(i),i}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,i={magFilter:bi,minFilter:bi,generateMipmaps:!1,type:cs,format:xs,colorSpace:zi,depthBuffer:!1},s=wp(e,t,i);if(this._pingPongRenderTarget===null||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){this._pingPongRenderTarget!==null&&this._dispose(),this._pingPongRenderTarget=wp(e,t,i);const{_lodMax:n}=this;({lodMeshes:this._lodMeshes,sizeLods:this._sizeLods,sigmas:this._sigmas}=Jb(n)),this._blurMaterial=tw(n,e,t),this._ggxMaterial=ew(n,e,t)}return s}_compileMaterial(e){const t=new w(new mt,e);this._renderer.compile(t,So)}_sceneToCubeUV(e,t,i,s,n){const r=new Wi(90,1,t,i),c=[1,-1,1,1,1,1],h=[1,1,1,-1,-1,-1],d=this._renderer,u=d.autoClear,p=d.toneMapping;d.getClearColor(xp),d.toneMapping=Ws,d.autoClear=!1,d.state.buffers.depth.getReversed()&&(d.setRenderTarget(s),d.clearDepth(),d.setRenderTarget(null)),this._backgroundBox===null&&(this._backgroundBox=new w(new ie,new B({name:"PMREM.Background",side:wi,depthWrite:!1,depthTest:!1})));const y=this._backgroundBox,m=y.material;let g=!1;const x=e.background;x?x.isColor&&(m.color.copy(x),e.background=null,g=!0):(m.color.copy(xp),g=!0);for(let v=0;v<6;v++){const b=v%3;b===0?(r.up.set(0,c[v],0),r.position.set(n.x,n.y,n.z),r.lookAt(n.x+h[v],n.y,n.z)):b===1?(r.up.set(0,0,c[v]),r.position.set(n.x,n.y,n.z),r.lookAt(n.x,n.y+h[v],n.z)):(r.up.set(0,c[v],0),r.position.set(n.x,n.y,n.z),r.lookAt(n.x,n.y,n.z+h[v]));const _=this._cubeSize;ka(s,b*_,v>2?_:0,_,_),d.setRenderTarget(s),g&&d.render(y,r),d.render(e,r)}d.toneMapping=p,d.autoClear=u,e.background=x}_textureToCubeUV(e,t){const i=this._renderer,s=e.mapping===aa||e.mapping===Va;s?(this._cubemapMaterial===null&&(this._cubemapMaterial=Mp()),this._cubemapMaterial.uniforms.flipEnvMap.value=e.isRenderTargetTexture===!1?-1:1):this._equirectMaterial===null&&(this._equirectMaterial=_p());const n=s?this._cubemapMaterial:this._equirectMaterial,a=this._lodMeshes[0];a.material=n;const o=n.uniforms;o.envMap.value=e;const r=this._cubeSize;ka(t,0,0,3*r,2*r),i.setRenderTarget(t),i.render(a,So)}_applyPMREM(e){const t=this._renderer,i=t.autoClear;t.autoClear=!1;const s=this._lodMeshes.length;for(let n=1;n<s;n++)this._applyGGXFilter(e,n-1,n);t.autoClear=i}_applyGGXFilter(e,t,i){const s=this._renderer,n=this._pingPongRenderTarget,a=this._ggxMaterial,o=this._lodMeshes[i];o.material=a;const r=a.uniforms,c=i/(this._lodMeshes.length-1),h=t/(this._lodMeshes.length-1),d=Math.sqrt(c*c-h*h),u=0+c*1.25,p=d*u,{_lodMax:f}=this,y=this._sizeLods[i],m=3*y*(i>f-kn?i-f+kn:0),g=4*(this._cubeSize-y);r.envMap.value=e.texture,r.roughness.value=p,r.mipInt.value=f-t,ka(n,m,g,3*y,2*y),s.setRenderTarget(n),s.render(o,So),r.envMap.value=n.texture,r.roughness.value=0,r.mipInt.value=f-i,ka(e,m,g,3*y,2*y),s.setRenderTarget(e),s.render(o,So)}_blur(e,t,i,s,n){const a=this._pingPongRenderTarget;this._halfBlur(e,a,t,i,s,"latitudinal",n),this._halfBlur(a,e,i,i,s,"longitudinal",n)}_halfBlur(e,t,i,s,n,a,o){const r=this._renderer,c=this._blurMaterial;a!=="latitudinal"&&a!=="longitudinal"&&rt("blur direction must be either latitudinal or longitudinal!");const h=3,d=this._lodMeshes[s];d.material=c;const u=c.uniforms,p=this._sizeLods[i]-1,f=isFinite(n)?Math.PI/(2*p):2*Math.PI/(2*Zn-1),y=n/f,m=isFinite(n)?1+Math.floor(h*y):Zn;m>Zn&&Qe(`sigmaRadians, ${n}, is too large and will clip, as it requested ${m} samples when the maximum is set to ${Zn}`);const g=[];let x=0;for(let A=0;A<Zn;++A){const R=A/y,M=Math.exp(-R*R/2);g.push(M),A===0?x+=M:A<m&&(x+=2*M)}for(let A=0;A<g.length;A++)g[A]=g[A]/x;u.envMap.value=e.texture,u.samples.value=m,u.weights.value=g,u.latitudinal.value=a==="latitudinal",o&&(u.poleAxis.value=o);const{_lodMax:v}=this;u.dTheta.value=f,u.mipInt.value=v-i;const b=this._sizeLods[s],_=3*b*(s>v-kn?s-v+kn:0),S=4*(this._cubeSize-b);ka(t,_,S,3*b,2*b),r.setRenderTarget(t),r.render(d,So)}}function Jb(l){const e=[],t=[],i=[];let s=l;const n=l-kn+1+vp.length;for(let a=0;a<n;a++){const o=Math.pow(2,s);e.push(o);let r=1/o;a>l-kn?r=vp[a-l+kn-1]:a===0&&(r=0),t.push(r);const c=1/(o-2),h=-c,d=1+c,u=[h,h,d,h,d,d,h,h,d,d,h,d],p=6,f=6,y=3,m=2,g=1,x=new Float32Array(y*f*p),v=new Float32Array(m*f*p),b=new Float32Array(g*f*p);for(let S=0;S<p;S++){const A=S%3*2/3-1,R=S>2?0:-1,M=[A,R,0,A+2/3,R,0,A+2/3,R+1,0,A,R,0,A+2/3,R+1,0,A,R+1,0];x.set(M,y*f*S),v.set(u,m*f*S);const C=[S,S,S,S,S,S];b.set(C,g*f*S)}const _=new mt;_.setAttribute("position",new Je(x,y)),_.setAttribute("uv",new Je(v,m)),_.setAttribute("faceIndex",new Je(b,g)),i.push(new w(_,null)),s>kn&&s--}return{lodMeshes:i,sizeLods:e,sigmas:t}}function wp(l,e,t){const i=new ji(l,e,t);return i.texture.mapping=ql,i.texture.name="PMREM.cubeUv",i.scissorTest=!0,i}function ka(l,e,t,i,s){l.viewport.set(e,t,i,s),l.scissor.set(e,t,i,s)}function ew(l,e,t){return new Ci({name:"PMREMGGXConvolution",defines:{GGX_SAMPLES:Kb,CUBEUV_TEXEL_WIDTH:1/e,CUBEUV_TEXEL_HEIGHT:1/t,CUBEUV_MAX_MIP:`${l}.0`},uniforms:{envMap:{value:null},roughness:{value:0},mipInt:{value:0}},vertexShader:$l(),fragmentShader:`

			precision highp float;
			precision highp int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform float roughness;
			uniform float mipInt;

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			#define PI 3.14159265359

			// Van der Corput radical inverse
			float radicalInverse_VdC(uint bits) {
				bits = (bits << 16u) | (bits >> 16u);
				bits = ((bits & 0x55555555u) << 1u) | ((bits & 0xAAAAAAAAu) >> 1u);
				bits = ((bits & 0x33333333u) << 2u) | ((bits & 0xCCCCCCCCu) >> 2u);
				bits = ((bits & 0x0F0F0F0Fu) << 4u) | ((bits & 0xF0F0F0F0u) >> 4u);
				bits = ((bits & 0x00FF00FFu) << 8u) | ((bits & 0xFF00FF00u) >> 8u);
				return float(bits) * 2.3283064365386963e-10; // / 0x100000000
			}

			// Hammersley sequence
			vec2 hammersley(uint i, uint N) {
				return vec2(float(i) / float(N), radicalInverse_VdC(i));
			}

			// GGX VNDF importance sampling (Eric Heitz 2018)
			// "Sampling the GGX Distribution of Visible Normals"
			// https://jcgt.org/published/0007/04/01/
			vec3 importanceSampleGGX_VNDF(vec2 Xi, vec3 V, float roughness) {
				float alpha = roughness * roughness;

				// Section 3.2: Transform view direction to hemisphere configuration
				vec3 Vh = normalize(vec3(alpha * V.x, alpha * V.y, V.z));

				// Section 4.1: Orthonormal basis
				float lensq = Vh.x * Vh.x + Vh.y * Vh.y;
				vec3 T1 = lensq > 0.0 ? vec3(-Vh.y, Vh.x, 0.0) / sqrt(lensq) : vec3(1.0, 0.0, 0.0);
				vec3 T2 = cross(Vh, T1);

				// Section 4.2: Parameterization of projected area
				float r = sqrt(Xi.x);
				float phi = 2.0 * PI * Xi.y;
				float t1 = r * cos(phi);
				float t2 = r * sin(phi);
				float s = 0.5 * (1.0 + Vh.z);
				t2 = (1.0 - s) * sqrt(1.0 - t1 * t1) + s * t2;

				// Section 4.3: Reprojection onto hemisphere
				vec3 Nh = t1 * T1 + t2 * T2 + sqrt(max(0.0, 1.0 - t1 * t1 - t2 * t2)) * Vh;

				// Section 3.4: Transform back to ellipsoid configuration
				return normalize(vec3(alpha * Nh.x, alpha * Nh.y, max(0.0, Nh.z)));
			}

			void main() {
				vec3 N = normalize(vOutputDirection);
				vec3 V = N; // Assume view direction equals normal for pre-filtering

				vec3 prefilteredColor = vec3(0.0);
				float totalWeight = 0.0;

				// For very low roughness, just sample the environment directly
				if (roughness < 0.001) {
					gl_FragColor = vec4(bilinearCubeUV(envMap, N, mipInt), 1.0);
					return;
				}

				// Tangent space basis for VNDF sampling
				vec3 up = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0);
				vec3 tangent = normalize(cross(up, N));
				vec3 bitangent = cross(N, tangent);

				for(uint i = 0u; i < uint(GGX_SAMPLES); i++) {
					vec2 Xi = hammersley(i, uint(GGX_SAMPLES));

					// For PMREM, V = N, so in tangent space V is always (0, 0, 1)
					vec3 H_tangent = importanceSampleGGX_VNDF(Xi, vec3(0.0, 0.0, 1.0), roughness);

					// Transform H back to world space
					vec3 H = normalize(tangent * H_tangent.x + bitangent * H_tangent.y + N * H_tangent.z);
					vec3 L = normalize(2.0 * dot(V, H) * H - V);

					float NdotL = max(dot(N, L), 0.0);

					if(NdotL > 0.0) {
						// Sample environment at fixed mip level
						// VNDF importance sampling handles the distribution filtering
						vec3 sampleColor = bilinearCubeUV(envMap, L, mipInt);

						// Weight by NdotL for the split-sum approximation
						// VNDF PDF naturally accounts for the visible microfacet distribution
						prefilteredColor += sampleColor * NdotL;
						totalWeight += NdotL;
					}
				}

				if (totalWeight > 0.0) {
					prefilteredColor = prefilteredColor / totalWeight;
				}

				gl_FragColor = vec4(prefilteredColor, 1.0);
			}
		`,blending:qs,depthTest:!1,depthWrite:!1})}function tw(l,e,t){const i=new Float32Array(Zn),s=new T(0,1,0);return new Ci({name:"SphericalGaussianBlur",defines:{n:Zn,CUBEUV_TEXEL_WIDTH:1/e,CUBEUV_TEXEL_HEIGHT:1/t,CUBEUV_MAX_MIP:`${l}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:i},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:s}},vertexShader:$l(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;
			uniform int samples;
			uniform float weights[ n ];
			uniform bool latitudinal;
			uniform float dTheta;
			uniform float mipInt;
			uniform vec3 poleAxis;

			#define ENVMAP_TYPE_CUBE_UV
			#include <cube_uv_reflection_fragment>

			vec3 getSample( float theta, vec3 axis ) {

				float cosTheta = cos( theta );
				// Rodrigues' axis-angle rotation
				vec3 sampleDirection = vOutputDirection * cosTheta
					+ cross( axis, vOutputDirection ) * sin( theta )
					+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );

				return bilinearCubeUV( envMap, sampleDirection, mipInt );

			}

			void main() {

				vec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );

				if ( all( equal( axis, vec3( 0.0 ) ) ) ) {

					axis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );

				}

				axis = normalize( axis );

				gl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );
				gl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );

				for ( int i = 1; i < n; i++ ) {

					if ( i >= samples ) {

						break;

					}

					float theta = dTheta * float( i );
					gl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );
					gl_FragColor.rgb += weights[ i ] * getSample( theta, axis );

				}

			}
		`,blending:qs,depthTest:!1,depthWrite:!1})}function _p(){return new Ci({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:$l(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			varying vec3 vOutputDirection;

			uniform sampler2D envMap;

			#include <common>

			void main() {

				vec3 outputDirection = normalize( vOutputDirection );
				vec2 uv = equirectUv( outputDirection );

				gl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );

			}
		`,blending:qs,depthTest:!1,depthWrite:!1})}function Mp(){return new Ci({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:$l(),fragmentShader:`

			precision mediump float;
			precision mediump int;

			uniform float flipEnvMap;

			varying vec3 vOutputDirection;

			uniform samplerCube envMap;

			void main() {

				gl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );

			}
		`,blending:qs,depthTest:!1,depthWrite:!1})}function $l(){return`

		precision mediump float;
		precision mediump int;

		attribute float faceIndex;

		varying vec3 vOutputDirection;

		// RH coordinate system; PMREM face-indexing convention
		vec3 getDirection( vec2 uv, float face ) {

			uv = 2.0 * uv - 1.0;

			vec3 direction = vec3( uv, 1.0 );

			if ( face == 0.0 ) {

				direction = direction.zyx; // ( 1, v, u ) pos x

			} else if ( face == 1.0 ) {

				direction = direction.xzy;
				direction.xz *= -1.0; // ( -u, 1, -v ) pos y

			} else if ( face == 2.0 ) {

				direction.x *= -1.0; // ( -u, v, 1 ) pos z

			} else if ( face == 3.0 ) {

				direction = direction.zyx;
				direction.xz *= -1.0; // ( -1, v, -u ) neg x

			} else if ( face == 4.0 ) {

				direction = direction.xzy;
				direction.xy *= -1.0; // ( -u, -1, v ) neg y

			} else if ( face == 5.0 ) {

				direction.z *= -1.0; // ( u, v, -1 ) neg z

			}

			return direction;

		}

		void main() {

			vOutputDirection = getDirection( uv, faceIndex );
			gl_Position = vec4( position, 1.0 );

		}
	`}function iw(l){let e=new WeakMap,t=null;function i(o){if(o&&o.isTexture){const r=o.mapping,c=r===Ah||r===Rh,h=r===aa||r===Va;if(c||h){let d=e.get(o);const u=d!==void 0?d.texture.pmremVersion:0;if(o.isRenderTargetTexture&&o.pmremVersion!==u)return t===null&&(t=new bp(l)),d=c?t.fromEquirectangular(o,d):t.fromCubemap(o,d),d.texture.pmremVersion=o.pmremVersion,e.set(o,d),d.texture;if(d!==void 0)return d.texture;{const p=o.image;return c&&p&&p.height>0||h&&p&&s(p)?(t===null&&(t=new bp(l)),d=c?t.fromEquirectangular(o):t.fromCubemap(o),d.texture.pmremVersion=o.pmremVersion,e.set(o,d),o.addEventListener("dispose",n),d.texture):null}}}return o}function s(o){let r=0;const c=6;for(let h=0;h<c;h++)o[h]!==void 0&&r++;return r===c}function n(o){const r=o.target;r.removeEventListener("dispose",n);const c=e.get(r);c!==void 0&&(e.delete(r),c.dispose())}function a(){e=new WeakMap,t!==null&&(t.dispose(),t=null)}return{get:i,dispose:a}}function sw(l){const e={};function t(i){if(e[i]!==void 0)return e[i];const s=l.getExtension(i);return e[i]=s,s}return{has:function(i){return t(i)!==null},init:function(){t("EXT_color_buffer_float"),t("WEBGL_clip_cull_distance"),t("OES_texture_float_linear"),t("EXT_color_buffer_half_float"),t("WEBGL_multisampled_render_to_texture"),t("WEBGL_render_shared_exponent")},get:function(i){const s=t(i);return s===null&&er("WebGLRenderer: "+i+" extension not supported."),s}}}function nw(l,e,t,i){const s={},n=new WeakMap;function a(d){const u=d.target;u.index!==null&&e.remove(u.index);for(const f in u.attributes)e.remove(u.attributes[f]);u.removeEventListener("dispose",a),delete s[u.id];const p=n.get(u);p&&(e.remove(p),n.delete(u)),i.releaseStatesOfGeometry(u),u.isInstancedBufferGeometry===!0&&delete u._maxInstanceCount,t.memory.geometries--}function o(d,u){return s[u.id]===!0||(u.addEventListener("dispose",a),s[u.id]=!0,t.memory.geometries++),u}function r(d){const u=d.attributes;for(const p in u)e.update(u[p],l.ARRAY_BUFFER)}function c(d){const u=[],p=d.index,f=d.attributes.position;let y=0;if(p!==null){const x=p.array;y=p.version;for(let v=0,b=x.length;v<b;v+=3){const _=x[v+0],S=x[v+1],A=x[v+2];u.push(_,S,S,A,A,_)}}else if(f!==void 0){const x=f.array;y=f.version;for(let v=0,b=x.length/3-1;v<b;v+=3){const _=v+0,S=v+1,A=v+2;u.push(_,S,S,A,A,_)}}else return;const m=new(nm(u)?cm:lm)(u,1);m.version=y;const g=n.get(d);g&&e.remove(g),n.set(d,m)}function h(d){const u=n.get(d);if(u){const p=d.index;p!==null&&u.version<p.version&&c(d)}else c(d);return n.get(d)}return{get:o,update:r,getWireframeAttribute:h}}function aw(l,e,t){let i;function s(u){i=u}let n,a;function o(u){n=u.type,a=u.bytesPerElement}function r(u,p){l.drawElements(i,p,n,u*a),t.update(p,i,1)}function c(u,p,f){f!==0&&(l.drawElementsInstanced(i,p,n,u*a,f),t.update(p,i,f))}function h(u,p,f){if(f===0)return;e.get("WEBGL_multi_draw").multiDrawElementsWEBGL(i,p,0,n,u,0,f);let m=0;for(let g=0;g<f;g++)m+=p[g];t.update(m,i,1)}function d(u,p,f,y){if(f===0)return;const m=e.get("WEBGL_multi_draw");if(m===null)for(let g=0;g<u.length;g++)c(u[g]/a,p[g],y[g]);else{m.multiDrawElementsInstancedWEBGL(i,p,0,n,u,0,y,0,f);let g=0;for(let x=0;x<f;x++)g+=p[x]*y[x];t.update(g,i,1)}}this.setMode=s,this.setIndex=o,this.render=r,this.renderInstances=c,this.renderMultiDraw=h,this.renderMultiDrawInstances=d}function ow(l){const e={geometries:0,textures:0},t={frame:0,calls:0,triangles:0,points:0,lines:0};function i(n,a,o){switch(t.calls++,a){case l.TRIANGLES:t.triangles+=o*(n/3);break;case l.LINES:t.lines+=o*(n/2);break;case l.LINE_STRIP:t.lines+=o*(n-1);break;case l.LINE_LOOP:t.lines+=o*n;break;case l.POINTS:t.points+=o*n;break;default:rt("WebGLInfo: Unknown draw mode:",a);break}}function s(){t.calls=0,t.triangles=0,t.points=0,t.lines=0}return{memory:e,render:t,programs:null,autoReset:!0,reset:s,update:i}}function rw(l,e,t){const i=new WeakMap,s=new ni;function n(a,o,r){const c=a.morphTargetInfluences,h=o.morphAttributes.position||o.morphAttributes.normal||o.morphAttributes.color,d=h!==void 0?h.length:0;let u=i.get(o);if(u===void 0||u.count!==d){let C=function(){R.dispose(),i.delete(o),o.removeEventListener("dispose",C)};var p=C;u!==void 0&&u.texture.dispose();const f=o.morphAttributes.position!==void 0,y=o.morphAttributes.normal!==void 0,m=o.morphAttributes.color!==void 0,g=o.morphAttributes.position||[],x=o.morphAttributes.normal||[],v=o.morphAttributes.color||[];let b=0;f===!0&&(b=1),y===!0&&(b=2),m===!0&&(b=3);let _=o.attributes.position.count*b,S=1;_>e.maxTextureSize&&(S=Math.ceil(_/e.maxTextureSize),_=e.maxTextureSize);const A=new Float32Array(_*S*4*d),R=new am(A,_,S,d);R.type=vs,R.needsUpdate=!0;const M=b*4;for(let k=0;k<d;k++){const L=g[k],O=x[k],W=v[k],U=_*S*4*k;for(let $=0;$<L.count;$++){const G=$*M;f===!0&&(s.fromBufferAttribute(L,$),A[U+G+0]=s.x,A[U+G+1]=s.y,A[U+G+2]=s.z,A[U+G+3]=0),y===!0&&(s.fromBufferAttribute(O,$),A[U+G+4]=s.x,A[U+G+5]=s.y,A[U+G+6]=s.z,A[U+G+7]=0),m===!0&&(s.fromBufferAttribute(W,$),A[U+G+8]=s.x,A[U+G+9]=s.y,A[U+G+10]=s.z,A[U+G+11]=W.itemSize===4?s.w:1)}}u={count:d,texture:R,size:new le(_,S)},i.set(o,u),o.addEventListener("dispose",C)}if(a.isInstancedMesh===!0&&a.morphTexture!==null)r.getUniforms().setValue(l,"morphTexture",a.morphTexture,t);else{let f=0;for(let m=0;m<c.length;m++)f+=c[m];const y=o.morphTargetsRelative?1:1-f;r.getUniforms().setValue(l,"morphTargetBaseInfluence",y),r.getUniforms().setValue(l,"morphTargetInfluences",c)}r.getUniforms().setValue(l,"morphTargetsTexture",u.texture,t),r.getUniforms().setValue(l,"morphTargetsTextureSize",u.size)}return{update:n}}function lw(l,e,t,i){let s=new WeakMap;function n(r){const c=i.render.frame,h=r.geometry,d=e.get(r,h);if(s.get(d)!==c&&(e.update(d),s.set(d,c)),r.isInstancedMesh&&(r.hasEventListener("dispose",o)===!1&&r.addEventListener("dispose",o),s.get(r)!==c&&(t.update(r.instanceMatrix,l.ARRAY_BUFFER),r.instanceColor!==null&&t.update(r.instanceColor,l.ARRAY_BUFFER),s.set(r,c))),r.isSkinnedMesh){const u=r.skeleton;s.get(u)!==c&&(u.update(),s.set(u,c))}return d}function a(){s=new WeakMap}function o(r){const c=r.target;c.removeEventListener("dispose",o),t.remove(c.instanceMatrix),c.instanceColor!==null&&t.remove(c.instanceColor)}return{update:n,dispose:a}}const cw={[Hl]:"LINEAR_TONE_MAPPING",[Ad]:"REINHARD_TONE_MAPPING",[Rd]:"CINEON_TONE_MAPPING",[Id]:"ACES_FILMIC_TONE_MAPPING",[Pd]:"AGX_TONE_MAPPING",[Dd]:"NEUTRAL_TONE_MAPPING",[kd]:"CUSTOM_TONE_MAPPING"};function hw(l,e,t,i,s){const n=new ji(e,t,{type:l,depthBuffer:i,stencilBuffer:s}),a=new ji(e,t,{type:cs,depthBuffer:!1,stencilBuffer:!1}),o=new mt;o.setAttribute("position",new Tt([-1,3,0,-1,-1,0,3,-1,0],3)),o.setAttribute("uv",new Tt([0,2,0,0,2,0],2));const r=new Em({uniforms:{tDiffuse:{value:null}},vertexShader:`
			precision highp float;

			uniform mat4 modelViewMatrix;
			uniform mat4 projectionMatrix;

			attribute vec3 position;
			attribute vec2 uv;

			varying vec2 vUv;

			void main() {
				vUv = uv;
				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			}`,fragmentShader:`
			precision highp float;

			uniform sampler2D tDiffuse;

			varying vec2 vUv;

			#include <tonemapping_pars_fragment>
			#include <colorspace_pars_fragment>

			void main() {
				gl_FragColor = texture2D( tDiffuse, vUv );

				#ifdef LINEAR_TONE_MAPPING
					gl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );
				#elif defined( REINHARD_TONE_MAPPING )
					gl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );
				#elif defined( CINEON_TONE_MAPPING )
					gl_FragColor.rgb = CineonToneMapping( gl_FragColor.rgb );
				#elif defined( ACES_FILMIC_TONE_MAPPING )
					gl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );
				#elif defined( AGX_TONE_MAPPING )
					gl_FragColor.rgb = AgXToneMapping( gl_FragColor.rgb );
				#elif defined( NEUTRAL_TONE_MAPPING )
					gl_FragColor.rgb = NeutralToneMapping( gl_FragColor.rgb );
				#elif defined( CUSTOM_TONE_MAPPING )
					gl_FragColor.rgb = CustomToneMapping( gl_FragColor.rgb );
				#endif

				#ifdef SRGB_TRANSFER
					gl_FragColor = sRGBTransferOETF( gl_FragColor );
				#endif
			}`,depthTest:!1,depthWrite:!1}),c=new w(o,r),h=new ur(-1,1,1,-1,0,1);let d=null,u=null,p=!1,f,y=null,m=[],g=!1;this.setSize=function(x,v){n.setSize(x,v),a.setSize(x,v);for(let b=0;b<m.length;b++){const _=m[b];_.setSize&&_.setSize(x,v)}},this.setEffects=function(x){m=x,g=m.length>0&&m[0].isRenderPass===!0;const v=n.width,b=n.height;for(let _=0;_<m.length;_++){const S=m[_];S.setSize&&S.setSize(v,b)}},this.begin=function(x,v){if(p||x.toneMapping===Ws&&m.length===0)return!1;if(y=v,v!==null){const b=v.width,_=v.height;(n.width!==b||n.height!==_)&&this.setSize(b,_)}return g===!1&&x.setRenderTarget(n),f=x.toneMapping,x.toneMapping=Ws,!0},this.hasRenderPass=function(){return g},this.end=function(x,v){x.toneMapping=f,p=!0;let b=n,_=a;for(let S=0;S<m.length;S++){const A=m[S];if(A.enabled!==!1&&(A.render(x,_,b,v),A.needsSwap!==!1)){const R=b;b=_,_=R}}if(d!==x.outputColorSpace||u!==x.toneMapping){d=x.outputColorSpace,u=x.toneMapping,r.defines={},Rt.getTransfer(d)===Gt&&(r.defines.SRGB_TRANSFER="");const S=cw[u];S&&(r.defines[S]=""),r.needsUpdate=!0}r.uniforms.tDiffuse.value=b.texture,x.setRenderTarget(y),x.render(c,h),y=null,p=!1},this.isCompositing=function(){return p},this.dispose=function(){n.dispose(),a.dispose(),o.dispose(),r.dispose()}}const Lm=new _i,yd=new ir(1,1),Om=new am,Nm=new Mg,Bm=new um,Sp=[],Tp=[],Ep=new Float32Array(16),Cp=new Float32Array(9),Ap=new Float32Array(4);function ro(l,e,t){const i=l[0];if(i<=0||i>0)return l;const s=e*t;let n=Sp[s];if(n===void 0&&(n=new Float32Array(s),Sp[s]=n),e!==0){i.toArray(n,0);for(let a=1,o=0;a!==e;++a)o+=t,l[a].toArray(n,o)}return n}function Mi(l,e){if(l.length!==e.length)return!1;for(let t=0,i=l.length;t<i;t++)if(l[t]!==e[t])return!1;return!0}function Si(l,e){for(let t=0,i=e.length;t<i;t++)l[t]=e[t]}function Xl(l,e){let t=Tp[e];t===void 0&&(t=new Int32Array(e),Tp[e]=t);for(let i=0;i!==e;++i)t[i]=l.allocateTextureUnit();return t}function dw(l,e){const t=this.cache;t[0]!==e&&(l.uniform1f(this.addr,e),t[0]=e)}function uw(l,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y)&&(l.uniform2f(this.addr,e.x,e.y),t[0]=e.x,t[1]=e.y);else{if(Mi(t,e))return;l.uniform2fv(this.addr,e),Si(t,e)}}function pw(l,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z)&&(l.uniform3f(this.addr,e.x,e.y,e.z),t[0]=e.x,t[1]=e.y,t[2]=e.z);else if(e.r!==void 0)(t[0]!==e.r||t[1]!==e.g||t[2]!==e.b)&&(l.uniform3f(this.addr,e.r,e.g,e.b),t[0]=e.r,t[1]=e.g,t[2]=e.b);else{if(Mi(t,e))return;l.uniform3fv(this.addr,e),Si(t,e)}}function fw(l,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z||t[3]!==e.w)&&(l.uniform4f(this.addr,e.x,e.y,e.z,e.w),t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.w);else{if(Mi(t,e))return;l.uniform4fv(this.addr,e),Si(t,e)}}function mw(l,e){const t=this.cache,i=e.elements;if(i===void 0){if(Mi(t,e))return;l.uniformMatrix2fv(this.addr,!1,e),Si(t,e)}else{if(Mi(t,i))return;Ap.set(i),l.uniformMatrix2fv(this.addr,!1,Ap),Si(t,i)}}function gw(l,e){const t=this.cache,i=e.elements;if(i===void 0){if(Mi(t,e))return;l.uniformMatrix3fv(this.addr,!1,e),Si(t,e)}else{if(Mi(t,i))return;Cp.set(i),l.uniformMatrix3fv(this.addr,!1,Cp),Si(t,i)}}function yw(l,e){const t=this.cache,i=e.elements;if(i===void 0){if(Mi(t,e))return;l.uniformMatrix4fv(this.addr,!1,e),Si(t,e)}else{if(Mi(t,i))return;Ep.set(i),l.uniformMatrix4fv(this.addr,!1,Ep),Si(t,i)}}function vw(l,e){const t=this.cache;t[0]!==e&&(l.uniform1i(this.addr,e),t[0]=e)}function xw(l,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y)&&(l.uniform2i(this.addr,e.x,e.y),t[0]=e.x,t[1]=e.y);else{if(Mi(t,e))return;l.uniform2iv(this.addr,e),Si(t,e)}}function bw(l,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z)&&(l.uniform3i(this.addr,e.x,e.y,e.z),t[0]=e.x,t[1]=e.y,t[2]=e.z);else{if(Mi(t,e))return;l.uniform3iv(this.addr,e),Si(t,e)}}function ww(l,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z||t[3]!==e.w)&&(l.uniform4i(this.addr,e.x,e.y,e.z,e.w),t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.w);else{if(Mi(t,e))return;l.uniform4iv(this.addr,e),Si(t,e)}}function _w(l,e){const t=this.cache;t[0]!==e&&(l.uniform1ui(this.addr,e),t[0]=e)}function Mw(l,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y)&&(l.uniform2ui(this.addr,e.x,e.y),t[0]=e.x,t[1]=e.y);else{if(Mi(t,e))return;l.uniform2uiv(this.addr,e),Si(t,e)}}function Sw(l,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z)&&(l.uniform3ui(this.addr,e.x,e.y,e.z),t[0]=e.x,t[1]=e.y,t[2]=e.z);else{if(Mi(t,e))return;l.uniform3uiv(this.addr,e),Si(t,e)}}function Tw(l,e){const t=this.cache;if(e.x!==void 0)(t[0]!==e.x||t[1]!==e.y||t[2]!==e.z||t[3]!==e.w)&&(l.uniform4ui(this.addr,e.x,e.y,e.z,e.w),t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.w);else{if(Mi(t,e))return;l.uniform4uiv(this.addr,e),Si(t,e)}}function Ew(l,e,t){const i=this.cache,s=t.allocateTextureUnit();i[0]!==s&&(l.uniform1i(this.addr,s),i[0]=s);let n;this.type===l.SAMPLER_2D_SHADOW?(yd.compareFunction=t.isReversedDepthBuffer()?qd:Hd,n=yd):n=Lm,t.setTexture2D(e||n,s)}function Cw(l,e,t){const i=this.cache,s=t.allocateTextureUnit();i[0]!==s&&(l.uniform1i(this.addr,s),i[0]=s),t.setTexture3D(e||Nm,s)}function Aw(l,e,t){const i=this.cache,s=t.allocateTextureUnit();i[0]!==s&&(l.uniform1i(this.addr,s),i[0]=s),t.setTextureCube(e||Bm,s)}function Rw(l,e,t){const i=this.cache,s=t.allocateTextureUnit();i[0]!==s&&(l.uniform1i(this.addr,s),i[0]=s),t.setTexture2DArray(e||Om,s)}function Iw(l){switch(l){case 5126:return dw;case 35664:return uw;case 35665:return pw;case 35666:return fw;case 35674:return mw;case 35675:return gw;case 35676:return yw;case 5124:case 35670:return vw;case 35667:case 35671:return xw;case 35668:case 35672:return bw;case 35669:case 35673:return ww;case 5125:return _w;case 36294:return Mw;case 36295:return Sw;case 36296:return Tw;case 35678:case 36198:case 36298:case 36306:case 35682:return Ew;case 35679:case 36299:case 36307:return Cw;case 35680:case 36300:case 36308:case 36293:return Aw;case 36289:case 36303:case 36311:case 36292:return Rw}}function kw(l,e){l.uniform1fv(this.addr,e)}function Pw(l,e){const t=ro(e,this.size,2);l.uniform2fv(this.addr,t)}function Dw(l,e){const t=ro(e,this.size,3);l.uniform3fv(this.addr,t)}function Lw(l,e){const t=ro(e,this.size,4);l.uniform4fv(this.addr,t)}function Ow(l,e){const t=ro(e,this.size,4);l.uniformMatrix2fv(this.addr,!1,t)}function Nw(l,e){const t=ro(e,this.size,9);l.uniformMatrix3fv(this.addr,!1,t)}function Bw(l,e){const t=ro(e,this.size,16);l.uniformMatrix4fv(this.addr,!1,t)}function zw(l,e){l.uniform1iv(this.addr,e)}function Fw(l,e){l.uniform2iv(this.addr,e)}function Uw(l,e){l.uniform3iv(this.addr,e)}function Gw(l,e){l.uniform4iv(this.addr,e)}function Hw(l,e){l.uniform1uiv(this.addr,e)}function qw(l,e){l.uniform2uiv(this.addr,e)}function Ww(l,e){l.uniform3uiv(this.addr,e)}function Vw(l,e){l.uniform4uiv(this.addr,e)}function $w(l,e,t){const i=this.cache,s=e.length,n=Xl(t,s);Mi(i,n)||(l.uniform1iv(this.addr,n),Si(i,n));let a;this.type===l.SAMPLER_2D_SHADOW?a=yd:a=Lm;for(let o=0;o!==s;++o)t.setTexture2D(e[o]||a,n[o])}function Xw(l,e,t){const i=this.cache,s=e.length,n=Xl(t,s);Mi(i,n)||(l.uniform1iv(this.addr,n),Si(i,n));for(let a=0;a!==s;++a)t.setTexture3D(e[a]||Nm,n[a])}function Yw(l,e,t){const i=this.cache,s=e.length,n=Xl(t,s);Mi(i,n)||(l.uniform1iv(this.addr,n),Si(i,n));for(let a=0;a!==s;++a)t.setTextureCube(e[a]||Bm,n[a])}function Qw(l,e,t){const i=this.cache,s=e.length,n=Xl(t,s);Mi(i,n)||(l.uniform1iv(this.addr,n),Si(i,n));for(let a=0;a!==s;++a)t.setTexture2DArray(e[a]||Om,n[a])}function jw(l){switch(l){case 5126:return kw;case 35664:return Pw;case 35665:return Dw;case 35666:return Lw;case 35674:return Ow;case 35675:return Nw;case 35676:return Bw;case 5124:case 35670:return zw;case 35667:case 35671:return Fw;case 35668:case 35672:return Uw;case 35669:case 35673:return Gw;case 5125:return Hw;case 36294:return qw;case 36295:return Ww;case 36296:return Vw;case 35678:case 36198:case 36298:case 36306:case 35682:return $w;case 35679:case 36299:case 36307:return Xw;case 35680:case 36300:case 36308:case 36293:return Yw;case 36289:case 36303:case 36311:case 36292:return Qw}}class Kw{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.type=t.type,this.setValue=Iw(t.type)}}class Zw{constructor(e,t,i){this.id=e,this.addr=i,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=jw(t.type)}}class Jw{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,i){const s=this.seq;for(let n=0,a=s.length;n!==a;++n){const o=s[n];o.setValue(e,t[o.id],i)}}}const Fc=/(\w+)(\])?(\[|\.)?/g;function Rp(l,e){l.seq.push(e),l.map[e.id]=e}function e_(l,e,t){const i=l.name,s=i.length;for(Fc.lastIndex=0;;){const n=Fc.exec(i),a=Fc.lastIndex;let o=n[1];const r=n[2]==="]",c=n[3];if(r&&(o=o|0),c===void 0||c==="["&&a+2===s){Rp(t,c===void 0?new Kw(o,l,e):new Zw(o,l,e));break}else{let d=t.map[o];d===void 0&&(d=new Jw(o),Rp(t,d)),t=d}}}class wl{constructor(e,t){this.seq=[],this.map={};const i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let a=0;a<i;++a){const o=e.getActiveUniform(t,a),r=e.getUniformLocation(t,o.name);e_(o,r,this)}const s=[],n=[];for(const a of this.seq)a.type===e.SAMPLER_2D_SHADOW||a.type===e.SAMPLER_CUBE_SHADOW||a.type===e.SAMPLER_2D_ARRAY_SHADOW?s.push(a):n.push(a);s.length>0&&(this.seq=s.concat(n))}setValue(e,t,i,s){const n=this.map[t];n!==void 0&&n.setValue(e,i,s)}setOptional(e,t,i){const s=t[i];s!==void 0&&this.setValue(e,i,s)}static upload(e,t,i,s){for(let n=0,a=t.length;n!==a;++n){const o=t[n],r=i[o.id];r.needsUpdate!==!1&&o.setValue(e,r.value,s)}}static seqWithValue(e,t){const i=[];for(let s=0,n=e.length;s!==n;++s){const a=e[s];a.id in t&&i.push(a)}return i}}function Ip(l,e,t){const i=l.createShader(e);return l.shaderSource(i,t),l.compileShader(i),i}const t_=37297;let i_=0;function s_(l,e){const t=l.split(`
`),i=[],s=Math.max(e-6,0),n=Math.min(e+6,t.length);for(let a=s;a<n;a++){const o=a+1;i.push(`${o===e?">":" "} ${o}: ${t[a]}`)}return i.join(`
`)}const kp=new yt;function n_(l){Rt._getMatrix(kp,Rt.workingColorSpace,l);const e=`mat3( ${kp.elements.map(t=>t.toFixed(4))} )`;switch(Rt.getTransfer(l)){case Il:return[e,"LinearTransferOETF"];case Gt:return[e,"sRGBTransferOETF"];default:return Qe("WebGLProgram: Unsupported color space: ",l),[e,"LinearTransferOETF"]}}function Pp(l,e,t){const i=l.getShaderParameter(e,l.COMPILE_STATUS),n=(l.getShaderInfoLog(e)||"").trim();if(i&&n==="")return"";const a=/ERROR: 0:(\d+)/.exec(n);if(a){const o=parseInt(a[1]);return t.toUpperCase()+`

`+n+`

`+s_(l.getShaderSource(e),o)}else return n}function a_(l,e){const t=n_(e);return[`vec4 ${l}( vec4 value ) {`,`	return ${t[1]}( vec4( value.rgb * ${t[0]}, value.a ) );`,"}"].join(`
`)}const o_={[Hl]:"Linear",[Ad]:"Reinhard",[Rd]:"Cineon",[Id]:"ACESFilmic",[Pd]:"AgX",[Dd]:"Neutral",[kd]:"Custom"};function r_(l,e){const t=o_[e];return t===void 0?(Qe("WebGLProgram: Unsupported toneMapping:",e),"vec3 "+l+"( vec3 color ) { return LinearToneMapping( color ); }"):"vec3 "+l+"( vec3 color ) { return "+t+"ToneMapping( color ); }"}const Kr=new T;function l_(){Rt.getLuminanceCoefficients(Kr);const l=Kr.x.toFixed(4),e=Kr.y.toFixed(4),t=Kr.z.toFixed(4);return["float luminance( const in vec3 rgb ) {",`	const vec3 weights = vec3( ${l}, ${e}, ${t} );`,"	return dot( weights, rgb );","}"].join(`
`)}function c_(l){return[l.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",l.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(No).join(`
`)}function h_(l){const e=[];for(const t in l){const i=l[t];i!==!1&&e.push("#define "+t+" "+i)}return e.join(`
`)}function d_(l,e){const t={},i=l.getProgramParameter(e,l.ACTIVE_ATTRIBUTES);for(let s=0;s<i;s++){const n=l.getActiveAttrib(e,s),a=n.name;let o=1;n.type===l.FLOAT_MAT2&&(o=2),n.type===l.FLOAT_MAT3&&(o=3),n.type===l.FLOAT_MAT4&&(o=4),t[a]={type:n.type,location:l.getAttribLocation(e,a),locationSize:o}}return t}function No(l){return l!==""}function Dp(l,e){const t=e.numSpotLightShadows+e.numSpotLightMaps-e.numSpotLightShadowsWithMaps;return l.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,e.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,t).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,e.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function Lp(l,e){return l.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const u_=/^[ \t]*#include +<([\w\d./]+)>/gm;function vd(l){return l.replace(u_,f_)}const p_=new Map;function f_(l,e){let t=xt[e];if(t===void 0){const i=p_.get(e);if(i!==void 0)t=xt[i],Qe('WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',e,i);else throw new Error("Can not resolve #include <"+e+">")}return vd(t)}const m_=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Op(l){return l.replace(m_,g_)}function g_(l,e,t,i){let s="";for(let n=parseInt(e);n<parseInt(t);n++)s+=i.replace(/\[\s*i\s*\]/g,"[ "+n+" ]").replace(/UNROLLED_LOOP_INDEX/g,n);return s}function Np(l){let e=`precision ${l.precision} float;
	precision ${l.precision} int;
	precision ${l.precision} sampler2D;
	precision ${l.precision} samplerCube;
	precision ${l.precision} sampler3D;
	precision ${l.precision} sampler2DArray;
	precision ${l.precision} sampler2DShadow;
	precision ${l.precision} samplerCubeShadow;
	precision ${l.precision} sampler2DArrayShadow;
	precision ${l.precision} isampler2D;
	precision ${l.precision} isampler3D;
	precision ${l.precision} isamplerCube;
	precision ${l.precision} isampler2DArray;
	precision ${l.precision} usampler2D;
	precision ${l.precision} usampler3D;
	precision ${l.precision} usamplerCube;
	precision ${l.precision} usampler2DArray;
	`;return l.precision==="highp"?e+=`
#define HIGH_PRECISION`:l.precision==="mediump"?e+=`
#define MEDIUM_PRECISION`:l.precision==="lowp"&&(e+=`
#define LOW_PRECISION`),e}const y_={[ml]:"SHADOWMAP_TYPE_PCF",[Do]:"SHADOWMAP_TYPE_VSM"};function v_(l){return y_[l.shadowMapType]||"SHADOWMAP_TYPE_BASIC"}const x_={[aa]:"ENVMAP_TYPE_CUBE",[Va]:"ENVMAP_TYPE_CUBE",[ql]:"ENVMAP_TYPE_CUBE_UV"};function b_(l){return l.envMap===!1?"ENVMAP_TYPE_CUBE":x_[l.envMapMode]||"ENVMAP_TYPE_CUBE"}const w_={[Va]:"ENVMAP_MODE_REFRACTION"};function __(l){return l.envMap===!1?"ENVMAP_MODE_REFLECTION":w_[l.envMapMode]||"ENVMAP_MODE_REFLECTION"}const M_={[Vf]:"ENVMAP_BLENDING_MULTIPLY",[F0]:"ENVMAP_BLENDING_MIX",[U0]:"ENVMAP_BLENDING_ADD"};function S_(l){return l.envMap===!1?"ENVMAP_BLENDING_NONE":M_[l.combine]||"ENVMAP_BLENDING_NONE"}function T_(l){const e=l.envMapCubeUVHeight;if(e===null)return null;const t=Math.log2(e)-2,i=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,t),112)),texelHeight:i,maxMip:t}}function E_(l,e,t,i){const s=l.getContext(),n=t.defines;let a=t.vertexShader,o=t.fragmentShader;const r=v_(t),c=b_(t),h=__(t),d=S_(t),u=T_(t),p=c_(t),f=h_(n),y=s.createProgram();let m,g,x=t.glslVersion?"#version "+t.glslVersion+`
`:"";t.isRawShaderMaterial?(m=["#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,f].filter(No).join(`
`),m.length>0&&(m+=`
`),g=["#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,f].filter(No).join(`
`),g.length>0&&(g+=`
`)):(m=[Np(t),"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,f,t.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",t.batching?"#define USE_BATCHING":"",t.batchingColor?"#define USE_BATCHING_COLOR":"",t.instancing?"#define USE_INSTANCING":"",t.instancingColor?"#define USE_INSTANCING_COLOR":"",t.instancingMorph?"#define USE_INSTANCING_MORPH":"",t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.map?"#define USE_MAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+h:"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",t.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",t.displacementMap?"#define USE_DISPLACEMENTMAP":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",t.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.alphaHash?"#define USE_ALPHAHASH":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",t.mapUv?"#define MAP_UV "+t.mapUv:"",t.alphaMapUv?"#define ALPHAMAP_UV "+t.alphaMapUv:"",t.lightMapUv?"#define LIGHTMAP_UV "+t.lightMapUv:"",t.aoMapUv?"#define AOMAP_UV "+t.aoMapUv:"",t.emissiveMapUv?"#define EMISSIVEMAP_UV "+t.emissiveMapUv:"",t.bumpMapUv?"#define BUMPMAP_UV "+t.bumpMapUv:"",t.normalMapUv?"#define NORMALMAP_UV "+t.normalMapUv:"",t.displacementMapUv?"#define DISPLACEMENTMAP_UV "+t.displacementMapUv:"",t.metalnessMapUv?"#define METALNESSMAP_UV "+t.metalnessMapUv:"",t.roughnessMapUv?"#define ROUGHNESSMAP_UV "+t.roughnessMapUv:"",t.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+t.anisotropyMapUv:"",t.clearcoatMapUv?"#define CLEARCOATMAP_UV "+t.clearcoatMapUv:"",t.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+t.clearcoatNormalMapUv:"",t.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+t.clearcoatRoughnessMapUv:"",t.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+t.iridescenceMapUv:"",t.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+t.iridescenceThicknessMapUv:"",t.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+t.sheenColorMapUv:"",t.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+t.sheenRoughnessMapUv:"",t.specularMapUv?"#define SPECULARMAP_UV "+t.specularMapUv:"",t.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+t.specularColorMapUv:"",t.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+t.specularIntensityMapUv:"",t.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+t.transmissionMapUv:"",t.thicknessMapUv?"#define THICKNESSMAP_UV "+t.thicknessMapUv:"",t.vertexTangents&&t.flatShading===!1?"#define USE_TANGENT":"",t.vertexColors?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUv1s?"#define USE_UV1":"",t.vertexUv2s?"#define USE_UV2":"",t.vertexUv3s?"#define USE_UV3":"",t.pointsUvs?"#define USE_POINTS_UV":"",t.flatShading?"#define FLAT_SHADED":"",t.skinning?"#define USE_SKINNING":"",t.morphTargets?"#define USE_MORPHTARGETS":"",t.morphNormals&&t.flatShading===!1?"#define USE_MORPHNORMALS":"",t.morphColors?"#define USE_MORPHCOLORS":"",t.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+t.morphTextureStride:"",t.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+t.morphTargetsCount:"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+r:"",t.sizeAttenuation?"#define USE_SIZEATTENUATION":"",t.numLightProbes>0?"#define USE_LIGHT_PROBES":"",t.logarithmicDepthBuffer?"#define USE_LOGARITHMIC_DEPTH_BUFFER":"",t.reversedDepthBuffer?"#define USE_REVERSED_DEPTH_BUFFER":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","	attribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","	attribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","	uniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","	attribute vec2 uv1;","#endif","#ifdef USE_UV2","	attribute vec2 uv2;","#endif","#ifdef USE_UV3","	attribute vec2 uv3;","#endif","#ifdef USE_TANGENT","	attribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","	attribute vec4 color;","#elif defined( USE_COLOR )","	attribute vec3 color;","#endif","#ifdef USE_SKINNING","	attribute vec4 skinIndex;","	attribute vec4 skinWeight;","#endif",`
`].filter(No).join(`
`),g=[Np(t),"#define SHADER_TYPE "+t.shaderType,"#define SHADER_NAME "+t.shaderName,f,t.useFog&&t.fog?"#define USE_FOG":"",t.useFog&&t.fogExp2?"#define FOG_EXP2":"",t.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",t.map?"#define USE_MAP":"",t.matcap?"#define USE_MATCAP":"",t.envMap?"#define USE_ENVMAP":"",t.envMap?"#define "+c:"",t.envMap?"#define "+h:"",t.envMap?"#define "+d:"",u?"#define CUBEUV_TEXEL_WIDTH "+u.texelWidth:"",u?"#define CUBEUV_TEXEL_HEIGHT "+u.texelHeight:"",u?"#define CUBEUV_MAX_MIP "+u.maxMip+".0":"",t.lightMap?"#define USE_LIGHTMAP":"",t.aoMap?"#define USE_AOMAP":"",t.bumpMap?"#define USE_BUMPMAP":"",t.normalMap?"#define USE_NORMALMAP":"",t.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",t.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",t.emissiveMap?"#define USE_EMISSIVEMAP":"",t.anisotropy?"#define USE_ANISOTROPY":"",t.anisotropyMap?"#define USE_ANISOTROPYMAP":"",t.clearcoat?"#define USE_CLEARCOAT":"",t.clearcoatMap?"#define USE_CLEARCOATMAP":"",t.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",t.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",t.dispersion?"#define USE_DISPERSION":"",t.iridescence?"#define USE_IRIDESCENCE":"",t.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",t.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",t.specularMap?"#define USE_SPECULARMAP":"",t.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",t.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",t.roughnessMap?"#define USE_ROUGHNESSMAP":"",t.metalnessMap?"#define USE_METALNESSMAP":"",t.alphaMap?"#define USE_ALPHAMAP":"",t.alphaTest?"#define USE_ALPHATEST":"",t.alphaHash?"#define USE_ALPHAHASH":"",t.sheen?"#define USE_SHEEN":"",t.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",t.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",t.transmission?"#define USE_TRANSMISSION":"",t.transmissionMap?"#define USE_TRANSMISSIONMAP":"",t.thicknessMap?"#define USE_THICKNESSMAP":"",t.vertexTangents&&t.flatShading===!1?"#define USE_TANGENT":"",t.vertexColors||t.instancingColor||t.batchingColor?"#define USE_COLOR":"",t.vertexAlphas?"#define USE_COLOR_ALPHA":"",t.vertexUv1s?"#define USE_UV1":"",t.vertexUv2s?"#define USE_UV2":"",t.vertexUv3s?"#define USE_UV3":"",t.pointsUvs?"#define USE_POINTS_UV":"",t.gradientMap?"#define USE_GRADIENTMAP":"",t.flatShading?"#define FLAT_SHADED":"",t.doubleSided?"#define DOUBLE_SIDED":"",t.flipSided?"#define FLIP_SIDED":"",t.shadowMapEnabled?"#define USE_SHADOWMAP":"",t.shadowMapEnabled?"#define "+r:"",t.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",t.numLightProbes>0?"#define USE_LIGHT_PROBES":"",t.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",t.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",t.logarithmicDepthBuffer?"#define USE_LOGARITHMIC_DEPTH_BUFFER":"",t.reversedDepthBuffer?"#define USE_REVERSED_DEPTH_BUFFER":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",t.toneMapping!==Ws?"#define TONE_MAPPING":"",t.toneMapping!==Ws?xt.tonemapping_pars_fragment:"",t.toneMapping!==Ws?r_("toneMapping",t.toneMapping):"",t.dithering?"#define DITHERING":"",t.opaque?"#define OPAQUE":"",xt.colorspace_pars_fragment,a_("linearToOutputTexel",t.outputColorSpace),l_(),t.useDepthPacking?"#define DEPTH_PACKING "+t.depthPacking:"",`
`].filter(No).join(`
`)),a=vd(a),a=Dp(a,t),a=Lp(a,t),o=vd(o),o=Dp(o,t),o=Lp(o,t),a=Op(a),o=Op(o),t.isRawShaderMaterial!==!0&&(x=`#version 300 es
`,m=[p,"#define attribute in","#define varying out","#define texture2D texture"].join(`
`)+`
`+m,g=["#define varying in",t.glslVersion===Au?"":"layout(location = 0) out highp vec4 pc_fragColor;",t.glslVersion===Au?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join(`
`)+`
`+g);const v=x+m+a,b=x+g+o,_=Ip(s,s.VERTEX_SHADER,v),S=Ip(s,s.FRAGMENT_SHADER,b);s.attachShader(y,_),s.attachShader(y,S),t.index0AttributeName!==void 0?s.bindAttribLocation(y,0,t.index0AttributeName):t.morphTargets===!0&&s.bindAttribLocation(y,0,"position"),s.linkProgram(y);function A(k){if(l.debug.checkShaderErrors){const L=s.getProgramInfoLog(y)||"",O=s.getShaderInfoLog(_)||"",W=s.getShaderInfoLog(S)||"",U=L.trim(),$=O.trim(),G=W.trim();let ee=!0,pe=!0;if(s.getProgramParameter(y,s.LINK_STATUS)===!1)if(ee=!1,typeof l.debug.onShaderError=="function")l.debug.onShaderError(s,y,_,S);else{const me=Pp(s,_,"vertex"),ve=Pp(s,S,"fragment");rt("THREE.WebGLProgram: Shader Error "+s.getError()+" - VALIDATE_STATUS "+s.getProgramParameter(y,s.VALIDATE_STATUS)+`

Material Name: `+k.name+`
Material Type: `+k.type+`

Program Info Log: `+U+`
`+me+`
`+ve)}else U!==""?Qe("WebGLProgram: Program Info Log:",U):($===""||G==="")&&(pe=!1);pe&&(k.diagnostics={runnable:ee,programLog:U,vertexShader:{log:$,prefix:m},fragmentShader:{log:G,prefix:g}})}s.deleteShader(_),s.deleteShader(S),R=new wl(s,y),M=d_(s,y)}let R;this.getUniforms=function(){return R===void 0&&A(this),R};let M;this.getAttributes=function(){return M===void 0&&A(this),M};let C=t.rendererExtensionParallelShaderCompile===!1;return this.isReady=function(){return C===!1&&(C=s.getProgramParameter(y,t_)),C},this.destroy=function(){i.releaseStatesOfProgram(this),s.deleteProgram(y),this.program=void 0},this.type=t.shaderType,this.name=t.shaderName,this.id=i_++,this.cacheKey=e,this.usedTimes=1,this.program=y,this.vertexShader=_,this.fragmentShader=S,this}let C_=0;class A_{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,i=e.fragmentShader,s=this._getShaderStage(t),n=this._getShaderStage(i),a=this._getShaderCacheForMaterial(e);return a.has(s)===!1&&(a.add(s),s.usedTimes++),a.has(n)===!1&&(a.add(n),n.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const i of t)i.usedTimes--,i.usedTimes===0&&this.shaderCache.delete(i.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let i=t.get(e);return i===void 0&&(i=new Set,t.set(e,i)),i}_getShaderStage(e){const t=this.shaderCache;let i=t.get(e);return i===void 0&&(i=new R_(e),t.set(e,i)),i}}class R_{constructor(e){this.id=C_++,this.code=e,this.usedTimes=0}}function I_(l,e,t,i,s,n,a){const o=new om,r=new A_,c=new Set,h=[],d=new Map,u=s.logarithmicDepthBuffer;let p=s.precision;const f={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distance",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function y(M){return c.add(M),M===0?"uv":`uv${M}`}function m(M,C,k,L,O){const W=L.fog,U=O.geometry,$=M.isMeshStandardMaterial?L.environment:null,G=(M.isMeshStandardMaterial?t:e).get(M.envMap||$),ee=G&&G.mapping===ql?G.image.height:null,pe=f[M.type];M.precision!==null&&(p=s.getMaxPrecision(M.precision),p!==M.precision&&Qe("WebGLProgram.getParameters:",M.precision,"not supported, using",p,"instead."));const me=U.morphAttributes.position||U.morphAttributes.normal||U.morphAttributes.color,ve=me!==void 0?me.length:0;let tt=0;U.morphAttributes.position!==void 0&&(tt=1),U.morphAttributes.normal!==void 0&&(tt=2),U.morphAttributes.color!==void 0&&(tt=3);let je,Ot,Nt,Z;if(pe){const qt=Bs[pe];je=qt.vertexShader,Ot=qt.fragmentShader}else je=M.vertexShader,Ot=M.fragmentShader,r.update(M),Nt=r.getVertexShaderID(M),Z=r.getFragmentShaderID(M);const se=l.getRenderTarget(),Pe=l.state.buffers.depth.getReversed(),Ze=O.isInstancedMesh===!0,Le=O.isBatchedMesh===!0,Ct=!!M.map,Bt=!!M.matcap,ht=!!G,J=!!M.aoMap,he=!!M.lightMap,oe=!!M.bumpMap,Se=!!M.normalMap,D=!!M.displacementMap,Ke=!!M.emissiveMap,Ae=!!M.metalnessMap,et=!!M.roughnessMap,ge=M.anisotropy>0,P=M.clearcoat>0,E=M.dispersion>0,N=M.iridescence>0,Y=M.sheen>0,te=M.transmission>0,K=ge&&!!M.anisotropyMap,He=P&&!!M.clearcoatMap,we=P&&!!M.clearcoatNormalMap,Ue=P&&!!M.clearcoatRoughnessMap,at=N&&!!M.iridescenceMap,de=N&&!!M.iridescenceThicknessMap,Te=Y&&!!M.sheenColorMap,Ge=Y&&!!M.sheenRoughnessMap,Ve=!!M.specularMap,Me=!!M.specularColorMap,_t=!!M.specularIntensityMap,z=te&&!!M.transmissionMap,De=te&&!!M.thicknessMap,ye=!!M.gradientMap,Ne=!!M.alphaMap,ue=M.alphaTest>0,ae=!!M.alphaHash,_e=!!M.extensions;let pt=Ws;M.toneMapped&&(se===null||se.isXRRenderTarget===!0)&&(pt=l.toneMapping);const jt={shaderID:pe,shaderType:M.type,shaderName:M.name,vertexShader:je,fragmentShader:Ot,defines:M.defines,customVertexShaderID:Nt,customFragmentShaderID:Z,isRawShaderMaterial:M.isRawShaderMaterial===!0,glslVersion:M.glslVersion,precision:p,batching:Le,batchingColor:Le&&O._colorsTexture!==null,instancing:Ze,instancingColor:Ze&&O.instanceColor!==null,instancingMorph:Ze&&O.morphTexture!==null,outputColorSpace:se===null?l.outputColorSpace:se.isXRRenderTarget===!0?se.texture.colorSpace:zi,alphaToCoverage:!!M.alphaToCoverage,map:Ct,matcap:Bt,envMap:ht,envMapMode:ht&&G.mapping,envMapCubeUVHeight:ee,aoMap:J,lightMap:he,bumpMap:oe,normalMap:Se,displacementMap:D,emissiveMap:Ke,normalMapObjectSpace:Se&&M.normalMapType===$0,normalMapTangentSpace:Se&&M.normalMapType===sm,metalnessMap:Ae,roughnessMap:et,anisotropy:ge,anisotropyMap:K,clearcoat:P,clearcoatMap:He,clearcoatNormalMap:we,clearcoatRoughnessMap:Ue,dispersion:E,iridescence:N,iridescenceMap:at,iridescenceThicknessMap:de,sheen:Y,sheenColorMap:Te,sheenRoughnessMap:Ge,specularMap:Ve,specularColorMap:Me,specularIntensityMap:_t,transmission:te,transmissionMap:z,thicknessMap:De,gradientMap:ye,opaque:M.transparent===!1&&M.blending===ta&&M.alphaToCoverage===!1,alphaMap:Ne,alphaTest:ue,alphaHash:ae,combine:M.combine,mapUv:Ct&&y(M.map.channel),aoMapUv:J&&y(M.aoMap.channel),lightMapUv:he&&y(M.lightMap.channel),bumpMapUv:oe&&y(M.bumpMap.channel),normalMapUv:Se&&y(M.normalMap.channel),displacementMapUv:D&&y(M.displacementMap.channel),emissiveMapUv:Ke&&y(M.emissiveMap.channel),metalnessMapUv:Ae&&y(M.metalnessMap.channel),roughnessMapUv:et&&y(M.roughnessMap.channel),anisotropyMapUv:K&&y(M.anisotropyMap.channel),clearcoatMapUv:He&&y(M.clearcoatMap.channel),clearcoatNormalMapUv:we&&y(M.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:Ue&&y(M.clearcoatRoughnessMap.channel),iridescenceMapUv:at&&y(M.iridescenceMap.channel),iridescenceThicknessMapUv:de&&y(M.iridescenceThicknessMap.channel),sheenColorMapUv:Te&&y(M.sheenColorMap.channel),sheenRoughnessMapUv:Ge&&y(M.sheenRoughnessMap.channel),specularMapUv:Ve&&y(M.specularMap.channel),specularColorMapUv:Me&&y(M.specularColorMap.channel),specularIntensityMapUv:_t&&y(M.specularIntensityMap.channel),transmissionMapUv:z&&y(M.transmissionMap.channel),thicknessMapUv:De&&y(M.thicknessMap.channel),alphaMapUv:Ne&&y(M.alphaMap.channel),vertexTangents:!!U.attributes.tangent&&(Se||ge),vertexColors:M.vertexColors,vertexAlphas:M.vertexColors===!0&&!!U.attributes.color&&U.attributes.color.itemSize===4,pointsUvs:O.isPoints===!0&&!!U.attributes.uv&&(Ct||Ne),fog:!!W,useFog:M.fog===!0,fogExp2:!!W&&W.isFogExp2,flatShading:M.flatShading===!0&&M.wireframe===!1,sizeAttenuation:M.sizeAttenuation===!0,logarithmicDepthBuffer:u,reversedDepthBuffer:Pe,skinning:O.isSkinnedMesh===!0,morphTargets:U.morphAttributes.position!==void 0,morphNormals:U.morphAttributes.normal!==void 0,morphColors:U.morphAttributes.color!==void 0,morphTargetsCount:ve,morphTextureStride:tt,numDirLights:C.directional.length,numPointLights:C.point.length,numSpotLights:C.spot.length,numSpotLightMaps:C.spotLightMap.length,numRectAreaLights:C.rectArea.length,numHemiLights:C.hemi.length,numDirLightShadows:C.directionalShadowMap.length,numPointLightShadows:C.pointShadowMap.length,numSpotLightShadows:C.spotShadowMap.length,numSpotLightShadowsWithMaps:C.numSpotLightShadowsWithMaps,numLightProbes:C.numLightProbes,numClippingPlanes:a.numPlanes,numClipIntersection:a.numIntersection,dithering:M.dithering,shadowMapEnabled:l.shadowMap.enabled&&k.length>0,shadowMapType:l.shadowMap.type,toneMapping:pt,decodeVideoTexture:Ct&&M.map.isVideoTexture===!0&&Rt.getTransfer(M.map.colorSpace)===Gt,decodeVideoTextureEmissive:Ke&&M.emissiveMap.isVideoTexture===!0&&Rt.getTransfer(M.emissiveMap.colorSpace)===Gt,premultipliedAlpha:M.premultipliedAlpha,doubleSided:M.side===lt,flipSided:M.side===wi,useDepthPacking:M.depthPacking>=0,depthPacking:M.depthPacking||0,index0AttributeName:M.index0AttributeName,extensionClipCullDistance:_e&&M.extensions.clipCullDistance===!0&&i.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(_e&&M.extensions.multiDraw===!0||Le)&&i.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:i.has("KHR_parallel_shader_compile"),customProgramCacheKey:M.customProgramCacheKey()};return jt.vertexUv1s=c.has(1),jt.vertexUv2s=c.has(2),jt.vertexUv3s=c.has(3),c.clear(),jt}function g(M){const C=[];if(M.shaderID?C.push(M.shaderID):(C.push(M.customVertexShaderID),C.push(M.customFragmentShaderID)),M.defines!==void 0)for(const k in M.defines)C.push(k),C.push(M.defines[k]);return M.isRawShaderMaterial===!1&&(x(C,M),v(C,M),C.push(l.outputColorSpace)),C.push(M.customProgramCacheKey),C.join()}function x(M,C){M.push(C.precision),M.push(C.outputColorSpace),M.push(C.envMapMode),M.push(C.envMapCubeUVHeight),M.push(C.mapUv),M.push(C.alphaMapUv),M.push(C.lightMapUv),M.push(C.aoMapUv),M.push(C.bumpMapUv),M.push(C.normalMapUv),M.push(C.displacementMapUv),M.push(C.emissiveMapUv),M.push(C.metalnessMapUv),M.push(C.roughnessMapUv),M.push(C.anisotropyMapUv),M.push(C.clearcoatMapUv),M.push(C.clearcoatNormalMapUv),M.push(C.clearcoatRoughnessMapUv),M.push(C.iridescenceMapUv),M.push(C.iridescenceThicknessMapUv),M.push(C.sheenColorMapUv),M.push(C.sheenRoughnessMapUv),M.push(C.specularMapUv),M.push(C.specularColorMapUv),M.push(C.specularIntensityMapUv),M.push(C.transmissionMapUv),M.push(C.thicknessMapUv),M.push(C.combine),M.push(C.fogExp2),M.push(C.sizeAttenuation),M.push(C.morphTargetsCount),M.push(C.morphAttributeCount),M.push(C.numDirLights),M.push(C.numPointLights),M.push(C.numSpotLights),M.push(C.numSpotLightMaps),M.push(C.numHemiLights),M.push(C.numRectAreaLights),M.push(C.numDirLightShadows),M.push(C.numPointLightShadows),M.push(C.numSpotLightShadows),M.push(C.numSpotLightShadowsWithMaps),M.push(C.numLightProbes),M.push(C.shadowMapType),M.push(C.toneMapping),M.push(C.numClippingPlanes),M.push(C.numClipIntersection),M.push(C.depthPacking)}function v(M,C){o.disableAll(),C.instancing&&o.enable(0),C.instancingColor&&o.enable(1),C.instancingMorph&&o.enable(2),C.matcap&&o.enable(3),C.envMap&&o.enable(4),C.normalMapObjectSpace&&o.enable(5),C.normalMapTangentSpace&&o.enable(6),C.clearcoat&&o.enable(7),C.iridescence&&o.enable(8),C.alphaTest&&o.enable(9),C.vertexColors&&o.enable(10),C.vertexAlphas&&o.enable(11),C.vertexUv1s&&o.enable(12),C.vertexUv2s&&o.enable(13),C.vertexUv3s&&o.enable(14),C.vertexTangents&&o.enable(15),C.anisotropy&&o.enable(16),C.alphaHash&&o.enable(17),C.batching&&o.enable(18),C.dispersion&&o.enable(19),C.batchingColor&&o.enable(20),C.gradientMap&&o.enable(21),M.push(o.mask),o.disableAll(),C.fog&&o.enable(0),C.useFog&&o.enable(1),C.flatShading&&o.enable(2),C.logarithmicDepthBuffer&&o.enable(3),C.reversedDepthBuffer&&o.enable(4),C.skinning&&o.enable(5),C.morphTargets&&o.enable(6),C.morphNormals&&o.enable(7),C.morphColors&&o.enable(8),C.premultipliedAlpha&&o.enable(9),C.shadowMapEnabled&&o.enable(10),C.doubleSided&&o.enable(11),C.flipSided&&o.enable(12),C.useDepthPacking&&o.enable(13),C.dithering&&o.enable(14),C.transmission&&o.enable(15),C.sheen&&o.enable(16),C.opaque&&o.enable(17),C.pointsUvs&&o.enable(18),C.decodeVideoTexture&&o.enable(19),C.decodeVideoTextureEmissive&&o.enable(20),C.alphaToCoverage&&o.enable(21),M.push(o.mask)}function b(M){const C=f[M.type];let k;if(C){const L=Bs[C];k=tr.clone(L.uniforms)}else k=M.uniforms;return k}function _(M,C){let k=d.get(C);return k!==void 0?++k.usedTimes:(k=new E_(l,C,M,n),h.push(k),d.set(C,k)),k}function S(M){if(--M.usedTimes===0){const C=h.indexOf(M);h[C]=h[h.length-1],h.pop(),d.delete(M.cacheKey),M.destroy()}}function A(M){r.remove(M)}function R(){r.dispose()}return{getParameters:m,getProgramCacheKey:g,getUniforms:b,acquireProgram:_,releaseProgram:S,releaseShaderCache:A,programs:h,dispose:R}}function k_(){let l=new WeakMap;function e(a){return l.has(a)}function t(a){let o=l.get(a);return o===void 0&&(o={},l.set(a,o)),o}function i(a){l.delete(a)}function s(a,o,r){l.get(a)[o]=r}function n(){l=new WeakMap}return{has:e,get:t,remove:i,update:s,dispose:n}}function P_(l,e){return l.groupOrder!==e.groupOrder?l.groupOrder-e.groupOrder:l.renderOrder!==e.renderOrder?l.renderOrder-e.renderOrder:l.material.id!==e.material.id?l.material.id-e.material.id:l.z!==e.z?l.z-e.z:l.id-e.id}function Bp(l,e){return l.groupOrder!==e.groupOrder?l.groupOrder-e.groupOrder:l.renderOrder!==e.renderOrder?l.renderOrder-e.renderOrder:l.z!==e.z?e.z-l.z:l.id-e.id}function zp(){const l=[];let e=0;const t=[],i=[],s=[];function n(){e=0,t.length=0,i.length=0,s.length=0}function a(d,u,p,f,y,m){let g=l[e];return g===void 0?(g={id:d.id,object:d,geometry:u,material:p,groupOrder:f,renderOrder:d.renderOrder,z:y,group:m},l[e]=g):(g.id=d.id,g.object=d,g.geometry=u,g.material=p,g.groupOrder=f,g.renderOrder=d.renderOrder,g.z=y,g.group=m),e++,g}function o(d,u,p,f,y,m){const g=a(d,u,p,f,y,m);p.transmission>0?i.push(g):p.transparent===!0?s.push(g):t.push(g)}function r(d,u,p,f,y,m){const g=a(d,u,p,f,y,m);p.transmission>0?i.unshift(g):p.transparent===!0?s.unshift(g):t.unshift(g)}function c(d,u){t.length>1&&t.sort(d||P_),i.length>1&&i.sort(u||Bp),s.length>1&&s.sort(u||Bp)}function h(){for(let d=e,u=l.length;d<u;d++){const p=l[d];if(p.id===null)break;p.id=null,p.object=null,p.geometry=null,p.material=null,p.group=null}}return{opaque:t,transmissive:i,transparent:s,init:n,push:o,unshift:r,finish:h,sort:c}}function D_(){let l=new WeakMap;function e(i,s){const n=l.get(i);let a;return n===void 0?(a=new zp,l.set(i,[a])):s>=n.length?(a=new zp,n.push(a)):a=n[s],a}function t(){l=new WeakMap}return{get:e,dispose:t}}function L_(){const l={};return{get:function(e){if(l[e.id]!==void 0)return l[e.id];let t;switch(e.type){case"DirectionalLight":t={direction:new T,color:new H};break;case"SpotLight":t={position:new T,direction:new T,color:new H,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":t={position:new T,color:new H,distance:0,decay:0};break;case"HemisphereLight":t={direction:new T,skyColor:new H,groundColor:new H};break;case"RectAreaLight":t={color:new H,position:new T,halfWidth:new T,halfHeight:new T};break}return l[e.id]=t,t}}}function O_(){const l={};return{get:function(e){if(l[e.id]!==void 0)return l[e.id];let t;switch(e.type){case"DirectionalLight":t={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new le};break;case"SpotLight":t={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new le};break;case"PointLight":t={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new le,shadowCameraNear:1,shadowCameraFar:1e3};break}return l[e.id]=t,t}}}let N_=0;function B_(l,e){return(e.castShadow?2:0)-(l.castShadow?2:0)+(e.map?1:0)-(l.map?1:0)}function z_(l){const e=new L_,t=O_(),i={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let c=0;c<9;c++)i.probe.push(new T);const s=new T,n=new ut,a=new ut;function o(c){let h=0,d=0,u=0;for(let M=0;M<9;M++)i.probe[M].set(0,0,0);let p=0,f=0,y=0,m=0,g=0,x=0,v=0,b=0,_=0,S=0,A=0;c.sort(B_);for(let M=0,C=c.length;M<C;M++){const k=c[M],L=k.color,O=k.intensity,W=k.distance;let U=null;if(k.shadow&&k.shadow.map&&(k.shadow.map.texture.format===$a?U=k.shadow.map.texture:U=k.shadow.map.depthTexture||k.shadow.map.texture),k.isAmbientLight)h+=L.r*O,d+=L.g*O,u+=L.b*O;else if(k.isLightProbe){for(let $=0;$<9;$++)i.probe[$].addScaledVector(k.sh.coefficients[$],O);A++}else if(k.isDirectionalLight){const $=e.get(k);if($.color.copy(k.color).multiplyScalar(k.intensity),k.castShadow){const G=k.shadow,ee=t.get(k);ee.shadowIntensity=G.intensity,ee.shadowBias=G.bias,ee.shadowNormalBias=G.normalBias,ee.shadowRadius=G.radius,ee.shadowMapSize=G.mapSize,i.directionalShadow[p]=ee,i.directionalShadowMap[p]=U,i.directionalShadowMatrix[p]=k.shadow.matrix,x++}i.directional[p]=$,p++}else if(k.isSpotLight){const $=e.get(k);$.position.setFromMatrixPosition(k.matrixWorld),$.color.copy(L).multiplyScalar(O),$.distance=W,$.coneCos=Math.cos(k.angle),$.penumbraCos=Math.cos(k.angle*(1-k.penumbra)),$.decay=k.decay,i.spot[y]=$;const G=k.shadow;if(k.map&&(i.spotLightMap[_]=k.map,_++,G.updateMatrices(k),k.castShadow&&S++),i.spotLightMatrix[y]=G.matrix,k.castShadow){const ee=t.get(k);ee.shadowIntensity=G.intensity,ee.shadowBias=G.bias,ee.shadowNormalBias=G.normalBias,ee.shadowRadius=G.radius,ee.shadowMapSize=G.mapSize,i.spotShadow[y]=ee,i.spotShadowMap[y]=U,b++}y++}else if(k.isRectAreaLight){const $=e.get(k);$.color.copy(L).multiplyScalar(O),$.halfWidth.set(k.width*.5,0,0),$.halfHeight.set(0,k.height*.5,0),i.rectArea[m]=$,m++}else if(k.isPointLight){const $=e.get(k);if($.color.copy(k.color).multiplyScalar(k.intensity),$.distance=k.distance,$.decay=k.decay,k.castShadow){const G=k.shadow,ee=t.get(k);ee.shadowIntensity=G.intensity,ee.shadowBias=G.bias,ee.shadowNormalBias=G.normalBias,ee.shadowRadius=G.radius,ee.shadowMapSize=G.mapSize,ee.shadowCameraNear=G.camera.near,ee.shadowCameraFar=G.camera.far,i.pointShadow[f]=ee,i.pointShadowMap[f]=U,i.pointShadowMatrix[f]=k.shadow.matrix,v++}i.point[f]=$,f++}else if(k.isHemisphereLight){const $=e.get(k);$.skyColor.copy(k.color).multiplyScalar(O),$.groundColor.copy(k.groundColor).multiplyScalar(O),i.hemi[g]=$,g++}}m>0&&(l.has("OES_texture_float_linear")===!0?(i.rectAreaLTC1=Ce.LTC_FLOAT_1,i.rectAreaLTC2=Ce.LTC_FLOAT_2):(i.rectAreaLTC1=Ce.LTC_HALF_1,i.rectAreaLTC2=Ce.LTC_HALF_2)),i.ambient[0]=h,i.ambient[1]=d,i.ambient[2]=u;const R=i.hash;(R.directionalLength!==p||R.pointLength!==f||R.spotLength!==y||R.rectAreaLength!==m||R.hemiLength!==g||R.numDirectionalShadows!==x||R.numPointShadows!==v||R.numSpotShadows!==b||R.numSpotMaps!==_||R.numLightProbes!==A)&&(i.directional.length=p,i.spot.length=y,i.rectArea.length=m,i.point.length=f,i.hemi.length=g,i.directionalShadow.length=x,i.directionalShadowMap.length=x,i.pointShadow.length=v,i.pointShadowMap.length=v,i.spotShadow.length=b,i.spotShadowMap.length=b,i.directionalShadowMatrix.length=x,i.pointShadowMatrix.length=v,i.spotLightMatrix.length=b+_-S,i.spotLightMap.length=_,i.numSpotLightShadowsWithMaps=S,i.numLightProbes=A,R.directionalLength=p,R.pointLength=f,R.spotLength=y,R.rectAreaLength=m,R.hemiLength=g,R.numDirectionalShadows=x,R.numPointShadows=v,R.numSpotShadows=b,R.numSpotMaps=_,R.numLightProbes=A,i.version=N_++)}function r(c,h){let d=0,u=0,p=0,f=0,y=0;const m=h.matrixWorldInverse;for(let g=0,x=c.length;g<x;g++){const v=c[g];if(v.isDirectionalLight){const b=i.directional[d];b.direction.setFromMatrixPosition(v.matrixWorld),s.setFromMatrixPosition(v.target.matrixWorld),b.direction.sub(s),b.direction.transformDirection(m),d++}else if(v.isSpotLight){const b=i.spot[p];b.position.setFromMatrixPosition(v.matrixWorld),b.position.applyMatrix4(m),b.direction.setFromMatrixPosition(v.matrixWorld),s.setFromMatrixPosition(v.target.matrixWorld),b.direction.sub(s),b.direction.transformDirection(m),p++}else if(v.isRectAreaLight){const b=i.rectArea[f];b.position.setFromMatrixPosition(v.matrixWorld),b.position.applyMatrix4(m),a.identity(),n.copy(v.matrixWorld),n.premultiply(m),a.extractRotation(n),b.halfWidth.set(v.width*.5,0,0),b.halfHeight.set(0,v.height*.5,0),b.halfWidth.applyMatrix4(a),b.halfHeight.applyMatrix4(a),f++}else if(v.isPointLight){const b=i.point[u];b.position.setFromMatrixPosition(v.matrixWorld),b.position.applyMatrix4(m),u++}else if(v.isHemisphereLight){const b=i.hemi[y];b.direction.setFromMatrixPosition(v.matrixWorld),b.direction.transformDirection(m),y++}}}return{setup:o,setupView:r,state:i}}function Fp(l){const e=new z_(l),t=[],i=[];function s(h){c.camera=h,t.length=0,i.length=0}function n(h){t.push(h)}function a(h){i.push(h)}function o(){e.setup(t)}function r(h){e.setupView(t,h)}const c={lightsArray:t,shadowsArray:i,camera:null,lights:e,transmissionRenderTarget:{}};return{init:s,state:c,setupLights:o,setupLightsView:r,pushLight:n,pushShadow:a}}function F_(l){let e=new WeakMap;function t(s,n=0){const a=e.get(s);let o;return a===void 0?(o=new Fp(l),e.set(s,[o])):n>=a.length?(o=new Fp(l),a.push(o)):o=a[n],o}function i(){e=new WeakMap}return{get:t,dispose:i}}const U_=`void main() {
	gl_Position = vec4( position, 1.0 );
}`,G_=`uniform sampler2D shadow_pass;
uniform vec2 resolution;
uniform float radius;
void main() {
	const float samples = float( VSM_SAMPLES );
	float mean = 0.0;
	float squared_mean = 0.0;
	float uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );
	float uvStart = samples <= 1.0 ? 0.0 : - 1.0;
	for ( float i = 0.0; i < samples; i ++ ) {
		float uvOffset = uvStart + i * uvStride;
		#ifdef HORIZONTAL_PASS
			vec2 distribution = texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ).rg;
			mean += distribution.x;
			squared_mean += distribution.y * distribution.y + distribution.x * distribution.x;
		#else
			float depth = texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ).r;
			mean += depth;
			squared_mean += depth * depth;
		#endif
	}
	mean = mean / samples;
	squared_mean = squared_mean / samples;
	float std_dev = sqrt( max( 0.0, squared_mean - mean * mean ) );
	gl_FragColor = vec4( mean, std_dev, 0.0, 1.0 );
}`,H_=[new T(1,0,0),new T(-1,0,0),new T(0,1,0),new T(0,-1,0),new T(0,0,1),new T(0,0,-1)],q_=[new T(0,-1,0),new T(0,-1,0),new T(0,0,1),new T(0,0,-1),new T(0,-1,0),new T(0,-1,0)],Up=new ut,To=new T,Uc=new T;function W_(l,e,t){let i=new jd;const s=new le,n=new le,a=new ni,o=new ky,r=new Py,c={},h=t.maxTextureSize,d={[Xs]:wi,[wi]:Xs,[lt]:lt},u=new Ci({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new le},radius:{value:4}},vertexShader:U_,fragmentShader:G_}),p=u.clone();p.defines.HORIZONTAL_PASS=1;const f=new mt;f.setAttribute("position",new Je(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const y=new w(f,u),m=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=ml;let g=this.type;this.render=function(S,A,R){if(m.enabled===!1||m.autoUpdate===!1&&m.needsUpdate===!1||S.length===0)return;S.type===Wf&&(Qe("WebGLShadowMap: PCFSoftShadowMap has been deprecated. Using PCFShadowMap instead."),S.type=ml);const M=l.getRenderTarget(),C=l.getActiveCubeFace(),k=l.getActiveMipmapLevel(),L=l.state;L.setBlending(qs),L.buffers.depth.getReversed()===!0?L.buffers.color.setClear(0,0,0,0):L.buffers.color.setClear(1,1,1,1),L.buffers.depth.setTest(!0),L.setScissorTest(!1);const O=g!==this.type;O&&A.traverse(function(W){W.material&&(Array.isArray(W.material)?W.material.forEach(U=>U.needsUpdate=!0):W.material.needsUpdate=!0)});for(let W=0,U=S.length;W<U;W++){const $=S[W],G=$.shadow;if(G===void 0){Qe("WebGLShadowMap:",$,"has no shadow.");continue}if(G.autoUpdate===!1&&G.needsUpdate===!1)continue;s.copy(G.mapSize);const ee=G.getFrameExtents();if(s.multiply(ee),n.copy(G.mapSize),(s.x>h||s.y>h)&&(s.x>h&&(n.x=Math.floor(h/ee.x),s.x=n.x*ee.x,G.mapSize.x=n.x),s.y>h&&(n.y=Math.floor(h/ee.y),s.y=n.y*ee.y,G.mapSize.y=n.y)),G.map===null||O===!0){if(G.map!==null&&(G.map.depthTexture!==null&&(G.map.depthTexture.dispose(),G.map.depthTexture=null),G.map.dispose()),this.type===Do){if($.isPointLight){Qe("WebGLShadowMap: VSM shadow maps are not supported for PointLights. Use PCF or BasicShadowMap instead.");continue}G.map=new ji(s.x,s.y,{format:$a,type:cs,minFilter:bi,magFilter:bi,generateMipmaps:!1}),G.map.texture.name=$.name+".shadowMap",G.map.depthTexture=new ir(s.x,s.y,vs),G.map.depthTexture.name=$.name+".shadowMapDepth",G.map.depthTexture.format=yn,G.map.depthTexture.compareFunction=null,G.map.depthTexture.minFilter=xi,G.map.depthTexture.magFilter=xi}else{$.isPointLight?(G.map=new pm(s.x),G.map.depthTexture=new jg(s.x,Qs)):(G.map=new ji(s.x,s.y),G.map.depthTexture=new ir(s.x,s.y,Qs)),G.map.depthTexture.name=$.name+".shadowMap",G.map.depthTexture.format=yn;const me=l.state.buffers.depth.getReversed();this.type===ml?(G.map.depthTexture.compareFunction=me?qd:Hd,G.map.depthTexture.minFilter=bi,G.map.depthTexture.magFilter=bi):(G.map.depthTexture.compareFunction=null,G.map.depthTexture.minFilter=xi,G.map.depthTexture.magFilter=xi)}G.camera.updateProjectionMatrix()}const pe=G.map.isWebGLCubeRenderTarget?6:1;for(let me=0;me<pe;me++){if(G.map.isWebGLCubeRenderTarget)l.setRenderTarget(G.map,me),l.clear();else{me===0&&(l.setRenderTarget(G.map),l.clear());const ve=G.getViewport(me);a.set(n.x*ve.x,n.y*ve.y,n.x*ve.z,n.y*ve.w),L.viewport(a)}if($.isPointLight){const ve=G.camera,tt=G.matrix,je=$.distance||ve.far;je!==ve.far&&(ve.far=je,ve.updateProjectionMatrix()),To.setFromMatrixPosition($.matrixWorld),ve.position.copy(To),Uc.copy(ve.position),Uc.add(H_[me]),ve.up.copy(q_[me]),ve.lookAt(Uc),ve.updateMatrixWorld(),tt.makeTranslation(-To.x,-To.y,-To.z),Up.multiplyMatrices(ve.projectionMatrix,ve.matrixWorldInverse),G._frustum.setFromProjectionMatrix(Up,ve.coordinateSystem,ve.reversedDepth)}else G.updateMatrices($);i=G.getFrustum(),b(A,R,G.camera,$,this.type)}G.isPointLightShadow!==!0&&this.type===Do&&x(G,R),G.needsUpdate=!1}g=this.type,m.needsUpdate=!1,l.setRenderTarget(M,C,k)};function x(S,A){const R=e.update(y);u.defines.VSM_SAMPLES!==S.blurSamples&&(u.defines.VSM_SAMPLES=S.blurSamples,p.defines.VSM_SAMPLES=S.blurSamples,u.needsUpdate=!0,p.needsUpdate=!0),S.mapPass===null&&(S.mapPass=new ji(s.x,s.y,{format:$a,type:cs})),u.uniforms.shadow_pass.value=S.map.depthTexture,u.uniforms.resolution.value=S.mapSize,u.uniforms.radius.value=S.radius,l.setRenderTarget(S.mapPass),l.clear(),l.renderBufferDirect(A,null,R,u,y,null),p.uniforms.shadow_pass.value=S.mapPass.texture,p.uniforms.resolution.value=S.mapSize,p.uniforms.radius.value=S.radius,l.setRenderTarget(S.map),l.clear(),l.renderBufferDirect(A,null,R,p,y,null)}function v(S,A,R,M){let C=null;const k=R.isPointLight===!0?S.customDistanceMaterial:S.customDepthMaterial;if(k!==void 0)C=k;else if(C=R.isPointLight===!0?r:o,l.localClippingEnabled&&A.clipShadows===!0&&Array.isArray(A.clippingPlanes)&&A.clippingPlanes.length!==0||A.displacementMap&&A.displacementScale!==0||A.alphaMap&&A.alphaTest>0||A.map&&A.alphaTest>0||A.alphaToCoverage===!0){const L=C.uuid,O=A.uuid;let W=c[L];W===void 0&&(W={},c[L]=W);let U=W[O];U===void 0&&(U=C.clone(),W[O]=U,A.addEventListener("dispose",_)),C=U}if(C.visible=A.visible,C.wireframe=A.wireframe,M===Do?C.side=A.shadowSide!==null?A.shadowSide:A.side:C.side=A.shadowSide!==null?A.shadowSide:d[A.side],C.alphaMap=A.alphaMap,C.alphaTest=A.alphaToCoverage===!0?.5:A.alphaTest,C.map=A.map,C.clipShadows=A.clipShadows,C.clippingPlanes=A.clippingPlanes,C.clipIntersection=A.clipIntersection,C.displacementMap=A.displacementMap,C.displacementScale=A.displacementScale,C.displacementBias=A.displacementBias,C.wireframeLinewidth=A.wireframeLinewidth,C.linewidth=A.linewidth,R.isPointLight===!0&&C.isMeshDistanceMaterial===!0){const L=l.properties.get(C);L.light=R}return C}function b(S,A,R,M,C){if(S.visible===!1)return;if(S.layers.test(A.layers)&&(S.isMesh||S.isLine||S.isPoints)&&(S.castShadow||S.receiveShadow&&C===Do)&&(!S.frustumCulled||i.intersectsObject(S))){S.modelViewMatrix.multiplyMatrices(R.matrixWorldInverse,S.matrixWorld);const O=e.update(S),W=S.material;if(Array.isArray(W)){const U=O.groups;for(let $=0,G=U.length;$<G;$++){const ee=U[$],pe=W[ee.materialIndex];if(pe&&pe.visible){const me=v(S,pe,M,C);S.onBeforeShadow(l,S,A,R,O,me,ee),l.renderBufferDirect(R,null,O,me,S,ee),S.onAfterShadow(l,S,A,R,O,me,ee)}}}else if(W.visible){const U=v(S,W,M,C);S.onBeforeShadow(l,S,A,R,O,U,null),l.renderBufferDirect(R,null,O,U,S,null),S.onAfterShadow(l,S,A,R,O,U,null)}}const L=S.children;for(let O=0,W=L.length;O<W;O++)b(L[O],A,R,M,C)}function _(S){S.target.removeEventListener("dispose",_);for(const R in c){const M=c[R],C=S.target.uuid;C in M&&(M[C].dispose(),delete M[C])}}}const V_={[wh]:_h,[Mh]:Eh,[Sh]:Ch,[Wa]:Th,[_h]:wh,[Eh]:Mh,[Ch]:Sh,[Th]:Wa};function $_(l,e){function t(){let z=!1;const De=new ni;let ye=null;const Ne=new ni(0,0,0,0);return{setMask:function(ue){ye!==ue&&!z&&(l.colorMask(ue,ue,ue,ue),ye=ue)},setLocked:function(ue){z=ue},setClear:function(ue,ae,_e,pt,jt){jt===!0&&(ue*=pt,ae*=pt,_e*=pt),De.set(ue,ae,_e,pt),Ne.equals(De)===!1&&(l.clearColor(ue,ae,_e,pt),Ne.copy(De))},reset:function(){z=!1,ye=null,Ne.set(-1,0,0,0)}}}function i(){let z=!1,De=!1,ye=null,Ne=null,ue=null;return{setReversed:function(ae){if(De!==ae){const _e=e.get("EXT_clip_control");ae?_e.clipControlEXT(_e.LOWER_LEFT_EXT,_e.ZERO_TO_ONE_EXT):_e.clipControlEXT(_e.LOWER_LEFT_EXT,_e.NEGATIVE_ONE_TO_ONE_EXT),De=ae;const pt=ue;ue=null,this.setClear(pt)}},getReversed:function(){return De},setTest:function(ae){ae?se(l.DEPTH_TEST):Pe(l.DEPTH_TEST)},setMask:function(ae){ye!==ae&&!z&&(l.depthMask(ae),ye=ae)},setFunc:function(ae){if(De&&(ae=V_[ae]),Ne!==ae){switch(ae){case wh:l.depthFunc(l.NEVER);break;case _h:l.depthFunc(l.ALWAYS);break;case Mh:l.depthFunc(l.LESS);break;case Wa:l.depthFunc(l.LEQUAL);break;case Sh:l.depthFunc(l.EQUAL);break;case Th:l.depthFunc(l.GEQUAL);break;case Eh:l.depthFunc(l.GREATER);break;case Ch:l.depthFunc(l.NOTEQUAL);break;default:l.depthFunc(l.LEQUAL)}Ne=ae}},setLocked:function(ae){z=ae},setClear:function(ae){ue!==ae&&(De&&(ae=1-ae),l.clearDepth(ae),ue=ae)},reset:function(){z=!1,ye=null,Ne=null,ue=null,De=!1}}}function s(){let z=!1,De=null,ye=null,Ne=null,ue=null,ae=null,_e=null,pt=null,jt=null;return{setTest:function(qt){z||(qt?se(l.STENCIL_TEST):Pe(l.STENCIL_TEST))},setMask:function(qt){De!==qt&&!z&&(l.stencilMask(qt),De=qt)},setFunc:function(qt,Is,tn){(ye!==qt||Ne!==Is||ue!==tn)&&(l.stencilFunc(qt,Is,tn),ye=qt,Ne=Is,ue=tn)},setOp:function(qt,Is,tn){(ae!==qt||_e!==Is||pt!==tn)&&(l.stencilOp(qt,Is,tn),ae=qt,_e=Is,pt=tn)},setLocked:function(qt){z=qt},setClear:function(qt){jt!==qt&&(l.clearStencil(qt),jt=qt)},reset:function(){z=!1,De=null,ye=null,Ne=null,ue=null,ae=null,_e=null,pt=null,jt=null}}}const n=new t,a=new i,o=new s,r=new WeakMap,c=new WeakMap;let h={},d={},u=new WeakMap,p=[],f=null,y=!1,m=null,g=null,x=null,v=null,b=null,_=null,S=null,A=new H(0,0,0),R=0,M=!1,C=null,k=null,L=null,O=null,W=null;const U=l.getParameter(l.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let $=!1,G=0;const ee=l.getParameter(l.VERSION);ee.indexOf("WebGL")!==-1?(G=parseFloat(/^WebGL (\d)/.exec(ee)[1]),$=G>=1):ee.indexOf("OpenGL ES")!==-1&&(G=parseFloat(/^OpenGL ES (\d)/.exec(ee)[1]),$=G>=2);let pe=null,me={};const ve=l.getParameter(l.SCISSOR_BOX),tt=l.getParameter(l.VIEWPORT),je=new ni().fromArray(ve),Ot=new ni().fromArray(tt);function Nt(z,De,ye,Ne){const ue=new Uint8Array(4),ae=l.createTexture();l.bindTexture(z,ae),l.texParameteri(z,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(z,l.TEXTURE_MAG_FILTER,l.NEAREST);for(let _e=0;_e<ye;_e++)z===l.TEXTURE_3D||z===l.TEXTURE_2D_ARRAY?l.texImage3D(De,0,l.RGBA,1,1,Ne,0,l.RGBA,l.UNSIGNED_BYTE,ue):l.texImage2D(De+_e,0,l.RGBA,1,1,0,l.RGBA,l.UNSIGNED_BYTE,ue);return ae}const Z={};Z[l.TEXTURE_2D]=Nt(l.TEXTURE_2D,l.TEXTURE_2D,1),Z[l.TEXTURE_CUBE_MAP]=Nt(l.TEXTURE_CUBE_MAP,l.TEXTURE_CUBE_MAP_POSITIVE_X,6),Z[l.TEXTURE_2D_ARRAY]=Nt(l.TEXTURE_2D_ARRAY,l.TEXTURE_2D_ARRAY,1,1),Z[l.TEXTURE_3D]=Nt(l.TEXTURE_3D,l.TEXTURE_3D,1,1),n.setClear(0,0,0,1),a.setClear(1),o.setClear(0),se(l.DEPTH_TEST),a.setFunc(Wa),oe(!1),Se(Mu),se(l.CULL_FACE),J(qs);function se(z){h[z]!==!0&&(l.enable(z),h[z]=!0)}function Pe(z){h[z]!==!1&&(l.disable(z),h[z]=!1)}function Ze(z,De){return d[z]!==De?(l.bindFramebuffer(z,De),d[z]=De,z===l.DRAW_FRAMEBUFFER&&(d[l.FRAMEBUFFER]=De),z===l.FRAMEBUFFER&&(d[l.DRAW_FRAMEBUFFER]=De),!0):!1}function Le(z,De){let ye=p,Ne=!1;if(z){ye=u.get(De),ye===void 0&&(ye=[],u.set(De,ye));const ue=z.textures;if(ye.length!==ue.length||ye[0]!==l.COLOR_ATTACHMENT0){for(let ae=0,_e=ue.length;ae<_e;ae++)ye[ae]=l.COLOR_ATTACHMENT0+ae;ye.length=ue.length,Ne=!0}}else ye[0]!==l.BACK&&(ye[0]=l.BACK,Ne=!0);Ne&&l.drawBuffers(ye)}function Ct(z){return f!==z?(l.useProgram(z),f=z,!0):!1}const Bt={[Kn]:l.FUNC_ADD,[_0]:l.FUNC_SUBTRACT,[M0]:l.FUNC_REVERSE_SUBTRACT};Bt[S0]=l.MIN,Bt[T0]=l.MAX;const ht={[E0]:l.ZERO,[C0]:l.ONE,[A0]:l.SRC_COLOR,[xh]:l.SRC_ALPHA,[L0]:l.SRC_ALPHA_SATURATE,[P0]:l.DST_COLOR,[I0]:l.DST_ALPHA,[R0]:l.ONE_MINUS_SRC_COLOR,[bh]:l.ONE_MINUS_SRC_ALPHA,[D0]:l.ONE_MINUS_DST_COLOR,[k0]:l.ONE_MINUS_DST_ALPHA,[O0]:l.CONSTANT_COLOR,[N0]:l.ONE_MINUS_CONSTANT_COLOR,[B0]:l.CONSTANT_ALPHA,[z0]:l.ONE_MINUS_CONSTANT_ALPHA};function J(z,De,ye,Ne,ue,ae,_e,pt,jt,qt){if(z===qs){y===!0&&(Pe(l.BLEND),y=!1);return}if(y===!1&&(se(l.BLEND),y=!0),z!==w0){if(z!==m||qt!==M){if((g!==Kn||b!==Kn)&&(l.blendEquation(l.FUNC_ADD),g=Kn,b=Kn),qt)switch(z){case ta:l.blendFuncSeparate(l.ONE,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case ui:l.blendFunc(l.ONE,l.ONE);break;case Su:l.blendFuncSeparate(l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ZERO,l.ONE);break;case Tu:l.blendFuncSeparate(l.DST_COLOR,l.ONE_MINUS_SRC_ALPHA,l.ZERO,l.ONE);break;default:rt("WebGLState: Invalid blending: ",z);break}else switch(z){case ta:l.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case ui:l.blendFuncSeparate(l.SRC_ALPHA,l.ONE,l.ONE,l.ONE);break;case Su:rt("WebGLState: SubtractiveBlending requires material.premultipliedAlpha = true");break;case Tu:rt("WebGLState: MultiplyBlending requires material.premultipliedAlpha = true");break;default:rt("WebGLState: Invalid blending: ",z);break}x=null,v=null,_=null,S=null,A.set(0,0,0),R=0,m=z,M=qt}return}ue=ue||De,ae=ae||ye,_e=_e||Ne,(De!==g||ue!==b)&&(l.blendEquationSeparate(Bt[De],Bt[ue]),g=De,b=ue),(ye!==x||Ne!==v||ae!==_||_e!==S)&&(l.blendFuncSeparate(ht[ye],ht[Ne],ht[ae],ht[_e]),x=ye,v=Ne,_=ae,S=_e),(pt.equals(A)===!1||jt!==R)&&(l.blendColor(pt.r,pt.g,pt.b,jt),A.copy(pt),R=jt),m=z,M=!1}function he(z,De){z.side===lt?Pe(l.CULL_FACE):se(l.CULL_FACE);let ye=z.side===wi;De&&(ye=!ye),oe(ye),z.blending===ta&&z.transparent===!1?J(qs):J(z.blending,z.blendEquation,z.blendSrc,z.blendDst,z.blendEquationAlpha,z.blendSrcAlpha,z.blendDstAlpha,z.blendColor,z.blendAlpha,z.premultipliedAlpha),a.setFunc(z.depthFunc),a.setTest(z.depthTest),a.setMask(z.depthWrite),n.setMask(z.colorWrite);const Ne=z.stencilWrite;o.setTest(Ne),Ne&&(o.setMask(z.stencilWriteMask),o.setFunc(z.stencilFunc,z.stencilRef,z.stencilFuncMask),o.setOp(z.stencilFail,z.stencilZFail,z.stencilZPass)),Ke(z.polygonOffset,z.polygonOffsetFactor,z.polygonOffsetUnits),z.alphaToCoverage===!0?se(l.SAMPLE_ALPHA_TO_COVERAGE):Pe(l.SAMPLE_ALPHA_TO_COVERAGE)}function oe(z){C!==z&&(z?l.frontFace(l.CW):l.frontFace(l.CCW),C=z)}function Se(z){z!==x0?(se(l.CULL_FACE),z!==k&&(z===Mu?l.cullFace(l.BACK):z===b0?l.cullFace(l.FRONT):l.cullFace(l.FRONT_AND_BACK))):Pe(l.CULL_FACE),k=z}function D(z){z!==L&&($&&l.lineWidth(z),L=z)}function Ke(z,De,ye){z?(se(l.POLYGON_OFFSET_FILL),(O!==De||W!==ye)&&(l.polygonOffset(De,ye),O=De,W=ye)):Pe(l.POLYGON_OFFSET_FILL)}function Ae(z){z?se(l.SCISSOR_TEST):Pe(l.SCISSOR_TEST)}function et(z){z===void 0&&(z=l.TEXTURE0+U-1),pe!==z&&(l.activeTexture(z),pe=z)}function ge(z,De,ye){ye===void 0&&(pe===null?ye=l.TEXTURE0+U-1:ye=pe);let Ne=me[ye];Ne===void 0&&(Ne={type:void 0,texture:void 0},me[ye]=Ne),(Ne.type!==z||Ne.texture!==De)&&(pe!==ye&&(l.activeTexture(ye),pe=ye),l.bindTexture(z,De||Z[z]),Ne.type=z,Ne.texture=De)}function P(){const z=me[pe];z!==void 0&&z.type!==void 0&&(l.bindTexture(z.type,null),z.type=void 0,z.texture=void 0)}function E(){try{l.compressedTexImage2D(...arguments)}catch(z){rt("WebGLState:",z)}}function N(){try{l.compressedTexImage3D(...arguments)}catch(z){rt("WebGLState:",z)}}function Y(){try{l.texSubImage2D(...arguments)}catch(z){rt("WebGLState:",z)}}function te(){try{l.texSubImage3D(...arguments)}catch(z){rt("WebGLState:",z)}}function K(){try{l.compressedTexSubImage2D(...arguments)}catch(z){rt("WebGLState:",z)}}function He(){try{l.compressedTexSubImage3D(...arguments)}catch(z){rt("WebGLState:",z)}}function we(){try{l.texStorage2D(...arguments)}catch(z){rt("WebGLState:",z)}}function Ue(){try{l.texStorage3D(...arguments)}catch(z){rt("WebGLState:",z)}}function at(){try{l.texImage2D(...arguments)}catch(z){rt("WebGLState:",z)}}function de(){try{l.texImage3D(...arguments)}catch(z){rt("WebGLState:",z)}}function Te(z){je.equals(z)===!1&&(l.scissor(z.x,z.y,z.z,z.w),je.copy(z))}function Ge(z){Ot.equals(z)===!1&&(l.viewport(z.x,z.y,z.z,z.w),Ot.copy(z))}function Ve(z,De){let ye=c.get(De);ye===void 0&&(ye=new WeakMap,c.set(De,ye));let Ne=ye.get(z);Ne===void 0&&(Ne=l.getUniformBlockIndex(De,z.name),ye.set(z,Ne))}function Me(z,De){const Ne=c.get(De).get(z);r.get(De)!==Ne&&(l.uniformBlockBinding(De,Ne,z.__bindingPointIndex),r.set(De,Ne))}function _t(){l.disable(l.BLEND),l.disable(l.CULL_FACE),l.disable(l.DEPTH_TEST),l.disable(l.POLYGON_OFFSET_FILL),l.disable(l.SCISSOR_TEST),l.disable(l.STENCIL_TEST),l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),l.blendEquation(l.FUNC_ADD),l.blendFunc(l.ONE,l.ZERO),l.blendFuncSeparate(l.ONE,l.ZERO,l.ONE,l.ZERO),l.blendColor(0,0,0,0),l.colorMask(!0,!0,!0,!0),l.clearColor(0,0,0,0),l.depthMask(!0),l.depthFunc(l.LESS),a.setReversed(!1),l.clearDepth(1),l.stencilMask(4294967295),l.stencilFunc(l.ALWAYS,0,4294967295),l.stencilOp(l.KEEP,l.KEEP,l.KEEP),l.clearStencil(0),l.cullFace(l.BACK),l.frontFace(l.CCW),l.polygonOffset(0,0),l.activeTexture(l.TEXTURE0),l.bindFramebuffer(l.FRAMEBUFFER,null),l.bindFramebuffer(l.DRAW_FRAMEBUFFER,null),l.bindFramebuffer(l.READ_FRAMEBUFFER,null),l.useProgram(null),l.lineWidth(1),l.scissor(0,0,l.canvas.width,l.canvas.height),l.viewport(0,0,l.canvas.width,l.canvas.height),h={},pe=null,me={},d={},u=new WeakMap,p=[],f=null,y=!1,m=null,g=null,x=null,v=null,b=null,_=null,S=null,A=new H(0,0,0),R=0,M=!1,C=null,k=null,L=null,O=null,W=null,je.set(0,0,l.canvas.width,l.canvas.height),Ot.set(0,0,l.canvas.width,l.canvas.height),n.reset(),a.reset(),o.reset()}return{buffers:{color:n,depth:a,stencil:o},enable:se,disable:Pe,bindFramebuffer:Ze,drawBuffers:Le,useProgram:Ct,setBlending:J,setMaterial:he,setFlipSided:oe,setCullFace:Se,setLineWidth:D,setPolygonOffset:Ke,setScissorTest:Ae,activeTexture:et,bindTexture:ge,unbindTexture:P,compressedTexImage2D:E,compressedTexImage3D:N,texImage2D:at,texImage3D:de,updateUBOMapping:Ve,uniformBlockBinding:Me,texStorage2D:we,texStorage3D:Ue,texSubImage2D:Y,texSubImage3D:te,compressedTexSubImage2D:K,compressedTexSubImage3D:He,scissor:Te,viewport:Ge,reset:_t}}function X_(l,e,t,i,s,n,a){const o=e.has("WEBGL_multisampled_render_to_texture")?e.get("WEBGL_multisampled_render_to_texture"):null,r=typeof navigator>"u"?!1:/OculusBrowser/g.test(navigator.userAgent),c=new le,h=new WeakMap;let d;const u=new WeakMap;let p=!1;try{p=typeof OffscreenCanvas<"u"&&new OffscreenCanvas(1,1).getContext("2d")!==null}catch{}function f(P,E){return p?new OffscreenCanvas(P,E):Jo("canvas")}function y(P,E,N){let Y=1;const te=ge(P);if((te.width>N||te.height>N)&&(Y=N/Math.max(te.width,te.height)),Y<1)if(typeof HTMLImageElement<"u"&&P instanceof HTMLImageElement||typeof HTMLCanvasElement<"u"&&P instanceof HTMLCanvasElement||typeof ImageBitmap<"u"&&P instanceof ImageBitmap||typeof VideoFrame<"u"&&P instanceof VideoFrame){const K=Math.floor(Y*te.width),He=Math.floor(Y*te.height);d===void 0&&(d=f(K,He));const we=E?f(K,He):d;return we.width=K,we.height=He,we.getContext("2d").drawImage(P,0,0,K,He),Qe("WebGLRenderer: Texture has been resized from ("+te.width+"x"+te.height+") to ("+K+"x"+He+")."),we}else return"data"in P&&Qe("WebGLRenderer: Image in DataTexture is too big ("+te.width+"x"+te.height+")."),P;return P}function m(P){return P.generateMipmaps}function g(P){l.generateMipmap(P)}function x(P){return P.isWebGLCubeRenderTarget?l.TEXTURE_CUBE_MAP:P.isWebGL3DRenderTarget?l.TEXTURE_3D:P.isWebGLArrayRenderTarget||P.isCompressedArrayTexture?l.TEXTURE_2D_ARRAY:l.TEXTURE_2D}function v(P,E,N,Y,te=!1){if(P!==null){if(l[P]!==void 0)return l[P];Qe("WebGLRenderer: Attempt to use non-existing WebGL internal format '"+P+"'")}let K=E;if(E===l.RED&&(N===l.FLOAT&&(K=l.R32F),N===l.HALF_FLOAT&&(K=l.R16F),N===l.UNSIGNED_BYTE&&(K=l.R8)),E===l.RED_INTEGER&&(N===l.UNSIGNED_BYTE&&(K=l.R8UI),N===l.UNSIGNED_SHORT&&(K=l.R16UI),N===l.UNSIGNED_INT&&(K=l.R32UI),N===l.BYTE&&(K=l.R8I),N===l.SHORT&&(K=l.R16I),N===l.INT&&(K=l.R32I)),E===l.RG&&(N===l.FLOAT&&(K=l.RG32F),N===l.HALF_FLOAT&&(K=l.RG16F),N===l.UNSIGNED_BYTE&&(K=l.RG8)),E===l.RG_INTEGER&&(N===l.UNSIGNED_BYTE&&(K=l.RG8UI),N===l.UNSIGNED_SHORT&&(K=l.RG16UI),N===l.UNSIGNED_INT&&(K=l.RG32UI),N===l.BYTE&&(K=l.RG8I),N===l.SHORT&&(K=l.RG16I),N===l.INT&&(K=l.RG32I)),E===l.RGB_INTEGER&&(N===l.UNSIGNED_BYTE&&(K=l.RGB8UI),N===l.UNSIGNED_SHORT&&(K=l.RGB16UI),N===l.UNSIGNED_INT&&(K=l.RGB32UI),N===l.BYTE&&(K=l.RGB8I),N===l.SHORT&&(K=l.RGB16I),N===l.INT&&(K=l.RGB32I)),E===l.RGBA_INTEGER&&(N===l.UNSIGNED_BYTE&&(K=l.RGBA8UI),N===l.UNSIGNED_SHORT&&(K=l.RGBA16UI),N===l.UNSIGNED_INT&&(K=l.RGBA32UI),N===l.BYTE&&(K=l.RGBA8I),N===l.SHORT&&(K=l.RGBA16I),N===l.INT&&(K=l.RGBA32I)),E===l.RGB&&(N===l.UNSIGNED_INT_5_9_9_9_REV&&(K=l.RGB9_E5),N===l.UNSIGNED_INT_10F_11F_11F_REV&&(K=l.R11F_G11F_B10F)),E===l.RGBA){const He=te?Il:Rt.getTransfer(Y);N===l.FLOAT&&(K=l.RGBA32F),N===l.HALF_FLOAT&&(K=l.RGBA16F),N===l.UNSIGNED_BYTE&&(K=He===Gt?l.SRGB8_ALPHA8:l.RGBA8),N===l.UNSIGNED_SHORT_4_4_4_4&&(K=l.RGBA4),N===l.UNSIGNED_SHORT_5_5_5_1&&(K=l.RGB5_A1)}return(K===l.R16F||K===l.R32F||K===l.RG16F||K===l.RG32F||K===l.RGBA16F||K===l.RGBA32F)&&e.get("EXT_color_buffer_float"),K}function b(P,E){let N;return P?E===null||E===Qs||E===jo?N=l.DEPTH24_STENCIL8:E===vs?N=l.DEPTH32F_STENCIL8:E===Qo&&(N=l.DEPTH24_STENCIL8,Qe("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):E===null||E===Qs||E===jo?N=l.DEPTH_COMPONENT24:E===vs?N=l.DEPTH_COMPONENT32F:E===Qo&&(N=l.DEPTH_COMPONENT16),N}function _(P,E){return m(P)===!0||P.isFramebufferTexture&&P.minFilter!==xi&&P.minFilter!==bi?Math.log2(Math.max(E.width,E.height))+1:P.mipmaps!==void 0&&P.mipmaps.length>0?P.mipmaps.length:P.isCompressedTexture&&Array.isArray(P.image)?E.mipmaps.length:1}function S(P){const E=P.target;E.removeEventListener("dispose",S),R(E),E.isVideoTexture&&h.delete(E)}function A(P){const E=P.target;E.removeEventListener("dispose",A),C(E)}function R(P){const E=i.get(P);if(E.__webglInit===void 0)return;const N=P.source,Y=u.get(N);if(Y){const te=Y[E.__cacheKey];te.usedTimes--,te.usedTimes===0&&M(P),Object.keys(Y).length===0&&u.delete(N)}i.remove(P)}function M(P){const E=i.get(P);l.deleteTexture(E.__webglTexture);const N=P.source,Y=u.get(N);delete Y[E.__cacheKey],a.memory.textures--}function C(P){const E=i.get(P);if(P.depthTexture&&(P.depthTexture.dispose(),i.remove(P.depthTexture)),P.isWebGLCubeRenderTarget)for(let Y=0;Y<6;Y++){if(Array.isArray(E.__webglFramebuffer[Y]))for(let te=0;te<E.__webglFramebuffer[Y].length;te++)l.deleteFramebuffer(E.__webglFramebuffer[Y][te]);else l.deleteFramebuffer(E.__webglFramebuffer[Y]);E.__webglDepthbuffer&&l.deleteRenderbuffer(E.__webglDepthbuffer[Y])}else{if(Array.isArray(E.__webglFramebuffer))for(let Y=0;Y<E.__webglFramebuffer.length;Y++)l.deleteFramebuffer(E.__webglFramebuffer[Y]);else l.deleteFramebuffer(E.__webglFramebuffer);if(E.__webglDepthbuffer&&l.deleteRenderbuffer(E.__webglDepthbuffer),E.__webglMultisampledFramebuffer&&l.deleteFramebuffer(E.__webglMultisampledFramebuffer),E.__webglColorRenderbuffer)for(let Y=0;Y<E.__webglColorRenderbuffer.length;Y++)E.__webglColorRenderbuffer[Y]&&l.deleteRenderbuffer(E.__webglColorRenderbuffer[Y]);E.__webglDepthRenderbuffer&&l.deleteRenderbuffer(E.__webglDepthRenderbuffer)}const N=P.textures;for(let Y=0,te=N.length;Y<te;Y++){const K=i.get(N[Y]);K.__webglTexture&&(l.deleteTexture(K.__webglTexture),a.memory.textures--),i.remove(N[Y])}i.remove(P)}let k=0;function L(){k=0}function O(){const P=k;return P>=s.maxTextures&&Qe("WebGLTextures: Trying to use "+P+" texture units while this GPU supports only "+s.maxTextures),k+=1,P}function W(P){const E=[];return E.push(P.wrapS),E.push(P.wrapT),E.push(P.wrapR||0),E.push(P.magFilter),E.push(P.minFilter),E.push(P.anisotropy),E.push(P.internalFormat),E.push(P.format),E.push(P.type),E.push(P.generateMipmaps),E.push(P.premultiplyAlpha),E.push(P.flipY),E.push(P.unpackAlignment),E.push(P.colorSpace),E.join()}function U(P,E){const N=i.get(P);if(P.isVideoTexture&&Ae(P),P.isRenderTargetTexture===!1&&P.isExternalTexture!==!0&&P.version>0&&N.__version!==P.version){const Y=P.image;if(Y===null)Qe("WebGLRenderer: Texture marked for update but no image data found.");else if(Y.complete===!1)Qe("WebGLRenderer: Texture marked for update but image is incomplete");else{Z(N,P,E);return}}else P.isExternalTexture&&(N.__webglTexture=P.sourceTexture?P.sourceTexture:null);t.bindTexture(l.TEXTURE_2D,N.__webglTexture,l.TEXTURE0+E)}function $(P,E){const N=i.get(P);if(P.isRenderTargetTexture===!1&&P.version>0&&N.__version!==P.version){Z(N,P,E);return}else P.isExternalTexture&&(N.__webglTexture=P.sourceTexture?P.sourceTexture:null);t.bindTexture(l.TEXTURE_2D_ARRAY,N.__webglTexture,l.TEXTURE0+E)}function G(P,E){const N=i.get(P);if(P.isRenderTargetTexture===!1&&P.version>0&&N.__version!==P.version){Z(N,P,E);return}t.bindTexture(l.TEXTURE_3D,N.__webglTexture,l.TEXTURE0+E)}function ee(P,E){const N=i.get(P);if(P.isCubeDepthTexture!==!0&&P.version>0&&N.__version!==P.version){se(N,P,E);return}t.bindTexture(l.TEXTURE_CUBE_MAP,N.__webglTexture,l.TEXTURE0+E)}const pe={[Ys]:l.REPEAT,[Us]:l.CLAMP_TO_EDGE,[Al]:l.MIRRORED_REPEAT},me={[xi]:l.NEAREST,[Xf]:l.NEAREST_MIPMAP_NEAREST,[Lo]:l.NEAREST_MIPMAP_LINEAR,[bi]:l.LINEAR,[gl]:l.LINEAR_MIPMAP_NEAREST,[un]:l.LINEAR_MIPMAP_LINEAR},ve={[X0]:l.NEVER,[Z0]:l.ALWAYS,[Y0]:l.LESS,[Hd]:l.LEQUAL,[Q0]:l.EQUAL,[qd]:l.GEQUAL,[j0]:l.GREATER,[K0]:l.NOTEQUAL};function tt(P,E){if(E.type===vs&&e.has("OES_texture_float_linear")===!1&&(E.magFilter===bi||E.magFilter===gl||E.magFilter===Lo||E.magFilter===un||E.minFilter===bi||E.minFilter===gl||E.minFilter===Lo||E.minFilter===un)&&Qe("WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),l.texParameteri(P,l.TEXTURE_WRAP_S,pe[E.wrapS]),l.texParameteri(P,l.TEXTURE_WRAP_T,pe[E.wrapT]),(P===l.TEXTURE_3D||P===l.TEXTURE_2D_ARRAY)&&l.texParameteri(P,l.TEXTURE_WRAP_R,pe[E.wrapR]),l.texParameteri(P,l.TEXTURE_MAG_FILTER,me[E.magFilter]),l.texParameteri(P,l.TEXTURE_MIN_FILTER,me[E.minFilter]),E.compareFunction&&(l.texParameteri(P,l.TEXTURE_COMPARE_MODE,l.COMPARE_REF_TO_TEXTURE),l.texParameteri(P,l.TEXTURE_COMPARE_FUNC,ve[E.compareFunction])),e.has("EXT_texture_filter_anisotropic")===!0){if(E.magFilter===xi||E.minFilter!==Lo&&E.minFilter!==un||E.type===vs&&e.has("OES_texture_float_linear")===!1)return;if(E.anisotropy>1||i.get(E).__currentAnisotropy){const N=e.get("EXT_texture_filter_anisotropic");l.texParameterf(P,N.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(E.anisotropy,s.getMaxAnisotropy())),i.get(E).__currentAnisotropy=E.anisotropy}}}function je(P,E){let N=!1;P.__webglInit===void 0&&(P.__webglInit=!0,E.addEventListener("dispose",S));const Y=E.source;let te=u.get(Y);te===void 0&&(te={},u.set(Y,te));const K=W(E);if(K!==P.__cacheKey){te[K]===void 0&&(te[K]={texture:l.createTexture(),usedTimes:0},a.memory.textures++,N=!0),te[K].usedTimes++;const He=te[P.__cacheKey];He!==void 0&&(te[P.__cacheKey].usedTimes--,He.usedTimes===0&&M(E)),P.__cacheKey=K,P.__webglTexture=te[K].texture}return N}function Ot(P,E,N){return Math.floor(Math.floor(P/N)/E)}function Nt(P,E,N,Y){const K=P.updateRanges;if(K.length===0)t.texSubImage2D(l.TEXTURE_2D,0,0,0,E.width,E.height,N,Y,E.data);else{K.sort((de,Te)=>de.start-Te.start);let He=0;for(let de=1;de<K.length;de++){const Te=K[He],Ge=K[de],Ve=Te.start+Te.count,Me=Ot(Ge.start,E.width,4),_t=Ot(Te.start,E.width,4);Ge.start<=Ve+1&&Me===_t&&Ot(Ge.start+Ge.count-1,E.width,4)===Me?Te.count=Math.max(Te.count,Ge.start+Ge.count-Te.start):(++He,K[He]=Ge)}K.length=He+1;const we=l.getParameter(l.UNPACK_ROW_LENGTH),Ue=l.getParameter(l.UNPACK_SKIP_PIXELS),at=l.getParameter(l.UNPACK_SKIP_ROWS);l.pixelStorei(l.UNPACK_ROW_LENGTH,E.width);for(let de=0,Te=K.length;de<Te;de++){const Ge=K[de],Ve=Math.floor(Ge.start/4),Me=Math.ceil(Ge.count/4),_t=Ve%E.width,z=Math.floor(Ve/E.width),De=Me,ye=1;l.pixelStorei(l.UNPACK_SKIP_PIXELS,_t),l.pixelStorei(l.UNPACK_SKIP_ROWS,z),t.texSubImage2D(l.TEXTURE_2D,0,_t,z,De,ye,N,Y,E.data)}P.clearUpdateRanges(),l.pixelStorei(l.UNPACK_ROW_LENGTH,we),l.pixelStorei(l.UNPACK_SKIP_PIXELS,Ue),l.pixelStorei(l.UNPACK_SKIP_ROWS,at)}}function Z(P,E,N){let Y=l.TEXTURE_2D;(E.isDataArrayTexture||E.isCompressedArrayTexture)&&(Y=l.TEXTURE_2D_ARRAY),E.isData3DTexture&&(Y=l.TEXTURE_3D);const te=je(P,E),K=E.source;t.bindTexture(Y,P.__webglTexture,l.TEXTURE0+N);const He=i.get(K);if(K.version!==He.__version||te===!0){t.activeTexture(l.TEXTURE0+N);const we=Rt.getPrimaries(Rt.workingColorSpace),Ue=E.colorSpace===In?null:Rt.getPrimaries(E.colorSpace),at=E.colorSpace===In||we===Ue?l.NONE:l.BROWSER_DEFAULT_WEBGL;l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,E.flipY),l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,E.premultiplyAlpha),l.pixelStorei(l.UNPACK_ALIGNMENT,E.unpackAlignment),l.pixelStorei(l.UNPACK_COLORSPACE_CONVERSION_WEBGL,at);let de=y(E.image,!1,s.maxTextureSize);de=et(E,de);const Te=n.convert(E.format,E.colorSpace),Ge=n.convert(E.type);let Ve=v(E.internalFormat,Te,Ge,E.colorSpace,E.isVideoTexture);tt(Y,E);let Me;const _t=E.mipmaps,z=E.isVideoTexture!==!0,De=He.__version===void 0||te===!0,ye=K.dataReady,Ne=_(E,de);if(E.isDepthTexture)Ve=b(E.format===ea,E.type),De&&(z?t.texStorage2D(l.TEXTURE_2D,1,Ve,de.width,de.height):t.texImage2D(l.TEXTURE_2D,0,Ve,de.width,de.height,0,Te,Ge,null));else if(E.isDataTexture)if(_t.length>0){z&&De&&t.texStorage2D(l.TEXTURE_2D,Ne,Ve,_t[0].width,_t[0].height);for(let ue=0,ae=_t.length;ue<ae;ue++)Me=_t[ue],z?ye&&t.texSubImage2D(l.TEXTURE_2D,ue,0,0,Me.width,Me.height,Te,Ge,Me.data):t.texImage2D(l.TEXTURE_2D,ue,Ve,Me.width,Me.height,0,Te,Ge,Me.data);E.generateMipmaps=!1}else z?(De&&t.texStorage2D(l.TEXTURE_2D,Ne,Ve,de.width,de.height),ye&&Nt(E,de,Te,Ge)):t.texImage2D(l.TEXTURE_2D,0,Ve,de.width,de.height,0,Te,Ge,de.data);else if(E.isCompressedTexture)if(E.isCompressedArrayTexture){z&&De&&t.texStorage3D(l.TEXTURE_2D_ARRAY,Ne,Ve,_t[0].width,_t[0].height,de.depth);for(let ue=0,ae=_t.length;ue<ae;ue++)if(Me=_t[ue],E.format!==xs)if(Te!==null)if(z){if(ye)if(E.layerUpdates.size>0){const _e=yp(Me.width,Me.height,E.format,E.type);for(const pt of E.layerUpdates){const jt=Me.data.subarray(pt*_e/Me.data.BYTES_PER_ELEMENT,(pt+1)*_e/Me.data.BYTES_PER_ELEMENT);t.compressedTexSubImage3D(l.TEXTURE_2D_ARRAY,ue,0,0,pt,Me.width,Me.height,1,Te,jt)}E.clearLayerUpdates()}else t.compressedTexSubImage3D(l.TEXTURE_2D_ARRAY,ue,0,0,0,Me.width,Me.height,de.depth,Te,Me.data)}else t.compressedTexImage3D(l.TEXTURE_2D_ARRAY,ue,Ve,Me.width,Me.height,de.depth,0,Me.data,0,0);else Qe("WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else z?ye&&t.texSubImage3D(l.TEXTURE_2D_ARRAY,ue,0,0,0,Me.width,Me.height,de.depth,Te,Ge,Me.data):t.texImage3D(l.TEXTURE_2D_ARRAY,ue,Ve,Me.width,Me.height,de.depth,0,Te,Ge,Me.data)}else{z&&De&&t.texStorage2D(l.TEXTURE_2D,Ne,Ve,_t[0].width,_t[0].height);for(let ue=0,ae=_t.length;ue<ae;ue++)Me=_t[ue],E.format!==xs?Te!==null?z?ye&&t.compressedTexSubImage2D(l.TEXTURE_2D,ue,0,0,Me.width,Me.height,Te,Me.data):t.compressedTexImage2D(l.TEXTURE_2D,ue,Ve,Me.width,Me.height,0,Me.data):Qe("WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):z?ye&&t.texSubImage2D(l.TEXTURE_2D,ue,0,0,Me.width,Me.height,Te,Ge,Me.data):t.texImage2D(l.TEXTURE_2D,ue,Ve,Me.width,Me.height,0,Te,Ge,Me.data)}else if(E.isDataArrayTexture)if(z){if(De&&t.texStorage3D(l.TEXTURE_2D_ARRAY,Ne,Ve,de.width,de.height,de.depth),ye)if(E.layerUpdates.size>0){const ue=yp(de.width,de.height,E.format,E.type);for(const ae of E.layerUpdates){const _e=de.data.subarray(ae*ue/de.data.BYTES_PER_ELEMENT,(ae+1)*ue/de.data.BYTES_PER_ELEMENT);t.texSubImage3D(l.TEXTURE_2D_ARRAY,0,0,0,ae,de.width,de.height,1,Te,Ge,_e)}E.clearLayerUpdates()}else t.texSubImage3D(l.TEXTURE_2D_ARRAY,0,0,0,0,de.width,de.height,de.depth,Te,Ge,de.data)}else t.texImage3D(l.TEXTURE_2D_ARRAY,0,Ve,de.width,de.height,de.depth,0,Te,Ge,de.data);else if(E.isData3DTexture)z?(De&&t.texStorage3D(l.TEXTURE_3D,Ne,Ve,de.width,de.height,de.depth),ye&&t.texSubImage3D(l.TEXTURE_3D,0,0,0,0,de.width,de.height,de.depth,Te,Ge,de.data)):t.texImage3D(l.TEXTURE_3D,0,Ve,de.width,de.height,de.depth,0,Te,Ge,de.data);else if(E.isFramebufferTexture){if(De)if(z)t.texStorage2D(l.TEXTURE_2D,Ne,Ve,de.width,de.height);else{let ue=de.width,ae=de.height;for(let _e=0;_e<Ne;_e++)t.texImage2D(l.TEXTURE_2D,_e,Ve,ue,ae,0,Te,Ge,null),ue>>=1,ae>>=1}}else if(_t.length>0){if(z&&De){const ue=ge(_t[0]);t.texStorage2D(l.TEXTURE_2D,Ne,Ve,ue.width,ue.height)}for(let ue=0,ae=_t.length;ue<ae;ue++)Me=_t[ue],z?ye&&t.texSubImage2D(l.TEXTURE_2D,ue,0,0,Te,Ge,Me):t.texImage2D(l.TEXTURE_2D,ue,Ve,Te,Ge,Me);E.generateMipmaps=!1}else if(z){if(De){const ue=ge(de);t.texStorage2D(l.TEXTURE_2D,Ne,Ve,ue.width,ue.height)}ye&&t.texSubImage2D(l.TEXTURE_2D,0,0,0,Te,Ge,de)}else t.texImage2D(l.TEXTURE_2D,0,Ve,Te,Ge,de);m(E)&&g(Y),He.__version=K.version,E.onUpdate&&E.onUpdate(E)}P.__version=E.version}function se(P,E,N){if(E.image.length!==6)return;const Y=je(P,E),te=E.source;t.bindTexture(l.TEXTURE_CUBE_MAP,P.__webglTexture,l.TEXTURE0+N);const K=i.get(te);if(te.version!==K.__version||Y===!0){t.activeTexture(l.TEXTURE0+N);const He=Rt.getPrimaries(Rt.workingColorSpace),we=E.colorSpace===In?null:Rt.getPrimaries(E.colorSpace),Ue=E.colorSpace===In||He===we?l.NONE:l.BROWSER_DEFAULT_WEBGL;l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,E.flipY),l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,E.premultiplyAlpha),l.pixelStorei(l.UNPACK_ALIGNMENT,E.unpackAlignment),l.pixelStorei(l.UNPACK_COLORSPACE_CONVERSION_WEBGL,Ue);const at=E.isCompressedTexture||E.image[0].isCompressedTexture,de=E.image[0]&&E.image[0].isDataTexture,Te=[];for(let ae=0;ae<6;ae++)!at&&!de?Te[ae]=y(E.image[ae],!0,s.maxCubemapSize):Te[ae]=de?E.image[ae].image:E.image[ae],Te[ae]=et(E,Te[ae]);const Ge=Te[0],Ve=n.convert(E.format,E.colorSpace),Me=n.convert(E.type),_t=v(E.internalFormat,Ve,Me,E.colorSpace),z=E.isVideoTexture!==!0,De=K.__version===void 0||Y===!0,ye=te.dataReady;let Ne=_(E,Ge);tt(l.TEXTURE_CUBE_MAP,E);let ue;if(at){z&&De&&t.texStorage2D(l.TEXTURE_CUBE_MAP,Ne,_t,Ge.width,Ge.height);for(let ae=0;ae<6;ae++){ue=Te[ae].mipmaps;for(let _e=0;_e<ue.length;_e++){const pt=ue[_e];E.format!==xs?Ve!==null?z?ye&&t.compressedTexSubImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,_e,0,0,pt.width,pt.height,Ve,pt.data):t.compressedTexImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,_e,_t,pt.width,pt.height,0,pt.data):Qe("WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):z?ye&&t.texSubImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,_e,0,0,pt.width,pt.height,Ve,Me,pt.data):t.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,_e,_t,pt.width,pt.height,0,Ve,Me,pt.data)}}}else{if(ue=E.mipmaps,z&&De){ue.length>0&&Ne++;const ae=ge(Te[0]);t.texStorage2D(l.TEXTURE_CUBE_MAP,Ne,_t,ae.width,ae.height)}for(let ae=0;ae<6;ae++)if(de){z?ye&&t.texSubImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,0,0,0,Te[ae].width,Te[ae].height,Ve,Me,Te[ae].data):t.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,0,_t,Te[ae].width,Te[ae].height,0,Ve,Me,Te[ae].data);for(let _e=0;_e<ue.length;_e++){const jt=ue[_e].image[ae].image;z?ye&&t.texSubImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,_e+1,0,0,jt.width,jt.height,Ve,Me,jt.data):t.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,_e+1,_t,jt.width,jt.height,0,Ve,Me,jt.data)}}else{z?ye&&t.texSubImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,0,0,0,Ve,Me,Te[ae]):t.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,0,_t,Ve,Me,Te[ae]);for(let _e=0;_e<ue.length;_e++){const pt=ue[_e];z?ye&&t.texSubImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,_e+1,0,0,Ve,Me,pt.image[ae]):t.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+ae,_e+1,_t,Ve,Me,pt.image[ae])}}}m(E)&&g(l.TEXTURE_CUBE_MAP),K.__version=te.version,E.onUpdate&&E.onUpdate(E)}P.__version=E.version}function Pe(P,E,N,Y,te,K){const He=n.convert(N.format,N.colorSpace),we=n.convert(N.type),Ue=v(N.internalFormat,He,we,N.colorSpace),at=i.get(E),de=i.get(N);if(de.__renderTarget=E,!at.__hasExternalTextures){const Te=Math.max(1,E.width>>K),Ge=Math.max(1,E.height>>K);te===l.TEXTURE_3D||te===l.TEXTURE_2D_ARRAY?t.texImage3D(te,K,Ue,Te,Ge,E.depth,0,He,we,null):t.texImage2D(te,K,Ue,Te,Ge,0,He,we,null)}t.bindFramebuffer(l.FRAMEBUFFER,P),Ke(E)?o.framebufferTexture2DMultisampleEXT(l.FRAMEBUFFER,Y,te,de.__webglTexture,0,D(E)):(te===l.TEXTURE_2D||te>=l.TEXTURE_CUBE_MAP_POSITIVE_X&&te<=l.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&l.framebufferTexture2D(l.FRAMEBUFFER,Y,te,de.__webglTexture,K),t.bindFramebuffer(l.FRAMEBUFFER,null)}function Ze(P,E,N){if(l.bindRenderbuffer(l.RENDERBUFFER,P),E.depthBuffer){const Y=E.depthTexture,te=Y&&Y.isDepthTexture?Y.type:null,K=b(E.stencilBuffer,te),He=E.stencilBuffer?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT;Ke(E)?o.renderbufferStorageMultisampleEXT(l.RENDERBUFFER,D(E),K,E.width,E.height):N?l.renderbufferStorageMultisample(l.RENDERBUFFER,D(E),K,E.width,E.height):l.renderbufferStorage(l.RENDERBUFFER,K,E.width,E.height),l.framebufferRenderbuffer(l.FRAMEBUFFER,He,l.RENDERBUFFER,P)}else{const Y=E.textures;for(let te=0;te<Y.length;te++){const K=Y[te],He=n.convert(K.format,K.colorSpace),we=n.convert(K.type),Ue=v(K.internalFormat,He,we,K.colorSpace);Ke(E)?o.renderbufferStorageMultisampleEXT(l.RENDERBUFFER,D(E),Ue,E.width,E.height):N?l.renderbufferStorageMultisample(l.RENDERBUFFER,D(E),Ue,E.width,E.height):l.renderbufferStorage(l.RENDERBUFFER,Ue,E.width,E.height)}}l.bindRenderbuffer(l.RENDERBUFFER,null)}function Le(P,E,N){const Y=E.isWebGLCubeRenderTarget===!0;if(t.bindFramebuffer(l.FRAMEBUFFER,P),!(E.depthTexture&&E.depthTexture.isDepthTexture))throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const te=i.get(E.depthTexture);if(te.__renderTarget=E,(!te.__webglTexture||E.depthTexture.image.width!==E.width||E.depthTexture.image.height!==E.height)&&(E.depthTexture.image.width=E.width,E.depthTexture.image.height=E.height,E.depthTexture.needsUpdate=!0),Y){if(te.__webglInit===void 0&&(te.__webglInit=!0,E.depthTexture.addEventListener("dispose",S)),te.__webglTexture===void 0){te.__webglTexture=l.createTexture(),t.bindTexture(l.TEXTURE_CUBE_MAP,te.__webglTexture),tt(l.TEXTURE_CUBE_MAP,E.depthTexture);const at=n.convert(E.depthTexture.format),de=n.convert(E.depthTexture.type);let Te;E.depthTexture.format===yn?Te=l.DEPTH_COMPONENT24:E.depthTexture.format===ea&&(Te=l.DEPTH24_STENCIL8);for(let Ge=0;Ge<6;Ge++)l.texImage2D(l.TEXTURE_CUBE_MAP_POSITIVE_X+Ge,0,Te,E.width,E.height,0,at,de,null)}}else U(E.depthTexture,0);const K=te.__webglTexture,He=D(E),we=Y?l.TEXTURE_CUBE_MAP_POSITIVE_X+N:l.TEXTURE_2D,Ue=E.depthTexture.format===ea?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT;if(E.depthTexture.format===yn)Ke(E)?o.framebufferTexture2DMultisampleEXT(l.FRAMEBUFFER,Ue,we,K,0,He):l.framebufferTexture2D(l.FRAMEBUFFER,Ue,we,K,0);else if(E.depthTexture.format===ea)Ke(E)?o.framebufferTexture2DMultisampleEXT(l.FRAMEBUFFER,Ue,we,K,0,He):l.framebufferTexture2D(l.FRAMEBUFFER,Ue,we,K,0);else throw new Error("Unknown depthTexture format")}function Ct(P){const E=i.get(P),N=P.isWebGLCubeRenderTarget===!0;if(E.__boundDepthTexture!==P.depthTexture){const Y=P.depthTexture;if(E.__depthDisposeCallback&&E.__depthDisposeCallback(),Y){const te=()=>{delete E.__boundDepthTexture,delete E.__depthDisposeCallback,Y.removeEventListener("dispose",te)};Y.addEventListener("dispose",te),E.__depthDisposeCallback=te}E.__boundDepthTexture=Y}if(P.depthTexture&&!E.__autoAllocateDepthBuffer)if(N)for(let Y=0;Y<6;Y++)Le(E.__webglFramebuffer[Y],P,Y);else{const Y=P.texture.mipmaps;Y&&Y.length>0?Le(E.__webglFramebuffer[0],P,0):Le(E.__webglFramebuffer,P,0)}else if(N){E.__webglDepthbuffer=[];for(let Y=0;Y<6;Y++)if(t.bindFramebuffer(l.FRAMEBUFFER,E.__webglFramebuffer[Y]),E.__webglDepthbuffer[Y]===void 0)E.__webglDepthbuffer[Y]=l.createRenderbuffer(),Ze(E.__webglDepthbuffer[Y],P,!1);else{const te=P.stencilBuffer?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT,K=E.__webglDepthbuffer[Y];l.bindRenderbuffer(l.RENDERBUFFER,K),l.framebufferRenderbuffer(l.FRAMEBUFFER,te,l.RENDERBUFFER,K)}}else{const Y=P.texture.mipmaps;if(Y&&Y.length>0?t.bindFramebuffer(l.FRAMEBUFFER,E.__webglFramebuffer[0]):t.bindFramebuffer(l.FRAMEBUFFER,E.__webglFramebuffer),E.__webglDepthbuffer===void 0)E.__webglDepthbuffer=l.createRenderbuffer(),Ze(E.__webglDepthbuffer,P,!1);else{const te=P.stencilBuffer?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT,K=E.__webglDepthbuffer;l.bindRenderbuffer(l.RENDERBUFFER,K),l.framebufferRenderbuffer(l.FRAMEBUFFER,te,l.RENDERBUFFER,K)}}t.bindFramebuffer(l.FRAMEBUFFER,null)}function Bt(P,E,N){const Y=i.get(P);E!==void 0&&Pe(Y.__webglFramebuffer,P,P.texture,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,0),N!==void 0&&Ct(P)}function ht(P){const E=P.texture,N=i.get(P),Y=i.get(E);P.addEventListener("dispose",A);const te=P.textures,K=P.isWebGLCubeRenderTarget===!0,He=te.length>1;if(He||(Y.__webglTexture===void 0&&(Y.__webglTexture=l.createTexture()),Y.__version=E.version,a.memory.textures++),K){N.__webglFramebuffer=[];for(let we=0;we<6;we++)if(E.mipmaps&&E.mipmaps.length>0){N.__webglFramebuffer[we]=[];for(let Ue=0;Ue<E.mipmaps.length;Ue++)N.__webglFramebuffer[we][Ue]=l.createFramebuffer()}else N.__webglFramebuffer[we]=l.createFramebuffer()}else{if(E.mipmaps&&E.mipmaps.length>0){N.__webglFramebuffer=[];for(let we=0;we<E.mipmaps.length;we++)N.__webglFramebuffer[we]=l.createFramebuffer()}else N.__webglFramebuffer=l.createFramebuffer();if(He)for(let we=0,Ue=te.length;we<Ue;we++){const at=i.get(te[we]);at.__webglTexture===void 0&&(at.__webglTexture=l.createTexture(),a.memory.textures++)}if(P.samples>0&&Ke(P)===!1){N.__webglMultisampledFramebuffer=l.createFramebuffer(),N.__webglColorRenderbuffer=[],t.bindFramebuffer(l.FRAMEBUFFER,N.__webglMultisampledFramebuffer);for(let we=0;we<te.length;we++){const Ue=te[we];N.__webglColorRenderbuffer[we]=l.createRenderbuffer(),l.bindRenderbuffer(l.RENDERBUFFER,N.__webglColorRenderbuffer[we]);const at=n.convert(Ue.format,Ue.colorSpace),de=n.convert(Ue.type),Te=v(Ue.internalFormat,at,de,Ue.colorSpace,P.isXRRenderTarget===!0),Ge=D(P);l.renderbufferStorageMultisample(l.RENDERBUFFER,Ge,Te,P.width,P.height),l.framebufferRenderbuffer(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0+we,l.RENDERBUFFER,N.__webglColorRenderbuffer[we])}l.bindRenderbuffer(l.RENDERBUFFER,null),P.depthBuffer&&(N.__webglDepthRenderbuffer=l.createRenderbuffer(),Ze(N.__webglDepthRenderbuffer,P,!0)),t.bindFramebuffer(l.FRAMEBUFFER,null)}}if(K){t.bindTexture(l.TEXTURE_CUBE_MAP,Y.__webglTexture),tt(l.TEXTURE_CUBE_MAP,E);for(let we=0;we<6;we++)if(E.mipmaps&&E.mipmaps.length>0)for(let Ue=0;Ue<E.mipmaps.length;Ue++)Pe(N.__webglFramebuffer[we][Ue],P,E,l.COLOR_ATTACHMENT0,l.TEXTURE_CUBE_MAP_POSITIVE_X+we,Ue);else Pe(N.__webglFramebuffer[we],P,E,l.COLOR_ATTACHMENT0,l.TEXTURE_CUBE_MAP_POSITIVE_X+we,0);m(E)&&g(l.TEXTURE_CUBE_MAP),t.unbindTexture()}else if(He){for(let we=0,Ue=te.length;we<Ue;we++){const at=te[we],de=i.get(at);let Te=l.TEXTURE_2D;(P.isWebGL3DRenderTarget||P.isWebGLArrayRenderTarget)&&(Te=P.isWebGL3DRenderTarget?l.TEXTURE_3D:l.TEXTURE_2D_ARRAY),t.bindTexture(Te,de.__webglTexture),tt(Te,at),Pe(N.__webglFramebuffer,P,at,l.COLOR_ATTACHMENT0+we,Te,0),m(at)&&g(Te)}t.unbindTexture()}else{let we=l.TEXTURE_2D;if((P.isWebGL3DRenderTarget||P.isWebGLArrayRenderTarget)&&(we=P.isWebGL3DRenderTarget?l.TEXTURE_3D:l.TEXTURE_2D_ARRAY),t.bindTexture(we,Y.__webglTexture),tt(we,E),E.mipmaps&&E.mipmaps.length>0)for(let Ue=0;Ue<E.mipmaps.length;Ue++)Pe(N.__webglFramebuffer[Ue],P,E,l.COLOR_ATTACHMENT0,we,Ue);else Pe(N.__webglFramebuffer,P,E,l.COLOR_ATTACHMENT0,we,0);m(E)&&g(we),t.unbindTexture()}P.depthBuffer&&Ct(P)}function J(P){const E=P.textures;for(let N=0,Y=E.length;N<Y;N++){const te=E[N];if(m(te)){const K=x(P),He=i.get(te).__webglTexture;t.bindTexture(K,He),g(K),t.unbindTexture()}}}const he=[],oe=[];function Se(P){if(P.samples>0){if(Ke(P)===!1){const E=P.textures,N=P.width,Y=P.height;let te=l.COLOR_BUFFER_BIT;const K=P.stencilBuffer?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT,He=i.get(P),we=E.length>1;if(we)for(let at=0;at<E.length;at++)t.bindFramebuffer(l.FRAMEBUFFER,He.__webglMultisampledFramebuffer),l.framebufferRenderbuffer(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0+at,l.RENDERBUFFER,null),t.bindFramebuffer(l.FRAMEBUFFER,He.__webglFramebuffer),l.framebufferTexture2D(l.DRAW_FRAMEBUFFER,l.COLOR_ATTACHMENT0+at,l.TEXTURE_2D,null,0);t.bindFramebuffer(l.READ_FRAMEBUFFER,He.__webglMultisampledFramebuffer);const Ue=P.texture.mipmaps;Ue&&Ue.length>0?t.bindFramebuffer(l.DRAW_FRAMEBUFFER,He.__webglFramebuffer[0]):t.bindFramebuffer(l.DRAW_FRAMEBUFFER,He.__webglFramebuffer);for(let at=0;at<E.length;at++){if(P.resolveDepthBuffer&&(P.depthBuffer&&(te|=l.DEPTH_BUFFER_BIT),P.stencilBuffer&&P.resolveStencilBuffer&&(te|=l.STENCIL_BUFFER_BIT)),we){l.framebufferRenderbuffer(l.READ_FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.RENDERBUFFER,He.__webglColorRenderbuffer[at]);const de=i.get(E[at]).__webglTexture;l.framebufferTexture2D(l.DRAW_FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,de,0)}l.blitFramebuffer(0,0,N,Y,0,0,N,Y,te,l.NEAREST),r===!0&&(he.length=0,oe.length=0,he.push(l.COLOR_ATTACHMENT0+at),P.depthBuffer&&P.resolveDepthBuffer===!1&&(he.push(K),oe.push(K),l.invalidateFramebuffer(l.DRAW_FRAMEBUFFER,oe)),l.invalidateFramebuffer(l.READ_FRAMEBUFFER,he))}if(t.bindFramebuffer(l.READ_FRAMEBUFFER,null),t.bindFramebuffer(l.DRAW_FRAMEBUFFER,null),we)for(let at=0;at<E.length;at++){t.bindFramebuffer(l.FRAMEBUFFER,He.__webglMultisampledFramebuffer),l.framebufferRenderbuffer(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0+at,l.RENDERBUFFER,He.__webglColorRenderbuffer[at]);const de=i.get(E[at]).__webglTexture;t.bindFramebuffer(l.FRAMEBUFFER,He.__webglFramebuffer),l.framebufferTexture2D(l.DRAW_FRAMEBUFFER,l.COLOR_ATTACHMENT0+at,l.TEXTURE_2D,de,0)}t.bindFramebuffer(l.DRAW_FRAMEBUFFER,He.__webglMultisampledFramebuffer)}else if(P.depthBuffer&&P.resolveDepthBuffer===!1&&r){const E=P.stencilBuffer?l.DEPTH_STENCIL_ATTACHMENT:l.DEPTH_ATTACHMENT;l.invalidateFramebuffer(l.DRAW_FRAMEBUFFER,[E])}}}function D(P){return Math.min(s.maxSamples,P.samples)}function Ke(P){const E=i.get(P);return P.samples>0&&e.has("WEBGL_multisampled_render_to_texture")===!0&&E.__useRenderToTexture!==!1}function Ae(P){const E=a.render.frame;h.get(P)!==E&&(h.set(P,E),P.update())}function et(P,E){const N=P.colorSpace,Y=P.format,te=P.type;return P.isCompressedTexture===!0||P.isVideoTexture===!0||N!==zi&&N!==In&&(Rt.getTransfer(N)===Gt?(Y!==xs||te!==ls)&&Qe("WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):rt("WebGLTextures: Unsupported texture color space:",N)),E}function ge(P){return typeof HTMLImageElement<"u"&&P instanceof HTMLImageElement?(c.width=P.naturalWidth||P.width,c.height=P.naturalHeight||P.height):typeof VideoFrame<"u"&&P instanceof VideoFrame?(c.width=P.displayWidth,c.height=P.displayHeight):(c.width=P.width,c.height=P.height),c}this.allocateTextureUnit=O,this.resetTextureUnits=L,this.setTexture2D=U,this.setTexture2DArray=$,this.setTexture3D=G,this.setTextureCube=ee,this.rebindTextures=Bt,this.setupRenderTarget=ht,this.updateRenderTargetMipmap=J,this.updateMultisampleRenderTarget=Se,this.setupDepthRenderbuffer=Ct,this.setupFrameBufferTexture=Pe,this.useMultisampledRTT=Ke,this.isReversedDepthBuffer=function(){return t.buffers.depth.getReversed()}}function Y_(l,e){function t(i,s=In){let n;const a=Rt.getTransfer(s);if(i===ls)return l.UNSIGNED_BYTE;if(i===Od)return l.UNSIGNED_SHORT_4_4_4_4;if(i===Nd)return l.UNSIGNED_SHORT_5_5_5_1;if(i===jf)return l.UNSIGNED_INT_5_9_9_9_REV;if(i===Kf)return l.UNSIGNED_INT_10F_11F_11F_REV;if(i===Yf)return l.BYTE;if(i===Qf)return l.SHORT;if(i===Qo)return l.UNSIGNED_SHORT;if(i===Ld)return l.INT;if(i===Qs)return l.UNSIGNED_INT;if(i===vs)return l.FLOAT;if(i===cs)return l.HALF_FLOAT;if(i===Zf)return l.ALPHA;if(i===Jf)return l.RGB;if(i===xs)return l.RGBA;if(i===yn)return l.DEPTH_COMPONENT;if(i===ea)return l.DEPTH_STENCIL;if(i===Bd)return l.RED;if(i===zd)return l.RED_INTEGER;if(i===$a)return l.RG;if(i===Fd)return l.RG_INTEGER;if(i===Ud)return l.RGBA_INTEGER;if(i===yl||i===vl||i===xl||i===bl)if(a===Gt)if(n=e.get("WEBGL_compressed_texture_s3tc_srgb"),n!==null){if(i===yl)return n.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(i===vl)return n.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(i===xl)return n.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(i===bl)return n.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else return null;else if(n=e.get("WEBGL_compressed_texture_s3tc"),n!==null){if(i===yl)return n.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===vl)return n.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===xl)return n.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===bl)return n.COMPRESSED_RGBA_S3TC_DXT5_EXT}else return null;if(i===Ih||i===kh||i===Ph||i===Dh)if(n=e.get("WEBGL_compressed_texture_pvrtc"),n!==null){if(i===Ih)return n.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===kh)return n.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===Ph)return n.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===Dh)return n.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}else return null;if(i===Lh||i===Oh||i===Nh||i===Bh||i===zh||i===Fh||i===Uh)if(n=e.get("WEBGL_compressed_texture_etc"),n!==null){if(i===Lh||i===Oh)return a===Gt?n.COMPRESSED_SRGB8_ETC2:n.COMPRESSED_RGB8_ETC2;if(i===Nh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:n.COMPRESSED_RGBA8_ETC2_EAC;if(i===Bh)return n.COMPRESSED_R11_EAC;if(i===zh)return n.COMPRESSED_SIGNED_R11_EAC;if(i===Fh)return n.COMPRESSED_RG11_EAC;if(i===Uh)return n.COMPRESSED_SIGNED_RG11_EAC}else return null;if(i===Gh||i===Hh||i===qh||i===Wh||i===Vh||i===$h||i===Xh||i===Yh||i===Qh||i===jh||i===Kh||i===Zh||i===Jh||i===ed)if(n=e.get("WEBGL_compressed_texture_astc"),n!==null){if(i===Gh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:n.COMPRESSED_RGBA_ASTC_4x4_KHR;if(i===Hh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:n.COMPRESSED_RGBA_ASTC_5x4_KHR;if(i===qh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:n.COMPRESSED_RGBA_ASTC_5x5_KHR;if(i===Wh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:n.COMPRESSED_RGBA_ASTC_6x5_KHR;if(i===Vh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:n.COMPRESSED_RGBA_ASTC_6x6_KHR;if(i===$h)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:n.COMPRESSED_RGBA_ASTC_8x5_KHR;if(i===Xh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:n.COMPRESSED_RGBA_ASTC_8x6_KHR;if(i===Yh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:n.COMPRESSED_RGBA_ASTC_8x8_KHR;if(i===Qh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:n.COMPRESSED_RGBA_ASTC_10x5_KHR;if(i===jh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:n.COMPRESSED_RGBA_ASTC_10x6_KHR;if(i===Kh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:n.COMPRESSED_RGBA_ASTC_10x8_KHR;if(i===Zh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:n.COMPRESSED_RGBA_ASTC_10x10_KHR;if(i===Jh)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:n.COMPRESSED_RGBA_ASTC_12x10_KHR;if(i===ed)return a===Gt?n.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:n.COMPRESSED_RGBA_ASTC_12x12_KHR}else return null;if(i===td||i===id||i===sd)if(n=e.get("EXT_texture_compression_bptc"),n!==null){if(i===td)return a===Gt?n.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:n.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(i===id)return n.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(i===sd)return n.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}else return null;if(i===nd||i===ad||i===od||i===rd)if(n=e.get("EXT_texture_compression_rgtc"),n!==null){if(i===nd)return n.COMPRESSED_RED_RGTC1_EXT;if(i===ad)return n.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(i===od)return n.COMPRESSED_RED_GREEN_RGTC2_EXT;if(i===rd)return n.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}else return null;return i===jo?l.UNSIGNED_INT_24_8:l[i]!==void 0?l[i]:null}return{convert:t}}const Q_=`
void main() {

	gl_Position = vec4( position, 1.0 );

}`,j_=`
uniform sampler2DArray depthColor;
uniform float depthWidth;
uniform float depthHeight;

void main() {

	vec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );

	if ( coord.x >= 1.0 ) {

		gl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;

	} else {

		gl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;

	}

}`;class K_{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t){if(this.texture===null){const i=new ym(e.texture);(e.depthNear!==t.depthNear||e.depthFar!==t.depthFar)&&(this.depthNear=e.depthNear,this.depthFar=e.depthFar),this.texture=i}}getMesh(e){if(this.texture!==null&&this.mesh===null){const t=e.cameras[0].viewport,i=new Ci({vertexShader:Q_,fragmentShader:j_,uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new w(new Dt(20,20),i)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class Z_ extends la{constructor(e,t){super();const i=this;let s=null,n=1,a=null,o="local-floor",r=1,c=null,h=null,d=null,u=null,p=null,f=null;const y=typeof XRWebGLBinding<"u",m=new K_,g={},x=t.getContextAttributes();let v=null,b=null;const _=[],S=[],A=new le;let R=null;const M=new Wi;M.viewport=new ni;const C=new Wi;C.viewport=new ni;const k=[M,C],L=new jy;let O=null,W=null;this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(Z){let se=_[Z];return se===void 0&&(se=new Sc,_[Z]=se),se.getTargetRaySpace()},this.getControllerGrip=function(Z){let se=_[Z];return se===void 0&&(se=new Sc,_[Z]=se),se.getGripSpace()},this.getHand=function(Z){let se=_[Z];return se===void 0&&(se=new Sc,_[Z]=se),se.getHandSpace()};function U(Z){const se=S.indexOf(Z.inputSource);if(se===-1)return;const Pe=_[se];Pe!==void 0&&(Pe.update(Z.inputSource,Z.frame,c||a),Pe.dispatchEvent({type:Z.type,data:Z.inputSource}))}function $(){s.removeEventListener("select",U),s.removeEventListener("selectstart",U),s.removeEventListener("selectend",U),s.removeEventListener("squeeze",U),s.removeEventListener("squeezestart",U),s.removeEventListener("squeezeend",U),s.removeEventListener("end",$),s.removeEventListener("inputsourceschange",G);for(let Z=0;Z<_.length;Z++){const se=S[Z];se!==null&&(S[Z]=null,_[Z].disconnect(se))}O=null,W=null,m.reset();for(const Z in g)delete g[Z];e.setRenderTarget(v),p=null,u=null,d=null,s=null,b=null,Nt.stop(),i.isPresenting=!1,e.setPixelRatio(R),e.setSize(A.width,A.height,!1),i.dispatchEvent({type:"sessionend"})}this.setFramebufferScaleFactor=function(Z){n=Z,i.isPresenting===!0&&Qe("WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(Z){o=Z,i.isPresenting===!0&&Qe("WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return c||a},this.setReferenceSpace=function(Z){c=Z},this.getBaseLayer=function(){return u!==null?u:p},this.getBinding=function(){return d===null&&y&&(d=new XRWebGLBinding(s,t)),d},this.getFrame=function(){return f},this.getSession=function(){return s},this.setSession=async function(Z){if(s=Z,s!==null){if(v=e.getRenderTarget(),s.addEventListener("select",U),s.addEventListener("selectstart",U),s.addEventListener("selectend",U),s.addEventListener("squeeze",U),s.addEventListener("squeezestart",U),s.addEventListener("squeezeend",U),s.addEventListener("end",$),s.addEventListener("inputsourceschange",G),x.xrCompatible!==!0&&await t.makeXRCompatible(),R=e.getPixelRatio(),e.getSize(A),y&&"createProjectionLayer"in XRWebGLBinding.prototype){let Pe=null,Ze=null,Le=null;x.depth&&(Le=x.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,Pe=x.stencil?ea:yn,Ze=x.stencil?jo:Qs);const Ct={colorFormat:t.RGBA8,depthFormat:Le,scaleFactor:n};d=this.getBinding(),u=d.createProjectionLayer(Ct),s.updateRenderState({layers:[u]}),e.setPixelRatio(1),e.setSize(u.textureWidth,u.textureHeight,!1),b=new ji(u.textureWidth,u.textureHeight,{format:xs,type:ls,depthTexture:new ir(u.textureWidth,u.textureHeight,Ze,void 0,void 0,void 0,void 0,void 0,void 0,Pe),stencilBuffer:x.stencil,colorSpace:e.outputColorSpace,samples:x.antialias?4:0,resolveDepthBuffer:u.ignoreDepthValues===!1,resolveStencilBuffer:u.ignoreDepthValues===!1})}else{const Pe={antialias:x.antialias,alpha:!0,depth:x.depth,stencil:x.stencil,framebufferScaleFactor:n};p=new XRWebGLLayer(s,t,Pe),s.updateRenderState({baseLayer:p}),e.setPixelRatio(1),e.setSize(p.framebufferWidth,p.framebufferHeight,!1),b=new ji(p.framebufferWidth,p.framebufferHeight,{format:xs,type:ls,colorSpace:e.outputColorSpace,stencilBuffer:x.stencil,resolveDepthBuffer:p.ignoreDepthValues===!1,resolveStencilBuffer:p.ignoreDepthValues===!1})}b.isXRRenderTarget=!0,this.setFoveation(r),c=null,a=await s.requestReferenceSpace(o),Nt.setContext(s),Nt.start(),i.isPresenting=!0,i.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(s!==null)return s.environmentBlendMode},this.getDepthTexture=function(){return m.getDepthTexture()};function G(Z){for(let se=0;se<Z.removed.length;se++){const Pe=Z.removed[se],Ze=S.indexOf(Pe);Ze>=0&&(S[Ze]=null,_[Ze].disconnect(Pe))}for(let se=0;se<Z.added.length;se++){const Pe=Z.added[se];let Ze=S.indexOf(Pe);if(Ze===-1){for(let Ct=0;Ct<_.length;Ct++)if(Ct>=S.length){S.push(Pe),Ze=Ct;break}else if(S[Ct]===null){S[Ct]=Pe,Ze=Ct;break}if(Ze===-1)break}const Le=_[Ze];Le&&Le.connect(Pe)}}const ee=new T,pe=new T;function me(Z,se,Pe){ee.setFromMatrixPosition(se.matrixWorld),pe.setFromMatrixPosition(Pe.matrixWorld);const Ze=ee.distanceTo(pe),Le=se.projectionMatrix.elements,Ct=Pe.projectionMatrix.elements,Bt=Le[14]/(Le[10]-1),ht=Le[14]/(Le[10]+1),J=(Le[9]+1)/Le[5],he=(Le[9]-1)/Le[5],oe=(Le[8]-1)/Le[0],Se=(Ct[8]+1)/Ct[0],D=Bt*oe,Ke=Bt*Se,Ae=Ze/(-oe+Se),et=Ae*-oe;if(se.matrixWorld.decompose(Z.position,Z.quaternion,Z.scale),Z.translateX(et),Z.translateZ(Ae),Z.matrixWorld.compose(Z.position,Z.quaternion,Z.scale),Z.matrixWorldInverse.copy(Z.matrixWorld).invert(),Le[10]===-1)Z.projectionMatrix.copy(se.projectionMatrix),Z.projectionMatrixInverse.copy(se.projectionMatrixInverse);else{const ge=Bt+Ae,P=ht+Ae,E=D-et,N=Ke+(Ze-et),Y=J*ht/P*ge,te=he*ht/P*ge;Z.projectionMatrix.makePerspective(E,N,Y,te,ge,P),Z.projectionMatrixInverse.copy(Z.projectionMatrix).invert()}}function ve(Z,se){se===null?Z.matrixWorld.copy(Z.matrix):Z.matrixWorld.multiplyMatrices(se.matrixWorld,Z.matrix),Z.matrixWorldInverse.copy(Z.matrixWorld).invert()}this.updateCamera=function(Z){if(s===null)return;let se=Z.near,Pe=Z.far;m.texture!==null&&(m.depthNear>0&&(se=m.depthNear),m.depthFar>0&&(Pe=m.depthFar)),L.near=C.near=M.near=se,L.far=C.far=M.far=Pe,(O!==L.near||W!==L.far)&&(s.updateRenderState({depthNear:L.near,depthFar:L.far}),O=L.near,W=L.far),L.layers.mask=Z.layers.mask|6,M.layers.mask=L.layers.mask&3,C.layers.mask=L.layers.mask&5;const Ze=Z.parent,Le=L.cameras;ve(L,Ze);for(let Ct=0;Ct<Le.length;Ct++)ve(Le[Ct],Ze);Le.length===2?me(L,M,C):L.projectionMatrix.copy(M.projectionMatrix),tt(Z,L,Ze)};function tt(Z,se,Pe){Pe===null?Z.matrix.copy(se.matrixWorld):(Z.matrix.copy(Pe.matrixWorld),Z.matrix.invert(),Z.matrix.multiply(se.matrixWorld)),Z.matrix.decompose(Z.position,Z.quaternion,Z.scale),Z.updateMatrixWorld(!0),Z.projectionMatrix.copy(se.projectionMatrix),Z.projectionMatrixInverse.copy(se.projectionMatrixInverse),Z.isPerspectiveCamera&&(Z.fov=Xa*2*Math.atan(1/Z.projectionMatrix.elements[5]),Z.zoom=1)}this.getCamera=function(){return L},this.getFoveation=function(){if(!(u===null&&p===null))return r},this.setFoveation=function(Z){r=Z,u!==null&&(u.fixedFoveation=Z),p!==null&&p.fixedFoveation!==void 0&&(p.fixedFoveation=Z)},this.hasDepthSensing=function(){return m.texture!==null},this.getDepthSensingMesh=function(){return m.getMesh(L)},this.getCameraTexture=function(Z){return g[Z]};let je=null;function Ot(Z,se){if(h=se.getViewerPose(c||a),f=se,h!==null){const Pe=h.views;p!==null&&(e.setRenderTargetFramebuffer(b,p.framebuffer),e.setRenderTarget(b));let Ze=!1;Pe.length!==L.cameras.length&&(L.cameras.length=0,Ze=!0);for(let ht=0;ht<Pe.length;ht++){const J=Pe[ht];let he=null;if(p!==null)he=p.getViewport(J);else{const Se=d.getViewSubImage(u,J);he=Se.viewport,ht===0&&(e.setRenderTargetTextures(b,Se.colorTexture,Se.depthStencilTexture),e.setRenderTarget(b))}let oe=k[ht];oe===void 0&&(oe=new Wi,oe.layers.enable(ht),oe.viewport=new ni,k[ht]=oe),oe.matrix.fromArray(J.transform.matrix),oe.matrix.decompose(oe.position,oe.quaternion,oe.scale),oe.projectionMatrix.fromArray(J.projectionMatrix),oe.projectionMatrixInverse.copy(oe.projectionMatrix).invert(),oe.viewport.set(he.x,he.y,he.width,he.height),ht===0&&(L.matrix.copy(oe.matrix),L.matrix.decompose(L.position,L.quaternion,L.scale)),Ze===!0&&L.cameras.push(oe)}const Le=s.enabledFeatures;if(Le&&Le.includes("depth-sensing")&&s.depthUsage=="gpu-optimized"&&y){d=i.getBinding();const ht=d.getDepthInformation(Pe[0]);ht&&ht.isValid&&ht.texture&&m.init(ht,s.renderState)}if(Le&&Le.includes("camera-access")&&y){e.state.unbindTexture(),d=i.getBinding();for(let ht=0;ht<Pe.length;ht++){const J=Pe[ht].camera;if(J){let he=g[J];he||(he=new ym,g[J]=he);const oe=d.getCameraImage(J);he.sourceTexture=oe}}}}for(let Pe=0;Pe<_.length;Pe++){const Ze=S[Pe],Le=_[Pe];Ze!==null&&Le!==void 0&&Le.update(Ze,se,c||a)}je&&je(Z,se),se.detectedPlanes&&i.dispatchEvent({type:"planesdetected",data:se}),f=null}const Nt=new Dm;Nt.setAnimationLoop(Ot),this.setAnimationLoop=function(Z){je=Z},this.dispose=function(){}}}const Wn=new nt,J_=new ut;function eM(l,e){function t(m,g){m.matrixAutoUpdate===!0&&m.updateMatrix(),g.value.copy(m.matrix)}function i(m,g){g.color.getRGB(m.fogColor.value,hm(l)),g.isFog?(m.fogNear.value=g.near,m.fogFar.value=g.far):g.isFogExp2&&(m.fogDensity.value=g.density)}function s(m,g,x,v,b){g.isMeshBasicMaterial||g.isMeshLambertMaterial?n(m,g):g.isMeshToonMaterial?(n(m,g),d(m,g)):g.isMeshPhongMaterial?(n(m,g),h(m,g)):g.isMeshStandardMaterial?(n(m,g),u(m,g),g.isMeshPhysicalMaterial&&p(m,g,b)):g.isMeshMatcapMaterial?(n(m,g),f(m,g)):g.isMeshDepthMaterial?n(m,g):g.isMeshDistanceMaterial?(n(m,g),y(m,g)):g.isMeshNormalMaterial?n(m,g):g.isLineBasicMaterial?(a(m,g),g.isLineDashedMaterial&&o(m,g)):g.isPointsMaterial?r(m,g,x,v):g.isSpriteMaterial?c(m,g):g.isShadowMaterial?(m.color.value.copy(g.color),m.opacity.value=g.opacity):g.isShaderMaterial&&(g.uniformsNeedUpdate=!1)}function n(m,g){m.opacity.value=g.opacity,g.color&&m.diffuse.value.copy(g.color),g.emissive&&m.emissive.value.copy(g.emissive).multiplyScalar(g.emissiveIntensity),g.map&&(m.map.value=g.map,t(g.map,m.mapTransform)),g.alphaMap&&(m.alphaMap.value=g.alphaMap,t(g.alphaMap,m.alphaMapTransform)),g.bumpMap&&(m.bumpMap.value=g.bumpMap,t(g.bumpMap,m.bumpMapTransform),m.bumpScale.value=g.bumpScale,g.side===wi&&(m.bumpScale.value*=-1)),g.normalMap&&(m.normalMap.value=g.normalMap,t(g.normalMap,m.normalMapTransform),m.normalScale.value.copy(g.normalScale),g.side===wi&&m.normalScale.value.negate()),g.displacementMap&&(m.displacementMap.value=g.displacementMap,t(g.displacementMap,m.displacementMapTransform),m.displacementScale.value=g.displacementScale,m.displacementBias.value=g.displacementBias),g.emissiveMap&&(m.emissiveMap.value=g.emissiveMap,t(g.emissiveMap,m.emissiveMapTransform)),g.specularMap&&(m.specularMap.value=g.specularMap,t(g.specularMap,m.specularMapTransform)),g.alphaTest>0&&(m.alphaTest.value=g.alphaTest);const x=e.get(g),v=x.envMap,b=x.envMapRotation;v&&(m.envMap.value=v,Wn.copy(b),Wn.x*=-1,Wn.y*=-1,Wn.z*=-1,v.isCubeTexture&&v.isRenderTargetTexture===!1&&(Wn.y*=-1,Wn.z*=-1),m.envMapRotation.value.setFromMatrix4(J_.makeRotationFromEuler(Wn)),m.flipEnvMap.value=v.isCubeTexture&&v.isRenderTargetTexture===!1?-1:1,m.reflectivity.value=g.reflectivity,m.ior.value=g.ior,m.refractionRatio.value=g.refractionRatio),g.lightMap&&(m.lightMap.value=g.lightMap,m.lightMapIntensity.value=g.lightMapIntensity,t(g.lightMap,m.lightMapTransform)),g.aoMap&&(m.aoMap.value=g.aoMap,m.aoMapIntensity.value=g.aoMapIntensity,t(g.aoMap,m.aoMapTransform))}function a(m,g){m.diffuse.value.copy(g.color),m.opacity.value=g.opacity,g.map&&(m.map.value=g.map,t(g.map,m.mapTransform))}function o(m,g){m.dashSize.value=g.dashSize,m.totalSize.value=g.dashSize+g.gapSize,m.scale.value=g.scale}function r(m,g,x,v){m.diffuse.value.copy(g.color),m.opacity.value=g.opacity,m.size.value=g.size*x,m.scale.value=v*.5,g.map&&(m.map.value=g.map,t(g.map,m.uvTransform)),g.alphaMap&&(m.alphaMap.value=g.alphaMap,t(g.alphaMap,m.alphaMapTransform)),g.alphaTest>0&&(m.alphaTest.value=g.alphaTest)}function c(m,g){m.diffuse.value.copy(g.color),m.opacity.value=g.opacity,m.rotation.value=g.rotation,g.map&&(m.map.value=g.map,t(g.map,m.mapTransform)),g.alphaMap&&(m.alphaMap.value=g.alphaMap,t(g.alphaMap,m.alphaMapTransform)),g.alphaTest>0&&(m.alphaTest.value=g.alphaTest)}function h(m,g){m.specular.value.copy(g.specular),m.shininess.value=Math.max(g.shininess,1e-4)}function d(m,g){g.gradientMap&&(m.gradientMap.value=g.gradientMap)}function u(m,g){m.metalness.value=g.metalness,g.metalnessMap&&(m.metalnessMap.value=g.metalnessMap,t(g.metalnessMap,m.metalnessMapTransform)),m.roughness.value=g.roughness,g.roughnessMap&&(m.roughnessMap.value=g.roughnessMap,t(g.roughnessMap,m.roughnessMapTransform)),g.envMap&&(m.envMapIntensity.value=g.envMapIntensity)}function p(m,g,x){m.ior.value=g.ior,g.sheen>0&&(m.sheenColor.value.copy(g.sheenColor).multiplyScalar(g.sheen),m.sheenRoughness.value=g.sheenRoughness,g.sheenColorMap&&(m.sheenColorMap.value=g.sheenColorMap,t(g.sheenColorMap,m.sheenColorMapTransform)),g.sheenRoughnessMap&&(m.sheenRoughnessMap.value=g.sheenRoughnessMap,t(g.sheenRoughnessMap,m.sheenRoughnessMapTransform))),g.clearcoat>0&&(m.clearcoat.value=g.clearcoat,m.clearcoatRoughness.value=g.clearcoatRoughness,g.clearcoatMap&&(m.clearcoatMap.value=g.clearcoatMap,t(g.clearcoatMap,m.clearcoatMapTransform)),g.clearcoatRoughnessMap&&(m.clearcoatRoughnessMap.value=g.clearcoatRoughnessMap,t(g.clearcoatRoughnessMap,m.clearcoatRoughnessMapTransform)),g.clearcoatNormalMap&&(m.clearcoatNormalMap.value=g.clearcoatNormalMap,t(g.clearcoatNormalMap,m.clearcoatNormalMapTransform),m.clearcoatNormalScale.value.copy(g.clearcoatNormalScale),g.side===wi&&m.clearcoatNormalScale.value.negate())),g.dispersion>0&&(m.dispersion.value=g.dispersion),g.iridescence>0&&(m.iridescence.value=g.iridescence,m.iridescenceIOR.value=g.iridescenceIOR,m.iridescenceThicknessMinimum.value=g.iridescenceThicknessRange[0],m.iridescenceThicknessMaximum.value=g.iridescenceThicknessRange[1],g.iridescenceMap&&(m.iridescenceMap.value=g.iridescenceMap,t(g.iridescenceMap,m.iridescenceMapTransform)),g.iridescenceThicknessMap&&(m.iridescenceThicknessMap.value=g.iridescenceThicknessMap,t(g.iridescenceThicknessMap,m.iridescenceThicknessMapTransform))),g.transmission>0&&(m.transmission.value=g.transmission,m.transmissionSamplerMap.value=x.texture,m.transmissionSamplerSize.value.set(x.width,x.height),g.transmissionMap&&(m.transmissionMap.value=g.transmissionMap,t(g.transmissionMap,m.transmissionMapTransform)),m.thickness.value=g.thickness,g.thicknessMap&&(m.thicknessMap.value=g.thicknessMap,t(g.thicknessMap,m.thicknessMapTransform)),m.attenuationDistance.value=g.attenuationDistance,m.attenuationColor.value.copy(g.attenuationColor)),g.anisotropy>0&&(m.anisotropyVector.value.set(g.anisotropy*Math.cos(g.anisotropyRotation),g.anisotropy*Math.sin(g.anisotropyRotation)),g.anisotropyMap&&(m.anisotropyMap.value=g.anisotropyMap,t(g.anisotropyMap,m.anisotropyMapTransform))),m.specularIntensity.value=g.specularIntensity,m.specularColor.value.copy(g.specularColor),g.specularColorMap&&(m.specularColorMap.value=g.specularColorMap,t(g.specularColorMap,m.specularColorMapTransform)),g.specularIntensityMap&&(m.specularIntensityMap.value=g.specularIntensityMap,t(g.specularIntensityMap,m.specularIntensityMapTransform))}function f(m,g){g.matcap&&(m.matcap.value=g.matcap)}function y(m,g){const x=e.get(g).light;m.referencePosition.value.setFromMatrixPosition(x.matrixWorld),m.nearDistance.value=x.shadow.camera.near,m.farDistance.value=x.shadow.camera.far}return{refreshFogUniforms:i,refreshMaterialUniforms:s}}function tM(l,e,t,i){let s={},n={},a=[];const o=l.getParameter(l.MAX_UNIFORM_BUFFER_BINDINGS);function r(x,v){const b=v.program;i.uniformBlockBinding(x,b)}function c(x,v){let b=s[x.id];b===void 0&&(f(x),b=h(x),s[x.id]=b,x.addEventListener("dispose",m));const _=v.program;i.updateUBOMapping(x,_);const S=e.render.frame;n[x.id]!==S&&(u(x),n[x.id]=S)}function h(x){const v=d();x.__bindingPointIndex=v;const b=l.createBuffer(),_=x.__size,S=x.usage;return l.bindBuffer(l.UNIFORM_BUFFER,b),l.bufferData(l.UNIFORM_BUFFER,_,S),l.bindBuffer(l.UNIFORM_BUFFER,null),l.bindBufferBase(l.UNIFORM_BUFFER,v,b),b}function d(){for(let x=0;x<o;x++)if(a.indexOf(x)===-1)return a.push(x),x;return rt("WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}function u(x){const v=s[x.id],b=x.uniforms,_=x.__cache;l.bindBuffer(l.UNIFORM_BUFFER,v);for(let S=0,A=b.length;S<A;S++){const R=Array.isArray(b[S])?b[S]:[b[S]];for(let M=0,C=R.length;M<C;M++){const k=R[M];if(p(k,S,M,_)===!0){const L=k.__offset,O=Array.isArray(k.value)?k.value:[k.value];let W=0;for(let U=0;U<O.length;U++){const $=O[U],G=y($);typeof $=="number"||typeof $=="boolean"?(k.__data[0]=$,l.bufferSubData(l.UNIFORM_BUFFER,L+W,k.__data)):$.isMatrix3?(k.__data[0]=$.elements[0],k.__data[1]=$.elements[1],k.__data[2]=$.elements[2],k.__data[3]=0,k.__data[4]=$.elements[3],k.__data[5]=$.elements[4],k.__data[6]=$.elements[5],k.__data[7]=0,k.__data[8]=$.elements[6],k.__data[9]=$.elements[7],k.__data[10]=$.elements[8],k.__data[11]=0):($.toArray(k.__data,W),W+=G.storage/Float32Array.BYTES_PER_ELEMENT)}l.bufferSubData(l.UNIFORM_BUFFER,L,k.__data)}}}l.bindBuffer(l.UNIFORM_BUFFER,null)}function p(x,v,b,_){const S=x.value,A=v+"_"+b;if(_[A]===void 0)return typeof S=="number"||typeof S=="boolean"?_[A]=S:_[A]=S.clone(),!0;{const R=_[A];if(typeof S=="number"||typeof S=="boolean"){if(R!==S)return _[A]=S,!0}else if(R.equals(S)===!1)return R.copy(S),!0}return!1}function f(x){const v=x.uniforms;let b=0;const _=16;for(let A=0,R=v.length;A<R;A++){const M=Array.isArray(v[A])?v[A]:[v[A]];for(let C=0,k=M.length;C<k;C++){const L=M[C],O=Array.isArray(L.value)?L.value:[L.value];for(let W=0,U=O.length;W<U;W++){const $=O[W],G=y($),ee=b%_,pe=ee%G.boundary,me=ee+pe;b+=pe,me!==0&&_-me<G.storage&&(b+=_-me),L.__data=new Float32Array(G.storage/Float32Array.BYTES_PER_ELEMENT),L.__offset=b,b+=G.storage}}}const S=b%_;return S>0&&(b+=_-S),x.__size=b,x.__cache={},this}function y(x){const v={boundary:0,storage:0};return typeof x=="number"||typeof x=="boolean"?(v.boundary=4,v.storage=4):x.isVector2?(v.boundary=8,v.storage=8):x.isVector3||x.isColor?(v.boundary=16,v.storage=12):x.isVector4?(v.boundary=16,v.storage=16):x.isMatrix3?(v.boundary=48,v.storage=48):x.isMatrix4?(v.boundary=64,v.storage=64):x.isTexture?Qe("WebGLRenderer: Texture samplers can not be part of an uniforms group."):Qe("WebGLRenderer: Unsupported uniform value type.",x),v}function m(x){const v=x.target;v.removeEventListener("dispose",m);const b=a.indexOf(v.__bindingPointIndex);a.splice(b,1),l.deleteBuffer(s[v.id]),delete s[v.id],delete n[v.id]}function g(){for(const x in s)l.deleteBuffer(s[x]);a=[],s={},n={}}return{bind:r,update:c,dispose:g}}const iM=new Uint16Array([12469,15057,12620,14925,13266,14620,13807,14376,14323,13990,14545,13625,14713,13328,14840,12882,14931,12528,14996,12233,15039,11829,15066,11525,15080,11295,15085,10976,15082,10705,15073,10495,13880,14564,13898,14542,13977,14430,14158,14124,14393,13732,14556,13410,14702,12996,14814,12596,14891,12291,14937,11834,14957,11489,14958,11194,14943,10803,14921,10506,14893,10278,14858,9960,14484,14039,14487,14025,14499,13941,14524,13740,14574,13468,14654,13106,14743,12678,14818,12344,14867,11893,14889,11509,14893,11180,14881,10751,14852,10428,14812,10128,14765,9754,14712,9466,14764,13480,14764,13475,14766,13440,14766,13347,14769,13070,14786,12713,14816,12387,14844,11957,14860,11549,14868,11215,14855,10751,14825,10403,14782,10044,14729,9651,14666,9352,14599,9029,14967,12835,14966,12831,14963,12804,14954,12723,14936,12564,14917,12347,14900,11958,14886,11569,14878,11247,14859,10765,14828,10401,14784,10011,14727,9600,14660,9289,14586,8893,14508,8533,15111,12234,15110,12234,15104,12216,15092,12156,15067,12010,15028,11776,14981,11500,14942,11205,14902,10752,14861,10393,14812,9991,14752,9570,14682,9252,14603,8808,14519,8445,14431,8145,15209,11449,15208,11451,15202,11451,15190,11438,15163,11384,15117,11274,15055,10979,14994,10648,14932,10343,14871,9936,14803,9532,14729,9218,14645,8742,14556,8381,14461,8020,14365,7603,15273,10603,15272,10607,15267,10619,15256,10631,15231,10614,15182,10535,15118,10389,15042,10167,14963,9787,14883,9447,14800,9115,14710,8665,14615,8318,14514,7911,14411,7507,14279,7198,15314,9675,15313,9683,15309,9712,15298,9759,15277,9797,15229,9773,15166,9668,15084,9487,14995,9274,14898,8910,14800,8539,14697,8234,14590,7790,14479,7409,14367,7067,14178,6621,15337,8619,15337,8631,15333,8677,15325,8769,15305,8871,15264,8940,15202,8909,15119,8775,15022,8565,14916,8328,14804,8009,14688,7614,14569,7287,14448,6888,14321,6483,14088,6171,15350,7402,15350,7419,15347,7480,15340,7613,15322,7804,15287,7973,15229,8057,15148,8012,15046,7846,14933,7611,14810,7357,14682,7069,14552,6656,14421,6316,14251,5948,14007,5528,15356,5942,15356,5977,15353,6119,15348,6294,15332,6551,15302,6824,15249,7044,15171,7122,15070,7050,14949,6861,14818,6611,14679,6349,14538,6067,14398,5651,14189,5311,13935,4958,15359,4123,15359,4153,15356,4296,15353,4646,15338,5160,15311,5508,15263,5829,15188,6042,15088,6094,14966,6001,14826,5796,14678,5543,14527,5287,14377,4985,14133,4586,13869,4257,15360,1563,15360,1642,15358,2076,15354,2636,15341,3350,15317,4019,15273,4429,15203,4732,15105,4911,14981,4932,14836,4818,14679,4621,14517,4386,14359,4156,14083,3795,13808,3437,15360,122,15360,137,15358,285,15355,636,15344,1274,15322,2177,15281,2765,15215,3223,15120,3451,14995,3569,14846,3567,14681,3466,14511,3305,14344,3121,14037,2800,13753,2467,15360,0,15360,1,15359,21,15355,89,15346,253,15325,479,15287,796,15225,1148,15133,1492,15008,1749,14856,1882,14685,1886,14506,1783,14324,1608,13996,1398,13702,1183]);let ks=null;function sM(){return ks===null&&(ks=new Yd(iM,16,16,$a,cs),ks.name="DFG_LUT",ks.minFilter=bi,ks.magFilter=bi,ks.wrapS=Us,ks.wrapT=Us,ks.generateMipmaps=!1,ks.needsUpdate=!0),ks}class nM{constructor(e={}){const{canvas:t=eg(),context:i=null,depth:s=!0,stencil:n=!1,alpha:a=!1,antialias:o=!1,premultipliedAlpha:r=!0,preserveDrawingBuffer:c=!1,powerPreference:h="default",failIfMajorPerformanceCaveat:d=!1,reversedDepthBuffer:u=!1,outputBufferType:p=ls}=e;this.isWebGLRenderer=!0;let f;if(i!==null){if(typeof WebGLRenderingContext<"u"&&i instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");f=i.getContextAttributes().alpha}else f=a;const y=p,m=new Set([Ud,Fd,zd]),g=new Set([ls,Qs,Qo,jo,Od,Nd]),x=new Uint32Array(4),v=new Int32Array(4);let b=null,_=null;const S=[],A=[];let R=null;this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.toneMapping=Ws,this.toneMappingExposure=1,this.transmissionResolutionScale=1;const M=this;let C=!1;this._outputColorSpace=pi;let k=0,L=0,O=null,W=-1,U=null;const $=new ni,G=new ni;let ee=null;const pe=new H(0);let me=0,ve=t.width,tt=t.height,je=1,Ot=null,Nt=null;const Z=new ni(0,0,ve,tt),se=new ni(0,0,ve,tt);let Pe=!1;const Ze=new jd;let Le=!1,Ct=!1;const Bt=new ut,ht=new T,J=new ni,he={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let oe=!1;function Se(){return O===null?je:1}let D=i;function Ke(I,F){return t.getContext(I,F)}try{const I={alpha:!0,depth:s,stencil:n,antialias:o,premultipliedAlpha:r,preserveDrawingBuffer:c,powerPreference:h,failIfMajorPerformanceCaveat:d};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${Cd}`),t.addEventListener("webglcontextlost",pt,!1),t.addEventListener("webglcontextrestored",jt,!1),t.addEventListener("webglcontextcreationerror",qt,!1),D===null){const F="webgl2";if(D=Ke(F,I),D===null)throw Ke(F)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(I){throw rt("WebGLRenderer: "+I.message),I}let Ae,et,ge,P,E,N,Y,te,K,He,we,Ue,at,de,Te,Ge,Ve,Me,_t,z,De,ye,Ne,ue;function ae(){Ae=new sw(D),Ae.init(),ye=new Y_(D,Ae),et=new Yb(D,Ae,e,ye),ge=new $_(D,Ae),et.reversedDepthBuffer&&u&&ge.buffers.depth.setReversed(!0),P=new ow(D),E=new k_,N=new X_(D,Ae,ge,E,et,ye,P),Y=new jb(M),te=new iw(M),K=new hv(D),Ne=new $b(D,K),He=new nw(D,K,P,Ne),we=new lw(D,He,K,P),_t=new rw(D,et,N),Ge=new Qb(E),Ue=new I_(M,Y,te,Ae,et,Ne,Ge),at=new eM(M,E),de=new D_,Te=new F_(Ae),Me=new Vb(M,Y,te,ge,we,f,r),Ve=new W_(M,we,et),ue=new tM(D,P,et,ge),z=new Xb(D,Ae,P),De=new aw(D,Ae,P),P.programs=Ue.programs,M.capabilities=et,M.extensions=Ae,M.properties=E,M.renderLists=de,M.shadowMap=Ve,M.state=ge,M.info=P}ae(),y!==ls&&(R=new hw(y,t.width,t.height,s,n));const _e=new Z_(M,D);this.xr=_e,this.getContext=function(){return D},this.getContextAttributes=function(){return D.getContextAttributes()},this.forceContextLoss=function(){const I=Ae.get("WEBGL_lose_context");I&&I.loseContext()},this.forceContextRestore=function(){const I=Ae.get("WEBGL_lose_context");I&&I.restoreContext()},this.getPixelRatio=function(){return je},this.setPixelRatio=function(I){I!==void 0&&(je=I,this.setSize(ve,tt,!1))},this.getSize=function(I){return I.set(ve,tt)},this.setSize=function(I,F,j=!0){if(_e.isPresenting){Qe("WebGLRenderer: Can't change size while VR device is presenting.");return}ve=I,tt=F,t.width=Math.floor(I*je),t.height=Math.floor(F*je),j===!0&&(t.style.width=I+"px",t.style.height=F+"px"),R!==null&&R.setSize(t.width,t.height),this.setViewport(0,0,I,F)},this.getDrawingBufferSize=function(I){return I.set(ve*je,tt*je).floor()},this.setDrawingBufferSize=function(I,F,j){ve=I,tt=F,je=j,t.width=Math.floor(I*j),t.height=Math.floor(F*j),this.setViewport(0,0,I,F)},this.setEffects=function(I){if(y===ls){console.error("THREE.WebGLRenderer: setEffects() requires outputBufferType set to HalfFloatType or FloatType.");return}if(I){for(let F=0;F<I.length;F++)if(I[F].isOutputPass===!0){console.warn("THREE.WebGLRenderer: OutputPass is not needed in setEffects(). Tone mapping and color space conversion are applied automatically.");break}}R.setEffects(I||[])},this.getCurrentViewport=function(I){return I.copy($)},this.getViewport=function(I){return I.copy(Z)},this.setViewport=function(I,F,j,Q){I.isVector4?Z.set(I.x,I.y,I.z,I.w):Z.set(I,F,j,Q),ge.viewport($.copy(Z).multiplyScalar(je).round())},this.getScissor=function(I){return I.copy(se)},this.setScissor=function(I,F,j,Q){I.isVector4?se.set(I.x,I.y,I.z,I.w):se.set(I,F,j,Q),ge.scissor(G.copy(se).multiplyScalar(je).round())},this.getScissorTest=function(){return Pe},this.setScissorTest=function(I){ge.setScissorTest(Pe=I)},this.setOpaqueSort=function(I){Ot=I},this.setTransparentSort=function(I){Nt=I},this.getClearColor=function(I){return I.copy(Me.getClearColor())},this.setClearColor=function(){Me.setClearColor(...arguments)},this.getClearAlpha=function(){return Me.getClearAlpha()},this.setClearAlpha=function(){Me.setClearAlpha(...arguments)},this.clear=function(I=!0,F=!0,j=!0){let Q=0;if(I){let V=!1;if(O!==null){const Ee=O.texture.format;V=m.has(Ee)}if(V){const Ee=O.texture.type,Be=g.has(Ee),Re=Me.getClearColor(),ze=Me.getClearAlpha(),$e=Re.r,ct=Re.g,it=Re.b;Be?(x[0]=$e,x[1]=ct,x[2]=it,x[3]=ze,D.clearBufferuiv(D.COLOR,0,x)):(v[0]=$e,v[1]=ct,v[2]=it,v[3]=ze,D.clearBufferiv(D.COLOR,0,v))}else Q|=D.COLOR_BUFFER_BIT}F&&(Q|=D.DEPTH_BUFFER_BIT),j&&(Q|=D.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),D.clear(Q)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",pt,!1),t.removeEventListener("webglcontextrestored",jt,!1),t.removeEventListener("webglcontextcreationerror",qt,!1),Me.dispose(),de.dispose(),Te.dispose(),E.dispose(),Y.dispose(),te.dispose(),we.dispose(),Ne.dispose(),ue.dispose(),Ue.dispose(),_e.dispose(),_e.removeEventListener("sessionstart",gu),_e.removeEventListener("sessionend",yu),Bn.stop()};function pt(I){I.preventDefault(),Pl("WebGLRenderer: Context Lost."),C=!0}function jt(){Pl("WebGLRenderer: Context Restored."),C=!1;const I=P.autoReset,F=Ve.enabled,j=Ve.autoUpdate,Q=Ve.needsUpdate,V=Ve.type;ae(),P.autoReset=I,Ve.enabled=F,Ve.autoUpdate=j,Ve.needsUpdate=Q,Ve.type=V}function qt(I){rt("WebGLRenderer: A WebGL context could not be created. Reason: ",I.statusMessage)}function Is(I){const F=I.target;F.removeEventListener("dispose",Is),tn(F)}function tn(I){d0(I),E.remove(I)}function d0(I){const F=E.get(I).programs;F!==void 0&&(F.forEach(function(j){Ue.releaseProgram(j)}),I.isShaderMaterial&&Ue.releaseShaderCache(I))}this.renderBufferDirect=function(I,F,j,Q,V,Ee){F===null&&(F=he);const Be=V.isMesh&&V.matrixWorld.determinant()<0,Re=p0(I,F,j,Q,V);ge.setMaterial(Q,Be);let ze=j.index,$e=1;if(Q.wireframe===!0){if(ze=He.getWireframeAttribute(j),ze===void 0)return;$e=2}const ct=j.drawRange,it=j.attributes.position;let Et=ct.start*$e,$t=(ct.start+ct.count)*$e;Ee!==null&&(Et=Math.max(Et,Ee.start*$e),$t=Math.min($t,(Ee.start+Ee.count)*$e)),ze!==null?(Et=Math.max(Et,0),$t=Math.min($t,ze.count)):it!=null&&(Et=Math.max(Et,0),$t=Math.min($t,it.count));const hi=$t-Et;if(hi<0||hi===1/0)return;Ne.setup(V,Q,Re,j,ze);let di,Yt=z;if(ze!==null&&(di=K.get(ze),Yt=De,Yt.setIndex(di)),V.isMesh)Q.wireframe===!0?(ge.setLineWidth(Q.wireframeLinewidth*Se()),Yt.setMode(D.LINES)):Yt.setMode(D.TRIANGLES);else if(V.isLine){let st=Q.linewidth;st===void 0&&(st=1),ge.setLineWidth(st*Se()),V.isLineSegments?Yt.setMode(D.LINES):V.isLineLoop?Yt.setMode(D.LINE_LOOP):Yt.setMode(D.LINE_STRIP)}else V.isPoints?Yt.setMode(D.POINTS):V.isSprite&&Yt.setMode(D.TRIANGLES);if(V.isBatchedMesh)if(V._multiDrawInstances!==null)er("WebGLRenderer: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),Yt.renderMultiDrawInstances(V._multiDrawStarts,V._multiDrawCounts,V._multiDrawCount,V._multiDrawInstances);else if(Ae.get("WEBGL_multi_draw"))Yt.renderMultiDraw(V._multiDrawStarts,V._multiDrawCounts,V._multiDrawCount);else{const st=V._multiDrawStarts,Wt=V._multiDrawCounts,zt=V._multiDrawCount,is=ze?K.get(ze).bytesPerElement:1,da=E.get(Q).currentProgram.getUniforms();for(let ss=0;ss<zt;ss++)da.setValue(D,"_gl_DrawID",ss),Yt.render(st[ss]/is,Wt[ss])}else if(V.isInstancedMesh)Yt.renderInstances(Et,hi,V.count);else if(j.isInstancedBufferGeometry){const st=j._maxInstanceCount!==void 0?j._maxInstanceCount:1/0,Wt=Math.min(j.instanceCount,st);Yt.renderInstances(Et,hi,Wt)}else Yt.render(Et,hi)};function mu(I,F,j){I.transparent===!0&&I.side===lt&&I.forceSinglePass===!1?(I.side=wi,I.needsUpdate=!0,xr(I,F,j),I.side=Xs,I.needsUpdate=!0,xr(I,F,j),I.side=lt):xr(I,F,j)}this.compile=function(I,F,j=null){j===null&&(j=I),_=Te.get(j),_.init(F),A.push(_),j.traverseVisible(function(V){V.isLight&&V.layers.test(F.layers)&&(_.pushLight(V),V.castShadow&&_.pushShadow(V))}),I!==j&&I.traverseVisible(function(V){V.isLight&&V.layers.test(F.layers)&&(_.pushLight(V),V.castShadow&&_.pushShadow(V))}),_.setupLights();const Q=new Set;return I.traverse(function(V){if(!(V.isMesh||V.isPoints||V.isLine||V.isSprite))return;const Ee=V.material;if(Ee)if(Array.isArray(Ee))for(let Be=0;Be<Ee.length;Be++){const Re=Ee[Be];mu(Re,j,V),Q.add(Re)}else mu(Ee,j,V),Q.add(Ee)}),_=A.pop(),Q},this.compileAsync=function(I,F,j=null){const Q=this.compile(I,F,j);return new Promise(V=>{function Ee(){if(Q.forEach(function(Be){E.get(Be).currentProgram.isReady()&&Q.delete(Be)}),Q.size===0){V(I);return}setTimeout(Ee,10)}Ae.get("KHR_parallel_shader_compile")!==null?Ee():setTimeout(Ee,10)})};let ec=null;function u0(I){ec&&ec(I)}function gu(){Bn.stop()}function yu(){Bn.start()}const Bn=new Dm;Bn.setAnimationLoop(u0),typeof self<"u"&&Bn.setContext(self),this.setAnimationLoop=function(I){ec=I,_e.setAnimationLoop(I),I===null?Bn.stop():Bn.start()},_e.addEventListener("sessionstart",gu),_e.addEventListener("sessionend",yu),this.render=function(I,F){if(F!==void 0&&F.isCamera!==!0){rt("WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}if(C===!0)return;const j=_e.enabled===!0&&_e.isPresenting===!0,Q=R!==null&&(O===null||j)&&R.begin(M,O);if(I.matrixWorldAutoUpdate===!0&&I.updateMatrixWorld(),F.parent===null&&F.matrixWorldAutoUpdate===!0&&F.updateMatrixWorld(),_e.enabled===!0&&_e.isPresenting===!0&&(R===null||R.isCompositing()===!1)&&(_e.cameraAutoUpdate===!0&&_e.updateCamera(F),F=_e.getCamera()),I.isScene===!0&&I.onBeforeRender(M,I,F,O),_=Te.get(I,A.length),_.init(F),A.push(_),Bt.multiplyMatrices(F.projectionMatrix,F.matrixWorldInverse),Ze.setFromProjectionMatrix(Bt,Gs,F.reversedDepth),Ct=this.localClippingEnabled,Le=Ge.init(this.clippingPlanes,Ct),b=de.get(I,S.length),b.init(),S.push(b),_e.enabled===!0&&_e.isPresenting===!0){const Be=M.xr.getDepthSensingMesh();Be!==null&&tc(Be,F,-1/0,M.sortObjects)}tc(I,F,0,M.sortObjects),b.finish(),M.sortObjects===!0&&b.sort(Ot,Nt),oe=_e.enabled===!1||_e.isPresenting===!1||_e.hasDepthSensing()===!1,oe&&Me.addToRenderList(b,I),this.info.render.frame++,Le===!0&&Ge.beginShadows();const V=_.state.shadowsArray;if(Ve.render(V,I,F),Le===!0&&Ge.endShadows(),this.info.autoReset===!0&&this.info.reset(),(Q&&R.hasRenderPass())===!1){const Be=b.opaque,Re=b.transmissive;if(_.setupLights(),F.isArrayCamera){const ze=F.cameras;if(Re.length>0)for(let $e=0,ct=ze.length;$e<ct;$e++){const it=ze[$e];xu(Be,Re,I,it)}oe&&Me.render(I);for(let $e=0,ct=ze.length;$e<ct;$e++){const it=ze[$e];vu(b,I,it,it.viewport)}}else Re.length>0&&xu(Be,Re,I,F),oe&&Me.render(I),vu(b,I,F)}O!==null&&L===0&&(N.updateMultisampleRenderTarget(O),N.updateRenderTargetMipmap(O)),Q&&R.end(M),I.isScene===!0&&I.onAfterRender(M,I,F),Ne.resetDefaultState(),W=-1,U=null,A.pop(),A.length>0?(_=A[A.length-1],Le===!0&&Ge.setGlobalState(M.clippingPlanes,_.state.camera)):_=null,S.pop(),S.length>0?b=S[S.length-1]:b=null};function tc(I,F,j,Q){if(I.visible===!1)return;if(I.layers.test(F.layers)){if(I.isGroup)j=I.renderOrder;else if(I.isLOD)I.autoUpdate===!0&&I.update(F);else if(I.isLight)_.pushLight(I),I.castShadow&&_.pushShadow(I);else if(I.isSprite){if(!I.frustumCulled||Ze.intersectsSprite(I)){Q&&J.setFromMatrixPosition(I.matrixWorld).applyMatrix4(Bt);const Be=we.update(I),Re=I.material;Re.visible&&b.push(I,Be,Re,j,J.z,null)}}else if((I.isMesh||I.isLine||I.isPoints)&&(!I.frustumCulled||Ze.intersectsObject(I))){const Be=we.update(I),Re=I.material;if(Q&&(I.boundingSphere!==void 0?(I.boundingSphere===null&&I.computeBoundingSphere(),J.copy(I.boundingSphere.center)):(Be.boundingSphere===null&&Be.computeBoundingSphere(),J.copy(Be.boundingSphere.center)),J.applyMatrix4(I.matrixWorld).applyMatrix4(Bt)),Array.isArray(Re)){const ze=Be.groups;for(let $e=0,ct=ze.length;$e<ct;$e++){const it=ze[$e],Et=Re[it.materialIndex];Et&&Et.visible&&b.push(I,Be,Et,j,J.z,it)}}else Re.visible&&b.push(I,Be,Re,j,J.z,null)}}const Ee=I.children;for(let Be=0,Re=Ee.length;Be<Re;Be++)tc(Ee[Be],F,j,Q)}function vu(I,F,j,Q){const{opaque:V,transmissive:Ee,transparent:Be}=I;_.setupLightsView(j),Le===!0&&Ge.setGlobalState(M.clippingPlanes,j),Q&&ge.viewport($.copy(Q)),V.length>0&&vr(V,F,j),Ee.length>0&&vr(Ee,F,j),Be.length>0&&vr(Be,F,j),ge.buffers.depth.setTest(!0),ge.buffers.depth.setMask(!0),ge.buffers.color.setMask(!0),ge.setPolygonOffset(!1)}function xu(I,F,j,Q){if((j.isScene===!0?j.overrideMaterial:null)!==null)return;if(_.state.transmissionRenderTarget[Q.id]===void 0){const Et=Ae.has("EXT_color_buffer_half_float")||Ae.has("EXT_color_buffer_float");_.state.transmissionRenderTarget[Q.id]=new ji(1,1,{generateMipmaps:!0,type:Et?cs:ls,minFilter:un,samples:et.samples,stencilBuffer:n,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:Rt.workingColorSpace})}const Ee=_.state.transmissionRenderTarget[Q.id],Be=Q.viewport||$;Ee.setSize(Be.z*M.transmissionResolutionScale,Be.w*M.transmissionResolutionScale);const Re=M.getRenderTarget(),ze=M.getActiveCubeFace(),$e=M.getActiveMipmapLevel();M.setRenderTarget(Ee),M.getClearColor(pe),me=M.getClearAlpha(),me<1&&M.setClearColor(16777215,.5),M.clear(),oe&&Me.render(j);const ct=M.toneMapping;M.toneMapping=Ws;const it=Q.viewport;if(Q.viewport!==void 0&&(Q.viewport=void 0),_.setupLightsView(Q),Le===!0&&Ge.setGlobalState(M.clippingPlanes,Q),vr(I,j,Q),N.updateMultisampleRenderTarget(Ee),N.updateRenderTargetMipmap(Ee),Ae.has("WEBGL_multisampled_render_to_texture")===!1){let Et=!1;for(let $t=0,hi=F.length;$t<hi;$t++){const di=F[$t],{object:Yt,geometry:st,material:Wt,group:zt}=di;if(Wt.side===lt&&Yt.layers.test(Q.layers)){const is=Wt.side;Wt.side=wi,Wt.needsUpdate=!0,bu(Yt,j,Q,st,Wt,zt),Wt.side=is,Wt.needsUpdate=!0,Et=!0}}Et===!0&&(N.updateMultisampleRenderTarget(Ee),N.updateRenderTargetMipmap(Ee))}M.setRenderTarget(Re,ze,$e),M.setClearColor(pe,me),it!==void 0&&(Q.viewport=it),M.toneMapping=ct}function vr(I,F,j){const Q=F.isScene===!0?F.overrideMaterial:null;for(let V=0,Ee=I.length;V<Ee;V++){const Be=I[V],{object:Re,geometry:ze,group:$e}=Be;let ct=Be.material;ct.allowOverride===!0&&Q!==null&&(ct=Q),Re.layers.test(j.layers)&&bu(Re,F,j,ze,ct,$e)}}function bu(I,F,j,Q,V,Ee){I.onBeforeRender(M,F,j,Q,V,Ee),I.modelViewMatrix.multiplyMatrices(j.matrixWorldInverse,I.matrixWorld),I.normalMatrix.getNormalMatrix(I.modelViewMatrix),V.onBeforeRender(M,F,j,Q,I,Ee),V.transparent===!0&&V.side===lt&&V.forceSinglePass===!1?(V.side=wi,V.needsUpdate=!0,M.renderBufferDirect(j,F,Q,V,I,Ee),V.side=Xs,V.needsUpdate=!0,M.renderBufferDirect(j,F,Q,V,I,Ee),V.side=lt):M.renderBufferDirect(j,F,Q,V,I,Ee),I.onAfterRender(M,F,j,Q,V,Ee)}function xr(I,F,j){F.isScene!==!0&&(F=he);const Q=E.get(I),V=_.state.lights,Ee=_.state.shadowsArray,Be=V.state.version,Re=Ue.getParameters(I,V.state,Ee,F,j),ze=Ue.getProgramCacheKey(Re);let $e=Q.programs;Q.environment=I.isMeshStandardMaterial?F.environment:null,Q.fog=F.fog,Q.envMap=(I.isMeshStandardMaterial?te:Y).get(I.envMap||Q.environment),Q.envMapRotation=Q.environment!==null&&I.envMap===null?F.environmentRotation:I.envMapRotation,$e===void 0&&(I.addEventListener("dispose",Is),$e=new Map,Q.programs=$e);let ct=$e.get(ze);if(ct!==void 0){if(Q.currentProgram===ct&&Q.lightsStateVersion===Be)return _u(I,Re),ct}else Re.uniforms=Ue.getUniforms(I),I.onBeforeCompile(Re,M),ct=Ue.acquireProgram(Re,ze),$e.set(ze,ct),Q.uniforms=Re.uniforms;const it=Q.uniforms;return(!I.isShaderMaterial&&!I.isRawShaderMaterial||I.clipping===!0)&&(it.clippingPlanes=Ge.uniform),_u(I,Re),Q.needsLights=m0(I),Q.lightsStateVersion=Be,Q.needsLights&&(it.ambientLightColor.value=V.state.ambient,it.lightProbe.value=V.state.probe,it.directionalLights.value=V.state.directional,it.directionalLightShadows.value=V.state.directionalShadow,it.spotLights.value=V.state.spot,it.spotLightShadows.value=V.state.spotShadow,it.rectAreaLights.value=V.state.rectArea,it.ltc_1.value=V.state.rectAreaLTC1,it.ltc_2.value=V.state.rectAreaLTC2,it.pointLights.value=V.state.point,it.pointLightShadows.value=V.state.pointShadow,it.hemisphereLights.value=V.state.hemi,it.directionalShadowMap.value=V.state.directionalShadowMap,it.directionalShadowMatrix.value=V.state.directionalShadowMatrix,it.spotShadowMap.value=V.state.spotShadowMap,it.spotLightMatrix.value=V.state.spotLightMatrix,it.spotLightMap.value=V.state.spotLightMap,it.pointShadowMap.value=V.state.pointShadowMap,it.pointShadowMatrix.value=V.state.pointShadowMatrix),Q.currentProgram=ct,Q.uniformsList=null,ct}function wu(I){if(I.uniformsList===null){const F=I.currentProgram.getUniforms();I.uniformsList=wl.seqWithValue(F.seq,I.uniforms)}return I.uniformsList}function _u(I,F){const j=E.get(I);j.outputColorSpace=F.outputColorSpace,j.batching=F.batching,j.batchingColor=F.batchingColor,j.instancing=F.instancing,j.instancingColor=F.instancingColor,j.instancingMorph=F.instancingMorph,j.skinning=F.skinning,j.morphTargets=F.morphTargets,j.morphNormals=F.morphNormals,j.morphColors=F.morphColors,j.morphTargetsCount=F.morphTargetsCount,j.numClippingPlanes=F.numClippingPlanes,j.numIntersection=F.numClipIntersection,j.vertexAlphas=F.vertexAlphas,j.vertexTangents=F.vertexTangents,j.toneMapping=F.toneMapping}function p0(I,F,j,Q,V){F.isScene!==!0&&(F=he),N.resetTextureUnits();const Ee=F.fog,Be=Q.isMeshStandardMaterial?F.environment:null,Re=O===null?M.outputColorSpace:O.isXRRenderTarget===!0?O.texture.colorSpace:zi,ze=(Q.isMeshStandardMaterial?te:Y).get(Q.envMap||Be),$e=Q.vertexColors===!0&&!!j.attributes.color&&j.attributes.color.itemSize===4,ct=!!j.attributes.tangent&&(!!Q.normalMap||Q.anisotropy>0),it=!!j.morphAttributes.position,Et=!!j.morphAttributes.normal,$t=!!j.morphAttributes.color;let hi=Ws;Q.toneMapped&&(O===null||O.isXRRenderTarget===!0)&&(hi=M.toneMapping);const di=j.morphAttributes.position||j.morphAttributes.normal||j.morphAttributes.color,Yt=di!==void 0?di.length:0,st=E.get(Q),Wt=_.state.lights;if(Le===!0&&(Ct===!0||I!==U)){const Ui=I===U&&Q.id===W;Ge.setState(Q,I,Ui)}let zt=!1;Q.version===st.__version?(st.needsLights&&st.lightsStateVersion!==Wt.state.version||st.outputColorSpace!==Re||V.isBatchedMesh&&st.batching===!1||!V.isBatchedMesh&&st.batching===!0||V.isBatchedMesh&&st.batchingColor===!0&&V.colorTexture===null||V.isBatchedMesh&&st.batchingColor===!1&&V.colorTexture!==null||V.isInstancedMesh&&st.instancing===!1||!V.isInstancedMesh&&st.instancing===!0||V.isSkinnedMesh&&st.skinning===!1||!V.isSkinnedMesh&&st.skinning===!0||V.isInstancedMesh&&st.instancingColor===!0&&V.instanceColor===null||V.isInstancedMesh&&st.instancingColor===!1&&V.instanceColor!==null||V.isInstancedMesh&&st.instancingMorph===!0&&V.morphTexture===null||V.isInstancedMesh&&st.instancingMorph===!1&&V.morphTexture!==null||st.envMap!==ze||Q.fog===!0&&st.fog!==Ee||st.numClippingPlanes!==void 0&&(st.numClippingPlanes!==Ge.numPlanes||st.numIntersection!==Ge.numIntersection)||st.vertexAlphas!==$e||st.vertexTangents!==ct||st.morphTargets!==it||st.morphNormals!==Et||st.morphColors!==$t||st.toneMapping!==hi||st.morphTargetsCount!==Yt)&&(zt=!0):(zt=!0,st.__version=Q.version);let is=st.currentProgram;zt===!0&&(is=xr(Q,F,V));let da=!1,ss=!1,po=!1;const Kt=is.getUniforms(),$i=st.uniforms;if(ge.useProgram(is.program)&&(da=!0,ss=!0,po=!0),Q.id!==W&&(W=Q.id,ss=!0),da||U!==I){ge.buffers.depth.getReversed()&&I.reversedDepth!==!0&&(I._reversedDepth=!0,I.updateProjectionMatrix()),Kt.setValue(D,"projectionMatrix",I.projectionMatrix),Kt.setValue(D,"viewMatrix",I.matrixWorldInverse);const Xi=Kt.map.cameraPosition;Xi!==void 0&&Xi.setValue(D,ht.setFromMatrixPosition(I.matrixWorld)),et.logarithmicDepthBuffer&&Kt.setValue(D,"logDepthBufFC",2/(Math.log(I.far+1)/Math.LN2)),(Q.isMeshPhongMaterial||Q.isMeshToonMaterial||Q.isMeshLambertMaterial||Q.isMeshBasicMaterial||Q.isMeshStandardMaterial||Q.isShaderMaterial)&&Kt.setValue(D,"isOrthographic",I.isOrthographicCamera===!0),U!==I&&(U=I,ss=!0,po=!0)}if(st.needsLights&&(Wt.state.directionalShadowMap.length>0&&Kt.setValue(D,"directionalShadowMap",Wt.state.directionalShadowMap,N),Wt.state.spotShadowMap.length>0&&Kt.setValue(D,"spotShadowMap",Wt.state.spotShadowMap,N),Wt.state.pointShadowMap.length>0&&Kt.setValue(D,"pointShadowMap",Wt.state.pointShadowMap,N)),V.isSkinnedMesh){Kt.setOptional(D,V,"bindMatrix"),Kt.setOptional(D,V,"bindMatrixInverse");const Ui=V.skeleton;Ui&&(Ui.boneTexture===null&&Ui.computeBoneTexture(),Kt.setValue(D,"boneTexture",Ui.boneTexture,N))}V.isBatchedMesh&&(Kt.setOptional(D,V,"batchingTexture"),Kt.setValue(D,"batchingTexture",V._matricesTexture,N),Kt.setOptional(D,V,"batchingIdTexture"),Kt.setValue(D,"batchingIdTexture",V._indirectTexture,N),Kt.setOptional(D,V,"batchingColorTexture"),V._colorsTexture!==null&&Kt.setValue(D,"batchingColorTexture",V._colorsTexture,N));const ds=j.morphAttributes;if((ds.position!==void 0||ds.normal!==void 0||ds.color!==void 0)&&_t.update(V,j,is),(ss||st.receiveShadow!==V.receiveShadow)&&(st.receiveShadow=V.receiveShadow,Kt.setValue(D,"receiveShadow",V.receiveShadow)),Q.isMeshGouraudMaterial&&Q.envMap!==null&&($i.envMap.value=ze,$i.flipEnvMap.value=ze.isCubeTexture&&ze.isRenderTargetTexture===!1?-1:1),Q.isMeshStandardMaterial&&Q.envMap===null&&F.environment!==null&&($i.envMapIntensity.value=F.environmentIntensity),$i.dfgLUT!==void 0&&($i.dfgLUT.value=sM()),ss&&(Kt.setValue(D,"toneMappingExposure",M.toneMappingExposure),st.needsLights&&f0($i,po),Ee&&Q.fog===!0&&at.refreshFogUniforms($i,Ee),at.refreshMaterialUniforms($i,Q,je,tt,_.state.transmissionRenderTarget[I.id]),wl.upload(D,wu(st),$i,N)),Q.isShaderMaterial&&Q.uniformsNeedUpdate===!0&&(wl.upload(D,wu(st),$i,N),Q.uniformsNeedUpdate=!1),Q.isSpriteMaterial&&Kt.setValue(D,"center",V.center),Kt.setValue(D,"modelViewMatrix",V.modelViewMatrix),Kt.setValue(D,"normalMatrix",V.normalMatrix),Kt.setValue(D,"modelMatrix",V.matrixWorld),Q.isShaderMaterial||Q.isRawShaderMaterial){const Ui=Q.uniformsGroups;for(let Xi=0,ic=Ui.length;Xi<ic;Xi++){const zn=Ui[Xi];ue.update(zn,is),ue.bind(zn,is)}}return is}function f0(I,F){I.ambientLightColor.needsUpdate=F,I.lightProbe.needsUpdate=F,I.directionalLights.needsUpdate=F,I.directionalLightShadows.needsUpdate=F,I.pointLights.needsUpdate=F,I.pointLightShadows.needsUpdate=F,I.spotLights.needsUpdate=F,I.spotLightShadows.needsUpdate=F,I.rectAreaLights.needsUpdate=F,I.hemisphereLights.needsUpdate=F}function m0(I){return I.isMeshLambertMaterial||I.isMeshToonMaterial||I.isMeshPhongMaterial||I.isMeshStandardMaterial||I.isShadowMaterial||I.isShaderMaterial&&I.lights===!0}this.getActiveCubeFace=function(){return k},this.getActiveMipmapLevel=function(){return L},this.getRenderTarget=function(){return O},this.setRenderTargetTextures=function(I,F,j){const Q=E.get(I);Q.__autoAllocateDepthBuffer=I.resolveDepthBuffer===!1,Q.__autoAllocateDepthBuffer===!1&&(Q.__useRenderToTexture=!1),E.get(I.texture).__webglTexture=F,E.get(I.depthTexture).__webglTexture=Q.__autoAllocateDepthBuffer?void 0:j,Q.__hasExternalTextures=!0},this.setRenderTargetFramebuffer=function(I,F){const j=E.get(I);j.__webglFramebuffer=F,j.__useDefaultFramebuffer=F===void 0};const g0=D.createFramebuffer();this.setRenderTarget=function(I,F=0,j=0){O=I,k=F,L=j;let Q=null,V=!1,Ee=!1;if(I){const Re=E.get(I);if(Re.__useDefaultFramebuffer!==void 0){ge.bindFramebuffer(D.FRAMEBUFFER,Re.__webglFramebuffer),$.copy(I.viewport),G.copy(I.scissor),ee=I.scissorTest,ge.viewport($),ge.scissor(G),ge.setScissorTest(ee),W=-1;return}else if(Re.__webglFramebuffer===void 0)N.setupRenderTarget(I);else if(Re.__hasExternalTextures)N.rebindTextures(I,E.get(I.texture).__webglTexture,E.get(I.depthTexture).__webglTexture);else if(I.depthBuffer){const ct=I.depthTexture;if(Re.__boundDepthTexture!==ct){if(ct!==null&&E.has(ct)&&(I.width!==ct.image.width||I.height!==ct.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");N.setupDepthRenderbuffer(I)}}const ze=I.texture;(ze.isData3DTexture||ze.isDataArrayTexture||ze.isCompressedArrayTexture)&&(Ee=!0);const $e=E.get(I).__webglFramebuffer;I.isWebGLCubeRenderTarget?(Array.isArray($e[F])?Q=$e[F][j]:Q=$e[F],V=!0):I.samples>0&&N.useMultisampledRTT(I)===!1?Q=E.get(I).__webglMultisampledFramebuffer:Array.isArray($e)?Q=$e[j]:Q=$e,$.copy(I.viewport),G.copy(I.scissor),ee=I.scissorTest}else $.copy(Z).multiplyScalar(je).floor(),G.copy(se).multiplyScalar(je).floor(),ee=Pe;if(j!==0&&(Q=g0),ge.bindFramebuffer(D.FRAMEBUFFER,Q)&&ge.drawBuffers(I,Q),ge.viewport($),ge.scissor(G),ge.setScissorTest(ee),V){const Re=E.get(I.texture);D.framebufferTexture2D(D.FRAMEBUFFER,D.COLOR_ATTACHMENT0,D.TEXTURE_CUBE_MAP_POSITIVE_X+F,Re.__webglTexture,j)}else if(Ee){const Re=F;for(let ze=0;ze<I.textures.length;ze++){const $e=E.get(I.textures[ze]);D.framebufferTextureLayer(D.FRAMEBUFFER,D.COLOR_ATTACHMENT0+ze,$e.__webglTexture,j,Re)}}else if(I!==null&&j!==0){const Re=E.get(I.texture);D.framebufferTexture2D(D.FRAMEBUFFER,D.COLOR_ATTACHMENT0,D.TEXTURE_2D,Re.__webglTexture,j)}W=-1},this.readRenderTargetPixels=function(I,F,j,Q,V,Ee,Be,Re=0){if(!(I&&I.isWebGLRenderTarget)){rt("WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");return}let ze=E.get(I).__webglFramebuffer;if(I.isWebGLCubeRenderTarget&&Be!==void 0&&(ze=ze[Be]),ze){ge.bindFramebuffer(D.FRAMEBUFFER,ze);try{const $e=I.textures[Re],ct=$e.format,it=$e.type;if(!et.textureFormatReadable(ct)){rt("WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");return}if(!et.textureTypeReadable(it)){rt("WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");return}F>=0&&F<=I.width-Q&&j>=0&&j<=I.height-V&&(I.textures.length>1&&D.readBuffer(D.COLOR_ATTACHMENT0+Re),D.readPixels(F,j,Q,V,ye.convert(ct),ye.convert(it),Ee))}finally{const $e=O!==null?E.get(O).__webglFramebuffer:null;ge.bindFramebuffer(D.FRAMEBUFFER,$e)}}},this.readRenderTargetPixelsAsync=async function(I,F,j,Q,V,Ee,Be,Re=0){if(!(I&&I.isWebGLRenderTarget))throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let ze=E.get(I).__webglFramebuffer;if(I.isWebGLCubeRenderTarget&&Be!==void 0&&(ze=ze[Be]),ze)if(F>=0&&F<=I.width-Q&&j>=0&&j<=I.height-V){ge.bindFramebuffer(D.FRAMEBUFFER,ze);const $e=I.textures[Re],ct=$e.format,it=$e.type;if(!et.textureFormatReadable(ct))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!et.textureTypeReadable(it))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");const Et=D.createBuffer();D.bindBuffer(D.PIXEL_PACK_BUFFER,Et),D.bufferData(D.PIXEL_PACK_BUFFER,Ee.byteLength,D.STREAM_READ),I.textures.length>1&&D.readBuffer(D.COLOR_ATTACHMENT0+Re),D.readPixels(F,j,Q,V,ye.convert(ct),ye.convert(it),0);const $t=O!==null?E.get(O).__webglFramebuffer:null;ge.bindFramebuffer(D.FRAMEBUFFER,$t);const hi=D.fenceSync(D.SYNC_GPU_COMMANDS_COMPLETE,0);return D.flush(),await tg(D,hi,4),D.bindBuffer(D.PIXEL_PACK_BUFFER,Et),D.getBufferSubData(D.PIXEL_PACK_BUFFER,0,Ee),D.deleteBuffer(Et),D.deleteSync(hi),Ee}else throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")},this.copyFramebufferToTexture=function(I,F=null,j=0){const Q=Math.pow(2,-j),V=Math.floor(I.image.width*Q),Ee=Math.floor(I.image.height*Q),Be=F!==null?F.x:0,Re=F!==null?F.y:0;N.setTexture2D(I,0),D.copyTexSubImage2D(D.TEXTURE_2D,j,0,0,Be,Re,V,Ee),ge.unbindTexture()};const y0=D.createFramebuffer(),v0=D.createFramebuffer();this.copyTextureToTexture=function(I,F,j=null,Q=null,V=0,Ee=null){Ee===null&&(V!==0?(er("WebGLRenderer: copyTextureToTexture function signature has changed to support src and dst mipmap levels."),Ee=V,V=0):Ee=0);let Be,Re,ze,$e,ct,it,Et,$t,hi;const di=I.isCompressedTexture?I.mipmaps[Ee]:I.image;if(j!==null)Be=j.max.x-j.min.x,Re=j.max.y-j.min.y,ze=j.isBox3?j.max.z-j.min.z:1,$e=j.min.x,ct=j.min.y,it=j.isBox3?j.min.z:0;else{const ds=Math.pow(2,-V);Be=Math.floor(di.width*ds),Re=Math.floor(di.height*ds),I.isDataArrayTexture?ze=di.depth:I.isData3DTexture?ze=Math.floor(di.depth*ds):ze=1,$e=0,ct=0,it=0}Q!==null?(Et=Q.x,$t=Q.y,hi=Q.z):(Et=0,$t=0,hi=0);const Yt=ye.convert(F.format),st=ye.convert(F.type);let Wt;F.isData3DTexture?(N.setTexture3D(F,0),Wt=D.TEXTURE_3D):F.isDataArrayTexture||F.isCompressedArrayTexture?(N.setTexture2DArray(F,0),Wt=D.TEXTURE_2D_ARRAY):(N.setTexture2D(F,0),Wt=D.TEXTURE_2D),D.pixelStorei(D.UNPACK_FLIP_Y_WEBGL,F.flipY),D.pixelStorei(D.UNPACK_PREMULTIPLY_ALPHA_WEBGL,F.premultiplyAlpha),D.pixelStorei(D.UNPACK_ALIGNMENT,F.unpackAlignment);const zt=D.getParameter(D.UNPACK_ROW_LENGTH),is=D.getParameter(D.UNPACK_IMAGE_HEIGHT),da=D.getParameter(D.UNPACK_SKIP_PIXELS),ss=D.getParameter(D.UNPACK_SKIP_ROWS),po=D.getParameter(D.UNPACK_SKIP_IMAGES);D.pixelStorei(D.UNPACK_ROW_LENGTH,di.width),D.pixelStorei(D.UNPACK_IMAGE_HEIGHT,di.height),D.pixelStorei(D.UNPACK_SKIP_PIXELS,$e),D.pixelStorei(D.UNPACK_SKIP_ROWS,ct),D.pixelStorei(D.UNPACK_SKIP_IMAGES,it);const Kt=I.isDataArrayTexture||I.isData3DTexture,$i=F.isDataArrayTexture||F.isData3DTexture;if(I.isDepthTexture){const ds=E.get(I),Ui=E.get(F),Xi=E.get(ds.__renderTarget),ic=E.get(Ui.__renderTarget);ge.bindFramebuffer(D.READ_FRAMEBUFFER,Xi.__webglFramebuffer),ge.bindFramebuffer(D.DRAW_FRAMEBUFFER,ic.__webglFramebuffer);for(let zn=0;zn<ze;zn++)Kt&&(D.framebufferTextureLayer(D.READ_FRAMEBUFFER,D.COLOR_ATTACHMENT0,E.get(I).__webglTexture,V,it+zn),D.framebufferTextureLayer(D.DRAW_FRAMEBUFFER,D.COLOR_ATTACHMENT0,E.get(F).__webglTexture,Ee,hi+zn)),D.blitFramebuffer($e,ct,Be,Re,Et,$t,Be,Re,D.DEPTH_BUFFER_BIT,D.NEAREST);ge.bindFramebuffer(D.READ_FRAMEBUFFER,null),ge.bindFramebuffer(D.DRAW_FRAMEBUFFER,null)}else if(V!==0||I.isRenderTargetTexture||E.has(I)){const ds=E.get(I),Ui=E.get(F);ge.bindFramebuffer(D.READ_FRAMEBUFFER,y0),ge.bindFramebuffer(D.DRAW_FRAMEBUFFER,v0);for(let Xi=0;Xi<ze;Xi++)Kt?D.framebufferTextureLayer(D.READ_FRAMEBUFFER,D.COLOR_ATTACHMENT0,ds.__webglTexture,V,it+Xi):D.framebufferTexture2D(D.READ_FRAMEBUFFER,D.COLOR_ATTACHMENT0,D.TEXTURE_2D,ds.__webglTexture,V),$i?D.framebufferTextureLayer(D.DRAW_FRAMEBUFFER,D.COLOR_ATTACHMENT0,Ui.__webglTexture,Ee,hi+Xi):D.framebufferTexture2D(D.DRAW_FRAMEBUFFER,D.COLOR_ATTACHMENT0,D.TEXTURE_2D,Ui.__webglTexture,Ee),V!==0?D.blitFramebuffer($e,ct,Be,Re,Et,$t,Be,Re,D.COLOR_BUFFER_BIT,D.NEAREST):$i?D.copyTexSubImage3D(Wt,Ee,Et,$t,hi+Xi,$e,ct,Be,Re):D.copyTexSubImage2D(Wt,Ee,Et,$t,$e,ct,Be,Re);ge.bindFramebuffer(D.READ_FRAMEBUFFER,null),ge.bindFramebuffer(D.DRAW_FRAMEBUFFER,null)}else $i?I.isDataTexture||I.isData3DTexture?D.texSubImage3D(Wt,Ee,Et,$t,hi,Be,Re,ze,Yt,st,di.data):F.isCompressedArrayTexture?D.compressedTexSubImage3D(Wt,Ee,Et,$t,hi,Be,Re,ze,Yt,di.data):D.texSubImage3D(Wt,Ee,Et,$t,hi,Be,Re,ze,Yt,st,di):I.isDataTexture?D.texSubImage2D(D.TEXTURE_2D,Ee,Et,$t,Be,Re,Yt,st,di.data):I.isCompressedTexture?D.compressedTexSubImage2D(D.TEXTURE_2D,Ee,Et,$t,di.width,di.height,Yt,di.data):D.texSubImage2D(D.TEXTURE_2D,Ee,Et,$t,Be,Re,Yt,st,di);D.pixelStorei(D.UNPACK_ROW_LENGTH,zt),D.pixelStorei(D.UNPACK_IMAGE_HEIGHT,is),D.pixelStorei(D.UNPACK_SKIP_PIXELS,da),D.pixelStorei(D.UNPACK_SKIP_ROWS,ss),D.pixelStorei(D.UNPACK_SKIP_IMAGES,po),Ee===0&&F.generateMipmaps&&D.generateMipmap(Wt),ge.unbindTexture()},this.initRenderTarget=function(I){E.get(I).__webglFramebuffer===void 0&&N.setupRenderTarget(I)},this.initTexture=function(I){I.isCubeTexture?N.setTextureCube(I,0):I.isData3DTexture?N.setTexture3D(I,0):I.isDataArrayTexture||I.isCompressedArrayTexture?N.setTexture2DArray(I,0):N.setTexture2D(I,0),ge.unbindTexture()},this.resetState=function(){k=0,L=0,O=null,ge.reset(),Ne.reset()},typeof __THREE_DEVTOOLS__<"u"&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return Gs}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorSpace=Rt._getDrawingBufferColorSpace(e),t.unpackColorSpace=Rt._getUnpackColorSpace()}}const _l={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform float opacity;

		uniform sampler2D tDiffuse;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );
			gl_FragColor = opacity * texel;


		}`};class lo{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const aM=new ur(-1,1,1,-1,0,1);class oM extends mt{constructor(){super(),this.setAttribute("position",new Tt([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Tt([0,2,0,0,2,0],2))}}const rM=new oM;class au{constructor(e){this._mesh=new w(rM,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,aM)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class zm extends lo{constructor(e,t="tDiffuse"){super(),this.textureID=t,this.uniforms=null,this.material=null,e instanceof Ci?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=tr.clone(e.uniforms),this.material=new Ci({name:e.name!==void 0?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this._fsQuad=new au(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this._fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this._fsQuad.render(e))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}class Gp extends lo{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,i){const s=e.getContext(),n=e.state;n.buffers.color.setMask(!1),n.buffers.depth.setMask(!1),n.buffers.color.setLocked(!0),n.buffers.depth.setLocked(!0);let a,o;this.inverse?(a=0,o=1):(a=1,o=0),n.buffers.stencil.setTest(!0),n.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),n.buffers.stencil.setFunc(s.ALWAYS,a,4294967295),n.buffers.stencil.setClear(o),n.buffers.stencil.setLocked(!0),e.setRenderTarget(i),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),n.buffers.color.setLocked(!1),n.buffers.depth.setLocked(!1),n.buffers.color.setMask(!0),n.buffers.depth.setMask(!0),n.buffers.stencil.setLocked(!1),n.buffers.stencil.setFunc(s.EQUAL,1,4294967295),n.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP),n.buffers.stencil.setLocked(!0)}}class lM extends lo{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class cM{constructor(e,t){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),t===void 0){const i=e.getSize(new le);this._width=i.width,this._height=i.height,t=new ji(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:cs}),t.texture.name="EffectComposer.rt1"}else this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new zm(_l),this.copyPass.material.blending=qs,this.clock=new km}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let i=!1;for(let s=0,n=this.passes.length;s<n;s++){const a=this.passes[s];if(a.enabled!==!1){if(a.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(s),a.render(this.renderer,this.writeBuffer,this.readBuffer,e,i),a.needsSwap){if(i){const o=this.renderer.getContext(),r=this.renderer.state.buffers.stencil;r.setFunc(o.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),r.setFunc(o.EQUAL,1,4294967295)}this.swapBuffers()}Gp!==void 0&&(a instanceof Gp?i=!0:a instanceof lM&&(i=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new le);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const i=this._width*this._pixelRatio,s=this._height*this._pixelRatio;this.renderTarget1.setSize(i,s),this.renderTarget2.setSize(i,s);for(let n=0;n<this.passes.length;n++)this.passes[n].setSize(i,s)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class hM extends lo{constructor(e,t,i=null,s=null,n=null){super(),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=s,this.clearAlpha=n,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this.isRenderPass=!0,this._oldClearColor=new H}render(e,t,i){const s=e.autoClear;e.autoClear=!1;let n,a;this.overrideMaterial!==null&&(a=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor!==null&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor,e.getClearAlpha())),this.clearAlpha!==null&&(n=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),this.clearDepth==!0&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:i),this.clear===!0&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor!==null&&e.setClearColor(this._oldClearColor),this.clearAlpha!==null&&e.setClearAlpha(n),this.overrideMaterial!==null&&(this.scene.overrideMaterial=a),e.autoClear=s}}const dM={uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new H(0)},defaultOpacity:{value:0}},vertexShader:`

		varying vec2 vUv;

		void main() {

			vUv = uv;

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		uniform sampler2D tDiffuse;
		uniform vec3 defaultColor;
		uniform float defaultOpacity;
		uniform float luminosityThreshold;
		uniform float smoothWidth;

		varying vec2 vUv;

		void main() {

			vec4 texel = texture2D( tDiffuse, vUv );

			float v = luminance( texel.xyz );

			vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );

			float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );

			gl_FragColor = mix( outputColor, texel, alpha );

		}`};class eo extends lo{constructor(e,t=1,i,s){super(),this.strength=t,this.radius=i,this.threshold=s,this.resolution=e!==void 0?new le(e.x,e.y):new le(256,256),this.clearColor=new H(0,0,0),this.needsSwap=!1,this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let n=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);this.renderTargetBright=new ji(n,a,{type:cs}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let h=0;h<this.nMips;h++){const d=new ji(n,a,{type:cs});d.texture.name="UnrealBloomPass.h"+h,d.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(d);const u=new ji(n,a,{type:cs});u.texture.name="UnrealBloomPass.v"+h,u.texture.generateMipmaps=!1,this.renderTargetsVertical.push(u),n=Math.round(n/2),a=Math.round(a/2)}const o=dM;this.highPassUniforms=tr.clone(o.uniforms),this.highPassUniforms.luminosityThreshold.value=s,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new Ci({uniforms:this.highPassUniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader}),this.separableBlurMaterials=[];const r=[6,10,14,18,22];n=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);for(let h=0;h<this.nMips;h++)this.separableBlurMaterials.push(this._getSeparableBlurMaterial(r[h])),this.separableBlurMaterials[h].uniforms.invSize.value=new le(1/n,1/a),n=Math.round(n/2),a=Math.round(a/2);this.compositeMaterial=this._getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=t,this.compositeMaterial.uniforms.bloomRadius.value=.1;const c=[1,.8,.6,.4,.2];this.compositeMaterial.uniforms.bloomFactors.value=c,this.bloomTintColors=[new T(1,1,1),new T(1,1,1),new T(1,1,1),new T(1,1,1),new T(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,this.copyUniforms=tr.clone(_l.uniforms),this.blendMaterial=new Ci({uniforms:this.copyUniforms,vertexShader:_l.vertexShader,fragmentShader:_l.fragmentShader,premultipliedAlpha:!0,blending:ui,depthTest:!1,depthWrite:!1,transparent:!0}),this._oldClearColor=new H,this._oldClearAlpha=1,this._basic=new B,this._fsQuad=new au(null)}dispose(){for(let e=0;e<this.renderTargetsHorizontal.length;e++)this.renderTargetsHorizontal[e].dispose();for(let e=0;e<this.renderTargetsVertical.length;e++)this.renderTargetsVertical[e].dispose();this.renderTargetBright.dispose();for(let e=0;e<this.separableBlurMaterials.length;e++)this.separableBlurMaterials[e].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this._basic.dispose(),this._fsQuad.dispose()}setSize(e,t){let i=Math.round(e/2),s=Math.round(t/2);this.renderTargetBright.setSize(i,s);for(let n=0;n<this.nMips;n++)this.renderTargetsHorizontal[n].setSize(i,s),this.renderTargetsVertical[n].setSize(i,s),this.separableBlurMaterials[n].uniforms.invSize.value=new le(1/i,1/s),i=Math.round(i/2),s=Math.round(s/2)}render(e,t,i,s,n){e.getClearColor(this._oldClearColor),this._oldClearAlpha=e.getClearAlpha();const a=e.autoClear;e.autoClear=!1,e.setClearColor(this.clearColor,0),n&&e.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this._fsQuad.material=this._basic,this._basic.map=i.texture,e.setRenderTarget(null),e.clear(),this._fsQuad.render(e)),this.highPassUniforms.tDiffuse.value=i.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this._fsQuad.material=this.materialHighPassFilter,e.setRenderTarget(this.renderTargetBright),e.clear(),this._fsQuad.render(e);let o=this.renderTargetBright;for(let r=0;r<this.nMips;r++)this._fsQuad.material=this.separableBlurMaterials[r],this.separableBlurMaterials[r].uniforms.colorTexture.value=o.texture,this.separableBlurMaterials[r].uniforms.direction.value=eo.BlurDirectionX,e.setRenderTarget(this.renderTargetsHorizontal[r]),e.clear(),this._fsQuad.render(e),this.separableBlurMaterials[r].uniforms.colorTexture.value=this.renderTargetsHorizontal[r].texture,this.separableBlurMaterials[r].uniforms.direction.value=eo.BlurDirectionY,e.setRenderTarget(this.renderTargetsVertical[r]),e.clear(),this._fsQuad.render(e),o=this.renderTargetsVertical[r];this._fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,e.setRenderTarget(this.renderTargetsHorizontal[0]),e.clear(),this._fsQuad.render(e),this._fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,n&&e.state.buffers.stencil.setTest(!0),this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(i),this._fsQuad.render(e)),e.setClearColor(this._oldClearColor,this._oldClearAlpha),e.autoClear=a}_getSeparableBlurMaterial(e){const t=[],i=e/3;for(let s=0;s<e;s++)t.push(.39894*Math.exp(-.5*s*s/(i*i))/i);return new Ci({defines:{KERNEL_RADIUS:e},uniforms:{colorTexture:{value:null},invSize:{value:new le(.5,.5)},direction:{value:new le(.5,.5)},gaussianCoefficients:{value:t}},vertexShader:`

				varying vec2 vUv;

				void main() {

					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

				}`,fragmentShader:`

				#include <common>

				varying vec2 vUv;

				uniform sampler2D colorTexture;
				uniform vec2 invSize;
				uniform vec2 direction;
				uniform float gaussianCoefficients[KERNEL_RADIUS];

				void main() {

					float weightSum = gaussianCoefficients[0];
					vec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;

					for ( int i = 1; i < KERNEL_RADIUS; i ++ ) {

						float x = float( i );
						float w = gaussianCoefficients[i];
						vec2 uvOffset = direction * invSize * x;
						vec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;
						vec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;
						diffuseSum += ( sample1 + sample2 ) * w;

					}

					gl_FragColor = vec4( diffuseSum, 1.0 );

				}`})}_getCompositeMaterial(e){return new Ci({defines:{NUM_MIPS:e},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:`

				varying vec2 vUv;

				void main() {

					vUv = uv;
					gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

				}`,fragmentShader:`

				varying vec2 vUv;

				uniform sampler2D blurTexture1;
				uniform sampler2D blurTexture2;
				uniform sampler2D blurTexture3;
				uniform sampler2D blurTexture4;
				uniform sampler2D blurTexture5;
				uniform float bloomStrength;
				uniform float bloomRadius;
				uniform float bloomFactors[NUM_MIPS];
				uniform vec3 bloomTintColors[NUM_MIPS];

				float lerpBloomFactor( const in float factor ) {

					float mirrorFactor = 1.2 - factor;
					return mix( factor, mirrorFactor, bloomRadius );

				}

				void main() {

					// 3.0 for backwards compatibility with previous alpha-based intensity
					vec3 bloom = 3.0 * bloomStrength * (
						lerpBloomFactor( bloomFactors[ 0 ] ) * bloomTintColors[ 0 ] * texture2D( blurTexture1, vUv ).rgb +
						lerpBloomFactor( bloomFactors[ 1 ] ) * bloomTintColors[ 1 ] * texture2D( blurTexture2, vUv ).rgb +
						lerpBloomFactor( bloomFactors[ 2 ] ) * bloomTintColors[ 2 ] * texture2D( blurTexture3, vUv ).rgb +
						lerpBloomFactor( bloomFactors[ 3 ] ) * bloomTintColors[ 3 ] * texture2D( blurTexture4, vUv ).rgb +
						lerpBloomFactor( bloomFactors[ 4 ] ) * bloomTintColors[ 4 ] * texture2D( blurTexture5, vUv ).rgb
					);

					float bloomAlpha = max( bloom.r, max( bloom.g, bloom.b ) );
					gl_FragColor = vec4( bloom, bloomAlpha );

				}`})}}eo.BlurDirectionX=new le(1,0);eo.BlurDirectionY=new le(0,1);const Zr={name:"OutputShader",uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:`
		precision highp float;

		uniform mat4 modelViewMatrix;
		uniform mat4 projectionMatrix;

		attribute vec3 position;
		attribute vec2 uv;

		varying vec2 vUv;

		void main() {

			vUv = uv;
			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

		}`,fragmentShader:`

		precision highp float;

		uniform sampler2D tDiffuse;

		#include <tonemapping_pars_fragment>
		#include <colorspace_pars_fragment>

		varying vec2 vUv;

		void main() {

			gl_FragColor = texture2D( tDiffuse, vUv );

			// tone mapping

			#ifdef LINEAR_TONE_MAPPING

				gl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );

			#elif defined( REINHARD_TONE_MAPPING )

				gl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );

			#elif defined( CINEON_TONE_MAPPING )

				gl_FragColor.rgb = CineonToneMapping( gl_FragColor.rgb );

			#elif defined( ACES_FILMIC_TONE_MAPPING )

				gl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );

			#elif defined( AGX_TONE_MAPPING )

				gl_FragColor.rgb = AgXToneMapping( gl_FragColor.rgb );

			#elif defined( NEUTRAL_TONE_MAPPING )

				gl_FragColor.rgb = NeutralToneMapping( gl_FragColor.rgb );

			#elif defined( CUSTOM_TONE_MAPPING )

				gl_FragColor.rgb = CustomToneMapping( gl_FragColor.rgb );

			#endif

			// color space

			#ifdef SRGB_TRANSFER

				gl_FragColor = sRGBTransferOETF( gl_FragColor );

			#endif

		}`};class uM extends lo{constructor(){super(),this.isOutputPass=!0,this.uniforms=tr.clone(Zr.uniforms),this.material=new Em({name:Zr.name,uniforms:this.uniforms,vertexShader:Zr.vertexShader,fragmentShader:Zr.fragmentShader}),this._fsQuad=new au(this.material),this._outputColorSpace=null,this._toneMapping=null}render(e,t,i){this.uniforms.tDiffuse.value=i.texture,this.uniforms.toneMappingExposure.value=e.toneMappingExposure,(this._outputColorSpace!==e.outputColorSpace||this._toneMapping!==e.toneMapping)&&(this._outputColorSpace=e.outputColorSpace,this._toneMapping=e.toneMapping,this.material.defines={},Rt.getTransfer(this._outputColorSpace)===Gt&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===Hl?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===Ad?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===Rd?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===Id?this.material.defines.ACES_FILMIC_TONE_MAPPING="":this._toneMapping===Pd?this.material.defines.AGX_TONE_MAPPING="":this._toneMapping===Dd?this.material.defines.NEUTRAL_TONE_MAPPING="":this._toneMapping===kd&&(this.material.defines.CUSTOM_TONE_MAPPING=""),this.material.needsUpdate=!0),this.renderToScreen===!0?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this._fsQuad.render(e))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}function pM(l){if(l<=1)return 0;let e=0;for(let t=2;t<=l;t++)e+=Math.floor(75*Math.pow(1.5,t-2));return e}const Fm=[];for(let l=0;l<=20;l++)Fm[l]=pM(l);const fM={dash:{name:"Dash",description:"Quick dodge in any direction",unlockLevel:3,baseCooldown:3,hotkey:"R",staminaCost:15},heavyCharge:{name:"Heavy Charge",description:"Hold for a powerful charged strike",unlockLevel:5,baseCooldown:0,hotkey:"HOLD LMB",staminaCost:35},parry:{name:"Parry",description:"Perfect timed block for riposte",unlockLevel:8,baseCooldown:1.5,hotkey:"F",staminaCost:10},warCry:{name:"War Cry",description:"Damage buff, scares weak enemies",unlockLevel:12,baseCooldown:20,hotkey:"G",staminaCost:25}};class mM{constructor(){this.currentXP=0,this.currentLevel=1,this.maxLevel=20,this.xpThresholds=Fm,this.statPointsPerLevel=3,this.stats={vigor:0,endurance:0,strength:0,dexterity:0,mind:0,intelligence:0},this.spentStatPoints=0,this.manaManager=null,this.spellManager=null,this.abilities=fM,this.abilityCooldowns={dash:0,heavyCharge:0,parry:0,warCry:0},this.unlockedAbilities=new Set,this.warCryActive=!1,this.warCryDuration=8,this.warCryTimer=0,this.warCryDamageBonus=.5,this.mindStat=0,this.floatingTexts=[],this.remnant=0,this.heldRemnant=0,this.deathCount=0,this.deathLessons={},this.infusions={strength:0,vitality:0,stamina:0,spirit:0},this.MAX_TOTAL_DEPTH=20,this.MAX_TRACK_DEPTH=5,this.bonfirePosition=new T(0,0,5),this.maxHealth=100,this.maxStamina=100,this.maxPosture=100,this.health=this.maxHealth,this.stamina=this.maxStamina,this.posture=0,this.isDead=!1,this.checkpoint=new T(0,0,5),this.deathScreenEl=document.getElementById("death-screen"),this.player=null,this.enemyManager=null,this.bloodstain=null,this.bloodstainMesh=null,this.staminaRegenDelay=.5,this.staminaRegenRate=25,this.staminaRegenTimer=0,this.postureRegenDelay=1,this.postureRegenRate=15,this.postureRegenTimer=0,this.audioManager=null,this.hitstopActive=!1,this.hitstopDuration=0,this.hitstopTimer=0,this.hud=null,this.cameraController=null,this._loadProgression()}_loadProgression(){try{const e=localStorage.getItem("ashen_progression");if(e){const t=JSON.parse(e);this.currentXP=t.currentXP||0,this.currentLevel=t.currentLevel||1,t.stats&&(this.stats={vigor:t.stats.vigor||0,endurance:t.stats.endurance||0,strength:t.stats.strength||0,dexterity:t.stats.dexterity||0,mind:t.stats.mind||0,intelligence:t.stats.intelligence||0}),this.spentStatPoints=t.spentStatPoints||0,this._applyStatBonuses(),console.log(`[GameManager] Loaded progression: Level ${this.currentLevel}, XP ${this.currentXP}, Stats: ${JSON.stringify(this.stats)}`)}}catch(e){console.warn("[GameManager] Failed to load progression:",e)}}_saveProgression(){try{const e={currentXP:this.currentXP,currentLevel:this.currentLevel,stats:this.stats,spentStatPoints:this.spentStatPoints};localStorage.setItem("ashen_progression",JSON.stringify(e))}catch(e){console.warn("[GameManager] Failed to save progression:",e)}}getTotalStatPoints(){return Math.max(0,(this.currentLevel-1)*this.statPointsPerLevel)}getAvailableStatPoints(){return this.getTotalStatPoints()-this.spentStatPoints}spendStatPoint(e){return this.getAvailableStatPoints()<=0?(console.warn("[GameManager] No stat points available"),!1):this.stats.hasOwnProperty(e)?(this.stats[e]++,this.spentStatPoints++,this._applyStatBonuses(),this._saveProgression(),console.log(`[GameManager] Spent point on ${e}: now ${this.stats[e]}`),!0):(console.warn(`[GameManager] Invalid stat: ${e}`),!1)}getStatBonuses(){return{bonusHealth:this.stats.vigor*5,bonusStamina:this.stats.endurance*5,staminaRegenMult:1+this.stats.endurance*.05,damageMult:1+this.stats.strength*.05,attackSpeedMult:1+this.stats.dexterity*.03,cooldownMult:Math.max(.5,1-this.stats.mind*.05),bonusMana:this.stats.intelligence*10,manaRegenMult:1+this.stats.intelligence*.05}}_applyStatBonuses(){const e=this.getStatBonuses(),t=this.getInfusionBonuses(),i=this.equipmentBonuses||{health:0,stamina:0};this.maxHealth=100+e.bonusHealth+t.bonusHealth+(i.health||0),this.maxStamina=100+e.bonusStamina+t.bonusStamina+(i.stamina||0),this.mindStat=this.stats.mind,this.isDead||(this.health=Math.min(this.health,this.maxHealth),this.stamina=Math.min(this.stamina,this.maxStamina)),this.manaManager&&this.manaManager.recalculateMaxMana()}applyStatBonuses(){this._applyStatBonuses()}gainXP(e,t=null){if(!(this.currentLevel>=this.maxLevel)){for(this.currentLevel,this.currentXP+=e,t&&this.player&&this._spawnFloatingText(`+${e} XP`,t.clone(),65416);this.currentLevel<this.maxLevel&&this.currentXP>=this.xpThresholds[this.currentLevel+1];)this._levelUp();this._saveProgression()}}_levelUp(){this.currentLevel++,console.log(`[GameManager] LEVEL UP! Now level ${this.currentLevel}`),this.health=this.maxHealth,this.stamina=this.maxStamina,this.posture=0,this.manaManager&&this.manaManager.fullRestore(),this.audioManager&&this.audioManager.play("levelUp",{volume:.8}),this.particleManager&&this.player&&this.particleManager.spawnLevelUpEffect(this.player.mesh.position.clone()),this.player&&(this._spawnFloatingText(`LEVEL ${this.currentLevel}!`,this.player.mesh.position.clone().add(new T(0,2.5,0)),16768256,!0),setTimeout(()=>{this._spawnFloatingText(`+${this.statPointsPerLevel} Stat Points!`,this.player.mesh.position.clone().add(new T(0,2.2,0)),8965375,!1)},600)),this.itemManager&&this.itemManager.showNotification&&setTimeout(()=>{this.itemManager.showNotification(`+${this.statPointsPerLevel} Stat Points! Press TAB to allocate`,"levelup")},800),this.hud&&this.hud.flashLevelUp&&this.hud.flashLevelUp(),this._checkAbilityUnlocks(this.currentLevel)}_spawnFloatingText(e,t,i=16777215,s=!1){if(this.floatingText){const n=typeof i=="number"?"#"+i.toString(16).padStart(6,"0"):i;this.floatingText.spawn(e,t,{color:n,isLevelUp:s,duration:s?2.5:1.5})}}getXPProgress(){if(this.currentLevel>=this.maxLevel)return 1;const e=this.xpThresholds[this.currentLevel],t=this.xpThresholds[this.currentLevel+1],i=this.currentXP-e,s=t-e;return i/s}getXPToNextLevel(){return this.currentLevel>=this.maxLevel?0:this.xpThresholds[this.currentLevel+1]-this.currentXP}isAbilityUnlocked(e){const t=this.abilities[e];return t?this.currentLevel>=t.unlockLevel:!1}getUnlockedAbilities(){const e=[];for(const[t,i]of Object.entries(this.abilities))this.currentLevel>=i.unlockLevel&&e.push({id:t,...i});return e}getCooldownModifier(){return this.getStatBonuses().cooldownMult}isAbilityReady(e){return this.isAbilityUnlocked(e)?this.abilityCooldowns[e]<=0:!1}useAbility(e){const t=this.abilities[e];if(!t)return!1;const i=t.baseCooldown*this.getCooldownModifier();return this.abilityCooldowns[e]=i,this.unlockedAbilities.has(e)||this.unlockedAbilities.add(e),!0}getAbilityCooldown(e){return Math.max(0,this.abilityCooldowns[e]||0)}getAbilityCooldownProgress(e){const t=this.abilities[e];if(!t||t.baseCooldown===0)return 1;const i=this.abilityCooldowns[e]||0,s=t.baseCooldown*this.getCooldownModifier();return 1-i/s}activateWarCry(){this.warCryActive=!0,this.warCryTimer=this.warCryDuration,this.audioManager&&this.audioManager.play("warCry",{volume:.8}),this.particleManager&&this.player&&this.particleManager.spawnWarCryEffect(this.player.mesh.position.clone()),this.player&&this._spawnFloatingText("WAR CRY!",this.player.mesh.position.clone().add(new T(0,2.5,0)),16737792,!0)}getDamageMultiplier(){let e=this.getInfusionBonuses().damageMult;const t=this.getStatBonuses();return e+=t.damageMult-1,this.warCryActive&&(e+=this.warCryDamageBonus),e}getEquipmentDamageBonus(){return this.equipmentBonuses&&this.equipmentBonuses.damage||0}getEquipmentDefense(){return this.equipmentBonuses&&this.equipmentBonuses.defense||0}getEquipmentCritChance(){return this.equipmentBonuses&&this.equipmentBonuses.critChance||0}getEquipmentCritDamage(){return this.equipmentBonuses&&this.equipmentBonuses.critDamage||0}getAttackSpeedMultiplier(){return this.getStatBonuses().attackSpeedMult}_checkAbilityUnlocks(e){for(const[t,i]of Object.entries(this.abilities))i.unlockLevel===e&&this._showAbilityUnlockNotification(t,i)}_showAbilityUnlockNotification(e,t){this.itemManager&&this.itemManager.showNotification&&this.itemManager.showNotification(`NEW ABILITY: ${t.name}`,"ability"),this.player&&(setTimeout(()=>{this._spawnFloatingText(`${t.name} Unlocked!`,this.player.mesh.position.clone().add(new T(0,3,0)),4500223,!0)},500),setTimeout(()=>{this._spawnFloatingText(`[${t.hotkey}] ${t.description}`,this.player.mesh.position.clone().add(new T(0,2.5,0)),8965375,!1)},1200)),this.audioManager&&this.audioManager.play("abilityUnlock",{volume:.7})}calculateEnemyXP(e){let t=Math.floor((e.config?.remnantDrop||25)*.5);return e.config?.isElite&&(t=Math.floor(t*1.5)),e.isBoss&&(t=200),t}triggerHitstop(e=.04){this.hitstopActive=!0,this.hitstopDuration=e,this.hitstopTimer=0}hitstopLight(){this.triggerHitstop(.035)}hitstopHeavy(){this.triggerHitstop(.06)}isInHitstop(){return this.hitstopActive}updateHitstop(e){return this.hitstopActive?(this.hitstopTimer+=e,this.hitstopTimer>=this.hitstopDuration&&(this.hitstopActive=!1,this.hitstopTimer=0),!0):!1}update(e){if(!this.isDead){if(this.staminaRegenTimer+=e,this.staminaRegenTimer>=this.staminaRegenDelay&&this.stamina<this.maxStamina){const t=this.getStatBonuses(),i=this.getInfusionBonuses(),s=t.staminaRegenMult*i.staminaRegenMult;this.stamina=Math.min(this.maxStamina,this.stamina+this.staminaRegenRate*s*e)}this.postureRegenTimer+=e,this.postureRegenTimer>=this.postureRegenDelay&&this.posture>0&&(this.posture=Math.max(0,this.posture-this.postureRegenRate*e));for(const t in this.abilityCooldowns)this.abilityCooldowns[t]>0&&(this.abilityCooldowns[t]-=e);this.warCryActive&&(this.warCryTimer-=e,this.warCryTimer<=0&&(this.warCryActive=!1,this.warCryTimer=0,this.player&&this._spawnFloatingText("War Cry ended",this.player.mesh.position.clone().add(new T(0,2,0)),8947848,!1)))}}canUseStamina(e){const t=this.stamina>=e;return!t&&this.hud&&(this.hud.flashStaminaDepleted(),this.audioManager&&this.player&&this.audioManager.play("staminaDepleted",{position:this.player.mesh.position,volume:.4})),t}useStamina(e){this.stamina=Math.max(0,this.stamina-e),this.staminaRegenTimer=0,this.stamina<15&&this.hud&&this.hud.flashStaminaDepleted()}takeDamage(e,t="physical",i=0,s=!1){if(this.isDead)return;const n=this.deathLessons[t]||0;let a=Math.floor(e*(1-n));const o=this.getEquipmentDefense();if(o>0&&(a=Math.max(1,a-o)),s){const r=a*.5;if(this.canUseStamina(r))this.useStamina(r),a=Math.floor(a*.2),i*=.5;else return this.stamina=0,this.posture=this.maxPosture,"guard_broken"}return this.health-=a,this.posture=Math.min(this.maxPosture,this.posture+i),this.postureRegenTimer=0,this.spellCaster&&this.spellCaster.isCasting&&this.spellCaster.interruptCast(),this.audioManager&&this.player&&this.audioManager.play("playerDamage",{position:this.player.mesh.position,volume:.7}),this.health<=0?(this.die(t),"died"):this.posture>=this.maxPosture?(this.audioManager&&this.player&&this.audioManager.play("postureBreak",{position:this.player.mesh.position,volume:.8}),"posture_broken"):"hit"}die(e="unknown"){this.isDead=!0,this.deathCount++,this.health=0,this.audioManager&&this.audioManager.play("death",{volume:.8});const t=this.player?this.player.mesh.position.clone():this.checkpoint.clone();if(this.particleManager&&this.player&&this.particleManager.spawnPlayerDeathEffect(t,this.camera),this.bloodstainMesh&&this.scene&&(this.scene.remove(this.bloodstainMesh),this.bloodstainMesh=null),this.remnant>0&&this.scene){this.heldRemnant=this.remnant,this.remnant=0,this.bloodstain=t.clone(),this.bloodstain.y=.05;const i=new Zi(.5,16),s=new B({color:11154227,transparent:!0,opacity:.8,side:lt});this.bloodstainMesh=new w(i,s),this.bloodstainMesh.rotation.x=-Math.PI/2,this.bloodstainMesh.position.copy(this.bloodstain),this.scene.add(this.bloodstainMesh)}else this.heldRemnant=0,this.bloodstain=null;this.deathLessons[e]||(this.deathLessons[e]=0),this.deathLessons[e]=Math.min(.25,this.deathLessons[e]+.005),this.deathScreenEl&&this.deathScreenEl.classList.add("visible"),setTimeout(()=>this.respawn(),3e3)}respawn(){this.isDead=!1,this.health=this.maxHealth,this.stamina=this.maxStamina,this.posture=0,this.manaManager&&this.manaManager.onRespawn(),this.player&&this.player.resetPosition(),this.enemyManager&&this.enemyManager.resetAll(),this.deathScreenEl&&this.deathScreenEl.classList.remove("visible")}setCheckpoint(e){this.checkpoint.copy(e)}setEntities(e,t,i,s=null){this.player=e,this.enemyManager=t,this.scene=i,this.camera=s}addRemnant(e){this.remnant+=e}collectBloodstain(){return!this.bloodstain||!this.player?!1:this.player.mesh.position.distanceTo(this.bloodstain)<2?(this.remnant+=this.heldRemnant,this.audioManager&&this.audioManager.play("itemPickup",{volume:.6}),this.heldRemnant=0,this.bloodstainMesh&&this.scene&&this.scene.remove(this.bloodstainMesh),this.bloodstain=null,this.bloodstainMesh=null,!0):!1}getTotalDepth(){return this.infusions.strength+this.infusions.vitality+this.infusions.stamina+this.infusions.spirit}canInfuse(e){return!(!this.infusions.hasOwnProperty(e)||this.infusions[e]>=this.MAX_TRACK_DEPTH||this.getTotalDepth()>=this.MAX_TOTAL_DEPTH)}getInfusionCost(e,t){return 100*t*t}infuse(e){if(!this.canInfuse(e))return!1;const t=this.infusions[e]+1,i=this.getInfusionCost(e,t);return this.remnant<i?!1:(this.remnant-=i,this.infusions[e]=t,this.audioManager&&this.audioManager.play("menuConfirm",{volume:.5}),!0)}getInfusionBonuses(){return{damageMult:1+this.infusions.strength*.1,bonusHealth:this.infusions.vitality*20,bonusStamina:this.infusions.stamina*15,staminaRegenMult:1+this.infusions.stamina*.1,postureResist:this.infusions.spirit*.05,postureRegenMult:1+this.infusions.spirit*.15}}applyInfusionBonuses(){const e=this.getInfusionBonuses();this.maxHealth=100+e.bonusHealth,this.maxStamina=100+e.bonusStamina,this.isDead||(this.health=Math.min(this.health,this.maxHealth),this.stamina=Math.min(this.stamina,this.maxStamina))}isNearBonfire(){return this.player?this.player.mesh.position.distanceTo(this.bonfirePosition)<3:!1}getDiscoveredBonfires(){return[{x:this.bonfirePosition.x,z:this.bonfirePosition.z,name:"Starting Bonfire",discovered:!0}]}getTrackInfo(e){const t=this.infusions[e]||0,i=t+1,s=i<=this.MAX_TRACK_DEPTH?this.getInfusionCost(e,i):null,n=s!==null&&this.remnant>=s,a=t>=this.MAX_TRACK_DEPTH,o={strength:{name:"Strength",desc:"+10% damage per level",bonus:`+${t*10}% damage`},vitality:{name:"Vitality",desc:"+20 max HP per level",bonus:`+${t*20} HP`},stamina:{name:"Stamina",desc:"+15 max stamina, +10% regen per level",bonus:`+${t*15} stamina`},spirit:{name:"Spirit",desc:"+5% posture resist, +15% posture regen per level",bonus:`+${t*5}% resist`}};return{level:t,nextLevel:i,cost:s,canAfford:n,maxed:a,...o[e]}}}function Hp(l,e){if(e===W0)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),l;if(e===ld||e===im){let t=l.getIndex();if(t===null){const a=[],o=l.getAttribute("position");if(o!==void 0){for(let r=0;r<o.count;r++)a.push(r);l.setIndex(a),t=l.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),l}const i=t.count-2,s=[];if(e===ld)for(let a=1;a<=i;a++)s.push(t.getX(0)),s.push(t.getX(a)),s.push(t.getX(a+1));else for(let a=0;a<i;a++)a%2===0?(s.push(t.getX(a)),s.push(t.getX(a+1)),s.push(t.getX(a+2))):(s.push(t.getX(a+2)),s.push(t.getX(a+1)),s.push(t.getX(a)));s.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const n=l.clone();return n.setIndex(s),n.clearGroups(),n}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),l}class gM extends ca{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new wM(t)}),this.register(function(t){return new _M(t)}),this.register(function(t){return new kM(t)}),this.register(function(t){return new PM(t)}),this.register(function(t){return new DM(t)}),this.register(function(t){return new SM(t)}),this.register(function(t){return new TM(t)}),this.register(function(t){return new EM(t)}),this.register(function(t){return new CM(t)}),this.register(function(t){return new bM(t)}),this.register(function(t){return new AM(t)}),this.register(function(t){return new MM(t)}),this.register(function(t){return new IM(t)}),this.register(function(t){return new RM(t)}),this.register(function(t){return new vM(t)}),this.register(function(t){return new LM(t)}),this.register(function(t){return new OM(t)})}load(e,t,i,s){const n=this;let a;if(this.resourcePath!=="")a=this.resourcePath;else if(this.path!==""){const c=$o.extractUrlBase(e);a=$o.resolveURL(c,this.path)}else a=$o.extractUrlBase(e);this.manager.itemStart(e);const o=function(c){s?s(c):console.error(c),n.manager.itemError(e),n.manager.itemEnd(e)},r=new Nl(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,function(c){try{n.parse(c,a,function(h){t(h),n.manager.itemEnd(e)},o)}catch(h){o(h)}},i,o)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,s){let n;const a={},o={},r=new TextDecoder;if(typeof e=="string")n=JSON.parse(e);else if(e instanceof ArrayBuffer)if(r.decode(new Uint8Array(e,0,4))===Um){try{a[It.KHR_BINARY_GLTF]=new NM(e)}catch(d){s&&s(d);return}n=JSON.parse(a[It.KHR_BINARY_GLTF].content)}else n=JSON.parse(r.decode(e));else n=e;if(n.asset===void 0||n.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new QM(n,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const d=this.pluginCallbacks[h](c);d.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[d.name]=d,a[d.name]=!0}if(n.extensionsUsed)for(let h=0;h<n.extensionsUsed.length;++h){const d=n.extensionsUsed[h],u=n.extensionsRequired||[];switch(d){case It.KHR_MATERIALS_UNLIT:a[d]=new xM;break;case It.KHR_DRACO_MESH_COMPRESSION:a[d]=new BM(n,this.dracoLoader);break;case It.KHR_TEXTURE_TRANSFORM:a[d]=new zM;break;case It.KHR_MESH_QUANTIZATION:a[d]=new FM;break;default:u.indexOf(d)>=0&&o[d]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+d+'".')}}c.setExtensions(a),c.setPlugins(o),c.parse(i,s)}parseAsync(e,t){const i=this;return new Promise(function(s,n){i.parse(e,t,s,n)})}}function yM(){let l={};return{get:function(e){return l[e]},add:function(e,t){l[e]=t},remove:function(e){delete l[e]},removeAll:function(){l={}}}}const It={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class vM{constructor(e){this.parser=e,this.name=It.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,s=t.length;i<s;i++){const n=t[i];n.extensions&&n.extensions[this.name]&&n.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let s=t.cache.get(i);if(s)return s;const n=t.json,r=((n.extensions&&n.extensions[this.name]||{}).lights||[])[e];let c;const h=new H(16777215);r.color!==void 0&&h.setRGB(r.color[0],r.color[1],r.color[2],zi);const d=r.range!==void 0?r.range:0;switch(r.type){case"directional":c=new gd(h),c.target.position.set(0,0,-1),c.add(c.target);break;case"point":c=new We(h),c.distance=d;break;case"spot":c=new Vy(h),c.distance=d,r.spot=r.spot||{},r.spot.innerConeAngle=r.spot.innerConeAngle!==void 0?r.spot.innerConeAngle:0,r.spot.outerConeAngle=r.spot.outerConeAngle!==void 0?r.spot.outerConeAngle:Math.PI/4,c.angle=r.spot.outerConeAngle,c.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,c.target.position.set(0,0,-1),c.add(c.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+r.type)}return c.position.set(0,0,0),Os(c,r),r.intensity!==void 0&&(c.intensity=r.intensity),c.name=t.createUniqueName(r.name||"light_"+e),s=Promise.resolve(c),t.cache.add(i,s),s}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,n=i.json.nodes[e],o=(n.extensions&&n.extensions[this.name]||{}).light;return o===void 0?null:this._loadLight(o).then(function(r){return i._getNodeRef(t.cache,o,r)})}}class xM{constructor(){this.name=It.KHR_MATERIALS_UNLIT}getMaterialType(){return B}extendParams(e,t,i){const s=[];e.color=new H(1,1,1),e.opacity=1;const n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){const a=n.baseColorFactor;e.color.setRGB(a[0],a[1],a[2],zi),e.opacity=a[3]}n.baseColorTexture!==void 0&&s.push(i.assignTexture(e,"map",n.baseColorTexture,pi))}return Promise.all(s)}}class bM{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name].emissiveStrength;return n!==void 0&&(t.emissiveIntensity=n),Promise.resolve()}}class wM{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],a=s.extensions[this.name];if(a.clearcoatFactor!==void 0&&(t.clearcoat=a.clearcoatFactor),a.clearcoatTexture!==void 0&&n.push(i.assignTexture(t,"clearcoatMap",a.clearcoatTexture)),a.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=a.clearcoatRoughnessFactor),a.clearcoatRoughnessTexture!==void 0&&n.push(i.assignTexture(t,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),a.clearcoatNormalTexture!==void 0&&(n.push(i.assignTexture(t,"clearcoatNormalMap",a.clearcoatNormalTexture)),a.clearcoatNormalTexture.scale!==void 0)){const o=a.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new le(o,o)}return Promise.all(n)}}class _M{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_DISPERSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.dispersion=n.dispersion!==void 0?n.dispersion:0,Promise.resolve()}}class MM{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],a=s.extensions[this.name];return a.iridescenceFactor!==void 0&&(t.iridescence=a.iridescenceFactor),a.iridescenceTexture!==void 0&&n.push(i.assignTexture(t,"iridescenceMap",a.iridescenceTexture)),a.iridescenceIor!==void 0&&(t.iridescenceIOR=a.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),a.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=a.iridescenceThicknessMinimum),a.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=a.iridescenceThicknessMaximum),a.iridescenceThicknessTexture!==void 0&&n.push(i.assignTexture(t,"iridescenceThicknessMap",a.iridescenceThicknessTexture)),Promise.all(n)}}class SM{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_SHEEN}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[];t.sheenColor=new H(0,0,0),t.sheenRoughness=0,t.sheen=1;const a=s.extensions[this.name];if(a.sheenColorFactor!==void 0){const o=a.sheenColorFactor;t.sheenColor.setRGB(o[0],o[1],o[2],zi)}return a.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=a.sheenRoughnessFactor),a.sheenColorTexture!==void 0&&n.push(i.assignTexture(t,"sheenColorMap",a.sheenColorTexture,pi)),a.sheenRoughnessTexture!==void 0&&n.push(i.assignTexture(t,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(n)}}class TM{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],a=s.extensions[this.name];return a.transmissionFactor!==void 0&&(t.transmission=a.transmissionFactor),a.transmissionTexture!==void 0&&n.push(i.assignTexture(t,"transmissionMap",a.transmissionTexture)),Promise.all(n)}}class EM{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_VOLUME}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],a=s.extensions[this.name];t.thickness=a.thicknessFactor!==void 0?a.thicknessFactor:0,a.thicknessTexture!==void 0&&n.push(i.assignTexture(t,"thicknessMap",a.thicknessTexture)),t.attenuationDistance=a.attenuationDistance||1/0;const o=a.attenuationColor||[1,1,1];return t.attenuationColor=new H().setRGB(o[0],o[1],o[2],zi),Promise.all(n)}}class CM{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_IOR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=s.extensions[this.name];return t.ior=n.ior!==void 0?n.ior:1.5,Promise.resolve()}}class AM{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_SPECULAR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],a=s.extensions[this.name];t.specularIntensity=a.specularFactor!==void 0?a.specularFactor:1,a.specularTexture!==void 0&&n.push(i.assignTexture(t,"specularIntensityMap",a.specularTexture));const o=a.specularColorFactor||[1,1,1];return t.specularColor=new H().setRGB(o[0],o[1],o[2],zi),a.specularColorTexture!==void 0&&n.push(i.assignTexture(t,"specularColorMap",a.specularColorTexture,pi)),Promise.all(n)}}class RM{constructor(e){this.parser=e,this.name=It.EXT_MATERIALS_BUMP}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],a=s.extensions[this.name];return t.bumpScale=a.bumpFactor!==void 0?a.bumpFactor:1,a.bumpTexture!==void 0&&n.push(i.assignTexture(t,"bumpMap",a.bumpTexture)),Promise.all(n)}}class IM{constructor(e){this.parser=e,this.name=It.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:en}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const n=[],a=s.extensions[this.name];return a.anisotropyStrength!==void 0&&(t.anisotropy=a.anisotropyStrength),a.anisotropyRotation!==void 0&&(t.anisotropyRotation=a.anisotropyRotation),a.anisotropyTexture!==void 0&&n.push(i.assignTexture(t,"anisotropyMap",a.anisotropyTexture)),Promise.all(n)}}class kM{constructor(e){this.parser=e,this.name=It.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,s=i.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const n=s.extensions[this.name],a=t.options.ktx2Loader;if(!a){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,n.source,a)}}class PM{constructor(e){this.parser=e,this.name=It.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,i=this.parser,s=i.json,n=s.textures[e];if(!n.extensions||!n.extensions[t])return null;const a=n.extensions[t],o=s.images[a.source];let r=i.textureLoader;if(o.uri){const c=i.options.manager.getHandler(o.uri);c!==null&&(r=c)}return i.loadTextureImage(e,a.source,r)}}class DM{constructor(e){this.parser=e,this.name=It.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,i=this.parser,s=i.json,n=s.textures[e];if(!n.extensions||!n.extensions[t])return null;const a=n.extensions[t],o=s.images[a.source];let r=i.textureLoader;if(o.uri){const c=i.options.manager.getHandler(o.uri);c!==null&&(r=c)}return i.loadTextureImage(e,a.source,r)}}class LM{constructor(e){this.name=It.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const s=i.extensions[this.name],n=this.parser.getDependency("buffer",s.buffer),a=this.parser.options.meshoptDecoder;if(!a||!a.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return n.then(function(o){const r=s.byteOffset||0,c=s.byteLength||0,h=s.count,d=s.byteStride,u=new Uint8Array(o,r,c);return a.decodeGltfBufferAsync?a.decodeGltfBufferAsync(h,d,u,s.mode,s.filter).then(function(p){return p.buffer}):a.ready.then(function(){const p=new ArrayBuffer(h*d);return a.decodeGltfBuffer(new Uint8Array(p),h,d,u,s.mode,s.filter),p})})}else return null}}class OM{constructor(e){this.name=It.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||i.mesh===void 0)return null;const s=t.meshes[i.mesh];for(const c of s.primitives)if(c.mode!==fs.TRIANGLES&&c.mode!==fs.TRIANGLE_STRIP&&c.mode!==fs.TRIANGLE_FAN&&c.mode!==void 0)return null;const a=i.extensions[this.name].attributes,o=[],r={};for(const c in a)o.push(this.parser.getDependency("accessor",a[c]).then(h=>(r[c]=h,r[c])));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then(c=>{const h=c.pop(),d=h.isGroup?h.children:[h],u=c[0].count,p=[];for(const f of d){const y=new ut,m=new T,g=new Cs,x=new T(1,1,1),v=new Qn(f.geometry,f.material,u);for(let b=0;b<u;b++)r.TRANSLATION&&m.fromBufferAttribute(r.TRANSLATION,b),r.ROTATION&&g.fromBufferAttribute(r.ROTATION,b),r.SCALE&&x.fromBufferAttribute(r.SCALE,b),v.setMatrixAt(b,y.compose(m,g,x));for(const b in r)if(b==="_COLOR_0"){const _=r[b];v.instanceColor=new hd(_.array,_.itemSize,_.normalized)}else b!=="TRANSLATION"&&b!=="ROTATION"&&b!=="SCALE"&&f.geometry.setAttribute(b,r[b]);ai.prototype.copy.call(v,f),this.parser.assignFinalMaterial(v),p.push(v)}return h.isGroup?(h.clear(),h.add(...p),h):p[0]}))}}const Um="glTF",Eo=12,qp={JSON:1313821514,BIN:5130562};class NM{constructor(e){this.name=It.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Eo),i=new TextDecoder;if(this.header={magic:i.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Um)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-Eo,n=new DataView(e,Eo);let a=0;for(;a<s;){const o=n.getUint32(a,!0);a+=4;const r=n.getUint32(a,!0);if(a+=4,r===qp.JSON){const c=new Uint8Array(e,Eo+a,o);this.content=i.decode(c)}else if(r===qp.BIN){const c=Eo+a;this.body=e.slice(c,c+o)}a+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class BM{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=It.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,s=this.dracoLoader,n=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,o={},r={},c={};for(const h in a){const d=xd[h]||h.toLowerCase();o[d]=a[h]}for(const h in e.attributes){const d=xd[h]||h.toLowerCase();if(a[h]!==void 0){const u=i.accessors[e.attributes[h]],p=qa[u.componentType];c[d]=p.name,r[d]=u.normalized===!0}}return t.getDependency("bufferView",n).then(function(h){return new Promise(function(d,u){s.decodeDracoFile(h,function(p){for(const f in p.attributes){const y=p.attributes[f],m=r[f];m!==void 0&&(y.normalized=m)}d(p)},o,c,zi,u)})})}}class zM{constructor(){this.name=It.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class FM{constructor(){this.name=It.KHR_MESH_QUANTIZATION}}class Gm extends dr{constructor(e,t,i,s){super(e,t,i,s)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,n=e*s*3+s;for(let a=0;a!==s;a++)t[a]=i[n+a];return t}interpolate_(e,t,i,s){const n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,r=o*2,c=o*3,h=s-t,d=(i-t)/h,u=d*d,p=u*d,f=e*c,y=f-c,m=-2*p+3*u,g=p-u,x=1-m,v=g-u+d;for(let b=0;b!==o;b++){const _=a[y+b+o],S=a[y+b+r]*h,A=a[f+b+o],R=a[f+b]*h;n[b]=x*_+v*S+m*A+g*R}return n}}const UM=new Cs;class GM extends Gm{interpolate_(e,t,i,s){const n=super.interpolate_(e,t,i,s);return UM.fromArray(n).normalize().toArray(n),n}}const fs={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},qa={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Wp={9728:xi,9729:bi,9984:Xf,9985:gl,9986:Lo,9987:un},Vp={33071:Us,33648:Al,10497:Ys},Gc={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},xd={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},En={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},HM={CUBICSPLINE:void 0,LINEAR:Zo,STEP:Ko},Hc={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function qM(l){return l.DefaultMaterial===void 0&&(l.DefaultMaterial=new X({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Xs})),l.DefaultMaterial}function Vn(l,e,t){for(const i in t.extensions)l[i]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[i]=t.extensions[i])}function Os(l,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(l.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function WM(l,e,t){let i=!1,s=!1,n=!1;for(let c=0,h=e.length;c<h;c++){const d=e[c];if(d.POSITION!==void 0&&(i=!0),d.NORMAL!==void 0&&(s=!0),d.COLOR_0!==void 0&&(n=!0),i&&s&&n)break}if(!i&&!s&&!n)return Promise.resolve(l);const a=[],o=[],r=[];for(let c=0,h=e.length;c<h;c++){const d=e[c];if(i){const u=d.POSITION!==void 0?t.getDependency("accessor",d.POSITION):l.attributes.position;a.push(u)}if(s){const u=d.NORMAL!==void 0?t.getDependency("accessor",d.NORMAL):l.attributes.normal;o.push(u)}if(n){const u=d.COLOR_0!==void 0?t.getDependency("accessor",d.COLOR_0):l.attributes.color;r.push(u)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(r)]).then(function(c){const h=c[0],d=c[1],u=c[2];return i&&(l.morphAttributes.position=h),s&&(l.morphAttributes.normal=d),n&&(l.morphAttributes.color=u),l.morphTargetsRelative=!0,l})}function VM(l,e){if(l.updateMorphTargets(),e.weights!==void 0)for(let t=0,i=e.weights.length;t<i;t++)l.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(l.morphTargetInfluences.length===t.length){l.morphTargetDictionary={};for(let i=0,s=t.length;i<s;i++)l.morphTargetDictionary[t[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function $M(l){let e;const t=l.extensions&&l.extensions[It.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+qc(t.attributes):e=l.indices+":"+qc(l.attributes)+":"+l.mode,l.targets!==void 0)for(let i=0,s=l.targets.length;i<s;i++)e+=":"+qc(l.targets[i]);return e}function qc(l){let e="";const t=Object.keys(l).sort();for(let i=0,s=t.length;i<s;i++)e+=t[i]+":"+l[t[i]]+";";return e}function bd(l){switch(l){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function XM(l){return l.search(/\.jpe?g($|\?)/i)>0||l.search(/^data\:image\/jpeg/)===0?"image/jpeg":l.search(/\.webp($|\?)/i)>0||l.search(/^data\:image\/webp/)===0?"image/webp":l.search(/\.ktx2($|\?)/i)>0||l.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const YM=new ut;class QM{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new yM,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,s=-1,n=!1,a=-1;if(typeof navigator<"u"){const o=navigator.userAgent;i=/^((?!chrome|android).)*safari/i.test(o)===!0;const r=o.match(/Version\/(\d+)/);s=i&&r?parseInt(r[1],10):-1,n=o.indexOf("Firefox")>-1,a=n?o.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||i&&s<17||n&&a<98?this.textureLoader=new Im(this.options.manager):this.textureLoader=new Qy(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Nl(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,s=this.json,n=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(a){return a._markDefs&&a._markDefs()}),Promise.all(this._invokeAll(function(a){return a.beforeRoot&&a.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(a){const o={scene:a[0][s.scene||0],scenes:a[0],animations:a[1],cameras:a[2],asset:s.asset,parser:i,userData:{}};return Vn(n,o,s),Os(o,s),Promise.all(i._invokeAll(function(r){return r.afterRoot&&r.afterRoot(o)})).then(function(){for(const r of o.scenes)r.updateMatrixWorld();e(o)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let s=0,n=t.length;s<n;s++){const a=t[s].joints;for(let o=0,r=a.length;o<r;o++)e[a[o]].isBone=!0}for(let s=0,n=e.length;s<n;s++){const a=e[s];a.mesh!==void 0&&(this._addNodeRef(this.meshCache,a.mesh),a.skin!==void 0&&(i[a.mesh].isSkinnedMesh=!0)),a.camera!==void 0&&this._addNodeRef(this.cameraCache,a.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const s=i.clone(),n=(a,o)=>{const r=this.associations.get(a);r!=null&&this.associations.set(o,r);for(const[c,h]of a.children.entries())n(h,o.children[c])};return n(i,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const s=e(t[i]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let s=0;s<t.length;s++){const n=e(t[s]);n&&i.push(n)}return i}getDependency(e,t){const i=e+":"+t;let s=this.cache.get(i);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(n){return n.loadNode&&n.loadNode(t)});break;case"mesh":s=this._invokeOne(function(n){return n.loadMesh&&n.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(n){return n.loadBufferView&&n.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(n){return n.loadMaterial&&n.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(n){return n.loadTexture&&n.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(n){return n.loadAnimation&&n.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e);break}this.cache.add(i,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,s=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(s.map(function(n,a){return i.getDependency(e,a)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[It.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(n,a){i.load($o.resolveURL(t.uri,s.path),n,void 0,function(){a(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(i){const s=t.byteLength||0,n=t.byteOffset||0;return i.slice(n,n+s)})}loadAccessor(e){const t=this,i=this.json,s=this.json.accessors[e];if(s.bufferView===void 0&&s.sparse===void 0){const a=Gc[s.type],o=qa[s.componentType],r=s.normalized===!0,c=new o(s.count*a);return Promise.resolve(new Je(c,a,r))}const n=[];return s.bufferView!==void 0?n.push(this.getDependency("bufferView",s.bufferView)):n.push(null),s.sparse!==void 0&&(n.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),n.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(n).then(function(a){const o=a[0],r=Gc[s.type],c=qa[s.componentType],h=c.BYTES_PER_ELEMENT,d=h*r,u=s.byteOffset||0,p=s.bufferView!==void 0?i.bufferViews[s.bufferView].byteStride:void 0,f=s.normalized===!0;let y,m;if(p&&p!==d){const g=Math.floor(u/p),x="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+g+":"+s.count;let v=t.cache.get(x);v||(y=new c(o,g*p,s.count*p/h),v=new $d(y,p/h),t.cache.add(x,v)),m=new Qa(v,r,u%p/h,f)}else o===null?y=new c(s.count*r):y=new c(o,u,s.count*r),m=new Je(y,r,f);if(s.sparse!==void 0){const g=Gc.SCALAR,x=qa[s.sparse.indices.componentType],v=s.sparse.indices.byteOffset||0,b=s.sparse.values.byteOffset||0,_=new x(a[1],v,s.sparse.count*g),S=new c(a[2],b,s.sparse.count*r);o!==null&&(m=new Je(m.array.slice(),m.itemSize,m.normalized)),m.normalized=!1;for(let A=0,R=_.length;A<R;A++){const M=_[A];if(m.setX(M,S[A*r]),r>=2&&m.setY(M,S[A*r+1]),r>=3&&m.setZ(M,S[A*r+2]),r>=4&&m.setW(M,S[A*r+3]),r>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}m.normalized=f}return m})}loadTexture(e){const t=this.json,i=this.options,n=t.textures[e].source,a=t.images[n];let o=this.textureLoader;if(a.uri){const r=i.manager.getHandler(a.uri);r!==null&&(o=r)}return this.loadTextureImage(e,n,o)}loadTextureImage(e,t,i){const s=this,n=this.json,a=n.textures[e],o=n.images[t],r=(o.uri||o.bufferView)+":"+a.sampler;if(this.textureCache[r])return this.textureCache[r];const c=this.loadImageSource(t,i).then(function(h){h.flipY=!1,h.name=a.name||o.name||"",h.name===""&&typeof o.uri=="string"&&o.uri.startsWith("data:image/")===!1&&(h.name=o.uri);const u=(n.samplers||{})[a.sampler]||{};return h.magFilter=Wp[u.magFilter]||bi,h.minFilter=Wp[u.minFilter]||un,h.wrapS=Vp[u.wrapS]||Ys,h.wrapT=Vp[u.wrapT]||Ys,h.generateMipmaps=!h.isCompressedTexture&&h.minFilter!==xi&&h.minFilter!==bi,s.associations.set(h,{textures:e}),h}).catch(function(){return null});return this.textureCache[r]=c,c}loadImageSource(e,t){const i=this,s=this.json,n=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(d=>d.clone());const a=s.images[e],o=self.URL||self.webkitURL;let r=a.uri||"",c=!1;if(a.bufferView!==void 0)r=i.getDependency("bufferView",a.bufferView).then(function(d){c=!0;const u=new Blob([d],{type:a.mimeType});return r=o.createObjectURL(u),r});else if(a.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(r).then(function(d){return new Promise(function(u,p){let f=u;t.isImageBitmapLoader===!0&&(f=function(y){const m=new _i(y);m.needsUpdate=!0,u(m)}),t.load($o.resolveURL(d,n.path),f,void 0,p)})}).then(function(d){return c===!0&&o.revokeObjectURL(r),Os(d,a),d.userData.mimeType=a.mimeType||XM(a.uri),d}).catch(function(d){throw console.error("THREE.GLTFLoader: Couldn't load texture",r),d});return this.sourceCache[e]=h,h}assignTexture(e,t,i,s){const n=this;return this.getDependency("texture",i.index).then(function(a){if(!a)return null;if(i.texCoord!==void 0&&i.texCoord>0&&(a=a.clone(),a.channel=i.texCoord),n.extensions[It.KHR_TEXTURE_TRANSFORM]){const o=i.extensions!==void 0?i.extensions[It.KHR_TEXTURE_TRANSFORM]:void 0;if(o){const r=n.associations.get(a);a=n.extensions[It.KHR_TEXTURE_TRANSFORM].extendTexture(a,o),n.associations.set(a,r)}}return s!==void 0&&(a.colorSpace=s),e[t]=a,a})}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const s=t.attributes.tangent===void 0,n=t.attributes.color!==void 0,a=t.attributes.normal===void 0;if(e.isPoints){const o="PointsMaterial:"+i.uuid;let r=this.cache.get(o);r||(r=new Ri,As.prototype.copy.call(r,i),r.color.copy(i.color),r.map=i.map,r.sizeAttenuation=!1,this.cache.add(o,r)),i=r}else if(e.isLine){const o="LineBasicMaterial:"+i.uuid;let r=this.cache.get(o);r||(r=new Kd,As.prototype.copy.call(r,i),r.color.copy(i.color),r.map=i.map,this.cache.add(o,r)),i=r}if(s||n||a){let o="ClonedMaterial:"+i.uuid+":";s&&(o+="derivative-tangents:"),n&&(o+="vertex-colors:"),a&&(o+="flat-shading:");let r=this.cache.get(o);r||(r=i.clone(),n&&(r.vertexColors=!0),a&&(r.flatShading=!0),s&&(r.normalScale&&(r.normalScale.y*=-1),r.clearcoatNormalScale&&(r.clearcoatNormalScale.y*=-1)),this.cache.add(o,r),this.associations.set(r,this.associations.get(i))),i=r}e.material=i}getMaterialType(){return X}loadMaterial(e){const t=this,i=this.json,s=this.extensions,n=i.materials[e];let a;const o={},r=n.extensions||{},c=[];if(r[It.KHR_MATERIALS_UNLIT]){const d=s[It.KHR_MATERIALS_UNLIT];a=d.getMaterialType(),c.push(d.extendParams(o,n,t))}else{const d=n.pbrMetallicRoughness||{};if(o.color=new H(1,1,1),o.opacity=1,Array.isArray(d.baseColorFactor)){const u=d.baseColorFactor;o.color.setRGB(u[0],u[1],u[2],zi),o.opacity=u[3]}d.baseColorTexture!==void 0&&c.push(t.assignTexture(o,"map",d.baseColorTexture,pi)),o.metalness=d.metallicFactor!==void 0?d.metallicFactor:1,o.roughness=d.roughnessFactor!==void 0?d.roughnessFactor:1,d.metallicRoughnessTexture!==void 0&&(c.push(t.assignTexture(o,"metalnessMap",d.metallicRoughnessTexture)),c.push(t.assignTexture(o,"roughnessMap",d.metallicRoughnessTexture))),a=this._invokeOne(function(u){return u.getMaterialType&&u.getMaterialType(e)}),c.push(Promise.all(this._invokeAll(function(u){return u.extendMaterialParams&&u.extendMaterialParams(e,o)})))}n.doubleSided===!0&&(o.side=lt);const h=n.alphaMode||Hc.OPAQUE;if(h===Hc.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,h===Hc.MASK&&(o.alphaTest=n.alphaCutoff!==void 0?n.alphaCutoff:.5)),n.normalTexture!==void 0&&a!==B&&(c.push(t.assignTexture(o,"normalMap",n.normalTexture)),o.normalScale=new le(1,1),n.normalTexture.scale!==void 0)){const d=n.normalTexture.scale;o.normalScale.set(d,d)}if(n.occlusionTexture!==void 0&&a!==B&&(c.push(t.assignTexture(o,"aoMap",n.occlusionTexture)),n.occlusionTexture.strength!==void 0&&(o.aoMapIntensity=n.occlusionTexture.strength)),n.emissiveFactor!==void 0&&a!==B){const d=n.emissiveFactor;o.emissive=new H().setRGB(d[0],d[1],d[2],zi)}return n.emissiveTexture!==void 0&&a!==B&&c.push(t.assignTexture(o,"emissiveMap",n.emissiveTexture,pi)),Promise.all(c).then(function(){const d=new a(o);return n.name&&(d.name=n.name),Os(d,n),t.associations.set(d,{materials:e}),n.extensions&&Vn(s,d,n),d})}createUniqueName(e){const t=Ht.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,s=this.primitiveCache;function n(o){return i[It.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(o,t).then(function(r){return $p(r,o,t)})}const a=[];for(let o=0,r=e.length;o<r;o++){const c=e[o],h=$M(c),d=s[h];if(d)a.push(d.promise);else{let u;c.extensions&&c.extensions[It.KHR_DRACO_MESH_COMPRESSION]?u=n(c):u=$p(new mt,c,t),s[h]={primitive:c,promise:u},a.push(u)}}return Promise.all(a)}loadMesh(e){const t=this,i=this.json,s=this.extensions,n=i.meshes[e],a=n.primitives,o=[];for(let r=0,c=a.length;r<c;r++){const h=a[r].material===void 0?qM(this.cache):this.getDependency("material",a[r].material);o.push(h)}return o.push(t.loadGeometries(a)),Promise.all(o).then(function(r){const c=r.slice(0,r.length-1),h=r[r.length-1],d=[];for(let p=0,f=h.length;p<f;p++){const y=h[p],m=a[p];let g;const x=c[p];if(m.mode===fs.TRIANGLES||m.mode===fs.TRIANGLE_STRIP||m.mode===fs.TRIANGLE_FAN||m.mode===void 0)g=n.isSkinnedMesh===!0?new Hg(y,x):new w(y,x),g.isSkinnedMesh===!0&&g.normalizeSkinWeights(),m.mode===fs.TRIANGLE_STRIP?g.geometry=Hp(g.geometry,im):m.mode===fs.TRIANGLE_FAN&&(g.geometry=Hp(g.geometry,ld));else if(m.mode===fs.LINES)g=new Yg(y,x);else if(m.mode===fs.LINE_STRIP)g=new Vl(y,x);else if(m.mode===fs.LINE_LOOP)g=new Qg(y,x);else if(m.mode===fs.POINTS)g=new Bi(y,x);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);Object.keys(g.geometry.morphAttributes).length>0&&VM(g,n),g.name=t.createUniqueName(n.name||"mesh_"+e),Os(g,n),m.extensions&&Vn(s,g,m),t.assignFinalMaterial(g),d.push(g)}for(let p=0,f=d.length;p<f;p++)t.associations.set(d[p],{meshes:e,primitives:p});if(d.length===1)return n.extensions&&Vn(s,d[0],n),d[0];const u=new ne;n.extensions&&Vn(s,u,n),t.associations.set(u,{meshes:e});for(let p=0,f=d.length;p<f;p++)u.add(d[p]);return u})}loadCamera(e){let t;const i=this.json.cameras[e],s=i[i.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return i.type==="perspective"?t=new Wi(gt.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):i.type==="orthographic"&&(t=new ur(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),Os(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i=[];for(let s=0,n=t.joints.length;s<n;s++)i.push(this._loadNodeShallow(t.joints[s]));return t.inverseBindMatrices!==void 0?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(s){const n=s.pop(),a=s,o=[],r=[];for(let c=0,h=a.length;c<h;c++){const d=a[c];if(d){o.push(d);const u=new ut;n!==null&&u.fromArray(n.array,c*16),r.push(u)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[c])}return new Qd(o,r)})}loadAnimation(e){const t=this.json,i=this,s=t.animations[e],n=s.name?s.name:"animation_"+e,a=[],o=[],r=[],c=[],h=[];for(let d=0,u=s.channels.length;d<u;d++){const p=s.channels[d],f=s.samplers[p.sampler],y=p.target,m=y.node,g=s.parameters!==void 0?s.parameters[f.input]:f.input,x=s.parameters!==void 0?s.parameters[f.output]:f.output;y.node!==void 0&&(a.push(this.getDependency("node",m)),o.push(this.getDependency("accessor",g)),r.push(this.getDependency("accessor",x)),c.push(f),h.push(y))}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(r),Promise.all(c),Promise.all(h)]).then(function(d){const u=d[0],p=d[1],f=d[2],y=d[3],m=d[4],g=[];for(let v=0,b=u.length;v<b;v++){const _=u[v],S=p[v],A=f[v],R=y[v],M=m[v];if(_===void 0)continue;_.updateMatrix&&_.updateMatrix();const C=i._createAnimationTracks(_,S,A,R,M);if(C)for(let k=0;k<C.length;k++)g.push(C[k])}const x=new md(n,void 0,g);return Os(x,s),x})}createNodeMesh(e){const t=this.json,i=this,s=t.nodes[e];return s.mesh===void 0?null:i.getDependency("mesh",s.mesh).then(function(n){const a=i._getNodeRef(i.meshCache,s.mesh,n);return s.weights!==void 0&&a.traverse(function(o){if(o.isMesh)for(let r=0,c=s.weights.length;r<c;r++)o.morphTargetInfluences[r]=s.weights[r]}),a})}loadNode(e){const t=this.json,i=this,s=t.nodes[e],n=i._loadNodeShallow(e),a=[],o=s.children||[];for(let c=0,h=o.length;c<h;c++)a.push(i.getDependency("node",o[c]));const r=s.skin===void 0?Promise.resolve(null):i.getDependency("skin",s.skin);return Promise.all([n,Promise.all(a),r]).then(function(c){const h=c[0],d=c[1],u=c[2];u!==null&&h.traverse(function(p){p.isSkinnedMesh&&p.bind(u,YM)});for(let p=0,f=d.length;p<f;p++)h.add(d[p]);return h})}_loadNodeShallow(e){const t=this.json,i=this.extensions,s=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const n=t.nodes[e],a=n.name?s.createUniqueName(n.name):"",o=[],r=s._invokeOne(function(c){return c.createNodeMesh&&c.createNodeMesh(e)});return r&&o.push(r),n.camera!==void 0&&o.push(s.getDependency("camera",n.camera).then(function(c){return s._getNodeRef(s.cameraCache,n.camera,c)})),s._invokeAll(function(c){return c.createNodeAttachment&&c.createNodeAttachment(e)}).forEach(function(c){o.push(c)}),this.nodeCache[e]=Promise.all(o).then(function(c){let h;if(n.isBone===!0?h=new gm:c.length>1?h=new ne:c.length===1?h=c[0]:h=new ai,h!==c[0])for(let d=0,u=c.length;d<u;d++)h.add(c[d]);if(n.name&&(h.userData.name=n.name,h.name=a),Os(h,n),n.extensions&&Vn(i,h,n),n.matrix!==void 0){const d=new ut;d.fromArray(n.matrix),h.applyMatrix4(d)}else n.translation!==void 0&&h.position.fromArray(n.translation),n.rotation!==void 0&&h.quaternion.fromArray(n.rotation),n.scale!==void 0&&h.scale.fromArray(n.scale);if(!s.associations.has(h))s.associations.set(h,{});else if(n.mesh!==void 0&&s.meshCache.refs[n.mesh]>1){const d=s.associations.get(h);s.associations.set(h,{...d})}return s.associations.get(h).nodes=e,h}),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],s=this,n=new ne;i.name&&(n.name=s.createUniqueName(i.name)),Os(n,i),i.extensions&&Vn(t,n,i);const a=i.nodes||[],o=[];for(let r=0,c=a.length;r<c;r++)o.push(s.getDependency("node",a[r]));return Promise.all(o).then(function(r){for(let h=0,d=r.length;h<d;h++)n.add(r[h]);const c=h=>{const d=new Map;for(const[u,p]of s.associations)(u instanceof As||u instanceof _i)&&d.set(u,p);return h.traverse(u=>{const p=s.associations.get(u);p!=null&&d.set(u,p)}),d};return s.associations=c(n),n})}_createAnimationTracks(e,t,i,s,n){const a=[],o=e.name?e.name:e.uuid,r=[];En[n.path]===En.weights?e.traverse(function(u){u.morphTargetInfluences&&r.push(u.name?u.name:u.uuid)}):r.push(o);let c;switch(En[n.path]){case En.weights:c=Ka;break;case En.rotation:c=Za;break;case En.translation:case En.scale:c=Ja;break;default:i.itemSize===1?c=Ka:c=Ja;break}const h=s.interpolation!==void 0?HM[s.interpolation]:Zo,d=this._getArrayFromAccessor(i);for(let u=0,p=r.length;u<p;u++){const f=new c(r[u]+"."+En[n.path],t.array,d,h);s.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(f),a.push(f)}return a}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const i=bd(t.constructor),s=new Float32Array(t.length);for(let n=0,a=t.length;n<a;n++)s[n]=t[n]*i;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(i){const s=this instanceof Za?GM:Gm;return new s(this.times,this.values,this.getValueSize()/3,i)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function jM(l,e,t){const i=e.attributes,s=new Qi;if(i.POSITION!==void 0){const o=t.json.accessors[i.POSITION],r=o.min,c=o.max;if(r!==void 0&&c!==void 0){if(s.set(new T(r[0],r[1],r[2]),new T(c[0],c[1],c[2])),o.normalized){const h=bd(qa[o.componentType]);s.min.multiplyScalar(h),s.max.multiplyScalar(h)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const n=e.targets;if(n!==void 0){const o=new T,r=new T;for(let c=0,h=n.length;c<h;c++){const d=n[c];if(d.POSITION!==void 0){const u=t.json.accessors[d.POSITION],p=u.min,f=u.max;if(p!==void 0&&f!==void 0){if(r.setX(Math.max(Math.abs(p[0]),Math.abs(f[0]))),r.setY(Math.max(Math.abs(p[1]),Math.abs(f[1]))),r.setZ(Math.max(Math.abs(p[2]),Math.abs(f[2]))),u.normalized){const y=bd(qa[u.componentType]);r.multiplyScalar(y)}o.max(r)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(o)}l.boundingBox=s;const a=new Zs;s.getCenter(a.center),a.radius=s.min.distanceTo(s.max)/2,l.boundingSphere=a}function $p(l,e,t){const i=e.attributes,s=[];function n(a,o){return t.getDependency("accessor",a).then(function(r){l.setAttribute(o,r)})}for(const a in i){const o=xd[a]||a.toLowerCase();o in l.attributes||s.push(n(i[a],o))}if(e.indices!==void 0&&!l.index){const a=t.getDependency("accessor",e.indices).then(function(o){l.setIndex(o)});s.push(a)}return Rt.workingColorSpace!==zi&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Rt.workingColorSpace}" not supported.`),Os(l,e),jM(l,e,t),Promise.all(s).then(function(){return e.targets!==void 0?WM(l,e.targets,t):l})}const Wc=new WeakMap;class KM extends ca{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,s){const n=new Nl(this.manager);n.setPath(this.path),n.setResponseType("arraybuffer"),n.setRequestHeader(this.requestHeader),n.setWithCredentials(this.withCredentials),n.load(e,a=>{this.parse(a,t,s)},i,s)}parse(e,t,i=()=>{}){this.decodeDracoFile(e,t,null,null,pi,i).catch(i)}decodeDracoFile(e,t,i,s,n=zi,a=()=>{}){const o={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i,vertexColorSpace:n};return this.decodeGeometry(e,o).then(t).catch(a)}decodeGeometry(e,t){const i=JSON.stringify(t);if(Wc.has(e)){const r=Wc.get(e);if(r.key===i)return r.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const n=this.workerNextTaskID++,a=e.byteLength,o=this._getWorker(n,a).then(r=>(s=r,new Promise((c,h)=>{s._callbacks[n]={resolve:c,reject:h},s.postMessage({type:"decode",id:n,taskConfig:t,buffer:e},[e])}))).then(r=>this._createGeometry(r.geometry));return o.catch(()=>!0).then(()=>{s&&n&&this._releaseTask(s,n)}),Wc.set(e,{key:i,promise:o}),o}_createGeometry(e){const t=new mt;e.index&&t.setIndex(new Je(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const{name:s,array:n,itemSize:a,stride:o,vertexColorSpace:r}=e.attributes[i];let c;if(a===o)c=new Je(n,a);else{const h=new $d(n,o);c=new Qa(h,a,0)}s==="color"&&(this._assignVertexColorSpace(c,r),c.normalized=!(n instanceof Float32Array)),t.setAttribute(s,c)}return t}_assignVertexColorSpace(e,t){if(t!==pi)return;const i=new H;for(let s=0,n=e.count;s<n;s++)i.fromBufferAttribute(e,s),Rt.colorSpaceToWorking(i,pi),e.setXYZ(s,i.r,i.g,i.b)}_loadLibrary(e,t){const i=new Nl(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise((s,n)=>{i.load(e,s,void 0,n)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(i=>{const s=i[0];e||(this.decoderConfig.wasmBinary=i[1]);const n=ZM.toString(),a=["/* draco decoder */",s,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([a]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const s=new Worker(this.workerSourceURL);s._callbacks={},s._taskCosts={},s._taskLoad=0,s.postMessage({type:"init",decoderConfig:this.decoderConfig}),s.onmessage=function(n){const a=n.data;switch(a.type){case"decode":s._callbacks[a.id].resolve(a);break;case"error":s._callbacks[a.id].reject(a);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+a.type+'"')}},this.workerPool.push(s)}else this.workerPool.sort(function(s,n){return s._taskLoad>n._taskLoad?-1:1});const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this.workerSourceURL!==""&&URL.revokeObjectURL(this.workerSourceURL),this}}function ZM(){let l,e;onmessage=function(a){const o=a.data;switch(o.type){case"init":l=o.decoderConfig,e=new Promise(function(h){l.onModuleLoaded=function(d){h({draco:d})},DracoDecoderModule(l)});break;case"decode":const r=o.buffer,c=o.taskConfig;e.then(h=>{const d=h.draco,u=new d.Decoder;try{const p=t(d,u,new Int8Array(r),c),f=p.attributes.map(y=>y.array.buffer);p.index&&f.push(p.index.array.buffer),self.postMessage({type:"decode",id:o.id,geometry:p},f)}catch(p){console.error(p),self.postMessage({type:"error",id:o.id,error:p.message})}finally{d.destroy(u)}});break}};function t(a,o,r,c){const h=c.attributeIDs,d=c.attributeTypes;let u,p;const f=o.GetEncodedGeometryType(r);if(f===a.TRIANGULAR_MESH)u=new a.Mesh,p=o.DecodeArrayToMesh(r,r.byteLength,u);else if(f===a.POINT_CLOUD)u=new a.PointCloud,p=o.DecodeArrayToPointCloud(r,r.byteLength,u);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!p.ok()||u.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+p.error_msg());const y={index:null,attributes:[]};for(const m in h){const g=self[d[m]];let x,v;if(c.useUniqueIDs)v=h[m],x=o.GetAttributeByUniqueId(u,v);else{if(v=o.GetAttributeId(u,a[h[m]]),v===-1)continue;x=o.GetAttribute(u,v)}const b=s(a,o,u,m,g,x);m==="color"&&(b.vertexColorSpace=c.vertexColorSpace),y.attributes.push(b)}return f===a.TRIANGULAR_MESH&&(y.index=i(a,o,u)),a.destroy(u),y}function i(a,o,r){const h=r.num_faces()*3,d=h*4,u=a._malloc(d);o.GetTrianglesUInt32Array(r,d,u);const p=new Uint32Array(a.HEAPF32.buffer,u,h).slice();return a._free(u),{array:p,itemSize:1}}function s(a,o,r,c,h,d){const u=r.num_points(),p=d.num_components(),f=n(a,h),y=p*h.BYTES_PER_ELEMENT,m=Math.ceil(y/4)*4,g=m/h.BYTES_PER_ELEMENT,x=u*y,v=u*m,b=a._malloc(x);o.GetAttributeDataArrayForAllPoints(r,d,f,x,b);const _=new h(a.HEAPF32.buffer,b,x/h.BYTES_PER_ELEMENT);let S;if(y===m)S=_.slice();else{S=new h(v/h.BYTES_PER_ELEMENT);let A=0;for(let R=0,M=_.length;R<M;R++){for(let C=0;C<p;C++)S[A+C]=_[R*p+C];A+=g}}return a._free(b),{name:c,count:u,itemSize:p,array:S,stride:g}}function n(a,o){switch(o){case Float32Array:return a.DT_FLOAT32;case Int8Array:return a.DT_INT8;case Int16Array:return a.DT_INT16;case Int32Array:return a.DT_INT32;case Uint8Array:return a.DT_UINT8;case Uint16Array:return a.DT_UINT16;case Uint32Array:return a.DT_UINT32}}}class JM{constructor(){this.gltfLoader=new gM,this.dracoLoader=new KM,this.textureLoader=new Im,this.dracoLoader.setDecoderPath("https://www.gstatic.com/draco/versioned/decoders/1.5.6/"),this.dracoLoader.setDecoderConfig({type:"js"}),this.gltfLoader.setDRACOLoader(this.dracoLoader),this.modelCache=new Map,this.textureCache=new Map,this.loadingPromises=new Map,this.debug=!1}async loadModel(e,t={}){const i=e+JSON.stringify(t);if(this.modelCache.has(i)){const n=this.modelCache.get(i);return this._cloneGLTF(n)}if(this.loadingPromises.has(i)){const n=await this.loadingPromises.get(i);return this._cloneGLTF(n)}const s=new Promise((n,a)=>{this.debug&&console.log(`[AssetManager] Loading: ${e}`),this.gltfLoader.load(e,o=>{this.debug&&(console.log(`[AssetManager] Loaded: ${e}`),console.log(`  - Animations: ${o.animations.length}`),o.animations.forEach((c,h)=>{console.log(`    ${h}: ${c.name} (${c.duration.toFixed(2)}s)`)})),t.scale&&o.scene.scale.setScalar(t.scale),o.scene.traverse(c=>{c.isMesh&&(c.castShadow=!0,c.receiveShadow=!0,c.material&&(Array.isArray(c.material)?c.material.forEach(h=>this._fixMaterial(h)):this._fixMaterial(c.material)))});const r={scene:o.scene,animations:o.animations,gltf:o};this.modelCache.set(i,r),n(r)},o=>{if(this.debug&&o.total>0){const r=(o.loaded/o.total*100).toFixed(1);console.log(`[AssetManager] Loading ${e}: ${r}%`)}},o=>{console.error(`[AssetManager] Failed to load: ${e}`,o),a(o)})});this.loadingPromises.set(i,s);try{const n=await s;return this.loadingPromises.delete(i),this._cloneGLTF(n)}catch(n){throw this.loadingPromises.delete(i),n}}_cloneGLTF(e){return{scene:e.scene.clone(),animations:e.animations,gltf:e.gltf}}_fixMaterial(e){(e.isMeshStandardMaterial||e.isMeshPhysicalMaterial)&&(e.metalness===void 0&&(e.metalness=0),e.roughness===void 0&&(e.roughness=.8)),e.transparent&&(e.depthWrite=!1,e.side=lt)}async loadTexture(e,t={}){return this.textureCache.has(e)?this.textureCache.get(e):new Promise((i,s)=>{this.textureLoader.load(e,n=>{t.repeat&&(n.wrapS=Ys,n.wrapT=Ys,n.repeat.set(t.repeat[0],t.repeat[1])),t.encoding?n.colorSpace=t.encoding:n.colorSpace=pi,t.anisotropy&&(n.anisotropy=t.anisotropy),this.textureCache.set(e,n),i(n)},void 0,s)})}async preload(e){const t=e.map(i=>i.type==="model"?this.loadModel(i.path,i.options):i.type==="texture"?this.loadTexture(i.path,i.options):Promise.resolve());return Promise.all(t)}createAnimationSystem(e,t){const i=new Pm(e),s=new Map;return t.forEach(n=>{const a=i.clipAction(n);s.set(n.name,a),s.set(n.name.toLowerCase(),a)}),{mixer:i,actions:s,play:(n,a={})=>{const o=s.get(n)||s.get(n.toLowerCase());return o?(o.reset(),a.loop!==void 0&&o.setLoop(a.loop?tm:em),a.clampWhenFinished&&(o.clampWhenFinished=!0),a.timeScale&&(o.timeScale=a.timeScale),a.fadeIn&&o.fadeIn(a.fadeIn),o.play(),o):(this.debug&&console.warn(`[AssetManager] Animation not found: ${n}`),null)},crossFade:(n,a,o=.2)=>{const r=s.get(n)||s.get(n.toLowerCase()),c=s.get(a)||s.get(a.toLowerCase());return c?(c.reset(),c.play(),r&&r.isRunning()&&r.crossFadeTo(c,o,!0),c):null},stopAll:()=>{i.stopAllAction()},update:n=>{i.update(n)}}}clearCache(){this.modelCache.clear(),this.textureCache.clear()}dispose(){this.modelCache.forEach(e=>{e.scene.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(i=>i.dispose()):t.material.dispose())})}),this.textureCache.forEach(e=>{e.dispose()}),this.dracoLoader.dispose(),this.clearCache()}}const or=new JM,Ie={IDLE:"idle",MOVING:"moving",DODGING:"dodging",ATTACKING:"attacking",HEAVY_ATTACKING:"heavy_attacking",BLOCKING:"blocking",STAGGERED:"staggered",DEAD:"dead",DASHING:"dashing",CHARGING:"charging",CHARGED_ATTACKING:"charged_attacking",PARRYING:"parrying",WAR_CRYING:"war_crying"},$n={dodge:20,lightAttack:15,heavyAttack:30},fi={dodgeDuration:.45,dodgeIframes:.3,lightAttackDuration:.35,heavyAttackDuration:.65,lightHitStart:.06,lightHitEnd:.18,heavyHitStart:.15,heavyHitEnd:.35,staggerDuration:.8,comboWindow:.12,dashDuration:.25,dashIframes:.2,parryWindow:.15,parryDuration:.35,chargedAttackDuration:.9,chargedHitStart:.25,chargedHitEnd:.5,warCryDuration:.8},e1={[Ie.IDLE]:"Idle",[Ie.MOVING]:"Walking",[Ie.DODGING]:"Jump",[Ie.ATTACKING]:"Punch",[Ie.HEAVY_ATTACKING]:"Punch",[Ie.BLOCKING]:"Idle",[Ie.STAGGERED]:"No",[Ie.DEAD]:"Death",[Ie.DASHING]:"Jump",[Ie.CHARGING]:"Idle",[Ie.CHARGED_ATTACKING]:"Punch",[Ie.PARRYING]:"Idle",[Ie.WAR_CRYING]:"ThumbsUp"};class t1{constructor(e,t,i){this.scene=e,this.gm=t,this.input=i,this.cameraController=null,this.world=null,this.state=Ie.IDLE,this.stateTimer=0,this.isInvincible=!1,this.attackCombo=0,this.hitThisSwing=!1,this.velocity=new T,this.moveSpeed=6,this.dodgeSpeed=14,this.gravity=-30,this.grounded=!0,this.collisionRadius=.4,this.currentMoveVelocity=new T,this.moveAcceleration=35,this.moveDeceleration=25,this.dodgeGhostMeshes=[],this.lastGhostSpawnTime=0,this.ghostSpawnInterval=.05;const s=typeof window<"u"&&window.AUTOSTART_MODE===!0;this._spawnSafetyFrames=s?120:60,this.dashDir=new T,this.dashSpeed=18,this.parrySuccessful=!1,this.chargeProgress=0,this.chargedDamage=60,this.chargedPostureDmg=40,this.moveDir=new T,this.dodgeDir=new T,this.facingAngle=Math.PI,this.modelLoaded=!1,this.animSystem=null,this.currentAnim=null,this.gltfModel=null,this.mesh=new ne,this.mesh.position.set(0,50,32),this._createFallbackMesh(),this.attackRange=2,this.lightDamage=15,this.heavyDamage=35,this.lightPostureDmg=10,this.heavyPostureDmg=25,e.add(this.mesh),this._loadGLTFModel()}_createFallbackMesh(){const e=new B({color:5921384,roughness:.35,metalness:.85}),t=new B({color:3816005,roughness:.4,metalness:.8}),i=new B({color:8026764,roughness:.3,metalness:.9,emissive:1710626,emissiveIntensity:.4}),s=new Pt(.35,.6,8,16);this.fallbackBody=new w(s,e),this.fallbackBody.position.y=1.1,this.fallbackBody.castShadow=!0,this.mesh.add(this.fallbackBody);const n=new re(.22,16,12);this.fallbackHead=new w(n,e),this.fallbackHead.position.y=1.7,this.fallbackHead.castShadow=!0,this.mesh.add(this.fallbackHead);const a=new B({color:6737151,emissive:4491468,emissiveIntensity:3}),o=new ie(.2,.04,.12);this.visor=new w(o,a),this.visor.position.set(0,1.68,.25),this.mesh.add(this.visor);const r=new Pt(.08,.28,6,10),c=new Pt(.07,.26,6,10),h=new w(r,e);h.position.set(-.42,1.25,0),h.rotation.z=.2,h.castShadow=!0,this.mesh.add(h);const d=new w(r,e);d.position.set(.42,1.25,0),d.rotation.z=-.2,d.castShadow=!0,this.mesh.add(d);const u=new w(c,e);u.position.set(-.52,.9,.05),u.rotation.z=.1,u.rotation.x=-.15,u.castShadow=!0,this.mesh.add(u);const p=new w(c,e);p.position.set(.52,.9,.05),p.rotation.z=-.1,p.rotation.x=-.15,p.castShadow=!0,this.mesh.add(p);const f=new ie(.2,.16,.26),y=new w(f,i);y.position.set(-.56,.58,.1),y.castShadow=!0,this.mesh.add(y);const m=new ie(.18,.1,.18),g=new w(m,i);g.position.set(-.56,.5,.18),g.castShadow=!0,this.mesh.add(g);const x=new ie(.16,.06,.06),v=new w(x,i);v.position.set(-.56,.54,.24),v.castShadow=!0,this.mesh.add(v);const b=new w(f,i);b.position.set(.56,.58,.1),b.castShadow=!0,this.mesh.add(b);const _=new w(m,i);_.position.set(.56,.5,.18),_.castShadow=!0,this.mesh.add(_);const S=new w(x,i);S.position.set(.56,.54,.24),S.castShadow=!0,this.mesh.add(S),this.fallbackRightHand=b,this.fallbackLeftHand=y;const A=new Pt(.1,.32,6,10),R=new Pt(.08,.3,6,10),M=new w(A,e);M.position.set(-.15,.55,0),M.castShadow=!0,this.mesh.add(M);const C=new w(A,e);C.position.set(.15,.55,0),C.castShadow=!0,this.mesh.add(C);const k=new w(R,e);k.position.set(-.15,.18,0),k.castShadow=!0,this.mesh.add(k);const L=new w(R,e);L.position.set(.15,.18,0),L.castShadow=!0,this.mesh.add(L);const O=new ie(.12,.08,.22),W=new w(O,t);W.position.set(-.15,.04,.04),W.castShadow=!0,this.mesh.add(W);const U=new w(O,t);U.position.set(.15,.04,.04),U.castShadow=!0,this.mesh.add(U),this.fallbackParts=[this.fallbackBody,this.fallbackHead,this.visor,h,d,u,p,y,g,v,b,_,S,M,C,k,L,W,U],this.body=this.fallbackBody}async _loadGLTFModel(){try{const e="/project-ashen/",{scene:t,animations:i}=await or.loadModel(`${e}assets/models/robot_expressive.glb`,{scale:.8});this.gltfModel=t,this.gltfModel.position.y=0,this.gltfModel.rotation.y=Math.PI,this.gltfModel.traverse(s=>{s.isMesh&&(s.castShadow=!0,s.receiveShadow=!0,s.material&&(s.material.color&&s.material.color.multiplyScalar(.85),s.material.emissive&&(s.material.emissive.setHex(0),s.material.emissiveIntensity=0)),s.userData.originalMaterial=s.material.clone())}),this.fallbackParts&&this.fallbackParts.forEach(s=>{s&&(s.visible=!1)}),this.mesh.add(this.gltfModel),i&&i.length>0&&(this.animSystem=or.createAnimationSystem(this.gltfModel,i),this._playAnimation(Ie.IDLE,{loop:!0})),this.modelLoaded=!0,this.body=this.gltfModel}catch(e){console.error("[Player] Failed to load GLTF model:",e)}}_playAnimation(e,t={}){if(!this.animSystem)return;const i=e1[e];if(!i||this.currentAnim===i&&e!==Ie.ATTACKING)return;const s={loop:e===Ie.IDLE||e===Ie.MOVING||e===Ie.BLOCKING,fadeIn:.2,timeScale:1,clampWhenFinished:e===Ie.DEAD};e===Ie.ATTACKING?(s.timeScale=1.6+this.attackCombo*.15,s.loop=!1,s.fadeIn=.05):e===Ie.HEAVY_ATTACKING?(s.timeScale=.75,s.loop=!1,s.fadeIn=.1):e===Ie.DODGING?(s.timeScale=1.5,s.loop=!1):e===Ie.MOVING?s.timeScale=1.2:e===Ie.CHARGED_ATTACKING&&(s.timeScale=.65,s.loop=!1,s.fadeIn=.08);const n={...s,...t};this.currentAnim?this.animSystem.crossFade(this.currentAnim,i,n.fadeIn):this.animSystem.play(i,n),this.currentAnim=i}update(e){if(this._spawnSafetyFrames>0&&this._checkSpawnSafety(),this.gm.isDead){this.state=Ie.DEAD,this.currentAnim!=="Death"&&this._playAnimation(Ie.DEAD);return}switch(this.animSystem&&this.animSystem.update(e),this.stateTimer+=e,this.state){case Ie.IDLE:case Ie.MOVING:this._processMovement(e),this._processCombatInput();break;case Ie.DODGING:this._processDodge(e);break;case Ie.ATTACKING:case Ie.HEAVY_ATTACKING:this._processAttack(e);break;case Ie.BLOCKING:this._processBlock(e);break;case Ie.STAGGERED:this.stateTimer>=fi.staggerDuration&&this._changeState(Ie.IDLE);break;case Ie.DEAD:break;case Ie.DASHING:this._processDash(e);break;case Ie.CHARGING:this._processCharging(e);break;case Ie.CHARGED_ATTACKING:this._processChargedAttack(e);break;case Ie.PARRYING:this._processParry(e);break;case Ie.WAR_CRYING:this._processWarCry(e);break}if(this.world){const t=this.world.getFloorY(this.mesh.position.x,this.mesh.position.z);if(this._spawnSafetyFrames>0){let o=null;if(this.world&&this.world.terrain){const c=this.world.terrain.getHeightAt||this.world.terrain.getTerrainHeight;if(c){const h=c.call(this.world.terrain,this.mesh.position.x,this.mesh.position.z);!isNaN(h)&&isFinite(h)&&h>-100&&(o=h)}}const r=o!==null?o+3:5;this.mesh.position.y<r&&(this.mesh.position.y=r,this.velocity.y=0)}t>this.mesh.position.y+2?(console.warn(`[Player] Detected spawn inside terrain! Correcting: y=${this.mesh.position.y} -> ${t+5}`),this.mesh.position.y=t+5,this.velocity.y=0,this.grounded=!1):this.mesh.position.y>t?(this.velocity.y+=this.gravity*e,this.mesh.position.y+=this.velocity.y*e,this.mesh.position.y<=t?(this.mesh.position.y=t,this.velocity.y=0,this.grounded=!0):this.grounded=!1):this.mesh.position.y<t?(this.mesh.position.y=gt.lerp(this.mesh.position.y,t,8*e),this.velocity.y=0,this.grounded=!0):(this.velocity.y=0,this.grounded=!0)}else this.mesh.position.y>0&&(this.velocity.y+=this.gravity*e,this.mesh.position.y+=this.velocity.y*e,this.mesh.position.y<=0&&(this.mesh.position.y=0,this.velocity.y=0,this.grounded=!0))}_processMovement(e){const t=this.input.getMovementVector();if(t.x!==0||t.z!==0){const i=this._getCameraYaw(),s=new T(-Math.sin(i),0,-Math.cos(i)),n=new T(Math.cos(i),0,-Math.sin(i));this.moveDir.set(0,0,0).addScaledVector(s,-t.z).addScaledVector(n,t.x).normalize();const a=this.moveDir.clone().multiplyScalar(this.moveSpeed);this.currentMoveVelocity.lerp(a,this.moveAcceleration*e),this.mesh.position.addScaledVector(this.currentMoveVelocity,e),this._applyWallCollision(),this.facingAngle=Math.atan2(this.moveDir.x,this.moveDir.z),this.mesh.rotation.y=gt.lerp(this.mesh.rotation.y,this.facingAngle+Math.PI,10*e),this.state!==Ie.MOVING&&this._changeState(Ie.MOVING)}else this.currentMoveVelocity.length()>.01?(this.currentMoveVelocity.lerp(new T(0,0,0),this.moveDeceleration*e),this.mesh.position.addScaledVector(this.currentMoveVelocity,e),this._applyWallCollision()):this.currentMoveVelocity.set(0,0,0),this.state===Ie.MOVING&&this._changeState(Ie.IDLE)}_applyWallCollision(){if(!this.world)return;const e=this.world.checkCollision(this.mesh.position,this.collisionRadius);e&&e.collides&&e.pushVector&&this.mesh.position.add(e.pushVector)}_applyFloorCollision(){if(!this.world)return;const e=this.world.getFloorY(this.mesh.position.x,this.mesh.position.z),t=e-this.mesh.position.y;Math.abs(t)<.1?this.mesh.position.y=e:t>0?this.mesh.position.y=gt.lerp(this.mesh.position.y,e,.3):this.mesh.position.y=gt.lerp(this.mesh.position.y,e,.2)}_processCombatInput(){if(this.input.lockOn&&this._toggleLockOn(),this.input.dashAbility&&this.gm.isAbilityUnlocked("dash")&&this.gm.isAbilityReady("dash")&&this.gm.canUseStamina(15)){this._startDash();return}if(this.input.parryAbility&&this.gm.isAbilityUnlocked("parry")&&this.gm.isAbilityReady("parry")&&this.gm.canUseStamina(10)){this._startParry();return}if(this.input.warCryAbility&&this.gm.isAbilityUnlocked("warCry")&&this.gm.isAbilityReady("warCry")&&this.gm.canUseStamina(25)){this._startWarCry();return}if(this.input.chargedAttack&&this.gm.isAbilityUnlocked("heavyCharge")&&this.gm.canUseStamina(35)){this._startChargedAttack();return}if(this.input.dodge&&this.gm.canUseStamina($n.dodge)){this._startDodge();return}if(this.input.lightAttack&&this.gm.canUseStamina($n.lightAttack)){this._startAttack(!1);return}if(this.input.heavyAttack&&this.gm.canUseStamina($n.heavyAttack)){this._startAttack(!0);return}this.input.block&&this._changeState(Ie.BLOCKING)}_toggleLockOn(){if(!this.cameraController||!this.gm.enemyManager)return;const t=this.gm.enemyManager.enemies.filter(o=>!o.isDead);if(this.gm.enemyManager.boss&&!this.gm.enemyManager.boss.isDead&&t.push(this.gm.enemyManager.boss),t.length===0){this.cameraController.clearLockOn();return}const i=20,s=this.mesh.position,n=t.map(o=>({enemy:o,dist:s.distanceTo(o.mesh.position)})).filter(o=>o.dist<=i).sort((o,r)=>o.dist-r.dist);if(n.length===0){this.cameraController.clearLockOn();return}const a=this.cameraController.lockOnTarget;if(a&&!a.isDead){const o=n.findIndex(r=>r.enemy===a);if(o!==-1&&n.length>1){const r=(o+1)%n.length;this.cameraController.setLockOnTarget(n[r].enemy),this.gm.audioManager&&this.gm.audioManager.play("menuSelect",{volume:.3})}else this.cameraController.clearLockOn(),this.gm.audioManager&&this.gm.audioManager.play("menuBack",{volume:.3})}else this.cameraController.setLockOnTarget(n[0].enemy),this.gm.audioManager&&this.gm.audioManager.play("menuSelect",{volume:.4})}_startDodge(){this.gm.useStamina($n.dodge),this.gm.audioManager&&this.gm.audioManager.play("dodge",{position:this.mesh.position,volume:.5});const e=this.input.getMovementVector();if(e.x!==0||e.z!==0){const t=this._getCameraYaw(),i=new T(-Math.sin(t),0,-Math.cos(t)),s=new T(Math.cos(t),0,-Math.sin(t));this.dodgeDir.set(0,0,0).addScaledVector(i,-e.z).addScaledVector(s,e.x).normalize()}else this.dodgeDir.set(-Math.sin(this.facingAngle),0,-Math.cos(this.facingAngle));this.isInvincible=!0,this.lastGhostSpawnTime=0,this._flashDodgeStart(),this._changeState(Ie.DODGING)}_flashDodgeStart(){this._flashModel(65535,100)}_flashModel(e,t){if(this.gltfModel&&(this.gltfModel.traverse(i=>{i.isMesh&&i.material&&(Array.isArray(i.material)?i.material:[i.material]).forEach(n=>{n.emissive&&(n.emissive.setHex(e),n.emissiveIntensity=.5)})}),setTimeout(()=>{this.gltfModel.traverse(i=>{i.isMesh&&i.material&&(Array.isArray(i.material)?i.material:[i.material]).forEach(n=>{n.emissive&&(n.emissive.setHex(0),n.emissiveIntensity=0)})})},t)),this.visor&&this.visor.material&&this.visor.material.emissive){const i=this.visor.material.emissive.getHex();this.visor.material.emissive.setHex(e),this.visor.material.emissiveIntensity=8,setTimeout(()=>{this.visor?.material?.emissive&&(this.visor.material.emissive.setHex(i),this.visor.material.emissiveIntensity=3)},t)}}_spawnDodgeGhost(){const e=new ne,t=new B({color:4491519,transparent:!0,opacity:.4,depthWrite:!1});if(this.gltfModel)this.gltfModel.traverse(i=>{if(i.isMesh&&i.visible){const s=new w(i.geometry.clone(),t);s.position.copy(i.position),s.rotation.copy(i.rotation),s.scale.copy(i.scale),e.add(s)}});else{const i=new Pt(.35,.6,4,8),s=new w(i,t);s.position.y=1.1,e.add(s)}e.position.copy(this.mesh.position),e.rotation.y=this.mesh.rotation.y,this.scene.add(e),this.dodgeGhostMeshes.push({mesh:e,material:t,spawnTime:Date.now(),lifetime:200})}_updateDodgeGhosts(){const e=Date.now();for(let t=this.dodgeGhostMeshes.length-1;t>=0;t--){const i=this.dodgeGhostMeshes[t],s=e-i.spawnTime;if(s>i.lifetime)this.scene.remove(i.mesh),i.mesh.traverse(n=>{n.geometry&&n.geometry.dispose(),n.material&&n.material.dispose()}),this.dodgeGhostMeshes.splice(t,1);else{const n=s/i.lifetime;i.material.opacity=.4*(1-n)}}}_processDodge(e){const t=this.stateTimer/fi.dodgeDuration,i=Math.sin(t*Math.PI);this.mesh.position.addScaledVector(this.dodgeDir,this.dodgeSpeed*i*e),this._applyWallCollision(),this.lastGhostSpawnTime+=e,this.isInvincible&&this.lastGhostSpawnTime>=this.ghostSpawnInterval&&(this._spawnDodgeGhost(),this.lastGhostSpawnTime=0),this._updateDodgeGhosts(),this.stateTimer>=fi.dodgeIframes&&this.isInvincible&&(this.isInvincible=!1,this._flashDodgeEnd()),this.stateTimer>=fi.dodgeDuration&&(this.isInvincible=!1,this._changeState(Ie.IDLE))}_flashDodgeEnd(){this._flashModel(2236962,50)}_startAttack(e){const t=e?$n.heavyAttack:$n.lightAttack;this.gm.useStamina(t),this.hitThisSwing=!1,this.gm.audioManager&&this.gm.audioManager.play("swordSwing",{position:this.mesh.position,volume:.5,pitch:e?.8:1,variation:.1});const i=this._getCameraYaw();if(this.facingAngle=i,this.mesh.rotation.y=i+Math.PI,e?this._flashModel(16737826,200):this._flashModel(4491519,80),this.gm.particleManager){const s=new T(-Math.sin(i),0,-Math.cos(i));this.gm.particleManager.spawnAttackArc(this.mesh.position.clone(),s,e)}if(this.gm.attackAnimator){const s=this.gm.getAttackSpeedMultiplier?this.gm.getAttackSpeedMultiplier():1;this.gm.attackAnimator.startAttack(e?"heavy":"light",s)}this._changeState(e?Ie.HEAVY_ATTACKING:Ie.ATTACKING)}_processAttack(e){const t=this.state===Ie.HEAVY_ATTACKING,i=this.gm.getAttackSpeedMultiplier?this.gm.getAttackSpeedMultiplier():1,s=t?fi.heavyAttackDuration:fi.lightAttackDuration,n=t?fi.heavyHitStart:fi.lightHitStart,a=t?fi.heavyHitEnd:fi.lightHitEnd,o=s/i,r=n/i,c=a/i;if(this.stateTimer>=r&&this.stateTimer<c&&!this.hitThisSwing&&this._checkHit(t),!t&&this.stateTimer>o-fi.comboWindow/i&&this.stateTimer<o&&this.input.lightAttack&&this.gm.canUseStamina($n.lightAttack)){this.attackCombo=(this.attackCombo+1)%3,this._startAttack(!1);return}const h=new T(-Math.sin(this.facingAngle),0,-Math.cos(this.facingAngle));if(this.stateTimer<c){const d=this.stateTimer/c;if(t){const p=5*(1-Math.pow(d,.5)*.5);this.mesh.position.addScaledVector(h,p*e)}else{const p=4*(1-Math.sin(d*Math.PI*.5)*.3);this.mesh.position.addScaledVector(h,p*e)}this._applyWallCollision()}this.stateTimer>=o&&(this.attackCombo=0,this._changeState(Ie.IDLE))}_checkHit(e){const t=this.gm.getDamageMultiplier(),i=e?this.heavyDamage:this.lightDamage,s=this.gm.getEquipmentDamageBonus?this.gm.getEquipmentDamageBonus():0;let n=Math.floor((i+s)*t),a=!1;const o=this.gm.getEquipmentCritChance?this.gm.getEquipmentCritChance():0;if(o>0&&Math.random()*100<o){a=!0;const r=this.gm.getEquipmentCritDamage?this.gm.getEquipmentCritDamage():50;n=Math.floor(n*(1.5+r/100))}this.activeAttack={position:this.mesh.position.clone().add(new T(Math.sin(this.facingAngle),1,Math.cos(this.facingAngle)).multiplyScalar(1.2)),range:this.attackRange,damage:n,postureDmg:e?this.heavyPostureDmg:this.lightPostureDmg,isHeavy:e,isCrit:a}}_processBlock(e){this.input.block||this._changeState(Ie.IDLE);const t=this.input.getMovementVector();if(t.x!==0||t.z!==0){const i=this._getCameraYaw(),s=new T(-Math.sin(i),0,-Math.cos(i)),n=new T(Math.cos(i),0,-Math.sin(i)),a=new T().addScaledVector(s,-t.z).addScaledVector(n,t.x).normalize();this.mesh.position.addScaledVector(a,this.moveSpeed*.3*e)}}_startDash(){this.gm.useStamina(15),this.gm.useAbility("dash"),this.gm.audioManager&&this.gm.audioManager.play("dash",{position:this.mesh.position,volume:.6});const e=this.input.getMovementVector();if(e.x!==0||e.z!==0){const t=this._getCameraYaw(),i=new T(-Math.sin(t),0,-Math.cos(t)),s=new T(Math.cos(t),0,-Math.sin(t));this.dashDir.set(0,0,0).addScaledVector(i,-e.z).addScaledVector(s,e.x).normalize()}else this.dashDir.set(-Math.sin(this.facingAngle),0,-Math.cos(this.facingAngle));this.isInvincible=!0,this._flashModel(65416,150),this.gm.particleManager&&this.gm.particleManager.spawnDashEffect(this.mesh.position.clone(),this.dashDir),this._changeState(Ie.DASHING)}_processDash(e){const t=this.stateTimer/fi.dashDuration,i=Math.pow(1-t,.5);this.mesh.position.addScaledVector(this.dashDir,this.dashSpeed*i*e),this._applyWallCollision(),this.lastGhostSpawnTime+=e,this.lastGhostSpawnTime>=.04&&(this._spawnDodgeGhost(),this.lastGhostSpawnTime=0),this._updateDodgeGhosts(),this.stateTimer>=fi.dashIframes&&this.isInvincible&&(this.isInvincible=!1),this.stateTimer>=fi.dashDuration&&(this.isInvincible=!1,this._changeState(Ie.IDLE))}_startChargedAttack(){this.gm.useStamina(35),this.hitThisSwing=!1,this.gm.audioManager&&this.gm.audioManager.play("chargedSwing",{position:this.mesh.position,volume:.7,pitch:.7});const e=this._getCameraYaw();if(this.facingAngle=e,this.mesh.rotation.y=e+Math.PI,this._flashModel(16755200,200),this.gm.cameraController&&this.gm.cameraController.shakeHeavy(),this.gm.attackAnimator){const t=this.gm.getAttackSpeedMultiplier?this.gm.getAttackSpeedMultiplier():1;this.gm.attackAnimator.startAttack("heavy",t*.7)}this._changeState(Ie.CHARGED_ATTACKING)}_processChargedAttack(e){this.stateTimer>=fi.chargedHitStart&&this.stateTimer<fi.chargedHitEnd&&!this.hitThisSwing&&this._checkChargedHit();const t=new T(-Math.sin(this.facingAngle),0,-Math.cos(this.facingAngle));this.stateTimer<fi.chargedHitEnd&&(this.mesh.position.addScaledVector(t,5*e),this._applyWallCollision()),this.stateTimer>=fi.chargedAttackDuration&&this._changeState(Ie.IDLE)}_checkChargedHit(){const e=this.gm.getDamageMultiplier();this.activeAttack={position:this.mesh.position.clone().add(new T(Math.sin(this.facingAngle),1,Math.cos(this.facingAngle)).multiplyScalar(1.5)),range:this.attackRange*1.3,damage:Math.floor(this.chargedDamage*e),postureDmg:this.chargedPostureDmg,isHeavy:!0,isCharged:!0},this.gm.hitstopHeavy()}_startParry(){this.gm.useStamina(10),this.gm.useAbility("parry"),this.parrySuccessful=!1,this.gm.audioManager&&this.gm.audioManager.play("parryReady",{position:this.mesh.position,volume:.5}),this._flashModel(16777215,100),this._changeState(Ie.PARRYING)}_processParry(e){this.stateTimer>=fi.parryDuration&&(this.parrySuccessful?this._startRiposte():this._changeState(Ie.IDLE))}_startRiposte(){this.hitThisSwing=!1,this.gm.audioManager&&this.gm.audioManager.play("riposte",{volume:.8}),this._flashModel(16729156,150),this.activeAttack={position:this.mesh.position.clone().add(new T(Math.sin(this.facingAngle),1,Math.cos(this.facingAngle)).multiplyScalar(1.2)),range:this.attackRange,damage:this.chargedDamage*1.5,postureDmg:50,isHeavy:!0,isRiposte:!0},this.gm.hitstopHeavy(),this._changeState(Ie.ATTACKING)}onParrySuccess(){this.parrySuccessful=!0,this.gm.audioManager&&this.gm.audioManager.play("parrySuccess",{position:this.mesh.position,volume:.8}),this._flashModel(16768256,200),this.gm.triggerHitstop(.1),this.gm.particleManager&&this.gm.particleManager.spawnParryEffect(this.mesh.position.clone())}_startWarCry(){this.gm.useStamina(25),this.gm.useAbility("warCry"),this.gm.activateWarCry(),this._flashModel(16737792,300),this._changeState(Ie.WAR_CRYING)}_processWarCry(e){this.stateTimer>=fi.warCryDuration&&this._changeState(Ie.IDLE)}get isParrying(){return this.state===Ie.PARRYING&&this.stateTimer<fi.parryWindow}_changeState(e){this.state!==e&&((this.state===Ie.ATTACKING||this.state===Ie.HEAVY_ATTACKING||this.state===Ie.CHARGED_ATTACKING)&&(this.activeAttack=null,(e===Ie.STAGGERED||e===Ie.DEAD)&&this.gm.attackAnimator&&this.gm.attackAnimator.cancel()),this.state=e,this.stateTimer=0,this._playAnimation(e))}setCameraController(e){this.cameraController=e}setWorld(e){this.world=e;const t=this.mesh.position.x,i=this.mesh.position.z;if(e&&e.terrain){const r=e.terrain.chunkSize||64;if(e.terrain.forceGenerateAt)for(let c=-2;c<=2;c++)for(let h=-2;h<=2;h++)e.terrain.forceGenerateAt(t+c*r,i+h*r);e.terrain.update&&e.terrain.update(t,i)}const s=3,n=5;let a=-1/0;if(e&&e.terrain){const r=e.terrain.getHeightAt||e.terrain.getTerrainHeight;if(r)for(let c=-3;c<=3;c++)for(let h=-3;h<=3;h++){const d=r.call(e.terrain,t+c,i+h);!isNaN(d)&&isFinite(d)&&d>-100&&(a=Math.max(a,d))}}const o=a>-1/0?Math.max(a+s,n):n;console.log(`[Player] setWorld: maxTerrain=${a.toFixed(2)}, targetY=${o.toFixed(2)}`),this.mesh.position.y=o,this.velocity.y=0,this.grounded=!0,this._spawnSafetyFrames=180}_ensureSafeSpawnHeight(){if(!this.world){console.warn("[Player] No world reference, using fallback spawn height"),this.mesh.position.y=Math.max(this.mesh.position.y,50),this.velocity.y=0;return}this.world.terrain&&this.world.terrain.forceGenerateAt&&this.world.terrain.forceGenerateAt(this.mesh.position.x,this.mesh.position.z);let i=0,s=!1;if(this.world.terrain){const a=this.world.terrain.getHeightAt||this.world.terrain.getTerrainHeight;a&&(i=a.call(this.world.terrain,this.mesh.position.x,this.mesh.position.z),s=!isNaN(i)&&isFinite(i)&&i>-100)}const n=s?i+5:50;console.log(`[Player] Spawn height: Y=${n.toFixed(2)} (terrain=${i.toFixed(2)}, ready=${s})`),this.mesh.position.y=n,this.velocity.y=0,this.grounded=!0}_checkSpawnSafety(){if(this._spawnSafetyFrames<=0)return;this._spawnSafetyFrames--;const e=3,t=5;if(!this.world){this.mesh.position.y<t&&(this.mesh.position.y=t,this.velocity.y=0);return}this.world.terrain&&this.world.terrain.forceGenerateAt&&this.world.terrain.forceGenerateAt(this.mesh.position.x,this.mesh.position.z);let i=null;if(this.world.terrain){const n=this.world.terrain.getHeightAt||this.world.terrain.getTerrainHeight;if(n){const a=n.call(this.world.terrain,this.mesh.position.x,this.mesh.position.z);!isNaN(a)&&isFinite(a)&&a>-100&&(i=a)}}let s;i!==null?s=i+e:s=t,this.mesh.position.y<s&&(this.mesh.position.y=s,this.velocity.y=0,this.grounded=!0)}recalculateSafeSpawn(){this._ensureSafeSpawnHeight()}_getCameraYaw(){return this.cameraController?this.cameraController.yaw:0}resetPosition(){this.mesh.position.copy(this.gm.checkpoint),this.velocity.set(0,0,0),this._changeState(Ie.IDLE)}get isBlocking(){return this.state===Ie.BLOCKING}get isAttacking(){return this.state===Ie.ATTACKING||this.state===Ie.HEAVY_ATTACKING}get isDead(){return this.state===Ie.DEAD}flashDamage(){this._flashModel(6684672,150)}}const Bl={CRYPT_LORDS_GREATSWORD:{id:"crypt-lords-greatsword",name:"Crypt Lord's Greatsword",type:"weapon",description:"A massive blade once wielded by the guardian of the ritual chamber. Purple energy crackles through cracks in the metal.",stats:{damage:65,scaling:{strength:"A",dexterity:"D"},weight:12,criticalDamage:110},special:"Charged R2 releases purple shockwave (consumes 20 extra stamina)",color:6693546,lightColor:8930508,canInfuse:!1},LORD_SOUL_FRAGMENT:{id:"lord-soul-fragment",name:"Lord Soul Fragment",type:"upgrade",description:"A fragment of the soul that sought godhood. Can be used at the crucible to grant +2 to any single stat track.",stats:{infusionBonus:2},color:16729343,lightColor:16738047,lore:"What rises from the ritual circle was never meant to die. It was meant to ascend."}};class i1{constructor(e,t){this.scene=e,this.gm=t,this.items=[],this.inventory={keys:new Set,weapons:[],upgrades:[]},this.bossesDefeated=new Set,this.notificationEl=document.getElementById("item-notification"),this.victoryNotificationEl=document.getElementById("victory-notification")}initItems(e){e.forEach((t,i)=>{this.spawnItem(t.pos,t.type,t)})}spawnItem(e,t,i={}){const s={id:`item-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:t,position:e.clone(),collected:!1,mesh:null,light:null,...i};switch(t){case"remnant":this._createRemnantVisual(s);break;case"key":this._createKeyVisual(s);break;case"boss_remnant":this._createBossRemnantVisual(s);break;case"boss_weapon":this._createBossWeaponVisual(s);break;case"boss_upgrade":this._createBossUpgradeVisual(s);break;default:this._createGenericVisual(s)}return this.items.push(s),s}_createRemnantVisual(e){const t=new re(.15,12,12),i=new X({color:8978346,emissive:4500070,emissiveIntensity:.8,transparent:!0,opacity:.9});e.mesh=new w(t,i),e.mesh.position.copy(e.position),e.mesh.castShadow=!0,this.scene.add(e.mesh),e.light=new We(8978346,.8,4),e.light.position.copy(e.position),this.scene.add(e.light);const s=e.position.y,n=()=>{e.collected||(requestAnimationFrame(n),e.mesh.position.y=s+Math.sin(Date.now()*.003)*.15,e.mesh.rotation.y+=.02,e.light.position.y=e.mesh.position.y,e.light.intensity=.6+Math.sin(Date.now()*.005)*.3)};n()}_createKeyVisual(e){const t=new ne,i=new Ai(.12,.03,8,16),s=new X({color:13412932,emissive:6702114,emissiveIntensity:.5,metalness:.8,roughness:.3}),n=new w(i,s);n.rotation.x=Math.PI/2,t.add(n);const a=new ie(.04,.25,.02),o=new w(a,s);o.position.y=-.18,t.add(o);const r=new ie(.08,.04,.02),c=new w(r,s);c.position.set(.04,-.25,0),t.add(c);const h=new w(r,s);h.position.set(.04,-.32,0),t.add(h),t.position.copy(e.position),e.mesh=t,this.scene.add(t),e.light=new We(16755268,1,5),e.light.position.copy(e.position),this.scene.add(e.light);const d=e.position.y,u=()=>{e.collected||(requestAnimationFrame(u),e.mesh.position.y=d+Math.sin(Date.now()*.003)*.1,e.mesh.rotation.y+=.015,e.light.position.y=e.mesh.position.y,e.light.intensity=.8+Math.sin(Date.now()*.004)*.3)};u()}_createGenericVisual(e){const t=new Ji(.15),i=new X({color:11184895,emissive:4474026,emissiveIntensity:.5});e.mesh=new w(t,i),e.mesh.position.copy(e.position),this.scene.add(e.mesh);const s=e.position.y,n=()=>{e.collected||(requestAnimationFrame(n),e.mesh.position.y=s+Math.sin(Date.now()*.003)*.1,e.mesh.rotation.y+=.02,e.mesh.rotation.x+=.01)};n()}_createBossRemnantVisual(e){const t=new re(.4,24,24),i=new X({color:16768358,emissive:16755234,emissiveIntensity:1.2,transparent:!0,opacity:.95});e.mesh=new w(t,i),e.mesh.position.copy(e.position),e.mesh.castShadow=!0,this.scene.add(e.mesh);const s=new re(.2,16,16),n=new B({color:16777215,transparent:!0,opacity:.9}),a=new w(s,n);e.mesh.add(a),e.light=new We(16768358,2.5,8),e.light.position.copy(e.position),this.scene.add(e.light);const o=e.position.y,r=()=>{if(e.collected)return;requestAnimationFrame(r);const c=Date.now()*.002;e.mesh.position.y=o+Math.sin(c)*.2,e.mesh.rotation.y+=.025;const h=1+Math.sin(c*2)*.08;e.mesh.scale.setScalar(h),e.light.position.y=e.mesh.position.y,e.light.intensity=2+Math.sin(c*2)*.8};r()}_createBossWeaponVisual(e){const t=new ne,i=e.itemDef||Bl.CRYPT_LORDS_GREATSWORD,s=new ie(.12,1.2,.03),n=new X({color:5592422,emissive:i.color,emissiveIntensity:.4,metalness:.9,roughness:.2}),a=new w(s,n);a.position.y=.6,t.add(a);const o=new ie(.02,.8,.04),r=new B({color:i.lightColor,transparent:!0,opacity:.9}),c=new w(o,r);c.position.set(.03,.5,0),c.rotation.z=.15,t.add(c);const h=new w(o,r);h.position.set(-.02,.7,0),h.rotation.z=-.1,t.add(h);const d=new ie(.35,.06,.06),u=new X({color:3355460,metalness:.8,roughness:.3}),p=new w(d,u);p.position.y=0,t.add(p);const f=new ce(.03,.035,.3,8),y=new X({color:4465186,roughness:.8}),m=new w(f,y);m.position.y=-.18,t.add(m);const g=new re(.05,8,8),x=new X({color:i.color,emissive:i.color,emissiveIntensity:.6}),v=new w(g,x);v.position.y=-.35,t.add(v),t.position.copy(e.position),t.rotation.z=Math.PI/6,e.mesh=t,this.scene.add(t),e.light=new We(i.lightColor,1.5,6),e.light.position.copy(e.position),this.scene.add(e.light);const b=e.position.y,_=()=>{if(e.collected)return;requestAnimationFrame(_);const S=Date.now()*.001;e.mesh.position.y=b+Math.sin(S*2)*.12,e.mesh.rotation.y+=.015;const A=.6+Math.sin(S*4)*.3;r.opacity=A,e.light.position.y=e.mesh.position.y,e.light.intensity=1.2+Math.sin(S*3)*.5};_()}_createBossUpgradeVisual(e){const t=e.itemDef||Bl.LORD_SOUL_FRAGMENT,i=new ne,s=new Ji(.25),n=new X({color:t.color,emissive:t.color,emissiveIntensity:1,transparent:!0,opacity:.85,metalness:.3,roughness:.1}),a=new w(s,n);i.add(a);const o=5,r=[];for(let d=0;d<o;d++){const u=new re(.04,8,8),p=new B({color:16777215,transparent:!0,opacity:.8}),f=new w(u,p);f.userData.orbitAngle=Math.PI*2*d/o,f.userData.orbitRadius=.35+Math.random()*.1,f.userData.orbitSpeed=2+Math.random(),r.push(f),i.add(f)}i.position.copy(e.position),e.mesh=i,this.scene.add(i),e.light=new We(t.lightColor,2,7),e.light.position.copy(e.position),this.scene.add(e.light);const c=e.position.y,h=()=>{if(e.collected)return;requestAnimationFrame(h);const d=Date.now()*.001;e.mesh.position.y=c+Math.sin(d*1.5)*.15,a.rotation.y+=.02,a.rotation.x=Math.sin(d)*.2,r.forEach(u=>{const p=u.userData.orbitAngle+d*u.userData.orbitSpeed;u.position.x=Math.cos(p)*u.userData.orbitRadius,u.position.z=Math.sin(p)*u.userData.orbitRadius,u.position.y=Math.sin(p*2)*.1}),e.light.position.y=e.mesh.position.y,e.light.intensity=1.5+Math.sin(d*2)*.7};h()}spawnBossRewards(e,t,i,s){if(this.bossesDefeated.has(t))return;this.bossesDefeated.add(t);const n=e.clone();n.y+=.5,this.spawnItem(n,"boss_remnant",{value:i,name:`${i} Remnant`});const a=e.clone();a.x+=.8,a.y+=.8;const o=s.type==="weapon"?"boss_weapon":"boss_upgrade";this.spawnItem(a,o,{itemDef:s,name:s.name,description:s.description})}showVictoryNotification(e){let t=this.victoryNotificationEl;t||(t=document.getElementById("victory-notification")),t||(t=document.createElement("div"),t.id="victory-notification-temp",t.style.cssText=`
        position: fixed;
        top: 35%;
        left: 50%;
        transform: translateX(-50%);
        font-family: 'Cinzel', serif;
        font-size: 3em;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 0 0 30px #ffa500, 0 0 60px #ff6600, 2px 2px 4px #000;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        opacity: 0;
        transition: opacity 0.8s ease-in;
        z-index: 1000;
        pointer-events: none;
        text-align: center;
      `,document.body.appendChild(t)),t.innerHTML=`<span style="display:block;font-size:0.4em;color:#aaa;margin-bottom:0.3em">GREAT FOE VANQUISHED</span>${e}`,t.style.opacity="0",setTimeout(()=>{t.style.opacity="1"},100),setTimeout(()=>{t.style.opacity="0"},4500),t.id==="victory-notification-temp"&&setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},6e3)}update(e){for(const i of this.items){if(i.collected)continue;e.distanceTo(i.position)<1.5&&this.collectItem(i)}}collectItem(e){if(e.collected)return;e.collected=!0,e.mesh&&this.scene.remove(e.mesh),e.light&&this.scene.remove(e.light),this.gm.audioManager&&this.gm.audioManager.play("itemPickup",{position:e.position,volume:.6});let t="";switch(e.type){case"remnant":this.gm.addRemnant(e.value),t=`+${e.value} Remnant`;break;case"boss_remnant":this.gm.addRemnant(e.value),t=`+${e.value} Remnant`,this.gm.audioManager&&this.gm.audioManager.play("menuConfirm",{volume:.8});break;case"key":this.inventory.keys.add(e.keyId),t=`Got ${e.name}`;break;case"boss_weapon":this.inventory.weapons.push(e.itemDef||e),t=`Obtained: ${e.name}`,this.gm.audioManager&&this.gm.audioManager.play("menuConfirm",{volume:1});break;case"boss_upgrade":this.inventory.upgrades.push(e.itemDef||e),t=`Obtained: ${e.name}`,this.gm.audioManager&&this.gm.audioManager.play("menuConfirm",{volume:1});break;default:t="Item collected"}this.showNotification(t)}showNotification(e){this.notificationEl&&(this.notificationEl.textContent=e,this.notificationEl.classList.add("visible"),setTimeout(()=>{this.notificationEl.classList.remove("visible")},2e3))}hasKey(e){return this.inventory.keys.has(e)}resetItems(){}}const zl={standard:{body:6974050,accent:5918792,glow:16724787,corruption:4868674},berserker:{body:6959152,accent:8926003,glow:16737792,corruption:4198416},revenant:{body:11180666,accent:8022618,glow:4521796,corruption:5918784},ranged:{body:5925466,accent:4872778,glow:8978244,corruption:3820090},sentinel:{body:5921386,accent:4868693,glow:4474111,corruption:3816005},elite:{body:4859173,accent:3806485,glow:16729088,corruption:2756624},boss:{body:3809344,accent:2758704,glow:16720418,corruption:1708064,secondary:5906528}};function pr(l={}){const{type:e="standard",scale:t=1,palette:i=null}=l,s=i||zl[e]||zl.standard,n=new ne,a=new B({color:s.body}),o=new Pt(.4,.4,8,16),r=new w(o,a);r.position.set(0,.9,.1),r.rotation.x=.2,r.scale.set(1.2,.9,1),r.castShadow=!0,n.add(r);const c=new re(.35,12,8),h=new w(c,a);h.position.set(0,1.3,.15),h.scale.set(1.3,.8,1.1),h.castShadow=!0,n.add(h);const d=new B({color:s.accent}),u=new re(.2,12,10),p=new w(u,d);p.position.set(0,1.5,.25),p.scale.set(1,.85,.9),p.castShadow=!0,n.add(p);const f=new B({color:s.glow}),y=new re(.05,8,6),m=new w(y,f);m.position.set(-.08,1.55,.4),n.add(m);const g=new w(y,f);g.position.set(.08,1.55,.4),n.add(g);const x=new We(s.glow,.5,2);x.position.set(0,1.55,.45),n.add(x),n.userData.eyes=[m,g],n.userData.eyeLight=x,n.userData.eyeMaterial=f,n.userData.eyeBaseColor=new H(s.glow);const v=new B({color:s.body}),b=new Pt(.1,.35,6,10),_=new w(b,v);_.position.set(-.5,1,.1),_.rotation.z=.3,_.rotation.x=.2,_.castShadow=!0,n.add(_);const S=new w(b,v);S.position.set(.5,1,.1),S.rotation.z=-.3,S.rotation.x=.2,S.castShadow=!0,n.add(S);const A=new Pt(.08,.4,6,10),R=new w(A,v);R.position.set(-.65,.5,.15),R.rotation.z=.15,R.castShadow=!0,n.add(R);const M=new w(A,v);M.position.set(.65,.5,.15),M.rotation.z=-.15,M.castShadow=!0,n.add(M);const C=new re(.08,8,6),k=new B({color:s.corruption}),L=new w(C,k);L.position.set(-.7,.15,.2),L.scale.set(1.2,.8,1.5),L.castShadow=!0,n.add(L);const O=new w(C,k);O.position.set(.7,.15,.2),O.scale.set(1.2,.8,1.5),O.castShadow=!0,n.add(O);const W=new Pt(.12,.3,6,10),U=new w(W,v);U.position.set(-.2,.35,0),U.rotation.x=-.15,U.castShadow=!0,n.add(U);const $=new w(W,v);$.position.set(.2,.35,0),$.rotation.x=-.15,$.castShadow=!0,n.add($);const G=new ie(.15,.08,.25),ee=new w(G,k);ee.position.set(-.2,.04,.05),ee.castShadow=!0,n.add(ee);const pe=new w(G,k);return pe.position.set(.2,.04,.05),pe.castShadow=!0,n.add(pe),s1(n,s),n.userData.particles=Hm(s.glow),n.add(n.userData.particles),n.scale.setScalar(t),n.userData.bodyMaterial=a,n.userData.limbMaterial=v,n.userData.type=e,n.userData.isEnemyModel=!0,n}function s1(l,e){const t=new B({color:e.corruption}),i=new wt(.06,.2,5);[{x:0,y:1.4,z:-.1,rot:-.4},{x:.1,y:1.3,z:-.05,rot:-.3},{x:-.1,y:1.3,z:-.05,rot:-.3},{x:0,y:1.2,z:0,rot:-.2},{x:.15,y:1.15,z:.05,rot:-.15},{x:-.15,y:1.15,z:.05,rot:-.15}].forEach(n=>{const a=new w(i,t);a.position.set(n.x,n.y,n.z),a.rotation.x=n.rot,a.castShadow=!0,l.add(a)})}function Hm(l){const t=new Float32Array(60),i=new Float32Array(60),s=new H(l);for(let r=0;r<20;r++)t[r*3]=(Math.random()-.5)*.8,t[r*3+1]=Math.random()*1.5+.3,t[r*3+2]=(Math.random()-.5)*.6,i[r*3]=s.r*(.8+Math.random()*.4),i[r*3+1]=s.g*(.8+Math.random()*.4),i[r*3+2]=s.b*(.8+Math.random()*.4);const n=new mt;n.setAttribute("position",new Je(t,3)),n.setAttribute("color",new Je(i,3));const a=new Ri({size:.08,vertexColors:!0,transparent:!0,opacity:.6,blending:ui,depthWrite:!1}),o=new Bi(n,a);return o.userData.time=0,o.userData.basePositions=t.slice(),o}function n1(l={}){const e=pr({...l,type:"elite",scale:(l.scale||1)*1.3}),t=new B({color:2760736}),i=new ie(.25,.15,.2),s=new w(i,t);s.position.set(-.45,1.25,.1),s.rotation.z=.3,s.castShadow=!0,e.add(s);const n=new w(i,t);n.position.set(.45,1.25,.1),n.rotation.z=-.3,n.castShadow=!0,e.add(n);const a=new B({color:1706506}),o=new wt(.1,.4,5),r=new w(o,a);return r.position.set(0,1.5,-.15),r.rotation.x=-.5,r.castShadow=!0,e.add(r),e.userData.isElite=!0,e}function a1(l={}){const e=pr({...l,type:"berserker",scale:(l.scale||1)*.95});e.userData.eyeBaseColor&&e.userData.eyeBaseColor.multiplyScalar(1.5);const t=new B({color:2099208}),i=new wt(.03,.15,4);return[-.7,.7].forEach(s=>{for(let n=-1;n<=1;n++){const a=new w(i,t);a.position.set(s+n*.04*Math.sign(s),.08,.25+Math.abs(n)*.02),a.rotation.x=.3,a.castShadow=!0,e.add(a)}}),e.userData.isBerserker=!0,e}function o1(l={}){const e=pr({...l,type:"revenant",scale:(l.scale||1)*.9});e.traverse(s=>{s.isMesh&&s.geometry?.type?.includes("Capsule")&&(s.scale.x*=.7,s.scale.z*=.7)});const t=new B({color:6969930}),i=new Pt(.02,.2,4,6);for(let s=0;s<4;s++){const n=.7+s*.15,a=new w(i,t);a.position.set(-.25,n,.15),a.rotation.z=.8,a.rotation.y=.2,e.add(a);const o=new w(i,t);o.position.set(.25,n,.15),o.rotation.z=-.8,o.rotation.y=-.2,e.add(o)}return e.userData.isRevenant=!0,e}function r1(l={}){const e=pr({...l,type:"sentinel",scale:(l.scale||1)*1.2}),t=new B({color:3816010}),i=new ie(.4,.5,.1),s=new w(i,t);s.position.set(-.8,.6,.2),s.rotation.y=.3,s.castShadow=!0,e.add(s);const n=new B({color:2763317}),a=new ie(.5,.4,.12),o=new w(a,n);return o.position.set(0,.95,.25),o.castShadow=!0,e.add(o),e.userData.isSentinel=!0,e}function l1(l={}){const e=zl.ranged,t=(l.scale||1)*.85,i=new ne,s=new B({color:e.body}),n=new Pt(.25,.5,8,16),a=new w(n,s);a.position.set(0,1,0),a.scale.set(.8,1.1,.7),a.castShadow=!0,i.add(a);const o=new B({color:e.accent}),r=new re(.18,12,10),c=new w(r,o);c.position.set(0,1.6,.15),c.scale.set(.9,1.2,.85),c.castShadow=!0,i.add(c);const h=new B({color:e.glow}),d=new re(.04,8,6),u=new w(d,h);u.position.set(-.06,1.65,.28),i.add(u);const p=new w(d,h);p.position.set(.06,1.65,.28),i.add(p);const f=new We(e.glow,.4,2);f.position.set(0,1.65,.3),i.add(f),i.userData.eyes=[u,p],i.userData.eyeLight=f,i.userData.eyeMaterial=h,i.userData.eyeBaseColor=new H(e.glow);const y=new B({color:e.body}),m=new Pt(.06,.35,6,10),g=new w(m,y);g.position.set(-.3,1.1,0),g.rotation.z=.4,g.rotation.x=.3,g.castShadow=!0,i.add(g);const x=new w(m,y);x.position.set(.3,1.1,0),x.rotation.z=-.4,x.rotation.x=.3,x.castShadow=!0,i.add(x);const v=new Pt(.05,.5,6,10),b=new w(v,y);b.position.set(-.5,.55,.1),b.rotation.z=.2,b.rotation.x=.4,b.castShadow=!0,i.add(b);const _=new w(v,y);_.position.set(.5,.55,.1),_.rotation.z=-.2,_.rotation.x=.4,_.castShadow=!0,i.add(_);const S=new B({color:e.corruption}),A=new ce(.06,.03,.15,8),R=new w(A,S);R.position.set(-.58,.15,.2),R.rotation.x=.5,R.rotation.z=.2,R.castShadow=!0,i.add(R);const M=new w(A,S);M.position.set(.58,.15,.2),M.rotation.x=.5,M.rotation.z=-.2,M.castShadow=!0,i.add(M);const C=new B({color:e.glow,transparent:!0,opacity:.8}),k=new re(.04,8,6),L=new w(k,C);L.position.set(-.6,.08,.25),i.add(L);const O=new w(k,C);O.position.set(.6,.08,.25),i.add(O),i.userData.projectileOrbs=[L,O];const W=new Pt(.07,.3,6,10),U=new w(W,y);U.position.set(-.15,.4,0),U.rotation.x=.15,U.castShadow=!0,i.add(U);const $=new w(W,y);$.position.set(.15,.4,0),$.rotation.x=.15,$.castShadow=!0,i.add($);const G=new Pt(.05,.25,6,10),ee=new w(G,y);ee.position.set(-.15,.12,.1),ee.rotation.x=-.4,ee.castShadow=!0,i.add(ee);const pe=new w(G,y);pe.position.set(.15,.12,.1),pe.rotation.x=-.4,pe.castShadow=!0,i.add(pe);const me=new ie(.1,.05,.2),ve=new B({color:e.corruption}),tt=new w(me,ve);tt.position.set(-.15,.025,.15),tt.castShadow=!0,i.add(tt);const je=new w(me,ve);je.position.set(.15,.025,.15),je.castShadow=!0,i.add(je);const Ot=new B({color:e.glow,transparent:!0,opacity:.6}),Nt=new Pt(.02,.25,4,6);for(let Z=0;Z<4;Z++){const se=new w(Nt,Ot),Pe=Z/4*Math.PI*.6-Math.PI*.3;se.position.set(Math.sin(Pe)*.3,.8+Z*.15,-.2),se.rotation.x=-.5+Math.random()*.3,se.rotation.z=Math.sin(Pe)*.3,i.add(se)}return i.userData.particles=Hm(e.glow),i.add(i.userData.particles),i.scale.setScalar(t),i.userData.bodyMaterial=s,i.userData.limbMaterial=y,i.userData.type="ranged",i.userData.isEnemyModel=!0,i.userData.isRanged=!0,i}function c1(l={}){const e=zl.boss,t=(l.scale||1)*1.8,i=new ne,s=new B({color:e.body}),n=new Pt(.5,.6,10,20),a=new w(n,s);a.position.set(0,1,0),a.scale.set(1.4,1,1.1),a.castShadow=!0,i.add(a);const o=new re(.45,12,10),r=new w(o,s);r.position.set(0,1.4,.05),r.scale.set(1.3,.9,1),r.castShadow=!0,i.add(r);const c=new B({color:1710629}),h=new B({color:2759216}),d=new ie(.7,.5,.15),u=new w(d,h);u.position.set(0,1.35,.35),u.castShadow=!0,i.add(u);const p=new re(.25,10,8),f=new w(p,c);f.position.set(-.6,1.55,0),f.scale.set(1.2,.9,1),f.castShadow=!0,i.add(f);const y=new w(p,c);y.position.set(.6,1.55,0),y.scale.set(1.2,.9,1),y.castShadow=!0,i.add(y);const m=new wt(.08,.3,5),g=new B({color:e.corruption});[[-.7,1.7,0],[.7,1.7,0],[-.5,1.75,-.1],[.5,1.75,-.1]].forEach(N=>{const Y=new w(m,g);Y.position.set(...N),Y.rotation.x=-.3,Y.castShadow=!0,i.add(Y)});const x=new B({color:e.accent}),v=new re(.22,12,10),b=new w(v,x);b.position.set(0,1.85,.1),b.scale.set(1,1.1,.95),b.castShadow=!0,i.add(b);const _=new B({color:2759184}),S=new w(new Ai(.18,.03,8,16),_);S.position.set(0,2.05,.05),S.rotation.x=Math.PI/2,i.add(S);const A=new wt(.04,.18,4);for(let N=0;N<5;N++){const Y=N/5*Math.PI*2,te=new w(A,_);te.position.set(Math.sin(Y)*.17,2.12,Math.cos(Y)*.15+.05),te.rotation.z=Math.sin(Y)*.2,i.add(te)}const R=new B({color:e.glow}),M=new re(.05,8,6),C=new w(M,R);C.position.set(-.08,1.9,.25),i.add(C);const k=new w(M,R);k.position.set(.08,1.9,.25),i.add(k);const L=new We(e.glow,1,4);L.position.set(0,1.9,.3),i.add(L),i.userData.eyes=[C,k],i.userData.eyeLight=L,i.userData.eyeMaterial=R,i.userData.eyeBaseColor=new H(e.glow);const O=new B({color:e.secondary||2756656,side:lt}),W=new Dt(1,1.2,8,12),U=W.attributes.position;for(let N=0;N<U.count;N++){const Y=U.getY(N),te=U.getX(N);U.setZ(N,-.1-Y*.15-Math.abs(te)*.1)}W.computeVertexNormals();const $=new w(W,O);$.position.set(0,1,-.35),$.rotation.x=.1,$.castShadow=!0,i.add($),i.userData.cape=$;const G=new B({color:e.body}),ee=new Pt(.14,.4,8,12),pe=new w(ee,G);pe.position.set(-.55,1.3,0),pe.rotation.z=.35,pe.castShadow=!0,i.add(pe);const me=new w(ee,G);me.position.set(.55,1.3,0),me.rotation.z=-.35,me.castShadow=!0,i.add(me);const ve=new Pt(.11,.45,8,12),tt=new w(ve,G);tt.position.set(-.75,.7,.1),tt.rotation.z=.15,tt.castShadow=!0,i.add(tt);const je=new w(ve,G);je.position.set(.75,.7,.1),je.rotation.z=-.15,je.castShadow=!0,i.add(je);const Ot=new B({color:1710624}),Nt=new re(.12,10,8),Z=new w(Nt,Ot);Z.position.set(-.8,.3,.15),Z.scale.set(1.1,.9,1.2),Z.castShadow=!0,i.add(Z);const se=new w(Nt,Ot);se.position.set(.8,.3,.15),se.scale.set(1.1,.9,1.2),se.castShadow=!0,i.add(se);const Pe=new Pt(.15,.45,8,12),Ze=new w(Pe,G);Ze.position.set(-.25,.45,0),Ze.castShadow=!0,i.add(Ze);const Le=new w(Pe,G);Le.position.set(.25,.45,0),Le.castShadow=!0,i.add(Le);const Ct=new ie(.2,.12,.3),Bt=new w(Ct,c);Bt.position.set(-.25,.06,.05),Bt.castShadow=!0,i.add(Bt);const ht=new w(Ct,c);ht.position.set(.25,.06,.05),ht.castShadow=!0,i.add(ht);const J=new ne,he=new B({color:3816005}),oe=new ie(.08,1.4,.02),Se=new w(oe,he);Se.position.y=.7,J.add(Se);const D=new wt(.04,.2,4),Ke=new w(D,he);Ke.position.y=1.45,J.add(Ke);const Ae=new B({color:2759189}),et=new ce(.03,.035,.25,8),ge=new w(et,Ae);ge.position.y=-.12,J.add(ge);const P=new ie(.25,.04,.06),E=new w(P,Ae);return E.position.y=.02,J.add(E),J.position.set(.85,.6,.2),J.rotation.z=-.3,i.add(J),i.userData.sword=J,i.userData.particles=h1(e.glow),i.add(i.userData.particles),i.scale.setScalar(t),i.userData.bodyMaterial=s,i.userData.limbMaterial=G,i.userData.type="boss",i.userData.isEnemyModel=!0,i.userData.isBoss=!0,i}function h1(l){const t=new Float32Array(120),i=new Float32Array(120),s=new H(l);for(let r=0;r<40;r++)t[r*3]=(Math.random()-.5)*1.2,t[r*3+1]=Math.random()*2+.3,t[r*3+2]=(Math.random()-.5)*1,i[r*3]=s.r*(.7+Math.random()*.5),i[r*3+1]=s.g*(.7+Math.random()*.5),i[r*3+2]=s.b*(.7+Math.random()*.5);const n=new mt;n.setAttribute("position",new Je(t,3)),n.setAttribute("color",new Je(i,3));const a=new Ri({size:.12,vertexColors:!0,transparent:!0,opacity:.7,blending:ui,depthWrite:!1}),o=new Bi(n,a);return o.userData.time=0,o.userData.basePositions=t.slice(),o}function d1(l,e){if(l.userData.isEnemyModel){if(l.userData.particles){const t=l.userData.particles;t.userData.time+=e;const i=t.geometry.attributes.position.array,s=t.userData.basePositions,n=t.userData.time;for(let a=0;a<i.length/3;a++){const o=a*.5;i[a*3]=s[a*3]+Math.sin(n*2+o)*.1,i[a*3+1]=s[a*3+1]+(n*.5+o)%1.5,i[a*3+2]=s[a*3+2]+Math.cos(n*2+o)*.1,i[a*3+1]>2&&(i[a*3+1]=s[a*3+1])}t.geometry.attributes.position.needsUpdate=!0}if(l.userData.eyeMaterial&&l.userData.eyeBaseColor){const t=.7+Math.sin(Date.now()*.003)*.3;l.userData.eyeMaterial.color.copy(l.userData.eyeBaseColor).multiplyScalar(t)}if(l.userData.eyeLight){const t=.4+Math.sin(Date.now()*.003)*.2;l.userData.eyeLight.intensity=t}}}function u1(l,e=16711680,t=150){if(!l.userData.isEnemyModel)return;const i=new H(e);l.traverse(s=>{if(s.isMesh&&s.material&&s.material.color){const n=s.material.color.clone();s.material.color.copy(i),setTimeout(()=>{s.material&&s.material.color.copy(n)},t)}})}const q={IDLE:"idle",PATROL:"patrol",CHASE:"chase",CIRCLE:"circle",RETREAT:"retreat",FLANK:"flank",ATTACK:"attack",STAGGERED:"staggered",DEAD:"dead",DORMANT:"dormant",RISING:"rising",BOSS_SLAM:"boss_slam",BOSS_SWEEP:"boss_sweep",BOSS_COMBO:"boss_combo",BOSS_CHARGE:"boss_charge",BOSS_GRAB:"boss_grab",BOSS_TRANSITION:"boss_transition",BOSS_SUMMON:"boss_summon",BOSS_AOE:"boss_aoe",BOSS_PROJECTILE:"boss_projectile"},Xt={NORMAL:"normal",QUICK_JAB:"quick_jab",HEAVY:"heavy",COMBO:"combo"},Jr={[Xt.NORMAL]:{windupMult:1,damageMult:1,postureMult:1,cooldownMult:1,rangeMult:1,tell:"normal"},[Xt.QUICK_JAB]:{windupMult:.5,damageMult:.6,postureMult:.5,cooldownMult:.7,rangeMult:.85,tell:"jab"},[Xt.HEAVY]:{windupMult:1.8,damageMult:1.6,postureMult:2,cooldownMult:1.5,rangeMult:1.2,tell:"heavy"},[Xt.COMBO]:{windupMult:.7,damageMult:.5,postureMult:.6,cooldownMult:.4,rangeMult:1,tell:"combo"}},p1={[q.IDLE]:"Idle",[q.PATROL]:"Walking",[q.CHASE]:"Running",[q.CIRCLE]:"Walking",[q.RETREAT]:"Walking",[q.FLANK]:"Walking",[q.ATTACK]:"Punch",[q.STAGGERED]:"No",[q.DEAD]:"Death",[q.DORMANT]:"Idle",[q.RISING]:"ThumbsUp",[q.BOSS_SLAM]:"Punch",[q.BOSS_SWEEP]:"Punch",[q.BOSS_COMBO]:"Punch",[q.BOSS_CHARGE]:"Running",[q.BOSS_GRAB]:"Punch",[q.BOSS_TRANSITION]:"No",[q.BOSS_SUMMON]:"ThumbsUp",[q.BOSS_AOE]:"Punch",[q.BOSS_PROJECTILE]:"Punch"},Fl={HOLLOW_SOLDIER:{name:"Hollow Soldier",health:50,damage:15,postureDmg:15,moveSpeed:2.5,detectionRange:10,attackRange:2.2,attackCooldown:1.5,attackWindup:.5,attackDuration:.2,remnantDrop:40,patrolRadius:3,bodyColor:4860458,eyeColor:16724787,canChainAttacks:!1,maxPosture:60,hasShield:!1,canRetreat:!1,attackVariety:{enabled:!0,heavyChance:.2,quickJabChance:.3,comboEnabled:!1},proceduralModel:"standard",modelScale:1,animSpeedMult:1},BERSERKER:{name:"Berserker",health:35,damage:20,postureDmg:10,moveSpeed:4,detectionRange:12,attackRange:2,attackCooldown:.8,attackWindup:.3,attackDuration:.15,remnantDrop:60,patrolRadius:5,bodyColor:6693410,eyeColor:16737792,canChainAttacks:!0,maxChainAttacks:3,maxPosture:40,hasShield:!1,canRetreat:!1,canFlank:!0,attackVariety:{enabled:!0,heavyChance:.05,quickJabChance:.5,comboEnabled:!0,comboChance:.4,maxComboHits:3},proceduralModel:"berserker",modelScale:.95,animSpeedMult:1.5},SENTINEL:{name:"Sentinel",health:100,damage:30,postureDmg:25,moveSpeed:1.5,detectionRange:8,attackRange:2.5,attackCooldown:2.5,attackWindup:.8,attackDuration:.3,remnantDrop:100,patrolRadius:2,bodyColor:3355460,eyeColor:4474111,canChainAttacks:!1,maxPosture:100,hasShield:!0,shieldBlockChance:.4,canRetreat:!1,attackVariety:{enabled:!0,heavyChance:.6,quickJabChance:.15,comboEnabled:!1},proceduralModel:"sentinel",modelScale:1.2,animSpeedMult:.8},CRYPT_GUARDIAN:{name:"Crypt Guardian",health:200,damage:40,postureDmg:30,moveSpeed:1.8,detectionRange:12,attackRange:3,attackCooldown:2,attackWindup:.6,attackDuration:.4,remnantDrop:500,patrolRadius:3,bodyColor:1710634,eyeColor:16720418,canChainAttacks:!0,maxChainAttacks:2,maxPosture:150,hasShield:!1,isElite:!0,canRetreat:!1,attackVariety:{enabled:!0,heavyChance:.35,quickJabChance:.25,comboEnabled:!0,comboChance:.35,maxComboHits:2},proceduralModel:"elite",modelScale:1.3,animSpeedMult:.9},BONE_REVENANT:{name:"Bone Revenant",health:40,damage:18,postureDmg:12,moveSpeed:3.5,detectionRange:8,attackRange:2,attackCooldown:.9,attackWindup:.25,attackDuration:.15,remnantDrop:70,patrolRadius:4,bodyColor:9075290,eyeColor:4521796,canChainAttacks:!0,maxChainAttacks:2,maxPosture:45,hasShield:!1,isAmbush:!0,canRetreat:!0,retreatHealthThreshold:.25,retreatDistance:12,canFlank:!0,attackVariety:{enabled:!0,heavyChance:.1,quickJabChance:.55,comboEnabled:!0,comboChance:.3,maxComboHits:2},proceduralModel:"revenant",modelScale:.9,animSpeedMult:1.4},CORRUPTED_ARCHER:{name:"Corrupted Archer",health:30,damage:22,postureDmg:8,moveSpeed:2.8,detectionRange:18,attackRange:12,attackCooldown:2.5,attackWindup:.8,attackDuration:.2,remnantDrop:55,patrolRadius:5,bodyColor:3820090,eyeColor:8978244,canChainAttacks:!1,maxPosture:35,hasShield:!1,isRanged:!0,preferredRange:10,canRetreat:!0,retreatHealthThreshold:.5,retreatDistance:8,canFlank:!0,attackVariety:{enabled:!0,heavyChance:.3,quickJabChance:.4,comboEnabled:!1},proceduralModel:"ranged",modelScale:.85,animSpeedMult:1.2},CRYPT_LORD:{name:"The Crypt Lord",health:600,damage:45,postureDmg:35,moveSpeed:2,detectionRange:20,attackRange:3.5,attackCooldown:1.8,attackWindup:.8,attackDuration:.3,remnantDrop:2500,patrolRadius:3,bodyColor:1710634,eyeColor:16720418,canChainAttacks:!0,maxChainAttacks:3,maxPosture:200,hasShield:!1,isBoss:!0,isElite:!0,bossPhase:1,attacks:{GREATSWORD_SLAM:{damage:55,postureDmg:40,windup:.8,recovery:1.5,range:4},HORIZONTAL_SWEEP:{damage:45,postureDmg:35,windup:.6,recovery:1,range:4.5},THREE_HIT_COMBO:{damages:[35,35,50],postureDmg:25,windup:.4,recovery:2,range:3.5},SHOULDER_BASH:{damage:30,postureDmg:45,windup:.5,recovery:1.2,range:6,isCharge:!0},GRAB:{damage:80,postureDmg:0,windup:1,recovery:2.5,range:2.5,isGrab:!0},SKELETON_SUMMON:{windup:1.2,recovery:1.5,summonCount:2},GROUND_SLAM_AOE:{damage:50,postureDmg:60,windup:1,recovery:2,range:8,jumpHeight:3},DARK_PROJECTILE:{damage:40,windup:.6,recovery:.8,speed:8,trackingStrength:3}},proceduralModel:"boss",modelPath:"assets/models/soldier.glb",modelScale:1.8,animSpeedMult:.85}};class Xo{constructor(e,t,i={},s=null){this.scene=e,this.gm=s;const n=i.type?Fl[i.type]:{};this.config={...Fl.HOLLOW_SOLDIER,...n,...i},this.maxHealth=this.config.health,this.health=this.maxHealth,this.maxPosture=this.config.maxPosture||60,this.posture=0,this.isDormant=this.config.behavior==="ambush"||this.config.isAmbush,this.triggerZone=this.config.triggerZone||null,this.triggerRadius=this.config.triggerRadius||6,this.state=this.isDormant?q.DORMANT:q.IDLE,this.stateTimer=0,this.hitThisSwing=!1,this.activeAttack=null,this.isBlocking=!1,this.isDead=!1,this.chainAttackCount=0,this.lastAttackTime=0,this.circleDirection=Math.random()>.5?1:-1,this.circleTimer=0,this.spawnPos=t.clone(),this.patrolTarget=t.clone(),this.patrolWait=0,this.modelLoaded=!1,this.animSystem=null,this.currentAnim=null,this.gltfModel=null,this.mesh=new ne,this.mesh.position.copy(t),this._createFallbackMesh(),this._createHealthBar(2.1),e.add(this.mesh),this.isDormant&&(this.mesh.visible=!1),this._loadGLTFModel(),this.world=null,this.collisionRadius=.5,this.lastPosition=t.clone(),this.stuckTimer=0,this.stuckThreshold=2,this.unstuckAttempts=0,this.avoidanceDir=null,this.avoidanceTimer=0,this.canRetreat=this.config.canRetreat||!1,this.retreatHealthThreshold=this.config.retreatHealthThreshold||.25,this.retreatDistance=this.config.retreatDistance||12,this.retreatReengageThreshold=.4,this.retreatStartPos=null,this.isRetreating=!1,this.retreatWallHits=0,this.canFlank=this.config.canFlank||!1,this.flankCooldown=5,this.lastFlankTime=-this.flankCooldown,this.flankTarget=null,this.isFlankAssigned=!1,this.flankDirection=1,this.flankProgress=0,this.groupId=null,this.isGroupLeader=!1,this.groupJoinDelay=0,this.isWaitingToJoin=!1,this.groupConfusionTimer=0,this.isConfused=!1,this.attackQueuePosition=-1,this.canAttackInGroup=!0,this.lastGroupAttackTime=0,this.groupEngageTime=0;const a=this.config.attackVariety||{};this.attackVarietyEnabled=a.enabled||!1,this.currentAttackType=Xt.NORMAL,this.lastAttackType=null,this.attackTypeCooldowns={[Xt.HEAVY]:0,[Xt.QUICK_JAB]:0,[Xt.COMBO]:0},this.playerLastPos=null,this.playerMoveSpeed=0,this.comboHitsRemaining=0,this.attackTellActive=!1,this.attackTellStartTime=0,this.config.isBoss&&(this.isBoss=!0,this.bossPhase=this.config.bossPhase||1,this.bossActive=!1,this.currentBossAttack=null,this.bossComboHit=0,this.lastBossAttackTime=0,this.bossAttackCooldown=0,this.chargeTarget=null,this.chargeProgress=0,this.grabTarget=null,this.world=null,this.enemyManager=null,this.activeProjectiles=[],this.summonedAdds=[],this.lastSummonTime=0,this.summonCooldown=15e3,this.aoeJumpProgress=0,this.aoeStartY=0,this._createHealthBar(3.5))}wake(){this.state===q.DORMANT&&(this.mesh.visible=!0,this.isDormant=!1,this._changeState(q.RISING),this.gm?.audioManager&&this.gm.audioManager.play("ambush",{position:this.mesh.position,volume:.7}))}checkTrigger(e){if(this.state!==q.DORMANT)return!1;const t=e.x-this.mesh.position.x,i=e.z-this.mesh.position.z;return Math.sqrt(t*t+i*i)<this.triggerRadius}_createFallbackMesh(){const e=this.config.proceduralModel||"standard",t=this.config.modelScale||1;let i;switch(e){case"berserker":i=a1({scale:t});break;case"sentinel":i=r1({scale:t});break;case"revenant":i=o1({scale:t});break;case"ranged":i=l1({scale:t});break;case"elite":i=n1({scale:t});break;case"boss":i=c1({scale:t});break;default:i=pr({type:"standard",scale:t});break}this.proceduralModel=i,this.mesh.add(i),this.body=i,this.fallbackBody=i,i.userData.eyes&&(this.eye=i.userData.eyes[0]),this.useProceduralAnimation=!0}async _loadGLTFModel(){if(!this.config.isBoss){this.modelLoaded=!0;return}try{const e="/project-ashen/",t=this.config.modelPath||"assets/models/soldier.glb",i=`${e}${t}`,s=this.config.modelScale||1.5,{scene:n,animations:a}=await or.loadModel(i,{scale:s});this.gltfModel=n,this.gltfModel.position.y=0,this.gltfModel.rotation.y=Math.PI,this._applyModelTint(2759226),this.gltfModel.traverse(o=>{o.isMesh&&(o.castShadow=!0,o.receiveShadow=!0,o.userData.originalMaterial=o.material.clone())}),this.proceduralModel&&(this.proceduralModel.visible=!1),this.mesh.add(this.gltfModel),a&&a.length>0&&(this.animSystem=or.createAnimationSystem(this.gltfModel,a),this._playAnimation(this.state,{loop:!0})),this.modelLoaded=!0,this.body=this.gltfModel,this.useProceduralAnimation=!1}catch(e){console.error(`[Boss:${this.config.name}] Failed to load GLTF, using procedural model:`,e),this.modelLoaded=!0}}_applyModelTint(e){const t=new H(e);this.gltfModel.traverse(i=>{i.isMesh&&i.material&&(Array.isArray(i.material)?i.material:[i.material]).forEach(n=>{n.color&&n.color.lerp(t,.3),n.emissive&&(n.emissive.copy(t).multiplyScalar(.1),n.emissiveIntensity=.2)})})}_playAnimation(e,t={}){if(!this.animSystem)return;const i=p1[e];if(!i||this.currentAnim===i&&e!==q.ATTACK)return;const s=this.config.animSpeedMult||1,n={loop:e===q.IDLE||e===q.PATROL||e===q.CHASE||e===q.CIRCLE||e===q.RETREAT,fadeIn:.2,timeScale:s,clampWhenFinished:e===q.DEAD};e===q.ATTACK?(n.loop=!1,n.timeScale=s*1.2):e===q.CHASE&&(n.timeScale=s*1.3);const a={...n,...t};this.currentAnim?this.animSystem.crossFade(this.currentAnim,i,a.fadeIn):this.animSystem.play(i,a),this.currentAnim=i}_updateProceduralAnimation(e){if(!this.proceduralModel)return;const t=this.stateTimer,i=Date.now()*.001,s=this.config.animSpeedMult||1,n=this.proceduralModel;let a=.02,o=2;const r=(this.mesh?.uuid?.charCodeAt(0)||0)*.1,c=this.config.isElite?.08:.05,h=Math.sin(i*12+r)*Math.sin(i*7.3)*c;switch(this.state){case q.IDLE:case q.DORMANT:a=.02,o=2.5;const d=Math.sin(t*1.2)*.06,u=Math.sin(t*8.5)*Math.sin(t*13.2)*.08,p=Math.random()<.002?(Math.random()-.5)*.2:0;n.rotation.y=d+u+p,n.rotation.z=Math.sin(t*.7)*.02+h*.5,Math.sin(t*.3)>.95?n.rotation.x=.05:n.rotation.x=gt.lerp(n.rotation.x,0,e*2);break;case q.PATROL:a=.05,o=7*s;const f=Math.sin(t*1.8)*.15,y=Math.sin(t*11)*.04;n.rotation.y=f+y,n.rotation.z=Math.sin(t*o)*.03;break;case q.CIRCLE:a=.03,o=5*s,n.rotation.x=.08,n.rotation.y=h*2,n.rotation.z=Math.sin(t*3)*.02;break;case q.CHASE:case q.FLANK:a=.08,o=12*s,n.rotation.x=.25;const m=Math.sin(t*o*1.5)*.06;n.rotation.y=m+h,n.rotation.z=Math.sin(t*o)*.04;break;case q.RETREAT:a=.04,o=8*s,n.rotation.x=-.15,n.rotation.y=Math.sin(t*2)*.1,n.rotation.z=Math.sin(t*o)*.06+h;break;case q.ATTACK:a=.03,o=18*s;const g=(this.config.attackWindup||.5)*(Jr[this.currentAttackType]?.windupMult||1);if(t<g){const _=t/g;n.rotation.x=-.2*_;const S=Math.sin(t*30)*.03*_;n.rotation.z=S,n.rotation.y=Math.sin(t*25)*.02*_,n.position.y=-.05*_}else{const _=t-g,A=Math.min(_/.15,1);n.rotation.x=gt.lerp(-.2,.4,A),n.rotation.z=Math.sin(A*Math.PI)*.1,n.position.y=-.05+A*.08}break;case q.STAGGERED:const x=Math.max(0,1-t/1.5);n.rotation.z=Math.sin(t*18)*.15*x,n.rotation.x=Math.cos(t*14)*.08*x,n.rotation.y=Math.sin(t*11)*.1*x,n.position.y=-.1*x,a=0;break;case q.RISING:const v=Math.min(t/.8,1),b=gt.lerp(-.6,0,this._easeOutBack(v));n.position.y=b,n.rotation.x=(1-v)*.6,n.rotation.z=Math.sin(t*15)*.05*(1-v),a=0;break;case q.DEAD:if(t<.5){const _=Math.sin(t*20)*Math.exp(-t*3);n.rotation.z=_*.2,n.rotation.x=t*.3}a=0;break;default:n.rotation.x=gt.lerp(n.rotation.x,0,e*3),n.rotation.z=gt.lerp(n.rotation.z,0,e*3)}if(a>0&&this.state!==q.STAGGERED&&this.state!==q.DEAD){const d=Math.sin(t*o*.7)*.2;n.position.y=(n.position.y||0)+Math.sin(t*o+d)*a}}_easeOutBack(e){return 1+2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2)}_createHealthBar(e){this.healthBarGroup=new ne,this.healthBarGroup.position.y=e;const t=new Dt(1,.08),i=new B({color:1118481,side:lt}),s=new w(t,i);this.healthBarGroup.add(s);const n=new Dt(.98,.06),a=new B({color:13382451,side:lt});this.healthFill=new w(n,a),this.healthFill.position.z=.001,this.healthBarGroup.add(this.healthFill);const o=new Dt(1,.04),r=new B({color:2236945,side:lt}),c=new w(o,r);c.position.y=-.08,this.healthBarGroup.add(c);const h=new Dt(.98,.03),d=new B({color:16763904,side:lt});this.postureFill=new w(h,d),this.postureFill.position.set(0,-.08,.001),this.postureFill.scale.x=0,this.healthBarGroup.add(this.postureFill),this.mesh.add(this.healthBarGroup),this.healthBarGroup.visible=!1,this.breakIndicator=this._createBreakIndicator(),this.breakIndicator.visible=!1,this.mesh.add(this.breakIndicator)}_createBreakIndicator(){const e=document.createElement("canvas");e.width=128,e.height=64;const t=e.getContext("2d");t.fillStyle="#ffcc00",t.font="bold 32px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("BREAK!",64,32);const i=new Zd(e),s=new Xd({map:i,transparent:!0,depthTest:!1}),n=new mm(s);return n.scale.set(1.5,.75,1),n.position.y=3,n}update(e,t){if(this.state===q.DEAD)return;this.animSystem&&this.animSystem.update(e),this.proceduralModel&&this.useProceduralAnimation&&(d1(this.proceduralModel,e),this._updateProceduralAnimation(e)),this.stateTimer+=e;const i=this.mesh.position.distanceTo(t.mesh.position),s=this.health/this.maxHealth;if(this.healthBarGroup.visible){const n=this.scene.getObjectByProperty("type","PerspectiveCamera");n&&this.healthBarGroup.lookAt(n.position)}switch(this.config.hasShield&&this.state===q.CHASE&&i<this.config.attackRange*1.5?this.isBlocking=Math.random()<this.config.shieldBlockChance:this.isBlocking=!1,this.state){case q.IDLE:this.patrolWait+=e,i<this.config.detectionRange?(this._changeState(q.CHASE),this.healthBarGroup.visible=!0):this.patrolWait>2&&(this.patrolWait=0,this._pickPatrolTarget(),this._changeState(q.PATROL));break;case q.PATROL:if(i<this.config.detectionRange){this._changeState(q.CHASE),this.healthBarGroup.visible=!0;break}this._moveToward(this.patrolTarget,this.config.moveSpeed*.5,e),this.mesh.position.distanceTo(this.patrolTarget)<.5&&this._changeState(q.IDLE);break;case q.CHASE:if(this.isBoss&&!this.bossActive&&(this.bossActive=!0,this.healthBarGroup.visible=!0,this.world&&this.world.activateBossArena&&this.world.activateBossArena(),this.gm?.audioManager&&this.gm.audioManager.play("bossRoar",{position:this.mesh.position,volume:.9})),this.isBoss&&(this.playerTarget=t.mesh.position.clone()),!this.isBoss&&i>this.config.detectionRange*1.5){this._changeState(q.IDLE),this.healthBarGroup.visible=!1,this._resetGroupState();break}if(!this.isBoss&&this.isWaitingToJoin)if(this.groupJoinDelay-=e,this.groupJoinDelay<=0)this.isWaitingToJoin=!1,this.groupEngageTime=Date.now();else{this._moveToward(t.mesh.position,this.config.moveSpeed*.4,e),this._faceTarget(t.mesh.position,e);break}if(!this.isBoss&&this.isConfused)if(this.groupConfusionTimer-=e,this.groupConfusionTimer<=0)this.isConfused=!1,this.groupConfusionTimer=0;else{const g=Math.sin(this.stateTimer*8)*.5;this.mesh.rotation.y+=g*e;break}if(!this.isBoss&&this.canRetreat&&s<this.retreatHealthThreshold&&!this.isRetreating){this.retreatStartPos=this.mesh.position.clone(),this.isRetreating=!0,this.retreatWallHits=0,this._changeState(q.RETREAT);break}if(!this.isBoss&&this.canFlank&&this.isFlankAssigned&&this.stateTimer+Date.now()/1e3-this.lastFlankTime>=this.flankCooldown){this._calculateFlankTarget(t.mesh.position),this.flankProgress=0,this._changeState(q.FLANK);break}if(i<=this.config.attackRange&&this.bossAttackCooldown<=0){if(this.isBoss)this._selectBossAttack(i,s);else{if(this.groupId!==null&&!this.canAttackInGroup){this._changeState(q.CIRCLE);break}this.lastGroupAttackTime=Date.now(),this._changeState(q.ATTACK)}break}if(this.isBoss&&i>this.config.attackRange&&i<8&&this.bossAttackCooldown<=0&&Math.random()<.02){this._startBossCharge(t);break}if(i<this.config.attackRange*2&&Math.random()<.005){this._changeState(q.CIRCLE);break}this._moveToward(t.mesh.position,this.config.moveSpeed,e),this._faceTarget(t.mesh.position,e);break;case q.CIRCLE:if(this.circleTimer+=e,this.circleTimer>1.5||i>this.config.detectionRange){this._changeState(q.CHASE);break}if(i<=this.config.attackRange){this._changeState(q.ATTACK);break}this._circleStrafe(t.mesh.position,e),this._faceTarget(t.mesh.position,e);break;case q.FLANK:if(this.flankProgress+=e,this.flankProgress>3){this._endFlankManeuver(!1),this._changeState(q.CHASE);break}if(i>this.config.detectionRange*1.5){this._endFlankManeuver(!1),this._changeState(q.IDLE),this.healthBarGroup.visible=!1;break}if(this.flankProgress%.5<e&&this._calculateFlankTarget(t.mesh.position),(this.flankTarget?this.mesh.position.distanceTo(this.flankTarget):1/0)<1.5||i<=this.config.attackRange){this._endFlankManeuver(!0),this._changeState(q.ATTACK);break}const a=this.mesh.position.clone();if(this._moveToward(this.flankTarget,this.config.moveSpeed*1.1,e),this.mesh.position.distanceTo(a)<this.config.moveSpeed*.5*e){this._endFlankManeuver(!1),this._changeState(q.CHASE);break}this.flankTarget&&this._faceTarget(this.flankTarget,e);break;case q.RETREAT:const r=this.retreatStartPos?this.mesh.position.distanceTo(this.retreatStartPos):0,c=s>=this.retreatReengageThreshold,h=r>=this.retreatDistance,d=this.retreatWallHits>=3,u=i>this.config.detectionRange*1.5;if(h||c||d||u){this.isRetreating=!1,this.retreatStartPos=null,this.retreatWallHits=0,u?(this._changeState(q.IDLE),this.healthBarGroup.visible=!1):this._changeState(q.CHASE);break}const p=new T().subVectors(this.mesh.position,t.mesh.position);p.y=0,p.normalize();const f=this.mesh.position.clone().add(p.multiplyScalar(3)),y=this.mesh.position.clone();if(this._moveToward(f,this.config.moveSpeed*.7,e),this.mesh.position.distanceTo(y)<this.config.moveSpeed*.7*e*.5){this.retreatWallHits++;const g=new T(-p.z,0,p.x),x=this.retreatWallHits%2===0?g:g.negate(),v=this.mesh.position.clone().add(x.multiplyScalar(2));this._moveToward(v,this.config.moveSpeed*.5,e)}this._faceTarget(t.mesh.position,e);break;case q.ATTACK:this._processAttack(e,t);break;case q.STAGGERED:this.gltfModel?this.gltfModel.rotation.z=Math.sin(this.stateTimer*15)*.1*(1-this.stateTimer/1.5):this.fallbackBody&&(this.fallbackBody.rotation.z=Math.sin(this.stateTimer*15)*.1*(1-this.stateTimer/1.5)),this.stateTimer>=1.5&&(this.posture=0,this.gltfModel&&(this.gltfModel.rotation.z=0),this.fallbackBody&&(this.fallbackBody.rotation.z=0),this.breakIndicator.visible=!1,this._updatePostureBar(),this._changeState(i<this.config.detectionRange?q.CHASE:q.IDLE));break;case q.DORMANT:break;case q.RISING:if(this.stateTimer<.5){const g=this.gltfModel||this.fallbackBody;if(g){const x=this.stateTimer/.5;g.position.y=gt.lerp(-.8,0,x)}}else if(this.stateTimer>=.8){const g=this.gltfModel||this.fallbackBody;g&&(g.position.y=0),this.healthBarGroup.visible=!0,this._changeState(q.CHASE)}this._faceTarget(t.mesh.position,e*2);break;case q.BOSS_SLAM:this._processBossSlamAttack(e,t);break;case q.BOSS_SWEEP:this._processBossSweepAttack(e,t);break;case q.BOSS_COMBO:this._processBossComboAttack(e,t);break;case q.BOSS_CHARGE:this._processBossChargeAttack(e,t);break;case q.BOSS_GRAB:this._processBossGrabAttack(e,t);break;case q.BOSS_TRANSITION:break;case q.BOSS_SUMMON:this._processBossSummonAttack(e,t);break;case q.BOSS_AOE:this._processBossAOEAttack(e,t);break;case q.BOSS_PROJECTILE:this._processBossProjectileAttack(e,t);break}this.isBoss&&this.activeProjectiles&&this._updateProjectiles(e,t),this.state!==q.STAGGERED&&this.posture>0&&(this.posture=Math.max(0,this.posture-8*e),this._updatePostureBar()),this.isBoss&&this.bossAttackCooldown>0&&(this.bossAttackCooldown-=e),(!this.isBoss||this.state===q.CHASE||this.state===q.PATROL)&&(this.state===q.CHASE||this.state===q.PATROL||this.state===q.RETREAT||this.state===q.CIRCLE)&&this._checkStuck(e)}_circleStrafe(e,t){const i=new T().subVectors(e,this.mesh.position);i.y=0;const s=i.length();i.normalize();const n=new T(-i.z,0,i.x).multiplyScalar(this.circleDirection),a=this.config.attackRange*1.5,o=new T().copy(i).multiplyScalar((s-a)*.5),r=n.add(o).normalize(),c=this.config.moveSpeed*.7*t,h=this.mesh.position.clone().addScaledVector(r,c);this.world&&this.world.checkCollision?this.world.checkCollision(h,this.collisionRadius).collides?this.circleDirection*=-1:this.mesh.position.copy(h):this.mesh.position.addScaledVector(r,c)}_calculateFlankTarget(e){const t=new T().subVectors(this.mesh.position,e);t.y=0,t.length(),t.normalize();const i=new T(-t.z*this.flankDirection,0,t.x*this.flankDirection),s=this.config.attackRange*1.2;this.flankTarget=new T(e.x+i.x*s,this.mesh.position.y,e.z+i.z*s);const n=new T().subVectors(e,this.flankTarget);n.y=0,n.normalize(),this.flankTarget.addScaledVector(n,s*.3)}_endFlankManeuver(e){this.isFlankAssigned=!1,this.flankTarget=null,this.flankProgress=0,e?this.lastFlankTime=Date.now()/1e3:(this.lastFlankTime=Date.now()/1e3-this.flankCooldown*.5,this.flankDirection*=-1)}requestFlank(){return!this.canFlank||this.state===q.DEAD||this.state===q.STAGGERED||this.state===q.FLANK||this.isRetreating||Date.now()/1e3-this.lastFlankTime<this.flankCooldown?!1:(this.isFlankAssigned=!0,this.flankDirection=Math.random()>.5?1:-1,!0)}_resetGroupState(){this.groupId=null,this.isGroupLeader=!1,this.groupJoinDelay=0,this.isWaitingToJoin=!1,this.groupConfusionTimer=0,this.isConfused=!1,this.attackQueuePosition=-1,this.canAttackInGroup=!0,this.groupEngageTime=0}joinGroup(e,t,i=0){this.groupId=e,this.isGroupLeader=t,t?(this.groupJoinDelay=0,this.isWaitingToJoin=!1,this.groupEngageTime=Date.now()):(this.groupJoinDelay=i,this.isWaitingToJoin=i>0,this.groupEngageTime=0)}triggerConfusion(e=1){this.isBoss||this.state!==q.DEAD&&(this.isConfused=!0,this.groupConfusionTimer=e,this.isGroupLeader=!1)}isAttacking(){return this.state===q.ATTACK||this.state===q.BOSS_SLAM||this.state===q.BOSS_SWEEP||this.state===q.BOSS_COMBO||this.state===q.BOSS_CHARGE||this.state===q.BOSS_GRAB||this.state===q.BOSS_AOE||this.state===q.BOSS_PROJECTILE}isInCombat(){return this.state===q.CHASE||this.state===q.CIRCLE||this.state===q.FLANK||this.state===q.ATTACK||this.isAttacking()}_selectBossAttack(e,t){const i=this.config.attacks;if(!i){this._changeState(q.ATTACK);return}if(this.bossPhase===2){this._selectPhase2Attack(e);return}const s=Math.random();e<=this.config.attackRange&&(s<.1&&i.GRAB?this._changeState(q.BOSS_GRAB):s<.35?this._changeState(q.BOSS_SLAM):s<.65?this._changeState(q.BOSS_COMBO):this._changeState(q.BOSS_SWEEP))}_selectPhase2Attack(e){this.config.attacks;const t=Math.random(),i=Date.now()-this.lastSummonTime>this.summonCooldown,s=this.summonedAdds.filter(n=>!n.isDead).length;if(i&&s===0&&t<.25){this._changeState(q.BOSS_SUMMON);return}if(e>this.config.attackRange&&e<10){if(t<.4)this._changeState(q.BOSS_PROJECTILE);else if(t<.7)this._changeState(q.BOSS_AOE);else if(t<.85)this.chargeTarget=this.playerTarget?this.playerTarget.clone():this.mesh.position.clone(),this.chargeProgress=0,this._changeState(q.BOSS_CHARGE);else return;return}e<=this.config.attackRange&&(t<.15?this._changeState(q.BOSS_AOE):t<.25?this._changeState(q.BOSS_PROJECTILE):t<.4?this._changeState(q.BOSS_SLAM):t<.6?this._changeState(q.BOSS_COMBO):t<.8?this._changeState(q.BOSS_SWEEP):t<.95?this._changeState(q.BOSS_GRAB):i&&s<3?this._changeState(q.BOSS_SUMMON):this._changeState(q.BOSS_SLAM))}_startBossCharge(e){this.chargeTarget=e.mesh.position.clone(),this.chargeProgress=0,this._changeState(q.BOSS_CHARGE)}_processBossSlamAttack(e,t){const i=this.config.attacks?.GREATSWORD_SLAM;if(!i){this._changeState(q.CHASE);return}const s=i.windup,n=s+.3,a=n+i.recovery;if(this.stateTimer<s){this._faceTarget(t.mesh.position,e*2);const o=this.stateTimer/s,r=this.gltfModel||this.fallbackBody;r&&(r.rotation.x=o*-.3);return}if(this.stateTimer>=s&&this.stateTimer<n){if(!this.hitThisSwing){const r=new T(Math.sin(this.mesh.rotation.y),0,Math.cos(this.mesh.rotation.y));this.activeAttack={position:this.mesh.position.clone().add(r.multiplyScalar(1.5)).add(new T(0,1.5,0)),range:i.range,damage:i.damage,postureDmg:i.postureDmg,isHeavy:!0},this.gm?.audioManager&&this.gm.audioManager.play("swordSwing",{position:this.mesh.position,volume:.8,pitch:.6})}const o=this.gltfModel||this.fallbackBody;if(o){const r=(this.stateTimer-s)/.3;o.rotation.x=gt.lerp(-.3,.2,r)}}if(this.stateTimer>=n&&this.stateTimer<a){this.activeAttack=null;const o=this.gltfModel||this.fallbackBody;o&&(o.rotation.x=gt.lerp(o.rotation.x,0,.08))}this.stateTimer>=a&&this._endBossAttack()}_processBossSweepAttack(e,t){const i=this.config.attacks?.HORIZONTAL_SWEEP;if(!i){this._changeState(q.CHASE);return}const s=i.windup,n=s+.25,a=n+i.recovery;if(this.stateTimer<s){this._faceTarget(t.mesh.position,e*2);const o=this.stateTimer/s,r=this.gltfModel||this.fallbackBody;r&&(r.rotation.z=o*.3);return}if(this.stateTimer>=s&&this.stateTimer<n){this.hitThisSwing||(this.activeAttack={position:this.mesh.position.clone().add(new T(0,1.2,0)),range:i.range,damage:i.damage,postureDmg:i.postureDmg,isHeavy:!1},this.gm?.audioManager&&this.gm.audioManager.play("swordSwing",{position:this.mesh.position,volume:.7}));const o=this.gltfModel||this.fallbackBody;if(o){const r=(this.stateTimer-s)/.25;o.rotation.z=gt.lerp(.3,-.25,r)}}if(this.stateTimer>=n&&this.stateTimer<a){this.activeAttack=null;const o=this.gltfModel||this.fallbackBody;o&&(o.rotation.z=gt.lerp(o.rotation.z,0,.1))}this.stateTimer>=a&&this._endBossAttack()}_processBossComboAttack(e,t){const i=this.config.attacks?.THREE_HIT_COMBO;if(!i){this._changeState(q.CHASE);return}const s=i.windup,n=.3,a=s+n,o=.15,r=this.bossComboHit||0,c=r*(a+o),h=this.stateTimer-c;if(h<s){this._faceTarget(t.mesh.position,e*3);const d=h/s,u=this.gltfModel||this.fallbackBody;if(u){const p=r%2===0?1:-1;u.rotation.z=d*.25*p}return}if(h>=s&&h<a){if(!this.hitThisSwing){const p=(i.damages||[35,35,50])[r]||i.damage;this.activeAttack={position:this.mesh.position.clone().add(new T(0,1.2,0)),range:i.range,damage:p,postureDmg:i.postureDmg,isHeavy:r===2,isCombo:!0},this.gm?.audioManager&&this.gm.audioManager.play("swordSwing",{position:this.mesh.position,volume:.65,pitch:.85+r*.1}),this.hitThisSwing=!0}const d=this.gltfModel||this.fallbackBody;if(d){const u=(h-s)/n,p=r%2===0?1:-1;d.rotation.z=gt.lerp(.25*p,-.2*p,u)}}if(h>=a){this.activeAttack=null,this.hitThisSwing=!1;const d=this.mesh.position.distanceTo(t.mesh.position);if(r<2&&d<this.config.attackRange*1.3){this.bossComboHit=r+1;const u=new T(Math.sin(this.mesh.rotation.y),0,Math.cos(this.mesh.rotation.y));this.mesh.position.addScaledVector(u,.5)}else{const u=this.gltfModel||this.fallbackBody;u&&(u.rotation.z=0),h>=a+i.recovery&&(this.bossComboHit=0,this._endBossAttack())}}}_processBossChargeAttack(e,t){const i=this.config.attacks?.SHOULDER_BASH;if(!i){this._changeState(q.CHASE);return}const s=i.windup,n=.4,a=s+n,o=a+i.recovery;if(this.stateTimer<s){this._faceTarget(t.mesh.position,e*2),this.chargeTarget=t.mesh.position.clone();const r=this.stateTimer/s,c=this.gltfModel||this.fallbackBody;c&&(c.position.y=-r*.3,c.rotation.x=r*.2);return}if(this.stateTimer>=s&&this.stateTimer<a){this.hitThisSwing||(this.activeAttack={position:this.mesh.position.clone().add(new T(0,1,0)),range:2,damage:i.damage,postureDmg:i.postureDmg,isHeavy:!0,isCharge:!0},this.gm?.audioManager&&this.gm.audioManager.play("dash",{position:this.mesh.position,volume:.8}));const r=i.range/n;this._moveToward(this.chargeTarget,r,e),this.activeAttack&&(this.activeAttack.position=this.mesh.position.clone().add(new T(0,1,0)))}if(this.stateTimer>=a&&this.stateTimer<o){this.activeAttack=null;const r=this.gltfModel||this.fallbackBody;r&&(r.position.y=gt.lerp(r.position.y,0,.15),r.rotation.x=gt.lerp(r.rotation.x,0,.15))}this.stateTimer>=o&&this._endBossAttack()}_processBossGrabAttack(e,t){const i=this.config.attacks?.GRAB;if(!i){this._changeState(q.CHASE);return}const s=i.windup,n=s+.3,a=n+.5,o=a+i.recovery;if(this.stateTimer<s){this._faceTarget(t.mesh.position,e*1.5);const r=this.stateTimer/s,c=this.gltfModel||this.fallbackBody;c&&(c.scale.x=1+r*.15);return}if(this.stateTimer>=s&&this.stateTimer<n&&(this.hitThisSwing||(this.mesh.position.distanceTo(t.mesh.position)<i.range&&(this.activeAttack={position:this.mesh.position.clone(),range:i.range,damage:i.damage,postureDmg:0,isGrab:!0,isUnblockable:!0},this.grabTarget=t,this.gm?.audioManager&&this.gm.audioManager.play("criticalHit",{position:this.mesh.position,volume:.9})),this.hitThisSwing=!0)),this.stateTimer>=n&&this.stateTimer<a){this.activeAttack=null;const r=this.gltfModel||this.fallbackBody;r&&(r.scale.x=gt.lerp(r.scale.x,1,.1))}if(this.stateTimer>=a&&this.stateTimer<o){this.grabTarget=null;const r=this.gltfModel||this.fallbackBody;r&&(r.scale.x=1)}this.stateTimer>=o&&this._endBossAttack()}_endBossAttack(){this.hitThisSwing=!1,this.activeAttack=null,this.bossComboHit=0,this.chargeTarget=null,this.grabTarget=null,this.bossAttackCooldown=this.config.attackCooldown;const e=this.gltfModel||this.fallbackBody;e&&(e.rotation.x=0,e.rotation.z=0,e.position.y=0,e.scale.x=1),this._changeState(q.CHASE)}_processBossSummonAttack(e,t){const i=this.config.attacks?.SKELETON_SUMMON;if(!i){this._changeState(q.CHASE);return}const s=i.windup,n=s+.5,a=n+i.recovery;if(this.stateTimer<s){const o=this.stateTimer/s,r=this.gltfModel||this.fallbackBody;r&&(r.rotation.x=-o*.2),this.stateTimer%.2<.1&&this._flashModel(8930508,80),this.stateTimer<.1&&this.gm?.audioManager&&this.gm.audioManager.play("magic",{position:this.mesh.position,volume:.7});return}if(this.stateTimer>=s&&this.stateTimer<n&&(this.hitThisSwing||(this.hitThisSwing=!0,this.lastSummonTime=Date.now(),this._spawnSkeletonAdds(i.summonCount||2),this._flashModel(16729343,200),this.gm?.audioManager&&this.gm.audioManager.play("ambush",{position:this.mesh.position,volume:.8}),this.gm?.cameraController&&this.gm.cameraController.shakeLight())),this.stateTimer>=n&&this.stateTimer<a){const o=this.gltfModel||this.fallbackBody;o&&(o.rotation.x=gt.lerp(o.rotation.x,0,.1))}this.stateTimer>=a&&this._endBossAttack()}_spawnSkeletonAdds(e){if(!this.enemyManager)return;const t=this.mesh.position,i=5;for(let s=0;s<e;s++){const n=Math.PI*2*s/e+Math.random()*.5,a=new T(t.x+Math.cos(n)*i,t.y,t.z+Math.sin(n)*i),o=new Xo(this.scene,a,{type:"BONE_REVENANT",name:"Summoned Revenant",behavior:"guard"},this.gm);o.mesh.visible=!0,o.isDormant=!1,o.state=q.CHASE,o.healthBarGroup.visible=!0,this.summonedAdds.push(o),this.enemyManager.enemies.push(o);const r=o.gltfModel||o.fallbackBody;if(r){r.position.y=-1;const c=()=>{r.position.y<0&&(r.position.y+=.05,requestAnimationFrame(c))};c()}}}_processBossAOEAttack(e,t){const i=this.config.attacks?.GROUND_SLAM_AOE;if(!i){this._changeState(q.CHASE);return}const s=i.windup,n=s+.4,a=n+.3,o=a+.2,r=o+i.recovery,c=this.gltfModel||this.fallbackBody;if(this.stateTimer<s){this._faceTarget(t.mesh.position,e),this.playerTarget=t.mesh.position.clone();const h=this.stateTimer/s;c&&(c.position.y=-h*.3),this.aoeStartY=this.mesh.position.y;return}if(this.stateTimer>=s&&this.stateTimer<n){const h=(this.stateTimer-s)/.4,d=i.jumpHeight||3,u=Math.sin(h*Math.PI)*d;this.mesh.position.y=this.aoeStartY+u,c&&(c.position.y=0,c.rotation.x=-.3);const p=this.playerTarget||t.mesh.position;this._moveToward(p,8,e);return}if(this.stateTimer>=n&&this.stateTimer<a){const h=(this.stateTimer-n)/.3;this.mesh.position.y=gt.lerp(this.mesh.position.y,this.aoeStartY,h*2),c&&(c.rotation.x=gt.lerp(-.3,.2,h))}this.stateTimer>=a&&this.stateTimer<o&&(this.mesh.position.y=this.aoeStartY,this.hitThisSwing||(this.hitThisSwing=!0,this.activeAttack={position:this.mesh.position.clone(),range:i.range,damage:i.damage,postureDmg:i.postureDmg,isHeavy:!0,isAOE:!0},this._createShockwaveEffect(),this.gm?.audioManager&&this.gm.audioManager.play("postureBreak",{position:this.mesh.position,volume:1,pitch:.6}),this.gm?.cameraController&&this.gm.cameraController.shake(.5,.4))),this.stateTimer>=o&&this.stateTimer<r&&(this.activeAttack=null,c&&(c.rotation.x=gt.lerp(c.rotation.x,0,.1))),this.stateTimer>=r&&this._endBossAttack()}_createShockwaveEffect(){const e=new Ki(.5,1.5,32),t=new B({color:8930508,transparent:!0,opacity:.8,side:lt}),i=new w(e,t);i.rotation.x=-Math.PI/2,i.position.copy(this.mesh.position),i.position.y=.1,this.scene.add(i);const s=this.config.attacks?.GROUND_SLAM_AOE?.range||8,n=Date.now(),a=400,o=()=>{const c=(Date.now()-n)/a;if(c<1){const h=1+c*s;i.scale.set(h,h,1),i.material.opacity=.8*(1-c),requestAnimationFrame(o)}else this.scene.remove(i),i.geometry.dispose(),i.material.dispose()};o()}_processBossProjectileAttack(e,t){const i=this.config.attacks?.DARK_PROJECTILE;if(!i){this._changeState(q.CHASE);return}const s=i.windup,n=s+.2,a=n+i.recovery;if(this.stateTimer<s){this._faceTarget(t.mesh.position,e*3);const o=this.stateTimer/s,r=this.gltfModel||this.fallbackBody;r&&(r.rotation.z=o*.15),this.stateTimer%.15<.075&&this._flashModel(6693546,60);return}if(this.stateTimer>=s&&this.stateTimer<n&&(this.hitThisSwing||(this.hitThisSwing=!0,this._spawnDarkProjectile(t,i),this.gm?.audioManager&&this.gm.audioManager.play("swordSwing",{position:this.mesh.position,volume:.6,pitch:1.5}))),this.stateTimer>=n&&this.stateTimer<a){const o=this.gltfModel||this.fallbackBody;o&&(o.rotation.z=gt.lerp(o.rotation.z,0,.15))}this.stateTimer>=a&&this._endBossAttack()}_spawnDarkProjectile(e,t){const i=new re(.4,16,16),s=new B({color:8930508,transparent:!0,opacity:.9}),n=new w(i,s),a=new T(Math.sin(this.mesh.rotation.y),0,Math.cos(this.mesh.rotation.y));n.position.copy(this.mesh.position).add(a.multiplyScalar(1.5)).add(new T(0,1.5,0));const o=new re(.25,12,12),r=new B({color:16729343,transparent:!0,opacity:1}),c=new w(o,r);n.add(c);const h=new We(8930508,2,5);n.add(h),this.scene.add(n),this.activeProjectiles.push({mesh:n,target:e,speed:t.speed||8,tracking:t.trackingStrength||3,damage:t.damage||40,lifetime:0,maxLifetime:5,direction:new T().subVectors(e.mesh.position,n.position).normalize()})}_updateProjectiles(e,t){for(let i=this.activeProjectiles.length-1;i>=0;i--){const s=this.activeProjectiles[i];if(s.lifetime+=e,s.lifetime>s.maxLifetime){this._destroyProjectile(i);continue}const n=new T().subVectors(t.mesh.position.clone().add(new T(0,1,0)),s.mesh.position),a=n.length();if(n.normalize(),s.direction.lerp(n,s.tracking*e),s.direction.normalize(),s.mesh.position.addScaledVector(s.direction,s.speed*e),s.mesh.rotation.x+=e*3,s.mesh.rotation.y+=e*2,a<1.2&&!t.isInvincible){this.gm?.takeDamage(s.damage,"magic",10,t.isBlocking),t.flashDamage(),this.gm?.hud&&this.gm.hud.flashDamage(.6),this.gm?.cameraController&&this.gm.cameraController.shakeMedium(),this.gm?.particleManager&&this.gm.particleManager.spawnHitSparks(s.mesh.position,8,!1),this._destroyProjectile(i);continue}a>30&&this._destroyProjectile(i)}}_destroyProjectile(e){const t=this.activeProjectiles[e];if(t&&t.mesh){const i=t.mesh.position.clone(),s=new re(.8,8,8),n=new B({color:8930508,transparent:!0,opacity:.8}),a=new w(s,n);a.position.copy(i),this.scene.add(a);const o=()=>{a.scale.multiplyScalar(1.1),a.material.opacity-=.1,a.material.opacity>0?requestAnimationFrame(o):(this.scene.remove(a),a.geometry.dispose(),a.material.dispose())};o(),this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.mesh.material.dispose()}this.activeProjectiles.splice(e,1)}_processAttack(e,t){this.stateTimer<e*2&&this.attackVarietyEnabled&&this._selectAttackType(t);const i=this.attackVarietyEnabled&&Jr[this.currentAttackType]||Jr[Xt.NORMAL],s=this.config.attackWindup*i.windupMult,n=this.config.attackDuration,a=s+n,o=this.config.attackCooldown*i.cooldownMult;if(this.stateTimer<s){this._faceTarget(t.mesh.position,e*2),this.attackVarietyEnabled&&this._showAttackTell(i.tell,this.stateTimer/s);return}if(this.stateTimer>=s&&this.stateTimer<a){if(!this.hitThisSwing){const r=new T(Math.sin(this.mesh.rotation.y),0,Math.cos(this.mesh.rotation.y)),c=Math.floor(this.config.damage*i.damageMult),h=Math.floor(this.config.postureDmg*i.postureMult),d=this.config.attackRange*i.rangeMult;if(this.activeAttack={position:this.mesh.position.clone().add(r.multiplyScalar(1)).add(new T(0,1,0)),range:d,damage:c,postureDmg:h,attackType:this.currentAttackType,isHeavy:this.currentAttackType===Xt.HEAVY},this.gm?.audioManager){const u=this.currentAttackType===Xt.HEAVY?.7:this.currentAttackType===Xt.QUICK_JAB?1.3:1;this.gm.audioManager.play("swordSwing",{position:this.mesh.position,volume:.6,pitch:u})}this.hitThisSwing=!0}this._resetAttackTell()}if(this.stateTimer>=o){this.hitThisSwing=!1,this.activeAttack=null,this.lastAttackType=this.currentAttackType,this.attackVarietyEnabled&&(this.attackTypeCooldowns[this.currentAttackType]=3);const r=this.mesh.position.distanceTo(t.mesh.position);if((this.currentAttackType===Xt.COMBO||this.config.canChainAttacks&&this.comboHitsRemaining>0)&&r<=this.config.attackRange*1.3&&(this.comboHitsRemaining--,this.comboHitsRemaining>0)){this.currentAttackType=Xt.COMBO,this._changeState(q.ATTACK);return}if(this.config.canChainAttacks&&r<=this.config.attackRange*1.3&&(this.chainAttackCount++,this.chainAttackCount<this.config.maxChainAttacks)){this._changeState(q.ATTACK);return}this.chainAttackCount=0,this.comboHitsRemaining=0,this.currentAttackType=Xt.NORMAL,r<=this.config.attackRange?this._changeState(q.ATTACK):this._changeState(q.CHASE)}}_selectAttackType(e){const t=this.config.attackVariety||{};if(!t.enabled){this.currentAttackType=Xt.NORMAL;return}const i=e.mesh.position.clone();this.playerLastPos&&(this.playerMoveSpeed=i.distanceTo(this.playerLastPos)),this.playerLastPos=i;const s=this.playerMoveSpeed>.03,n=this.playerMoveSpeed<.01;for(const r in this.attackTypeCooldowns)this.attackTypeCooldowns[r]>0&&(this.attackTypeCooldowns[r]-=.016);const a=Math.random();let o=Xt.NORMAL;if(t.comboEnabled&&this.attackTypeCooldowns[Xt.COMBO]<=0){const r=t.comboChance||.3;a<r&&(o=Xt.COMBO,this.comboHitsRemaining=t.maxComboHits||2)}if(o===Xt.NORMAL&&n&&this.attackTypeCooldowns[Xt.HEAVY]<=0){const r=t.heavyChance||.25;a<r&&(o=Xt.HEAVY)}if(o===Xt.NORMAL&&s&&this.attackTypeCooldowns[Xt.QUICK_JAB]<=0){const r=t.quickJabChance||.3;a<r&&(o=Xt.QUICK_JAB)}o===this.lastAttackType&&o!==Xt.COMBO&&Math.random()<.5&&(o=Xt.NORMAL),this.currentAttackType=o}_showAttackTell(e,t){const i=this.gltfModel||this.fallbackBody;if(i){switch(e){case"heavy":i.rotation.x=-t*.35,i.position.y=t*.15,this.eye&&t>.3&&this.eye.material.emissive&&(this.eye.material.emissiveIntensity=4+t*4),(t>.5&&t<.55||t>.8&&t<.85)&&this._flashModel(16720418,50);break;case"jab":i.position.y=-t*.08;break;case"combo":i.rotation.x=t*.15,t>.6&&Math.random()<.3&&this._flashModel(16755200,30);break;default:i.rotation.x=-t*.1;break}this.attackTellActive=!0}}_resetAttackTell(){if(!this.attackTellActive)return;const e=this.gltfModel||this.fallbackBody;e&&(e.rotation.x=0,e.position.y=0),this.eye&&this.eye.material.emissive&&(this.eye.material.emissiveIntensity=4),this.attackTellActive=!1}takeDamage(e,t=0,i=null){if(this.state===q.DEAD)return"dead";if(this.state===q.BOSS_TRANSITION)return"immune";this.isBlocking&&(e=Math.floor(e*.3),t=Math.floor(t*.5),this._flashModel(4473958,100)),this.state===q.STAGGERED&&(t*=2),this.health-=e,this.posture=Math.min(this.maxPosture,this.posture+t),this.gm?.audioManager&&(this.gm.audioManager.play("hitImpact",{position:this.mesh.position,volume:.6,variation:.15}),this.gm.audioManager.playEnemyGrunt(this.mesh.position));const s=Math.max(0,this.health/this.maxHealth);return this.healthFill.scale.x=s,this.healthFill.position.x=-(1-s)*.49*.5,this.healthBarGroup.visible=!0,this._updatePostureBar(),this._flashModel(4456448,100),this._applyHitRecoil(i,e),this.health<=0?(this._die(),"died"):this.isBoss&&this.bossPhase===1&&this.health<=this.maxHealth*.5?(this._enterPhase2CryptLord(),"phase_transition"):this.posture>=this.maxPosture&&this.state!==q.STAGGERED?(this._triggerPostureBreak(),"staggered"):((this.state===q.IDLE||this.state===q.PATROL)&&this._changeState(q.CHASE),"hit")}_enterPhase2CryptLord(){this.bossPhase=2,this.posture=0,this.activeAttack=null,this.hitThisSwing=!1,this._changeState(q.BOSS_TRANSITION),this.world&&this.world.setBossArenaPhase&&this.world.setBossArenaPhase("transition"),this.gm?.audioManager&&this.gm.audioManager.play("bossRoar",{position:this.mesh.position,volume:1}),this.config.damage=55,this.config.postureDmg=45,this.config.moveSpeed=2.5,this.config.attackCooldown=1.2,this.config.maxPosture=250,this.maxPosture=250,this._cryptLordTransformSequence()}_cryptLordTransformSequence(){const t=Date.now(),i=this.gltfModel||this.fallbackBody,s=i?i.scale.clone():new T(1,1,1),n=s.clone().multiplyScalar(1.25);this.gm?.cameraController&&this.gm.cameraController.shake(.3,4);const a=()=>{const o=Date.now()-t,r=Math.min(o/4e3,1);if(this.state===q.BOSS_TRANSITION){if(i&&(i.scale.lerpVectors(s,n,r),i.rotation.z=Math.sin(o*.02)*.15*(1-r),i.rotation.x=Math.sin(o*.015)*.1*(1-r)),this.eye){const c=gt.lerp(1,1,r),h=gt.lerp(.13,0,r),d=gt.lerp(.13,1,r);this.eye.material.emissive&&(this.eye.material.emissiveIntensity=4+r*6,this.eye.material.emissive.setRGB(c,h,d)),this.eye.material.color.setRGB(c,h,d)}o%300<150&&this._flashModel(8930508,100),r<1?requestAnimationFrame(a):this._completeCryptLordTransform(i)}};a()}_completeCryptLordTransform(e){e&&(e.rotation.z=0,e.rotation.x=0),this.eye&&(this.eye.material.color.setHex(16711935),this.eye.material.emissive&&(this.eye.material.emissive.setHex(16711935),this.eye.material.emissiveIntensity=5)),this._applyModelTint(4465322),this.world&&this.world.setBossArenaPhase&&this.world.setBossArenaPhase("phase2"),this.bossAttackCooldown=.5,this._changeState(q.CHASE)}_flashModel(e,t){if(this.proceduralModel&&this.useProceduralAnimation){u1(this.proceduralModel,e,t);return}if(this.gltfModel&&(this.gltfModel.traverse(i=>{i.isMesh&&i.material&&(Array.isArray(i.material)?i.material:[i.material]).forEach(n=>{n.emissive&&(n.emissive.setHex(e),n.emissiveIntensity=.5)})}),setTimeout(()=>{this.gltfModel.traverse(i=>{i.isMesh&&i.material&&(Array.isArray(i.material)?i.material:[i.material]).forEach(n=>{n.emissive&&(n.emissive.setHex(0),n.emissiveIntensity=0)})})},t)),this.eye&&this.eye.material&&this.eye.material.emissive){const i=this.eye.material.emissive.getHex();this.eye.material.emissive.setHex(e),setTimeout(()=>{this.eye?.material?.emissive&&this.eye.material.emissive.setHex(i)},t)}}_applyHitRecoil(e,t){let i;if(e)i=new T().subVectors(this.mesh.position,e),i.y=0,i.normalize();else{const p=this.mesh.rotation.y;i=new T(-Math.sin(p),0,-Math.cos(p))}const s=Math.min(.5,t*.015),n=this.mesh.position.clone(),a=n.clone().add(i.multiplyScalar(s)),o=this.gltfModel||this.fallbackBody,r=o?o.rotation.z:0,c=Math.random()>.5?1:-1;o&&(o.rotation.z=r+c*.15);let h=0;const d=.12,u=()=>{h+=.016;const p=Math.min(1,h/d),f=1-Math.pow(1-p,3);this.mesh.position.lerpVectors(a,n,f),o&&(o.rotation.z=gt.lerp(r+c*.15,r,f)),p<1&&requestAnimationFrame(u)};this.mesh.position.copy(a),requestAnimationFrame(u)}_triggerPostureBreak(){this._changeState(q.STAGGERED),this.breakIndicator.visible=!0,this.gm?.audioManager&&this.gm.audioManager.play("postureBreak",{position:this.mesh.position,volume:.7}),this._flashModel(16763904,300),this.postureFill.material.color.setHex(16729088),setTimeout(()=>this.postureFill.material.color.setHex(16763904),300)}_updatePostureBar(){const e=this.posture/this.maxPosture;this.postureFill.scale.x=e,this.postureFill.position.x=-(1-e)*.49*.5}_die(){if(this.state=q.DEAD,this.isDead=!0,this.health=0,this.activeAttack=null,this.breakIndicator.visible=!1,this._playAnimation(q.DEAD,{loop:!1,clampWhenFinished:!0}),this.healthBarGroup.visible=!1,this.isBoss){if(this.bossActive=!1,this.world&&this.world.deactivateBossArena&&this.world.deactivateBossArena(),this.summonedAdds&&(this.summonedAdds.forEach(e=>{e&&!e.isDead&&e._die()}),this.summonedAdds=[]),this.activeProjectiles)for(let e=this.activeProjectiles.length-1;e>=0;e--)this._destroyProjectile(e);this.gm?.audioManager&&this.gm.audioManager.play("bossRoar",{position:this.mesh.position,volume:.8}),this._cryptLordDeathSequence();return}this._enemyDeathSequence()}_enemyDeathSequence(){const t=Date.now(),i=this.gltfModel||this.fallbackBody,s=i?.position.y||0,n=i?.rotation.x||0,a=i?.rotation.z||0,r=this.config.isElite?6684723:3355443;this.gm?.particleManager&&this.gm.particleManager.spawnDeathBurst(this.mesh.position.clone());const c=()=>{const h=Date.now()-t,d=Math.min(h/2500,1);if(i)if(d<.3){const u=d/.3;i.position.y=s-u*.4;const p=(this.mesh.uuid?.charCodeAt(0)||0)%2===0?1:-1;i.rotation.x=n+u*.4,i.rotation.z=a+u*.25*p;const f=(1-u)*.15,y=Math.sin(h*.025)*f;i.rotation.z+=y,i.rotation.y=Math.sin(h*.03)*f*.5}else{const u=(d-.3)/.7;i.position.y=s-.4-u*.3;const p=(this.mesh.uuid?.charCodeAt(0)||0)%2===0?1:-1;i.rotation.x=n+.4+u*.1,i.rotation.z=a+.25*p,h%150<75&&this._flashModel(r,30),i.traverse(y=>{y.isMesh&&y.material&&(Array.isArray(y.material)?y.material:[y.material]).forEach(g=>{g.transparent=!0,g.opacity=Math.max(0,1-u*1.2)})});const f=1-u*.15;if(i.scale.setScalar(f*(this.config.modelScale||1)),this.gm?.particleManager&&h%300<50&&u<.8){const y=this.mesh.position.clone().add(new T((Math.random()-.5)*.8,Math.random()*1.2,(Math.random()-.5)*.8));this.gm.particleManager.spawnHitSparks(y,2,!1)}}this.eye&&(this.eye.material.emissive&&(this.eye.material.emissiveIntensity=Math.max(0,3*(1-d*1.5))),this.eye.material.opacity!==void 0&&(this.eye.material.opacity=Math.max(0,1-d))),d<1?requestAnimationFrame(c):this.mesh.visible=!1};c()}_cryptLordDeathSequence(){const t=Date.now(),i=this.gltfModel||this.fallbackBody,s=this.mesh.position.clone();this.gm?.cameraController&&this.gm.cameraController.shake(.4,3),this.gm?.itemManager&&this.gm.itemManager.showVictoryNotification("THE CRYPT LORD");const n=()=>{const a=Date.now()-t,o=Math.min(a/5e3,1);if(i)if(o<.3){const r=o/.3;i.position.y=-r*.5,i.rotation.x=r*.3,i.rotation.z=r*.15}else{const r=(o-.3)/.7;a%200<100&&this._flashModel(8930508,50),i.traverse(c=>{c.isMesh&&c.material&&(Array.isArray(c.material)?c.material:[c.material]).forEach(d=>{d.transparent=!0,d.opacity=1-r})})}this.eye&&(this.eye.material.emissive&&(this.eye.material.emissiveIntensity=5*(1-o)),this.eye.material.opacity=1-o),o<1?requestAnimationFrame(n):(this.mesh.visible=!1,this._spawnCryptLordRewards(s))};n()}_spawnCryptLordRewards(e){if(!this.gm?.itemManager)return;const i=Math.random()<.5?Bl.CRYPT_LORDS_GREATSWORD:Bl.LORD_SOUL_FRAGMENT;this.gm.itemManager.spawnBossRewards(e,"crypt-lord",this.config.remnantDrop||2500,i),this.bossDefeated=!0,this.enemyManager&&this.enemyManager.markBossDefeated("crypt-lord")}_fadeOutModel(){const e=this.gltfModel||this.fallbackBody;if(!e)return;e.traverse(i=>{i.isMesh&&i.material&&(Array.isArray(i.material)?i.material:[i.material]).forEach(n=>{n.transparent=!0})});const t=()=>{let i=!0;e.traverse(s=>{s.isMesh&&s.material&&(Array.isArray(s.material)?s.material:[s.material]).forEach(a=>{a.opacity>0&&(a.opacity-=.02,i=!1)})}),i?this.mesh.visible=!1:requestAnimationFrame(t)};t()}respawn(){this.health=this.maxHealth,this.posture=0,this.isDead=!1,this.stateTimer=0,this.chainAttackCount=0,this.circleTimer=0,this.isBlocking=!1,this.stuckTimer=0,this.unstuckAttempts=0,this.avoidanceDir=null,this.avoidanceTimer=0,this.isRetreating=!1,this.retreatStartPos=null,this.retreatWallHits=0,this._resetGroupState();let e=this.spawnPos.clone();if(this.world&&this.world.checkCollision&&this.world.checkCollision(e,this.collisionRadius).collides){const s=[new T(1,0,0),new T(-1,0,0),new T(0,0,1),new T(0,0,-1),new T(1,0,1),new T(-1,0,1),new T(1,0,-1),new T(-1,0,-1)];for(const n of s){const a=this.spawnPos.clone().add(n);if(!this.world.checkCollision(a,this.collisionRadius).collides){e=a;break}}}this.mesh.position.copy(e),this.lastPosition.copy(e);const t=this.config.behavior==="ambush"||this.config.isAmbush;this.isDormant=t,this.state=t?q.DORMANT:q.IDLE;const i=this.gltfModel||this.fallbackBody;i&&(i.rotation.x=0,i.rotation.z=0,i.position.y=0,i.traverse(s=>{s.isMesh&&s.material&&(Array.isArray(s.material)?s.material:[s.material]).forEach(a=>{a.opacity=1,a.transparent=!1})})),this.mesh.visible=!t,this.healthBarGroup.visible=!1,this.breakIndicator.visible=!1,this.healthFill.scale.x=1,this.healthFill.position.x=0,this.postureFill.scale.x=0,this.postureFill.position.x=0,this._playAnimation(t?q.DORMANT:q.IDLE,{loop:!0})}_moveToward(e,t,i){const s=new T().subVectors(e,this.mesh.position);if(s.y=0,s.length()<.5)return;s.normalize();const a=t*i,o=this.mesh.position.clone().addScaledVector(s,a);if(this.world&&this.world.checkCollision){const r=this.world.checkCollision(o,this.collisionRadius);if(r.collides){const c=this._findSlideDirection(s,r,i);if(c){const h=this.mesh.position.clone().addScaledVector(c,a*.7);this.world.checkCollision(h,this.collisionRadius).collides?this._tryPerpendicularMove(s,a,i):(this.mesh.position.copy(h),this.avoidanceDir=c.clone(),this.avoidanceTimer=.5)}else this._tryPerpendicularMove(s,a,i)}else this.mesh.position.copy(o),this.avoidanceDir=null,this.avoidanceTimer=0}else this.mesh.position.addScaledVector(s,a);if(this.world&&this.world.terrain&&this.world.terrain.getTerrainHeight){const r=this.world.terrain.getTerrainHeight(this.mesh.position.x,this.mesh.position.z);this.mesh.position.y=r+.3}}_findSlideDirection(e,t,i){const s=new T(-e.z,0,e.x),n=new T(e.z,0,-e.x);if(t.normal){const a=e.dot(t.normal),o=e.clone().sub(t.normal.clone().multiplyScalar(a));if(o.length()>.1)return o.normalize()}return this.avoidanceDir&&this.avoidanceTimer>0?(this.avoidanceTimer-=i,this.avoidanceDir):this.unstuckAttempts%2===0?s:n}_tryPerpendicularMove(e,t,i){if(!this.world)return;const s=new T(-e.z,0,e.x),n=new T(e.z,0,-e.x),a=this.mesh.position.clone().addScaledVector(s,t);if(!this.world.checkCollision(a,this.collisionRadius).collides){this.mesh.position.copy(a),this.avoidanceDir=s,this.avoidanceTimer=.3;return}const o=this.mesh.position.clone().addScaledVector(n,t);if(!this.world.checkCollision(o,this.collisionRadius).collides){this.mesh.position.copy(o),this.avoidanceDir=n,this.avoidanceTimer=.3;return}}_checkStuck(e){if(this.mesh.position.distanceTo(this.lastPosition)<.05){if(this.stuckTimer+=e,this.stuckTimer>this.stuckThreshold)if(this.unstuckAttempts++,this.stuckTimer=0,this.unstuckAttempts>3){if(this._pickPatrolTarget(),this.world&&this.world.checkCollision){let i=0;for(;this.world.checkCollision(this.patrolTarget,this.collisionRadius).collides&&i<5;)this._pickPatrolTarget(),i++}this.unstuckAttempts=0,this._changeState(q.PATROL)}else this.circleDirection*=-1,(this.state===q.CHASE||this.state===q.CIRCLE)&&this._changeState(q.CIRCLE)}else this.stuckTimer=0,this.unstuckAttempts=0;this.lastPosition.copy(this.mesh.position)}_faceTarget(e,t){const i=new T().subVectors(e,this.mesh.position);if(i.y=0,i.length()>.1){const s=Math.atan2(i.x,i.z);this.mesh.rotation.y=gt.lerp(this.mesh.rotation.y,s,5*t)}}_pickPatrolTarget(){const e=Math.random()*Math.PI*2,t=Math.random()*this.config.patrolRadius;this.patrolTarget.set(this.spawnPos.x+Math.cos(e)*t,0,this.spawnPos.z+Math.sin(e)*t)}_changeState(e){this.state!==e&&(this.state===q.ATTACK&&(this.activeAttack=null,this.hitThisSwing=!1),e===q.CIRCLE&&(this.circleTimer=0,this.circleDirection=Math.random()>.5?1:-1),this.state=e,this.stateTimer=0,this._playAnimation(e))}}const Xe={DORMANT:"dormant",AWAKENING:"awakening",IDLE:"idle",WALK:"walk",ATTACK:"attack",HEAVY_ATTACK:"heavy_attack",AOE_ATTACK:"aoe_attack",COMBO:"combo",STAGGERED:"staggered",PHASE_TRANSITION:"phase_transition",DEAD:"dead"},f1={[Xe.DORMANT]:"Idle",[Xe.AWAKENING]:"Idle",[Xe.IDLE]:"Idle",[Xe.WALK]:"Walking",[Xe.ATTACK]:"Punch",[Xe.HEAVY_ATTACK]:"Punch",[Xe.AOE_ATTACK]:"Jump",[Xe.COMBO]:"Punch",[Xe.STAGGERED]:"No",[Xe.PHASE_TRANSITION]:"Death",[Xe.DEAD]:"Death"};class m1{constructor(e,t,i){this.scene=e,this.gm=i,this.name="The Failed Experiment",this.maxHealth=500,this.health=this.maxHealth,this.maxPosture=150,this.posture=0,this.phase=1,this.state=Xe.DORMANT,this.stateTimer=0,this.hitThisSwing=!1,this.activeAttack=null,this.comboCount=0,this.isActive=!1,this.isDead=!1,this.mixer=null,this.animations={},this.currentAction=null,this.gltfModel=null,this.gltfLoaded=!1,this.phaseConfigs={1:{moveSpeed:2,attackCooldown:2.5,attackWindup:1,damage:35,postureDmg:30,canCombo:!1,canAoE:!1,modelTint:3809344,emissiveColor:2228258},2:{moveSpeed:3.5,attackCooldown:1.5,attackWindup:.6,damage:45,postureDmg:40,canCombo:!0,maxCombo:3,canAoE:!0,aoeCooldown:8,modelTint:5902368,emissiveColor:4456465}},this.config=this.phaseConfigs[1],this.attackCooldownTimer=0,this.aoeCooldownTimer=0,this.detectionRange=15,this.attackRange=3.5,this.spawnPos=t.clone(),this.world=null,this.collisionRadius=.8,this.mesh=new ne,this.mesh.position.copy(t),this.body=new ne,this.mesh.add(this.body),this._createFallbackMesh(),this.eyeLights=[],this.eyes=[],this._createEyes(),this.weapon=this._createWeapon(),this.mesh.add(this.weapon),this._createAoEIndicator(),this._createAuraParticles(),this.mutatedArm=null,e.add(this.mesh),this._loadGLTFModel(),this._setDormant()}_createFallbackMesh(){const e=new Ni(1.2,2),t=new X({color:1709344,roughness:.75,metalness:.25,flatShading:!0});this.fallbackMesh=new w(e,t),this.fallbackMesh.position.y=2,this.fallbackMesh.scale.set(1.3,1.6,1.2),this.fallbackMesh.castShadow=!0,this.body.add(this.fallbackMesh);const i=new Ni(.7,1),s=new w(i,t.clone());s.position.set(0,2.8,-.6),s.scale.set(1.3,1,.9),this.body.add(s);for(let y=0;y<12;y++){const m=.12+Math.random()*.2,g=new re(m,6,6),x=new X({color:2759205,roughness:.9,emissive:1114120,emissiveIntensity:.3}),v=new w(g,x),b=y/12*Math.PI*2,_=1.3+Math.random()*2,S=.8+Math.random()*.4;v.position.set(Math.cos(b)*S+(Math.random()-.5)*.3,_,Math.sin(b)*(S*.7)+(Math.random()-.5)*.3),this.body.add(v)}const n=new X({color:9075306,roughness:.6,metalness:.3});for(let y=0;y<6;y++){const m=new Ai(.4-y*.035,.035,6,16,Math.PI*.75),g=new w(m,n);g.position.set(0,1.4+y*.18,.7),g.rotation.x=Math.PI/2,g.rotation.y=Math.PI,this.body.add(g)}const a=new js(.5,1),o=new X({color:1709088,roughness:.7,metalness:.25}),r=new w(a,o);r.position.set(0,3.6,.35),r.scale.set(1,1.2,.85),this.body.add(r);const c=new X({color:1709344,roughness:.75,metalness:.2}),h=new Pt(.22,1,10,12),d=new w(h,c);d.position.set(-.45,.6,0),d.rotation.z=.15,this.body.add(d);const u=new Pt(.24,.95,10,12),p=new w(u,c);p.position.set(.45,.6,0),p.rotation.z=-.12,this.body.add(p);const f=new X({color:2236962,roughness:.4,metalness:.6});for(let y of[-1,1])for(let m=0;m<3;m++){const g=new wt(.05,.18,6),x=new w(g,f);x.position.set(y*.45+(m-1)*.1,.05,.25),x.rotation.x=Math.PI/3,this.body.add(x)}}async _loadGLTFModel(){try{const e="/project-ashen/",{scene:t,animations:i}=await or.loadModel(`${e}assets/models/brainrobot.glb`,{scale:2.5});if(!t){console.warn("[BOSS] GLTF model failed to load, using fallback");return}this.gltfModel=t,this.gltfLoaded=!0,t.position.set(0,.5,0),t.scale.setScalar(2.5),this._applyModelTint(this.config.modelTint,this.config.emissiveColor),t.traverse(s=>{s.isMesh&&(s.castShadow=!0,s.receiveShadow=!0)}),i&&i.length>0&&(this.mixer=new Pm(t),i.forEach(s=>{this.animations[s.name]=this.mixer.clipAction(s)}),this._playAnimation(Xe.IDLE)),this.body.add(t),this.fallbackMesh&&(this.fallbackMesh.visible=!1)}catch(e){console.warn("[BOSS] GLTF loading failed:",e)}}_applyModelTint(e,t){if(!this.gltfModel)return;const i=new H(e),s=new H(t);this.gltfModel.traverse(n=>{n.isMesh&&n.material&&(Array.isArray(n.material)?n.material:[n.material]).forEach(o=>{o.color&&o.color.lerp(i,.4),o.emissive!==void 0&&(o.emissive.copy(s),o.emissiveIntensity=.5),o.needsUpdate=!0})}),this.body.traverse(n=>{n.isMesh&&n.material&&n!==this.gltfModel&&(Array.isArray(n.material)?n.material:[n.material]).forEach(o=>{o.color&&o.color.lerp(i,.3),o.emissive!==void 0&&(o.emissive.copy(s),o.emissiveIntensity=.4)})})}_playAnimation(e,t=1){if(!this.mixer)return;const i=f1[e];if(!i)return;let s=this.animations[i];if(!s){const n=i.toLowerCase();for(const a of Object.keys(this.animations))if(a.toLowerCase().includes(n)){s=this.animations[a];break}}s&&(this.currentAction&&this.currentAction!==s?(s.reset(),s.setEffectiveTimeScale(t),s.setEffectiveWeight(1),s.crossFadeFrom(this.currentAction,.3,!0),s.play()):this.currentAction||(s.reset(),s.setEffectiveTimeScale(t),s.play()),this.currentAction=s)}_createEyes(){const e=[{x:-.18,y:3.55,z:.6,size:.11},{x:.18,y:3.55,z:.6,size:.11},{x:0,y:3.75,z:.55,size:.085},{x:-.38,y:3.35,z:.45,size:.06},{x:.38,y:3.35,z:.45,size:.06},{x:-.85,y:3.1,z:.3,size:.05},{x:-.95,y:2.9,z:.35,size:.04},{x:.12,y:2.85,z:-.35,size:.07}],t=new X({color:16720384,emissive:16720384,emissiveIntensity:5});e.forEach(i=>{const s=new re(i.size,12,12),n=new w(s,t.clone());if(n.position.set(i.x,i.y,i.z),this.eyes.push(n),this.body.add(n),i.size>=.08){const a=new We(16720384,.5,3);a.position.copy(n.position),this.eyeLights.push(a),this.body.add(a)}})}_createWeapon(){const e=new ne,t=new ce(.08,.1,2,12),i=new X({color:3811872,roughness:.85,metalness:.15}),s=new w(t,i);e.add(s);for(let d=0;d<5;d++){const u=new Ai(.11,.025,6,14),p=new w(u,new X({color:4860456,roughness:.9}));p.position.y=-.7+d*.35,p.rotation.x=Math.PI/2,e.add(p)}const n=new ie(.1,1.8,.6),a=new X({color:2763306,roughness:.25,metalness:.95}),o=new w(n,a);o.position.set(0,1.5,.18),o.rotation.z=.12,e.add(o);const r=new ie(.025,1.75,.025),c=new X({color:16724736,emissive:16720384,emissiveIntensity:3}),h=new w(r,c);h.position.set(0,1.5,.5),h.rotation.z=.12,e.add(h);for(let d=0;d<6;d++){const u=new wt(.04,.15,6),p=new w(u,a);p.position.set(0,.85+d*.22,-.1),p.rotation.x=-Math.PI/4,e.add(p)}return e.position.set(1.6,1.9,0),e.rotation.z=.4,e.castShadow=!0,e}_createAoEIndicator(){const e=new Ki(.5,6,32),t=new B({color:16729088,transparent:!0,opacity:0,side:lt});this.aoeIndicator=new w(e,t),this.aoeIndicator.rotation.x=-Math.PI/2,this.aoeIndicator.position.y=.1,this.mesh.add(this.aoeIndicator)}_createAuraParticles(){this.auraParticles=[];for(let e=0;e<8;e++){const t=new re(.1,6,6),i=new X({color:2228258,emissive:1114129,emissiveIntensity:1.5,transparent:!0,opacity:.7}),s=new w(t,i);s.userData.angle=e/8*Math.PI*2,s.userData.yOffset=Math.random()*2,s.userData.radius=.9+Math.random()*.5,this.auraParticles.push(s),this.mesh.add(s)}}_setDormant(){this.eyes.forEach(e=>{e.material.emissive&&(e.material.emissiveIntensity=.5)}),this.eyeLights.forEach(e=>{e.intensity=.1})}_awaken(){if(this.state!==Xe.DORMANT)return;this.isActive=!0,this._changeState(Xe.AWAKENING),this.gm?.audioManager&&(this.gm.audioManager.play("bossRoar",{position:this.mesh.position,volume:.8}),this.gm.audioManager.startBossMusic());let e=0;this.eyes.forEach((t,i)=>{setTimeout(()=>{t.material.emissive&&(t.material.emissiveIntensity=7,setTimeout(()=>{t.material.emissive&&(t.material.emissiveIntensity=4.5)},200))},e),e+=120}),this.eyeLights.forEach((t,i)=>{setTimeout(()=>{t.intensity=.8},i*100)})}update(e,t){if(this.state===Xe.DEAD)return;this.mixer&&this.mixer.update(e),this.stateTimer+=e,this.attackCooldownTimer=Math.max(0,this.attackCooldownTimer-e),this.aoeCooldownTimer=Math.max(0,this.aoeCooldownTimer-e);const i=this.mesh.position.distanceTo(t.mesh.position);if(this.state===Xe.DORMANT&&i<this.detectionRange){this._awaken();return}switch(this.state){case Xe.AWAKENING:this.stateTimer<2?(this.body.position.y=Math.sin(this.stateTimer*Math.PI)*.4,this.body.rotation.z=Math.sin(this.stateTimer*3)*.05):(this.body.position.y=0,this.body.rotation.z=0,this._changeState(Xe.IDLE));break;case Xe.IDLE:this._faceTarget(t.mesh.position,e),this.body.position.y=Math.sin(this.stateTimer*2)*.08,this.body.scale.y=1+Math.sin(this.stateTimer*2.5)*.02,i<=this.attackRange&&this.attackCooldownTimer<=0?this._startAttack(t):i>this.attackRange&&this._changeState(Xe.WALK);break;case Xe.WALK:this._moveToward(t.mesh.position,e),this._faceTarget(t.mesh.position,e),this.body.position.y=Math.sin(this.stateTimer*8)*.12,this.body.rotation.z=Math.sin(this.stateTimer*4)*.03,i<=this.attackRange&&(this.attackCooldownTimer<=0?this._startAttack(t):this._changeState(Xe.IDLE));break;case Xe.ATTACK:this._processAttack(e,t,!1);break;case Xe.HEAVY_ATTACK:this._processAttack(e,t,!0);break;case Xe.AOE_ATTACK:this._processAoEAttack(e,t);break;case Xe.COMBO:this._processCombo(e,t);break;case Xe.STAGGERED:this.body.rotation.z=Math.sin(this.stateTimer*14)*.18*(1-this.stateTimer/2.5),this.body.position.y=Math.sin(this.stateTimer*8)*.1,this.stateTimer>=2.5&&(this.posture=0,this.body.rotation.z=0,this.body.position.y=0,this._changeState(Xe.IDLE));break;case Xe.PHASE_TRANSITION:this._processPhaseTransition(e);break}this.state!==Xe.STAGGERED&&this.posture>0&&(this.posture=Math.max(0,this.posture-3*e));const s=this.health/this.maxHealth,n=2+(1-s)*5,a=3.5+Math.sin(Date.now()*.001*n)*(1.5+(1-s)*2.5);if(this.eyes.forEach(o=>{o.material.emissive&&(o.material.emissiveIntensity=a)}),this.eyeLights.forEach(o=>{o.intensity=.3+a*.1}),this.auraParticles&&this.isActive){const o=Date.now()*.001;this.auraParticles.forEach((r,c)=>{const h=r.userData.angle+o*.6,d=r.userData.yOffset+Math.sin(o+c)*.4,u=r.userData.radius;r.position.set(Math.cos(h)*u,1.6+d,Math.sin(h)*u),r.material.opacity=.35+Math.sin(o*2.5+c)*.25})}}_startAttack(e){if(this.phase===2&&this.config.canAoE&&this.aoeCooldownTimer<=0&&Math.random()<.3){this._changeState(Xe.AOE_ATTACK);return}if(this.phase===2&&this.config.canCombo&&Math.random()<.4){this.comboCount=0,this._changeState(Xe.COMBO);return}Math.random()<.5?this._changeState(Xe.ATTACK):this._changeState(Xe.HEAVY_ATTACK)}_processAttack(e,t,i){const s=i?this.config.attackWindup*1.5:this.config.attackWindup,n=s+.3,a=n+(i?1:.6);if(this.stateTimer<s){this._faceTarget(t.mesh.position,e*2);const o=this.stateTimer/s;i?(this.weapon.rotation.z=-o*2.8,this.weapon.position.y=1.9+o*1.6,this.body.rotation.x=o*.15):(this.weapon.rotation.z=.4-o*1.6,this.body.rotation.z=o*.1);return}if(this.stateTimer>=s&&this.stateTimer<n){if(!this.hitThisSwing){const r=new T(Math.sin(this.body.rotation.y),0,Math.cos(this.body.rotation.y));this.activeAttack={position:this.mesh.position.clone().add(r.multiplyScalar(2.2)).add(new T(0,1.6,0)),range:this.attackRange,damage:i?this.config.damage*1.5:this.config.damage,postureDmg:i?this.config.postureDmg*1.5:this.config.postureDmg,isHeavy:i},this.gm?.audioManager&&this.gm.audioManager.play("swordSwing",{position:this.mesh.position,volume:.7,pitch:i?.6:.8})}const o=(this.stateTimer-s)/.3;i?(this.weapon.rotation.z=-2.8+o*4.5,this.weapon.position.y=3.5-o*2.8,this.body.rotation.x=.15-o*.25):(this.weapon.rotation.z=-1.2+o*2.8,this.body.rotation.z=.1-o*.15)}this.stateTimer>=n&&(this.activeAttack=null,this.weapon.rotation.z=gt.lerp(this.weapon.rotation.z,.4,.12),this.weapon.position.y=gt.lerp(this.weapon.position.y,1.9,.12),this.body.rotation.x=gt.lerp(this.body.rotation.x,0,.15),this.body.rotation.z=gt.lerp(this.body.rotation.z,0,.15)),this.stateTimer>=a&&(this.hitThisSwing=!1,this.activeAttack=null,this.attackCooldownTimer=this.config.attackCooldown,this._resetWeapon(),this._changeState(Xe.IDLE))}_processCombo(e,t){const i=this.config.attackWindup*.7,s=i+.2,n=s+.3;if(this.stateTimer<i){this._faceTarget(t.mesh.position,e*3);const a=this.stateTimer/i,o=this.comboCount%2===0?1:-1;this.weapon.rotation.z=o*a*1.8,this.body.rotation.z=o*a*.08;return}if(this.stateTimer>=i&&this.stateTimer<s){if(!this.hitThisSwing){const r=new T(Math.sin(this.body.rotation.y),0,Math.cos(this.body.rotation.y));this.activeAttack={position:this.mesh.position.clone().add(r.multiplyScalar(2.2)).add(new T(0,1.6,0)),range:this.attackRange*.9,damage:this.config.damage*.7,postureDmg:this.config.postureDmg*.6,isCombo:!0},this.gm?.audioManager&&this.gm.audioManager.play("swordSwing",{position:this.mesh.position,volume:.6,pitch:.9+this.comboCount*.1})}const a=(this.stateTimer-i)/.2,o=this.comboCount%2===0?1:-1;this.weapon.rotation.z=o*(1.8-a*3.5),this.body.rotation.z=o*(.08-a*.12)}if(this.stateTimer>=n){this.comboCount++,this.hitThisSwing=!1,this.activeAttack=null;const a=this.mesh.position.distanceTo(t.mesh.position);if(this.comboCount<this.config.maxCombo&&a<this.attackRange*1.2){this.stateTimer=0;const o=new T(Math.sin(this.body.rotation.y),0,Math.cos(this.body.rotation.y));this.mesh.position.addScaledVector(o,.6)}else this.comboCount=0,this.attackCooldownTimer=this.config.attackCooldown*1.5,this._resetWeapon(),this._changeState(Xe.IDLE)}}_processAoEAttack(e,t){if(this.stateTimer<1.5){const a=this.stateTimer/1.5;this.aoeIndicator.material.opacity=a*.65,this.aoeIndicator.scale.setScalar(1+a*.35),this.weapon.rotation.z=-a*3.2,this.weapon.position.y=1.9+a*2.2,this._flashModel(a*.5,16720384),this.eyes.forEach(o=>{o.material.emissive&&(o.material.emissiveIntensity=4+a*7)}),this.body.position.y=Math.sin(this.stateTimer*20)*.05*a;return}this.stateTimer>=1.5&&this.stateTimer<1.8&&(this.hitThisSwing||(this.hitThisSwing=!0,this.aoeIndicator.material.opacity=1,this.aoeIndicator.material.color.setHex(16737792),this.gm?.audioManager&&this.gm.audioManager.play("explosion",{position:this.mesh.position,volume:.9}),this.mesh.position.distanceTo(t.mesh.position)<6&&!t.isInvincible&&(this.activeAttack={position:this.mesh.position.clone(),range:6,damage:this.config.damage*1.2,postureDmg:this.config.postureDmg,isAoE:!0}),this.weapon.rotation.z=.6,this.weapon.position.y=.6)),this.stateTimer>=1.8&&(this.activeAttack=null,this.aoeIndicator.material.opacity*=.88,this._flashModel(0,0)),this.stateTimer>=2.8&&(this.hitThisSwing=!1,this.aoeIndicator.material.opacity=0,this.aoeIndicator.material.color.setHex(16729088),this.aoeCooldownTimer=this.config.aoeCooldown,this.attackCooldownTimer=this.config.attackCooldown,this._resetWeapon(),this._changeState(Xe.IDLE))}_processPhaseTransition(e){if(this.stateTimer<3){this.body.rotation.z=Math.sin(this.stateTimer*22)*.25,this.body.scale.y=1+Math.sin(this.stateTimer*12)*.15,this.body.scale.x=1+Math.sin(this.stateTimer*10)*.08,this.eyes.forEach((a,o)=>{a.material.emissive&&(a.material.emissiveIntensity=6+Math.sin(this.stateTimer*18+o)*5)});const i=this.stateTimer/3,s=new H(this.phaseConfigs[1].modelTint),n=new H(this.phaseConfigs[2].modelTint);s.lerp(n,i),this._applyModelTint(s.getHex(),this.phaseConfigs[2].emissiveColor),this.stateTimer>1.5&&!this.mutatedArm&&this._createMutatedArm();return}this.body.rotation.z=0,this.body.scale.set(1,1,1),this._applyModelTint(this.phaseConfigs[2].modelTint,this.phaseConfigs[2].emissiveColor),this.eyes.forEach(i=>{i.material.color.setHex(16729088),i.material.emissive&&i.material.emissive.setHex(16729088)}),this._changeState(Xe.IDLE)}_createMutatedArm(){this.mutatedArm=new ne;const e=new Pt(.18,1.2,12,16),t=new X({color:3806504,roughness:.85,metalness:.15}),i=new w(e,t);i.position.set(0,0,0),i.rotation.z=.7,i.rotation.x=.45,this.mutatedArm.add(i);const s=new X({color:2236962,roughness:.35,metalness:.75});for(let o=0;o<4;o++){const r=new wt(.04,.25,6),c=new w(r,s);c.position.set(-.5+(o-1.5)*.1,.7,.8),c.rotation.x=-.85,this.mutatedArm.add(c)}for(let o=0;o<4;o++){const r=new re(.07+Math.random()*.05,6,6),c=new X({color:4859960,roughness:.9,emissive:1114120,emissiveIntensity:.4}),h=new w(r,c);h.position.set(-.25+o*.18,.25+o*.18,.4),this.mutatedArm.add(h)}this.mutatedArm.position.set(-1.1,2.7,.25),this.mesh.add(this.mutatedArm);const n=new X({color:16729088,emissive:16729088,emissiveIntensity:5});[{x:-1.3,y:2.9,z:.55,size:.07},{x:-1.1,y:2.5,z:.65,size:.055},{x:.55,y:3.1,z:.4,size:.045}].forEach(o=>{const r=new w(new re(o.size,10,10),n.clone());r.position.set(o.x,o.y,o.z),this.eyes.push(r),this.mesh.add(r)})}_flashModel(e,t){const i=new H(t);this.gltfModel&&this.gltfModel.traverse(s=>{s.isMesh&&s.material&&s.material.emissive!==void 0&&(s.material.emissive.lerp(i,e),s.material.emissiveIntensity=e*2)}),this.body.traverse(s=>{s.isMesh&&s.material&&s.material.emissive!==void 0&&s.material.emissive.lerp(i,e)})}takeDamage(e,t=0,i=null){return this.state===Xe.DEAD||this.state===Xe.PHASE_TRANSITION||this.state===Xe.DORMANT?"immune":(this.state===Xe.AWAKENING&&(e=Math.floor(e*.5),t=Math.floor(t*.5)),this.state===Xe.STAGGERED&&(t*=2),this.health-=e,this.posture=Math.min(this.maxPosture,this.posture+t),this.gm?.audioManager&&this.gm.audioManager.play("criticalHit",{position:this.mesh.position,volume:.7}),this._flashModel(.6,16720384),setTimeout(()=>{this.state!==Xe.AOE_ATTACK&&this._flashModel(0,0)},100),this._applyHitRecoil(i,e),this.health<=0?(this._die(),"died"):this.phase===1&&this.health<=this.maxHealth*.5?(this._enterPhase2(),"phase_transition"):this.posture>=this.maxPosture&&this.state!==Xe.STAGGERED?(this._triggerPostureBreak(),"staggered"):"hit")}_applyHitRecoil(e,t){let i;if(e)i=new T().subVectors(this.mesh.position,e),i.y=0,i.normalize();else{const u=this.body.rotation.y;i=new T(-Math.sin(u),0,-Math.cos(u))}const s=Math.min(.25,t*.006),n=this.mesh.position.clone(),a=n.clone().add(i.multiplyScalar(s)),o=this.body.rotation.z||0,r=Math.random()>.5?1:-1;this.body.rotation.z=o+r*.1;let c=0;const h=.15,d=()=>{c+=.016;const u=Math.min(1,c/h),p=1-Math.pow(1-u,3);this.mesh.position.lerpVectors(a,n,p),this.body.rotation.z=gt.lerp(o+r*.1,o,p),u<1&&requestAnimationFrame(d)};this.mesh.position.copy(a),requestAnimationFrame(d)}_triggerPostureBreak(){this._changeState(Xe.STAGGERED),this.activeAttack=null,this.gm?.audioManager&&this.gm.audioManager.play("postureBreak",{position:this.mesh.position,volume:.9}),this._flashModel(1,16763904),this.eyes.forEach(e=>{e.material.emissive&&e.material.emissive.setHex(16763904)}),setTimeout(()=>{this.state===Xe.STAGGERED&&(this._flashModel(0,0),this.eyes.forEach(e=>{e.material.emissive&&e.material.emissive.setHex(this.phase===2?16729088:16720384)}))},300)}_enterPhase2(){this.phase=2,this.config=this.phaseConfigs[2],this.posture=0,this.activeAttack=null,this._changeState(Xe.PHASE_TRANSITION),this.gm?.audioManager&&this.gm.audioManager.play("bossRoar",{position:this.mesh.position,volume:1})}_die(){this.state=Xe.DEAD,this.isDead=!0,this.health=0,this.activeAttack=null,this.isActive=!1,this._playAnimation(Xe.DEAD,.8),this.gm?.audioManager&&this.gm.audioManager.startAmbientMusic();let e=0;const t=()=>{e+=.018,this.body.position.y=-e*1.8,this.body.rotation.x=e*.6,this.body.rotation.z=e*.3,this.eyes.forEach(i=>{i.material.emissive&&(i.material.emissiveIntensity*=.94)}),this.eyeLights.forEach(i=>{i.intensity*=.92}),e<1?requestAnimationFrame(t):this._fadeOut()};t(),this.gm&&this.gm.collectRemnants(2e3)}_fadeOut(){let e=1;const t=()=>{e-=.008;const i=s=>{s.isMesh&&s.material&&(Array.isArray(s.material)?s.material:[s.material]).forEach(a=>{a.transparent=!0,a.opacity=e})};this.body.traverse(i),this.weapon.traverse(i),this.eyes.forEach(s=>{s.material.transparent=!0,s.material.opacity=e}),this.auraParticles&&this.auraParticles.forEach(s=>{s.material.opacity=e*.6}),this.mutatedArm&&this.mutatedArm.traverse(i),e>0?requestAnimationFrame(t):this.mesh.visible=!1};setTimeout(t,3e3)}_moveToward(e,t){const i=new T().subVectors(e,this.mesh.position);if(i.y=0,i.length()>.5){i.normalize();const s=this.config.moveSpeed*t,n=this.mesh.position.clone().addScaledVector(i,s);this.world&&this.world.checkCollision?this.world.checkCollision(n,this.collisionRadius).collides||this.mesh.position.copy(n):this.mesh.position.addScaledVector(i,s)}}_faceTarget(e,t){const i=new T().subVectors(e,this.mesh.position);if(i.y=0,i.length()>.1){const s=Math.atan2(i.x,i.z);this.body.rotation.y=gt.lerp(this.body.rotation.y,s,5*t)}}_resetWeapon(){this.weapon.rotation.z=.4,this.weapon.position.set(1.6,1.9,0),this.body.rotation.x=0,this.body.rotation.z=0}_changeState(e){this.state!==e&&((this.state===Xe.ATTACK||this.state===Xe.HEAVY_ATTACK||this.state===Xe.AOE_ATTACK||this.state===Xe.COMBO)&&(this.activeAttack=null,this.hitThisSwing=!1),this.state=e,this.stateTimer=0,this._playAnimation(e))}respawn(){this.health=this.maxHealth,this.posture=0,this.phase=1,this.config=this.phaseConfigs[1],this.state=Xe.DORMANT,this.stateTimer=0,this.isActive=!1,this.isDead=!1,this.comboCount=0,this.attackCooldownTimer=0,this.aoeCooldownTimer=0,this.mesh.position.copy(this.spawnPos),this.mesh.visible=!0,this.body.position.set(0,0,0),this.body.rotation.set(0,0,0),this.body.scale.set(1,1,1);const e=t=>{t.isMesh&&t.material&&(Array.isArray(t.material)?t.material:[t.material]).forEach(s=>{s.opacity=1,s.transparent=!1,s.emissive&&s.emissive.setHex(0)})};for(this.body.traverse(e),this.weapon.traverse(e),this._resetWeapon();this.eyes.length>8;){const t=this.eyes.pop();t&&this.mesh.remove(t)}this.eyes.forEach(t=>{t.material.opacity=1,t.material.transparent=!1,t.material.color.setHex(16720384),t.material.emissive&&t.material.emissive.setHex(16720384)}),this.eyeLights.forEach(t=>{t.intensity=.1}),this.mutatedArm&&(this.mesh.remove(this.mutatedArm),this.mutatedArm=null),this._applyModelTint(this.phaseConfigs[1].modelTint,this.phaseConfigs[1].emissiveColor),this.aoeIndicator.material.opacity=0,this._setDormant(),this._playAnimation(Xe.IDLE)}}const Xn={SAFE:{maxDistance:50,hpMultiplier:.8,damageMultiplier:.7,remnantMultiplier:.8,spawnDensity:.3,enemyTypes:["HOLLOW_SOLDIER"],eliteChance:0,label:"Safe Zone"},MEDIUM:{maxDistance:150,hpMultiplier:1,damageMultiplier:1,remnantMultiplier:1,spawnDensity:.5,enemyTypes:["HOLLOW_SOLDIER","BERSERKER"],eliteChance:.05,label:"Medium Zone"},HARD:{maxDistance:300,hpMultiplier:1.3,damageMultiplier:1.2,remnantMultiplier:1.5,spawnDensity:.7,enemyTypes:["HOLLOW_SOLDIER","BERSERKER","SENTINEL"],eliteChance:.15,label:"Hard Zone"},FRONTIER:{maxDistance:1/0,hpMultiplier:1.6,damageMultiplier:1.4,remnantMultiplier:2,spawnDensity:.9,enemyTypes:["BERSERKER","SENTINEL","CRYPT_GUARDIAN"],eliteChance:.25,label:"Dark Frontier"}};function Vc(l){return l<Xn.SAFE.maxDistance?Xn.SAFE:l<Xn.MEDIUM.maxDistance?Xn.MEDIUM:l<Xn.HARD.maxDistance?Xn.HARD:Xn.FRONTIER}function el(l,e){return Math.sqrt(l*l+e*e)}class g1{constructor(e,t,i,s=null,n=null,a=null){this.scene=e,this.gm=t,this.player=i,this.world=s,this.particleManager=n,this.lootManager=a,this.enemies=[],this.boss=null,this.cryptLord=null,this.defeatedBosses=new Set,this.spawnedRegions=new Set,this.maxEnemies=30,this.spawnCheckRadius=60,this.despawnRadius=100,this.groupRadius=30,this.maxActiveAttackers=3,this.groupJoinDelayMin=.5,this.groupJoinDelayMax=2,this.leaderDeathConfusionTime=1,this.activeGroups=new Map,this.nextGroupId=1,this._spawnEnemies(),console.log("[EnemyManager] Initialized with distance-based scaling")}_spawnEnemies(){if(!this.world?.terrain){console.warn("[EnemyManager] No terrain available, using fallback spawns"),this._spawnFallbackEnemies();return}this.world.terrain,this._populateArea(0,0,80),console.log(`[EnemyManager] Spawned ${this.enemies.length} enemies with distance scaling`)}_populateArea(e,t,i){if(!this.world?.terrain)return;const s=this.world.terrain,n=Math.floor(i/10);for(let a=0;a<n;a++){const o=Math.random()*Math.PI*2,r=Math.random()*i,c=e+Math.cos(o)*r,h=t+Math.sin(o)*r,d=el(c,h);if(d<35)continue;const u=Vc(d);if(Math.random()>u.spawnDensity||s.getTerrainSlope(c,h)>.5||this.world.isNearTree&&this.world.isNearTree(c,h,3)||this.enemies.some(m=>{const g=m.spawnPos.x-c,x=m.spawnPos.z-h;return Math.sqrt(g*g+x*x)<8}))continue;if(this.enemies.length>=this.maxEnemies)break;const y=s.getTerrainHeight(c,h)+.3;this._spawnEnemyAtPosition(c,y,h,u,d)}}_spawnEnemyAtPosition(e,t,i,s,n){const a=s.enemyTypes[Math.floor(Math.random()*s.enemyTypes.length)],o=Fl[a];if(!o){console.warn(`[EnemyManager] Unknown enemy type: ${a}`);return}const r=Math.random()<s.eliteChance,c=this._applyDistanceScaling(o,s,n,r),h=new T(e,t,i),d=new Xo(this.scene,h,{type:a,...c},this.gm);return d.spawnDistance=n,d.difficultyZone=s.label,d.world=this.world,this.enemies.push(d),d}_applyDistanceScaling(e,t,i,s=!1){let n=t.hpMultiplier,a=t.damageMultiplier,o=t.remnantMultiplier;const r=1+i/1e3;return n*=r,a*=r,o*=r,s&&(n*=1.5,a*=1.3,o*=2),{name:s?`Elite ${e.name}`:e.name,health:Math.round(e.health*n),damage:Math.round(e.damage*a),postureDmg:Math.round((e.postureDmg||15)*a),remnantDrop:Math.round(e.remnantDrop*o),maxPosture:Math.round((e.maxPosture||60)*n),moveSpeed:e.moveSpeed,detectionRange:e.detectionRange+(s?3:0),attackRange:e.attackRange,attackCooldown:e.attackCooldown,attackWindup:e.attackWindup,attackDuration:e.attackDuration,bodyColor:s?6684706:e.bodyColor,eyeColor:s?16711680:e.eyeColor,modelTint:s?this._eliteTint(e.modelTint):e.modelTint,modelScale:(e.modelScale||.5)*(s?1.15:1),canChainAttacks:e.canChainAttacks,maxChainAttacks:e.maxChainAttacks,hasShield:e.hasShield,shieldBlockChance:e.shieldBlockChance,modelPath:e.modelPath,animSpeedMult:e.animSpeedMult,patrolRadius:e.patrolRadius,isElite:s}}_eliteTint(e){if(!e)return 4456482;const t=new H(e);return t.lerp(new H(6684672),.4),t.getHex()}_spawnFallbackEnemies(){[{pos:new T(40,0,0),type:"HOLLOW_SOLDIER"},{pos:new T(60,0,20),type:"HOLLOW_SOLDIER"},{pos:new T(80,0,-10),type:"BERSERKER"},{pos:new T(100,0,30),type:"SENTINEL"}].forEach(t=>{const i=Vc(el(t.pos.x,t.pos.z)),s=Fl[t.type],n=this._applyDistanceScaling(s,i,el(t.pos.x,t.pos.z)),a=new Xo(this.scene,t.pos,{type:t.type,...n},this.gm);a.world=this.world,this.enemies.push(a)})}_trySpawnNightEnemies(e){const t=this.gm?.timeWeatherGameplay;if(!t)return;const i=this.gm?.timeManager;if(!i)return;const s=i.dayPhase;if(s!=="night"&&s!=="dusk")return;const n=this.enemies.filter(r=>r.isNightEnemy).length,a=s==="night"?5:2;if(n>=a||(this._nightSpawnTimer||(this._nightSpawnTimer=0),this._nightSpawnTimer++,this._nightSpawnTimer<60))return;this._nightSpawnTimer=0;const o=["WRAITH","SHADOW_STALKER","NIGHT_HOWLER","PHANTOM"];for(const r of o){if(n>=a)break;if(t.shouldSpawnNightEnemy(r)){const c=t.getNightEnemyConfig(r);if(!c)continue;const h=Math.random()*Math.PI*2,d=25+Math.random()*30,u=e.x+Math.cos(h)*d,p=e.z+Math.sin(h)*d,f=(this.world?.terrain?.getTerrainHeight(u,p)??0)+.3,y={health:c.baseHealth*(1+(i.currentDay-1)*.1),maxHealth:c.baseHealth*(1+(i.currentDay-1)*.1),damage:c.baseDamage,speed:3.5,type:c.id,name:c.name,tint:4465322,remnantDrop:50+Math.floor(Math.random()*50),isElite:!1,isNightEnemy:!0,fadeOnDawn:!0},m=new T(u,f,p),g=new Xo(this.scene,m,y,this.gm);g.world=this.world,g.isNightEnemy=!0,g.special=c.special,g.lootTable=c.loot,g.mesh&&g.mesh.material&&(g.mesh.material.transparent=!0,g.mesh.material.opacity=.85),this.enemies.push(g),console.log(`[EnemyManager] Spawned night enemy: ${c.name} at (${u.toFixed(1)}, ${p.toFixed(1)})`);break}}}_despawnNightEnemies(){for(let e=this.enemies.length-1;e>=0;e--){const t=this.enemies[e];t.isNightEnemy&&t.fadeOnDawn&&t.mesh&&(t.mesh.material.opacity*=.95,t.mesh.material.opacity<.1&&(this.scene.remove(t.mesh),this.enemies.splice(e,1)))}}updateDynamicSpawns(e){if(!this.world?.terrain)return;this._trySpawnNightEnemies(e);const t=new Set;for(let i=this.enemies.length-1;i>=0;i--){const s=this.enemies[i];if(s.mesh.position.distanceTo(e)>this.despawnRadius&&!s.bossActive){if(s.spawnPos){const a=Math.floor(s.spawnPos.x/40)*40,o=Math.floor(s.spawnPos.z/40)*40;t.add(`${a},${o}`)}s.mesh&&this.scene.remove(s.mesh),this.enemies.splice(i,1)}}for(const i of t)this.enemies.some(n=>{if(!n.spawnPos)return!1;const a=Math.floor(n.spawnPos.x/40)*40,o=Math.floor(n.spawnPos.z/40)*40;return`${a},${o}`===i})||this.spawnedRegions.delete(i);if(this.enemies.length<this.maxEnemies){const i=Math.floor(e.x/40),s=Math.floor(e.z/40);for(let n=-1;n<=1;n++)for(let a=-1;a<=1;a++){const o=(i+n)*40,r=(s+a)*40,c=`${o},${r}`;if(this.spawnedRegions.has(c))continue;if(this.enemies.length>=this.maxEnemies)break;Math.sqrt(Math.pow(o+20-e.x,2)+Math.pow(r+20-e.z,2))>this.spawnCheckRadius||(this.spawnedRegions.add(c),this._populateArea(o,r,40))}}}_spawnBoss(){const e=this.world?.getBossPosition()||new T(0,0,-95);this.boss=new m1(this.scene,e,this.gm),this.boss.world=this.world;const t=new Ki(8,12,32),i=new B({color:3346705,transparent:!0,opacity:.3,side:lt}),s=new w(t,i);s.rotation.x=-Math.PI/2,s.position.copy(e),s.position.y=.02,this.scene.add(s)}update(e,t){this.updateDynamicSpawns(t.mesh.position);const i=this.gm?.timeManager;i&&(i.dayPhase==="dawn"||i.dayPhase==="day")&&this._despawnNightEnemies(),this._checkDormantTriggers(t),this._coordinateFlanking(t),this._coordinateGroups(t);for(let s=this.enemies.length-1;s>=0;s--){const n=this.enemies[s];if(n.update(e,t),t.activeAttack&&!t.hitThisSwing){const a=n.mesh.position.x-t.activeAttack.position.x,o=n.mesh.position.z-t.activeAttack.position.z;if(Math.sqrt(a*a+o*o)<t.activeAttack.range&&n.health>0){const c=t.activeAttack.damage,h=n.takeDamage(c,t.activeAttack.postureDmg,t.mesh.position);if(t.hitThisSwing=!0,this.gm.damageNumbers){const d=t.activeAttack.isHeavy;this.gm.damageNumbers.spawn(c,n.mesh.position,d?"critical":"normal")}if(this.gm.hitEffects&&this.gm.hitEffects.spawnBurst(n.mesh.position),t.activeAttack.isHeavy?this.gm.hitstopHeavy():this.gm.hitstopLight(),this.gm.cameraController&&(t.activeAttack.isHeavy?this.gm.cameraController.shakeMedium():this.gm.cameraController.shakeLight()),this.particleManager){const d=n.mesh.position.clone(),u=n.mesh.position.clone().sub(t.mesh.position).normalize();this.particleManager.spawnHitSparks(d,8,t.activeAttack.isHeavy),this.particleManager.spawnBlood(d,u,Math.ceil(t.activeAttack.damage/5)),h==="posture_broken"&&this.particleManager.spawnPostureBreak(d)}if(h==="died"){this.gm.addRemnant(n.config.remnantDrop);const d=this.gm.calculateEnemyXP(n);this.gm.gainXP(d,n.mesh.position),this.particleManager&&this.particleManager.spawnDeathBurst(n.mesh.position.clone()),this.lootManager&&this.lootManager.rollLoot(n,n.mesh.position.clone()),setTimeout(()=>{n.respawn()},8e3)}}}if(n.activeAttack&&!n.hitThisSwing){const a=t.mesh.position.x-n.activeAttack.position.x,o=t.mesh.position.z-n.activeAttack.position.z;if(Math.sqrt(a*a+o*o)<n.activeAttack.range&&!t.isInvincible){if(t.isParrying){n.hitThisSwing=!0,t.onParrySuccess(),n.state="staggered",n.stateTimer=0,this.particleManager&&this.particleManager.spawnParryEffect(t.mesh.position.clone());continue}const c=n.activeAttack.damage,h=this.gm.takeDamage(c,"physical",n.activeAttack.postureDmg,t.isBlocking);if(n.hitThisSwing=!0,t.flashDamage(),this.gm.damageNumbers&&this.gm.damageNumbers.spawn(c,t.mesh.position,"player-hit"),this.gm.hitEffects&&(this.gm.hitEffects.spawnBurst(t.mesh.position),this.gm.hitEffects.screenShake()),this.gm.hud){const d=c/30;this.gm.hud.flashDamage(Math.min(1,d))}if(this.gm.cameraController&&this.gm.cameraController.shakeHeavy(),this.particleManager){const d=t.mesh.position.clone(),u=t.mesh.position.clone().sub(n.mesh.position).normalize();t.isBlocking&&h!=="guard_broken"?this.particleManager.spawnBlockSparks(d):(this.particleManager.spawnHitSparks(d,6,!1),this.particleManager.spawnBlood(d,u,Math.ceil(n.activeAttack.damage/5))),(h==="guard_broken"||h==="posture_broken")&&this.particleManager.spawnPostureBreak(d)}h==="died"||(h==="guard_broken"||h==="posture_broken")&&(t.state="staggered",t.stateTimer=0)}}}if(this.boss){if(this.boss.update(e,t),t.activeAttack&&!t.hitThisSwing&&!this.boss.isDead){const s=this.boss.mesh.position.x-t.activeAttack.position.x,n=this.boss.mesh.position.z-t.activeAttack.position.z;if(Math.sqrt(s*s+n*n)<t.activeAttack.range+1&&this.boss.health>0){const o=t.activeAttack.damage,r=this.boss.takeDamage(o,t.activeAttack.postureDmg,t.mesh.position);if(t.hitThisSwing=!0,this.gm.damageNumbers&&this.gm.damageNumbers.spawn(o,this.boss.mesh.position,t.activeAttack.isHeavy?"critical":"normal"),this.gm.hitEffects&&this.gm.hitEffects.spawnBurst(this.boss.mesh.position),this.gm.hitstopHeavy(),this.gm.cameraController&&this.gm.cameraController.shakeMedium(),this.particleManager){const c=this.boss.mesh.position.clone(),h=this.boss.mesh.position.clone().sub(t.mesh.position).normalize();this.particleManager.spawnHitSparks(c,12,t.activeAttack.isHeavy),this.particleManager.spawnBlood(c,h,Math.ceil(t.activeAttack.damage/3)),r==="posture_broken"&&this.particleManager.spawnPostureBreak(c),r==="died"&&(this.particleManager.spawnDeathBurst(c),this.particleManager.spawnDeathBurst(c),this.gm.gainXP(200,c))}}}if(this.boss.activeAttack&&!this.boss.hitThisSwing){const s=t.mesh.position.x-this.boss.activeAttack.position.x,n=t.mesh.position.z-this.boss.activeAttack.position.z;if(Math.sqrt(s*s+n*n)<this.boss.activeAttack.range&&!t.isInvincible)if(t.isParrying)this.boss.hitThisSwing=!0,t.onParrySuccess(),this.boss.state!=="staggered"&&(this.boss.state="staggered",this.boss.stateTimer=0),this.particleManager&&(this.particleManager.spawnParryEffect(t.mesh.position.clone()),this.particleManager.spawnBlockSparks(t.mesh.position.clone())),this.gm.cameraController&&this.gm.cameraController.shakeMedium();else{const o=this.boss.activeAttack.damage,r=this.gm.takeDamage(o,"physical",this.boss.activeAttack.postureDmg,t.isBlocking);if(this.boss.hitThisSwing=!0,t.flashDamage(),this.gm.damageNumbers&&this.gm.damageNumbers.spawn(o,t.mesh.position,"player-hit"),this.gm.hitEffects&&(this.gm.hitEffects.spawnBurst(t.mesh.position),this.gm.hitEffects.screenShake()),this.gm.hud){const c=o/25;this.gm.hud.flashDamage(Math.min(1,c))}if(this.gm.cameraController&&this.gm.cameraController.shake(.7,.25),this.particleManager){const c=t.mesh.position.clone(),h=t.mesh.position.clone().sub(this.boss.mesh.position).normalize();t.isBlocking&&r!=="guard_broken"?(this.particleManager.spawnBlockSparks(c),this.particleManager.spawnBlockSparks(c)):(this.particleManager.spawnHitSparks(c,10,!0),this.particleManager.spawnBlood(c,h,Math.ceil(this.boss.activeAttack.damage/4))),(r==="guard_broken"||r==="posture_broken")&&this.particleManager.spawnPostureBreak(c)}r==="died"||(r==="guard_broken"||r==="posture_broken")&&(t.state="staggered",t.stateTimer=0)}}}}_checkDormantTriggers(e){const t=e.mesh.position;for(const i of this.enemies)i.checkTrigger&&i.checkTrigger(t)&&(i.wake(),this.gm?.audioManager&&this.gm.audioManager.play("ambushReveal",{position:i.mesh.position,volume:.8}),this.gm?.cameraController&&this.gm.cameraController.shakeLight())}_coordinateFlanking(e){const t=e.mesh.position,i=this.enemies.filter(o=>o.isDead||o.state==="dead"||o.state==="staggered"||o.state==="dormant"||o.isBoss||o.mesh.position.distanceTo(t)>(o.config.detectionRange||10)*1.2?!1:o.state==="chase"||o.state==="circle"||o.state==="attack");if(i.length<2)return;const s=i.filter(o=>!(!o.canFlank||o.state==="flank"||o.isFlankAssigned||o.isRetreating)),n=i.filter(o=>o.state==="flank").length,a=Math.floor(i.length/2);if(!(n>=a)){s.sort((o,r)=>{const c=o.mesh.position.distanceTo(t);return r.mesh.position.distanceTo(t)-c});for(const o of s)if(o.requestFlank&&o.requestFlank())break}}_coordinateGroups(e){const t=e.mesh.position,i=this.enemies.filter(n=>n.isDead||n.state==="dead"||n.state==="staggered"||n.state==="dormant"||n.state==="rising"||n.isBoss||n.mesh.position.distanceTo(t)>(n.config.detectionRange||10)*1.5?!1:n.state==="chase"||n.state==="circle"||n.state==="attack"||n.state==="flank"||n.isInCombat?.()||!1);if(i.length===0){this.activeGroups.clear();return}for(const[n,a]of this.activeGroups)a.members=a.members.filter(o=>!o.isDead&&o.state!=="dead"&&o.state!=="idle"&&o.state!=="patrol"),a.leader&&(a.leader.isDead||a.leader.state==="dead")&&(this._handleLeaderDeath(a),a.leader=null),a.members.length===0&&this.activeGroups.delete(n);const s=i.filter(n=>n.groupId===null);for(const n of s){let a=!1;for(const[o,r]of this.activeGroups){if(r.members.length===0)continue;if(r.members.some(h=>n.mesh.position.distanceTo(h.mesh.position)<this.groupRadius)){const h=this.groupJoinDelayMin+Math.random()*(this.groupJoinDelayMax-this.groupJoinDelayMin);n.joinGroup(o,!1,h),r.members.push(n),a=!0;break}}if(!a){const o=`group_${this.nextGroupId++}`;n.joinGroup(o,!0,0),this.activeGroups.set(o,{leader:n,members:[n],attackers:[]})}}this._mergeNearbyGroups(),this._manageGroupAttackers(e)}_handleLeaderDeath(e){for(const t of e.members)!t.isDead&&t.state!=="dead"&&!t.isGroupLeader&&t.triggerConfusion(this.leaderDeathConfusionTime);setTimeout(()=>{const t=e.members.filter(i=>!i.isDead&&i.state!=="dead");if(t.length>0){t.sort((s,n)=>n.health-s.health);const i=t[0];i.isGroupLeader=!0,e.leader=i}},this.leaderDeathConfusionTime*1e3)}_mergeNearbyGroups(){const e=Array.from(this.activeGroups.keys());for(let t=0;t<e.length;t++)for(let i=t+1;i<e.length;i++){const s=this.activeGroups.get(e[t]),n=this.activeGroups.get(e[i]);if(!s||!n||s.members.length===0||n.members.length===0)continue;let a=!1;for(const o of s.members){for(const r of n.members)if(o.mesh.position.distanceTo(r.mesh.position)<this.groupRadius){a=!0;break}if(a)break}if(a){for(const o of n.members)o.groupId=e[t],o.isGroupLeader=!1,s.members.push(o);n.leader&&s.leader&&n.leader.health>s.leader.health&&(s.leader.isGroupLeader=!1,n.leader.isGroupLeader=!0,s.leader=n.leader),this.activeGroups.delete(e[i])}}}_manageGroupAttackers(e){for(const[t,i]of this.activeGroups){const s=i.members.filter(r=>r.isAttacking?.()||r.state==="attack"),n=i.members.filter(r=>r.isDead||r.state==="dead"||r.isAttacking?.()||r.state==="attack"||r.isWaitingToJoin||r.isConfused?!1:r.mesh.position.distanceTo(e.mesh.position)<=(r.config.attackRange||2.2)),a=this.maxActiveAttackers-s.length;let o=0;for(const r of i.members)r.isDead||r.state==="dead"||(r.isAttacking?.()||r.state==="attack"?r.canAttackInGroup=!0:o<a&&n.includes(r)?(r.canAttackInGroup=!0,o++):n.includes(r)?r.canAttackInGroup=!1:r.canAttackInGroup=!0);i.attackers=s}}getPlayerZone(e){const t=el(e.x,e.z);return Vc(t)}resetAll(){this.activeGroups.clear(),this.enemies.forEach(e=>{e.isBoss&&this.defeatedBosses.has(e.bossId||"crypt-lord")||e.respawn()}),this.boss&&this.boss.respawn()}markBossDefeated(e){this.defeatedBosses.add(e)}isBossDefeated(e){return this.defeatedBosses.has(e)}getBoss(){return this.boss}getCryptLord(){return this.cryptLord}getActiveBoss(){return this.cryptLord&&this.cryptLord.bossActive&&!this.cryptLord.isDead?this.cryptLord:this.boss&&this.boss.isActive&&!this.boss.isDead?this.boss:null}}const qm=Math.sqrt(3),y1=.5*(qm-1),Co=(3-qm)/6,Xp=l=>Math.floor(l)|0,Yp=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);function Qp(l=Math.random){const e=v1(l),t=new Float64Array(e).map(s=>Yp[s%12*2]),i=new Float64Array(e).map(s=>Yp[s%12*2+1]);return function(n,a){let o=0,r=0,c=0;const h=(n+a)*y1,d=Xp(n+h),u=Xp(a+h),p=(d+u)*Co,f=d-p,y=u-p,m=n-f,g=a-y;let x,v;m>g?(x=1,v=0):(x=0,v=1);const b=m-x+Co,_=g-v+Co,S=m-1+2*Co,A=g-1+2*Co,R=d&255,M=u&255;let C=.5-m*m-g*g;if(C>=0){const O=R+e[M],W=t[O],U=i[O];C*=C,o=C*C*(W*m+U*g)}let k=.5-b*b-_*_;if(k>=0){const O=R+x+e[M+v],W=t[O],U=i[O];k*=k,r=k*k*(W*b+U*_)}let L=.5-S*S-A*A;if(L>=0){const O=R+1+e[M+1],W=t[O],U=i[O];L*=L,c=L*L*(W*S+U*A)}return 70*(o+r+c)}}function v1(l){const t=new Uint8Array(512);for(let i=0;i<512/2;i++)t[i]=i;for(let i=0;i<512/2-1;i++){const s=i+~~(l()*(256-i)),n=t[i];t[i]=t[s],t[s]=n}for(let i=256;i<512;i++)t[i]=t[i-256];return t}class x1{constructor(e){this.scene=e,this.chunkSize=64,this.chunkResolution=32,this.loadDistance=3,this.unloadDistance=5,this.heightScale=25,this.baseHeight=0,this.castleRadius=30,this.castleBlendRadius=45,this.seed=12345,this.noise2D=Qp(()=>this.seed/1e4),this.moistureNoise=Qp(()=>(this.seed+7777)/1e4),this.octaves=[{frequency:.003,amplitude:1},{frequency:.01,amplitude:.4},{frequency:.03,amplitude:.15},{frequency:.08,amplitude:.05}],this.chunks=new Map,this.lastPlayerChunkX=null,this.lastPlayerChunkZ=null,this.waterLevel=-2,this.pathSegments=[[0,30,60,80],[60,80,140,160],[140,160,220,260],[220,260,280,320],[0,-30,-50,-80],[-50,-80,-120,-180],[-120,-180,-190,-290],[-190,-290,-250,-380],[-20,25,-70,60],[-70,60,-150,110],[-150,110,-240,160],[-240,160,-320,200]],this.pathWidth=3,this.terrainMaterial=this._createTerrainMaterial(),this.waterMaterial=new B({color:2254506,transparent:!0,opacity:.55,side:lt,depthWrite:!1}),this._updateChunks(0,0)}_sampleNoise(e,t){let i=0,s=0;for(const n of this.octaves)i+=this.noise2D(e*n.frequency,t*n.frequency)*n.amplitude,s+=n.amplitude;return i/=s,i*this.heightScale+this.baseHeight}_distToPath(e,t){let i=1/0;for(let s=0;s<this.pathSegments.length;s++){const n=this.pathSegments[s],a=n[0],o=n[1],r=n[2],c=n[3],h=r-a,d=c-o,u=h*h+d*d;if(u===0)continue;const p=Math.max(0,Math.min(1,((e-a)*h+(t-o)*d)/u)),f=a+p*h,y=o+p*d,m=Math.sqrt((e-f)*(e-f)+(t-y)*(t-y));m<i&&(i=m)}return i}getTerrainHeight(e,t){const i=Math.sqrt(e*e+t*t);if(i<this.castleRadius)return this.baseHeight;const s=this._sampleNoise(e,t);if(i<this.castleBlendRadius){const n=(i-this.castleRadius)/(this.castleBlendRadius-this.castleRadius),a=n*n*(3-2*n);return gt.lerp(this.baseHeight,s,a)}return s}getTerrainSlope(e,t){const s=this.getTerrainHeight(e,t),n=this.getTerrainHeight(e+1,t),a=this.getTerrainHeight(e,t+1),o=(n-s)/1,r=(a-s)/1;return Math.sqrt(o*o+r*r)}getTerrainNormal(e,t){const s=this.getTerrainHeight(e,t),n=this.getTerrainHeight(e+1,t),a=this.getTerrainHeight(e,t+1),o=new T(1,n-s,0),r=new T(0,a-s,1);return new T().crossVectors(r,o).normalize()}_worldToChunk(e,t){return{chunkX:Math.floor(e/this.chunkSize),chunkZ:Math.floor(t/this.chunkSize)}}_chunkKey(e,t){return`${e},${t}`}update(e,t){const{chunkX:i,chunkZ:s}=this._worldToChunk(e,t);i===this.lastPlayerChunkX&&s===this.lastPlayerChunkZ||(this.lastPlayerChunkX=i,this.lastPlayerChunkZ=s,this._updateChunks(i,s))}_updateChunks(e,t){const i=new Set;for(let n=-this.loadDistance;n<=this.loadDistance;n++)for(let a=-this.loadDistance;a<=this.loadDistance;a++){const o=e+n,r=t+a;i.add(this._chunkKey(o,r)),this.chunks.has(this._chunkKey(o,r))||this._loadChunk(o,r)}const s=[];for(const[n,a]of this.chunks){const[o,r]=n.split(",").map(Number),c=Math.abs(o-e),h=Math.abs(r-t);(c>this.unloadDistance||h>this.unloadDistance)&&s.push(n)}for(const n of s)this._unloadChunk(n)}_loadChunk(e,t){const i=this._chunkKey(e,t);if(this.chunks.has(i))return;const s=e*this.chunkSize,n=t*this.chunkSize,a=new Dt(this.chunkSize,this.chunkSize,this.chunkResolution,this.chunkResolution);a.rotateX(-Math.PI/2);const o=a.attributes.position.array;for(let f=0;f<o.length;f+=3){const y=o[f],m=o[f+2],g=y+s+this.chunkSize/2,x=m+n+this.chunkSize/2,v=this.getTerrainHeight(g,x);o[f+1]=v}a.attributes.position.needsUpdate=!0;const r=o.length/3,c=new Float32Array(r*3);for(let f=0;f<r;f++){const y=o[f*3]+s+this.chunkSize/2,m=o[f*3+2]+n+this.chunkSize/2,g=o[f*3+1],x=(this.moistureNoise(y*.005,m*.005)+1)*.5,v=Math.max(0,Math.min(1,(g+5)/30)),b=Math.sqrt(y*y+m*m);let _,S,A;if(b<this.castleRadius)_=.35,S=.33,A=.3;else if(v>.75){const M=(v-.75)/.25;_=.4+M*.15,S=.38+M*.08,A=.3+M*.1}else if(x<.35)_=.5+v*.15,S=.45+v*.1,A=.2+v*.05;else if(x>.65)_=.1+v*.12,S=.28+v*.15,A=.08+v*.06;else{const M=(x-.35)/.3,C=.45+v*.15,k=.45+v*.1,L=.2+v*.05,O=.12+v*.15,W=.32+v*.18,U=.1+v*.06;_=C+(O-C)*M,S=k+(W-k)*M,A=L+(U-L)*M}if(b>this.castleRadius&&b<80){const M=1-(b-this.castleRadius)/(80-this.castleRadius);_=_+(.35-_)*M*.4,S=S+(.55-S)*M*.4,A=A+(.2-A)*M*.4}if(b>this.castleRadius){const M=this._distToPath(y,m);if(M<this.pathWidth*2){const C=1-Math.min(1,M/(this.pathWidth*2)),k=.45,L=.35,O=.2;_=_+(k-_)*C*.85,S=S+(L-S)*C*.85,A=A+(O-A)*C*.85}}const R=this.noise2D(y*.15,m*.15)*.04;_=Math.max(0,Math.min(1,_+R)),S=Math.max(0,Math.min(1,S+R*.7)),A=Math.max(0,Math.min(1,A+R*.5)),c[f*3]=_,c[f*3+1]=S,c[f*3+2]=A}a.setAttribute("color",new Je(c,3)),a.computeVertexNormals();const h=new w(a,this.terrainMaterial);h.position.set(s+this.chunkSize/2,0,n+this.chunkSize/2),h.receiveShadow=!0,h.castShadow=!1,a.computeBoundingSphere(),this.scene.add(h);let d=null,u=!1;for(let f=0;f<o.length;f+=3)if(o[f+1]<this.waterLevel){u=!0;break}if(u){const f=new Dt(this.chunkSize,this.chunkSize);f.rotateX(-Math.PI/2),d=new w(f,this.waterMaterial),d.position.set(s+this.chunkSize/2,this.waterLevel,n+this.chunkSize/2),d.renderOrder=1,this.scene.add(d)}const p=this._addFoliage(e,t);p&&this.scene.add(p),this.chunks.set(i,{mesh:h,geometry:a,foliageGroup:p,waterMesh:d})}_unloadChunk(e){const t=this.chunks.get(e);t&&(this.scene.remove(t.mesh),t.geometry.dispose(),t.foliageGroup&&(this.scene.remove(t.foliageGroup),t.foliageGroup.traverse(i=>{i.geometry&&i.geometry.dispose()})),t.waterMesh&&(this.scene.remove(t.waterMesh),t.waterMesh.geometry.dispose()),this.chunks.delete(e))}_foliageHash(e,t,i){let s=e*374761+t*668265+(i||0)*982451|0;return s=(s>>16^s)*73244475|0,s=(s>>16^s)*73244475|0,(s>>16^s)&2147483647}_addFoliage(e,t){const i=e*this.chunkSize,s=t*this.chunkSize,n=i+this.chunkSize/2,a=s+this.chunkSize/2,o=this.lastPlayerChunkX||0,r=this.lastPlayerChunkZ||0;if(Math.abs(e-o)>2||Math.abs(t-r)>2)return null;const c=new ne;this._foliageMats||(this._foliageMats={trunk:new B({color:5583633}),canopy1:new B({color:2258722}),canopy2:new B({color:2787882}),canopy3:new B({color:1730080}),rock1:new B({color:7829367}),rock2:new B({color:6710869}),rock3:new B({color:8947840})},this._foliageGeo={trunk:new ce(.15,.25,3,5),canopyA:new wt(1.8,3.5,6),canopyB:new re(1.6,6,5),canopyC:new wt(1.2,4,5),rockA:new js(1,0),rockB:new js(.6,1)});const h=this._foliageMats,d=this._foliageGeo;if(Math.sqrt(n*n+a*a)<this.castleRadius)return null;const p=this.getBiome(n,a);let f,y;switch(p){case"safe_meadow":f=4,y=2;break;case"grassland":f=8,y=4;break;case"dense_woods":f=14,y=3;break;case"dark_frontier":f=10,y=6;break;default:f=0,y=0}for(let m=0;m<f;m++){const g=this._foliageHash(e,t,m),x=g%1e3/1e3*this.chunkSize,v=(g>>10)%1e3/1e3*this.chunkSize,b=i+x,_=s+v;if(Math.sqrt(b*b+_*_)<this.castleBlendRadius||this.getTerrainSlope(b,_)>.6)continue;const R=this.getTerrainHeight(b,_),M=g%3,C=.7+g%100/100*.6,k=new w(d.trunk,h.trunk);k.position.set(b,R+1.5*C,_),k.scale.set(C,C,C),c.add(k);let L;M===0?(L=new w(d.canopyA,h.canopy1),L.position.set(b,R+3.8*C,_)):M===1?(L=new w(d.canopyB,h.canopy2),L.position.set(b,R+3.5*C,_)):(L=new w(d.canopyC,h.canopy3),L.position.set(b,R+4*C,_)),L.scale.set(C,C,C),c.add(L)}for(let m=0;m<y;m++){const g=this._foliageHash(e,t,1e3+m),x=g%1e3/1e3*this.chunkSize,v=(g>>10)%1e3/1e3*this.chunkSize,b=i+x,_=s+v;if(Math.sqrt(b*b+_*_)<this.castleBlendRadius)continue;const A=this.getTerrainHeight(b,_),R=g%2,M=.5+g%100/100*1.5,C=[h.rock1,h.rock2,h.rock3][g%3],k=new w(R===0?d.rockA:d.rockB,C);k.position.set(b,A+.3*M,_),k.scale.set(M,M*(.5+g%50/100),M),k.rotation.y=g%628/100,c.add(k)}return c.children.length>0?c:null}_createTerrainMaterial(){const e=document.createElement("canvas");e.width=512,e.height=512;const t=e.getContext("2d");t.fillStyle="#3a5a30",t.fillRect(0,0,512,512);for(let s=0;s<1e4;s++){const n=Math.random()*512,a=Math.random()*512,r=80+Math.floor(Math.random()*30),c=50+Math.floor(Math.random()*20),h=40+Math.floor(Math.random()*15);t.fillStyle=`rgb(${c}, ${r}, ${h})`,t.fillRect(n,a,2+Math.random()*3,2+Math.random()*3)}for(let s=0;s<50;s++){const n=Math.random()*512,a=Math.random()*512,o=10+Math.random()*30;t.fillStyle=`rgba(90, 70, 50, ${.2+Math.random()*.3})`,t.beginPath(),t.ellipse(n,a,o,o*.7,0,0,Math.PI*2),t.fill()}const i=new Zd(e);return i.wrapS=Ys,i.wrapT=Ys,i.repeat.set(4,4),new B({vertexColors:!0,side:lt})}getBiome(e,t){const i=Math.sqrt(e*e+t*t);return i<this.castleRadius?"castle":i<100?"safe_meadow":i<300?"grassland":i<600?"dense_woods":"dark_frontier"}getBiomeParams(e,t){const i=this.getBiome(e,t),s={castle:{treeDensity:0,grassDensity:0,fogDensity:0,ambientLight:1,groundColor:5592405},safe_meadow:{treeDensity:.05,grassDensity:.8,fogDensity:.001,ambientLight:.9,groundColor:8039008},grassland:{treeDensity:.15,grassDensity:.6,fogDensity:.002,ambientLight:.7,groundColor:5933632},dense_woods:{treeDensity:.5,grassDensity:.4,fogDensity:.004,ambientLight:.4,groundColor:3825712},dark_frontier:{treeDensity:.3,grassDensity:.2,fogDensity:.008,ambientLight:.2,groundColor:4872768}};return s[i]||s.grassland}findValidSpawnPoint(e=50,t=200){for(let s=0;s<20;s++){const n=Math.random()*Math.PI*2,a=e+Math.random()*(t-e),o=Math.cos(n)*a,r=Math.sin(n)*a,c=this.getTerrainHeight(o,r);if(!(this.getTerrainSlope(o,r)>.5)&&!(c<-2))return new T(o,c,r)}return new T(60,this.getTerrainHeight(60,0),0)}getHeightAt(e,t){return this.getTerrainHeight(e,t)}forceGenerateAt(e,t){const{chunkX:i,chunkZ:s}=this._worldToChunk(e,t);for(let n=-1;n<=1;n++)for(let a=-1;a<=1;a++){const o=i+n,r=s+a;this.chunks.has(this._chunkKey(o,r))||this._loadChunk(o,r)}this.lastPlayerChunkX=i,this.lastPlayerChunkZ=s}raycast(e){for(const[t,i]of this.chunks){const s=e.intersectObject(i.mesh);if(s.length>0)return s[0].point}return null}getLoadedChunkCount(){return this.chunks.size}dispose(){for(const[e,t]of this.chunks)this.scene.remove(t.mesh),t.geometry.dispose(),t.waterMesh&&(this.scene.remove(t.waterMesh),t.waterMesh.geometry.dispose());this.chunks.clear(),this.terrainMaterial.dispose(),this.waterMaterial.dispose()}}class b1{constructor(e,t){this.scene=e,this.terrain=t,this.chunkSize=64,this.loadDistance=3,this.unloadDistance=5,this.treesPerChunk=15,this.treeMinDistance=4,this.treeMaxSlope=.4,this.castleExclusionRadius=35,this.trunkCollisionRadius=.4,this.grassPerChunk=100,this.bushesPerChunk=12,this.chunks=new Map,this.treeColliders=[],this._createSharedAssets(),this.lastPlayerChunkX=null,this.lastPlayerChunkZ=null,this.update(0,0),console.log("[FoliageManager] Initialized with chunk-based generation")}_createSharedAssets(){this.oakTrunkGeo=new ce(.15,.25,3,6),this.oakTrunkGeo.translate(0,1.5,0),this.oakFoliageGeo=new Ni(1.8,1),this.oakFoliageGeo.translate(0,4.2,0),this.pineTrunkGeo=new ce(.12,.2,4,6),this.pineTrunkGeo.translate(0,2,0),this.pineFoliageGeo=new wt(1.5,3,6),this.pineFoliageGeo.translate(0,5.5,0),this.grassGeo=new Dt(.3,.5),this.grassGeo.translate(0,.25,0),this.bushGeo=new Ni(.5,1),this.bushGeo.scale(1,.7,1),this.bushGeo.translate(0,.35,0),this.oakTrunkMat=new X({color:4863269,roughness:.95}),this.oakFoliageMat=new X({color:2972190,roughness:.9}),this.pineTrunkMat=new X({color:3811866,roughness:.95}),this.pineFoliageMat=new X({color:1722904,roughness:.85}),this.grassMat=new X({color:4880944,roughness:.9,side:lt,alphaTest:.5}),this.bushMat=new X({color:3828264,roughness:.9})}_seededRandom(e){const t=Math.sin(e*12.9898+78.233)*43758.5453;return t-Math.floor(t)}_chunkKey(e,t){return`${e},${t}`}_worldToChunk(e,t){return{cx:Math.floor(e/this.chunkSize),cz:Math.floor(t/this.chunkSize)}}update(e,t){const{cx:i,cz:s}=this._worldToChunk(e,t);if(i===this.lastPlayerChunkX&&s===this.lastPlayerChunkZ)return;this.lastPlayerChunkX=i,this.lastPlayerChunkZ=s;const n=new Set;for(let o=-this.loadDistance;o<=this.loadDistance;o++)for(let r=-this.loadDistance;r<=this.loadDistance;r++){const c=i+o,h=s+r,d=this._chunkKey(c,h);n.add(d),this.chunks.has(d)||this._loadChunk(c,h)}const a=[];for(const[o]of this.chunks)if(!n.has(o)){const[r,c]=o.split(",").map(Number),h=Math.abs(r-i),d=Math.abs(c-s);(h>this.unloadDistance||d>this.unloadDistance)&&a.push(o)}for(const o of a)this._unloadChunk(o)}_loadChunk(e,t){const i=this._chunkKey(e,t);if(this.chunks.has(i))return;const s={trees:[],colliders:[],meshes:[]},n=e*this.chunkSize,a=t*this.chunkSize,o=e*73856093+t*19349663,r=[],c=this.treesPerChunk*5;for(let h=0;h<c&&r.length<this.treesPerChunk;h++){const d=this._seededRandom(o+h*3),u=this._seededRandom(o+h*3+1),p=d*this.chunkSize,f=u*this.chunkSize,y=n+p,m=a+f;if(Math.sqrt(y*y+m*m)<this.castleExclusionRadius||this.terrain.getTerrainSlope(y,m)>this.treeMaxSlope)continue;const v=this.terrain.getBiomeParams(y,m);if(this._seededRandom(o+h*3+2)>v.treeDensity*3)continue;let _=!1;for(const k of r){const L=y-k.x,O=m-k.z;if(L*L+O*O<this.treeMinDistance*this.treeMinDistance){_=!0;break}}if(_)continue;const S=this.terrain.getTerrainHeight(y,m),A=this.terrain.getBiome(y,m),R=(A==="dense_woods"||A==="dark_frontier")&&this._seededRandom(o+h*7)>.3,M=.7+this._seededRandom(o+h*5)*.6,C=this._seededRandom(o+h*11)*Math.PI*2;r.push({x:y,y:S,z:m,scale:M,rotation:C,isPine:R})}r.length>0&&this._createTreeMeshes(s,r),this._createGrassMesh(s,e,t,o),this._createBushMesh(s,e,t,o+999),this.chunks.set(i,s),this.treeColliders.push(...s.colliders)}_createTreeMeshes(e,t){const i=t.filter(a=>!a.isPine),s=t.filter(a=>a.isPine),n=new ut;if(i.length>0){const a=new Qn(this.oakTrunkGeo,this.oakTrunkMat,i.length),o=new Qn(this.oakFoliageGeo,this.oakFoliageMat,i.length);a.castShadow=!0,a.receiveShadow=!0,o.castShadow=!0,o.receiveShadow=!0,i.forEach((r,c)=>{n.makeRotationY(r.rotation),n.scale(new T(r.scale,r.scale,r.scale)),n.setPosition(r.x,r.y,r.z),a.setMatrixAt(c,n),o.setMatrixAt(c,n),e.colliders.push({x:r.x,z:r.z,radius:this.trunkCollisionRadius*r.scale,height:4*r.scale,baseY:r.y,chunkKey:null})}),a.instanceMatrix.needsUpdate=!0,o.instanceMatrix.needsUpdate=!0,this.scene.add(a),this.scene.add(o),e.meshes.push(a,o)}if(s.length>0){const a=new Qn(this.pineTrunkGeo,this.pineTrunkMat,s.length),o=new Qn(this.pineFoliageGeo,this.pineFoliageMat,s.length);a.castShadow=!0,a.receiveShadow=!0,o.castShadow=!0,o.receiveShadow=!0,s.forEach((r,c)=>{n.makeRotationY(r.rotation),n.scale(new T(r.scale,r.scale,r.scale)),n.setPosition(r.x,r.y,r.z),a.setMatrixAt(c,n),o.setMatrixAt(c,n),e.colliders.push({x:r.x,z:r.z,radius:this.trunkCollisionRadius*r.scale*.9,height:5*r.scale,baseY:r.y})}),a.instanceMatrix.needsUpdate=!0,o.instanceMatrix.needsUpdate=!0,this.scene.add(a),this.scene.add(o),e.meshes.push(a,o)}e.trees=t}_createGrassMesh(e,t,i,s){const n=t*this.chunkSize,a=i*this.chunkSize,o=new Qn(this.grassGeo,this.grassMat,this.grassPerChunk*3);o.receiveShadow=!0;const r=new ut;let c=0;for(let h=0;h<this.grassPerChunk;h++){const d=this._seededRandom(s+h*2),u=this._seededRandom(s+h*2+1),p=n+d*this.chunkSize,f=a+u*this.chunkSize;if(p*p+f*f<this.castleExclusionRadius*this.castleExclusionRadius)continue;const y=this.terrain.getBiomeParams(p,f);if(this._seededRandom(s+h*3)>y.grassDensity)continue;const g=this.terrain.getTerrainHeight(p,f);for(let x=0;x<3;x++){const v=(this._seededRandom(s+h*10+x)-.5)*.3,b=(this._seededRandom(s+h*10+x+5)-.5)*.3,_=x/3*Math.PI+this._seededRandom(s+h*20+x)*.5,S=.5+this._seededRandom(s+h*30+x)*.5;if(r.makeRotationY(_),r.scale(new T(S,S,S)),r.setPosition(p+v,g,f+b),o.setMatrixAt(c,r),c++,c>=this.grassPerChunk*3)break}if(c>=this.grassPerChunk*3)break}o.instanceMatrix.needsUpdate=!0,o.count=c,this.scene.add(o),e.meshes.push(o)}_createBushMesh(e,t,i,s){const n=t*this.chunkSize,a=i*this.chunkSize,o=new Qn(this.bushGeo,this.bushMat,this.bushesPerChunk);o.castShadow=!0,o.receiveShadow=!0;const r=new ut;let c=0;for(let h=0;h<this.bushesPerChunk*3&&c<this.bushesPerChunk;h++){const d=this._seededRandom(s+h*2),u=this._seededRandom(s+h*2+1),p=n+d*this.chunkSize,f=a+u*this.chunkSize,y=(this.castleExclusionRadius+5)*(this.castleExclusionRadius+5);if(p*p+f*f<y)continue;const m=this.terrain.getBiomeParams(p,f);if(this._seededRandom(s+h*3)>m.grassDensity*.8||this.terrain.getTerrainSlope(p,f)>.3)continue;const x=this.terrain.getTerrainHeight(p,f),v=.6+this._seededRandom(s+h*4)*.8,b=this._seededRandom(s+h*5)*Math.PI*2;r.makeRotationY(b),r.scale(new T(v,v,v)),r.setPosition(p,x,f),o.setMatrixAt(c,r),c++}o.instanceMatrix.needsUpdate=!0,o.count=c,this.scene.add(o),e.meshes.push(o)}_unloadChunk(e){const t=this.chunks.get(e);if(t){for(const i of t.meshes)this.scene.remove(i),i.geometry.dispose();this.treeColliders=this.treeColliders.filter(i=>{for(const s of t.colliders)if(i===s)return!1;return!0}),this.chunks.delete(e)}}checkTreeCollision(e,t=.4){for(const i of this.treeColliders){if(e.y<i.baseY-1||e.y>i.baseY+i.height)continue;const s=e.x-i.x,n=e.z-i.z,a=s*s+n*n,o=i.radius+t;if(a<o*o){const r=Math.sqrt(a);if(r>.001){const c=o-r;return new T(s/r*c,0,n/r*c)}}}return null}getTreeColliders(){return this.treeColliders}isNearTree(e,t,i=3){for(const s of this.treeColliders){const n=e-s.x,a=t-s.z;if(n*n+a*a<i*i)return!0}return!1}getLoadedChunkCount(){return this.chunks.size}dispose(){for(const[e]of this.chunks)this._unloadChunk(e);this.oakTrunkGeo.dispose(),this.oakFoliageGeo.dispose(),this.pineTrunkGeo.dispose(),this.pineFoliageGeo.dispose(),this.grassGeo.dispose(),this.bushGeo.dispose(),this.oakTrunkMat.dispose(),this.oakFoliageMat.dispose(),this.pineTrunkMat.dispose(),this.pineFoliageMat.dispose(),this.grassMat.dispose(),this.bushMat.dispose()}}class w1{constructor(e,t){this.scene=e,this.terrain=t,this.regionSize=200,this.loadDistance=2,this.unloadDistance=3,this.minDistFromCastle=60,this.villagesPerRegion=1,this.maxSlopeForVillage=.3,this.minVillageSpacing=80,this.materials=this._createMaterials(),this.regions=new Map,this.villages=[],this.lastPlayerRegionX=null,this.lastPlayerRegionZ=null,this.update(0,0),console.log("[VillageManager] Initialized with region-based generation")}_seededRandom(e){const t=Math.sin(e*12.9898+78.233)*43758.5453;return t-Math.floor(t)}_regionKey(e,t){return`${e},${t}`}_worldToRegion(e,t){return{rx:Math.floor(e/this.regionSize),rz:Math.floor(t/this.regionSize)}}update(e,t){const{rx:i,rz:s}=this._worldToRegion(e,t);if(i===this.lastPlayerRegionX&&s===this.lastPlayerRegionZ)return;this.lastPlayerRegionX=i,this.lastPlayerRegionZ=s;const n=new Set;for(let o=-this.loadDistance;o<=this.loadDistance;o++)for(let r=-this.loadDistance;r<=this.loadDistance;r++){const c=i+o,h=s+r,d=this._regionKey(c,h);n.add(d),this.regions.has(d)||this._loadRegion(c,h)}const a=[];for(const[o]of this.regions){const[r,c]=o.split(",").map(Number),h=Math.abs(r-i),d=Math.abs(c-s);(h>this.unloadDistance||d>this.unloadDistance)&&a.push(o)}for(const o of a)this._unloadRegion(o)}_loadRegion(e,t){const i=this._regionKey(e,t);if(this.regions.has(i))return;const s={villages:[],meshes:[]},n=e*this.regionSize,a=t*this.regionSize,o=e*73856093+t*19349663,r=20;for(let c=0;c<r;c++){const h=this._seededRandom(o+c*3),d=this._seededRandom(o+c*3+1),u=n+h*this.regionSize,p=a+d*this.regionSize;if(Math.sqrt(u*u+p*p)<this.minDistFromCastle||this.terrain.getTerrainSlope(u,p)>this.maxSlopeForVillage)continue;let m=!1;for(const b of this.villages){const _=u-b.x,S=p-b.z;if(Math.sqrt(_*_+S*S)<this.minVillageSpacing){m=!0;break}}if(m||this.terrain.getBiome(u,p)==="dark_frontier")continue;const x=this.terrain.getTerrainHeight(u,p),v={x:u,y:x,z:p,rotation:this._seededRandom(o+c*7)*Math.PI*2,size:2+Math.floor(this._seededRandom(o+c*11)*2),regionKey:i};this._buildVillage(v,s),s.villages.push(v),this.villages.push(v);break}this.regions.set(i,s)}_unloadRegion(e){const t=this.regions.get(e);if(t){for(const i of t.meshes)this.scene.remove(i),i.traverse(s=>{s.geometry&&s.geometry.dispose()});this.villages=this.villages.filter(i=>i.regionKey!==e),this.regions.delete(e)}}_createMaterials(){return{hutWall:new B({color:11244405}),hutRoof:new B({color:12625276}),marketWood:new B({color:9139044}),wellStone:new B({color:9474192}),wellWood:new B({color:8151123}),fenceWood:new B({color:10126450})}}_buildVillage(e,t){const i=new ne;i.position.set(e.x,0,e.z),i.rotation.y=e.rotation,this._createWell(i,0,0,e);const s=e.size;for(let r=0;r<s;r++){const c=r/s*Math.PI*2+Math.random()*.5,h=8+Math.random()*5,d=Math.cos(c)*h,u=Math.sin(c)*h;this._createHut(i,d,u,e)}const n=1+Math.floor(Math.random()*2);for(let r=0;r<n;r++){const c=r/n*Math.PI*2+Math.PI/4+Math.random()*.3,h=5+Math.random()*3;this._createMarketStall(i,Math.cos(c)*h,Math.sin(c)*h,e)}const a=this._createCraftingStations(i,e);e.craftingStations=a;const o=3+Math.floor(Math.random()*3);for(let r=0;r<o;r++){const c=Math.random()*Math.PI*2,h=12+Math.random()*5;this._createFence(i,Math.cos(c)*h,Math.sin(c)*h,c,e)}this.scene.add(i),t.meshes.push(i)}_createHut(e,t,i,s){const n=Math.cos(s.rotation),a=Math.sin(s.rotation),o=s.x+t*n-i*a,r=s.z+t*a+i*n,c=this.terrain.getTerrainHeight(o,r),h=new ne;h.position.set(t,c,i);const d=2.5+Math.random()*.5,u=1.5+Math.random()*.3,p=new ce(u,u*1.1,d,12),f=new w(p,this.materials.hutWall);f.position.y=d/2,f.castShadow=!0,f.receiveShadow=!0,h.add(f);const y=1.8,m=new wt(u*1.4,y,12),g=new w(m,this.materials.hutRoof);g.position.y=d+y/2-.1,g.castShadow=!0,h.add(g);const x=new ie(.6,1.5,.1),v=new B({color:4866101}),b=new w(x,v);b.position.set(0,.75,u+.05),h.add(b),this._addHutFurniture(h,u),h.rotation.y=Math.random()*Math.PI*2,e.add(h)}_addHutFurniture(e,t){const i=new B({color:7029286}),s=new B({color:4861722}),n=new B({color:6044190}),a=t*.6,o=new ie(.9,.05,.6),r=new w(o,i);r.position.set(0,.7,0),e.add(r);const c=new ie(.06,.65,.06);for(const[g,x]of[[-.38,-.24],[.38,-.24],[-.38,.24],[.38,.24]]){const v=new w(c,s);v.position.set(g,.325,x),e.add(v)}const h=new ie(.3,.4,.3),d=new w(h,s);d.position.set(-.6,.2,0),e.add(d);const u=new w(h,s);u.position.set(.6,.2,0),e.add(u);const p=new ce(.25,.28,.6,8),f=new w(p,n);f.position.set(a*.5,.3,-a*.7),e.add(f);const y=new ie(.6,1.2,.15),m=new w(y,i);m.position.set(-a*.6,.65,-a*.6),e.add(m)}_createMarketStall(e,t,i,s){const n=Math.cos(s.rotation),a=Math.sin(s.rotation),o=s.x+t*n-i*a,r=s.z+t*a+i*n,c=this.terrain.getTerrainHeight(o,r),h=new ne;h.position.set(t,c,i);const d=2.2,u=new ce(.08,.08,d,6),p=2,f=1.5,y=[[-p/2,-f/2],[p/2,-f/2],[-p/2,f/2],[p/2,f/2]];for(const[S,A]of y){const R=new w(u,this.materials.marketWood);R.position.set(S,d/2,A),R.castShadow=!0,h.add(R)}const m=new ie(p,.1,f),g=new w(m,this.materials.marketWood);g.position.y=.9,g.castShadow=!0,g.receiveShadow=!0,h.add(g);const x=new Dt(p*1.2,f*1.3),v=[12080208,5535160,7051604,13216083],b=new B({color:v[Math.floor(Math.random()*v.length)],side:lt}),_=new w(x,b);_.position.y=d+.05,_.rotation.x=-Math.PI/2+.15,_.castShadow=!0,h.add(_),h.rotation.y=Math.random()*Math.PI*2,e.add(h)}_createWell(e,t,i,s){const n=s?Math.cos(s.rotation):1,a=s?Math.sin(s.rotation):0,o=(s?s.x:0)+t*n-i*a,r=(s?s.z:0)+t*a+i*n,c=this.terrain.getTerrainHeight(o,r),h=new ne;h.position.set(t,c,i);const d=new Ai(1,.3,8,16),u=new w(d,this.materials.wellStone);u.rotation.x=Math.PI/2,u.position.y=.3,u.castShadow=!0,u.receiveShadow=!0,h.add(u);const p=new ce(1,1,.8,12,1,!0),f=new w(p,this.materials.wellStone);f.position.y=.4,f.castShadow=!0,h.add(f);const y=new ce(.08,.08,2.5,6),m=new w(y,this.materials.wellWood);m.position.set(.7,1.25,0),m.castShadow=!0,h.add(m);const g=new w(y,this.materials.wellWood);g.position.set(-.7,1.25,0),g.castShadow=!0,h.add(g);const x=new ce(.06,.06,1.6,6),v=new w(x,this.materials.wellWood);v.position.y=2.5,v.rotation.z=Math.PI/2,v.castShadow=!0,h.add(v);const b=new wt(1.2,.6,4),_=new w(b,this.materials.hutRoof);_.position.y=2.9,_.rotation.y=Math.PI/4,_.castShadow=!0,h.add(_);const S=new Zi(.85,12),A=new B({color:1716304}),R=new w(S,A);R.rotation.x=-Math.PI/2,R.position.y=.1,h.add(R),e.add(h)}_createCraftingStations(e,t){const i=[],s=Math.random()*Math.PI*2,n=6+Math.random()*3,a=Math.cos(s)*n,o=Math.sin(s)*n;this._createForge(e,a,o,t),i.push({type:"forge",localX:a,localZ:o,villageX:t.x,villageZ:t.z});const r=s+Math.PI/2+Math.random()*.5,c=5+Math.random()*3,h=Math.cos(r)*c,d=Math.sin(r)*c;this._createWorkbench(e,h,d,t),i.push({type:"workbench",localX:h,localZ:d,villageX:t.x,villageZ:t.z});const u=s+Math.PI+Math.random()*.5,p=5+Math.random()*2,f=Math.cos(u)*p,y=Math.sin(u)*p;return this._createAlchemyTable(e,f,y,t),i.push({type:"alchemy_table",localX:f,localZ:y,villageX:t.x,villageZ:t.z}),i}_createForge(e,t,i,s){const n=Math.cos(s.rotation),a=Math.sin(s.rotation),o=s.x+t*n-i*a,r=s.z+t*a+i*n,c=this.terrain.getTerrainHeight(o,r),h=new ne;h.position.set(t,c,i);const d=new B({color:9127187}),u=new ie(1.2,1.5,1),p=new w(u,d);p.position.y=.75,p.castShadow=!0,p.receiveShadow=!0,h.add(p);const f=new B({color:16729088}),y=new ie(.4,.5,.1),m=new w(y,f);m.position.set(0,.5,.52),h.add(m);const g=new We(16729088,1.5,6);g.position.set(0,.7,.6),h.add(g);const x=new B({color:4473924}),v=new ie(.6,.3,.4),b=new w(v,x);b.position.set(1.2,.15,0),b.castShadow=!0,h.add(b);const _=new ie(.7,.15,.35),S=new w(_,x);S.position.set(1.2,.38,0),S.castShadow=!0,h.add(S);const A=new wt(.08,.3,6),R=new w(A,x);R.position.set(1.55,.38,0),R.rotation.z=Math.PI/2,h.add(R),h.userData.craftingStation={type:"forge",id:"forge",name:"Forge"},e.add(h)}_createWorkbench(e,t,i,s){const n=Math.cos(s.rotation),a=Math.sin(s.rotation),o=s.x+t*n-i*a,r=s.z+t*a+i*n,c=this.terrain.getTerrainHeight(o,r),h=new ne;h.position.set(t,c,i);const d=new B({color:7033668}),u=new ie(1.6,.1,.9),p=new w(u,d);p.position.y=.85,p.castShadow=!0,p.receiveShadow=!0,h.add(p);const f=new B({color:5914672}),y=new ce(.06,.06,.85,6);[[-.7,.425,-.35],[.7,.425,-.35],[-.7,.425,.35],[.7,.425,.35]].forEach(([b,_,S])=>{const A=new w(y,f);A.position.set(b,_,S),A.castShadow=!0,h.add(A)});const g=new B({color:5592405}),x=new ie(.2,.15,.15),v=new w(x,g);v.position.set(-.5,.98,0),h.add(v),h.userData.craftingStation={type:"workbench",id:"workbench",name:"Workbench"},e.add(h)}_createAlchemyTable(e,t,i,s){const n=Math.cos(s.rotation),a=Math.sin(s.rotation),o=s.x+t*n-i*a,r=s.z+t*a+i*n,c=this.terrain.getTerrainHeight(o,r),h=new ne;h.position.set(t,c,i);const d=new B({color:3813456}),u=new ce(.7,.6,.1,8),p=new w(u,d);p.position.y=.8,p.castShadow=!0,p.receiveShadow=!0,h.add(p);const f=new ce(.25,.35,.8,8),y=new w(f,d);y.position.y=.35,y.castShadow=!0,h.add(y);const m=new B({color:4521864,transparent:!0,opacity:.85}),g=new Pt(.06,.12,4,8),x=[[-.25,.98,.15],[.1,.98,-.2],[.3,.98,.1]],v=[4521864,16729224,4491519];x.forEach(([_,S,A],R)=>{const M=m.clone();M.color.setHex(v[R]),M.emissive&&(M.emissive.setHex(v[R]),M.emissiveIntensity=.5);const C=new w(g,M);C.position.set(_,S,A),h.add(C)});const b=new We(4521864,.8,4);b.position.set(0,1.2,0),h.add(b),h.userData.craftingStation={type:"alchemy_table",id:"alchemy_table",name:"Alchemy Table"},e.add(h)}_createFence(e,t,i,s,n){const a=Math.cos(n.rotation),o=Math.sin(n.rotation),r=n.x+t*a-i*o,c=n.z+t*o+i*a,h=this.terrain.getTerrainHeight(r,c),d=new ne;d.position.set(t,h,i),d.rotation.y=s;const u=3+Math.random()*2,p=Math.ceil(u/1.2),f=u/(p-1),y=new ce(.06,.07,1,6);for(let v=0;v<p;v++){const b=new w(y,this.materials.fenceWood);b.position.set(v*f-u/2,.5,0),b.castShadow=!0,d.add(b)}const m=new ie(u,.08,.06),g=new w(m,this.materials.fenceWood);g.position.y=.3,g.castShadow=!0,d.add(g);const x=new w(m,this.materials.fenceWood);x.position.y=.7,x.castShadow=!0,d.add(x),e.add(d)}getVillages(){return this.villages}isNearVillage(e,t,i=20){for(const s of this.villages){const n=e-s.x,a=t-s.z;if(Math.sqrt(n*n+a*a)<i)return!0}return!1}getNearbyCraftingStation(e,t,i=3){for(const s of this.villages){if(!s.craftingStations)continue;const n=Math.cos(s.rotation),a=Math.sin(s.rotation);for(const o of s.craftingStations){const r=s.x+o.localX*n-o.localZ*a,c=s.z+o.localX*a+o.localZ*n,h=e-r,d=t-c,u=Math.sqrt(h*h+d*d);if(u<i)return{type:o.type,id:o.type,name:this._getStationName(o.type),worldX:r,worldZ:c,distance:u}}}return null}_getStationName(e){return{forge:"Forge",workbench:"Workbench",alchemy_table:"Alchemy Table"}[e]||"Crafting Station"}getCampfires(){const e=[];for(const t of this.villages){if(!t.craftingStations)continue;const i=Math.cos(t.rotation),s=Math.sin(t.rotation);for(const n of t.craftingStations)if(n.type==="forge"){const a=t.x+n.localX*i-n.localZ*s,o=t.z+n.localX*s+n.localZ*i,r=this.terrain&&this.terrain.getTerrainHeight?this.terrain.getTerrainHeight(a,o):0;e.push({position:new T(a,r+.5,o),isLit:!0})}}return e}getVillagePositions(){return this.villages.map(e=>({x:e.x,z:e.z,name:e.name||"Village",type:e.type||"village"}))}getLoadedRegionCount(){return this.regions.size}dispose(){for(const[e]of this.regions)this._unloadRegion(e);for(const e of Object.values(this.materials))e.dispose()}}class _1{constructor(e,t,i=[]){this.scene=e,this.terrain=t,this.colliders=i,this.regionSize=150,this.loadDistance=2,this.unloadDistance=3,this.minDistFromCastle=80,this.ruinsPerRegion=1,this.maxSlopeForRuins=.4,this.minRuinsSpacing=60,this.materials=this._createMaterials(),this.regions=new Map,this.ruins=[],this.lastPlayerRegionX=null,this.lastPlayerRegionZ=null,this.update(0,0),console.log("[RuinsManager] Initialized with region-based generation")}_seededRandom(e){const t=Math.sin(e*12.9898+78.233)*43758.5453;return t-Math.floor(t)}_regionKey(e,t){return`${e},${t}`}_worldToRegion(e,t){return{rx:Math.floor(e/this.regionSize),rz:Math.floor(t/this.regionSize)}}update(e,t){const{rx:i,rz:s}=this._worldToRegion(e,t);if(i===this.lastPlayerRegionX&&s===this.lastPlayerRegionZ)return;this.lastPlayerRegionX=i,this.lastPlayerRegionZ=s;const n=new Set;for(let o=-this.loadDistance;o<=this.loadDistance;o++)for(let r=-this.loadDistance;r<=this.loadDistance;r++){const c=i+o,h=s+r,d=this._regionKey(c,h);n.add(d),this.regions.has(d)||this._loadRegion(c,h)}const a=[];for(const[o]of this.regions){const[r,c]=o.split(",").map(Number),h=Math.abs(r-i),d=Math.abs(c-s);(h>this.unloadDistance||d>this.unloadDistance)&&a.push(o)}for(const o of a)this._unloadRegion(o)}_loadRegion(e,t){const i=this._regionKey(e,t);if(this.regions.has(i))return;const s={ruins:[],meshes:[],localColliders:[]},n=e*this.regionSize,a=t*this.regionSize,o=e*48271+t*16807,r=15;for(let c=0;c<r;c++){const h=this._seededRandom(o+c*3),d=this._seededRandom(o+c*3+1),u=n+h*this.regionSize,p=a+d*this.regionSize;if(Math.sqrt(u*u+p*p)<this.minDistFromCastle||this.terrain.getTerrainSlope(u,p)>this.maxSlopeForRuins)continue;let m=!1;for(const _ of this.ruins){const S=u-_.x,A=p-_.z;if(Math.sqrt(S*S+A*A)<this.minRuinsSpacing){m=!0;break}}if(m)continue;const g=this.terrain.getBiome(u,p);if(g==="safe_meadow"||g==="castle")continue;const x=this.terrain.getTerrainHeight(u,p),v=["temple","monument","shrine","graveyard"],b={x:u,y:x,z:p,rotation:this._seededRandom(o+c*7)*Math.PI*2,type:v[Math.floor(this._seededRandom(o+c*11)*v.length)],enemyCampRadius:15+this._seededRandom(o+c*13)*10,regionKey:i};this._buildRuin(b,s),s.ruins.push(b),this.ruins.push(b);break}this.regions.set(i,s)}_unloadRegion(e){const t=this.regions.get(e);if(t){for(const i of t.meshes)this.scene.remove(i),i.traverse(s=>{s.geometry&&s.geometry.dispose()});for(const i of t.localColliders){const s=this.colliders.indexOf(i);s>=0&&this.colliders.splice(s,1)}this.ruins=this.ruins.filter(i=>i.regionKey!==e),this.regions.delete(e)}}_createMaterials(){return{ancientStone:new B({color:5921370}),mossyStone:new B({color:4870208}),crackedStone:new B({color:6973536}),altarStone:new B({color:3814709}),runeGlow:new B({color:4491434})}}_buildRuin(e,t){const i=new ne;switch(i.position.set(e.x,0,e.z),i.rotation.y=e.rotation,e.type){case"temple":this._createTempleRuin(i,e,t);break;case"monument":this._createMonumentRuin(i,e,t);break;case"shrine":this._createShrineRuin(i,e,t);break;case"graveyard":this._createGraveyardRuin(i,e,t);break}this.scene.add(i),t.meshes.push(i)}_createTempleRuin(e,t,i){const s=Math.cos(t.rotation),n=Math.sin(t.rotation);this._createAltar(e,0,0,t,i);const a=[[-6,-4],[-6,4],[6,-4],[6,4],[-6,0],[6,0],[-3,-4],[-3,4],[3,-4],[3,4]];for(const[o,r]of a){const c=t.x+o*s-r*n,h=t.z+o*n+r*s,d=this.terrain.getTerrainHeight(c,h),p=Math.random()>.4?1+Math.random()*2:3.5+Math.random();this._createColumn(e,o,r,p,d,t,i)}this._createCollapsedWall(e,-8,0,Math.PI/2,t,i),this._createCollapsedWall(e,8,0,-Math.PI/2,t,i)}_createMonumentRuin(e,t,i){const s=this.terrain.getTerrainHeight(t.x,t.z);this._createObelisk(e,0,0,s,i,t);const n=6,a=Math.cos(t.rotation),o=Math.sin(t.rotation);for(let r=0;r<n;r++){const c=r/n*Math.PI*2,h=5,d=Math.cos(c)*h,u=Math.sin(c)*h,p=t.x+d*a-u*o,f=t.z+d*o+u*a,y=this.terrain.getTerrainHeight(p,f),m=Math.random()>.2?.8+Math.random()*1.5:3+Math.random();this._createColumn(e,d,u,m,y,t,i)}this._createDebris(e,3,2,t),this._createDebris(e,-2,4,t)}_createShrineRuin(e,t,i){this._createSmallAltar(e,0,0,t,i);const s=Math.cos(t.rotation),n=Math.sin(t.rotation);for(const a of[-1,1]){const o=a*3,r=t.x+o*s,c=t.z+o*n,h=this.terrain.getTerrainHeight(r,c),d=2+Math.random()*1.5;this._createColumn(e,o,0,d,h,t,i)}this._createOfferingStones(e,0,2,t)}_createGraveyardRuin(e,t,i){const s=Math.cos(t.rotation),n=Math.sin(t.rotation);this._createMausoleum(e,0,0,t,i);const a=8+Math.floor(Math.random()*5);for(let o=0;o<a;o++){const r=Math.random()*Math.PI*2,c=4+Math.random()*6,h=Math.cos(r)*c,d=Math.sin(r)*c,u=t.x+h*s-d*n,p=t.z+h*n+d*s,f=this.terrain.getTerrainHeight(u,p);this._createHeadstone(e,h,d,f)}}_createColumn(e,t,i,s,n,a,o){const r=new ne;r.position.set(t,n,i);const c=new ce(.7,.8,.4,8),h=new w(c,this.materials.ancientStone);h.position.y=.2,h.castShadow=!0,h.receiveShadow=!0,r.add(h);const d=new ce(.5,.55,s,8),u=new w(d,this.materials.mossyStone);if(u.position.y=.4+s/2,u.castShadow=!0,u.receiveShadow=!0,r.add(u),s>2.5){const x=new ce(.65,.55,.3,8),v=new w(x,this.materials.crackedStone);v.position.y=.4+s+.15,v.castShadow=!0,r.add(v)}const p=Math.cos(a.rotation),f=Math.sin(a.rotation),y=a.x+t*p-i*f,m=a.z+t*f+i*p,g={type:"cylinder",position:new T(y,n,m),radius:.6,height:s+.5};this.colliders.push(g),o.localColliders.push(g),e.add(r)}_createCollapsedWall(e,t,i,s,n,a){const o=Math.cos(n.rotation),r=Math.sin(n.rotation),c=n.x+t*o-i*r,h=n.z+t*r+i*o,d=this.terrain.getTerrainHeight(c,h),u=new ne;u.position.set(t,d,i),u.rotation.y=s;const p=1.5+Math.random(),f=4+Math.random()*2,y=new ie(f,p,.6),m=new w(y,this.materials.mossyStone);m.position.y=p/2,m.castShadow=!0,m.receiveShadow=!0,u.add(m);for(let x=0;x<3;x++){const v=.3+Math.random()*.4,b=new ie(v,v*.7,v),_=new w(b,this.materials.crackedStone);_.position.set((Math.random()-.5)*f,v*.35,.6+Math.random()*.5),_.rotation.set(Math.random()*.3,Math.random()*Math.PI,Math.random()*.3),_.castShadow=!0,u.add(_)}const g={type:"box",bounds:new Qi(new T(c-f/2,d,h-.5),new T(c+f/2,d+p,h+.5))};this.colliders.push(g),a.localColliders.push(g),e.add(u)}_createAltar(e,t,i,s,n){const a=Math.cos(s.rotation),o=Math.sin(s.rotation),r=s.x+t*a-i*o,c=s.z+t*o+i*a,h=this.terrain.getTerrainHeight(r,c),d=new ne;d.position.set(t,h,i);const u=new ie(3,.4,2.5),p=new w(u,this.materials.altarStone);p.position.y=.2,p.castShadow=!0,p.receiveShadow=!0,d.add(p);const f=new ie(2,.6,1.5),y=new w(f,this.materials.altarStone);y.position.y=.7,y.castShadow=!0,y.receiveShadow=!0,d.add(y);const m=new Dt(1.2,.8),g=new w(m,this.materials.runeGlow);g.rotation.x=-Math.PI/2,g.position.y=1.01,d.add(g);const x=new We(4491434,.5,8);x.position.y=1.5,d.add(x);const v={type:"box",bounds:new Qi(new T(r-1.5,h,c-1.25),new T(r+1.5,h+1.2,c+1.25))};this.colliders.push(v),n.localColliders.push(v),e.add(d)}_createSmallAltar(e,t,i,s,n){const a=Math.cos(s.rotation),o=Math.sin(s.rotation),r=s.x+t*a-i*o,c=s.z+t*o+i*a,h=this.terrain.getTerrainHeight(r,c),d=new ne;d.position.set(t,h,i);const u=new ce(.6,.8,.8,8),p=new w(u,this.materials.altarStone);p.position.y=.4,p.castShadow=!0,p.receiveShadow=!0,d.add(p);const f=new Ai(.3,.08,8,12),y=new w(f,this.materials.ancientStone);y.rotation.x=Math.PI/2,y.position.y=.85,d.add(y);const m=new We(4491434,.3,5);m.position.y=1.2,d.add(m);const g={type:"cylinder",position:new T(r,h,c),radius:.9,height:1};this.colliders.push(g),n.localColliders.push(g),e.add(d)}_createOfferingStones(e,t,i,s){const n=Math.cos(s.rotation),a=Math.sin(s.rotation);for(let o=0;o<3;o++){const r=o/3*Math.PI*2,c=1.2,h=t+Math.cos(r)*c,d=i+Math.sin(r)*c,u=s.x+h*n-d*a,p=s.z+h*a+d*n,f=this.terrain.getTerrainHeight(u,p),y=new re(.15+Math.random()*.1,6,6),m=new w(y,this.materials.crackedStone);m.position.set(h,f+.1,d),m.scale.y=.6,m.castShadow=!0,e.add(m)}}_createObelisk(e,t,i,s,n,a){const o=new ne;o.position.set(t,s,i);const r=new ie(2.5,.6,2.5),c=new w(r,this.materials.altarStone);c.position.y=.3,c.castShadow=!0,c.receiveShadow=!0,o.add(c);const h=6+Math.random()*2,d=new ce(.3,.8,h,4),u=new w(d,this.materials.ancientStone);u.position.y=.6+h/2,u.rotation.y=Math.PI/4,u.castShadow=!0,u.receiveShadow=!0,o.add(u);const p=new wt(.4,.6,4),f=new w(p,this.materials.runeGlow);f.position.y=.6+h+.3,f.rotation.y=Math.PI/4,o.add(f);const y=new We(4491434,.8,12);y.position.y=h+1,o.add(y);const m={type:"box",bounds:new Qi(new T(a.x+t-1.25,s,a.z+i-1.25),new T(a.x+t+1.25,s+h+1,a.z+i+1.25))};this.colliders.push(m),n.localColliders.push(m),e.add(o)}_createDebris(e,t,i,s){const n=Math.cos(s.rotation),a=Math.sin(s.rotation),o=s.x+t*n-i*a,r=s.z+t*a+i*n,c=this.terrain.getTerrainHeight(o,r),h=new ne;h.position.set(t,c,i);const d=3+Math.floor(Math.random()*3);for(let u=0;u<d;u++){const p=.2+Math.random()*.4,f=new ie(p,p*.6,p*.8),y=new w(f,this.materials.crackedStone);y.position.set((Math.random()-.5)*2,p*.3,(Math.random()-.5)*2),y.rotation.set(Math.random()*.4,Math.random()*Math.PI,Math.random()*.4),y.castShadow=!0,h.add(y)}e.add(h)}_createMausoleum(e,t,i,s,n){const a=Math.cos(s.rotation),o=Math.sin(s.rotation),r=s.x+t*a-i*o,c=s.z+t*o+i*a,h=this.terrain.getTerrainHeight(r,c),d=new ne;d.position.set(t,h,i);const u=new ie(5,.3,4),p=new w(u,this.materials.altarStone);p.position.y=.15,p.castShadow=!0,p.receiveShadow=!0,d.add(p);const f=new ie(5,2.5,.4),y=new w(f,this.materials.mossyStone);y.position.set(0,1.55,-1.8),y.castShadow=!0,y.receiveShadow=!0,d.add(y);const m=new ie(.4,1.8,3.2),g=new w(m,this.materials.mossyStone);g.position.set(-2.3,1.2,-.2),g.castShadow=!0,g.receiveShadow=!0,d.add(g);const x=new ie(.4,2.2,3.2),v=new w(x,this.materials.mossyStone);v.position.set(2.3,1.4,-.2),v.castShadow=!0,v.receiveShadow=!0,d.add(v);const b=new ie(2.2,.8,1.2),_=new w(b,this.materials.altarStone);_.position.set(0,.7,-.5),_.castShadow=!0,_.receiveShadow=!0,d.add(_);const S=new ie(2.3,.2,1.3),A=new w(S,this.materials.ancientStone);A.position.set(.1,1.2,-.4),A.rotation.y=.08,A.castShadow=!0,d.add(A);const R={type:"box",bounds:new Qi(new T(r-2.5,h,c-2),new T(r+2.5,h+2.8,c+2))};this.colliders.push(R),n.localColliders.push(R),e.add(d)}_createHeadstone(e,t,i,s){const n=new ne;n.position.set(t,s,i),n.rotation.y=Math.random()*.4-.2;const a=.6+Math.random()*.4,o=.4+Math.random()*.3,r=new ie(o,a,.12),c=new w(r,this.materials.mossyStone);c.position.y=a/2,Math.random()>.6&&(c.rotation.x=(Math.random()-.5)*.3,c.rotation.z=(Math.random()-.5)*.2),c.castShadow=!0,n.add(c),e.add(n)}getRuins(){return this.ruins}isNearRuin(e,t,i=15){for(const s of this.ruins){const n=e-s.x,a=t-s.z;if(Math.sqrt(n*n+a*a)<i)return!0}return!1}getNearbyRuin(e,t,i=20){for(const s of this.ruins){const n=e-s.x,a=t-s.z;if(Math.sqrt(n*n+a*a)<i)return s}return null}getLoadedRegionCount(){return this.regions.size}dispose(){for(const[e]of this.regions)this._unloadRegion(e);for(const e of Object.values(this.materials))e.dispose()}}class M1{constructor(e,t){this.scene=e,this.terrain=t,this.regionSize=150,this.loadDistance=2,this.unloadDistance=4,this.minDistFromCastle=150,this.cavesPerRegion=1,this.minCaveSpacing=80,this.minSlopeForCave=.25,this.maxSlopeForCave=.9,this.materials=this._createMaterials(),this.regions=new Map,this.caves=[],this.lastPlayerRegionX=null,this.lastPlayerRegionZ=null,this.update(0,0),console.log("[CaveManager] Initialized with region-based generation")}_seededRandom(e){const t=Math.sin(e*12.9898+78.233)*43758.5453;return t-Math.floor(t)}_regionKey(e,t){return`${e},${t}`}_worldToRegion(e,t){return{rx:Math.floor(e/this.regionSize),rz:Math.floor(t/this.regionSize)}}update(e,t){const{rx:i,rz:s}=this._worldToRegion(e,t);if(i===this.lastPlayerRegionX&&s===this.lastPlayerRegionZ)return;this.lastPlayerRegionX=i,this.lastPlayerRegionZ=s;const n=new Set;for(let o=-this.loadDistance;o<=this.loadDistance;o++)for(let r=-this.loadDistance;r<=this.loadDistance;r++){const c=i+o,h=s+r,d=this._regionKey(c,h);n.add(d),this.regions.has(d)||this._loadRegion(c,h)}const a=[];for(const[o]of this.regions){const[r,c]=o.split(",").map(Number),h=Math.abs(r-i),d=Math.abs(c-s);(h>this.unloadDistance||d>this.unloadDistance)&&a.push(o)}for(const o of a)this._unloadRegion(o)}_loadRegion(e,t){const i=this._regionKey(e,t);if(this.regions.has(i))return;const s={caves:[],meshes:[]},n=e*this.regionSize,a=t*this.regionSize,o=e*73856093+t*19349663+54321,r=25;for(let c=0;c<r;c++){const h=this._seededRandom(o+c*3),d=this._seededRandom(o+c*3+1),u=n+h*this.regionSize,p=a+d*this.regionSize;if(Math.sqrt(u*u+p*p)<this.minDistFromCastle)continue;const y=this.terrain.getTerrainSlope(u,p);if(y<this.minSlopeForCave||y>this.maxSlopeForCave)continue;let m=!1;for(const _ of this.caves){const S=u-_.x,A=p-_.z;if(Math.sqrt(S*S+A*A)<this.minCaveSpacing){m=!0;break}}if(m)continue;const g=this.terrain.getTerrainHeight(u,p),x=Math.atan2(-u,-p),v=this._seededRandom(o+c*7)<.5?"crystal":"torch",b={x:u,y:g,z:p,rotation:x,type:v,size:1.5+this._seededRandom(o+c*11)*.5,regionKey:i};this._buildCaveEntrance(b,s),s.caves.push(b),this.caves.push(b);break}this.regions.set(i,s)}_unloadRegion(e){const t=this.regions.get(e);if(t){for(const i of t.meshes)this.scene.remove(i),i.traverse(s=>{s.geometry&&s.geometry.dispose()});this.caves=this.caves.filter(i=>i.regionKey!==e),this.regions.delete(e)}}_createMaterials(){return{caveRock:new B({color:1710618}),frameRock:new B({color:3814704}),moss:new B({color:2768928}),crystalCyan:new B({color:65535}),crystalPurple:new B({color:11167487}),torchWood:new B({color:4861984})}}_buildCaveEntrance(e,t){const i=new ne;i.position.set(e.x,e.y,e.z),i.rotation.y=e.rotation;const s=e.size;this._createCaveOpening(i,s),this._createRockyFrame(i,s),this._createDebris(i,s),e.type==="crystal"?this._createCrystalMarkers(i,s):this._createTorchMarkers(i,s),this._createAtmosphere(i,e),this.scene.add(i),t.meshes.push(i)}_createCaveOpening(e,t){const i=3.5*t,s=4*t,n=5*t,a=new Zi(i*.8,16,0,Math.PI),o=new w(a,this.materials.caveRock);o.rotation.x=-.2,o.position.set(0,s*.5,-n*.5),o.scale.y=1.2,e.add(o);const r=new Zi(i*.5,12,0,Math.PI),c=new B({color:328965}),h=new w(r,c);h.rotation.x=-.3,h.position.set(0,s*.45,-n*.8),h.scale.y=1.1,e.add(h);const d=new Dt(i*1.5,n),u=new w(d,this.materials.caveRock);u.rotation.x=-Math.PI/2,u.position.set(0,.02,-n*.3),u.receiveShadow=!0,e.add(u)}_createRockyFrame(e,t){const i=3.5*t,s=4*t;this._createRockFormation(e,-i*.7,0,0,t*1.2,s*.9),this._createRockFormation(e,i*.7,0,0,t*1,s*.85);const n=4+Math.floor(Math.random()*3);for(let a=0;a<n;a++){const o=a/(n-1),r=gt.lerp(-i*.6,i*.6,o),c=s*(.6+Math.sin(o*Math.PI)*.35),h=-.5+Math.random()*.5,d=.4+Math.random()*.4;this._createBoulder(e,r,c,h,d*t)}this._createOverhang(e,t)}_createRockFormation(e,t,i,s,n,a){const o=new ne;o.position.set(t,i,s);const r=3+Math.floor(Math.random()*2);let c=0;for(let h=0;h<r;h++){const d=a/r*(.8+Math.random()*.4),u=n*(.8-h*.1)*(.8+Math.random()*.3),p=new js(u,0),f=new w(p,this.materials.frameRock);f.position.y=c+d*.5,f.rotation.set(Math.random(),Math.random(),Math.random()),f.scale.y=d/u,f.castShadow=!0,f.receiveShadow=!0,o.add(f),c+=d*.7}e.add(o)}_createBoulder(e,t,i,s,n){const a=new js(n,0),o=new w(a,this.materials.frameRock);o.position.set(t,i,s),o.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI),o.scale.set(.8+Math.random()*.4,.6+Math.random()*.3,.8+Math.random()*.4),o.castShadow=!0,o.receiveShadow=!0,e.add(o)}_createOverhang(e,t){const i=4*t,s=new ie(5*t,.8*t,3*t),n=new w(s,this.materials.frameRock);n.position.set(0,i+.5*t,-1*t),n.rotation.x=.15,n.rotation.z=(Math.random()-.5)*.1,n.castShadow=!0,e.add(n);const a=new Dt(1.5*t,1*t),o=new w(a,this.materials.moss);o.position.set(-1*t,i+.1*t,.5*t),o.rotation.x=-Math.PI/2+.3,e.add(o)}_createDebris(e,t){const i=8+Math.floor(Math.random()*6);for(let s=0;s<i;s++){const n=Math.random()*Math.PI-Math.PI/2,a=2+Math.random()*4,o=Math.sin(n)*a*t,r=Math.cos(n)*a*t,c=.15+Math.random()*.35;this._createBoulder(e,o,c*t*.3,r,c*t)}Math.random()<.7&&this._createBoneScatter(e,t)}_createBoneScatter(e,t){const i=new B({color:13682872}),s=3+Math.floor(Math.random()*4);for(let n=0;n<s;n++){const a=(Math.random()-.5)*3*t,o=1+Math.random()*2*t,r=new ce(.03*t,.04*t,.4*t,6),c=new w(r,i);c.position.set(a,.02,o),c.rotation.x=Math.PI/2,c.rotation.z=Math.random()*Math.PI,e.add(c)}}_createCrystalMarkers(e,t){const i=[{x:-2.2,y:.3,z:.5,size:.6,angle:.4},{x:2.5,y:.5,z:.8,size:.5,angle:-.3},{x:-1.5,y:2.5,z:-.3,size:.35,angle:.6},{x:1.8,y:2.8,z:-.5,size:.4,angle:-.5},{x:0,y:.2,z:2,size:.45,angle:.2}];for(const s of i)Math.random()<.7&&this._createCrystal(e,s.x*t,s.y*t,s.z*t,s.size*t,s.angle);this._createCrystalCluster(e,-1.8*t,0,1.5*t,t*.7)}_createCrystal(e,t,i,s,n,a){const o=Math.random()<.6?this.materials.crystalCyan:this.materials.crystalPurple,r=new Ji(n,0);r.scale(1,2.5,1);const c=new w(r,o);c.position.set(t,i+n*1.2,s),c.rotation.z=a,c.rotation.y=Math.random()*Math.PI,c.castShadow=!0,e.add(c);const h=o===this.materials.crystalCyan?65535:11167487,d=new We(h,.5,5*n);d.position.copy(c.position),e.add(d)}_createCrystalCluster(e,t,i,s,n){const a=new ne;a.position.set(t,i,s);const o=4+Math.floor(Math.random()*3);for(let c=0;c<o;c++){const h=(Math.random()-.5)*n,d=(Math.random()-.5)*n,u=(.15+Math.random()*.25)*n,p=(Math.random()-.5)*.8,f=Math.random()<.5?this.materials.crystalCyan:this.materials.crystalPurple,y=new Ji(u,0);y.scale(1,2+Math.random(),1);const m=new w(y,f);m.position.set(h,u*1.2,d),m.rotation.z=p,m.rotation.y=Math.random()*Math.PI*2,a.add(m)}const r=new We(4513245,1,8);r.position.set(0,n*.5,0),a.add(r),e.add(a)}_createTorchMarkers(e,t){const i=[{x:-2.5,y:0,z:1,wallMount:!1},{x:2.5,y:0,z:1,wallMount:!1},{x:-1.5,y:2.5,z:0,wallMount:!0},{x:1.5,y:2.5,z:0,wallMount:!0}];for(const s of i)this._createTorch(e,s.x*t,s.y*t,s.z*t,t,s.wallMount)}_createTorch(e,t,i,s,n,a){const o=new ne;if(o.position.set(t,i,s),a){const x=new ie(.1*n,.1*n,.3*n),v=new w(x,this.materials.torchWood);o.add(v)}const r=a?.6*n:1.2*n,c=new ce(.05*n,.07*n,r,6),h=new w(c,this.materials.torchWood);h.position.y=r/2,h.castShadow=!0,o.add(h);const d=new ce(.08*n,.12*n,.25*n,8),u=new B({color:3351057}),p=new w(d,u);p.position.y=r+.1*n,o.add(p);const f=new We(16737826,1.5,10);f.position.y=r+.2*n,f.castShadow=!1,o.add(f);const y=new re(.06*n,8,8),m=new B({color:16729088});for(let x=0;x<4;x++){const v=new w(y,m);v.position.set((Math.random()-.5)*.1*n,r+.15*n+Math.random()*.15*n,(Math.random()-.5)*.1*n),o.add(v)}const g=()=>{requestAnimationFrame(g),f.intensity=1.3+Math.sin(Date.now()*.015)*.4+Math.random()*.2};g(),e.add(o)}_createAtmosphere(e,t){const i=new We(2236979,.3,8);i.position.set(0,2,-2),e.add(i);const s=new Dt(6*t.size,3*t.size),n=new B({color:8947865,transparent:!0,opacity:.15,side:lt,depthWrite:!1}),a=new w(s,n);a.position.set(0,1.5*t.size,-1),a.rotation.y=Math.PI,e.add(a);const o=()=>{requestAnimationFrame(o),a.position.x=Math.sin(Date.now()*5e-4)*.2,a.material.opacity=.1+Math.sin(Date.now()*.001)*.05};o()}getCaves(){return this.caves}isNearCave(e,t,i=15){for(const s of this.caves){const n=e-s.x,a=t-s.z;if(Math.sqrt(n*n+a*a)<i)return!0}return!1}getNearestCave(e,t){let i=null,s=1/0;for(const n of this.caves){const a=e-n.x,o=t-n.z,r=Math.sqrt(a*a+o*o);r<s&&(s=r,i=n)}return i?{cave:i,distance:s}:null}getLoadedRegionCount(){return this.regions.size}dispose(){for(const[e]of this.regions)this._unloadRegion(e);for(const e of Object.values(this.materials))e.dispose()}}class S1{constructor(e,t,i){this.scene=e,this.terrain=t,this.villageManager=i,this.npcsPerVillage={min:2,max:3},this.npcTypes=[{type:"merchant",bodyColor:3368618,headColor:13935988,role:"Sells goods"},{type:"guard",bodyColor:5592405,headColor:12883306,role:"Protects village"},{type:"villager",bodyColor:7033668,headColor:14530710,role:"Common folk"},{type:"elder",bodyColor:5583718,headColor:13213824,role:"Village wisdom"},{type:"blacksmith",bodyColor:3355443,headColor:13934720,role:"Crafts weapons"}],this.materials=new Map,this.npcs=[],this.meshes=[],this._populateVillages()}_getOrCreateMaterial(e,t=.8){const i=`${e.toString(16)}_${t}`;return this.materials.has(i)||this.materials.set(i,new B({color:e,roughness:t})),this.materials.get(i)}_populateVillages(){const e=this.villageManager.getVillages();for(const t of e)this._populateVillage(t);console.log(`[NPCManager] Created ${this.npcs.length} NPCs across ${e.length} villages`)}_populateVillage(e){const t=this.npcsPerVillage.min+Math.floor(Math.random()*(this.npcsPerVillage.max-this.npcsPerVillage.min+1)),i=[];for(i.push(this.npcTypes[0]),t>1&&i.push(this.npcTypes[1]);i.length<t;){const s=this.npcTypes[Math.floor(Math.random()*this.npcTypes.length)];i.push(s)}for(let s=0;s<t;s++){const n=s/t*Math.PI*2+Math.random()*.5,a=3+Math.random()*5,o=Math.cos(n)*a,r=Math.sin(n)*a,c=Math.cos(e.rotation),h=Math.sin(e.rotation),d=e.x+o*c-r*h,u=e.z+o*h+r*c,p=this.terrain.getTerrainHeight(d,u),f=i[s],y=this._createNPC(d,p,u,f,e);this.npcs.push(y)}}_createNPC(e,t,i,s,n){const a=new ne;a.position.set(e,t,i);const o=1.4+Math.random()*.2,r=.25+Math.random()*.05,c=.18+Math.random()*.02,h=.6,d=this._getOrCreateMaterial(s.bodyColor),u=new ce(r,r*.9,o-r*2,12),p=new w(u,d);p.position.y=h+o/2,p.castShadow=!0,p.receiveShadow=!0,a.add(p);const f=new re(r,12,8,0,Math.PI*2,0,Math.PI/2),y=new w(f,d);y.position.y=h+o-r,y.castShadow=!0,a.add(y);const m=new re(r*.9,12,8,0,Math.PI*2,Math.PI/2,Math.PI/2),g=new w(m,d);g.position.y=h+r,g.castShadow=!0,a.add(g);const x=this._getOrCreateMaterial(s.headColor,.6),v=new re(c,12,10),b=new w(v,x);b.position.y=h+o+c*.7,b.castShadow=!0,a.add(b);const _=this._getOrCreateMaterial(4469538,.9),S=new ce(r*.35,r*.3,h,8),A=r*.5,R=new w(S,_);R.position.set(-A,h/2,0),R.castShadow=!0,a.add(R);const M=new w(S,_);M.position.set(A,h/2,0),M.castShadow=!0,a.add(M);const C=o*.4,k=r*.25,L=new ce(k,k*.8,C,8),O=new w(L,d);O.position.set(-r-k,h+o*.7,0),O.rotation.z=.3,O.castShadow=!0,a.add(O);const W=new w(L,d);W.position.set(r+k,h+o*.7,0),W.rotation.z=-.3,W.castShadow=!0,a.add(W),this._addAccessories(a,s,h,o,r);const U=Math.atan2(n.x-e,n.z-i);return a.rotation.y=U+(Math.random()-.5)*.5,this.scene.add(a),this.meshes.push(a),{mesh:a,type:s.type,role:s.role,position:new T(e,t,i),villageX:n.x,villageZ:n.z}}_addAccessories(e,t,i,s,n){switch(t.type){case"merchant":this._addApron(e,i,s,n);break;case"guard":this._addHelmet(e,i,s),this._addSpear(e,i,s,n);break;case"blacksmith":this._addApron(e,i,s,n,2236962),this._addHammer(e,i,s,n);break;case"elder":this._addStaff(e,i,s,n);break}}_addApron(e,t,i,s,n=14540236){const a=this._getOrCreateMaterial(n,.9),o=new ie(s*1.8,i*.5,.05),r=new w(o,a);r.position.set(0,t+i*.35,s+.03),r.castShadow=!0,e.add(r)}_addHelmet(e,t,i){const s=this._getOrCreateMaterial(6710886,.4),n=new re(.22,12,8,0,Math.PI*2,0,Math.PI/2),a=new w(n,s);a.position.y=t+i+.2,a.castShadow=!0,e.add(a);const o=new Ai(.22,.03,8,16),r=new w(o,s);r.position.y=t+i+.1,r.rotation.x=Math.PI/2,e.add(r)}_addSpear(e,t,i,s){const n=this._getOrCreateMaterial(6045747,.9),a=this._getOrCreateMaterial(8947848,.3),o=2.2,r=new ce(.03,.03,o,6),c=new w(r,n);c.position.set(s+.15,t+o/2,0),c.castShadow=!0,e.add(c);const h=new wt(.06,.2,6),d=new w(h,a);d.position.set(s+.15,t+o+.1,0),d.castShadow=!0,e.add(d)}_addHammer(e,t,i,s){const n=this._getOrCreateMaterial(6045747,.9),a=this._getOrCreateMaterial(5592405,.4),o=new ce(.025,.025,.5,6),r=new w(o,n);r.position.set(s+.3,t+i*.5,.1),r.rotation.z=.3,r.castShadow=!0,e.add(r);const c=new ie(.15,.08,.08),h=new w(c,a);h.position.set(s+.4,t+i*.65,.1),h.rotation.z=.3,h.castShadow=!0,e.add(h)}_addStaff(e,t,i,s){const n=this._getOrCreateMaterial(4861984,.9),a=1.6,o=new ce(.04,.035,a,6),r=new w(o,n);r.position.set(s+.2,a/2,.15),r.rotation.z=.1,r.castShadow=!0,e.add(r);const c=new re(.06,8,6),h=new w(c,n);h.position.set(s+.2+a*.05,a+.02,.15),h.castShadow=!0,e.add(h)}getNPCs(){return this.npcs}getNPCAt(e,t,i=1.5){for(const s of this.npcs){const n=e-s.position.x,a=t-s.position.z;if(Math.sqrt(n*n+a*a)<i)return s}return null}getNPCsInVillage(e,t,i=25){return this.npcs.filter(s=>{const n=s.villageX-e,a=s.villageZ-t;return Math.sqrt(n*n+a*a)<i})}isNearNPC(e,t,i=2){return this.getNPCAt(e,t,i)!==null}update(e){}dispose(){for(const e of this.meshes)this.scene.remove(e),e.traverse(t=>{t.geometry&&t.geometry.dispose()});for(const e of this.materials.values())e.dispose();this.npcs=[],this.meshes=[],this.materials.clear()}}class T1{constructor(e){this.scene=e,this.colliders=[],this.floorZones=[],this.stairs=[],this.doors=[],this.hiddenWalls=[],this.ladders=[],this.shortcuts=[],this.bonfirePosition=new T(0,0,0),this.bossArena={active:!1,phase:"idle"},this.terrain=new x1(e),this._createStartingCastle(),this.foliage=new b1(e,this.terrain),this.villages=new w1(e,this.terrain),this.npcManager=new S1(e,this.terrain,this.villages),this.ruinsManager=new _1(e,this.terrain,this.colliders),this.caveManager=new M1(e,this.terrain),this._createLighting(),this.bonfirePosition.y=this.terrain.getTerrainHeight(0,0)}getFloorY(e,t){return this.terrain.getTerrainHeight(e,t)}getTerrainSlope(e,t){return this.terrain.getTerrainSlope(e,t)}getBiome(e,t){return this.terrain.getBiome(e,t)}checkWallCollision(e,t=.4){const i=new T;let s=!1;for(const n of this.colliders)if(n.type==="box"){const a=n.bounds;if(!a)continue;const o=a.min.x-t,r=a.max.x+t,c=a.min.z-t,h=a.max.z+t;if(e.x>o&&e.x<r&&e.z>c&&e.z<h&&e.y>a.min.y-1&&e.y<a.max.y){const d=e.x-o,u=r-e.x,p=e.z-c,f=h-e.z,y=Math.min(d,u,p,f);y===d?i.x-=d:y===u?i.x+=u:y===p?i.z-=p:i.z+=f,s=!0}}else if(n.type==="cylinder"){const a=e.x-n.position.x,o=e.z-n.position.z,r=Math.sqrt(a*a+o*o),c=n.radius+t;if(r<c&&e.y>n.position.y-4&&e.y<n.position.y+n.height){const h=c-r;r>.001&&(i.x+=a/r*h,i.z+=o/r*h),s=!0}}return s?i:null}checkTreeCollision(e,t=.4){return this.foliage?this.foliage.checkTreeCollision(e,t):null}checkCollision(e,t=.4){const i=new T;let s=!1;const n=this.checkWallCollision(e,t);n&&(i.add(n),s=!0);const a=this.checkTreeCollision(e,t);return a&&(i.add(a),s=!0),{collides:s,pushVector:i}}isNearTree(e,t,i=3){return this.foliage?this.foliage.isNearTree(e,t,i):!1}isNearVillage(e,t,i=25){return this.villages?this.villages.isNearVillage(e,t,i):!1}getVillages(){return this.villages?this.villages.getVillages():[]}isNearRuin(e,t,i=15){return this.ruinsManager?this.ruinsManager.isNearRuin(e,t,i):!1}getRuins(){return this.ruinsManager?this.ruinsManager.getRuins():[]}getNearbyRuin(e,t,i=20){return this.ruinsManager?this.ruinsManager.getNearbyRuin(e,t,i):null}isNearCave(e,t,i=15){return this.caveManager?this.caveManager.isNearCave(e,t,i):!1}getCaves(){return this.caveManager?this.caveManager.getCaves():[]}getNearestCave(e,t){return this.caveManager?this.caveManager.getNearestCave(e,t):null}isNearNPC(e,t,i=2){return this.npcManager?this.npcManager.isNearNPC(e,t,i):!1}getNPCAt(e,t,i=1.5){return this.npcManager?this.npcManager.getNPCAt(e,t,i):null}getNPCs(){return this.npcManager?this.npcManager.getNPCs():[]}_createSkybox(){const e=new re(500,32,32),t=new Ci({uniforms:{topColor:{value:new H(4491468)},horizonColor:{value:new H(8956620)},bottomColor:{value:new H(6715204)},sunDirection:{value:new T(.5,.7,.3).normalize()},sunColor:{value:new H(16777181)}},vertexShader:`
        varying vec3 vWorldPosition;
        void main() {
          vec4 worldPosition = modelMatrix * vec4(position, 1.0);
          vWorldPosition = worldPosition.xyz;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        uniform vec3 topColor;
        uniform vec3 horizonColor;
        uniform vec3 bottomColor;
        uniform vec3 sunDirection;
        uniform vec3 sunColor;
        varying vec3 vWorldPosition;
        
        void main() {
          vec3 viewDir = normalize(vWorldPosition);
          float h = viewDir.y;
          
          // Sky gradient
          vec3 sky;
          if (h > 0.0) {
            sky = mix(horizonColor, topColor, pow(h, 0.6));
          } else {
            sky = mix(horizonColor, bottomColor, pow(-h, 0.4));
          }
          
          // Sun glow
          float sunDot = max(0.0, dot(viewDir, sunDirection));
          float sunGlow = pow(sunDot, 128.0) * 2.0 + pow(sunDot, 16.0) * 0.3;
          sky += sunColor * sunGlow;
          
          // Atmospheric haze near horizon
          float haze = 1.0 - abs(h);
          haze = pow(haze, 3.0) * 0.3;
          sky = mix(sky, vec3(0.8, 0.85, 0.9), haze);
          
          gl_FragColor = vec4(sky, 1.0);
        }
      `,side:wi}),i=new w(e,t);this.scene.add(i);const s=new Zi(20,32),n=new B({color:16777198,transparent:!0,opacity:.9}),a=new w(s,n);a.position.set(150,200,100),a.lookAt(0,0,0),this.scene.add(a)}_createLighting(){const e=new qy(16772829,5596740,.3);this.scene.add(e)}_createStartingCastle(){const r=new B({color:5592405}),c=new B({color:4473924}),h=new Dt(36,46),d=new B({color:3816e3}),u=new w(h,d);u.rotation.x=-Math.PI/2,u.position.y=.05,u.receiveShadow=!0,this.scene.add(u);const p=(b,_,S,A,R,M)=>{const C=new ie(A,R,M),k=new w(C,r);k.position.set(b,_+R/2,S),k.castShadow=!0,k.receiveShadow=!0,this.scene.add(k),this.colliders.push({type:"box",bounds:new Qi(new T(b-A/2,_,S-M/2),new T(b+A/2,_+R,S+M/2))})},f=(b,_)=>{const S=new ce(3.5,4,12,8),A=new w(S,c);A.position.set(b,12/2,_),A.castShadow=!0,A.receiveShadow=!0,this.scene.add(A);const R=new ce(8/2+.2,8/2-.3,1.5,8),M=new w(R,r);M.position.set(b,12+.75,_),M.castShadow=!0,this.scene.add(M),this.colliders.push({type:"cylinder",position:new T(b,0,_),radius:8/2,height:12});const C=b>0?b-8/2-.5:b+8/2+.5,k=_>0?_-8/2-.5:_+8/2+.5;this._createTorch(C,7,k)},y=40/2,m=50/2;p(0,0,-m,40,8,2);const g=34/2;p(-y+g/2+2/2,0,m,g-2,8,2),p(y-g/2-2/2,0,m,g-2,8,2),p(-y,0,0,2,8,50),p(y,0,0,2,8,50),f(-y+8/2,-m+8/2),f(y-8/2,-m+8/2),f(-y+8/2,m-8/2),f(y-8/2,m-8/2),this._createBonfire(0,0,-5),this._createTorch(-12,5,-m+2+.5),this._createTorch(12,5,-m+2+.5),this._createTorch(-y+2+.5,5,-10),this._createTorch(-y+2+.5,5,10),this._createTorch(y-2-.5,5,-10),this._createTorch(y-2-.5,5,10),this._createTorch(-6/2-1,5,m-2-.5),this._createTorch(6/2+1,5,m-2-.5),console.log("[World] Castle torches added for starting area visibility");const x=new ie(7,1.5,2+.5),v=new w(x,c);v.position.set(0,8-.25,m),v.castShadow=!0,this.scene.add(v),console.log("[World] Starting castle created")}_createBonfire(e,t,i){const s=new ne;s.position.set(e,t,i);const n=new Ai(.8,.15,8,16),a=new B({color:3355443,roughness:.9}),o=new w(n,a);o.rotation.x=Math.PI/2,o.position.y=.1,o.castShadow=!0,s.add(o);const r=new B({color:3809296,roughness:.95});for(let p=0;p<6;p++){const f=new ce(.08,.1,.8,6),y=new w(f,r),m=p/6*Math.PI*2;y.position.set(Math.cos(m)*.3,.15,Math.sin(m)*.3),y.rotation.x=Math.PI/2,y.rotation.z=m+Math.PI/2,y.rotation.y=.3,s.add(y)}const c=new We(16746547,3,15);c.position.y=.8,c.castShadow=!0,s.add(c);const h=()=>{requestAnimationFrame(h),c.intensity=2.5+Math.sin(Date.now()*.01)*.5+Math.random()*.3};h();const d=new re(.05,8,8),u=new B({color:16737792});for(let p=0;p<8;p++){const f=new w(d,u);f.position.set((Math.random()-.5)*.4,.3+Math.random()*.5,(Math.random()-.5)*.4),s.add(f)}this.scene.add(s),this.bonfirePosition.set(e,t,i)}_createTorch(e,t,i){const s=new ne;s.position.set(e,t,i);const n=new B({color:2763306,roughness:.8,metalness:.5}),a=new ie(.15,.4,.15),o=new w(a,n);o.position.y=-.1,s.add(o);const r=new B({color:4861984,roughness:.9}),c=new ce(.05,.06,.6,6),h=new w(c,r);h.position.y=.2,s.add(h);const d=new B({color:3346688}),u=new re(.12,8,8),p=new w(u,d);p.position.y=.55,p.scale.y=1.3,s.add(p);const f=new We(16742195,2.5,18);if(f.position.y=.6,s.add(f),this.torchLights=this.torchLights||[],this.torchLights.push(f),!this._torchFlickerStarted){this._torchFlickerStarted=!0;const y=()=>{requestAnimationFrame(y);const m=Date.now()*.001;for(let g=0;g<this.torchLights.length;g++){const x=this.torchLights[g];x.intensity=2+Math.sin(m*8+g*1.7)*.4+Math.random()*.3}};y()}return this.scene.add(s),s}getItemSpawns(){return[]}getNearbyDoor(e){return null}tryOpenDoor(e,t){return!1}getNearbyLadder(e){return null}getNearbyShortcut(e){return null}unlockShortcut(e){return!1}checkHiddenWallHit(e,t){return null}revealHiddenWall(e){}checkInsideIllusoryWall(e){return null}activateBossArena(){return!1}setBossArenaPhase(e){return null}updateBossArena(e,t){return 0}deactivateBossArena(){return!1}isBlockedByFogGate(e){return!1}getBossArenaState(){return{active:!1,phase:"idle"}}dispose(){this.terrain&&this.terrain.dispose(),this.foliage&&this.foliage.dispose(),this.villages&&this.villages.dispose(),this.npcManager&&this.npcManager.dispose(),this.ruinsManager&&this.ruinsManager.dispose(),this.caveManager&&this.caveManager.dispose()}}class E1{constructor(e){this.scene=e,this.clouds=[],this.cloudCount=18,this.minY=180,this.maxY=280,this.fieldRadius=400,this.driftSpeed=.3,this.materials=[new B({color:16777215,transparent:!0,opacity:.55,side:lt,depthWrite:!1}),new B({color:15658734,transparent:!0,opacity:.45,side:lt,depthWrite:!1}),new B({color:16316671,transparent:!0,opacity:.65,side:lt,depthWrite:!1})],this.geometries=[new Dt(40,18),new Dt(55,22),new Dt(30,14),new Dt(65,28)],this._createClouds()}_createClouds(){for(let e=0;e<this.cloudCount;e++){const t=this.geometries[e%this.geometries.length],i=this.materials[e%this.materials.length],s=new ne,n=1+Math.floor(Math.random()*2);for(let r=0;r<n;r++){const c=new w(t,i);c.rotation.x=-Math.PI/2,c.position.set((Math.random()-.5)*10,r*3,(Math.random()-.5)*8),c.scale.set(.8+Math.random()*.4,1,.8+Math.random()*.4),s.add(c)}const a=Math.random()*Math.PI*2,o=Math.random()*this.fieldRadius;s.position.set(Math.cos(a)*o,this.minY+Math.random()*(this.maxY-this.minY),Math.sin(a)*o),s.rotation.y=Math.random()*Math.PI,s.userData.driftX=(.15+Math.random()*.35)*(Math.random()>.5?1:-1),s.userData.driftZ=(Math.random()-.5)*.1,this.scene.add(s),this.clouds.push(s)}}update(e,t=0,i=0){for(const s of this.clouds){s.position.x+=s.userData.driftX*e,s.position.z+=s.userData.driftZ*e;const n=s.position.x-t,a=s.position.z-i;n>this.fieldRadius&&(s.position.x-=this.fieldRadius*2),n<-this.fieldRadius&&(s.position.x+=this.fieldRadius*2),a>this.fieldRadius&&(s.position.z-=this.fieldRadius*2),a<-this.fieldRadius&&(s.position.z+=this.fieldRadius*2)}}dispose(){for(const e of this.clouds)this.scene.remove(e),e.traverse(t=>{t.geometry&&t.geometry.dispose()});this.clouds=[],this.materials.forEach(e=>e.dispose()),this.geometries.forEach(e=>e.dispose())}}const C1=[{id:"ancient-tower",name:"The Ashen Spire",position:[280,0,320],type:"tower",height:70,radius:5,color:6974058,roofColor:3816005},{id:"great-peak",name:"Frosthollow Peak",position:[-250,0,-380],type:"mountain",height:55,radius:30,color:5921362,snowColor:13421772},{id:"ruined-arch",name:"The Shattered Gate",position:[-320,0,200],type:"arch",height:45,radius:8,color:8022613,pillarColor:5917242}];class A1{constructor(e,t){this.scene=e,this.terrain=t,this.landmarks=[],this._buildLandmarks()}_buildLandmarks(){for(const e of C1){let t;switch(e.type){case"tower":t=this._buildTower(e);break;case"mountain":t=this._buildMountain(e);break;case"arch":t=this._buildArch(e);break;default:continue}const i=this.terrain?this.terrain.getTerrainHeight(e.position[0],e.position[2]):0;t.position.set(e.position[0],i,e.position[2]),this.scene.add(t),this.landmarks.push({def:e,group:t})}console.log(`[LandmarkManager] Created ${this.landmarks.length} distant landmarks`)}_buildTower(e){const t=new ne,i=new B({color:e.color}),s=new B({color:e.roofColor}),n=new ce(e.radius,e.radius*1.2,e.height,8),a=new w(n,i);a.position.y=e.height/2,t.add(a);const o=new ce(e.radius*1.4,e.radius*1.3,3,8),r=new w(o,i);r.position.y=e.height+1.5,t.add(r);const c=new wt(e.radius*1.6,12,8),h=new w(c,s);h.position.y=e.height+9,t.add(h);const d=new B({color:1710618}),u=new Dt(1.2,3);for(let y=0;y<4;y++){const m=y/4*Math.PI*2,g=new w(u,d);g.position.set(Math.sin(m)*(e.radius+.1),e.height*.7,Math.cos(m)*(e.radius+.1)),g.rotation.y=m,t.add(g)}const p=new ce(e.radius*1.6,e.radius*2,4,8),f=new w(p,i);return f.position.y=2,t.add(f),t}_buildMountain(e){const t=new ne,i=new B({color:e.color}),s=new B({color:e.snowColor}),n=new Ni(e.radius,1),a=new w(n,i);a.scale.set(1,e.height/e.radius,1),a.position.y=e.height*.4,t.add(a);const o=new wt(e.radius*.5,e.height*.35,7),r=new w(o,s);r.position.y=e.height*.85,t.add(r);for(let c=0;c<3;c++){const h=c/3*Math.PI*2+.5,d=e.radius*(.4+Math.random()*.3),u=e.height*(.2+Math.random()*.15),p=new Ni(d,0),f=new w(p,i);f.scale.set(1,u/d,1),f.position.set(Math.cos(h)*e.radius*.8,u*.3,Math.sin(h)*e.radius*.8),t.add(f)}return t}_buildArch(e){const t=new ne,i=new B({color:e.color}),s=new B({color:e.pillarColor}),n=new ie(e.radius,e.height,e.radius*.8),a=new w(n,s);a.position.set(-e.radius*1.5,e.height/2,0),t.add(a);const o=new w(n,s);o.position.set(e.radius*1.5,e.height/2,0),t.add(o);const r=new ie(e.radius*4.5,5,e.radius*.9),c=new w(r,i);c.position.set(0,e.height-1,0),c.rotation.z=.03,t.add(c);const h=new ie(e.radius*1.5,4,e.radius*.7),d=new w(h,i);d.position.set(e.radius*.5,2,e.radius*1.2),d.rotation.set(.4,.2,.6),t.add(d);const u=new ie(e.radius*4.8,1.5,e.radius*1),p=new w(u,s);return p.position.set(0,e.height+2,0),p.rotation.z=.02,t.add(p),t}dispose(){for(const{group:e}of this.landmarks)this.scene.remove(e),e.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()});this.landmarks=[]}}class R1{constructor(e,t){this.scene=e,this.terrain=t,this.poolSize=200,this.renderRadius=28,this.spacing=2.5,this.lastUpdateX=1/0,this.lastUpdateZ=1/0,this.updateThreshold=8,this.geometries=[new wt(.08,.35,3),new wt(.1,.45,3),new wt(.06,.3,3),new wt(.12,.5,4)],this.materials=[new B({color:3832368}),new B({color:3042856}),new B({color:4557370}),new B({color:4886592}),new B({color:3369e3})],this.pool=[],this._createPool()}_createPool(){for(let e=0;e<this.poolSize;e++){const t=this.geometries[e%this.geometries.length],i=this.materials[e%this.materials.length],s=new w(t,i);s.visible=!1,s.rotation.y=Math.random()*Math.PI*2,s.rotation.x=(Math.random()-.5)*.3,s.rotation.z=(Math.random()-.5)*.3,this.scene.add(s),this.pool.push(s)}}update(e,t){const i=e-this.lastUpdateX,s=t-this.lastUpdateZ;if(i*i+s*s<this.updateThreshold*this.updateThreshold)return;this.lastUpdateX=e,this.lastUpdateZ=t;let n=0;const a=this.spacing,o=this.renderRadius,r=Math.floor((e-o)/a)*a,c=Math.floor((t-o)/a)*a;for(let h=r;h<e+o&&n<this.poolSize;h+=a)for(let d=c;d<t+o&&n<this.poolSize;d+=a){const u=h-e,p=d-t;if(u*u+p*p>o*o)continue;const f=this._hash(h,d);if((f&255)>140||Math.sqrt(h*h+d*d)<35||!this.terrain)continue;const m=this.terrain.getTerrainHeight(h,d);if(m>18||m<-1.5)continue;const g=((f>>8&255)/255-.5)*a*.7,x=((f>>16&255)/255-.5)*a*.7,v=h+g,b=d+x,_=this.terrain.getTerrainHeight(v,b),S=this.pool[n];S.position.set(v,_+.15,b),S.visible=!0,n++}for(let h=n;h<this.poolSize;h++)this.pool[h].visible=!1}_hash(e,t){let i=Math.floor(e*374761)+Math.floor(t*668265)|0;return i=(i>>16^i)*73244475|0,i=(i>>16^i)*73244475|0,(i>>16^i)&2147483647}dispose(){for(const e of this.pool)this.scene.remove(e);this.pool=[],this.geometries.forEach(e=>e.dispose()),this.materials.forEach(e=>e.dispose())}}class I1{constructor(e){this.keys={},this.mouseButtons={},this.mouseDelta={x:0,y:0},this.isLocked=!1,this.buffer={},this.bufferDuration=.15,this.lmbHoldTime=0,this.lmbHoldStart=0,this.lmbWasHeld=!1,this.chargeThreshold=.4,this.domElement=e,window.addEventListener("keydown",t=>{this.keys[t.code]=!0,this._bufferAction(t.code)}),window.addEventListener("keyup",t=>{this.keys[t.code]=!1}),e.addEventListener("mousedown",t=>{this.mouseButtons[t.button]=!0,this._bufferAction(`mouse${t.button}`),t.button===0&&(this.lmbHoldStart=performance.now(),this.lmbWasHeld=!1)}),e.addEventListener("mouseup",t=>{this.mouseButtons[t.button]=!1,t.button===0&&this.lmbHoldStart>0&&(this.lmbHoldTime=(performance.now()-this.lmbHoldStart)/1e3,this.lmbHoldTime>=this.chargeThreshold&&(this.lmbWasHeld=!0,this._bufferAction("chargedAttack")),this.lmbHoldStart=0)}),e.addEventListener("mousemove",t=>{this.isLocked&&(this.mouseDelta.x+=t.movementX,this.mouseDelta.y+=t.movementY)}),e.addEventListener("click",()=>{this.isLocked||e.requestPointerLock()}),document.addEventListener("pointerlockchange",()=>{this.isLocked=document.pointerLockElement===e}),e.addEventListener("contextmenu",t=>t.preventDefault())}_bufferAction(e){this.buffer[e]=this.bufferDuration}update(e){const t=e||.016666666666666666;for(const i in this.buffer)this.buffer[i]-=t,this.buffer[i]<=0&&delete this.buffer[i]}consumeBuffer(e){return this.buffer[e]?(delete this.buffer[e],!0):!1}getMouseDelta(){const e={x:this.mouseDelta.x,y:this.mouseDelta.y};return this.mouseDelta.x=0,this.mouseDelta.y=0,e}get moveForward(){return this.keys.KeyW}get moveBack(){return this.keys.KeyS}get moveLeft(){return this.keys.KeyA}get moveRight(){return this.keys.KeyD}get dodge(){return this.consumeBuffer("Space")}get lightAttack(){return this.consumeBuffer("mouse0")}get heavyAttack(){return this.consumeBuffer("mouse2")}get block(){return this.keys.ShiftLeft||this.keys.ShiftRight}get lockOn(){return this.consumeBuffer("KeyQ")}get interact(){return this.consumeBuffer("KeyE")}get dashAbility(){return this.consumeBuffer("KeyR")}get parryAbility(){return this.consumeBuffer("KeyF")}get warCryAbility(){return this.consumeBuffer("KeyG")}get chargedAttack(){return this.consumeBuffer("chargedAttack")}get useHealthPotion(){return(this.keys.ControlLeft||this.keys.ControlRight)&&this.consumeBuffer("Digit1")}get useStaminaPotion(){return(this.keys.ControlLeft||this.keys.ControlRight)&&this.consumeBuffer("Digit2")}get useManaPotion(){return(this.keys.ControlLeft||this.keys.ControlRight)&&this.consumeBuffer("Digit3")}get cycleWeapon(){return this.consumeBuffer("KeyQ")||this.consumeBuffer("Tab")}get weaponSlot1(){return this.consumeBuffer("Digit1")}get weaponSlot2(){return this.consumeBuffer("Digit2")}get weaponSlot3(){return this.consumeBuffer("Digit3")}get weaponSlot4(){return this.consumeBuffer("Digit4")}get weaponSlotsActive(){return!0}get openEquipment(){return this.consumeBuffer("KeyI")}get craftingToggle(){return this.consumeBuffer("KeyC")}get escape(){return this.consumeBuffer("Escape")}get castSpell(){return this.consumeBuffer("KeyF")}get spellSlot1(){return this.consumeBuffer("F1")}get spellSlot2(){return this.consumeBuffer("F2")}get spellSlot3(){return this.consumeBuffer("F3")}get spellSlot4(){return this.consumeBuffer("F4")}get spellSlot5(){return this.consumeBuffer("F5")}get spellSlot6(){return this.consumeBuffer("F6")}get selectSpellSlot1(){return(this.keys.ShiftLeft||this.keys.ShiftRight)&&this.consumeBuffer("Digit1")}get selectSpellSlot2(){return(this.keys.ShiftLeft||this.keys.ShiftRight)&&this.consumeBuffer("Digit2")}get selectSpellSlot3(){return(this.keys.ShiftLeft||this.keys.ShiftRight)&&this.consumeBuffer("Digit3")}get selectSpellSlot4(){return(this.keys.ShiftLeft||this.keys.ShiftRight)&&this.consumeBuffer("Digit4")}get selectSpellSlot5(){return(this.keys.ShiftLeft||this.keys.ShiftRight)&&this.consumeBuffer("Digit5")}get selectSpellSlot6(){return(this.keys.ShiftLeft||this.keys.ShiftRight)&&this.consumeBuffer("Digit6")}get isChargingAttack(){return this.mouseButtons[0]&&this.lmbHoldStart>0}getChargeProgress(){if(!this.isChargingAttack)return 0;const e=(performance.now()-this.lmbHoldStart)/1e3;return Math.min(1,e/this.chargeThreshold)}getMovementVector(){let e=0,t=0;this.moveForward&&(t-=1),this.moveBack&&(t+=1),this.moveLeft&&(e-=1),this.moveRight&&(e+=1);const i=Math.sqrt(e*e+t*t);return i>0&&(e/=i,t/=i),{x:e,z:t}}}const Di={PHYSICAL:"physical",FIRE:"fire",ICE:"ice",LIGHTNING:"lightning",SHADOW:"shadow",NATURE:"nature",HOLY:"holy"},Cn={AGGRESSIVE:{moveSpeedMult:1.3,attackCooldownMult:.7,damageMult:1.2},DESPERATE:{moveSpeedMult:1.5,attackCooldownMult:.5,damageMult:1.4,canEnrage:!0},DEFENSIVE:{moveSpeedMult:.8,attackCooldownMult:1.2,damageReduction:.3}},Ba={ANCIENT_GOLEM:{id:"ancient_golem",name:"Gormund",title:"The Ancient Golem",fullTitle:"Gormund, The Ancient Golem",description:"A massive stone construct awakened from centuries of slumber. Its crystalline core pulses with ancient magic.",stats:{maxHealth:1500,health:1500,maxPosture:200,posture:0,damage:45,defense:30,moveSpeed:2,attackRange:4,detectionRange:18},scale:3.5,poise:100,weaknesses:[Di.LIGHTNING,Di.NATURE],resistances:[Di.PHYSICAL,Di.FIRE],immunities:[Di.SHADOW],bodyColor:5921386,accentColor:4491519,eyeColor:4500223,glowColor:4491519,auraColor:2241382,modelType:"golem",phases:[{id:1,name:"Awakened",threshold:1,abilities:["GROUND_POUND","STOMP"],attackPattern:"methodical",modifiers:{},music:"boss_phase1"},{id:2,name:"Enraged",threshold:.6,abilities:["GROUND_POUND","STOMP","BOULDER_THROW"],attackPattern:"aggressive",modifiers:Cn.AGGRESSIVE,newAbility:"BOULDER_THROW",visualChange:{glowIntensity:1.5,colorShift:16737860},transitionDuration:3,transitionRoar:!0,music:"boss_phase2"},{id:3,name:"Crystalline Fury",threshold:.25,abilities:["GROUND_POUND","STOMP","BOULDER_THROW","CRYSTAL_ARMOR"],attackPattern:"desperate",modifiers:Cn.DESPERATE,newAbility:"CRYSTAL_ARMOR",visualChange:{glowIntensity:2.5,colorShift:16720384,sizeScale:1.1},transitionDuration:4,transitionRoar:!0,music:"boss_phase3"}],lootTable:{guaranteed:[{id:"golem_soul",name:"Gormund's Soul",type:"boss_soul",quantity:1},{id:"ancient_core",name:"Ancient Core",type:"material",quantity:1}],common:[{id:"stone_chunk",name:"Enchanted Stone",type:"material",quantity:{min:3,max:6},chance:1},{id:"crystal_shard",name:"Crystal Shard",type:"material",quantity:{min:2,max:4},chance:.8}],rare:[{id:"golem_fist",name:"Gormund's Fist",type:"weapon",rarity:"legendary",chance:.15},{id:"crystal_armor",name:"Crystalline Plate",type:"armor",rarity:"epic",chance:.25}],remnants:3e3,firstKillBonus:{remnants:2e3,items:[{id:"golem_trophy",name:"Golem Slayer's Trophy",type:"trophy"}]}},spawnLocation:{x:150,z:200,y:0,areaName:"Stone Circle Ruins",landmarkType:"ancient_ruins"},arena:{radius:25,boundaryType:"stone_pillars",fogDensity:.02,ambientColor:3359829,props:["broken_pillars","stone_debris","crystal_formations"]},respawnTime:600},SHADOW_WRAITH:{id:"shadow_wraith",name:"Vexaris",title:"The Shadow Wraith",fullTitle:"Vexaris, The Shadow Wraith",description:"A being of pure darkness, this wraith moves between shadows with terrifying speed. Its touch drains the very life from its victims.",stats:{maxHealth:1e3,health:1e3,maxPosture:120,posture:0,damage:40,defense:10,moveSpeed:5,attackRange:3,detectionRange:25},scale:2.5,poise:40,weaknesses:[Di.HOLY,Di.FIRE],resistances:[Di.SHADOW,Di.ICE],immunities:[],bodyColor:1710634,accentColor:6693546,eyeColor:11150079,glowColor:6693546,auraColor:2228275,modelType:"wraith",phases:[{id:1,name:"Stalking",threshold:1,abilities:["SHADOW_BOLT","SHADOW_DASH","TELEPORT"],attackPattern:"hit_and_run",modifiers:{},music:"boss_wraith_phase1"},{id:2,name:"Unleashed",threshold:.5,abilities:["SHADOW_BOLT","SHADOW_DASH","TELEPORT","VOID_ERUPTION"],attackPattern:"aggressive",modifiers:{...Cn.AGGRESSIVE,teleportFrequency:2},newAbility:"VOID_ERUPTION",visualChange:{opacity:.7,trailEffect:!0,colorShift:11158783},transitionDuration:2.5,transitionRoar:!1,transitionEffect:"shadow_explosion",music:"boss_wraith_phase2"},{id:3,name:"Void Form",threshold:.2,abilities:["SHADOW_BOLT","SHADOW_DASH","TELEPORT","VOID_ERUPTION","SOUL_DRAIN"],attackPattern:"desperate",modifiers:{...Cn.DESPERATE,invulnerableDuringTeleport:!0},newAbility:"SOUL_DRAIN",visualChange:{opacity:.4,sizeScale:1.3,colorShift:16711935},transitionDuration:3,transitionEffect:"void_collapse",music:"boss_wraith_phase3"}],lootTable:{guaranteed:[{id:"wraith_soul",name:"Vexaris's Soul",type:"boss_soul",quantity:1},{id:"shadow_essence",name:"Shadow Essence",type:"material",quantity:1}],common:[{id:"dark_fragment",name:"Dark Fragment",type:"material",quantity:{min:4,max:8},chance:1},{id:"void_dust",name:"Void Dust",type:"material",quantity:{min:2,max:5},chance:.9}],rare:[{id:"shadow_blade",name:"Vexaris's Shadow Blade",type:"weapon",rarity:"legendary",chance:.15},{id:"wraith_cloak",name:"Cloak of Shadows",type:"armor",rarity:"epic",chance:.25}],remnants:2500,firstKillBonus:{remnants:1500,items:[{id:"wraith_trophy",name:"Wraith Hunter's Trophy",type:"trophy"}]}},spawnLocation:{x:-180,z:280,y:0,areaName:"The Void Hollow",landmarkType:"dark_cave"},arena:{radius:30,boundaryType:"shadow_barrier",fogDensity:.05,ambientColor:1114146,props:["shadow_pillars","void_cracks","floating_debris"],specialMechanic:"darkness_zones"},respawnTime:480},FOREST_GUARDIAN:{id:"forest_guardian",name:"Thornwood",title:"The Forest Guardian",fullTitle:"Thornwood, Guardian of the Ancient Grove",description:"A towering treant that has protected this forest for millennia. Its bark is harder than iron, and it commands the very plants around it.",stats:{maxHealth:2e3,health:2e3,maxPosture:250,posture:0,damage:38,defense:35,moveSpeed:1.5,attackRange:6,detectionRange:20},scale:4,poise:150,weaknesses:[Di.FIRE],resistances:[Di.NATURE,Di.PHYSICAL,Di.ICE],immunities:[],bodyColor:3820074,accentColor:6728260,eyeColor:8978244,glowColor:4500002,auraColor:2245649,modelType:"treant",phases:[{id:1,name:"Rooted",threshold:1,abilities:["VINE_WHIP","ROOT_PRISON"],attackPattern:"defensive",modifiers:Cn.DEFENSIVE,music:"boss_guardian_phase1"},{id:2,name:"Awakened Grove",threshold:.65,abilities:["VINE_WHIP","ROOT_PRISON","SUMMON_TREANTS"],attackPattern:"summoner",modifiers:{},newAbility:"SUMMON_TREANTS",visualChange:{leafParticles:!0,glowIntensity:1.3},transitionDuration:3.5,transitionRoar:!0,music:"boss_guardian_phase2"},{id:3,name:"Nature's Wrath",threshold:.3,abilities:["VINE_WHIP","ROOT_PRISON","SUMMON_TREANTS","NATURE_WRATH","REGENERATION"],attackPattern:"aggressive",modifiers:{...Cn.AGGRESSIVE,summonOnDamage:!0},newAbility:"NATURE_WRATH",visualChange:{leafParticles:!0,glowIntensity:2,colorShift:16746564,thornsVisible:!0},transitionDuration:4,transitionRoar:!0,music:"boss_guardian_phase3"}],lootTable:{guaranteed:[{id:"guardian_soul",name:"Thornwood's Soul",type:"boss_soul",quantity:1},{id:"heartwood",name:"Ancient Heartwood",type:"material",quantity:1}],common:[{id:"enchanted_bark",name:"Enchanted Bark",type:"material",quantity:{min:4,max:8},chance:1},{id:"verdant_essence",name:"Verdant Essence",type:"material",quantity:{min:2,max:5},chance:.9},{id:"thornvine",name:"Thornvine",type:"material",quantity:{min:3,max:6},chance:.85}],rare:[{id:"guardian_staff",name:"Thornwood's Staff",type:"weapon",rarity:"legendary",chance:.15},{id:"bark_armor",name:"Ironbark Armor",type:"armor",rarity:"epic",chance:.25},{id:"ring_of_nature",name:"Ring of the Grove",type:"accessory",rarity:"epic",chance:.2}],remnants:3500,firstKillBonus:{remnants:2500,items:[{id:"guardian_trophy",name:"Grove Protector's Trophy",type:"trophy"}]}},spawnLocation:{x:80,z:-220,y:0,areaName:"The Ancient Grove",landmarkType:"sacred_grove"},arena:{radius:35,boundaryType:"thick_vegetation",fogDensity:.01,ambientColor:4482611,props:["giant_trees","glowing_mushrooms","moss_covered_stones"],specialMechanic:"healing_zones"},respawnTime:720},CORRUPTED_KNIGHT:{id:"corrupted_knight",name:"Sir Aldric",title:"The Corrupted Knight",fullTitle:"Sir Aldric, The Fallen Paladin",description:"Once a noble defender of the realm, this knight fell to dark corruption. His skills remain formidable, twisted now by shadow magic.",stats:{maxHealth:1200,health:1200,maxPosture:180,posture:0,damage:50,defense:25,moveSpeed:3.5,attackRange:3.5,detectionRange:16},scale:2,poise:80,weaknesses:[Di.HOLY],resistances:[Di.PHYSICAL,Di.SHADOW],immunities:[],bodyColor:2763317,accentColor:8912964,eyeColor:16720452,glowColor:8912964,auraColor:3342370,modelType:"knight",phases:[{id:1,name:"Disciplined",threshold:1,abilities:["SWORD_COMBO","SHIELD_BASH"],attackPattern:"tactical",modifiers:{},music:"boss_knight_phase1"},{id:2,name:"Aggressive",threshold:.6,abilities:["SWORD_COMBO","SHIELD_BASH","CHARGE_ATTACK"],attackPattern:"aggressive",modifiers:Cn.AGGRESSIVE,newAbility:"CHARGE_ATTACK",visualChange:{corruptionAura:!0,eyeGlow:1.5},transitionDuration:2.5,transitionRoar:!0,music:"boss_knight_phase2"},{id:3,name:"Corrupted",threshold:.3,abilities:["SWORD_COMBO","SHIELD_BASH","CHARGE_ATTACK","DARK_SLAM","ENRAGE"],attackPattern:"desperate",modifiers:{...Cn.DESPERATE,shieldDisabled:!0},newAbility:"DARK_SLAM",visualChange:{corruptionAura:!0,eyeGlow:2.5,armorCracked:!0,colorShift:16711748},transitionDuration:3,transitionRoar:!0,transitionEffect:"corruption_burst",music:"boss_knight_phase3"}],lootTable:{guaranteed:[{id:"knight_soul",name:"Sir Aldric's Soul",type:"boss_soul",quantity:1},{id:"corrupted_sigil",name:"Corrupted Sigil",type:"material",quantity:1}],common:[{id:"dark_metal",name:"Dark Metal Shard",type:"material",quantity:{min:3,max:6},chance:1},{id:"corrupt_essence",name:"Corrupt Essence",type:"material",quantity:{min:2,max:4},chance:.9}],rare:[{id:"aldric_sword",name:"Aldric's Corrupted Blade",type:"weapon",rarity:"legendary",chance:.15},{id:"fallen_shield",name:"Shield of the Fallen",type:"shield",rarity:"epic",chance:.2},{id:"knight_armor",name:"Corrupted Paladin Armor",type:"armor",rarity:"epic",chance:.25}],remnants:2800,firstKillBonus:{remnants:2e3,items:[{id:"knight_trophy",name:"Knight Slayer's Trophy",type:"trophy"}]}},spawnLocation:{x:-100,z:-150,y:0,areaName:"Ruined Chapel",landmarkType:"ruined_church"},arena:{radius:20,boundaryType:"ruined_walls",fogDensity:.015,ambientColor:3351091,props:["broken_altar","fallen_statues","corrupted_banners"],specialMechanic:"corruption_zones"},respawnTime:540}},k1={golem_soul:{id:"golem_soul",name:"Gormund's Soul",description:"The crystalline essence of the Ancient Golem. Radiates ancient power.",bossId:"ancient_golem",exchangeOptions:[{id:"golem_fist_weapon",name:"Golem's Wrath",type:"weapon",category:"fist"},{id:"stone_skin_spell",name:"Stone Skin",type:"spell"},{id:"remnants",quantity:5e3}]},wraith_soul:{id:"wraith_soul",name:"Vexaris's Soul",description:"Dark energy swirls within this ephemeral essence.",bossId:"shadow_wraith",exchangeOptions:[{id:"shadow_blade_weapon",name:"Shadow Blade",type:"weapon",category:"dagger"},{id:"shadow_step_spell",name:"Shadow Step",type:"spell"},{id:"remnants",quantity:4500}]},guardian_soul:{id:"guardian_soul",name:"Thornwood's Soul",description:"Pulsing with the life force of the ancient forest.",bossId:"forest_guardian",exchangeOptions:[{id:"guardian_staff_weapon",name:"Nature's Warden",type:"weapon",category:"staff"},{id:"entangle_spell",name:"Entangle",type:"spell"},{id:"remnants",quantity:6e3}]},knight_soul:{id:"knight_soul",name:"Sir Aldric's Soul",description:"A tortured soul seeking redemption... or vengeance.",bossId:"corrupted_knight",exchangeOptions:[{id:"aldric_blade_weapon",name:"Paladin's Fall",type:"weapon",category:"greatsword"},{id:"dark_aura_spell",name:"Dark Aura",type:"spell"},{id:"remnants",quantity:5500}]}};function wd(l){const e=l.toUpperCase();if(Ba[e])return Ba[e];for(const t of Object.keys(Ba))if(Ba[t].id===l)return Ba[t];return null}function P1(){return Object.values(Ba).map(l=>({bossId:l.id,name:l.name,title:l.title,...l.spawnLocation,arena:l.arena}))}function D1(l,e=!1){const t=wd(l);if(!t)return{items:[],remnants:0};const i={items:[],remnants:t.lootTable.remnants};i.items.push(...t.lootTable.guaranteed);for(const s of t.lootTable.common)if(Math.random()<s.chance){const n=typeof s.quantity=="object"?Math.floor(Math.random()*(s.quantity.max-s.quantity.min+1))+s.quantity.min:s.quantity;i.items.push({...s,quantity:n})}for(const s of t.lootTable.rare)Math.random()<s.chance&&i.items.push({...s,quantity:1});return e&&t.lootTable.firstKillBonus&&(i.remnants+=t.lootTable.firstKillBonus.remnants,i.items.push(...t.lootTable.firstKillBonus.items)),i}const jp={GOLEM_SOUL:{id:"golem_soul",name:"Gormund's Soul",type:"boss_soul",description:"The crystalline essence of the Ancient Golem. Radiates ancient power.",color:4491519,emissive:2254540,stackable:!1,rarity:"legendary",bossId:"ancient_golem"},WRAITH_SOUL:{id:"wraith_soul",name:"Vexaris's Soul",type:"boss_soul",description:"Dark energy swirls within this ephemeral essence.",color:11150079,emissive:6689194,stackable:!1,rarity:"legendary",bossId:"shadow_wraith"},GUARDIAN_SOUL:{id:"guardian_soul",name:"Thornwood's Soul",type:"boss_soul",description:"Pulsing with the life force of the ancient forest.",color:8978244,emissive:4500002,stackable:!1,rarity:"legendary",bossId:"forest_guardian"},KNIGHT_SOUL:{id:"knight_soul",name:"Sir Aldric's Soul",type:"boss_soul",description:"A tortured soul seeking redemption... or vengeance.",color:16720452,emissive:11145523,stackable:!1,rarity:"legendary",bossId:"corrupted_knight"},ANCIENT_CORE:{id:"ancient_core",name:"Ancient Core",type:"material",description:"The magical heart of a golem. Extremely rare crafting material.",color:6728447,emissive:4491468,stackable:!0,maxStack:5,rarity:"epic"},SHADOW_ESSENCE:{id:"shadow_essence",name:"Shadow Essence",type:"material",description:"Concentrated darkness from the void. Use with caution.",color:6693546,emissive:4460936,stackable:!0,maxStack:10,rarity:"epic"},HEARTWOOD:{id:"heartwood",name:"Ancient Heartwood",type:"material",description:"Living wood from the heart of a treant guardian.",color:6728260,emissive:4491298,stackable:!0,maxStack:5,rarity:"epic"},CORRUPTED_SIGIL:{id:"corrupted_sigil",name:"Corrupted Sigil",type:"material",description:"A holy symbol twisted by dark corruption.",color:8912964,emissive:5570611,stackable:!0,maxStack:5,rarity:"epic"},GOLEM_TROPHY:{id:"golem_trophy",name:"Golem Slayer's Trophy",type:"trophy",description:"Proof that you have defeated the Ancient Golem.",color:16766720,emissive:11175936,stackable:!1,rarity:"legendary"},WRAITH_TROPHY:{id:"wraith_trophy",name:"Wraith Hunter's Trophy",type:"trophy",description:"Proof that you have defeated the Shadow Wraith.",color:16766720,emissive:11175936,stackable:!1,rarity:"legendary"},GUARDIAN_TROPHY:{id:"guardian_trophy",name:"Grove Protector's Trophy",type:"trophy",description:"Proof that you have defeated the Forest Guardian.",color:16766720,emissive:11175936,stackable:!1,rarity:"legendary"},KNIGHT_TROPHY:{id:"knight_trophy",name:"Knight Slayer's Trophy",type:"trophy",description:"Proof that you have defeated the Corrupted Knight.",color:16766720,emissive:11175936,stackable:!1,rarity:"legendary"}},Fs={GOLD:{id:"gold",name:"Gold",type:"currency",description:"Currency for trading with merchants",color:16766720,emissive:11175936,stackable:!0},HEALTH_POTION:{id:"health-potion",name:"Health Potion",type:"consumable",description:"Restores 50 HP when used",effect:{healAmount:50},color:16729156,emissive:11149858,stackable:!0,maxStack:10,hotkey:"1"},STAMINA_POTION:{id:"stamina-potion",name:"Stamina Potion",type:"consumable",description:"Restores 75 Stamina when used",effect:{staminaAmount:75},color:4521796,emissive:2271778,stackable:!0,maxStack:10,hotkey:"2"},MANA_POTION:{id:"mana-potion",name:"Mana Potion",type:"consumable",description:"Restores 50 Mana when used (Phase 20)",effect:{manaAmount:50},color:4491519,emissive:2250188,stackable:!0,maxStack:10,hotkey:"3"},IRON_ORE:{id:"iron-ore",name:"Iron Ore",type:"material",description:"Raw metal for crafting weapons and armor",color:8947865,emissive:4473941,stackable:!0,maxStack:99},DARK_SHARD:{id:"dark-shard",name:"Dark Shard",type:"material",description:"Crystallized corruption. Used in advanced crafting.",color:6693546,emissive:4460936,stackable:!0,maxStack:50},BONE_FRAGMENT:{id:"bone-fragment",name:"Bone Fragment",type:"material",description:"Remains of fallen warriors. Used for crafting.",color:14535850,emissive:8943445,stackable:!0,maxStack:99},SPIRIT_ESSENCE:{id:"spirit-essence",name:"Spirit Essence",type:"material",description:"A wisp of captured soul energy. Rare material.",color:8969727,emissive:4495803,stackable:!0,maxStack:20}},Kp={hollow_soldier:[{itemId:"gold",chance:.9,minQty:5,maxQty:15},{itemId:"health-potion",chance:.15,minQty:1,maxQty:1},{itemId:"bone_shard",chance:.35,minQty:1,maxQty:3},{itemId:"tattered_cloth",chance:.25,minQty:1,maxQty:2}],berserker:[{itemId:"gold",chance:.95,minQty:10,maxQty:25},{itemId:"health-potion",chance:.2,minQty:1,maxQty:1},{itemId:"stamina-potion",chance:.2,minQty:1,maxQty:1},{itemId:"bone_shard",chance:.4,minQty:1,maxQty:3},{itemId:"beast_fang",chance:.2,minQty:1,maxQty:2},{itemId:"dark-shard",chance:.1,minQty:1,maxQty:1}],sentinel:[{itemId:"gold",chance:1,minQty:20,maxQty:40},{itemId:"health-potion",chance:.25,minQty:1,maxQty:2},{itemId:"iron_ore",chance:.35,minQty:1,maxQty:3},{itemId:"bone_shard",chance:.4,minQty:2,maxQty:4},{itemId:"crude_leather",chance:.2,minQty:1,maxQty:2}],revenant:[{itemId:"gold",chance:.85,minQty:8,maxQty:18},{itemId:"stamina-potion",chance:.2,minQty:1,maxQty:1},{itemId:"mana-potion",chance:.15,minQty:1,maxQty:1},{itemId:"shadow_essence",chance:.25,minQty:1,maxQty:2},{itemId:"spirit-essence",chance:.15,minQty:1,maxQty:1},{itemId:"dark-shard",chance:.2,minQty:1,maxQty:2}],ranged:[{itemId:"gold",chance:.85,minQty:8,maxQty:20},{itemId:"health-potion",chance:.15,minQty:1,maxQty:1},{itemId:"bone_shard",chance:.2,minQty:1,maxQty:2},{itemId:"tattered_cloth",chance:.3,minQty:1,maxQty:2}],wolf:[{itemId:"gold",chance:.6,minQty:3,maxQty:8},{itemId:"beast_fang",chance:.5,minQty:1,maxQty:2},{itemId:"beast_hide",chance:.4,minQty:1,maxQty:2},{itemId:"raw_meat",chance:.3,minQty:1,maxQty:1}],slime:[{itemId:"gold",chance:.4,minQty:2,maxQty:6},{itemId:"slime_gel",chance:.6,minQty:1,maxQty:3},{itemId:"poison_gland",chance:.15,minQty:1,maxQty:1}],spider:[{itemId:"gold",chance:.5,minQty:4,maxQty:10},{itemId:"spider_silk",chance:.4,minQty:1,maxQty:2},{itemId:"poison_gland",chance:.25,minQty:1,maxQty:1},{itemId:"chitin_shard",chance:.2,minQty:1,maxQty:2}],elite:[{itemId:"gold",chance:1,minQty:30,maxQty:60},{itemId:"health-potion",chance:.4,minQty:1,maxQty:2},{itemId:"stamina-potion",chance:.35,minQty:1,maxQty:2},{itemId:"mana-potion",chance:.3,minQty:1,maxQty:2},{itemId:"iron_ore",chance:.4,minQty:2,maxQty:4},{itemId:"dark-shard",chance:.3,minQty:1,maxQty:3},{itemId:"spirit-essence",chance:.2,minQty:1,maxQty:1},{itemId:"mythril_ore",chance:.1,minQty:1,maxQty:1},{itemId:"dragon_scale",chance:.05,minQty:1,maxQty:1}],boss:[{itemId:"gold",chance:1,minQty:200,maxQty:400},{itemId:"health-potion",chance:1,minQty:3,maxQty:5},{itemId:"stamina-potion",chance:1,minQty:3,maxQty:5},{itemId:"mana-potion",chance:1,minQty:2,maxQty:4},{itemId:"dark-shard",chance:1,minQty:5,maxQty:10},{itemId:"spirit-essence",chance:1,minQty:3,maxQty:5},{itemId:"mythril_ore",chance:.5,minQty:2,maxQty:4},{itemId:"dragon_scale",chance:.3,minQty:1,maxQty:2}],default:[{itemId:"gold",chance:.8,minQty:3,maxQty:10},{itemId:"bone_shard",chance:.2,minQty:1,maxQty:1},{itemId:"tattered_cloth",chance:.1,minQty:1,maxQty:1}]};function L1(l){if(l.isBoss)return"boss";if(l.config?.isElite)return"elite";const e=(l.config?.name||"").toLowerCase();return e.includes("hollow")||e.includes("soldier")||e.includes("skeleton")?"hollow_soldier":e.includes("berserker")||e.includes("brute")?"berserker":e.includes("sentinel")||e.includes("guard")||e.includes("knight")?"sentinel":e.includes("revenant")||e.includes("wraith")||e.includes("ghost")?"revenant":e.includes("archer")||e.includes("ranged")||e.includes("mage")||e.includes("caster")?"ranged":e.includes("wolf")||e.includes("hound")||e.includes("beast")?"wolf":e.includes("slime")||e.includes("ooze")||e.includes("blob")?"slime":e.includes("spider")||e.includes("arachnid")?"spider":"default"}class O1{constructor(e,t){this.scene=e,this.gm=t,this.drops=[],this.inventory={gold:0,items:{},potionHotbar:["health-potion","stamina-potion"]},this.pickupRadius=2,this.notificationQueue=[],this.notificationActive=!1,this._loadInventory(),this._ensureNotificationUI()}_ensureNotificationUI(){if(!document.getElementById("loot-notification")){const e=document.createElement("div");e.id="loot-notification",e.style.cssText=`
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.85);
        color: #fff;
        padding: 10px 25px;
        border-radius: 6px;
        font-family: 'Georgia', serif;
        font-size: 18px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 1000;
        border: 1px solid #444;
        text-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
      `,document.body.appendChild(e)}}_loadInventory(){try{const e=localStorage.getItem("ashen_inventory");if(e){const t=JSON.parse(e);this.inventory.gold=t.gold||0,this.inventory.items=t.items||{},t.potionHotbar&&(this.inventory.potionHotbar=t.potionHotbar),console.log("[LootManager] Loaded inventory:",this.inventory)}}catch(e){console.warn("[LootManager] Failed to load inventory:",e)}}_saveInventory(){try{localStorage.setItem("ashen_inventory",JSON.stringify(this.inventory))}catch(e){console.warn("[LootManager] Failed to save inventory:",e)}}rollLoot(e,t){const i=L1(e),s=Kp[i]||Kp.default,n=[];for(const a of s)if(Math.random()<a.chance){const o=Math.floor(Math.random()*(a.maxQty-a.minQty+1))+a.minQty;n.push({itemId:a.itemId,quantity:o})}if(this._spawnDrops(n,t),this.equipmentManager){const a=this.equipmentManager.generateEquipmentDrop(i);a&&(this.equipmentManager.addToInventory(a),console.log(`[LootManager] Equipment dropped: ${a.name}`))}return n}_spawnDrops(e,t){const s=Math.PI*2/Math.max(e.length,1);e.forEach((n,a)=>{const o=Object.values(Fs).find(d=>d.id===n.itemId);if(!o)return;const r=s*a+Math.random()*.3,c=.5+Math.random()*.3,h=t.clone();h.x+=Math.cos(r)*c,h.z+=Math.sin(r)*c,h.y=.3,this._createDropVisual(o,n.quantity,h)})}_createDropVisual(e,t,i){const s={id:`drop-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,itemDef:e,quantity:t,position:i.clone(),collected:!1,mesh:null,light:null,spawnTime:Date.now()};let n,a;e.id==="gold"?(n=new ce(.12,.14,.08,12),a=new X({color:e.color,emissive:e.emissive,emissiveIntensity:.8,metalness:.9,roughness:.2})):e.type==="consumable"?(n=new Pt(.08,.12,4,8),a=new X({color:e.color,emissive:e.emissive,emissiveIntensity:.6,transparent:!0,opacity:.85})):(n=new Ji(.12,0),a=new X({color:e.color,emissive:e.emissive,emissiveIntensity:.5,roughness:.4})),s.mesh=new w(n,a),s.mesh.position.copy(i),s.mesh.castShadow=!0,this.scene.add(s.mesh),s.light=new We(e.color,.6,3),s.light.position.copy(i),this.scene.add(s.light),this.drops.push(s),this._animateDrop(s)}_animateDrop(e){const t=e.position.y,i=()=>{if(e.collected)return;requestAnimationFrame(i);const s=Date.now()*.003;e.mesh.position.y=t+Math.sin(s)*.08,e.mesh.rotation.y+=.025,e.light.position.copy(e.mesh.position),e.light.intensity=.4+Math.sin(s*1.5)*.25};i()}update(e){for(let t=this.drops.length-1;t>=0;t--){const i=this.drops[t];if(i.collected)continue;e.distanceTo(i.mesh.position)<this.pickupRadius&&this._collectDrop(i,t)}this.updateBossChests(e),this._processNotificationQueue()}_collectDrop(e,t){e.collected=!0,e.itemDef.id==="gold"?this.inventory.gold+=e.quantity:(this.inventory.items[e.itemDef.id]||(this.inventory.items[e.itemDef.id]=0),this.inventory.items[e.itemDef.id]+=e.quantity),this._saveInventory(),this.gm?.audioManager&&this.gm.audioManager.play("itemPickup",{volume:.5});const i=e.quantity>1?` x${e.quantity}`:"";this._queueNotification(`${e.itemDef.name}${i}`,e.itemDef.color),this.gm?.floatingText&&this.gm.floatingText.spawn(`+${e.quantity} ${e.itemDef.name}`,e.mesh.position.clone().add(new T(0,.5,0)),{color:"#"+e.itemDef.color.toString(16).padStart(6,"0"),duration:1.5}),this.scene.remove(e.mesh),this.scene.remove(e.light),e.mesh.geometry&&e.mesh.geometry.dispose(),e.mesh.material&&e.mesh.material.dispose(),this.drops.splice(t,1)}_queueNotification(e,t){this.notificationQueue.push({text:e,color:t})}_processNotificationQueue(){if(this.notificationActive||this.notificationQueue.length===0)return;const e=this.notificationQueue.shift();this._showNotification(e.text,e.color)}_showNotification(e,t=16777215){const i=document.getElementById("loot-notification");if(!i)return;this.notificationActive=!0;const s="#"+t.toString(16).padStart(6,"0");i.style.borderColor=s,i.style.textShadow=`0 0 8px ${s}`,i.innerHTML=`<span style="color: ${s}">+</span> ${e}`,i.style.opacity="1",setTimeout(()=>{i.style.opacity="0",setTimeout(()=>{this.notificationActive=!1},300)},1200)}useItem(e){if((this.inventory.items[e]||0)<=0)return!1;const i=Object.values(Fs).find(s=>s.id===e);if(!i||i.type!=="consumable")return!1;if(i.effect){if(i.effect.healAmount&&this.gm){const s=Math.min(i.effect.healAmount,this.gm.maxHealth-this.gm.health);this.gm.health=Math.min(this.gm.maxHealth,this.gm.health+i.effect.healAmount),this.gm.floatingText&&this.gm.player&&this.gm.floatingText.spawn(`+${s} HP`,this.gm.player.mesh.position.clone().add(new T(0,2,0)),{color:"#ff4444",duration:1.5})}if(i.effect.staminaAmount&&this.gm&&(this.gm.stamina=Math.min(this.gm.maxStamina,this.gm.stamina+i.effect.staminaAmount),this.gm.floatingText&&this.gm.player&&this.gm.floatingText.spawn(`+${i.effect.staminaAmount} Stamina`,this.gm.player.mesh.position.clone().add(new T(0,2,0)),{color:"#44ff44",duration:1.5})),i.effect.manaAmount&&this.gm?.manaManager){const s=this.gm.manaManager.restoreMana(i.effect.manaAmount);this.gm.floatingText&&this.gm.player&&s>0&&this.gm.floatingText.spawn(`+${s} Mana`,this.gm.player.mesh.position.clone().add(new T(0,2,0)),{color:"#4488ff",duration:1.5})}}return this.inventory.items[e]--,this.inventory.items[e]<=0&&delete this.inventory.items[e],this.gm?.audioManager&&this.gm.audioManager.play("itemPickup",{volume:.4}),this._saveInventory(),!0}getItemCount(e){return e==="gold"?this.inventory.gold:this.inventory.items[e]||0}getInventory(){return{...this.inventory,items:this.inventory.items||{}}}getGold(){return this.inventory.gold}spendGold(e){return this.inventory.gold<e?!1:(this.inventory.gold-=e,this._saveInventory(),!0)}addGold(e){this.inventory.gold+=e,this.inventory.gold<0&&(this.inventory.gold=0),this._saveInventory()}addItem(e,t=1){this.inventory.items[e]||(this.inventory.items[e]=0),this.inventory.items[e]+=t,this._saveInventory(),console.log(`[LootManager] Added ${t}x ${e}`)}removeItem(e,t=1){return(this.inventory.items[e]||0)<t?!1:(this.inventory.items[e]-=t,this.inventory.items[e]<=0&&delete this.inventory.items[e],this._saveInventory(),console.log(`[LootManager] Removed ${t}x ${e}`),!0)}clearDrops(){for(const e of this.drops)e.mesh&&(this.scene.remove(e.mesh),e.mesh.geometry?.dispose(),e.mesh.material?.dispose()),e.light&&this.scene.remove(e.light);this.drops=[]}spawnLootDrop(e,t){const i=Object.values(Fs).find(s=>s.id===e.itemId);if(!i){console.warn(`[LootManager] Unknown item: ${e.itemId}`);return}this._createDropVisual(i,e.quantity,t.clone())}showNotification(e,t="wooden"){const s={wooden:9127187,silver:12632256,gold:16766720}[t]||16777215;this._showNotification(e,s)}get gameManager(){return this.gm}generateBossLoot(e,t,i=!1){const s=D1(e,i);return!s||!s.items?(console.warn(`[LootManager] No loot defined for boss: ${e}`),null):(console.log(`[LootManager] Generating boss loot for ${e}:`,s),this.spawnBossChest(t,s,e,i),this._trackBossKill(e,i),s)}spawnBossChest(e,t,i,s){const n=new ne;n.position.copy(e),n.position.y=.3;const a=new X({color:s?16766720:8939178,roughness:.3,metalness:.8,emissive:s?11171584:4465254,emissiveIntensity:.5}),o=new ie(1.5,.8,1),r=new w(o,a);r.position.y=.4,r.castShadow=!0,n.add(r);const c=new ie(1.5,.3,1),h=new w(c,a.clone());h.position.y=.95,h.position.z=-.35,h.rotation.x=-.3,h.castShadow=!0,n.add(h);const d=new X({color:16768324,emissive:16755234,emissiveIntensity:3,transparent:!0,opacity:.8}),u=new re(.4,16,12),p=new w(u,d);p.position.y=.6,n.add(p);const f=t.items.find(m=>m.type==="boss_soul");if(f){const m=Object.values(jp).find(g=>g.id===f.id);if(m){const g=new X({color:m.color,emissive:m.emissive,emissiveIntensity:4,transparent:!0,opacity:.85}),x=new Ni(.25,1),v=new w(x,g);v.position.y=1.3,n.add(v),n.userData.soul=v}}const y=new We(16768324,2,8);return y.position.y=1,n.add(y),this._createBossLootParticles(n,s),this.scene.add(n),n.userData.loot=t,n.userData.bossId=i,n.userData.isFirstKill=s,n.userData.collected=!1,n.userData.light=y,n.userData.glow=p,this.bossChests||(this.bossChests=[]),this.bossChests.push(n),s?(this._showBossNotification("FIRST VICTORY!","boss_first"),setTimeout(()=>{this._showBossNotification(`${i.toUpperCase()} DEFEATED`,"boss")},1500)):this._showBossNotification(`${i.toUpperCase()} DEFEATED`,"boss"),n}_createBossLootParticles(e,t){const s=new Float32Array(300),n=new Float32Array(300),a=[],o=t?new H(16766720):new H(11167487);for(let p=0;p<100;p++){s[p*3]=0,s[p*3+1]=.5,s[p*3+2]=0;const f=.7+Math.random()*.3;n[p*3]=o.r*f,n[p*3+1]=o.g*f,n[p*3+2]=o.b*f,a.push(new T((Math.random()-.5)*4,Math.random()*3+1,(Math.random()-.5)*4))}const r=new mt;r.setAttribute("position",new Je(s,3)),r.setAttribute("color",new Je(n,3));const c=new Ri({size:.15,vertexColors:!0,transparent:!0,opacity:1,blending:ui,depthWrite:!1}),h=new Bi(r,c);e.add(h);let d=0;const u=()=>{if(d+=.016,d>3){e.remove(h),r.dispose(),c.dispose();return}const p=h.geometry.attributes.position.array;for(let f=0;f<100;f++)p[f*3]+=a[f].x*.016,p[f*3+1]+=a[f].y*.016,p[f*3+2]+=a[f].z*.016,a[f].y-=.05;h.geometry.attributes.position.needsUpdate=!0,c.opacity=Math.max(0,1-d/2.5),requestAnimationFrame(u)};u()}updateBossChests(e){if(this.bossChests)for(let t=this.bossChests.length-1;t>=0;t--){const i=this.bossChests[t];if(i.userData.collected)continue;const s=Date.now()*.001;i.position.y=.3+Math.sin(s*2)*.05,i.userData.soul&&(i.userData.soul.rotation.y+=.02,i.userData.soul.position.y=1.3+Math.sin(s*3)*.1),i.userData.light&&(i.userData.light.intensity=2+Math.sin(s*4)*.5),i.userData.glow&&i.userData.glow.scale.setScalar(1+Math.sin(s*3)*.1),e.distanceTo(i.position)<3&&this._collectBossChest(i,t)}}_collectBossChest(e,t){e.userData.collected=!0;const i=e.userData.loot;i.items.forEach(s=>{const n=this._getBossItemDef(s.id)||Object.values(Fs).find(a=>a.id===s.id);if(n){this.addItem(s.id,s.quantity||1);const a=s.quantity&&s.quantity>1?` x${s.quantity}`:"",r={legendary:16766720,epic:11167487,rare:4491519,uncommon:4521796,common:16777215}[n.rarity]||n.color||16777215;this._queueNotification(`${n.name}${a}`,r)}}),i.remnants>0&&(this.addGold(i.remnants),this._queueNotification(`${i.remnants} Remnants`,16766720)),this.gm?.audioManager&&this.gm.audioManager.play("levelUp",{volume:.8}),this._burstItemsFromChest(e,i.items),setTimeout(()=>{this.scene.remove(e),e.traverse(s=>{s.geometry&&s.geometry.dispose(),s.material&&(Array.isArray(s.material)?s.material.forEach(n=>n.dispose()):s.material.dispose())}),this.bossChests.splice(t,1)},1e3),this._saveInventory(),console.log(`[LootManager] Collected boss chest with ${i.items.length} items`)}_burstItemsFromChest(e,t){const i=e.position.clone();t.forEach((s,n)=>{const a=this._getBossItemDef(s.id)||Object.values(Fs).find(f=>f.id===s.id);if(!a)return;const o=new Ji(.15,0),r=new X({color:a.color||16777215,emissive:a.emissive||4473924,emissiveIntensity:1.5}),c=new w(o,r);c.position.copy(i),c.position.y+=.8,this.scene.add(c);const h=n/t.length*Math.PI*2,d=new T(Math.cos(h)*2,3+Math.random(),Math.sin(h)*2);let u=0;const p=()=>{if(u+=.016,u>1.5){this.scene.remove(c),o.dispose(),r.dispose();return}c.position.add(d.clone().multiplyScalar(.016)),d.y-=.1,c.rotation.x+=.1,c.rotation.y+=.15,r.opacity=Math.max(0,1-u),requestAnimationFrame(p)};p()})}_getBossItemDef(e){return Object.values(jp).find(t=>t.id===e)}_showBossNotification(e,t="boss"){let i=document.getElementById("boss-notification");i||(i=document.createElement("div"),i.id="boss-notification",i.style.cssText=`
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(20, 10, 30, 0.95), rgba(50, 20, 60, 0.95));
        color: #fff;
        padding: 20px 60px;
        border-radius: 8px;
        font-family: 'Georgia', serif;
        font-size: 32px;
        font-weight: bold;
        letter-spacing: 3px;
        text-transform: uppercase;
        opacity: 0;
        transition: opacity 0.5s ease, transform 0.5s ease;
        pointer-events: none;
        z-index: 2000;
        border: 2px solid #ffd700;
        box-shadow: 0 0 40px rgba(255, 215, 0, 0.5), inset 0 0 30px rgba(0, 0, 0, 0.5);
        text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
      `,document.body.appendChild(i)),t==="boss_first"?(i.style.color="#ffd700",i.style.borderColor="#ffd700",i.style.textShadow="0 0 30px rgba(255, 215, 0, 1)"):(i.style.color="#ffffff",i.style.borderColor="#aa66ff",i.style.textShadow="0 0 20px rgba(170, 102, 255, 0.8)"),i.textContent=e,i.style.opacity="1",i.style.transform="translate(-50%, -50%) scale(1)",setTimeout(()=>{i.style.opacity="0",i.style.transform="translate(-50%, -50%) scale(0.8)"},2500)}_trackBossKill(e,t){this.bossKills||(this.bossKills={},this._loadBossKills()),this.bossKills[e]||(this.bossKills[e]={count:0,firstKillAt:null}),this.bossKills[e].count++,t&&(this.bossKills[e].firstKillAt=Date.now()),this._saveBossKills()}hasKilledBoss(e){return this.bossKills||(this.bossKills={},this._loadBossKills()),this.bossKills[e]?.count>0}getBossKillCount(e){return this.bossKills||(this.bossKills={},this._loadBossKills()),this.bossKills[e]?.count||0}_saveBossKills(){try{localStorage.setItem("ashen_boss_kills",JSON.stringify(this.bossKills))}catch(e){console.warn("[LootManager] Failed to save boss kills:",e)}}_loadBossKills(){try{const e=localStorage.getItem("ashen_boss_kills");e&&(this.bossKills=JSON.parse(e))}catch(e){console.warn("[LootManager] Failed to load boss kills:",e)}}getBossSoulExchangeOptions(e){return k1[e]?.exchangeOptions||[]}hasBossSoul(e){return this.getItemCount(e)>0}exchangeBossSoul(e,t){if(!this.hasBossSoul(e))return console.warn(`[LootManager] No ${e} to exchange`),!1;const s=this.getBossSoulExchangeOptions(e).find(n=>n.id===t);return s?(this.removeItem(e,1),s.id==="remnants"?(this.addGold(s.quantity),this._queueNotification(`+${s.quantity} Remnants`,16766720)):s.type==="weapon"?(this.equipmentManager&&console.log(`[LootManager] Granted weapon: ${s.name}`),this._queueNotification(`Obtained: ${s.name}`,16766720)):s.type==="spell"&&(this.gm?.spellManager&&console.log(`[LootManager] Unlocked spell: ${s.name}`),this._queueNotification(`Learned: ${s.name}`,4491519)),this._saveInventory(),!0):(console.warn(`[LootManager] Invalid exchange option: ${t}`),!1)}}const si={SWORD:{id:"sword",name:"Sword",description:"Balanced weapons with good speed and damage.",icon:"",baseSpeed:1,baseRange:1,baseDamage:1,staminaMult:1,primaryScaling:"STR",secondaryScaling:"DEX",scalingRatio:[.6,.4]},AXE:{id:"axe",name:"Axe",description:"Slow but devastating weapons that cleave through armor.",icon:"",baseSpeed:.7,baseRange:.9,baseDamage:1.4,staminaMult:1.3,primaryScaling:"STR",secondaryScaling:null,scalingRatio:[1,0]},SPEAR:{id:"spear",name:"Spear",description:"Long reach weapons for keeping enemies at distance.",icon:"",baseSpeed:.9,baseRange:1.5,baseDamage:.9,staminaMult:.9,primaryScaling:"DEX",secondaryScaling:"STR",scalingRatio:[.6,.4]},DAGGER:{id:"dagger",name:"Dagger",description:"Very fast weapons with lower damage but high crit potential.",icon:"",baseSpeed:1.5,baseRange:.6,baseDamage:.6,staminaMult:.6,primaryScaling:"DEX",secondaryScaling:null,scalingRatio:[1,0]},GREATSWORD:{id:"greatsword",name:"Greatsword",description:"Massive blades dealing tremendous damage but very slow.",icon:"",baseSpeed:.5,baseRange:1.3,baseDamage:1.8,staminaMult:1.6,primaryScaling:"STR",secondaryScaling:null,scalingRatio:[1,0]}},mi={COMMON:{id:"common",name:"Common",color:"#888888",hexColor:8947848,statMult:1,critBonus:0,glowIntensity:0},UNCOMMON:{id:"uncommon",name:"Uncommon",color:"#4ade80",hexColor:4906624,statMult:1.2,critBonus:2,glowIntensity:.15},RARE:{id:"rare",name:"Rare",color:"#60a5fa",hexColor:6333946,statMult:1.5,critBonus:5,glowIntensity:.3},EPIC:{id:"epic",name:"Epic",color:"#c084fc",hexColor:12616956,statMult:1.8,critBonus:8,glowIntensity:.5},LEGENDARY:{id:"legendary",name:"Legendary",color:"#f97316",hexColor:16347926,statMult:2.2,critBonus:12,glowIntensity:.8}},vi={sword:{light:{name:"Horizontal Slash",animation:"sword_slash_h",damageMultiplier:1,staminaCost:10,duration:.4,windupTime:.1,recoveryTime:.2,hitboxWidth:1.2,hitboxDepth:.8,canCombo:!0,comboWindow:.3},heavy:{name:"Overhead Chop",animation:"sword_chop",damageMultiplier:1.8,staminaCost:25,duration:.7,windupTime:.25,recoveryTime:.35,hitboxWidth:.8,hitboxDepth:1,canCombo:!1,knockback:2}},axe:{light:{name:"Wide Swing",animation:"axe_swing",damageMultiplier:1.2,staminaCost:15,duration:.55,windupTime:.2,recoveryTime:.25,hitboxWidth:1.6,hitboxDepth:.7,canCombo:!0,comboWindow:.25},heavy:{name:"Overhead Slam",animation:"axe_slam",damageMultiplier:2.2,staminaCost:35,duration:.9,windupTime:.35,recoveryTime:.4,hitboxWidth:1,hitboxDepth:1.2,canCombo:!1,knockback:3.5,groundPound:!0}},spear:{light:{name:"Forward Thrust",animation:"spear_thrust",damageMultiplier:.9,staminaCost:8,duration:.35,windupTime:.08,recoveryTime:.18,hitboxWidth:.4,hitboxDepth:2,canCombo:!0,comboWindow:.35,piercing:!0},heavy:{name:"Sweeping Spin",animation:"spear_spin",damageMultiplier:1.5,staminaCost:28,duration:.75,windupTime:.2,recoveryTime:.3,hitboxWidth:2.2,hitboxDepth:2.2,canCombo:!1,knockback:2,areaAttack:!0}},dagger:{light:{name:"Quick Stab",animation:"dagger_stab",damageMultiplier:.6,staminaCost:5,duration:.2,windupTime:.04,recoveryTime:.1,hitboxWidth:.5,hitboxDepth:.6,canCombo:!0,comboWindow:.4,critBonus:5},heavy:{name:"Rapid Multi-Stab",animation:"dagger_flurry",damageMultiplier:1.6,staminaCost:20,duration:.5,windupTime:.05,recoveryTime:.2,hitboxWidth:.6,hitboxDepth:.8,canCombo:!1,multiHit:4,critBonus:10}},greatsword:{light:{name:"Horizontal Sweep",animation:"gs_sweep",damageMultiplier:1.4,staminaCost:20,duration:.7,windupTime:.25,recoveryTime:.35,hitboxWidth:2,hitboxDepth:1,canCombo:!0,comboWindow:.2,knockback:1.5},heavy:{name:"Vertical Slam",animation:"gs_slam",damageMultiplier:2.5,staminaCost:45,duration:1.1,windupTime:.45,recoveryTime:.5,hitboxWidth:1.2,hitboxDepth:1.5,canCombo:!1,knockback:4,groundPound:!0,stagger:!0}}},N1={iron_sword:{id:"iron_sword",name:"Iron Sword",category:si.SWORD,baseDamage:10,baseSpeed:1,baseRange:1,baseCritChance:5,staminaCost:10,moveset:vi.sword,description:"A sturdy iron blade. The standard weapon of soldiers.",visualModel:"sword",levelRequired:1},steel_sword:{id:"steel_sword",name:"Steel Sword",category:si.SWORD,baseDamage:18,baseSpeed:1.05,baseRange:1,baseCritChance:6,staminaCost:10,moveset:vi.sword,description:"Tempered steel, sharp and reliable.",visualModel:"longsword",levelRequired:5},knight_blade:{id:"knight_blade",name:"Knight's Blade",category:si.SWORD,baseDamage:25,baseSpeed:1.1,baseRange:1.1,baseCritChance:8,staminaCost:12,moveset:vi.sword,description:"A finely crafted sword bearing a knight's crest.",visualModel:"longsword",levelRequired:10},dark_edge:{id:"dark_edge",name:"Dark Edge",category:si.SWORD,baseDamage:35,baseSpeed:.95,baseRange:1.15,baseCritChance:12,staminaCost:14,moveset:vi.sword,description:"A blade forged in shadow. Hungers for souls.",visualModel:"longsword",specialEffect:"lifesteal",levelRequired:15},hand_axe:{id:"hand_axe",name:"Hand Axe",category:si.AXE,baseDamage:14,baseSpeed:.75,baseRange:.85,baseCritChance:3,staminaCost:14,moveset:vi.axe,description:"A simple woodcutter turned weapon.",visualModel:"axe",levelRequired:1},battle_axe:{id:"battle_axe",name:"Battle Axe",category:si.AXE,baseDamage:26,baseSpeed:.7,baseRange:.9,baseCritChance:4,staminaCost:18,moveset:vi.axe,description:"Heavy and brutal. Cleaves through armor.",visualModel:"axe",levelRequired:6},executioner_axe:{id:"executioner_axe",name:"Executioner's Axe",category:si.AXE,baseDamage:38,baseSpeed:.6,baseRange:.95,baseCritChance:6,staminaCost:22,moveset:vi.axe,description:"Once used for grim justice. Still eager.",visualModel:"axe",specialEffect:"execute",levelRequired:12},wooden_spear:{id:"wooden_spear",name:"Wooden Spear",category:si.SPEAR,baseDamage:8,baseSpeed:.95,baseRange:1.4,baseCritChance:4,staminaCost:7,moveset:vi.spear,description:"Simple but effective. Keeps enemies at distance.",visualModel:"spear",levelRequired:1},iron_spear:{id:"iron_spear",name:"Iron Spear",category:si.SPEAR,baseDamage:16,baseSpeed:.9,baseRange:1.5,baseCritChance:5,staminaCost:9,moveset:vi.spear,description:"Iron-tipped for piercing strikes.",visualModel:"spear",levelRequired:4},halberd:{id:"halberd",name:"Halberd",category:si.SPEAR,baseDamage:28,baseSpeed:.8,baseRange:1.6,baseCritChance:7,staminaCost:14,moveset:vi.spear,description:"Versatile polearm with axe blade and spike.",visualModel:"spear",specialEffect:"armorPierce",levelRequired:11},rusty_dagger:{id:"rusty_dagger",name:"Rusty Dagger",category:si.DAGGER,baseDamage:5,baseSpeed:1.5,baseRange:.55,baseCritChance:8,staminaCost:4,moveset:vi.dagger,description:"A worn blade, still quick.",visualModel:"dagger",levelRequired:1},steel_dagger:{id:"steel_dagger",name:"Steel Dagger",category:si.DAGGER,baseDamage:10,baseSpeed:1.55,baseRange:.6,baseCritChance:12,staminaCost:5,moveset:vi.dagger,description:"A well-balanced throwing knife.",visualModel:"dagger",levelRequired:4},shadow_fang:{id:"shadow_fang",name:"Shadow Fang",category:si.DAGGER,baseDamage:15,baseSpeed:1.6,baseRange:.65,baseCritChance:18,staminaCost:6,moveset:vi.dagger,description:"A dagger forged in darkness. Strikes from the shadows.",visualModel:"dagger",specialEffect:"backstab",levelRequired:10},claymore:{id:"claymore",name:"Claymore",category:si.GREATSWORD,baseDamage:30,baseSpeed:.55,baseRange:1.25,baseCritChance:4,staminaCost:22,moveset:vi.greatsword,description:"A massive two-handed sword.",visualModel:"greatsword",levelRequired:6},executioner_blade:{id:"executioner_blade",name:"Executioner Blade",category:si.GREATSWORD,baseDamage:42,baseSpeed:.5,baseRange:1.35,baseCritChance:5,staminaCost:28,moveset:vi.greatsword,description:"Heavy blade meant to end lives.",visualModel:"greatsword",levelRequired:12},void_reaver:{id:"void_reaver",name:"Void Reaver",category:si.GREATSWORD,baseDamage:55,baseSpeed:.45,baseRange:1.4,baseCritChance:8,staminaCost:32,moveset:vi.greatsword,description:"A blade forged in the void. Reality bends around its edge.",visualModel:"greatsword",specialEffect:"voidRift",levelRequired:18}};function B1(l,e,t=mi.COMMON){const i=l.category;let s=l.baseDamage*t.statMult;s*=i.baseDamage;const n=i.scalingRatio;let a=0;if(i.primaryScaling&&e[i.primaryScaling]){const o=e[i.primaryScaling],r=Math.max(0,(o-10)*.02);a+=s*r*n[0]}if(i.secondaryScaling&&e[i.secondaryScaling]){const o=e[i.secondaryScaling],r=Math.max(0,(o-10)*.02);a+=s*r*n[1]}return Math.round(s+a)}function z1(l,e){let t=l.baseSpeed*l.category.baseSpeed;if(e.DEX){const i=Math.max(0,(e.DEX-10)*.01);t*=1+i}return t}function F1(l,e){const t=l.moveset[e];if(!t)return l.staminaCost;let i=t.staminaCost*l.category.staminaMult;return Math.round(i)}function U1(l){return l.baseRange*l.category.baseRange}function G1(l,e,t=mi.COMMON,i="light"){let s=l.baseCritChance+t.critBonus;const n=l.moveset[i];return n&&n.critBonus&&(s+=n.critBonus),e.DEX&&(s+=Math.max(0,(e.DEX-10)*.5)),Math.min(s,75)}function $c(l){return N1[l]||null}const Zp={position:new T(.5,.2,.3),rotation:new nt(0,0,-Math.PI/6)},Ei={blade:{metalness:.9,roughness:.2},handle:{metalness:.3,roughness:.7,color:3811866},guard:{metalness:.85,roughness:.25},accent:{metalness:.7,roughness:.3}};class H1{constructor(){this.weaponCache=new Map,this.glowLight=null,console.log("[WeaponRenderer] Initialized")}createWeapon(e,t=mi.COMMON,i={}){const s=new ne;switch(s.userData.weaponType=e,s.userData.rarity=t,this.normalizeWeaponType(e)){case"sword":this.buildSword(s,t,i);break;case"longsword":this.buildLongsword(s,t,i);break;case"greatsword":this.buildGreatsword(s,t,i);break;case"axe":this.buildAxe(s,t,i);break;case"spear":this.buildSpear(s,t,i);break;case"dagger":this.buildDagger(s,t,i);break;default:this.buildSword(s,t,i)}return t.glowIntensity>0&&this.addGlowEffect(s,t),s.position.copy(Zp.position),s.rotation.copy(Zp.rotation),s.traverse(a=>{a.isMesh&&(a.castShadow=!0,a.receiveShadow=!1)}),s}normalizeWeaponType(e){if(!e)return"sword";const t=e.toLowerCase().trim();return{sword:"sword",longsword:"longsword",greatsword:"greatsword",axe:"axe",battleaxe:"axe",spear:"spear",halberd:"spear",dagger:"dagger",knife:"dagger"}[t]||"sword"}createMaterial(e,t,i=!1){const s=new X({color:i?this.getBladeColor(t):e.color||8947848,metalness:e.metalness||.5,roughness:e.roughness||.5});return i&&t.glowIntensity>0&&s.emissive&&(s.emissive=new H(t.hexColor),s.emissiveIntensity=t.glowIntensity*.3),s}getBladeColor(e){switch(e.id){case"common":return 9079434;case"uncommon":return 10139802;case"rare":return 9088204;case"epic":return 12098252;case"legendary":return 13413002;default:return 9079434}}buildSword(e,t,i){const s=this.createMaterial(Ei.blade,t,!0),n=this.createMaterial(Ei.handle,t),a=this.createMaterial(Ei.guard,t,!0),o=new ne,r=new ie(.06,.55,.015),c=new w(r,s);c.position.y=.35,o.add(c);const h=new wt(.03,.12,4),d=new w(h,s);d.position.y=.68,d.rotation.z=Math.PI,o.add(d);const u=new X({color:4473924,metalness:.8,roughness:.4}),p=new ie(.02,.4,.005),f=new w(p,u);f.position.set(0,.32,.006),o.add(f),e.add(o);const y=new ie(.2,.04,.025),m=new w(y,a);m.position.y=.04,e.add(m);const g=new re(.025,8,6),x=new w(g,a);x.position.set(-.1,.04,0),e.add(x);const v=new w(g,a);v.position.set(.1,.04,0),e.add(v);const b=new ce(.022,.025,.15,8),_=new w(b,n);_.position.y=-.05,e.add(_);const S=new re(.035,8,6),A=new w(S,a);A.position.y=-.14,e.add(A)}buildLongsword(e,t,i){const s=this.createMaterial(Ei.blade,t,!0),n=this.createMaterial(Ei.handle,t),a=this.createMaterial(Ei.guard,t,!0),o=new ne,r=new ie(.07,.75,.018),c=new w(r,s);c.position.y=.45,o.add(c);const h=new wt(.035,.15,4),d=new w(h,s);d.position.y=.9,d.rotation.z=Math.PI,o.add(d);const u=new X({color:4473924,metalness:.8,roughness:.4}),p=new ie(.025,.55,.005),f=new w(p,u);f.position.set(0,.4,.008),o.add(f),e.add(o);const y=new ie(.28,.05,.03),m=new w(y,a);m.position.y=.04,e.add(m);const g=new re(.03,8,6),x=new w(g,a);x.position.set(-.14,.04,0),e.add(x);const v=new w(g,a);v.position.set(.14,.04,0),e.add(v);const b=new ce(.025,.028,.2,8),_=new w(b,n);_.position.y=-.08,e.add(_);const S=new X({color:2759178,roughness:.9});for(let M=0;M<4;M++){const C=new Ai(.028,.004,4,8),k=new w(C,S);k.position.y=-.16+M*.045,k.rotation.x=Math.PI/2,e.add(k)}const A=new js(.04,0),R=new w(A,a);R.position.y=-.2,e.add(R)}buildGreatsword(e,t,i){const s=this.createMaterial(Ei.blade,t,!0),n=this.createMaterial(Ei.handle,t),a=this.createMaterial(Ei.guard,t,!0),o=new ne,r=new ie(.12,1.1,.025),c=new w(r,s);c.position.y=.7,o.add(c);const h=new ia;h.moveTo(-.06,0),h.lineTo(0,.18),h.lineTo(.06,0),h.lineTo(-.06,0);const d={depth:.025,bevelEnabled:!1},u=new Wo(h,d),p=new w(u,s);p.position.set(0,1.25,-.0125),o.add(p);const f=new X({color:3815994,metalness:.85,roughness:.35}),y=new ie(.025,.85,.006),m=new w(y,f);m.position.set(-.025,.65,.012),o.add(m);const g=new w(y,f);g.position.set(.025,.65,.012),o.add(g),e.add(o);const x=new ie(.4,.06,.04),v=new w(x,a);v.position.y=.08,e.add(v);const b=new ce(.025,.015,.08,6),_=new w(b,a);_.position.set(-.2,.04,0),_.rotation.z=Math.PI/4,e.add(_);const S=new w(b,a);S.position.set(.2,.04,0),S.rotation.z=-Math.PI/4,e.add(S);const A=new ce(.03,.035,.35,8),R=new w(A,n);R.position.y=-.12,e.add(R);const M=new X({color:2759178,roughness:.9});for(let W=0;W<6;W++){const U=new Ai(.033,.005,4,8),$=new w(U,M);$.position.y=-.25+W*.055,$.rotation.x=Math.PI/2,e.add($)}const C=new ce(.05,.04,.06,8),k=new w(C,a);k.position.y=-.32,e.add(k);const L=new re(.04,8,6),O=new w(L,a);O.position.y=-.36,e.add(O)}buildAxe(e,t,i){const s=this.createMaterial(Ei.blade,t,!0),n=this.createMaterial(Ei.handle,t),a=this.createMaterial(Ei.accent,t,!0),o=new ne,r=new ia;r.moveTo(0,-.15),r.quadraticCurveTo(.18,-.12,.22,0),r.quadraticCurveTo(.18,.12,0,.15),r.lineTo(0,-.15);const c={depth:.04,bevelEnabled:!0,bevelThickness:.01,bevelSize:.01,bevelSegments:2},h=new Wo(r,c),d=new w(h,s);d.position.set(.04,.4,-.02),o.add(d);const u=new ce(.035,.035,.06,8),p=new X({color:5592405,metalness:.7,roughness:.4}),f=new w(u,p);f.position.set(0,.4,0),f.rotation.x=Math.PI/2,o.add(f);const y=new wt(.03,.1,4),m=new w(y,s);m.position.set(-.06,.4,0),m.rotation.z=Math.PI/2,o.add(m),e.add(o);const g=new ce(.025,.03,.6,8),x=new w(g,n);x.position.y=.05,e.add(x);const v=new ce(.032,.032,.03,8),b=new w(v,a);b.position.y=.3,e.add(b);const _=new re(.035,8,6),S=new w(_,a);S.position.y=-.26,e.add(S)}buildSpear(e,t,i){const s=this.createMaterial(Ei.blade,t,!0),n=this.createMaterial(Ei.handle,t),a=this.createMaterial(Ei.accent,t,!0),o=new ne,r=new ia;r.moveTo(0,0),r.quadraticCurveTo(.04,.08,.03,.2),r.lineTo(0,.35),r.lineTo(-.03,.2),r.quadraticCurveTo(-.04,.08,0,0);const c={depth:.015,bevelEnabled:!0,bevelThickness:.005,bevelSize:.005,bevelSegments:1},h=new Wo(r,c),d=new w(h,s);d.position.set(0,.75,-.0075),o.add(d);const u=new ce(.022,.028,.08,8),p=new w(u,a);p.position.y=.73,o.add(p),e.add(o);const f=new ce(.018,.022,1.2,8),y=new w(f,n);y.position.y=.1,e.add(y);const m=new X({color:3811866,roughness:.85});for(let v=0;v<5;v++){const b=new Ai(.022,.003,4,8),_=new w(b,m);_.position.y=-.1+v*.04,_.rotation.x=Math.PI/2,e.add(_)}const g=new wt(.02,.08,6),x=new w(g,a);x.position.y=-.54,x.rotation.z=Math.PI,e.add(x)}buildDagger(e,t,i){const s=this.createMaterial(Ei.blade,t,!0),n=this.createMaterial(Ei.handle,t),a=this.createMaterial(Ei.guard,t,!0),o=new ne,r=new ie(.035,.25,.008),c=new w(r,s);c.position.y=.18,o.add(c);const h=new wt(.0175,.08,4),d=new w(h,s);d.position.y=.35,d.rotation.z=Math.PI,o.add(d),e.add(o);const u=new ce(.04,.045,.015,8),p=new w(u,a);p.position.y=.04,e.add(p);const f=new ce(.018,.02,.1,8),y=new w(f,n);y.position.y=-.02,e.add(y);const m=new re(.022,8,6),g=new w(m,a);g.position.y=-.08,e.add(g)}addGlowEffect(e,t){const i=new We(t.hexColor,t.glowIntensity*.8,1.5);if(i.position.set(0,.3,0),e.add(i),e.userData.glowLight=i,t.glowIntensity>=.5){const s=new re(.15,8,6),n=new B({color:t.hexColor,transparent:!0,opacity:t.glowIntensity*.15,side:wi}),a=new w(s,n);a.position.y=.4,a.scale.set(1,3,1),e.add(a),e.userData.aura=a}}updateGlow(e,t,i){if(!e?.userData?.glowLight)return;const s=e.userData.rarity;if(!s||s.glowIntensity<=0)return;const n=Math.sin(i*2)*.3+.7;e.userData.glowLight.intensity=s.glowIntensity*n*.8,e.userData.aura&&(e.userData.aura.rotation.y+=t*.5,e.userData.aura.material.opacity=s.glowIntensity*.15*n)}getAttachmentInfo(e){switch(this.normalizeWeaponType(e)){case"greatsword":return{position:new T(.6,.1,.2),rotation:new nt(0,-Math.PI/6,-Math.PI/5)};case"spear":return{position:new T(.4,.4,.2),rotation:new nt(-Math.PI/8,0,-Math.PI/4)};case"axe":return{position:new T(.55,.15,.25),rotation:new nt(0,0,-Math.PI/5)};case"dagger":return{position:new T(.4,.1,.35),rotation:new nt(0,0,-Math.PI/8)};default:return{position:new T(.5,.2,.3),rotation:new nt(0,0,-Math.PI/6)}}}disposeWeapon(e){e&&e.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(i=>i.dispose()):t.material.dispose())})}}let Xc=null;function Yc(){return Xc||(Xc=new H1),Xc}const qe={COMMON:{id:"common",name:"Common",color:"#ffffff",hexColor:16777215,dropWeight:100,statMult:1},UNCOMMON:{id:"uncommon",name:"Uncommon",color:"#4ade80",hexColor:4906624,dropWeight:40,statMult:1.3},RARE:{id:"rare",name:"Rare",color:"#60a5fa",hexColor:6333946,dropWeight:15,statMult:1.7},EPIC:{id:"epic",name:"Epic",color:"#c084fc",hexColor:12616956,dropWeight:5,statMult:2.2}},ot={WEAPON:"weapon",ARMOR:"armor",ACCESSORY:"accessory"},Ml={rusty_sword:{id:"rusty_sword",name:"Rusty Sword",slot:ot.WEAPON,baseStats:{damage:5},description:"A weathered blade, still serviceable.",weaponModel:"sword"},iron_sword:{id:"iron_sword",name:"Iron Sword",slot:ot.WEAPON,baseStats:{damage:10},description:"A sturdy iron blade.",weaponModel:"sword"},soldier_blade:{id:"soldier_blade",name:"Soldier's Blade",slot:ot.WEAPON,baseStats:{damage:12,attackSpeed:5},description:"Standard issue military sword.",weaponModel:"sword"},knight_sword:{id:"knight_sword",name:"Knight Sword",slot:ot.WEAPON,baseStats:{damage:18,critChance:3},description:"A finely crafted knightly weapon.",weaponModel:"longsword"},executioner_blade:{id:"executioner_blade",name:"Executioner Blade",slot:ot.WEAPON,baseStats:{damage:25,critDamage:20},description:"Heavy blade meant to end lives.",weaponModel:"greatsword"},shadow_fang:{id:"shadow_fang",name:"Shadow Fang",slot:ot.WEAPON,baseStats:{damage:15,critChance:8,attackSpeed:10},description:"A dagger forged in darkness.",weaponModel:"dagger"},tattered_robe:{id:"tattered_robe",name:"Tattered Robe",slot:ot.ARMOR,baseStats:{defense:3},description:"Worn cloth offering minimal protection."},leather_armor:{id:"leather_armor",name:"Leather Armor",slot:ot.ARMOR,baseStats:{defense:8,stamina:10},description:"Light armor for mobility."},chainmail:{id:"chainmail",name:"Chainmail",slot:ot.ARMOR,baseStats:{defense:15,health:10},description:"Interlocking metal rings."},knight_armor:{id:"knight_armor",name:"Knight Armor",slot:ot.ARMOR,baseStats:{defense:22,health:25},description:"Heavy plate worn by knights."},dark_plate:{id:"dark_plate",name:"Dark Plate",slot:ot.ARMOR,baseStats:{defense:30,health:40,stamina:-10},description:"Corrupted armor of immense protection."},copper_ring:{id:"copper_ring",name:"Copper Ring",slot:ot.ACCESSORY,baseStats:{health:10},description:"A simple ring."},warriors_band:{id:"warriors_band",name:"Warrior's Band",slot:ot.ACCESSORY,baseStats:{damage:5,stamina:15},description:"Worn by seasoned fighters."},vitality_amulet:{id:"vitality_amulet",name:"Vitality Amulet",slot:ot.ACCESSORY,baseStats:{health:30,healthRegen:1},description:"Pulses with life energy."},crit_pendant:{id:"crit_pendant",name:"Critical Pendant",slot:ot.ACCESSORY,baseStats:{critChance:10,critDamage:25},description:"Sharpens your killing instinct."},endurance_charm:{id:"endurance_charm",name:"Endurance Charm",slot:ot.ACCESSORY,baseStats:{stamina:30,staminaRegen:10},description:"Never tire, never falter."}},Jp={hollow_soldier:[{equipId:"rusty_sword",weight:30},{equipId:"tattered_robe",weight:30},{equipId:"copper_ring",weight:20}],berserker:[{equipId:"iron_sword",weight:25},{equipId:"soldier_blade",weight:15},{equipId:"leather_armor",weight:25},{equipId:"warriors_band",weight:15}],sentinel:[{equipId:"soldier_blade",weight:20},{equipId:"knight_sword",weight:10},{equipId:"chainmail",weight:25},{equipId:"warriors_band",weight:20},{equipId:"vitality_amulet",weight:10}],revenant:[{equipId:"shadow_fang",weight:15},{equipId:"knight_sword",weight:15},{equipId:"knight_armor",weight:15},{equipId:"crit_pendant",weight:20}],ranged:[{equipId:"leather_armor",weight:30},{equipId:"crit_pendant",weight:25},{equipId:"endurance_charm",weight:20}],elite:[{equipId:"knight_sword",weight:20},{equipId:"executioner_blade",weight:15},{equipId:"knight_armor",weight:20},{equipId:"dark_plate",weight:10},{equipId:"vitality_amulet",weight:15},{equipId:"crit_pendant",weight:15}],boss:[{equipId:"executioner_blade",weight:25},{equipId:"shadow_fang",weight:20},{equipId:"dark_plate",weight:25},{equipId:"crit_pendant",weight:15},{equipId:"endurance_charm",weight:15}]},q1={hollow_soldier:.08,berserker:.12,sentinel:.15,revenant:.18,ranged:.1,elite:.3,boss:.85};class W1{constructor(e,t,i){this.scene=e,this.gameManager=t,this.lootManager=i,this.equipped={[ot.WEAPON]:null,[ot.ARMOR]:null,[ot.ACCESSORY]:null},this.inventory=[],this.uiContainer=null,this.isUIVisible=!1,this.weaponMesh=null,this.loadEquipment(),this.createUI(),console.log("[EquipmentManager] Initialized")}generateEquipmentDrop(e){const t=q1[e]||.05;if(Math.random()>t)return null;const i=Jp[e]||Jp.hollow_soldier,s=i.reduce((r,c)=>r+c.weight,0);let n=Math.random()*s,a=null;for(const r of i)if(n-=r.weight,n<=0){a=Ml[r.equipId];break}a||(a=Ml.rusty_sword);const o=this.rollRarity(e);return this.createEquipmentInstance(a,o)}generateChestEquipment(e){const t=Object.values(Ml),i=t[Math.floor(Math.random()*t.length)];return this.createEquipmentInstance(i,e)}spawnEquipmentDrop(e,t){if(!e||!this.lootManager)return;const i=new ne;i.position.copy(t);const s=new re(.25,12,8),n=new X({color:e.rarity.hexColor,emissive:e.rarity.hexColor,emissiveIntensity:.6,metalness:.8,roughness:.2}),a=new w(s,n);i.add(a);const o=new We(e.rarity.hexColor,1,5);i.add(o),this.scene.add(i);const r={type:"equipment",equipment:e,mesh:i,position:t.clone(),spawnTime:Date.now(),bobOffset:Math.random()*Math.PI*2};this.equipmentDrops||(this.equipmentDrops=[]),this.equipmentDrops.push(r)}updateEquipmentDrops(e,t){if(!this.equipmentDrops)return;const i=2,s=[];for(const n of this.equipmentDrops){const a=(Date.now()-n.spawnTime)/1e3;n.mesh.position.y=n.position.y+.5+Math.sin(a*2+n.bobOffset)*.15,n.mesh.rotation.y+=t*1.5;const o=e.x-n.position.x,r=e.z-n.position.z;Math.sqrt(o*o+r*r)<i&&(this.addToInventory(n.equipment),this.gameManager.audioManager&&this.gameManager.audioManager.playSound("itemPickup",{position:n.position}),this.scene.remove(n.mesh),n.mesh.traverse(h=>{h.geometry&&h.geometry.dispose(),h.material&&h.material.dispose()}),s.push(n))}for(const n of s){const a=this.equipmentDrops.indexOf(n);a>=0&&this.equipmentDrops.splice(a,1)}}rollRarity(e){let t=0;e==="elite"&&(t=20),e==="boss"&&(t=50);const i=Math.random()*100+t;return i>=160?qe.EPIC:i>=130?qe.RARE:i>=100?qe.UNCOMMON:qe.COMMON}createEquipmentInstance(e,t){const i={id:`${e.id}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,baseId:e.id,name:this.generateEquipmentName(e,t),slot:e.slot,rarity:t,description:e.description,weaponModel:e.weaponModel||null,stats:{}};for(const[s,n]of Object.entries(e.baseStats))i.stats[s]=Math.round(n*t.statMult);return i}generateEquipmentName(e,t){const i={common:["","Old","Worn"],uncommon:["Fine","Quality","Sturdy"],rare:["Superior","Masterwork","Enchanted"],epic:["Legendary","Mythic","Divine"]},s=i[t.id][Math.floor(Math.random()*i[t.id].length)];return s?`${s} ${e.name}`:e.name}addToInventory(e){this.inventory.push(e),this.saveEquipment(),this.showEquipmentPickup(e),console.log(`[EquipmentManager] Added to inventory: ${e.name}`)}equip(e){const t=this.inventory.findIndex(n=>n.id===e);if(t===-1)return console.warn("[EquipmentManager] Equipment not found in inventory"),!1;const i=this.inventory[t],s=i.slot;return this.equipped[s]&&this.inventory.push(this.equipped[s]),this.inventory.splice(t,1),this.equipped[s]=i,this.applyEquipmentStats(),s===ot.WEAPON&&(this.updateWeaponVisual(),this.weaponManager&&this.weaponManager.equipFromInventory(i,this.weaponManager.activeSlot)),this.saveEquipment(),this.updateUI(),this.gameManager.audioManager&&this.gameManager.audioManager.play("itemPickup",{volume:.6}),console.log(`[EquipmentManager] Equipped: ${i.name}`),!0}unequip(e){if(!this.equipped[e])return!1;const t=this.equipped[e];return this.inventory.push(t),this.equipped[e]=null,this.applyEquipmentStats(),e===ot.WEAPON&&this.updateWeaponVisual(),this.saveEquipment(),this.updateUI(),console.log(`[EquipmentManager] Unequipped: ${t.name}`),!0}dropEquipment(e){const t=this.inventory.findIndex(s=>s.id===e);if(t===-1)return!1;const i=this.inventory.splice(t,1)[0];return this.saveEquipment(),this.updateUI(),console.log(`[EquipmentManager] Dropped: ${i.name}`),!0}getEquipmentBonuses(){const e={damage:0,defense:0,health:0,stamina:0,critChance:0,critDamage:0,attackSpeed:0,healthRegen:0,staminaRegen:0};for(const t of Object.values(this.equipped))if(t)for(const[i,s]of Object.entries(t.stats))e.hasOwnProperty(i)&&(e[i]+=s);return e}applyEquipmentStats(){if(!this.gameManager)return;const e=this.getEquipmentBonuses();this.gameManager.equipmentBonuses=e,this.gameManager.applyStatBonuses(),console.log("[EquipmentManager] Applied equipment bonuses:",e)}updateWeaponVisual(){const e=this.equipped[ot.WEAPON];if(!this.gameManager.playerMesh||(this.weaponMesh&&(this.gameManager.playerMesh.remove(this.weaponMesh),Yc().disposeWeapon(this.weaponMesh),this.weaponMesh=null),!e))return;const i={common:mi.COMMON,uncommon:mi.UNCOMMON,rare:mi.RARE,epic:mi.EPIC,legendary:mi.LEGENDARY}[e.rarity?.id]||mi.COMMON,s=Yc();this.weaponMesh=s.createWeapon(e.weaponModel||"sword",i,{name:e.name}),this.gameManager.playerMesh.add(this.weaponMesh),console.log(`[EquipmentManager] Updated weapon visual: ${e.name} (${e.weaponModel||"sword"})`)}updateWeaponGlow(e,t){this.weaponMesh&&Yc().updateGlow(this.weaponMesh,e,t)}createUI(){this.uiContainer=document.createElement("div"),this.uiContainer.id="equipment-ui",this.uiContainer.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 700px;
      max-height: 80vh;
      background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(10, 10, 15, 0.98));
      border: 2px solid rgba(255, 200, 100, 0.3);
      border-radius: 8px;
      padding: 20px;
      color: #ddd;
      font-family: 'Cinzel', 'Times New Roman', serif;
      display: none;
      z-index: 2000;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8), inset 0 0 60px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
    `,document.body.appendChild(this.uiContainer)}toggleUI(){this.isUIVisible=!this.isUIVisible,this.uiContainer.style.display=this.isUIVisible?"block":"none",this.isUIVisible&&this.updateUI()}updateUI(){if(!this.uiContainer)return;const e=this.getEquipmentBonuses();let t=`
      <h2 style="margin: 0 0 20px 0; text-align: center; color: #ffc864; text-shadow: 0 0 10px rgba(255, 200, 100, 0.5);">
         Equipment
      </h2>
      
      <div style="display: flex; gap: 20px;">
        <!-- Equipped slots -->
        <div style="flex: 1;">
          <h3 style="color: #aaa; margin-bottom: 10px; border-bottom: 1px solid rgba(255,200,100,0.2); padding-bottom: 5px;">Equipped</h3>
          ${this.renderEquippedSlot(ot.WEAPON," Weapon")}
          ${this.renderEquippedSlot(ot.ARMOR," Armor")}
          ${this.renderEquippedSlot(ot.ACCESSORY," Accessory")}
          
          <div style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 4px;">
            <h4 style="color: #888; margin: 0 0 8px 0;">Total Bonuses</h4>
            <div style="font-size: 12px; color: #8f8;">
              ${e.damage>0?`+${e.damage} Damage<br>`:""}
              ${e.defense>0?`+${e.defense} Defense<br>`:""}
              ${e.health!==0?`${e.health>0?"+":""}${e.health} Health<br>`:""}
              ${e.stamina!==0?`${e.stamina>0?"+":""}${e.stamina} Stamina<br>`:""}
              ${e.critChance>0?`+${e.critChance}% Crit Chance<br>`:""}
              ${e.critDamage>0?`+${e.critDamage}% Crit Damage<br>`:""}
              ${e.attackSpeed>0?`+${e.attackSpeed}% Attack Speed<br>`:""}
              ${e.healthRegen>0?`+${e.healthRegen} HP/s<br>`:""}
              ${e.staminaRegen>0?`+${e.staminaRegen}% Stamina Regen<br>`:""}
            </div>
          </div>
        </div>
        
        <!-- Inventory -->
        <div style="flex: 1.5;">
          <h3 style="color: #aaa; margin-bottom: 10px; border-bottom: 1px solid rgba(255,200,100,0.2); padding-bottom: 5px;">Inventory (${this.inventory.length})</h3>
          <div style="max-height: 400px; overflow-y: auto;">
            ${this.inventory.length===0?'<p style="color: #666;">No equipment in inventory</p>':""}
            ${this.inventory.map(i=>this.renderInventoryItem(i)).join("")}
          </div>
        </div>
      </div>
      
      <p style="text-align: center; color: #666; margin-top: 15px; font-size: 12px;">Press I to close</p>
    `;this.uiContainer.innerHTML=t,this.attachUIListeners()}renderEquippedSlot(e,t){const i=this.equipped[e];return i?`
      <div style="padding: 10px; margin-bottom: 8px; background: rgba(0,0,0,0.4); border: 1px solid ${i.rarity.color}40; border-radius: 4px;">
        <div style="color: ${i.rarity.color}; font-weight: bold;">${t}</div>
        <div style="color: ${i.rarity.color};">${i.name}</div>
        <div style="font-size: 11px; color: #888; margin-top: 4px;">
          ${Object.entries(i.stats).map(([s,n])=>`${n>0?"+":""}${n} ${this.formatStatName(s)}`).join(" | ")}
        </div>
        <button class="equip-unequip-btn" data-slot="${e}" style="
          margin-top: 6px;
          padding: 4px 10px;
          background: rgba(180, 80, 80, 0.4);
          border: 1px solid rgba(255, 100, 100, 0.3);
          color: #f88;
          border-radius: 3px;
          cursor: pointer;
          font-size: 11px;
        ">Unequip</button>
      </div>
    `:`
        <div style="padding: 10px; margin-bottom: 8px; background: rgba(0,0,0,0.3); border: 1px dashed rgba(255,255,255,0.1); border-radius: 4px;">
          <span style="color: #555;">${t}: Empty</span>
        </div>
      `}renderInventoryItem(e){return`
      <div style="padding: 10px; margin-bottom: 6px; background: rgba(0,0,0,0.3); border: 1px solid ${e.rarity.color}30; border-radius: 4px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span style="color: ${e.rarity.color};">${e.name}</span>
          <span style="color: #666; font-size: 11px;">${e.slot}</span>
        </div>
        <div style="font-size: 11px; color: #888; margin: 4px 0;">
          ${Object.entries(e.stats).map(([t,i])=>`${i>0?"+":""}${i} ${this.formatStatName(t)}`).join(" | ")}
        </div>
        <div style="display: flex; gap: 6px;">
          <button class="equip-item-btn" data-id="${e.id}" style="
            padding: 4px 12px;
            background: rgba(80, 180, 80, 0.4);
            border: 1px solid rgba(100, 255, 100, 0.3);
            color: #8f8;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
          ">Equip</button>
          <button class="drop-item-btn" data-id="${e.id}" style="
            padding: 4px 8px;
            background: rgba(80, 80, 80, 0.4);
            border: 1px solid rgba(100, 100, 100, 0.3);
            color: #888;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
          ">Drop</button>
        </div>
      </div>
    `}formatStatName(e){return{damage:"DMG",defense:"DEF",health:"HP",stamina:"STA",critChance:"CRIT%",critDamage:"CRIT DMG",attackSpeed:"ATK SPD",healthRegen:"HP/s",staminaRegen:"STA REG"}[e]||e}attachUIListeners(){this.uiContainer.querySelectorAll(".equip-item-btn").forEach(e=>{e.addEventListener("click",()=>{this.equip(e.dataset.id)})}),this.uiContainer.querySelectorAll(".equip-unequip-btn").forEach(e=>{e.addEventListener("click",()=>{this.unequip(e.dataset.slot)})}),this.uiContainer.querySelectorAll(".drop-item-btn").forEach(e=>{e.addEventListener("click",()=>{confirm("Drop this equipment?")&&this.dropEquipment(e.dataset.id)})})}showEquipmentPickup(e){const t=document.createElement("div");if(t.style.cssText=`
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid ${e.rarity.color};
      border-radius: 6px;
      color: ${e.rarity.color};
      font-family: 'Cinzel', serif;
      font-size: 16px;
      text-align: center;
      z-index: 3000;
      animation: equipPickup 2s ease-out forwards;
      box-shadow: 0 0 20px ${e.rarity.color}40;
    `,t.innerHTML=`
      <div style="font-size: 12px; color: #888; margin-bottom: 4px;">${e.rarity.name} ${e.slot}</div>
      <div style="font-weight: bold;">${e.name}</div>
      <div style="font-size: 11px; color: #aaa; margin-top: 6px;">
        ${Object.entries(e.stats).map(([i,s])=>`${s>0?"+":""}${s} ${this.formatStatName(i)}`).join(" | ")}
      </div>
    `,!document.getElementById("equip-pickup-style")){const i=document.createElement("style");i.id="equip-pickup-style",i.textContent=`
        @keyframes equipPickup {
          0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
          15% { opacity: 1; transform: translateX(-50%) translateY(0); }
          85% { opacity: 1; transform: translateX(-50%) translateY(0); }
          100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
      `,document.head.appendChild(i)}document.body.appendChild(t),setTimeout(()=>t.remove(),2e3)}saveEquipment(){const e={equipped:this.equipped,inventory:this.inventory};localStorage.setItem("ashen_equipment",JSON.stringify(e))}loadEquipment(){try{const e=localStorage.getItem("ashen_equipment");if(e){const t=JSON.parse(e);if(t.equipped)for(const[i,s]of Object.entries(t.equipped))s&&(s.rarity=qe[s.rarity.id.toUpperCase()]||qe.COMMON,this.equipped[i]=s);t.inventory&&(this.inventory=t.inventory.map(i=>(i.rarity=qe[i.rarity.id.toUpperCase()]||qe.COMMON,i))),console.log("[EquipmentManager] Loaded equipment from localStorage")}}catch(e){console.error("[EquipmentManager] Failed to load equipment:",e)}}update(e){}}const ft={ORE:{id:"ore",name:"Ores",description:"Metals and minerals for forging weapons and armor.",icon:"",color:8947848},HERB:{id:"herb",name:"Herbs",description:"Plants used in alchemy and potion brewing.",icon:"",color:4500036},MONSTER_DROP:{id:"monster_drop",name:"Monster Drops",description:"Materials harvested from defeated creatures.",icon:"",color:11158596},GEM:{id:"gem",name:"Gems",description:"Precious stones used for enchanting and high-tier crafting.",icon:"",color:4500223},MISC:{id:"misc",name:"Miscellaneous",description:"Common crafting components and materials.",icon:"",color:11184776}},vt={COMMON:{id:"common",name:"Common",color:"#888888",hexColor:8947848,dropChance:1,sellMultiplier:1},UNCOMMON:{id:"uncommon",name:"Uncommon",color:"#4ade80",hexColor:4906624,dropChance:.5,sellMultiplier:2},RARE:{id:"rare",name:"Rare",color:"#60a5fa",hexColor:6333946,dropChance:.2,sellMultiplier:5},EPIC:{id:"epic",name:"Epic",color:"#c084fc",hexColor:12616956,dropChance:.08,sellMultiplier:15},LEGENDARY:{id:"legendary",name:"Legendary",color:"#f97316",hexColor:16347926,dropChance:.02,sellMultiplier:50}},be={ANY:"any",FOREST:"forest",MOUNTAIN:"mountain",SWAMP:"swamp",DESERT:"desert",SNOW:"snow",CAVE:"cave",RUINS:"ruins",VILLAGE:"village"},Wm={iron_ore:{id:"iron_ore",name:"Iron Ore",category:ft.ORE,rarity:vt.COMMON,description:"Common metal ore. Foundation of most weapons and armor.",iconColor:9145227,sellValue:5,stackLimit:99,sources:["gathering","chest"],biomes:[be.MOUNTAIN,be.CAVE],gatherYield:{min:2,max:4}},copper_ore:{id:"copper_ore",name:"Copper Ore",category:ft.ORE,rarity:vt.COMMON,description:"Soft metal, easy to work with. Used in basic crafting.",iconColor:12088115,sellValue:3,stackLimit:99,sources:["gathering","shop"],biomes:[be.ANY],gatherYield:{min:2,max:5}},gold_ore:{id:"gold_ore",name:"Gold Ore",category:ft.ORE,rarity:vt.UNCOMMON,description:"Precious metal ore. Highly valuable but soft.",iconColor:16766720,sellValue:25,stackLimit:50,sources:["gathering","chest"],biomes:[be.MOUNTAIN,be.CAVE],gatherYield:{min:1,max:2}},mythril_ore:{id:"mythril_ore",name:"Mythril Ore",category:ft.ORE,rarity:vt.RARE,description:"Magical silver-blue ore. Light yet incredibly strong.",iconColor:8965375,sellValue:75,stackLimit:30,sources:["gathering","boss"],biomes:[be.CAVE,be.RUINS],gatherYield:{min:1,max:2}},darksteel_ore:{id:"darksteel_ore",name:"Darksteel Ore",category:ft.ORE,rarity:vt.EPIC,description:"Corrupted metal from the deep. Forged in shadow.",iconColor:2759226,sellValue:150,stackLimit:20,sources:["gathering","boss"],biomes:[be.CAVE,be.SWAMP],gatherYield:{min:1,max:1}},titanium_ore:{id:"titanium_ore",name:"Titanium Ore",category:ft.ORE,rarity:vt.RARE,description:"Extremely hard metal. Difficult to smelt but worth it.",iconColor:12632256,sellValue:60,stackLimit:30,sources:["gathering"],biomes:[be.MOUNTAIN],gatherYield:{min:1,max:2}},healing_leaf:{id:"healing_leaf",name:"Healing Leaf",category:ft.HERB,rarity:vt.COMMON,description:"Soft green leaves with restorative properties.",iconColor:6736998,sellValue:3,stackLimit:99,sources:["gathering","shop"],biomes:[be.FOREST,be.ANY],gatherYield:{min:2,max:5}},mana_bloom:{id:"mana_bloom",name:"Mana Bloom",category:ft.HERB,rarity:vt.UNCOMMON,description:"Blue-petaled flower that pulses with magical energy.",iconColor:6719743,sellValue:12,stackLimit:50,sources:["gathering"],biomes:[be.FOREST,be.RUINS],gatherYield:{min:1,max:3}},vitality_root:{id:"vitality_root",name:"Vitality Root",category:ft.HERB,rarity:vt.UNCOMMON,description:"Gnarled red root. Invigorates the body when consumed.",iconColor:13386820,sellValue:15,stackLimit:50,sources:["gathering"],biomes:[be.FOREST,be.SWAMP],gatherYield:{min:1,max:2}},poison_ivy:{id:"poison_ivy",name:"Poison Ivy",category:ft.HERB,rarity:vt.COMMON,description:"Toxic plant. Handle with care. Used in poisons.",iconColor:8956450,sellValue:8,stackLimit:50,sources:["gathering"],biomes:[be.SWAMP,be.FOREST],gatherYield:{min:2,max:4}},fire_petal:{id:"fire_petal",name:"Fire Petal",category:ft.HERB,rarity:vt.RARE,description:"Warm to the touch. Blooms only near volcanic heat.",iconColor:16737860,sellValue:40,stackLimit:30,sources:["gathering","chest"],biomes:[be.DESERT,be.MOUNTAIN],gatherYield:{min:1,max:2}},frost_moss:{id:"frost_moss",name:"Frost Moss",category:ft.HERB,rarity:vt.RARE,description:"Ice-cold moss from frozen peaks. Chills the blood.",iconColor:11197951,sellValue:35,stackLimit:30,sources:["gathering"],biomes:[be.SNOW,be.MOUNTAIN],gatherYield:{min:1,max:2}},shadow_fungus:{id:"shadow_fungus",name:"Shadow Fungus",category:ft.HERB,rarity:vt.EPIC,description:"Grows only in absolute darkness. Absorbs light.",iconColor:4465254,sellValue:80,stackLimit:20,sources:["gathering","boss"],biomes:[be.CAVE],gatherYield:{min:1,max:1}},wolf_fang:{id:"wolf_fang",name:"Wolf Fang",category:ft.MONSTER_DROP,rarity:vt.COMMON,description:"Sharp canine tooth. Popular in primitive jewelry.",iconColor:15658700,sellValue:5,stackLimit:99,sources:["enemy"],enemyTypes:["wolf","beast"],dropChance:.4},slime_gel:{id:"slime_gel",name:"Slime Gel",category:ft.MONSTER_DROP,rarity:vt.COMMON,description:"Gelatinous goo. Surprisingly useful in alchemy.",iconColor:8978312,sellValue:3,stackLimit:99,sources:["enemy"],enemyTypes:["slime"],dropChance:.6},bone_shard:{id:"bone_shard",name:"Bone Shard",category:ft.MONSTER_DROP,rarity:vt.COMMON,description:"Fragment of bone. Used in dark rituals and crafting.",iconColor:14540219,sellValue:4,stackLimit:99,sources:["enemy"],enemyTypes:["skeleton","undead"],dropChance:.5},shadow_essence:{id:"shadow_essence",name:"Shadow Essence",category:ft.MONSTER_DROP,rarity:vt.RARE,description:"Concentrated darkness from corrupted beings.",iconColor:6693546,sellValue:45,stackLimit:30,sources:["enemy","boss"],enemyTypes:["wraith","shadow","corrupted"],dropChance:.15},dragon_scale:{id:"dragon_scale",name:"Dragon Scale",category:ft.MONSTER_DROP,rarity:vt.LEGENDARY,description:"Nearly indestructible scale from an ancient dragon.",iconColor:16729122,sellValue:500,stackLimit:10,sources:["boss"],enemyTypes:["dragon"],dropChance:.05},golem_core:{id:"golem_core",name:"Golem Core",category:ft.MONSTER_DROP,rarity:vt.EPIC,description:"Magical crystalline heart that once animated stone.",iconColor:6728447,sellValue:200,stackLimit:10,sources:["boss"],enemyTypes:["golem"],dropChance:.2},corrupted_heart:{id:"corrupted_heart",name:"Corrupted Heart",category:ft.MONSTER_DROP,rarity:vt.EPIC,description:"Black heart still beating with dark energy.",iconColor:4456482,sellValue:180,stackLimit:10,sources:["boss","enemy"],enemyTypes:["corrupted_knight","elite"],dropChance:.1},beast_hide:{id:"beast_hide",name:"Beast Hide",category:ft.MONSTER_DROP,rarity:vt.COMMON,description:"Tough animal hide. Good for basic leather armor.",iconColor:9136404,sellValue:6,stackLimit:50,sources:["enemy"],enemyTypes:["wolf","beast","boar"],dropChance:.35},treant_bark:{id:"treant_bark",name:"Treant Bark",category:ft.MONSTER_DROP,rarity:vt.RARE,description:"Living bark from a forest guardian. Magically hardened.",iconColor:5596723,sellValue:55,stackLimit:20,sources:["boss","enemy"],enemyTypes:["treant","forest_guardian"],dropChance:.12},spider_silk:{id:"spider_silk",name:"Spider Silk",category:ft.MONSTER_DROP,rarity:vt.UNCOMMON,description:"Strong yet lightweight thread. Perfect for robes.",iconColor:15658734,sellValue:18,stackLimit:50,sources:["enemy"],enemyTypes:["spider"],dropChance:.3},ruby:{id:"ruby",name:"Ruby",category:ft.GEM,rarity:vt.RARE,description:"Blood-red gem pulsing with fire magic.",iconColor:16720452,sellValue:100,stackLimit:20,sources:["gathering","chest","boss"],biomes:[be.CAVE,be.MOUNTAIN],gatherYield:{min:1,max:1},enchantment:"fire"},sapphire:{id:"sapphire",name:"Sapphire",category:ft.GEM,rarity:vt.RARE,description:"Deep blue gem resonating with ice magic.",iconColor:2245887,sellValue:100,stackLimit:20,sources:["gathering","chest"],biomes:[be.SNOW,be.CAVE],gatherYield:{min:1,max:1},enchantment:"ice"},emerald:{id:"emerald",name:"Emerald",category:ft.GEM,rarity:vt.RARE,description:"Vibrant green gem attuned to nature magic.",iconColor:2293572,sellValue:100,stackLimit:20,sources:["gathering","chest"],biomes:[be.FOREST,be.SWAMP],gatherYield:{min:1,max:1},enchantment:"nature"},diamond:{id:"diamond",name:"Diamond",category:ft.GEM,rarity:vt.EPIC,description:"Flawless gem of unmatched hardness and purity.",iconColor:15663103,sellValue:300,stackLimit:10,sources:["gathering","boss"],biomes:[be.CAVE],gatherYield:{min:1,max:1},enchantment:"light"},void_crystal:{id:"void_crystal",name:"Void Crystal",category:ft.GEM,rarity:vt.LEGENDARY,description:"Purple crystal from beyond reality. Bends space.",iconColor:8921855,sellValue:750,stackLimit:5,sources:["boss"],biomes:[be.RUINS],gatherYield:{min:1,max:1},enchantment:"void"},topaz:{id:"topaz",name:"Topaz",category:ft.GEM,rarity:vt.UNCOMMON,description:"Golden gem that amplifies lightning magic.",iconColor:16763938,sellValue:50,stackLimit:30,sources:["gathering","chest"],biomes:[be.DESERT,be.MOUNTAIN],gatherYield:{min:1,max:2},enchantment:"lightning"},amethyst:{id:"amethyst",name:"Amethyst",category:ft.GEM,rarity:vt.UNCOMMON,description:"Purple gem that enhances arcane magic.",iconColor:11158732,sellValue:45,stackLimit:30,sources:["gathering","chest"],biomes:[be.CAVE,be.RUINS],gatherYield:{min:1,max:2},enchantment:"arcane"},leather:{id:"leather",name:"Leather",category:ft.MISC,rarity:vt.COMMON,description:"Tanned animal hide. Basic armor material.",iconColor:9127187,sellValue:8,stackLimit:99,sources:["shop","enemy"],biomes:[be.VILLAGE]},cloth:{id:"cloth",name:"Cloth",category:ft.MISC,rarity:vt.COMMON,description:"Woven fabric for robes and light armor.",iconColor:15658700,sellValue:4,stackLimit:99,sources:["shop","chest"],biomes:[be.VILLAGE]},thread:{id:"thread",name:"Thread",category:ft.MISC,rarity:vt.COMMON,description:"Thin fibers for sewing and crafting.",iconColor:13421738,sellValue:2,stackLimit:99,sources:["shop"],biomes:[be.VILLAGE]},wood:{id:"wood",name:"Wood",category:ft.MISC,rarity:vt.COMMON,description:"Sturdy lumber for handles and construction.",iconColor:9136404,sellValue:3,stackLimit:99,sources:["gathering","shop"],biomes:[be.FOREST,be.ANY],gatherYield:{min:3,max:6}},stone:{id:"stone",name:"Stone",category:ft.MISC,rarity:vt.COMMON,description:"Basic rock. Used in simple tools and construction.",iconColor:8947848,sellValue:1,stackLimit:99,sources:["gathering"],biomes:[be.ANY],gatherYield:{min:3,max:6}},glass:{id:"glass",name:"Glass",category:ft.MISC,rarity:vt.COMMON,description:"Transparent material for vials and lenses.",iconColor:11197934,sellValue:5,stackLimit:50,sources:["shop"],biomes:[be.VILLAGE]},enchanted_dust:{id:"enchanted_dust",name:"Enchanted Dust",category:ft.MISC,rarity:vt.UNCOMMON,description:"Magical residue. Essential for enchanting.",iconColor:16755455,sellValue:20,stackLimit:50,sources:["enemy","chest"],enemyTypes:["mage","elemental","magic"],dropChance:.25},ancient_rune:{id:"ancient_rune",name:"Ancient Rune",category:ft.MISC,rarity:vt.RARE,description:"Stone tablet inscribed with forgotten magic.",iconColor:6750122,sellValue:65,stackLimit:20,sources:["chest","boss"],biomes:[be.RUINS]},refined_steel:{id:"refined_steel",name:"Refined Steel",category:ft.MISC,rarity:vt.UNCOMMON,description:"Purified steel ingot. Superior to raw iron.",iconColor:11189196,sellValue:25,stackLimit:50,sources:["shop","crafted"],biomes:[be.VILLAGE]},magic_crystal:{id:"magic_crystal",name:"Magic Crystal",category:ft.MISC,rarity:vt.RARE,description:"Crystallized mana. Powers magical devices.",iconColor:8978431,sellValue:55,stackLimit:30,sources:["gathering","boss"],biomes:[be.RUINS,be.CAVE],gatherYield:{min:1,max:1}}},_d={ORE_VEIN:{id:"ore_vein",name:"Ore Vein",category:ft.ORE,model:"rock",gatherTime:2,respawnTime:180,particles:"spark",biomeDrops:{[be.MOUNTAIN]:["iron_ore","copper_ore","gold_ore","titanium_ore"],[be.CAVE]:["iron_ore","mythril_ore","darksteel_ore","gold_ore"],[be.ANY]:["iron_ore","copper_ore","stone"]}},HERB_PATCH:{id:"herb_patch",name:"Herb Patch",category:ft.HERB,model:"plant",gatherTime:1.5,respawnTime:120,particles:"leaf",biomeDrops:{[be.FOREST]:["healing_leaf","mana_bloom","poison_ivy"],[be.SWAMP]:["poison_ivy","vitality_root","shadow_fungus"],[be.SNOW]:["frost_moss","healing_leaf"],[be.DESERT]:["fire_petal","vitality_root"],[be.ANY]:["healing_leaf"]}},WOOD_STUMP:{id:"wood_stump",name:"Wood Stump",category:ft.MISC,model:"stump",gatherTime:1.8,respawnTime:150,particles:"wood",biomeDrops:{[be.FOREST]:["wood","treant_bark"],[be.ANY]:["wood"]}},CRYSTAL_NODE:{id:"crystal_node",name:"Crystal Formation",category:ft.GEM,model:"crystal",gatherTime:2.5,respawnTime:300,particles:"sparkle",biomeDrops:{[be.CAVE]:["amethyst","sapphire","diamond","magic_crystal"],[be.RUINS]:["void_crystal","ancient_rune","magic_crystal"],[be.MOUNTAIN]:["ruby","topaz","emerald"],[be.ANY]:["amethyst","topaz"]}}};function On(l){return Wm[l]||null}function V1(l,e){const t=_d[l];return!t||!t.biomeDrops?[]:t.biomeDrops[e]?t.biomeDrops[e]:t.biomeDrops[be.ANY]||[]}function $1(l,e,t=0){const i=V1(l,e);if(i.length===0)return[];const s=[],n=Math.random()<.3+t?2:1;for(let a=0;a<n&&i.length>0;a++){const o=Math.floor(Math.random()*i.length),r=i[o],c=On(r);if(c&&c.gatherYield){const h=c.gatherYield.min+Math.floor(Math.random()*(c.gatherYield.max-c.gatherYield.min+1)),d=Math.floor(h*(1+t));s.push({materialId:r,quantity:Math.max(1,d)})}else s.push({materialId:r,quantity:1})}return s}const X1=Object.values(Wm);X1.length;const Ft={WEAPON:{id:"weapon",name:"Weapons",description:"Swords, axes, daggers, and implements of war.",icon:"",color:13386820,station:"forge"},ARMOR:{id:"armor",name:"Armor",description:"Protection for head, chest, hands, and feet.",icon:"",color:4491468,station:"forge"},POTION:{id:"potion",name:"Potions",description:"Consumable brews for health, mana, and buffs.",icon:"",color:4508808,station:"alchemy_table"},ACCESSORY:{id:"accessory",name:"Accessories",description:"Rings, amulets, and charms for bonus effects.",icon:"",color:13412932,station:"workbench"},UPGRADE:{id:"upgrade",name:"Upgrades",description:"Materials to enhance weapons and armor.",icon:"",color:11158732,station:"forge"},MATERIAL:{id:"material",name:"Refined Materials",description:"Processed materials for advanced crafting.",icon:"",color:8947848,station:"workbench"}},Mt={KNOWN_BY_DEFAULT:"known_by_default",FOUND_IN_CHEST:"found_in_chest",BOUGHT_FROM_NPC:"bought_from_npc",BOSS_DROP:"boss_drop",EXPLORATION:"exploration",QUEST_REWARD:"quest_reward",LEVEL_UP:"level_up"},Ut={FORGE:{id:"forge",name:"Forge",description:"Required for metalworking and weapon crafting.",modelType:"forge"},ALCHEMY_TABLE:{id:"alchemy_table",name:"Alchemy Table",description:"Required for brewing potions and elixirs.",modelType:"table"},WORKBENCH:{id:"workbench",name:"Workbench",description:"Required for general crafting and accessories.",modelType:"bench"},ENCHANTING_ALTAR:{id:"enchanting_altar",name:"Enchanting Altar",description:"Required for magical enhancements.",modelType:"altar"}},fr={health_potion:{id:"health_potion",name:"Health Potion",category:Ft.POTION,description:"Restores 50 HP instantly.",materials:[{materialId:"healing_leaf",qty:3},{materialId:"glass",qty:1}],result:{itemId:"health_potion",qty:1},craftingTime:2,requiredLevel:1,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.ALCHEMY_TABLE,rarity:"common"},mana_potion:{id:"mana_potion",name:"Mana Potion",category:Ft.POTION,description:"Restores 40 MP instantly.",materials:[{materialId:"mana_bloom",qty:2},{materialId:"glass",qty:1}],result:{itemId:"mana_potion",qty:1},craftingTime:2,requiredLevel:1,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.ALCHEMY_TABLE,rarity:"common"},stamina_potion:{id:"stamina_potion",name:"Stamina Potion",category:Ft.POTION,description:"Instantly refills stamina.",materials:[{materialId:"vitality_root",qty:2},{materialId:"glass",qty:1}],result:{itemId:"stamina_potion",qty:1},craftingTime:2,requiredLevel:3,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.ALCHEMY_TABLE,rarity:"common"},greater_health_potion:{id:"greater_health_potion",name:"Greater Health Potion",category:Ft.POTION,description:"Restores 120 HP instantly.",materials:[{materialId:"healing_leaf",qty:5},{materialId:"vitality_root",qty:2},{materialId:"glass",qty:1}],result:{itemId:"greater_health_potion",qty:1},craftingTime:3.5,requiredLevel:8,unlockMethod:Mt.FOUND_IN_CHEST,station:Ut.ALCHEMY_TABLE,rarity:"uncommon"},antidote:{id:"antidote",name:"Antidote",category:Ft.POTION,description:"Cures poison and grants temporary immunity.",materials:[{materialId:"poison_ivy",qty:2},{materialId:"healing_leaf",qty:1},{materialId:"glass",qty:1}],result:{itemId:"antidote",qty:1},craftingTime:2.5,requiredLevel:5,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.ALCHEMY_TABLE,rarity:"common"},fire_resistance_potion:{id:"fire_resistance_potion",name:"Fire Resistance Potion",category:Ft.POTION,description:"Reduces fire damage by 50% for 60 seconds.",materials:[{materialId:"fire_petal",qty:2},{materialId:"frost_moss",qty:1},{materialId:"glass",qty:1}],result:{itemId:"fire_resistance_potion",qty:1},craftingTime:4,requiredLevel:10,unlockMethod:Mt.FOUND_IN_CHEST,station:Ut.ALCHEMY_TABLE,rarity:"uncommon"},strength_elixir:{id:"strength_elixir",name:"Strength Elixir",category:Ft.POTION,description:"Increases STR by 5 for 90 seconds.",materials:[{materialId:"vitality_root",qty:3},{materialId:"wolf_fang",qty:2},{materialId:"glass",qty:1}],result:{itemId:"strength_elixir",qty:1},craftingTime:5,requiredLevel:12,unlockMethod:Mt.BOUGHT_FROM_NPC,station:Ut.ALCHEMY_TABLE,rarity:"rare"},speed_potion:{id:"speed_potion",name:"Speed Potion",category:Ft.POTION,description:"Increases movement speed by 30% for 45 seconds.",materials:[{materialId:"mana_bloom",qty:2},{materialId:"spider_silk",qty:1},{materialId:"glass",qty:1}],result:{itemId:"speed_potion",qty:1},craftingTime:3,requiredLevel:6,unlockMethod:Mt.EXPLORATION,station:Ut.ALCHEMY_TABLE,rarity:"uncommon"},refined_steel:{id:"refined_steel",name:"Refined Steel",category:Ft.MATERIAL,description:"Purified steel ingot for advanced forging.",materials:[{materialId:"iron_ore",qty:3},{materialId:"copper_ore",qty:1}],result:{itemId:"refined_steel",qty:1},craftingTime:4,requiredLevel:5,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.FORGE,rarity:"uncommon"},treated_leather:{id:"treated_leather",name:"Treated Leather",category:Ft.MATERIAL,description:"Hardened leather for quality armor.",materials:[{materialId:"leather",qty:2},{materialId:"beast_hide",qty:2}],result:{itemId:"treated_leather",qty:1},craftingTime:3,requiredLevel:4,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.WORKBENCH,rarity:"uncommon"},enchanted_thread:{id:"enchanted_thread",name:"Enchanted Thread",category:Ft.MATERIAL,description:"Magically infused thread for robes.",materials:[{materialId:"thread",qty:3},{materialId:"spider_silk",qty:2},{materialId:"enchanted_dust",qty:1}],result:{itemId:"enchanted_thread",qty:1},craftingTime:5,requiredLevel:10,unlockMethod:Mt.FOUND_IN_CHEST,station:Ut.WORKBENCH,rarity:"rare"},iron_sword:{id:"iron_sword",name:"Iron Sword",category:Ft.WEAPON,description:"A reliable sword forged from iron. Solid damage with balanced scaling.",materials:[{materialId:"iron_ore",qty:5},{materialId:"wood",qty:2},{materialId:"leather",qty:1}],result:{itemId:"iron_sword",qty:1},craftingTime:6,requiredLevel:3,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.FORGE,rarity:"common",resultStats:{damage:25,scaling:{strength:"C",dexterity:"D"}}},steel_sword:{id:"steel_sword",name:"Steel Sword",category:Ft.WEAPON,description:"Refined steel blade with improved damage.",materials:[{materialId:"refined_steel",qty:4},{materialId:"wood",qty:2},{materialId:"leather",qty:2}],result:{itemId:"steel_sword",qty:1},craftingTime:8,requiredLevel:8,unlockMethod:Mt.BOUGHT_FROM_NPC,station:Ut.FORGE,rarity:"uncommon",resultStats:{damage:38,scaling:{strength:"B",dexterity:"D"}}},hunter_dagger:{id:"hunter_dagger",name:"Hunter's Dagger",category:Ft.WEAPON,description:"Quick blade favored by scouts. High crit chance.",materials:[{materialId:"iron_ore",qty:3},{materialId:"wolf_fang",qty:2},{materialId:"leather",qty:1}],result:{itemId:"hunter_dagger",qty:1},craftingTime:4,requiredLevel:4,unlockMethod:Mt.EXPLORATION,station:Ut.FORGE,rarity:"common",resultStats:{damage:18,scaling:{strength:"D",dexterity:"B"},critBonus:15}},battle_axe:{id:"battle_axe",name:"Battle Axe",category:Ft.WEAPON,description:"Heavy two-handed axe with devastating cleave damage.",materials:[{materialId:"iron_ore",qty:8},{materialId:"wood",qty:4},{materialId:"leather",qty:2}],result:{itemId:"battle_axe",qty:1},craftingTime:10,requiredLevel:6,unlockMethod:Mt.FOUND_IN_CHEST,station:Ut.FORGE,rarity:"uncommon",resultStats:{damage:45,scaling:{strength:"A",dexterity:"E"}}},mythril_blade:{id:"mythril_blade",name:"Mythril Blade",category:Ft.WEAPON,description:"Light yet deadly blade forged from mythril. Excellent magic scaling.",materials:[{materialId:"mythril_ore",qty:5},{materialId:"refined_steel",qty:2},{materialId:"magic_crystal",qty:1}],result:{itemId:"mythril_blade",qty:1},craftingTime:15,requiredLevel:15,unlockMethod:Mt.BOSS_DROP,station:Ut.FORGE,rarity:"rare",resultStats:{damage:52,scaling:{strength:"C",dexterity:"B",intelligence:"B"},magicDamage:20}},shadow_blade:{id:"shadow_blade",name:"Shadow Blade",category:Ft.WEAPON,description:"Blade forged from darksteel. Drains life on hit.",materials:[{materialId:"darksteel_ore",qty:4},{materialId:"shadow_essence",qty:3},{materialId:"corrupted_heart",qty:1}],result:{itemId:"shadow_blade",qty:1},craftingTime:20,requiredLevel:20,unlockMethod:Mt.BOSS_DROP,station:Ut.FORGE,rarity:"epic",resultStats:{damage:65,scaling:{strength:"B",dexterity:"A"},lifesteal:5}},leather_chest:{id:"leather_chest",name:"Leather Chestpiece",category:Ft.ARMOR,description:"Basic leather armor. Light and flexible.",materials:[{materialId:"leather",qty:4},{materialId:"thread",qty:2}],result:{itemId:"leather_chest",qty:1},craftingTime:5,requiredLevel:2,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.WORKBENCH,rarity:"common",resultStats:{defense:8,weight:3}},chainmail_helm:{id:"chainmail_helm",name:"Chainmail Helm",category:Ft.ARMOR,description:"Interlocked rings provide good protection.",materials:[{materialId:"iron_ore",qty:6},{materialId:"leather",qty:1}],result:{itemId:"chainmail_helm",qty:1},craftingTime:6,requiredLevel:5,unlockMethod:Mt.BOUGHT_FROM_NPC,station:Ut.FORGE,rarity:"common",resultStats:{defense:12,weight:4}},steel_plate_boots:{id:"steel_plate_boots",name:"Steel Plate Boots",category:Ft.ARMOR,description:"Heavy boots offering solid protection.",materials:[{materialId:"refined_steel",qty:3},{materialId:"leather",qty:2}],result:{itemId:"steel_plate_boots",qty:1},craftingTime:7,requiredLevel:10,unlockMethod:Mt.FOUND_IN_CHEST,station:Ut.FORGE,rarity:"uncommon",resultStats:{defense:18,weight:6,poise:5}},mage_robe:{id:"mage_robe",name:"Mage's Robe",category:Ft.ARMOR,description:"Enchanted cloth that boosts magic power.",materials:[{materialId:"cloth",qty:5},{materialId:"enchanted_thread",qty:2},{materialId:"mana_bloom",qty:3}],result:{itemId:"mage_robe",qty:1},craftingTime:10,requiredLevel:12,unlockMethod:Mt.EXPLORATION,station:Ut.WORKBENCH,rarity:"rare",resultStats:{defense:6,magicDefense:25,weight:2,manaBonus:30}},iron_ring:{id:"iron_ring",name:"Iron Ring",category:Ft.ACCESSORY,description:"Simple ring that slightly boosts defense.",materials:[{materialId:"iron_ore",qty:2}],result:{itemId:"iron_ring",qty:1},craftingTime:2,requiredLevel:1,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.WORKBENCH,rarity:"common",resultStats:{defense:2}},ruby_amulet:{id:"ruby_amulet",name:"Ruby Amulet",category:Ft.ACCESSORY,description:"Amulet infused with fire magic. +15% fire damage.",materials:[{materialId:"ruby",qty:1},{materialId:"gold_ore",qty:2},{materialId:"thread",qty:1}],result:{itemId:"ruby_amulet",qty:1},craftingTime:8,requiredLevel:12,unlockMethod:Mt.FOUND_IN_CHEST,station:Ut.WORKBENCH,rarity:"rare",resultStats:{fireDamageBonus:15}},sapphire_ring:{id:"sapphire_ring",name:"Sapphire Ring",category:Ft.ACCESSORY,description:"Ring that enhances mana regeneration.",materials:[{materialId:"sapphire",qty:1},{materialId:"refined_steel",qty:1}],result:{itemId:"sapphire_ring",qty:1},craftingTime:6,requiredLevel:10,unlockMethod:Mt.EXPLORATION,station:Ut.WORKBENCH,rarity:"rare",resultStats:{manaRegen:3}},wolf_fang_charm:{id:"wolf_fang_charm",name:"Wolf Fang Charm",category:Ft.ACCESSORY,description:"Tribal charm that increases attack speed.",materials:[{materialId:"wolf_fang",qty:5},{materialId:"leather",qty:1},{materialId:"thread",qty:1}],result:{itemId:"wolf_fang_charm",qty:1},craftingTime:4,requiredLevel:6,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.WORKBENCH,rarity:"uncommon",resultStats:{attackSpeedBonus:8}},void_pendant:{id:"void_pendant",name:"Void Pendant",category:Ft.ACCESSORY,description:"Mysterious pendant that grants shadow damage and phasing.",materials:[{materialId:"void_crystal",qty:1},{materialId:"shadow_essence",qty:3},{materialId:"ancient_rune",qty:1}],result:{itemId:"void_pendant",qty:1},craftingTime:15,requiredLevel:25,unlockMethod:Mt.BOSS_DROP,station:Ut.ENCHANTING_ALTAR,rarity:"legendary",resultStats:{shadowDamageBonus:25,phaseChance:10}},weapon_sharpening_stone:{id:"weapon_sharpening_stone",name:"Sharpening Stone",category:Ft.UPGRADE,description:"Use at forge to upgrade weapon damage by +5.",materials:[{materialId:"stone",qty:5},{materialId:"iron_ore",qty:2}],result:{itemId:"sharpening_stone",qty:1},craftingTime:3,requiredLevel:3,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.WORKBENCH,rarity:"common"},armor_reinforcement_kit:{id:"armor_reinforcement_kit",name:"Reinforcement Kit",category:Ft.UPGRADE,description:"Use at forge to upgrade armor defense by +3.",materials:[{materialId:"iron_ore",qty:3},{materialId:"leather",qty:2}],result:{itemId:"reinforcement_kit",qty:1},craftingTime:3,requiredLevel:4,unlockMethod:Mt.KNOWN_BY_DEFAULT,station:Ut.WORKBENCH,rarity:"common"},fire_enchantment_scroll:{id:"fire_enchantment_scroll",name:"Fire Enchantment Scroll",category:Ft.UPGRADE,description:"Imbue weapon with fire damage.",materials:[{materialId:"fire_petal",qty:3},{materialId:"ruby",qty:1},{materialId:"ancient_rune",qty:1}],result:{itemId:"fire_enchantment_scroll",qty:1},craftingTime:10,requiredLevel:15,unlockMethod:Mt.BOSS_DROP,station:Ut.ENCHANTING_ALTAR,rarity:"epic"},ice_enchantment_scroll:{id:"ice_enchantment_scroll",name:"Ice Enchantment Scroll",category:Ft.UPGRADE,description:"Imbue weapon with ice damage and slow effect.",materials:[{materialId:"frost_moss",qty:3},{materialId:"sapphire",qty:1},{materialId:"ancient_rune",qty:1}],result:{itemId:"ice_enchantment_scroll",qty:1},craftingTime:10,requiredLevel:15,unlockMethod:Mt.BOSS_DROP,station:Ut.ENCHANTING_ALTAR,rarity:"epic"},dragon_scale_reinforcement:{id:"dragon_scale_reinforcement",name:"Dragon Scale Reinforcement",category:Ft.UPGRADE,description:"Ultimate armor upgrade. +15 defense, +10 fire resistance.",materials:[{materialId:"dragon_scale",qty:2},{materialId:"mythril_ore",qty:3},{materialId:"magic_crystal",qty:2}],result:{itemId:"dragon_reinforcement",qty:1},craftingTime:25,requiredLevel:30,unlockMethod:Mt.BOSS_DROP,station:Ut.FORGE,rarity:"legendary"}};function cn(l){return fr[l]||null}function Y1(){return Object.values(fr).filter(l=>l.unlockMethod===Mt.KNOWN_BY_DEFAULT)}function Q1(l,e){const t=cn(l);return t?t.materials.map(i=>({materialId:i.materialId,qty:i.qty*e})):null}function ef(l){const e=cn(l);return e&&{common:"#888888",uncommon:"#4ade80",rare:"#60a5fa",epic:"#c084fc",legendary:"#f97316"}[e.rarity]||"#888888"}const j1=Object.values(fr);j1.length;const ps={WOODEN:{id:"wooden",name:"Wooden Chest",color:9127187,emissive:3346688,glowColor:16755268,glowIntensity:.5,spawnWeight:60,goldRange:[10,30],potionChance:.3,equipmentChance:.15,equipmentRarityWeights:{common:80,uncommon:18,rare:2,epic:0},materialChance:.4,materialRange:[1,3],recipeScrollChance:.1},SILVER:{id:"silver",name:"Silver Chest",color:12632256,emissive:4473941,glowColor:8956671,glowIntensity:.8,spawnWeight:30,goldRange:[30,80],potionChance:.5,equipmentChance:.35,equipmentRarityWeights:{common:40,uncommon:40,rare:18,epic:2},materialChance:.6,materialRange:[2,5],recipeScrollChance:.25},GOLD:{id:"gold",name:"Golden Chest",color:16766720,emissive:11175936,glowColor:16772744,glowIntensity:1.2,spawnWeight:10,goldRange:[80,200],potionChance:.8,equipmentChance:.65,equipmentRarityWeights:{common:10,uncommon:30,rare:45,epic:15},materialChance:.9,materialRange:[3,8],recipeScrollChance:.5}},tl={RUINS:{chance:.7,offset:{minDist:3,maxDist:12},tierBoost:1.2},CAVES:{chance:.85,offset:{minDist:2,maxDist:8},tierBoost:1.5},HIDDEN:{chance:.3,minDistFromCastle:120,tierBoost:1}};class K1{constructor(e,t,i,s,n,a,o){this.scene=e,this.terrain=t,this.ruinsManager=i,this.caveManager=s,this.lootManager=n,this.equipmentManager=a,this.inputManager=o,this.regionSize=150,this.loadDistance=2,this.unloadDistance=4,this.interactionDistance=3,this.respawnTimeMs=300*1e3,this.regions=new Map,this.chests=[],this.chestMeshes=[],this.lastPlayerRegionX=null,this.lastPlayerRegionZ=null,this.openedChests=this._loadOpenedChests(),this.nearbyChest=null,this.interactPrompt=null,this.openingChests=[],this.materials=this._createMaterials(),this._createInteractPrompt(),console.log("[ChestManager] Initialized with region-based chest placement")}_loadOpenedChests(){try{const e=localStorage.getItem("ashen_opened_chests");if(e){const t=JSON.parse(e),i=Date.now(),s={};for(const[n,a]of Object.entries(t))i-a<this.respawnTimeMs&&(s[n]=a);return s}}catch(e){console.warn("[ChestManager] Failed to load opened chests:",e)}return{}}_saveOpenedChests(){try{localStorage.setItem("ashen_opened_chests",JSON.stringify(this.openedChests))}catch(e){console.warn("[ChestManager] Failed to save opened chests:",e)}}_getChestKey(e,t){return`${Math.round(e)},${Math.round(t)}`}_createMaterials(){return{wooden:{body:new X({color:ps.WOODEN.color,emissive:ps.WOODEN.emissive,emissiveIntensity:.2,roughness:.8,metalness:.1}),trim:new X({color:4863264,roughness:.7,metalness:.3})},silver:{body:new X({color:ps.SILVER.color,emissive:ps.SILVER.emissive,emissiveIntensity:.3,roughness:.4,metalness:.7}),trim:new X({color:6710920,roughness:.3,metalness:.8})},gold:{body:new X({color:ps.GOLD.color,emissive:ps.GOLD.emissive,emissiveIntensity:.4,roughness:.3,metalness:.9}),trim:new X({color:13408512,roughness:.2,metalness:.95})}}}_createInteractPrompt(){const e=document.createElement("div");e.id="chest-interact-prompt",e.style.cssText=`
      position: fixed;
      bottom: 25%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-family: 'Segoe UI', sans-serif;
      font-size: 16px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 100;
      border: 1px solid rgba(255, 200, 100, 0.5);
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    `,e.innerHTML='<span style="color:#ffcc66">[E]</span> Open Chest',document.body.appendChild(e),this.interactPrompt=e}_showInteractPrompt(e){if(this.interactPrompt){const t=e.tier.name,i=`#${e.tier.color.toString(16).padStart(6,"0")}`;this.interactPrompt.innerHTML=`<span style="color:#ffcc66">[E]</span> Open <span style="color:${i}">${t}</span>`,this.interactPrompt.style.opacity="1"}}_hideInteractPrompt(){this.interactPrompt&&(this.interactPrompt.style.opacity="0")}_seededRandom(e){const t=Math.sin(e*12.9898+78.233)*43758.5453;return t-Math.floor(t)}_regionKey(e,t){return`${e},${t}`}_worldToRegion(e,t){return{rx:Math.floor(e/this.regionSize),rz:Math.floor(t/this.regionSize)}}update(e,t,i=0){const s=new T(e,0,t),{rx:n,rz:a}=this._worldToRegion(e,t);if(n!==this.lastPlayerRegionX||a!==this.lastPlayerRegionZ){this.lastPlayerRegionX=n,this.lastPlayerRegionZ=a;const o=new Set;for(let c=-this.loadDistance;c<=this.loadDistance;c++)for(let h=-this.loadDistance;h<=this.loadDistance;h++){const d=n+c,u=a+h,p=this._regionKey(d,u);o.add(p),this.regions.has(p)||this._loadRegion(d,u)}const r=[];for(const[c]of this.regions){const[h,d]=c.split(",").map(Number),u=Math.abs(h-n),p=Math.abs(d-a);(u>this.unloadDistance||p>this.unloadDistance)&&r.push(c)}for(const c of r)this._unloadRegion(c)}this._updateAnimations(i),this._updateInteraction(s),this.nearbyChest&&this.inputManager&&this.inputManager.interact&&this._openChest(this.nearbyChest)}_loadRegion(e,t){const i=this._regionKey(e,t);if(this.regions.has(i))return;const s={chests:[],meshes:[]},n=e*73856093+t*19349663;if(this.ruinsManager&&this.ruinsManager.ruins)for(const c of this.ruinsManager.ruins){const h=this._worldToRegion(c.x,c.z);h.rx===e&&h.rz===t&&this._tryPlaceChestNearPOI(c,"ruins",n,s)}if(this.caveManager&&this.caveManager.caves)for(const c of this.caveManager.caves){const h=this._worldToRegion(c.x,c.z);h.rx===e&&h.rz===t&&this._tryPlaceChestNearPOI(c,"caves",n+1e3,s)}const a=e*this.regionSize,o=t*this.regionSize;if(Math.sqrt((a+this.regionSize/2)**2+(o+this.regionSize/2)**2)>tl.HIDDEN.minDistFromCastle&&this._seededRandom(n+5e3)<tl.HIDDEN.chance){const h=a+this._seededRandom(n+5001)*this.regionSize,d=o+this._seededRandom(n+5002)*this.regionSize;if(this.terrain){const u=this.terrain.getTerrainHeight(h,d);if((this.terrain.getTerrainSlope?this.terrain.getTerrainSlope(h,d):0)<.5){const f=this._selectTier(n+5003,tl.HIDDEN.tierBoost);this._createChest(h,u,d,f,n+5004,s)}}}this.regions.set(i,s)}_tryPlaceChestNearPOI(e,t,i,s){const n=tl[t.toUpperCase()];if(!n||this._seededRandom(i+e.x*100+e.z)>n.chance)return;const o=this._seededRandom(i+e.x+e.z*50)*Math.PI*2,r=n.offset.minDist+this._seededRandom(i+e.x*7+e.z*13)*(n.offset.maxDist-n.offset.minDist),c=e.x+Math.cos(o)*r,h=e.z+Math.sin(o)*r,d=this.terrain?this.terrain.getTerrainHeight(c,h):e.y||0,u=this._selectTier(i+e.x*3+e.z*7,n.tierBoost);this._createChest(c,d,h,u,i,s)}_selectTier(e,t=1){const i=this._seededRandom(e)*100,s=ps.WOODEN.spawnWeight,n=ps.SILVER.spawnWeight*t,a=ps.GOLD.spawnWeight*(t*t),o=s+n+a,r=i*(o/100);return r<a?ps.GOLD:r<a+n?ps.SILVER:ps.WOODEN}_createChest(e,t,i,s,n,a){const o=this._getChestKey(e,i);if(this.openedChests[o]){if(Date.now()-this.openedChests[o]<this.respawnTimeMs)return;delete this.openedChests[o],this._saveOpenedChests()}const r=new ne;r.position.set(e,t,i),r.rotation.y=this._seededRandom(n+999)*Math.PI*2;const c=new ie(1.2,.6,.8),h=new w(c,this.materials[s.id].body);h.position.y=.3,h.castShadow=!0,h.receiveShadow=!0,r.add(h);const d=new ne;d.position.set(0,.6,-.4);const u=new ie(1.2,.3,.8),p=new w(u,this.materials[s.id].body);p.position.set(0,.15,.4),p.castShadow=!0,r.add(d),d.add(p);const f=new ie(1.25,.08,.85),y=new w(f,this.materials[s.id].trim);y.position.y=.55,r.add(y);const m=new w(f,this.materials[s.id].trim);m.position.y=.15,r.add(m);const g=new ie(.15,.2,.1),x=new w(g,this.materials[s.id].trim);if(x.position.set(0,.5,.42),r.add(x),s.glowIntensity>.5){const b=new We(s.glowColor,s.glowIntensity,8);b.position.set(0,.8,0),r.add(b)}this.scene.add(r);const v={x:e,y:t,z:i,key:o,tier:s,mesh:r,lidGroup:d,opened:!1,seed:n};this.chests.push(v),a.chests.push(v),a.meshes.push(r),r.userData.chestData=v,this.chestMeshes.push(r)}_unloadRegion(e){const t=this.regions.get(e);if(t){for(const i of t.meshes){this.scene.remove(i);const s=this.chestMeshes.indexOf(i);s>=0&&this.chestMeshes.splice(s,1)}for(const i of t.chests){const s=this.chests.indexOf(i);s>=0&&this.chests.splice(s,1)}this.regions.delete(e)}}_updateInteraction(e){let t=null,i=this.interactionDistance;for(const s of this.chests){if(s.opened)continue;const n=e.x-s.x,a=e.z-s.z,o=Math.sqrt(n*n+a*a);o<i&&(t=s,i=o)}t!==this.nearbyChest&&(this.nearbyChest=t,t?this._showInteractPrompt(t):this._hideInteractPrompt())}_openChest(e){e.opened||(e.opened=!0,this._hideInteractPrompt(),this.nearbyChest=null,this.openedChests[e.key]=Date.now(),this._saveOpenedChests(),this.openingChests.push({chest:e,progress:0,targetAngle:-Math.PI*.7}),this._generateLoot(e),this.lootManager&&this.lootManager.gameManager&&this.lootManager.gameManager.audioManager&&this.lootManager.gameManager.audioManager.playSound("chestOpen",{position:new T(e.x,e.y,e.z)}))}_generateLoot(e){const t=e.tier,i=e.seed,s=new T(e.x,e.y+1,e.z),n=t.goldRange[0]+Math.floor(this._seededRandom(i+100)*(t.goldRange[1]-t.goldRange[0]));if(this.lootManager&&this.lootManager.spawnLootDrop({itemId:"gold",quantity:n},s.clone().add(new T((Math.random()-.5)*1.5,0,(Math.random()-.5)*1.5))),this._seededRandom(i+200)<t.potionChance){const a=this._seededRandom(i+201)<.5?"health-potion":"stamina-potion",o=Math.ceil(this._seededRandom(i+202)*2);this.lootManager&&this.lootManager.spawnLootDrop({itemId:a,quantity:o},s.clone().add(new T((Math.random()-.5)*1.5,0,(Math.random()-.5)*1.5)))}if(this._seededRandom(i+300)<t.materialChance){const a=["iron-ore","dark-shard","bone-fragment","spirit-essence"],o=Math.floor(this._seededRandom(i+301)*a.length),r=t.materialRange[0]+Math.floor(this._seededRandom(i+302)*(t.materialRange[1]-t.materialRange[0]));this.lootManager&&this.lootManager.spawnLootDrop({itemId:a[o],quantity:r},s.clone().add(new T((Math.random()-.5)*1.5,0,(Math.random()-.5)*1.5)))}if(this._seededRandom(i+400)<t.equipmentChance&&this.equipmentManager){const a=t.equipmentRarityWeights,o=this._seededRandom(i+401)*100;let r=qe.COMMON,c=0;o<(c+=a.epic)?r=qe.EPIC:o<(c+=a.rare)?r=qe.RARE:o<(c+=a.uncommon)&&(r=qe.UNCOMMON);const h=this.equipmentManager.generateChestEquipment(r);h&&this.equipmentManager.spawnEquipmentDrop(h,s.clone().add(new T((Math.random()-.5)*1.5,.5,(Math.random()-.5)*1.5)))}if(t.recipeScrollChance&&this._seededRandom(i+500)<t.recipeScrollChance){const a=this._rollRecipeScroll(i+501);if(a&&this.lootManager?.gameManager?.craftingManager)if(this.lootManager.gameManager.craftingManager.handleRecipeScroll(a.id))this.lootManager.showNotification(`Recipe Discovered: ${a.name}`,"gold");else{const r=Math.floor(50+this._seededRandom(i+502)*50);this.lootManager&&this.lootManager.spawnLootDrop({itemId:"gold",quantity:r},s.clone())}}this.lootManager&&this.lootManager.showNotification&&this.lootManager.showNotification(`Opened ${t.name}!`,t.id)}_rollRecipeScroll(e){const t=Object.values(fr).filter(s=>s.unlockMethod===Mt.FOUND_IN_CHEST);if(t.length===0)return null;const i=Math.floor(this._seededRandom(e)*t.length);return t[i]}_updateAnimations(e){const t=[];for(const i of this.openingChests){i.progress+=e*2,i.progress>=1&&(i.progress=1,t.push(i));const s=1-Math.pow(1-i.progress,3);i.chest.lidGroup.rotation.x=i.targetAngle*s}for(const i of t){const s=this.openingChests.indexOf(i);s>=0&&this.openingChests.splice(s,1)}}getChests(){return this.chests}getNearbyChest(e,t=5){for(const i of this.chests){if(i.opened)continue;const s=e.x-i.x,n=e.z-i.z;if(Math.sqrt(s*s+n*n)<t)return i}return null}respawnAll(){this.openedChests={},this._saveOpenedChests();const e=[...this.regions.keys()];for(const t of e)this._unloadRegion(t);this.lastPlayerRegionX=null,this.lastPlayerRegionZ=null}dispose(){for(const[e]of this.regions)this._unloadRegion(e);this.interactPrompt&&this.interactPrompt.parentNode&&this.interactPrompt.parentNode.removeChild(this.interactPrompt)}}const Z1="modulepreload",J1=function(l){return"/project-ashen/"+l},tf={},sf=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){let c=function(h){return Promise.all(h.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};var a=c;document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),r=o?.nonce||o?.getAttribute("nonce");s=c(t.map(h=>{if(h=J1(h),h in tf)return;tf[h]=!0;const d=h.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${u}`))return;const p=document.createElement("link");if(p.rel=d?"stylesheet":Z1,d||(p.as="script"),p.crossOrigin="",p.href=h,r&&p.setAttribute("nonce",r),document.head.appendChild(p),d)return new Promise((f,y)=>{p.addEventListener("load",f),p.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${h}`)))})}))}function n(o){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=o,window.dispatchEvent(r),!r.defaultPrevented)throw o}return s.then(o=>{for(const r of o||[])r.status==="rejected"&&n(r.reason);return e().catch(n)})};class eS{constructor(e){this.gm=e,this.healthBar=document.getElementById("health-bar"),this.staminaBar=document.getElementById("stamina-bar"),this.postureBar=document.getElementById("posture-bar"),this.bossContainer=document.getElementById("boss-container"),this.bossName=document.getElementById("boss-name"),this.bossHealthBar=document.getElementById("boss-health-bar"),this.bossPostureBar=document.getElementById("boss-posture-bar"),this.bossPhase=document.getElementById("boss-phase"),this.enemyManager=null,this.statsUI=null,this._createDamageVignette(),this.damageVignetteOpacity=0,this.staminaWarningActive=!1,this._createLevelBadge(),this._createXPBar(),this._createStatPointsIndicator(),this._createAbilityBar(),this._createManaBar(),this._createRemnantLabels(),this._createSpellHotbar(),this.levelUpFlashActive=!1,this._lastLevel=this.gm.currentLevel||1,this.manaManager=null,this.spellManager=null,this.manaWarningActive=!1}setStatsUI(e){this.statsUI=e}_createLevelBadge(){this.levelBadge=document.createElement("div"),this.levelBadge.id="level-badge",this.levelBadge.style.cssText=`
      position: fixed;
      top: 20px;
      left: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 100;
      pointer-events: none;
    `;const e=document.createElement("div");e.style.cssText=`
      font-size: 16px;
      filter: drop-shadow(0 0 4px rgba(255, 200, 0, 0.5));
    `,e.textContent="",this.levelBadge.appendChild(e),this.levelBadgeText=document.createElement("div"),this.levelBadgeText.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 16px;
      font-weight: bold;
      color: #ffd088;
      text-shadow: 0 0 6px rgba(0, 0, 0, 0.9), 0 0 12px rgba(255, 180, 0, 0.4);
      letter-spacing: 1px;
    `,this.levelBadgeText.textContent="LV 1",this.levelBadge.appendChild(this.levelBadgeText),document.body.appendChild(this.levelBadge)}_createXPBar(){this.xpContainer=document.createElement("div"),this.xpContainer.id="xp-container",this.xpContainer.style.cssText=`
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      z-index: 100;
      pointer-events: none;
    `,this.levelLabel=document.createElement("div"),this.levelLabel.id="level-label",this.levelLabel.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 14px;
      color: #ffdd88;
      text-shadow: 0 0 4px rgba(0,0,0,0.8), 0 0 8px rgba(255,200,0,0.3);
      letter-spacing: 2px;
    `,this.levelLabel.textContent="LEVEL 1",this.xpContainer.appendChild(this.levelLabel),this.xpBarBg=document.createElement("div"),this.xpBarBg.style.cssText=`
      width: 100%;
      height: 6px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 200, 100, 0.3);
      border-radius: 3px;
      overflow: hidden;
    `,this.xpBar=document.createElement("div"),this.xpBar.id="xp-bar",this.xpBar.style.cssText=`
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #aa8800, #ffcc44);
      box-shadow: 0 0 6px rgba(255, 200, 0, 0.5);
      transition: width 0.3s ease-out;
    `,this.xpBarBg.appendChild(this.xpBar),this.xpContainer.appendChild(this.xpBarBg),document.body.appendChild(this.xpContainer)}_createStatPointsIndicator(){this.statPointsIndicator=document.createElement("div"),this.statPointsIndicator.id="stat-points-indicator",this.statPointsIndicator.style.cssText=`
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Cinzel', serif;
      font-size: 13px;
      color: #ffd088;
      text-shadow: 0 0 8px rgba(255, 180, 80, 0.6), 0 0 2px rgba(0, 0, 0, 0.8);
      letter-spacing: 1px;
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease-out;
      animation: statPointsPulse 2s ease-in-out infinite;
    `;const e=document.createElement("style");e.textContent=`
      @keyframes statPointsPulse {
        0%, 100% { opacity: 0.8; }
        50% { opacity: 1; text-shadow: 0 0 12px rgba(255, 200, 100, 0.9), 0 0 2px rgba(0, 0, 0, 0.8); }
      }
      @keyframes xpBarPulse {
        0%, 100% { box-shadow: 0 0 12px rgba(255, 255, 100, 0.8); }
        50% { box-shadow: 0 0 20px rgba(255, 255, 150, 1), 0 0 30px rgba(255, 200, 50, 0.6); }
      }
    `,document.head.appendChild(e),document.body.appendChild(this.statPointsIndicator)}_createAbilityBar(){this.abilityContainer=document.createElement("div"),this.abilityContainer.id="ability-container",this.abilityContainer.style.cssText=`
      position: fixed;
      bottom: 60px;
      right: 20px;
      display: flex;
      flex-direction: row;
      gap: 8px;
      z-index: 100;
      pointer-events: none;
    `,this.abilitySlots={};const e=[{id:"dash",hotkey:"R",icon:"",color:"#00ff88"},{id:"heavyCharge",hotkey:"",icon:"",color:"#ffaa00"},{id:"parry",hotkey:"F",icon:"",color:"#4488ff"},{id:"warCry",hotkey:"G",icon:"",color:"#ff6600"}];for(const t of e){const i=document.createElement("div");i.className="ability-slot",i.dataset.abilityId=t.id,i.style.cssText=`
        width: 48px;
        height: 48px;
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid rgba(100, 100, 100, 0.5);
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        opacity: 0.3;
        transition: opacity 0.3s, border-color 0.3s;
      `;const s=document.createElement("div");s.className="ability-icon",s.textContent=t.icon,s.style.cssText=`
        font-size: 20px;
        line-height: 1;
      `,i.appendChild(s);const n=document.createElement("div");n.className="ability-hotkey",n.textContent=t.hotkey,n.style.cssText=`
        font-family: 'Cinzel', serif;
        font-size: 10px;
        color: #aaa;
        margin-top: 2px;
      `,i.appendChild(n);const a=document.createElement("div");a.className="cooldown-overlay",a.style.cssText=`
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 0%;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 4px;
        pointer-events: none;
      `,i.appendChild(a);const o=document.createElement("div");o.className="cooldown-text",o.style.cssText=`
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'Cinzel', serif;
        font-size: 14px;
        font-weight: bold;
        color: #fff;
        text-shadow: 0 0 4px rgba(0,0,0,0.8);
        display: none;
      `,i.appendChild(o),this.abilitySlots[t.id]={element:i,cooldownOverlay:a,cooldownText:o,color:t.color},this.abilityContainer.appendChild(i)}document.body.appendChild(this.abilityContainer)}_createManaBar(){this.manaContainer=document.createElement("div"),this.manaContainer.id="mana-container",this.manaContainer.style.cssText=`
      position: fixed;
      top: 84px;
      left: 20px;
      width: 200px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      z-index: 100;
      pointer-events: none;
    `;const e=document.createElement("div");e.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 10px;
      color: #6699ff;
      text-shadow: 0 0 4px rgba(0,0,0,0.8);
      letter-spacing: 1px;
    `,e.textContent="MANA",this.manaContainer.appendChild(e),this.manaBarBg=document.createElement("div"),this.manaBarBg.style.cssText=`
      width: 100%;
      height: 10px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(100, 150, 255, 0.3);
      border-radius: 3px;
      overflow: hidden;
    `,this.manaBar=document.createElement("div"),this.manaBar.id="mana-bar",this.manaBar.style.cssText=`
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, #3366cc, #6699ff);
      box-shadow: 0 0 6px rgba(100, 150, 255, 0.5);
      transition: width 0.15s ease-out;
    `,this.manaBarBg.appendChild(this.manaBar),this.manaContainer.appendChild(this.manaBarBg),this.manaText=document.createElement("div"),this.manaText.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 9px;
      color: #88aaff;
      text-shadow: 0 0 4px rgba(0,0,0,0.8);
      text-align: right;
    `,this.manaText.textContent="100 / 100",this.manaContainer.appendChild(this.manaText),document.body.appendChild(this.manaContainer)}_createRemnantLabels(){this.remnantContainer=document.createElement("div"),this.remnantContainer.style.cssText=`
      position: fixed;
      top: 122px;
      left: 20px;
      z-index: 100;
      pointer-events: none;
    `,this.remnantLabel=document.createElement("div"),this.remnantLabel.id="remnant",this.remnantLabel.style.cssText=`
      font-family: 'Courier New', monospace;
      font-size: 14px;
      color: #d4af37;
      text-shadow: 0 0 8px rgba(212,175,55,0.4);
    `,this.remnantLabel.textContent="Remnant: 0",this.remnantContainer.appendChild(this.remnantLabel),this.lostRemnantLabel=document.createElement("div"),this.lostRemnantLabel.id="lost-remnant",this.lostRemnantLabel.style.cssText=`
      display: none;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #aa3333;
      margin-top: 4px;
    `,this.remnantContainer.appendChild(this.lostRemnantLabel),document.body.appendChild(this.remnantContainer)}_createSpellHotbar(){this.spellHotbarContainer=document.createElement("div"),this.spellHotbarContainer.id="spell-hotbar",this.spellHotbarContainer.style.cssText=`
      position: fixed;
      bottom: 55px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: row;
      gap: 6px;
      z-index: 100;
      pointer-events: none;
    `,this.spellSlots=[];for(let t=0;t<6;t++){const i=document.createElement("div");i.className="spell-slot",i.dataset.slotIndex=t,i.style.cssText=`
        width: 44px;
        height: 44px;
        background: rgba(0, 0, 20, 0.75);
        border: 2px solid rgba(100, 120, 180, 0.5);
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        transition: border-color 0.2s, box-shadow 0.2s;
      `;const s=document.createElement("div");s.className="spell-icon",s.style.cssText=`
        font-size: 20px;
        line-height: 1;
        color: #aaccff;
      `,s.textContent="",i.appendChild(s);const n=document.createElement("div");n.className="spell-hotkey",n.textContent=`F${t+1}`,n.style.cssText=`
        position: absolute;
        bottom: 2px;
        right: 3px;
        font-family: 'Cinzel', serif;
        font-size: 8px;
        color: #888;
      `,i.appendChild(n);const a=document.createElement("div");a.className="spell-cooldown-overlay",a.style.cssText=`
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 0%;
        background: rgba(0, 0, 0, 0.75);
        border-radius: 4px;
        pointer-events: none;
        transition: height 0.1s linear;
      `,i.appendChild(a);const o=document.createElement("div");o.className="spell-cooldown-text",o.style.cssText=`
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-family: 'Cinzel', serif;
        font-size: 12px;
        font-weight: bold;
        color: #fff;
        text-shadow: 0 0 4px rgba(0,0,0,0.9);
        display: none;
      `,i.appendChild(o);const r=document.createElement("div");r.className="spell-mana-cost",r.style.cssText=`
        position: absolute;
        top: 2px;
        left: 3px;
        font-family: 'Cinzel', serif;
        font-size: 8px;
        color: #6699ff;
        text-shadow: 0 0 2px rgba(0,0,0,0.8);
      `,i.appendChild(r);const c=document.createElement("div");c.className="spell-selected",c.style.cssText=`
        position: absolute;
        top: -3px;
        left: -3px;
        right: -3px;
        bottom: -3px;
        border: 2px solid #ffcc44;
        border-radius: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.15s;
      `,i.appendChild(c),this.spellSlots.push({element:i,icon:s,hotkey:n,cooldownOverlay:a,cooldownText:o,manaCost:r,selectedIndicator:c,spellId:null}),this.spellHotbarContainer.appendChild(i)}document.body.appendChild(this.spellHotbarContainer);const e=document.createElement("style");e.textContent=`
      @keyframes spellCastGlow {
        0% { box-shadow: 0 0 10px rgba(100, 150, 255, 0.8); }
        100% { box-shadow: none; }
      }
      @keyframes manaWarningFlash {
        0%, 100% { background: linear-gradient(90deg, #3366cc, #6699ff); }
        50% { background: linear-gradient(90deg, #cc3366, #ff6699); }
      }
    `,document.head.appendChild(e)}setManaManager(e){this.manaManager=e,e&&(e.setOnManaChanged((t,i)=>{this._updateManaBar(t,i)}),e.setOnManaInsufficient(()=>{this.flashManaInsufficient()}))}setSpellManager(e){this.spellManager=e,e&&(e.onHotbarChanged=t=>{this._updateSpellHotbarSlots(t)},e.onCooldownUpdate=(t,i,s)=>{this._updateSpellSlotCooldown(t,i,s)},this._updateSpellHotbarSlots(e.hotbarSlots))}_updateManaBar(e,t){if(!this.manaBar)return;const i=e/t*100;this.manaBar.style.width=`${i}%`,this.manaText&&(this.manaText.textContent=`${Math.floor(e)} / ${Math.floor(t)}`),i<20?this.manaBar.style.background="linear-gradient(90deg, #6633cc, #9966ff)":this.manaBar.style.background="linear-gradient(90deg, #3366cc, #6699ff)"}flashManaInsufficient(){this.manaWarningActive||(this.manaWarningActive=!0,this.manaBar&&(this.manaBar.style.animation="manaWarningFlash 0.3s ease-in-out 2",setTimeout(()=>{this.manaBar.style.animation="",this.manaWarningActive=!1},600)))}_updateSpellHotbarSlots(e){!this.spellSlots||!this.spellManager||sf(()=>Promise.resolve().then(()=>nf),void 0).then(t=>{const i=t.default;for(let s=0;s<this.spellSlots.length;s++){const n=this.spellSlots[s],a=e[s];if(n.spellId=a,a&&i[a]){const o=i[a];n.icon.textContent=this._getSpellIcon(o),n.icon.style.color=this._getSpellColor(o),n.manaCost.textContent=o.manaCost,n.element.style.opacity="1",n.element.title=`${o.name} (${o.manaCost} mana)`}else n.icon.textContent="",n.manaCost.textContent="",n.element.style.opacity="0.5",n.element.title="Empty slot"}}).catch(()=>{console.warn("[HUD] Could not load SpellData for hotbar")})}_getSpellIcon(e){switch(e.id){case"fireball":return"";case"iceShard":return"";case"lightningBolt":return"";case"arcaneMissile":return"";case"darkOrb":return"";case"spark":return"";case"minorHeal":return"";case"heal":return"";case"regeneration":return"";case"lifeSteal":return"";case"magicShield":return"";case"ward":return"";case"barrier":return"";case"haste":return"";case"strengthBoost":return"";case"magicPower":return"";case"ironSkin":return"";case"frostNova":return"";case"chainLightning":return"";default:switch(e.category){case"offensive":return"";case"healing":return"";case"defensive":return"";case"buff":return"";default:return""}}}_getSpellColor(e){switch(e.damageType){case"fire":return"#ff6600";case"ice":return"#66ccff";case"lightning":return"#ffff66";case"arcane":return"#aa66ff";case"dark":return"#884488";default:return e.category==="healing"?"#66ff88":e.category==="defensive"?"#66aaff":e.category==="buff"?"#ffcc44":"#aaccff"}}_updateSpellSlotCooldown(e,t,i){if(!this.spellSlots||e<0||e>=this.spellSlots.length)return;const s=this.spellSlots[e];if(t>0&&i>0){const n=t/i*100;s.cooldownOverlay.style.height=`${n}%`,s.cooldownText.textContent=t.toFixed(1),s.cooldownText.style.display="block",s.element.style.borderColor="rgba(60, 60, 80, 0.5)"}else s.cooldownOverlay.style.height="0%",s.cooldownText.style.display="none",s.element.style.borderColor="rgba(100, 120, 180, 0.5)"}updateSpellHotbarSelection(e){if(this.spellSlots)for(let t=0;t<this.spellSlots.length;t++){const i=this.spellSlots[t];i.selectedIndicator.style.opacity=t===e?"1":"0"}}flashSpellCast(e){if(!this.spellSlots||e<0||e>=this.spellSlots.length)return;const t=this.spellSlots[e];t.element.style.animation="spellCastGlow 0.3s ease-out",setTimeout(()=>{t.element.style.animation=""},300)}_updateAbilityBar(){if(!(!this.abilitySlots||!this.gm.abilities)){for(const[e,t]of Object.entries(this.abilitySlots)){const i=this.gm.isAbilityUnlocked(e),s=this.gm.getAbilityCooldown(e),n=this.gm.abilities[e];if(i)if(t.element.style.opacity="1",t.element.style.borderColor=s>0?"rgba(100,100,100,0.5)":t.color,s>0){const a=s/(n.baseCooldown*this.gm.getCooldownModifier())*100;t.cooldownOverlay.style.height=`${a}%`,t.cooldownText.textContent=Math.ceil(s),t.cooldownText.style.display="block"}else t.cooldownOverlay.style.height="0%",t.cooldownText.style.display="none";else t.element.style.opacity="0.3",t.cooldownOverlay.style.height="0%",t.cooldownText.style.display="none"}if(this.gm.warCryActive&&this.abilitySlots.warCry){const e=this.abilitySlots.warCry;e.element.style.boxShadow="0 0 10px #ff6600, 0 0 20px #ff440088"}else this.abilitySlots.warCry&&(this.abilitySlots.warCry.element.style.boxShadow="none")}}flashLevelUp(){this.levelUpFlashActive||(this.levelUpFlashActive=!0,this.levelLabel.style.color="#ffffff",this.levelLabel.style.textShadow="0 0 20px rgba(255,220,0,1), 0 0 40px rgba(255,200,0,0.8)",this.levelLabel.style.fontSize="18px",this.levelLabel.style.transition="all 0.2s ease-out",this.levelBadgeText&&(this.levelBadgeText.style.color="#ffffff",this.levelBadgeText.style.textShadow="0 0 20px rgba(255,220,0,1), 0 0 30px rgba(255,200,0,0.8)",this.levelBadgeText.style.fontSize="22px",this.levelBadgeText.style.transition="all 0.3s ease-out"),this.xpBar.style.background="linear-gradient(90deg, #ffff88, #ffffff)",this.xpBar.style.boxShadow="0 0 20px rgba(255, 255, 200, 1)",this.levelUpFlash||(this.levelUpFlash=document.createElement("div"),this.levelUpFlash.style.cssText=`
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(ellipse at center, rgba(255, 220, 100, 0.4) 0%, transparent 70%);
        pointer-events: none;
        z-index: 997;
        opacity: 0;
        transition: opacity 0.1s ease-out;
      `,document.body.appendChild(this.levelUpFlash)),this.levelUpFlash.style.opacity="1",setTimeout(()=>{this.levelUpFlash.style.opacity="0"},200),setTimeout(()=>{this.levelLabel.style.color="#ffdd88",this.levelLabel.style.textShadow="0 0 4px rgba(0,0,0,0.8), 0 0 8px rgba(255,200,0,0.3)",this.levelLabel.style.fontSize="14px",this.xpBar.style.background="linear-gradient(90deg, #aa8800, #ffcc44)",this.xpBar.style.boxShadow="0 0 6px rgba(255, 200, 0, 0.5)",this.levelBadgeText&&(this.levelBadgeText.style.color="#ffd088",this.levelBadgeText.style.textShadow="0 0 6px rgba(0, 0, 0, 0.9), 0 0 12px rgba(255, 180, 0, 0.4)",this.levelBadgeText.style.fontSize="16px"),this.levelUpFlashActive=!1,this.statsUI&&this.gm.getAvailableStatPoints()>0&&setTimeout(()=>{this.statsUI.open()},300)},800))}_createDamageVignette(){this.damageVignette=document.createElement("div"),this.damageVignette.id="damage-vignette",this.damageVignette.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
      background: radial-gradient(ellipse at center, transparent 40%, rgba(180, 30, 30, 0.6) 100%);
      opacity: 0;
      transition: opacity 0.05s ease-out;
    `,document.body.appendChild(this.damageVignette),this.hitFlash=document.createElement("div"),this.hitFlash.id="hit-flash",this.hitFlash.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 998;
      background: rgba(255, 100, 100, 0.3);
      opacity: 0;
      transition: opacity 0.08s ease-out;
    `,document.body.appendChild(this.hitFlash)}flashDamage(e=.6){this.damageVignetteOpacity=Math.min(1,e),this.damageVignette.style.opacity=this.damageVignetteOpacity,this.hitFlash.style.opacity=Math.min(.5,e*.8),setTimeout(()=>{this.damageVignette.style.opacity=this.damageVignetteOpacity*.5,this.hitFlash.style.opacity=0},80),setTimeout(()=>{this.damageVignette.style.opacity=0},250)}flashStaminaDepleted(){this.staminaWarningActive||(this.staminaWarningActive=!0,this.staminaBar&&(this.staminaBar.style.background="linear-gradient(90deg, #ffaa00, #ff6600)",this.staminaBar.style.boxShadow="0 0 10px #ff6600",setTimeout(()=>{this.staminaBar.style.background="",this.staminaBar.style.boxShadow="",this.staminaWarningActive=!1},300)))}setEnemyManager(e){this.enemyManager=e}update(){this.healthBar&&(this.healthBar.style.width=`${this.gm.health/this.gm.maxHealth*100}%`),this.staminaBar&&(this.staminaBar.style.width=`${this.gm.stamina/this.gm.maxStamina*100}%`),this.postureBar&&(this.postureBar.style.width=`${this.gm.posture/this.gm.maxPosture*100}%`),this.remnantLabel&&(this.remnantLabel.textContent=`Remnant: ${this.gm.remnant}`),this.lostRemnantLabel&&(this.gm.bloodstain&&this.gm.heldRemnant>0?(this.lostRemnantLabel.style.display="block",this.lostRemnantLabel.textContent=`Lost: ${this.gm.heldRemnant} (recover at bloodstain)`):this.lostRemnantLabel.style.display="none"),this._updateXPBar(),this._updateAbilityBar(),this._updateStatPointsIndicator(),this.manaManager&&this._updateManaBar(this.manaManager.currentMana,this.manaManager.maxMana),this._updateSpellCooldowns(),this._updateBossUI()}_updateSpellCooldowns(){!this.spellSlots||!this.spellManager||(sf(()=>Promise.resolve().then(()=>nf),void 0).then(e=>{const t=e.default;for(let i=0;i<this.spellSlots.length;i++){const s=this.spellSlots[i],n=s.spellId;if(n&&t[n]){const a=this.spellManager.getCooldownRemaining(n),r=t[n].cooldown||0;if(a>0&&r>0){const c=a/r*100;s.cooldownOverlay.style.height=`${c}%`,s.cooldownText.textContent=a.toFixed(1),s.cooldownText.style.display="block",s.element.style.borderColor="rgba(60, 60, 80, 0.5)"}else s.cooldownOverlay.style.height="0%",s.cooldownText.style.display="none",s.element.style.borderColor="rgba(100, 120, 180, 0.5)"}}}).catch(()=>{}),this.spellManager.activeSlot!==void 0&&this.updateSpellHotbarSelection(this.spellManager.activeSlot))}_updateStatPointsIndicator(){if(!this.statPointsIndicator)return;const e=this.gm.getAvailableStatPoints?this.gm.getAvailableStatPoints():0;e>0?(this.statPointsIndicator.textContent=` ${e} Stat Point${e>1?"s":""} - Press TAB`,this.statPointsIndicator.style.opacity="1"):this.statPointsIndicator.style.opacity="0"}_updateXPBar(){const e=this.gm.currentLevel||1,t=this.gm.maxLevel||20;if(this.levelLabel&&(e>=t?this.levelLabel.textContent=`LEVEL ${e} (MAX)`:this.levelLabel.textContent=`LEVEL ${e}`),this.levelBadgeText&&(e>=t?(this.levelBadgeText.textContent=`LV ${e} `,this.levelBadgeText.style.color="#ffcc00"):this.levelBadgeText.textContent=`LV ${e}`),this.xpBar){const i=this.gm.getXPProgress?this.gm.getXPProgress():0;this.xpBar.style.width=`${i*100}%`,i>.8?(this.xpBar.style.boxShadow="0 0 12px rgba(255, 255, 100, 0.8)",this._xpBarPulsing||(this._xpBarPulsing=!0,this.xpBar.style.animation="xpBarPulse 1.5s ease-in-out infinite")):(this.xpBar.style.boxShadow="0 0 6px rgba(255, 200, 0, 0.5)",this._xpBarPulsing=!1,this.xpBar.style.animation="none")}}_updateBossUI(){if(!this.enemyManager||!this.bossContainer)return;const e=this.enemyManager.getCryptLord(),t=this.enemyManager.getBoss();let i=null,s=!1;if(e&&e.bossActive&&!e.isDead?(i=e,s=!0):t&&t.isActive&&!t.isDead&&(i=t),!i){this.bossContainer.style.display="none";return}if(this.bossContainer.style.display="block",this.bossName&&(this.bossName.textContent=s?i.config.name:i.name),this.bossHealthBar){const n=i.health/i.maxHealth*100;this.bossHealthBar.style.width=`${n}%`,s?(i.bossPhase||1)===2?this.bossHealthBar.style.background="linear-gradient(90deg, #8844cc, #aa66ff)":this.bossHealthBar.style.background="linear-gradient(90deg, #882222, #cc4444)":i.phase===2?this.bossHealthBar.style.background="linear-gradient(90deg, #ff4400, #ff6622)":this.bossHealthBar.style.background="linear-gradient(90deg, #cc2222, #ff4444)",n<=50&&n>0?this.bossHealthBar.classList.add("phase-two"):this.bossHealthBar.classList.remove("phase-two")}if(this.bossPostureBar){const n=i.posture/i.maxPosture*100;this.bossPostureBar.style.width=`${n}%`}if(this.bossPhase){const n=s?i.bossPhase||1:i.phase;this.bossPhase.textContent=n===2?"PHASE 2":"",this.bossPhase.style.color=n===2?s?"#aa66ff":"#ff4400":"#ffcc00"}}}class tS{constructor(e,t,i){this.gm=e,this.input=t,this.player=i,this.isOpen=!1,this.selectedTrack=0,this.tracks=["strength","vitality","stamina","spirit"],this._createUI(),window.addEventListener("keydown",s=>this._handleKey(s))}_createUI(){if(this.container=document.getElementById("crucible-container"),!this.container){console.warn("CrucibleUI: #crucible-container not found in HTML");return}this.promptEl=document.getElementById("crucible-prompt"),this.menuEl=document.getElementById("crucible-menu"),this.trackEls=this.tracks.map(e=>document.getElementById(`track-${e}`)),this.remnantEl=document.getElementById("crucible-remnant")}update(){if(!this.container)return;const e=this.gm.isNearBonfire(),t=this.gm.isDead;this.isOpen?(!e||t||this.input.keys.Escape)&&this._close():e&&!t?(this._showPrompt(!0),this.input.interact&&this._open()):this._showPrompt(!1),this.isOpen&&this._updateMenu()}_showPrompt(e){this.promptEl&&(this.promptEl.style.display=e?"block":"none")}_open(){this.isOpen=!0,this._showPrompt(!1),this.menuEl&&(this.menuEl.style.display="block"),document.pointerLockElement&&document.exitPointerLock()}_close(){this.isOpen=!1,this.menuEl&&(this.menuEl.style.display="none")}_handleKey(e){if(this.isOpen)switch(e.code){case"ArrowUp":case"KeyW":e.preventDefault(),this.selectedTrack=(this.selectedTrack-1+this.tracks.length)%this.tracks.length;break;case"ArrowDown":case"KeyS":e.preventDefault(),this.selectedTrack=(this.selectedTrack+1)%this.tracks.length;break;case"Enter":case"KeyF":e.preventDefault(),this._purchaseSelected();break;case"Escape":case"KeyE":e.preventDefault(),this._close();break}}_purchaseSelected(){const e=this.tracks[this.selectedTrack],t=this.gm.getTrackInfo(e);t.maxed||!t.canAfford||this.gm.infuse(e)&&(this.gm.applyInfusionBonuses(),this._applyVisualEffect(e))}_applyVisualEffect(e){if(!this.player||!this.player.mesh)return;const t=this.gm.infusions[e]||0,s=1+(this.gm.getTotalDepth()||0)*.01;switch(isFinite(s)&&s>0&&this.player.mesh.scale.setScalar(s),e){case"strength":this._addGlow(this.player.body,16729156,t*.1);break;case"vitality":this._addGlow(this.player.body,4521796,t*.1);break;case"stamina":this._addGlow(this.player.body,16777028,t*.1);break;case"spirit":this._addGlow(this.player.visor,4491519,t*.3);break}}_addGlow(e,t,i){if(!e||!e.material||!e.material.emissive)return;const s=e.material.emissive.getHex(),n=this._blendColors(s,t,.5);e.material.emissive.setHex(n),e.material.emissiveIntensity=Math.min(2,(e.material.emissiveIntensity||0)+i)}_blendColors(e,t,i){const s=e>>16&255,n=e>>8&255,a=e&255,o=t>>16&255,r=t>>8&255,c=t&255,h=Math.round(s+(o-s)*i),d=Math.round(n+(r-n)*i),u=Math.round(a+(c-a)*i);return h<<16|d<<8|u}_updateMenu(){this.remnantEl&&(this.remnantEl.textContent=`Remnant: ${this.gm.remnant}`),this.tracks.forEach((e,t)=>{const i=this.trackEls[t];if(!i)return;const s=this.gm.getTrackInfo(e),n=t===this.selectedTrack;i.classList.toggle("selected",n),i.classList.toggle("maxed",s.maxed),i.classList.toggle("affordable",s.canAfford&&!s.maxed);const a=i.querySelector(".track-name"),o=i.querySelector(".track-level"),r=i.querySelector(".track-cost"),c=i.querySelector(".track-bonus");a&&(a.textContent=s.name),o&&(o.textContent=`Lv. ${s.level}/${this.gm.MAX_TRACK_DEPTH}`),r&&(r.textContent=s.maxed?"MAX":`Cost: ${s.cost}`),c&&(c.textContent=s.bonus)})}}class iS{constructor(e,t,i){this.gm=e,this.input=t,this.player=i,this.isOpen=!1,this._createUI(),this._setupInput()}_setupInput(){window.addEventListener("keydown",e=>{(e.code==="Tab"||e.code==="KeyP")&&(e.preventDefault(),this.toggle()),e.code==="Escape"&&this.isOpen&&this.close()})}_createUI(){this.container=document.createElement("div"),this.container.id="stats-ui",this.container.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      font-family: 'Cinzel', serif;
    `,this.panel=document.createElement("div"),this.panel.style.cssText=`
      background: linear-gradient(135deg, rgba(30, 25, 20, 0.95), rgba(20, 15, 10, 0.98));
      border: 2px solid rgba(180, 140, 80, 0.5);
      border-radius: 8px;
      padding: 32px 48px;
      min-width: 450px;
      max-width: 550px;
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.8), 0 0 80px rgba(180, 140, 80, 0.2) inset;
    `;const e=document.createElement("h2");e.textContent="CHARACTER STATS",e.style.cssText=`
      text-align: center;
      color: #ffd088;
      font-size: 24px;
      margin: 0 0 8px 0;
      text-shadow: 0 0 10px rgba(255, 180, 80, 0.5);
      letter-spacing: 4px;
    `,this.panel.appendChild(e),this.levelInfo=document.createElement("div"),this.levelInfo.style.cssText=`
      text-align: center;
      color: #aaa;
      font-size: 14px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(180, 140, 80, 0.3);
    `,this.panel.appendChild(this.levelInfo),this.pointsDisplay=document.createElement("div"),this.pointsDisplay.style.cssText=`
      text-align: center;
      margin-bottom: 24px;
    `,this.panel.appendChild(this.pointsDisplay),this.statsGrid=document.createElement("div"),this.statsGrid.style.cssText=`
      display: flex;
      flex-direction: column;
      gap: 12px;
    `,this.panel.appendChild(this.statsGrid),this.statDefs=[{id:"vigor",name:"Vigor",icon:"",color:"#ff6666",desc:"+5 Max HP per point",getBonus:s=>`+${s*5} HP`},{id:"endurance",name:"Endurance",icon:"",color:"#66ff88",desc:"+5 Max Stamina, +5% regen per point",getBonus:s=>`+${s*5} Stam, +${s*5}% regen`},{id:"strength",name:"Strength",icon:"",color:"#ff8844",desc:"+5% melee damage per point",getBonus:s=>`+${s*5}% dmg`},{id:"dexterity",name:"Dexterity",icon:"",color:"#88ccff",desc:"+3% attack speed per point",getBonus:s=>`+${s*3}% speed`},{id:"mind",name:"Mind",icon:"",color:"#cc88ff",desc:"+5% cooldown reduction per point",getBonus:s=>`-${s*5}% cooldowns`},{id:"intelligence",name:"Intelligence",icon:"",color:"#4488ff",desc:"+10 Max Mana, +5% mana regen per point",getBonus:s=>`+${s*10} Mana`}],this.statRows={};for(const s of this.statDefs){const n=this._createStatRow(s);this.statsGrid.appendChild(n),this.statRows[s.id]=n}const t=document.createElement("div");t.textContent="DERIVED STATS",t.style.cssText=`
      color: #888;
      font-size: 12px;
      letter-spacing: 2px;
      margin-top: 24px;
      margin-bottom: 12px;
      padding-top: 16px;
      border-top: 1px solid rgba(180, 140, 80, 0.3);
    `,this.panel.appendChild(t),this.derivedStats=document.createElement("div"),this.derivedStats.style.cssText=`
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 13px;
      color: #aaa;
    `,this.panel.appendChild(this.derivedStats);const i=document.createElement("div");i.textContent="Press TAB, P, or ESC to close",i.style.cssText=`
      text-align: center;
      color: #666;
      font-size: 12px;
      margin-top: 24px;
    `,this.panel.appendChild(i),this.container.appendChild(this.panel),document.body.appendChild(this.container)}_createStatRow(e){const t=document.createElement("div");t.className="stat-row",t.style.cssText=`
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      transition: background 0.2s;
    `;const i=document.createElement("span");i.textContent=e.icon,i.style.cssText=`
      font-size: 24px;
      width: 36px;
      text-align: center;
    `,t.appendChild(i);const s=document.createElement("div");s.style.cssText=`
      flex: 1;
    `;const n=document.createElement("div");n.textContent=e.name,n.style.cssText=`
      color: ${e.color};
      font-size: 16px;
      font-weight: bold;
    `,s.appendChild(n);const a=document.createElement("div");a.textContent=e.desc,a.style.cssText=`
      color: #888;
      font-size: 11px;
      margin-top: 2px;
    `,s.appendChild(a),t.appendChild(s);const o=document.createElement("div");o.className="stat-value",o.style.cssText=`
      font-size: 24px;
      font-weight: bold;
      color: #fff;
      min-width: 40px;
      text-align: center;
    `,t.appendChild(o);const r=document.createElement("div");r.className="stat-bonus",r.style.cssText=`
      font-size: 12px;
      color: ${e.color};
      min-width: 100px;
      text-align: right;
    `,t.appendChild(r);const c=document.createElement("button");return c.textContent="+",c.className="add-point-btn",c.style.cssText=`
      width: 36px;
      height: 36px;
      border: 2px solid rgba(180, 140, 80, 0.5);
      border-radius: 50%;
      background: rgba(180, 140, 80, 0.2);
      color: #ffd088;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    `,c.addEventListener("mouseenter",()=>{c.disabled||(c.style.background="rgba(180, 140, 80, 0.4)",c.style.borderColor="#ffd088",c.style.transform="scale(1.1)")}),c.addEventListener("mouseleave",()=>{c.style.background="rgba(180, 140, 80, 0.2)",c.style.borderColor="rgba(180, 140, 80, 0.5)",c.style.transform="scale(1)"}),c.addEventListener("click",()=>{this.gm.spendStatPoint(e.id)&&(this._update(),this.gm.audioManager&&this.gm.audioManager.play("menuConfirm",{volume:.5}),t.style.background="rgba(180, 140, 80, 0.3)",setTimeout(()=>{t.style.background="rgba(0, 0, 0, 0.3)"},200))}),t.appendChild(c),t.valueDisplay=o,t.bonusDisplay=r,t.addBtn=c,t.statDef=e,t}_update(){const e=this.gm.currentLevel||1;this.levelInfo.textContent=`Level ${e}`;const t=this.gm.getAvailableStatPoints();t>0?this.pointsDisplay.innerHTML=`
        <span style="color: #ffd088; font-size: 18px;">
          ${t} Point${t>1?"s":""} Available
        </span>
      `:this.pointsDisplay.innerHTML=`
        <span style="color: #666; font-size: 14px;">
          No points available  Level up to earn more!
        </span>
      `;for(const n of this.statDefs){const a=this.statRows[n.id],o=this.gm.stats[n.id]||0;a.valueDisplay.textContent=o,a.bonusDisplay.textContent=n.getBonus(o),t>0?(a.addBtn.disabled=!1,a.addBtn.style.opacity="1",a.addBtn.style.cursor="pointer"):(a.addBtn.disabled=!0,a.addBtn.style.opacity="0.3",a.addBtn.style.cursor="not-allowed")}const i=this.gm.getStatBonuses(),s=this.gm.manaManager?this.gm.manaManager.maxMana:100;this.derivedStats.innerHTML=`
      <div>Max HP: <span style="color: #ff6666">${this.gm.maxHealth}</span></div>
      <div>Max Stamina: <span style="color: #66ff88">${this.gm.maxStamina}</span></div>
      <div>Max Mana: <span style="color: #4488ff">${s}</span></div>
      <div>Damage Mult: <span style="color: #ff8844">${(i.damageMult*100).toFixed(0)}%</span></div>
      <div>Attack Speed: <span style="color: #88ccff">${(i.attackSpeedMult*100).toFixed(0)}%</span></div>
      <div>Mana Regen: <span style="color: #4488ff">${(i.manaRegenMult*100).toFixed(0)}%</span></div>
      <div>Stamina Regen: <span style="color: #66ff88">${(i.staminaRegenMult*100).toFixed(0)}%</span></div>
      <div>Cooldown Mult: <span style="color: #cc88ff">${(i.cooldownMult*100).toFixed(0)}%</span></div>
    `}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen||(this.isOpen=!0,this._update(),this.container.style.display="flex",this.gm.audioManager&&this.gm.audioManager.play("menuOpen",{volume:.4}))}close(){this.isOpen&&(this.isOpen=!1,this.container.style.display="none",this.gm.audioManager&&this.gm.audioManager.play("menuBack",{volume:.3}))}update(){this.isOpen&&this._update()}}class sS{constructor(e,t,i,s){this.gm=e,this.lootManager=t,this.equipmentManager=i,this.inputManager=s,this.isOpen=!1,this.activeTab="items",this.hoveredItem=null,this.hoveredEquipment=null,this.container=null,this.tooltipEl=null,this.createUI(),this.createHotbar(),console.log("[InventoryUI] Initialized")}get weaponManager(){return this.equipmentManager?.weaponManager||this.gm?.weaponManager}createUI(){if(this.container=document.createElement("div"),this.container.id="inventory-ui",this.container.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 800px;
      max-height: 85vh;
      background: linear-gradient(145deg, rgba(15, 15, 20, 0.97), rgba(8, 8, 12, 0.99));
      border: 2px solid rgba(200, 170, 100, 0.4);
      border-radius: 6px;
      padding: 0;
      color: #ddd;
      font-family: 'Cinzel', 'Georgia', serif;
      display: none;
      z-index: 2000;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.9), inset 0 0 80px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    `,document.body.appendChild(this.container),this.tooltipEl=document.createElement("div"),this.tooltipEl.id="inventory-tooltip",this.tooltipEl.style.cssText=`
      position: fixed;
      background: rgba(10, 10, 15, 0.98);
      border: 1px solid rgba(200, 170, 100, 0.5);
      border-radius: 4px;
      padding: 12px 16px;
      color: #ccc;
      font-family: 'Cinzel', 'Georgia', serif;
      font-size: 13px;
      max-width: 320px;
      z-index: 3000;
      pointer-events: none;
      display: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
    `,document.body.appendChild(this.tooltipEl),!document.getElementById("inventory-ui-styles")){const e=document.createElement("style");e.id="inventory-ui-styles",e.textContent=`
        #inventory-ui .tab-btn {
          background: rgba(30, 30, 40, 0.8);
          border: none;
          border-bottom: 2px solid transparent;
          color: #888;
          padding: 12px 24px;
          font-family: 'Cinzel', 'Georgia', serif;
          font-size: 14px;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        #inventory-ui .tab-btn:hover {
          color: #ccc;
          background: rgba(50, 50, 60, 0.8);
        }
        #inventory-ui .tab-btn.active {
          color: #ffc864;
          border-bottom-color: #ffc864;
          background: rgba(40, 35, 30, 0.8);
        }
        #inventory-ui .item-slot {
          width: 60px;
          height: 60px;
          background: rgba(0, 0, 0, 0.4);
          border: 1px solid rgba(80, 80, 80, 0.3);
          border-radius: 4px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: all 0.15s ease;
          position: relative;
        }
        #inventory-ui .item-slot:hover {
          border-color: rgba(200, 170, 100, 0.6);
          background: rgba(40, 35, 30, 0.5);
          transform: scale(1.05);
        }
        #inventory-ui .item-slot .item-icon {
          width: 40px;
          height: 40px;
          border-radius: 4px;
        }
        #inventory-ui .item-slot .item-qty {
          position: absolute;
          bottom: 2px;
          right: 4px;
          font-size: 11px;
          color: #fff;
          text-shadow: 0 0 3px #000, 0 0 5px #000;
          font-weight: bold;
        }
        #inventory-ui .item-slot .hotkey-badge {
          position: absolute;
          top: 2px;
          left: 4px;
          font-size: 10px;
          color: #ffc864;
          background: rgba(0,0,0,0.7);
          padding: 1px 4px;
          border-radius: 2px;
        }
        #inventory-ui .equip-slot {
          padding: 12px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(80, 80, 80, 0.3);
          border-radius: 4px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: all 0.15s ease;
        }
        #inventory-ui .equip-slot:hover {
          border-color: rgba(200, 170, 100, 0.5);
          background: rgba(30, 25, 20, 0.4);
        }
        #inventory-ui .equip-slot.empty {
          border-style: dashed;
          opacity: 0.6;
        }
        #inventory-ui .equip-slot.equipped-highlight {
          border-color: rgba(255, 200, 100, 0.6);
          box-shadow: 0 0 10px rgba(255, 200, 100, 0.2);
        }
        #inventory-ui .action-btn {
          padding: 6px 14px;
          border: 1px solid rgba(100, 100, 100, 0.4);
          border-radius: 3px;
          background: rgba(40, 40, 50, 0.6);
          color: #aaa;
          font-family: 'Cinzel', 'Georgia', serif;
          font-size: 11px;
          cursor: pointer;
          transition: all 0.15s ease;
          margin-right: 6px;
        }
        #inventory-ui .action-btn:hover {
          background: rgba(60, 60, 70, 0.8);
          color: #fff;
          border-color: rgba(150, 150, 150, 0.5);
        }
        #inventory-ui .action-btn.use {
          border-color: rgba(100, 200, 100, 0.4);
          color: #8f8;
        }
        #inventory-ui .action-btn.use:hover {
          background: rgba(50, 80, 50, 0.6);
          border-color: rgba(100, 255, 100, 0.5);
        }
        #inventory-ui .action-btn.equip {
          border-color: rgba(100, 150, 255, 0.4);
          color: #8af;
        }
        #inventory-ui .action-btn.equip:hover {
          background: rgba(50, 60, 90, 0.6);
          border-color: rgba(100, 150, 255, 0.6);
        }
        #inventory-ui .action-btn.drop {
          border-color: rgba(180, 80, 80, 0.4);
          color: #f88;
        }
        #inventory-ui .action-btn.drop:hover {
          background: rgba(80, 40, 40, 0.6);
          border-color: rgba(255, 100, 100, 0.5);
        }
        #inventory-ui .stat-better { color: #4ade80; }
        #inventory-ui .stat-worse { color: #f87171; }
        #inventory-ui .stat-same { color: #888; }
        #inventory-ui .weapon-slot-badge {
          position: absolute;
          top: -6px;
          right: -6px;
          width: 18px;
          height: 18px;
          background: #ffc864;
          color: #000;
          border-radius: 50%;
          font-size: 10px;
          font-weight: bold;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 0 5px rgba(255, 200, 100, 0.5);
        }
      `,document.head.appendChild(e)}}createHotbar(){this.hotbarEl=document.createElement("div"),this.hotbarEl.id="combat-hotbar",this.hotbarEl.style.cssText=`
      position: fixed;
      bottom: 100px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 500;
      pointer-events: none;
    `,document.body.appendChild(this.hotbarEl),this.updateHotbar()}updateHotbar(){const t=this.lootManager.getInventory().items||{},i=t["health-potion"]||0,s=t["stamina-potion"]||0,n=this.weaponManager?.getQuickSlotsInfo?.()||[],a=this.weaponManager?.activeSlot??0;this.hotbarEl.innerHTML=`
      <!-- Weapon Quick Slots -->
      <div style="
        display: flex;
        gap: 4px;
        justify-content: flex-end;
      ">
        ${[0,1,2,3].map(o=>{const r=n[o],c=o===a,h=!r||r.empty;return`
            <div style="
              display: flex;
              flex-direction: column;
              align-items: center;
              background: ${c?"rgba(60, 50, 30, 0.8)":"rgba(0, 0, 0, 0.6)"};
              border: 2px solid ${c?"rgba(255, 200, 100, 0.8)":"rgba(100, 100, 100, 0.4)"};
              border-radius: 6px;
              padding: 4px 8px;
              min-width: 40px;
              ${c?"box-shadow: 0 0 10px rgba(255, 200, 100, 0.4);":""}
            ">
              <div style="font-size: 9px; color: ${c?"#ffc864":"#666"}; margin-bottom: 2px;">[${o+1}]</div>
              <div style="font-size: 14px; color: ${h?"#444":r?.rarity?.color||"#888"};">
                ${h?"":r?.category||""}
              </div>
              <div style="font-size: 8px; color: ${h?"#444":"#aaa"}; max-width: 50px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${h?"Empty":r?.name?.split(" ").pop()||""}
              </div>
            </div>
          `}).join("")}
      </div>
      
      <!-- Potions -->
      <div style="
        display: flex;
        gap: 6px;
        justify-content: flex-end;
      ">
        <div style="
          display: flex;
          flex-direction: column;
          align-items: center;
          background: rgba(0,0,0,0.6);
          border: 1px solid rgba(255,80,80,0.4);
          border-radius: 6px;
          padding: 4px 8px;
          min-width: 45px;
        ">
          <div style="font-size: 8px; color: #ff6666; margin-bottom: 1px;">Ctrl+1</div>
          <div style="font-size: 14px; color: #ff4444;"></div>
          <div style="font-size: 11px; color: ${i>0?"#fff":"#666"}; font-family: 'Cinzel', serif;">${i}</div>
        </div>
        <div style="
          display: flex;
          flex-direction: column;
          align-items: center;
          background: rgba(0,0,0,0.6);
          border: 1px solid rgba(80,255,80,0.4);
          border-radius: 6px;
          padding: 4px 8px;
          min-width: 45px;
        ">
          <div style="font-size: 8px; color: #66ff66; margin-bottom: 1px;">Ctrl+2</div>
          <div style="font-size: 14px; color: #44ff44;"></div>
          <div style="font-size: 11px; color: ${s>0?"#fff":"#666"}; font-family: 'Cinzel', serif;">${s}</div>
        </div>
      </div>
    `}toggle(){this.isOpen=!this.isOpen,this.container.style.display=this.isOpen?"block":"none",this.tooltipEl.style.display="none",this.isOpen&&this.render(),this.equipmentManager.isUIVisible&&(this.equipmentManager.isUIVisible=!1,this.equipmentManager.uiContainer.style.display="none")}render(){const e=this.lootManager.getInventory(),t=this.equipmentManager.equipped,i=this.equipmentManager.inventory,s=this.equipmentManager.getEquipmentBonuses();this.container.innerHTML=`
      <!-- Header with gold -->
      <div style="
        background: linear-gradient(90deg, rgba(40, 35, 25, 0.9), rgba(30, 28, 22, 0.95), rgba(40, 35, 25, 0.9));
        padding: 15px 20px;
        border-bottom: 1px solid rgba(200, 170, 100, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <h2 style="margin: 0; color: #ffc864; font-size: 20px; text-shadow: 0 0 15px rgba(255, 200, 100, 0.4);">
           Inventory
        </h2>
        <div style="
          display: flex;
          align-items: center;
          gap: 8px;
          background: rgba(0, 0, 0, 0.4);
          padding: 8px 16px;
          border-radius: 4px;
          border: 1px solid rgba(255, 215, 0, 0.3);
        ">
          <span style="font-size: 20px;"></span>
          <span style="color: #ffd700; font-size: 18px; font-weight: bold;">${e.gold.toLocaleString()}</span>
          <span style="color: #aa9933; font-size: 12px;">Gold</span>
        </div>
      </div>
      
      <!-- Tabs -->
      <div style="display: flex; background: rgba(20, 20, 25, 0.8); border-bottom: 1px solid rgba(80, 80, 80, 0.3);">
        <button class="tab-btn ${this.activeTab==="items"?"active":""}" data-tab="items">
           Items
        </button>
        <button class="tab-btn ${this.activeTab==="equipment"?"active":""}" data-tab="equipment">
           Equipment
        </button>
        <button class="tab-btn ${this.activeTab==="materials"?"active":""}" data-tab="materials">
           Materials
        </button>
      </div>
      
      <!-- Content area -->
      <div style="padding: 20px; max-height: calc(85vh - 140px); overflow-y: auto;">
        ${this.activeTab==="items"?this.renderItemsTab(e):this.activeTab==="materials"?this.renderMaterialsTab():this.renderEquipmentTab(t,i,s)}
      </div>
      
      <!-- Footer -->
      <div style="
        padding: 10px 20px;
        background: rgba(15, 15, 20, 0.9);
        border-top: 1px solid rgba(80, 80, 80, 0.3);
        text-align: center;
        color: #666;
        font-size: 12px;
      ">
        <span style="color: #ffc864;">[I]</span> Close  
        <span style="color: #ffc864;">[1-4]</span> Switch Weapons  
        <span style="color: #ffc864;">[Q]</span> Cycle Weapons  
        <span style="color: #ff6666;">Ctrl+[1]</span> HP Potion  
        <span style="color: #66ff66;">Ctrl+[2]</span> Stamina Potion
      </div>
    `,this.attachEventListeners()}renderItemsTab(e){const t=[],i=[];for(const[s,n]of Object.entries(e.items||{})){const a=Object.values(Fs).find(o=>o.id===s);a&&(a.type==="consumable"?t.push({...a,quantity:n}):a.type==="material"&&i.push({...a,quantity:n}))}return`
      <!-- Consumables Section -->
      <div style="margin-bottom: 25px;">
        <h3 style="color: #aaa; font-size: 14px; margin: 0 0 12px 0; padding-bottom: 6px; border-bottom: 1px solid rgba(100, 100, 100, 0.2);">
           Consumables
        </h3>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
          ${t.length===0?'<span style="color: #555; font-size: 13px;">No consumables</span>':""}
          ${t.map(s=>this.renderItemSlot(s)).join("")}
        </div>
      </div>
      
      <!-- Materials Section -->
      <div>
        <h3 style="color: #aaa; font-size: 14px; margin: 0 0 12px 0; padding-bottom: 6px; border-bottom: 1px solid rgba(100, 100, 100, 0.2);">
           Materials
        </h3>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
          ${i.length===0?'<span style="color: #555; font-size: 13px;">No materials</span>':""}
          ${i.map(s=>this.renderItemSlot(s)).join("")}
        </div>
      </div>
    `}renderMaterialsTab(){const e=JSON.parse(localStorage.getItem("ashen-materials")||"{}"),t={ore:[],herb:[],monster_drop:[],gem:[],misc:[]};for(const[n,a]of Object.entries(e)){if(a<=0)continue;const o=On(n);if(o){const r=o.category?.id||"misc";t[r]||(t[r]=[]),t[r].push({...o,quantity:a})}else t.misc.push({id:n,name:n.replace(/_/g," ").replace(/\b\w/g,r=>r.toUpperCase()),quantity:a,iconColor:8947848,rarity:{color:"#888888"},description:"Unknown material"})}const i=Object.values(e).reduce((n,a)=>n+a,0);return`
      <!-- Materials Summary -->
      <div style="
        margin-bottom: 20px;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(100, 180, 100, 0.3);
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <div>
          <span style="color: #88cc88; font-size: 14px;"> Crafting Materials</span>
          <span style="color: #666; font-size: 12px; margin-left: 10px;">Press C to open Crafting</span>
        </div>
        <div style="color: #aaa; font-size: 12px;">
          ${Object.keys(e).filter(n=>e[n]>0).length} types  ${i} total
        </div>
      </div>
      
      <!-- Ores -->
      ${this.renderMaterialCategory("ore"," Ores",t.ore)}
      
      <!-- Herbs -->
      ${this.renderMaterialCategory("herb"," Herbs",t.herb)}
      
      <!-- Monster Drops -->
      ${this.renderMaterialCategory("monster_drop"," Monster Drops",t.monster_drop)}
      
      <!-- Gems -->
      ${this.renderMaterialCategory("gem"," Gems",t.gem)}
      
      <!-- Miscellaneous -->
      ${this.renderMaterialCategory("misc"," Miscellaneous",t.misc)}
    `}renderMaterialCategory(e,t,i){return i.length===0?`
        <div style="margin-bottom: 20px;">
          <h3 style="color: #666; font-size: 13px; margin: 0 0 10px 0; padding-bottom: 4px; border-bottom: 1px solid rgba(80, 80, 80, 0.2);">
            ${t}
          </h3>
          <span style="color: #444; font-size: 12px; font-style: italic;">None collected</span>
        </div>
      `:`
      <div style="margin-bottom: 20px;">
        <h3 style="color: #aaa; font-size: 13px; margin: 0 0 10px 0; padding-bottom: 4px; border-bottom: 1px solid rgba(80, 80, 80, 0.2);">
          ${t} <span style="color: #666; font-size: 11px;">(${i.length})</span>
        </h3>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          ${i.map(s=>this.renderMaterialSlot(s)).join("")}
        </div>
      </div>
    `}renderMaterialSlot(e){const t="#"+(e.iconColor||8947848).toString(16).padStart(6,"0"),i=e.rarity?.color||e.rarity?.hexColor?.toString(16).padStart(6,"0")||"#888888";return`
      <div class="item-slot material-slot" 
           data-material-id="${e.id}"
           style="border-color: ${i}40; position: relative;"
           onmouseenter="window.inventoryUI?.showMaterialTooltip(event, '${e.id}')"
           onmouseleave="window.inventoryUI?.hideTooltip()">
        <div class="item-icon" style="
          background: radial-gradient(circle at 30% 30%, ${t}, ${t}66);
          box-shadow: 0 0 8px ${t}33;
        "></div>
        <span class="item-qty">${e.quantity}</span>
      </div>
    `}showMaterialTooltip(e,t){const i=On(t);if(!i){this.tooltipEl.innerHTML=`
        <div style="color: #888; font-weight: bold;">${t}</div>
        <div style="color: #666; font-size: 11px;">Unknown material</div>
      `,this.tooltipEl.style.display="block",this.positionTooltip(e);return}""+(i.iconColor||8947848).toString(16).padStart(6,"0");const s=i.rarity?.color||"#888888",n=i.category?.name||"Material",a=i.sellValue||0;let o="";if(i.sources&&i.sources.length>0){const r={gathering:" Gathering",enemy:" Enemy Drops",chest:" Chests",shop:" Merchants",boss:" Boss Drops"};o=`
        <div style="margin-top: 8px; padding-top: 6px; border-top: 1px solid rgba(100,100,100,0.2);">
          <div style="color: #666; font-size: 10px; margin-bottom: 4px;">Sources:</div>
          <div style="color: #888; font-size: 11px;">
            ${i.sources.map(c=>r[c]||c).join("  ")}
          </div>
        </div>
      `}this.tooltipEl.innerHTML=`
      <div style="color: ${s}; font-weight: bold; margin-bottom: 4px;">${i.name}</div>
      <div style="color: #888; font-size: 11px;">${i.rarity?.name||"Common"} ${n}</div>
      <div style="margin-top: 8px; color: #aaa; font-size: 12px; line-height: 1.4;">
        ${i.description||"A crafting material."}
      </div>
      ${a>0?`
        <div style="margin-top: 8px; color: #ffd700; font-size: 11px;">
           Sell: ${a} gold
        </div>
      `:""}
      ${o}
      <div style="color: #88cc88; font-size: 10px; margin-top: 10px;">
        Press C to craft with this material
      </div>
    `,this.tooltipEl.style.display="block",this.positionTooltip(e)}renderItemSlot(e){const t="#"+e.color.toString(16).padStart(6,"0"),i=e.id==="health-potion"?"Ctrl+1":e.id==="stamina-potion"?"Ctrl+2":"",s=i?`<span class="hotkey-badge">${i}</span>`:"";return`
      <div class="item-slot" data-item-id="${e.id}" data-item-type="consumable"
           style="border-color: ${t}40;">
        <div class="item-icon" style="
          background: radial-gradient(circle at 30% 30%, ${t}, ${t}66);
          box-shadow: 0 0 10px ${t}44;
        "></div>
        ${s}
        <span class="item-qty">${e.quantity}</span>
      </div>
    `}renderEquipmentTab(e,t,i){const s=this.weaponManager?.getQuickSlotsInfo?.()||[];return`
      <div style="display: flex; gap: 25px;">
        <!-- Equipped Section -->
        <div style="flex: 1;">
          <h3 style="color: #aaa; font-size: 14px; margin: 0 0 12px 0; padding-bottom: 6px; border-bottom: 1px solid rgba(100, 100, 100, 0.2);">
            Equipped
          </h3>
          ${this.renderWeaponSlot(e[ot.WEAPON]," Weapon",ot.WEAPON)}
          ${this.renderEquipSlot(e[ot.ARMOR]," Armor",ot.ARMOR)}
          ${this.renderEquipSlot(e[ot.ACCESSORY]," Accessory",ot.ACCESSORY)}
          
          <!-- Weapon Quick Slots -->
          <div style="
            margin-top: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(200, 170, 100, 0.2);
            border-radius: 4px;
          ">
            <h4 style="color: #ffc864; font-size: 12px; margin: 0 0 10px 0;"> Weapon Quick Slots</h4>
            <div style="display: flex; gap: 8px;">
              ${s.map((n,a)=>`
                <div style="
                  flex: 1;
                  padding: 8px;
                  background: ${n?.isActive?"rgba(60, 50, 30, 0.6)":"rgba(0, 0, 0, 0.3)"};
                  border: 1px solid ${n?.isActive?"rgba(255, 200, 100, 0.5)":"rgba(80, 80, 80, 0.3)"};
                  border-radius: 4px;
                  text-align: center;
                ">
                  <div style="font-size: 10px; color: ${n?.isActive?"#ffc864":"#666"};">[${a+1}]</div>
                  <div style="font-size: 12px; color: ${n?.empty?"#444":n?.rarity?.color||"#888"}; margin-top: 4px;">
                    ${n?.empty?"":n?.category||""}
                  </div>
                  <div style="font-size: 10px; color: ${n?.empty?"#444":"#aaa"}; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${n?.empty?"Empty":n?.name||""}
                  </div>
                </div>
              `).join("")}
            </div>
            <div style="font-size: 10px; color: #666; margin-top: 8px; text-align: center;">
              Press [1-4] to switch  [Q] to cycle
            </div>
          </div>
          
          <!-- Total Bonuses -->
          <div style="
            margin-top: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(100, 200, 100, 0.2);
            border-radius: 4px;
          ">
            <h4 style="color: #8f8; font-size: 12px; margin: 0 0 8px 0;">Total Bonuses</h4>
            <div style="font-size: 11px; color: #afa; line-height: 1.6;">
              ${i.damage>0?`<div>+${i.damage} Damage</div>`:""}
              ${i.defense>0?`<div>+${i.defense} Defense</div>`:""}
              ${i.health!==0?`<div>${i.health>0?"+":""}${i.health} Max Health</div>`:""}
              ${i.stamina!==0?`<div>${i.stamina>0?"+":""}${i.stamina} Max Stamina</div>`:""}
              ${i.critChance>0?`<div>+${i.critChance}% Crit Chance</div>`:""}
              ${i.critDamage>0?`<div>+${i.critDamage}% Crit Damage</div>`:""}
              ${i.attackSpeed>0?`<div>+${i.attackSpeed}% Attack Speed</div>`:""}
              ${i.healthRegen>0?`<div>+${i.healthRegen} HP/sec</div>`:""}
              ${i.staminaRegen>0?`<div>+${i.staminaRegen}% Stamina Regen</div>`:""}
              ${Object.values(i).every(n=>n===0)?'<div style="color: #666;">No bonuses</div>':""}
            </div>
          </div>
        </div>
        
        <!-- Inventory Section -->
        <div style="flex: 1.5;">
          <h3 style="color: #aaa; font-size: 14px; margin: 0 0 12px 0; padding-bottom: 6px; border-bottom: 1px solid rgba(100, 100, 100, 0.2);">
            Equipment Inventory (${t.length})
          </h3>
          <div style="max-height: 400px; overflow-y: auto;">
            ${t.length===0?'<span style="color: #555; font-size: 13px;">No equipment in inventory</span>':""}
            ${t.map(n=>this.renderEquipmentItem(n,e)).join("")}
          </div>
        </div>
      </div>
    `}renderWeaponSlot(e,t,i){if(!e)return`
        <div class="equip-slot empty" data-slot="${i}">
          <span style="color: #555; font-size: 13px;">${t}: Empty</span>
        </div>
      `;const s=this.weaponManager?.getActiveWeaponInfo?.()||{},n=Object.entries(e.stats).map(([a,o])=>`${o>0?"+":""}${o} ${this.formatStatName(a)}`).join("  ");return`
      <div class="equip-slot equipped-highlight" data-slot="${i}" style="border-color: ${e.rarity.color}40;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="flex: 1;">
            <div style="color: #888; font-size: 11px; margin-bottom: 2px;">${t}</div>
            <div style="color: ${e.rarity.color}; font-weight: bold;">${e.name}</div>
            <div style="color: #777; font-size: 11px; margin-top: 4px;">${n}</div>
            ${s.category?`
              <div style="font-size: 10px; color: #aaa; margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(100,100,100,0.2);">
                <span style="color: #ffc864;">${s.categoryIcon||""} ${s.category}</span>
                ${s.damage?`  ${s.damage} DMG`:""}
                ${s.speed?`  ${(s.speed*100).toFixed(0)}% SPD`:""}
                ${s.range?`  ${(s.range*100).toFixed(0)}% RNG`:""}
                ${s.critChance?`  ${s.critChance.toFixed(0)}% CRIT`:""}
              </div>
            `:""}
          </div>
          <button class="action-btn drop unequip-btn" data-slot="${i}">Unequip</button>
        </div>
      </div>
    `}renderEquipSlot(e,t,i){if(!e)return`
        <div class="equip-slot empty" data-slot="${i}">
          <span style="color: #555; font-size: 13px;">${t}: Empty</span>
        </div>
      `;const s=Object.entries(e.stats).map(([n,a])=>`${a>0?"+":""}${a} ${this.formatStatName(n)}`).join("  ");return`
      <div class="equip-slot" data-slot="${i}" style="border-color: ${e.rarity.color}40;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="color: #888; font-size: 11px; margin-bottom: 2px;">${t}</div>
            <div style="color: ${e.rarity.color}; font-weight: bold;">${e.name}</div>
            <div style="color: #777; font-size: 11px; margin-top: 4px;">${s}</div>
          </div>
          <button class="action-btn drop unequip-btn" data-slot="${i}">Unequip</button>
        </div>
      </div>
    `}renderEquipmentItem(e,t){const i=Object.entries(e.stats).map(([o,r])=>`${r>0?"+":""}${r} ${this.formatStatName(o)}`).join("  "),s=t[e.slot],n=this.compareStats(e,s),a=e.slot===ot.WEAPON;return`
      <div class="equip-slot" 
           data-equip-id="${e.id}" 
           data-slot="${e.slot}"
           style="border-color: ${e.rarity.color}30; position: relative;"
           onmouseenter="window.inventoryUI?.showEquipmentTooltip(event, '${e.id}')"
           onmouseleave="window.inventoryUI?.hideTooltip()">
        <div style="display: flex; justify-content: space-between; align-items: start;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: ${e.rarity.color}; font-weight: bold;">${e.name}</span>
              <span style="color: #666; font-size: 11px; text-transform: capitalize;">${e.slot}</span>
              ${a&&e.weaponModel?`<span style="color: #888; font-size: 10px;">(${e.weaponModel})</span>`:""}
            </div>
            <div style="color: #777; font-size: 11px; margin-top: 4px;">${i}</div>
            ${n?`
              <div style="font-size: 10px; margin-top: 4px;">
                ${n}
              </div>
            `:""}
          </div>
          <div style="display: flex; flex-direction: column; gap: 4px;">
            <button class="action-btn equip equip-btn" data-equip-id="${e.id}">Equip</button>
            <button class="action-btn drop drop-equip-btn" data-equip-id="${e.id}">Drop</button>
          </div>
        </div>
      </div>
    `}compareStats(e,t){if(!t)return'<span class="stat-better"> No item equipped</span>';const i=[],s=new Set([...Object.keys(e.stats),...Object.keys(t.stats)]);for(const n of s){const a=e.stats[n]||0,o=t.stats[n]||0,r=a-o;if(r!==0){const c=r>0?"":"",h=r>0?"stat-better":"stat-worse";i.push(`<span class="${h}">${c}${Math.abs(r)} ${this.formatStatName(n)}</span>`)}}return i.length===0?'<span class="stat-same">= Same stats</span>':i.join(" ")}showEquipmentTooltip(e,t){const i=this.equipmentManager.inventory.find(r=>r.id===t);if(!i)return;const s=i.slot===ot.WEAPON,n=this.equipmentManager.equipped[i.slot];let a="";s&&i.weaponModel&&(a=`
        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(100, 100, 100, 0.3);">
          <div style="color: #ffc864; font-size: 11px; margin-bottom: 4px;">Weapon Type: ${i.weaponModel}</div>
          <div style="color: #888; font-size: 10px;">
            ${i.stats.damage?`Base Damage: ${i.stats.damage}`:""}
            ${i.stats.critChance?`<br>Crit Chance: +${i.stats.critChance}%`:""}
            ${i.stats.attackSpeed?`<br>Attack Speed: +${i.stats.attackSpeed}%`:""}
          </div>
        </div>
      `);let o="";if(n){const r=[],c=new Set([...Object.keys(i.stats),...Object.keys(n.stats)]);for(const h of c){const d=i.stats[h]||0,u=n.stats[h]||0,p=d-u;if(p!==0){const f=p>0?"#4ade80":"#f87171",y=p>0?"+":"";r.push(`<div style="color: ${f};">${y}${p} ${this.formatStatName(h)}</div>`)}}r.length>0&&(o=`
          <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(100, 100, 100, 0.3);">
            <div style="color: #888; font-size: 10px; margin-bottom: 4px;">vs Equipped:</div>
            ${r.join("")}
          </div>
        `)}this.tooltipEl.innerHTML=`
      <div style="color: ${i.rarity.color}; font-weight: bold; margin-bottom: 4px;">${i.name}</div>
      <div style="color: #888; font-size: 11px;">${i.rarity.name} ${i.slot}</div>
      <div style="margin-top: 8px; line-height: 1.5;">
        ${Object.entries(i.stats).map(([r,c])=>`<div style="color: #afa;">${c>0?"+":""}${c} ${this.formatStatName(r)}</div>`).join("")}
      </div>
      ${a}
      ${o}
      <div style="color: #ffc864; font-size: 10px; margin-top: 10px;">Click Equip to use</div>
    `,this.tooltipEl.style.display="block",this.positionTooltip(e),this.hoveredEquipment=t}formatStatName(e){return{damage:"DMG",defense:"DEF",health:"HP",stamina:"STA",critChance:"CRIT%",critDamage:"CRIT DMG",attackSpeed:"ATK SPD",healthRegen:"HP/s",staminaRegen:"STA REG"}[e]||e}attachEventListeners(){window.inventoryUI=this,this.container.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{this.activeTab=e.dataset.tab,this.render()})}),this.container.querySelectorAll(".item-slot").forEach(e=>{e.addEventListener("mouseenter",t=>this.showItemTooltip(t,e.dataset.itemId)),e.addEventListener("mouseleave",()=>this.hideTooltip()),e.addEventListener("click",()=>this.handleItemClick(e.dataset.itemId))}),this.container.querySelectorAll(".equip-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),this.equipmentManager.equip(e.dataset.equipId),this.render(),this.updateHotbar()})}),this.container.querySelectorAll(".unequip-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),this.equipmentManager.unequip(e.dataset.slot),this.render(),this.updateHotbar()})}),this.container.querySelectorAll(".drop-equip-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation(),confirm("Drop this equipment?")&&(this.equipmentManager.dropEquipment(e.dataset.equipId),this.render())})})}showItemTooltip(e,t){const i=Object.values(Fs).find(o=>o.id===t);if(!i)return;const s="#"+i.color.toString(16).padStart(6,"0");let n="";i.effect&&(i.effect.healAmount&&(n=`<div style="color: #ff6666; margin-top: 6px;">Restores ${i.effect.healAmount} HP</div>`),i.effect.staminaAmount&&(n=`<div style="color: #66ff66; margin-top: 6px;">Restores ${i.effect.staminaAmount} Stamina</div>`));let a="";t==="health-potion"?a='<div style="color: #ffc864; font-size: 11px; margin-top: 10px;">Press Ctrl+1 to use</div>':t==="stamina-potion"?a='<div style="color: #ffc864; font-size: 11px; margin-top: 10px;">Press Ctrl+2 to use</div>':i.type==="consumable"&&(a='<div style="color: #ffc864; font-size: 11px; margin-top: 10px;">Click to use</div>'),this.tooltipEl.innerHTML=`
      <div style="color: ${s}; font-weight: bold; margin-bottom: 6px;">${i.name}</div>
      <div style="color: #888; font-size: 11px; text-transform: capitalize;">${i.type}</div>
      <div style="margin-top: 8px; line-height: 1.4;">${i.description}</div>
      ${n}
      ${a}
    `,this.tooltipEl.style.display="block",this.positionTooltip(e)}positionTooltip(e){const t=e.clientX+15,i=e.clientY+10,s=window.innerWidth-340,n=window.innerHeight-250;this.tooltipEl.style.left=Math.min(t,s)+"px",this.tooltipEl.style.top=Math.min(i,n)+"px"}hideTooltip(){this.tooltipEl.style.display="none",this.hoveredEquipment=null}handleItemClick(e){const t=Object.values(Fs).find(i=>i.id===e);t&&t.type==="consumable"&&this.lootManager.useItem(e)&&(this.render(),this.updateHotbar(),this.gm?.audioManager&&this.gm.audioManager.play("itemPickup",{volume:.5}))}update(){this.hotbarEl&&this.updateHotbar(),this.inputManager.openEquipment&&this.toggle()}}class nS{constructor(e,t,i){this.camera=e,this.target=t,this.input=i,this.distance=14,this.minDistance=6,this.maxDistance=20,this.height=1,this.sensitivity=.002,this.yaw=Math.PI,this.pitch=.53,this.minPitch=-.3,this.maxPitch=1.2,this.smoothing=8,this.currentPos=e.position.clone(),this.lockOnTarget=null,this.terrain=null,this._firstFrame=!0,this.lockOnYaw=0,this.lockOnTransition=0,this.lockOnTransitionSpeed=5,this.shakeIntensity=0,this.shakeDuration=0,this.shakeTimer=0,this.shakeOffset=new T,this.shakeDecay=.92}shake(e=.3,t=.15){this.shakeIntensity=Math.min(this.shakeIntensity+e,1),this.shakeDuration=Math.max(this.shakeDuration,t),this.shakeTimer=0}shakeLight(){this.shake(.15,.1)}shakeMedium(){this.shake(.35,.15)}shakeHeavy(){this.shake(.5,.2)}update(e){const t=this.input.getMouseDelta();this.yaw-=t.x*this.sensitivity,this.pitch=Math.max(this.minPitch,Math.min(this.maxPitch,this.pitch+t.y*this.sensitivity));const i=this.target.position.clone();if(i.y+=this.height,this.lockOnTarget&&this.lockOnTarget.mesh){const h=this.lockOnTarget.mesh.position,d=this.target.position.distanceTo(h);if(this.lockOnTarget.isDead||d>25)this.lockOnTarget=null,this.lockOnTransition=Math.max(0,this.lockOnTransition-this.lockOnTransitionSpeed*e);else{const u=new T().subVectors(h,i);u.y=0,this.lockOnYaw=Math.atan2(u.x,u.z)+Math.PI,this.lockOnTransition=Math.min(1,this.lockOnTransition+this.lockOnTransitionSpeed*e)}}else this.lockOnTransition=Math.max(0,this.lockOnTransition-this.lockOnTransitionSpeed*e);let s=this.yaw;if(this.lockOnTransition>0){let h=this.lockOnYaw-this.yaw;for(;h>Math.PI;)h-=Math.PI*2;for(;h<-Math.PI;)h+=Math.PI*2;s=this.yaw+h*this.lockOnTransition}const n=Math.sin(s)*this.distance*Math.cos(this.pitch),a=Math.cos(s)*this.distance*Math.cos(this.pitch),o=this.distance*Math.sin(this.pitch),r=new T(i.x+n,i.y+o,i.z+a);this._firstFrame?(this._firstFrame=!1,this.currentPos.copy(r)):this.currentPos.lerp(r,this.smoothing*e),this.clampToTerrain(),this._updateShake(e),this.camera.position.copy(this.currentPos),this.camera.position.add(this.shakeOffset);const c=i.clone();if(this.lockOnTarget&&this.lockOnTarget.mesh&&this.lockOnTransition>0){const h=this.lockOnTarget.mesh.position.clone();h.y+=1,c.lerp(h,.35*this.lockOnTransition)}this.camera.lookAt(c)}_updateShake(e){this.shakeIntensity>.001?(this.shakeOffset.set((Math.random()-.5)*2*this.shakeIntensity,(Math.random()-.5)*2*this.shakeIntensity,(Math.random()-.5)*2*this.shakeIntensity),this.shakeIntensity*=this.shakeDecay,this.shakeTimer+=e,this.shakeTimer>=this.shakeDuration&&(this.shakeIntensity=0,this.shakeOffset.set(0,0,0))):this.shakeOffset.set(0,0,0)}setLockOnTarget(e){if(this.lockOnTarget=e,e&&e.mesh){const t=this.target.position.clone();t.y+=this.height;const i=new T().subVectors(e.mesh.position,t);i.y=0,this.lockOnYaw=Math.atan2(i.x,i.z)+Math.PI}}isLockedOn(){return this.lockOnTarget!==null&&this.lockOnTransition>.5}clearLockOn(){this.lockOnTarget=null}setTerrain(e){this.terrain=e}clampToTerrain(){if(!this.terrain)return;const e=this.terrain.getHeightAt||this.terrain.getTerrainHeight;if(!e)return;const t=e.call(this.terrain,this.currentPos.x,this.currentPos.z);if(isNaN(t)||!isFinite(t))return;const i=t+2;this.currentPos.y<i&&(this.currentPos.y=i)}forcePosition(e,t,i){this.currentPos.set(e,t,i),this.camera.position.set(e,t,i)}getForwardDirection(){return new T(-Math.sin(this.yaw),0,-Math.cos(this.yaw)).normalize()}getRightDirection(){return new T(-Math.cos(this.yaw),0,Math.sin(this.yaw)).normalize()}}class aS{constructor(e){this.camera=e,this.context=null,this.masterGain=null,this.musicGain=null,this.sfxGain=null,this.initialized=!1,this.masterVolume=.7,this.musicVolume=.4,this.sfxVolume=.8,this.listener=null,this.currentMusic=null,this.musicSource=null,this.soundCooldowns={},this.soundBuffers={}}async init(){if(!this.initialized)try{this.context=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.context.createGain(),this.masterGain.gain.value=this.masterVolume,this.masterGain.connect(this.context.destination),this.musicGain=this.context.createGain(),this.musicGain.gain.value=this.musicVolume,this.musicGain.connect(this.masterGain),this.sfxGain=this.context.createGain(),this.sfxGain.gain.value=this.sfxVolume,this.sfxGain.connect(this.masterGain),this.listener=this.context.listener,await this.generateSoundBuffers(),this.initialized=!0}catch(e){console.warn("[AUDIO] Failed to initialize:",e)}}async generateSoundBuffers(){this.soundBuffers.swordSwing=this.createNoiseBuffer(.15,"highpass",2e3,.3),this.soundBuffers.hitImpact=this.createImpactBuffer(.12,150,.6),this.soundBuffers.criticalHit=this.createImpactBuffer(.15,200,.8),this.soundBuffers.playerDamage=this.createImpactBuffer(.2,80,.5),this.soundBuffers.enemyGrunt1=this.createGruntBuffer(.2,120),this.soundBuffers.enemyGrunt2=this.createGruntBuffer(.25,100),this.soundBuffers.enemyGrunt3=this.createGruntBuffer(.18,140),this.soundBuffers.dodge=this.createNoiseBuffer(.2,"bandpass",800,.25),this.soundBuffers.footstepStone=this.createFootstepBuffer(.08,"stone"),this.soundBuffers.footstepMetal=this.createFootstepBuffer(.1,"metal"),this.soundBuffers.death=this.createDeathBuffer(.8),this.soundBuffers.postureBreak=this.createPostureBreakBuffer(.3),this.soundBuffers.itemPickup=this.createChimeBuffer(.3,[523,659,784]),this.soundBuffers.doorUnlock=this.createChimeBuffer(.4,[392,494,587]),this.soundBuffers.menuSelect=this.createChimeBuffer(.15,[880]),this.soundBuffers.menuConfirm=this.createChimeBuffer(.2,[523,659]),this.soundBuffers.bossRoar=this.createRoarBuffer(.6),this.soundBuffers.staminaDepleted=this.createStaminaDepletedBuffer(.15),this.soundBuffers.levelUp=this.createLevelUpBuffer(.8),this.soundBuffers.dash=this.createNoiseBuffer(.15,"highpass",3e3,.4),this.soundBuffers.chargedSwing=this.createImpactBuffer(.25,100,.7),this.soundBuffers.parryReady=this.createChimeBuffer(.1,[440]),this.soundBuffers.parrySuccess=this.createImpactBuffer(.15,300,.6),this.soundBuffers.riposte=this.createImpactBuffer(.2,180,.8),this.soundBuffers.warCry=this.createRoarBuffer(.4),this.soundBuffers.abilityUnlock=this.createChimeBuffer(.5,[523,659,784,1047]),this.soundBuffers.chestOpen=this.createChestOpenBuffer(.5)}createChestOpenBuffer(e){const t=this.context.sampleRate,i=t*e,s=this.context.createBuffer(1,i,t),n=s.getChannelData(0),a=Math.floor(t*.2);for(let d=0;d<a;d++){const u=d/t,p=Math.sin(2*Math.PI*(200-u*150)*u)*.3,f=(Math.random()*2-1)*.15,y=Math.sin(d/a*Math.PI)*.5;n[d]=(p+f)*y}const o=a,r=i-o,c=[392,494,587,784],h=Math.floor(r/c.length);for(let d=0;d<c.length;d++){const u=c[d],p=o+d*h;for(let f=0;f<h;f++){const y=f/t,m=Math.exp(-y*4)*.5;n[p+f]=Math.sin(2*Math.PI*u*y)*m}}return s}createLevelUpBuffer(e){const t=this.context.sampleRate,i=t*e,s=this.context.createBuffer(1,i,t),n=s.getChannelData(0),a=[523,659,784,1047],o=i/a.length;for(let r=0;r<i;r++){const c=Math.min(Math.floor(r/o),a.length-1),h=r%o/o,d=r/i,u=Math.sin(h*Math.PI)*.8,p=1-Math.pow(d,3)*.5,f=a[c],y=Math.sin(2*Math.PI*f*(r/t)),m=Math.sin(2*Math.PI*f*2*(r/t))*.3,g=Math.sin(2*Math.PI*f*3*(r/t))*.15;n[r]=(y+m+g)*u*p*.4}return{buffer:s,filterType:null,filterFreq:null}}createNoiseBuffer(e,t,i,s){const n=this.context.sampleRate,a=n*e,o=this.context.createBuffer(1,a,n),r=o.getChannelData(0);for(let c=0;c<a;c++){const h=c/a,d=Math.sin(h*Math.PI);r[c]=(Math.random()*2-1)*d*s}return{buffer:o,filterType:t,filterFreq:i}}createImpactBuffer(e,t,i){const s=this.context.sampleRate,n=s*e,a=this.context.createBuffer(1,n,s),o=a.getChannelData(0);for(let r=0;r<n;r++){const c=r/n,h=Math.exp(-c*10),d=Math.sin(2*Math.PI*t*c*(1-c*.5)),u=(Math.random()*2-1)*.3;o[r]=(d+u)*h*i}return{buffer:a}}createGruntBuffer(e,t){const i=this.context.sampleRate,s=i*e,n=this.context.createBuffer(1,s,i),a=n.getChannelData(0);for(let o=0;o<s;o++){const r=o/s,c=Math.sin(r*Math.PI)*Math.exp(-r*3),h=Math.sin(2*Math.PI*t*o/i),d=Math.sin(2*Math.PI*t*2.5*o/i)*.5,u=Math.sin(2*Math.PI*t*4*o/i)*.25,p=(Math.random()*2-1)*.2;a[o]=(h+d+u+p)*c*.4}return{buffer:n}}createFootstepBuffer(e,t){const i=this.context.sampleRate,s=i*e,n=this.context.createBuffer(1,s,i),a=n.getChannelData(0),o=t==="metal"?400:200,r=t==="metal"?.6:.4;for(let c=0;c<s;c++){const h=c/s,d=Math.exp(-h*20),u=Math.sin(2*Math.PI*o*h),p=(Math.random()*2-1)*r;a[c]=(u*.5+p)*d*.3}return{buffer:n}}createDeathBuffer(e){const t=this.context.sampleRate,i=t*e,s=this.context.createBuffer(1,i,t),n=s.getChannelData(0);for(let a=0;a<i;a++){const o=a/i,r=Math.exp(-o*2)*(1-o),c=150*(1-o*.5),h=Math.sin(2*Math.PI*c*a/t),d=Math.tanh(h*3),u=(Math.random()*2-1)*.3*(1-o);n[a]=(d+u)*r*.5}return{buffer:s}}createPostureBreakBuffer(e){const t=this.context.sampleRate,i=t*e,s=this.context.createBuffer(1,i,t),n=s.getChannelData(0);for(let a=0;a<i;a++){const o=a/i,r=Math.exp(-o*5),c=Math.sin(2*Math.PI*800*a/t),h=Math.sin(2*Math.PI*1200*a/t),d=(Math.random()*2-1)*.5;n[a]=(c*.3+h*.2+d)*r*.4}return{buffer:s}}createChimeBuffer(e,t){const i=this.context.sampleRate,s=i*e,n=this.context.createBuffer(1,s,i),a=n.getChannelData(0);for(let o=0;o<s;o++){const r=o/s,c=Math.exp(-r*4);let h=0;t.forEach((d,u)=>{const p=u*.03*i;if(o>p){const f=(o-p)/i;h+=Math.sin(2*Math.PI*d*f)/t.length}}),a[o]=h*c*.3}return{buffer:n}}createStaminaDepletedBuffer(e){const t=this.context.sampleRate,i=t*e,s=this.context.createBuffer(1,i,t),n=s.getChannelData(0);for(let a=0;a<i;a++){const o=a/i,r=Math.exp(-o*8)*Math.sin(o*Math.PI*2),c=(Math.random()*2-1)*.6,h=Math.sin(2*Math.PI*200*a/t)*.3;n[a]=(c+h)*Math.abs(r)*.25}return{buffer:s}}createRoarBuffer(e){const t=this.context.sampleRate,i=t*e,s=this.context.createBuffer(1,i,t),n=s.getChannelData(0);for(let a=0;a<i;a++){const o=a/i;let r;o<.1?r=o/.1:o<.7?r=1:r=(1-o)/.3;const c=Math.sin(2*Math.PI*60*a/t),h=Math.sin(2*Math.PI*65*a/t),d=Math.sin(2*Math.PI*120*a/t)*.5,u=(Math.random()*2-1)*.4,p=Math.tanh((c+h+d+u)*2);n[a]=p*r*.5}return{buffer:s}}play(e,t={}){if(!this.initialized||!this.soundBuffers[e])return;const{position:i=null,volume:s=1,pitch:n=1,cooldown:a=0,variation:o=0}=t,r=performance.now();if(a>0){const p=this.soundCooldowns[e]||0;if(r-p<a)return;this.soundCooldowns[e]=r}const c=this.soundBuffers[e],h=this.context.createBufferSource();h.buffer=c.buffer;const d=n+(Math.random()*2-1)*o;h.playbackRate.value=Math.max(.5,Math.min(2,d));const u=this.context.createGain();if(u.gain.value=s,c.filterType){const p=this.context.createBiquadFilter();p.type=c.filterType,p.frequency.value=c.filterFreq,h.connect(p),p.connect(u)}else h.connect(u);if(i&&this.camera){const p=this.context.createPanner();p.panningModel="HRTF",p.distanceModel="inverse",p.refDistance=1,p.maxDistance=50,p.rolloffFactor=1,p.setPosition(i.x,i.y,i.z),u.connect(p),p.connect(this.sfxGain)}else u.connect(this.sfxGain);return h.start(),h}playEnemyGrunt(e){const t=["enemyGrunt1","enemyGrunt2","enemyGrunt3"],i=t[Math.floor(Math.random()*t.length)];this.play(i,{position:e,volume:.6,pitch:.9+Math.random()*.2,cooldown:200})}playFootstep(e,t="stone"){const i=t==="metal"?"footstepMetal":"footstepStone";this.play(i,{position:e,volume:.4,pitch:.9+Math.random()*.2,cooldown:150})}updateListener(){if(!this.initialized||!this.camera||!this.listener)return;const e=this.camera.position,t=new T;this.camera.getWorldDirection(t);const i=this.camera.up;this.listener.positionX?(this.listener.positionX.value=e.x,this.listener.positionY.value=e.y,this.listener.positionZ.value=e.z,this.listener.forwardX.value=t.x,this.listener.forwardY.value=t.y,this.listener.forwardZ.value=t.z,this.listener.upX.value=i.x,this.listener.upY.value=i.y,this.listener.upZ.value=i.z):(this.listener.setPosition(e.x,e.y,e.z),this.listener.setOrientation(t.x,t.y,t.z,i.x,i.y,i.z))}startAmbientMusic(){this.initialized&&this.currentMusic!=="ambient"&&(this.stopMusic(),this.currentMusic="ambient",this.createAmbientDrone())}startBossMusic(){this.initialized&&this.currentMusic!=="boss"&&(this.stopMusic(),this.currentMusic="boss",this.createBossMusic())}createAmbientDrone(){const e=this.context.createOscillator();e.type="sine",e.frequency.value=55;const t=this.context.createOscillator();t.type="sine",t.frequency.value=82.5;const i=this.context.createOscillator();i.type="sine",i.frequency.value=.1;const s=this.context.createGain();s.gain.value=2,i.connect(s),s.connect(e.frequency);const n=this.context.createGain();n.gain.value=.15;const a=this.context.createGain();a.gain.value=.1,e.connect(n),t.connect(a),n.connect(this.musicGain),a.connect(this.musicGain),e.start(),t.start(),i.start(),this.musicSource={oscs:[e,t,i]}}createBossMusic(){const e=this.context.createOscillator();e.type="sawtooth",e.frequency.value=55;const t=this.context.createWaveShaper();t.curve=this.makeDistortionCurve(20);const i=this.context.createOscillator();i.type="square",i.frequency.value=2;const s=this.context.createGain();s.gain.value=.3;const n=this.context.createGain();n.gain.value=.2,i.connect(s),s.connect(n.gain),e.connect(t),t.connect(n),n.connect(this.musicGain),e.start(),i.start(),this.musicSource={oscs:[e,i]}}makeDistortionCurve(e){const i=new Float32Array(44100),s=Math.PI/180;for(let n=0;n<44100;++n){const a=n*2/44100-1;i[n]=(3+e)*a*20*s/(Math.PI+e*Math.abs(a))}return i}stopMusic(){this.musicSource&&this.musicSource.oscs&&this.musicSource.oscs.forEach(e=>{try{e.stop()}catch{}}),this.musicSource=null,this.currentMusic=null}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e)),this.masterGain&&(this.masterGain.gain.value=this.masterVolume)}setMusicVolume(e){this.musicVolume=Math.max(0,Math.min(1,e)),this.musicGain&&(this.musicGain.gain.value=this.musicVolume)}setSfxVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e)),this.sfxGain&&(this.sfxGain.gain.value=this.sfxVolume)}resume(){this.context&&this.context.state==="suspended"&&this.context.resume()}}class oS{constructor(e){this.scene=e,this.particles=[],this.slashTrails=[],this.embers=[],this.dustMotes=[],this.sparkPool=[],this.bloodPool=[],this.wispPool=[],this.ringPool=[],this.POOL_SIZES={spark:60,blood:40,wisp:20,ring:5},this._initSharedAssets(),this._initPools(),this._initEmbers(),this._initDustMotes()}_initSharedAssets(){this.sparkGeo=new mt;const e=new Float32Array([0,.05,0,-.02,0,0,0,-.05,0,.02,0,0,0,.05,0,0,0,.02,0,-.05,0,0,0,-.02]);this.sparkGeo.setAttribute("position",new Je(e,3)),this.bloodGeo=new tu(.06,0),this.emberGeo=new re(.02,4,4),this.wispGeo=new re(.1,8,8),this.playerWispGeo=new re(.15,8,8),this.mistGeo=new re(.2,6,6),this.sparkMat=new B({color:16755268,transparent:!0,opacity:1,side:lt}),this.critSparkMat=new B({color:16777096,transparent:!0,opacity:1,side:lt}),this.bloodMat=new B({color:8912930,transparent:!0,opacity:.9}),this.emberMat=new B({color:16729088,transparent:!0,opacity:.7}),this.wispMat=new B({color:8956671,transparent:!0,opacity:.8,blending:ui}),this.playerSoulMat=new B({color:8965375,transparent:!0,opacity:.9,blending:ui}),this.deathMistMat=new B({color:4456465,transparent:!0,opacity:.7}),this.slashMat=new B({color:6719743,transparent:!0,opacity:.6,side:lt,blending:ui,depthWrite:!1}),this.heavySlashMat=new B({color:16737860,transparent:!0,opacity:.7,side:lt,blending:ui,depthWrite:!1})}_initPools(){for(let e=0;e<this.POOL_SIZES.spark;e++){const t=new w(this.sparkGeo,this.sparkMat);t.visible=!1,t.userData.inPool=!0,this.scene.add(t),this.sparkPool.push(t)}for(let e=0;e<this.POOL_SIZES.blood;e++){const t=new w(this.bloodGeo,this.bloodMat);t.visible=!1,t.userData.inPool=!0,this.scene.add(t),this.bloodPool.push(t)}for(let e=0;e<this.POOL_SIZES.wisp;e++){const t=new w(this.wispGeo,this.wispMat);t.visible=!1,t.userData.inPool=!0,this.scene.add(t),this.wispPool.push(t)}for(let e=0;e<this.POOL_SIZES.ring;e++){const t=new Ki(.1,.3,32),i=new B({color:16763972,transparent:!0,opacity:.8,side:lt,blending:ui,depthWrite:!1}),s=new w(t,i);s.visible=!1,s.userData.inPool=!0,this.scene.add(s),this.ringPool.push(s)}console.log("[ParticleManager] Pools initialized:",{sparks:this.sparkPool.length,blood:this.bloodPool.length,wisps:this.wispPool.length,rings:this.ringPool.length})}_getFromPool(e){for(const t of e)if(t.userData.inPool)return t.userData.inPool=!1,t.visible=!0,t.scale.set(1,1,1),t.rotation.set(0,0,0),t;return null}_returnToPool(e){e.visible=!1,e.userData.inPool=!0}_initEmbers(){for(let t=0;t<30;t++)this._spawnEmber()}_spawnEmber(){const e=new w(this.emberGeo,this.emberMat);e.position.set((Math.random()-.5)*60,Math.random()*.5,(Math.random()-.5)*100-20),this.scene.add(e),this.embers.push({mesh:e,velocity:new T((Math.random()-.5)*.3,.3+Math.random()*.5,(Math.random()-.5)*.3),life:Math.random()*10,maxLife:8+Math.random()*6})}_initDustMotes(){this.dustGeo=new Dt(.03,.03),this.dustMat=new B({color:16777198,transparent:!0,opacity:.4,blending:ui,depthWrite:!1,side:lt});for(let t=0;t<80;t++){const i=new w(this.dustGeo,this.dustMat);i.position.set((Math.random()-.5)*40,.5+Math.random()*5,(Math.random()-.5)*80-20),this.scene.add(i),this.dustMotes.push({mesh:i,baseY:i.position.y,driftSpeed:.1+Math.random()*.2,driftAmplitude:.3+Math.random()*.5,phase:Math.random()*Math.PI*2,rotateSpeed:(Math.random()-.5)*2})}}spawnSlashTrail(e,t,i=!1){const s=i?1.8:1.4,n=i?Math.PI*.7:Math.PI*.5,a=12,o=i?.15:.1,r=new ia;r.moveTo(0,0);for(let p=0;p<=a;p++){const f=-n/2+n*p/a,y=Math.cos(f)*s,m=Math.sin(f)*s;p===0?r.moveTo(y,m):r.lineTo(y,m)}for(let p=a;p>=0;p--){const f=-n/2+n*p/a,y=Math.cos(f)*(s-o),m=Math.sin(f)*(s-o);r.lineTo(y,m)}r.closePath();const c=new Ol(r),h=i?this.heavySlashMat:this.slashMat,d=new w(c,h);d.position.copy(e),d.position.y+=1.2;const u=Math.atan2(t.x,t.z);d.rotation.y=u,d.rotation.x=i?-.5:.2,this.scene.add(d),this.slashTrails.push({mesh:d,life:0,maxLife:i?.35:.25,scaleStart:.3,scaleEnd:1,ownedGeometry:c})}spawnHitSparks(e,t=8,i=!1){const s=i?Math.min(t*2,16):Math.min(t,10);for(let n=0;n<s;n++){const a=this._getFromPool(this.sparkPool);if(!a)continue;a.userData.isCritical=i,a.position.copy(e),a.position.y+=.8+Math.random()*.4;const o=Math.random()*Math.PI*2,r=2+Math.random()*4,c=2+Math.random()*3;this.particles.push({mesh:a,velocity:new T(Math.cos(o)*r,c,Math.sin(o)*r),gravity:-15,life:0,maxLife:.3+Math.random()*.2,type:"spark",pool:this.sparkPool})}}spawnBlood(e,t,i=6){const s=Math.min(i,10);for(let n=0;n<s;n++){const a=this._getFromPool(this.bloodPool);if(!a)continue;a.position.copy(e),a.position.y+=.8+Math.random()*.6;const r=Math.atan2(t.x,t.z)+(Math.random()-.5)*Math.PI*.6,c=3+Math.random()*3,h=1+Math.random()*3;this.particles.push({mesh:a,velocity:new T(Math.sin(r)*c,h,Math.cos(r)*c),gravity:-18,life:0,maxLife:.6+Math.random()*.4,type:"blood",scale:.8+Math.random()*.4,pool:this.bloodPool})}}spawnPostureBreak(e){this.spawnHitSparks(e,12,!0);const t=this._getFromPool(this.ringPool);t&&(t.position.copy(e),t.position.y+=1,t.rotation.x=-Math.PI/2,t.scale.set(1,1,1),this.particles.push({mesh:t,velocity:new T(0,0,0),gravity:0,life:0,maxLife:.5,type:"ring",expandRate:8,pool:this.ringPool}))}spawnBlockSparks(e){for(let i=0;i<5;i++){const s=this._getFromPool(this.sparkPool);if(!s)continue;s.position.copy(e),s.position.y+=1;const n=Math.random()*Math.PI*2,a=1+Math.random()*2;this.particles.push({mesh:s,velocity:new T(Math.cos(n)*a,1+Math.random()*2,Math.sin(n)*a),gravity:-10,life:0,maxLife:.25,type:"spark",isBlock:!0,pool:this.sparkPool})}}spawnDeathBurst(e){for(let t=0;t<6;t++){const i=this._getFromPool(this.bloodPool);if(!i)continue;const s=t/6*Math.PI*2;i.position.copy(e),i.position.y+=1,this.particles.push({mesh:i,velocity:new T(Math.cos(s)*4,2+Math.random()*3,Math.sin(s)*4),gravity:-15,life:0,maxLife:.8,type:"blood",scale:1.2,pool:this.bloodPool})}for(let t=0;t<3;t++){const i=this._getFromPool(this.wispPool);i&&(i.position.copy(e),i.position.y+=.5+Math.random()*.5,i.position.x+=(Math.random()-.5)*.5,i.position.z+=(Math.random()-.5)*.5,this.particles.push({mesh:i,velocity:new T((Math.random()-.5)*.5,2+Math.random()*1,(Math.random()-.5)*.5),gravity:0,life:0,maxLife:1.5+Math.random()*.5,type:"wisp",pool:this.wispPool}))}}update(e){this._updateDeathEffects(e);for(let i=this.particles.length-1;i>=0;i--){const s=this.particles[i];if(s.life+=e,s.velocity.y+=s.gravity*e,s.mesh.position.add(s.velocity.clone().multiplyScalar(e)),s.type==="ring"){const a=1+s.expandRate*s.life;s.mesh.scale.set(a,a,1)}if(s.type==="playerSoul"&&(s.mesh.position.x+=Math.sin(s.life*2)*e*.5,s.mesh.position.z+=Math.cos(s.life*2)*e*.5),s.type==="deathMist"){const a=1+s.life*.5;s.mesh.scale.setScalar(a)}const n=1-s.life/s.maxLife;if(s.scale){const a=s.scale*n;s.mesh.scale.setScalar(Math.max(.1,a))}s.type==="blood"&&s.mesh.position.y<.05&&(s.mesh.position.y=.05,s.velocity.x*=.5,s.velocity.z*=.5,s.velocity.y=0),s.type==="spark"&&(s.mesh.rotation.x+=e*10,s.mesh.rotation.z+=e*8),s.life>=s.maxLife&&(s.pool?this._returnToPool(s.mesh):(this.scene.remove(s.mesh),s.mesh.geometry?.dispose?.()),this.particles.splice(i,1))}for(let i=this.slashTrails.length-1;i>=0;i--){const s=this.slashTrails[i];s.life+=e;const n=s.life/s.maxLife,a=gt.lerp(s.scaleStart,s.scaleEnd,n);if(s.mesh.scale.setScalar(a),s.isAttackArc&&s.rotationSpeed){const o=Math.pow(n,.6);if(s.mesh.rotation.z=s.initialRotationZ+o*s.rotationSpeed,s.material&&n>.4){const c=(n-.4)/.6;s.material.opacity=(1-c)*.85}}s.life>=s.maxLife&&(this.scene.remove(s.mesh),s.ownedGeometry?.dispose(),s.material?.dispose(),this.slashTrails.splice(i,1))}for(let i=this.embers.length-1;i>=0;i--){const s=this.embers[i];s.life+=e,s.mesh.position.add(s.velocity.clone().multiplyScalar(e)),s.mesh.position.x+=Math.sin(s.life*2)*.01,s.mesh.position.z+=Math.cos(s.life*1.5)*.01,s.life>=s.maxLife&&(s.life=0,s.mesh.position.set((Math.random()-.5)*60,Math.random()*.3,(Math.random()-.5)*100-20),s.maxLife=8+Math.random()*6)}const t=Date.now()*.001;for(const i of this.dustMotes)i.mesh.position.y=i.baseY+Math.sin(t*i.driftSpeed+i.phase)*i.driftAmplitude,i.mesh.position.x+=Math.sin(t*.5+i.phase)*.002,i.mesh.position.z+=Math.cos(t*.3+i.phase)*.002,i.mesh.rotation.z+=i.rotateSpeed*e}spawnPlayerDeathEffect(e,t){for(let i=0;i<8;i++){const s=this._getFromPool(this.wispPool);s&&(s.position.copy(e),s.position.y+=.5+Math.random()*.8,s.position.x+=(Math.random()-.5)*.6,s.position.z+=(Math.random()-.5)*.6,this.particles.push({mesh:s,velocity:new T((Math.random()-.5)*1.5,3+Math.random()*2,(Math.random()-.5)*1.5),gravity:-.5,life:0,maxLife:2.5+Math.random()*1.5,type:"playerSoul",pool:this.wispPool}))}for(let i=0;i<10;i++){const s=this._getFromPool(this.bloodPool);if(!s)continue;s.position.copy(e),s.position.y+=Math.random()*1.5;const n=Math.random()*Math.PI*2,a=1+Math.random()*2;this.particles.push({mesh:s,velocity:new T(Math.cos(n)*a,.5+Math.random()*1,Math.sin(n)*a),gravity:-1,life:0,maxLife:2+Math.random()*1,type:"deathMist",scale:1,pool:this.bloodPool})}this._createDeathVignette(t),t&&this._triggerCameraShake(t)}_createDeathVignette(e){const t=new Dt(2,2),i=new Ci({transparent:!0,depthTest:!1,depthWrite:!1,uniforms:{uTime:{value:0},uIntensity:{value:0}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = vec4(position, 1.0);
        }
      `,fragmentShader:`
        varying vec2 vUv;
        uniform float uTime;
        uniform float uIntensity;
        
        void main() {
          vec2 center = vUv - 0.5;
          float dist = length(center) * 1.8;
          
          float vignette = smoothstep(0.3, 1.2, dist);
          vec3 color = mix(vec3(0.0), vec3(0.3, 0.0, 0.0), vignette);
          
          float pulse = sin(uTime * 2.0) * 0.1 + 0.9;
          float alpha = vignette * uIntensity * pulse;
          
          gl_FragColor = vec4(color, alpha * 0.85);
        }
      `}),s=new w(t,i);s.frustumCulled=!1,s.renderOrder=999,this.scene.add(s),this.deathVignette={mesh:s,material:i,life:0,fadeInDuration:.5,holdDuration:2.5,fadeOutDuration:.5}}_triggerCameraShake(e){this.cameraShake||(this.cameraShake={originalPosition:e.position.clone(),intensity:.3,decay:.95,duration:.8,elapsed:0,camera:e})}_updateDeathEffects(e){if(this.deathVignette){const t=this.deathVignette;t.life+=e,t.material.uniforms.uTime.value=t.life;const i=t.fadeInDuration+t.holdDuration+t.fadeOutDuration;if(t.life<t.fadeInDuration)t.material.uniforms.uIntensity.value=t.life/t.fadeInDuration;else if(t.life<t.fadeInDuration+t.holdDuration)t.material.uniforms.uIntensity.value=1;else if(t.life<i){const s=(t.life-t.fadeInDuration-t.holdDuration)/t.fadeOutDuration;t.material.uniforms.uIntensity.value=1-s}else this.scene.remove(t.mesh),t.mesh.geometry.dispose(),t.material.dispose(),this.deathVignette=null}if(this.cameraShake){const t=this.cameraShake;if(t.elapsed+=e,t.elapsed<t.duration){const i=1-t.elapsed/t.duration,s=t.intensity*i;t.camera.position.x+=(Math.random()-.5)*s,t.camera.position.y+=(Math.random()-.5)*s*.5,t.camera.position.z+=(Math.random()-.5)*s}else this.cameraShake=null}}spawnLevelUpEffect(e){for(let i=0;i<20;i++){const s=this._getFromPool(this.sparkPool);if(!s)continue;s.userData.isLevelUp=!0;const n=i/20*Math.PI*2;s.position.copy(e),s.position.y+=1;const a=3+Math.random()*4,o=3+Math.random()*4;this.particles.push({mesh:s,velocity:new T(Math.cos(n)*a,o,Math.sin(n)*a),gravity:-8,life:0,maxLife:.8+Math.random()*.4,type:"spark",isLevelUp:!0,pool:this.sparkPool})}for(let i=0;i<8;i++){const s=this._getFromPool(this.wispPool);s&&(s.position.copy(e),s.position.y+=.2,s.position.x+=(Math.random()-.5)*1.5,s.position.z+=(Math.random()-.5)*1.5,this.particles.push({mesh:s,velocity:new T((Math.random()-.5)*.5,4+Math.random()*2,(Math.random()-.5)*.5),gravity:0,life:0,maxLife:1.5+Math.random()*.5,type:"wisp",isLevelUp:!0,pool:this.wispPool}))}const t=this._getFromPool(this.ringPool);t&&(t.position.copy(e),t.position.y+=.1,t.rotation.x=-Math.PI/2,t.scale.set(.5,.5,1),t.userData.isLevelUp=!0,this.particles.push({mesh:t,velocity:new T(0,0,0),gravity:0,life:0,maxLife:.8,type:"ring",expandRate:12,isLevelUp:!0,pool:this.ringPool}))}spawnDashEffect(e,t){for(let i=0;i<12;i++){const s=this._getFromPool(this.sparkPool);if(!s)continue;s.userData.isDash=!0,s.position.copy(e),s.position.y+=.5+Math.random()*1,s.position.x+=(Math.random()-.5)*.8,s.position.z+=(Math.random()-.5)*.8;const n=t.clone().multiplyScalar(-1),a=(Math.random()-.5)*.5;this.particles.push({mesh:s,velocity:n.clone().multiplyScalar(5+Math.random()*3).add(new T(a,Math.random()*2,a)),gravity:-2,life:0,maxLife:.3+Math.random()*.2,type:"spark",isDash:!0,pool:this.sparkPool})}}spawnParryEffect(e){for(let i=0;i<15;i++){const s=this._getFromPool(this.sparkPool);if(!s)continue;s.userData.isParry=!0,s.position.copy(e),s.position.y+=1.2,s.position.z+=.5;const n=i/15*Math.PI*2,a=4+Math.random()*3;this.particles.push({mesh:s,velocity:new T(Math.cos(n)*a*.5,Math.sin(n)*a,-2),gravity:-6,life:0,maxLife:.4+Math.random()*.2,type:"spark",isParry:!0,pool:this.sparkPool})}const t=this._getFromPool(this.ringPool);t&&(t.position.copy(e),t.position.y+=1.2,t.rotation.x=0,t.rotation.y=0,t.scale.set(.3,.3,1),t.userData.isParry=!0,this.particles.push({mesh:t,velocity:new T(0,0,0),gravity:0,life:0,maxLife:.4,type:"ring",expandRate:8,isParry:!0,pool:this.ringPool}))}spawnWarCryEffect(e){for(let i=0;i<25;i++){const s=this._getFromPool(this.sparkPool);if(!s)continue;s.userData.isWarCry=!0;const n=i/25*Math.PI*2;s.position.copy(e),s.position.y+=.5;const a=.5+Math.random()*.3;s.position.x+=Math.cos(n)*a,s.position.z+=Math.sin(n)*a;const o=5+Math.random()*4;this.particles.push({mesh:s,velocity:new T(Math.cos(n)*o,2+Math.random()*3,Math.sin(n)*o),gravity:-4,life:0,maxLife:.6+Math.random()*.4,type:"spark",isWarCry:!0,pool:this.sparkPool})}for(let i=0;i<6;i++){const s=this._getFromPool(this.wispPool);if(!s)continue;s.userData.isWarCry=!0;const n=i/6*Math.PI*2;s.position.copy(e),s.position.x+=Math.cos(n)*.8,s.position.z+=Math.sin(n)*.8,this.particles.push({mesh:s,velocity:new T(Math.cos(n)*2,5+Math.random()*2,Math.sin(n)*2),gravity:1,life:0,maxLife:1+Math.random()*.5,type:"wisp",isWarCry:!0,pool:this.wispPool})}const t=this._getFromPool(this.ringPool);t&&(t.position.copy(e),t.position.y+=.1,t.rotation.x=-Math.PI/2,t.scale.set(1,1,1),t.userData.isWarCry=!0,this.particles.push({mesh:t,velocity:new T(0,0,0),gravity:0,life:0,maxLife:.6,type:"ring",expandRate:15,isWarCry:!0,pool:this.ringPool}))}spawnAttackArc(e,t,i=!1){const s=i?16737860:8956671,n=i?2:1.6,a=i?Math.PI*.8:Math.PI*.6,o=i?.18:.12,r=i?.35:.22,c=16,h=new ia;for(let m=0;m<=c;m++){const g=-a/2+a*m/c,x=Math.cos(g)*n,v=Math.sin(g)*n;m===0?h.moveTo(x,v):h.lineTo(x,v)}for(let m=c;m>=0;m--){const g=-a/2+a*m/c,x=Math.cos(g)*(n-o),v=Math.sin(g)*(n-o);h.lineTo(x,v)}h.closePath();const d=new Ol(h),u=new B({color:s,transparent:!0,opacity:i?.85:.7,side:lt,blending:ui,depthWrite:!1}),p=new w(d,u);p.position.copy(e),p.position.y+=1.1;const f=Math.atan2(t.x,t.z);p.rotation.y=f,p.rotation.x=i?-.6:.15,p.rotation.z=i?.2:-.1,this.scene.add(p);const y=i?10:6;for(let m=0;m<y;m++){const g=this._getFromPool(this.sparkPool);if(!g)continue;const x=-a/2+a*m/(y-1),v=e.clone();v.y+=1.1;const b=Math.cos(x)*n,_=Math.sin(x)*n;v.x+=b*Math.cos(f)-_*Math.sin(f)*.3,v.z+=b*Math.sin(f)+_*Math.cos(f)*.3,v.y+=_*.7,g.position.copy(v),g.userData.isAttackSpark=!0;const S=i?3:2;this.particles.push({mesh:g,velocity:new T((Math.random()-.5)*S,(Math.random()-.5)*S,(Math.random()-.5)*S),gravity:-8,life:0,maxLife:.2+Math.random()*.15,type:"spark",isAttackSpark:!0,pool:this.sparkPool})}this.slashTrails.push({mesh:p,life:0,maxLife:r,scaleStart:.2,scaleEnd:1,ownedGeometry:d,material:u,isAttackArc:!0,rotationSpeed:i?2.5:4,initialRotationZ:p.rotation.z})}dispose(){this.particles.forEach(e=>{e.pool?this._returnToPool(e.mesh):(this.scene.remove(e.mesh),e.mesh.geometry?.dispose?.())}),this.particles=[],this.slashTrails.forEach(e=>{this.scene.remove(e.mesh),e.ownedGeometry?.dispose()}),this.slashTrails=[],this.embers.forEach(e=>{this.scene.remove(e.mesh)}),this.embers=[],this.dustMotes.forEach(e=>{this.scene.remove(e.mesh)}),this.dustMotes=[],[...this.sparkPool,...this.bloodPool,...this.wispPool,...this.ringPool].forEach(e=>{this.scene.remove(e)}),this.sparkPool=[],this.bloodPool=[],this.wispPool=[],this.ringPool=[],this.sparkGeo?.dispose(),this.bloodGeo?.dispose(),this.emberGeo?.dispose(),this.wispGeo?.dispose(),this.playerWispGeo?.dispose(),this.mistGeo?.dispose(),this.dustGeo?.dispose(),this.sparkMat?.dispose(),this.critSparkMat?.dispose(),this.bloodMat?.dispose(),this.emberMat?.dispose(),this.wispMat?.dispose(),this.playerSoulMat?.dispose(),this.deathMistMat?.dispose(),this.slashMat?.dispose(),this.heavySlashMat?.dispose(),this.dustMat?.dispose()}}class rS{constructor(e){this.camera=e,this.texts=[],this.container=document.createElement("div"),this.container.id="floating-text-container",this.container.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 500;
      overflow: hidden;
    `,document.body.appendChild(this.container)}spawn(e,t,i={}){const{color:s="#00ff88",fontSize:n=18,duration:a=1.5,isLevelUp:o=!1}=i,r=document.createElement("div");r.className="floating-text",r.textContent=e,r.style.cssText=`
      position: absolute;
      font-family: 'Cinzel', serif;
      font-size: ${o?28:n}px;
      font-weight: ${o?"bold":"normal"};
      color: ${s};
      text-shadow: 
        0 0 4px rgba(0,0,0,0.9),
        0 0 8px ${s}44,
        ${o?"0 0 20px "+s+"88":""};
      white-space: nowrap;
      transform: translate(-50%, -50%);
      transition: opacity 0.3s ease-out;
      opacity: 1;
      ${o?"animation: levelUpPulse 0.5s ease-out;":""}
    `,this.container.appendChild(r),this.texts.push({element:r,worldPos:t.clone(),startY:t.y,age:0,duration:a,isLevelUp:o,floatSpeed:o?1.5:2.5})}update(e){const t=window.innerWidth,i=window.innerHeight;for(let s=this.texts.length-1;s>=0;s--){const n=this.texts[s];n.age+=e,n.worldPos.y+=n.floatSpeed*e;const a=n.worldPos.clone().project(this.camera),o=(a.x*.5+.5)*t,r=(-a.y*.5+.5)*i;a.z>1||o<-100||o>t+100||r<-100||r>i+100?n.element.style.display="none":(n.element.style.display="block",n.element.style.left=`${o}px`,n.element.style.top=`${r}px`);const c=n.duration*.6;if(n.age>c){const h=(n.age-c)/(n.duration-c);n.element.style.opacity=1-h}n.age>=n.duration&&(this.container.removeChild(n.element),this.texts.splice(s,1))}}dispose(){this.texts.forEach(e=>{e.element.parentNode&&e.element.parentNode.removeChild(e.element)}),this.texts=[],this.container.parentNode&&this.container.parentNode.removeChild(this.container)}}const Vm=document.createElement("style");Vm.textContent=`
  @keyframes levelUpPulse {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
    50% { transform: translate(-50%, -50%) scale(1.3); }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  }
`;document.head.appendChild(Vm);class lS{constructor(e,t,i,s,n,a){this.scene=e,this.camera=t,this.input=i,this.npcManager=s,this.gm=n,this.audio=a,this.interactionRadius=3,this.approachRadius=6,this.facingSpeed=4,this.nearbyNPC=null,this.activeNPC=null,this.interactionMode=null,this.npcRoles={merchant:{title:"Merchant",action:"Trade",icon:""},blacksmith:{title:"Blacksmith",action:"Forge",icon:""},guard:{title:"Guard",action:"Talk",icon:""},elder:{title:"Elder",action:"Talk",icon:""},villager:{title:"Villager",action:"Talk",icon:""},healer:{title:"Healer",action:"Heal",icon:""}},this._createInteractionUI(),this._createNPCLabels(),this.onShopOpen=null,this.onDialogueOpen=null,console.log("[InteractionManager] Initialized")}_createInteractionUI(){this.promptContainer=document.createElement("div"),this.promptContainer.id="npc-interaction-prompt",this.promptContainer.style.cssText=`
      position: fixed;
      bottom: 200px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      z-index: 150;
      pointer-events: none;
    `,this.promptName=document.createElement("div"),this.promptName.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 18px;
      font-weight: bold;
      color: #ffd088;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.9), 0 0 16px rgba(255, 180, 0, 0.3);
      letter-spacing: 2px;
    `,this.promptContainer.appendChild(this.promptName),this.promptAction=document.createElement("div"),this.promptAction.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 200, 100, 0.4);
      border-radius: 4px;
    `,this.keyIndicator=document.createElement("div"),this.keyIndicator.style.cssText=`
      width: 28px;
      height: 28px;
      background: linear-gradient(145deg, #4a4a4a, #2a2a2a);
      border: 2px solid #666;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Cinzel', serif;
      font-size: 14px;
      font-weight: bold;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    `,this.keyIndicator.textContent="E",this.promptAction.appendChild(this.keyIndicator),this.actionText=document.createElement("div"),this.actionText.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 14px;
      color: #ddd;
      letter-spacing: 1px;
    `,this.promptAction.appendChild(this.actionText),this.promptContainer.appendChild(this.promptAction),document.body.appendChild(this.promptContainer);const e=document.createElement("style");e.textContent=`
      @keyframes interactPromptPulse {
        0%, 100% { transform: translateX(-50%) scale(1); }
        50% { transform: translateX(-50%) scale(1.02); }
      }
      #npc-interaction-prompt.active {
        animation: interactPromptPulse 1.5s ease-in-out infinite;
      }
    `,document.head.appendChild(e)}_createNPCLabels(){this.npcLabels=new Map}_getOrCreateLabel(e){const t=this._getNPCId(e);if(this.npcLabels.has(t))return this.npcLabels.get(t);const i=document.createElement("div");i.className="npc-label",i.style.cssText=`
      position: fixed;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease-out;
    `;const s=this.npcRoles[e.type]||this.npcRoles.villager,n=document.createElement("div");n.className="npc-icon",n.style.cssText=`
      font-size: 16px;
      filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.8));
    `,n.textContent=s.icon,i.appendChild(n);const a=document.createElement("div");return a.className="npc-title",a.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 11px;
      color: #ffdd88;
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.9);
      letter-spacing: 1px;
      white-space: nowrap;
    `,a.textContent=s.title,i.appendChild(a),document.body.appendChild(i),this.npcLabels.set(t,{element:i,npc:e,visible:!1}),this.npcLabels.get(t)}_getNPCId(e){return`npc_${e.position.x.toFixed(0)}_${e.position.z.toFixed(0)}`}_updateLabels(e){const t=this.npcManager.getNPCs();for(const i of t){const s=e.distanceTo(i.position);if(s<this.approachRadius*1.5){const n=this._getOrCreateLabel(i),a=i.position.clone();a.y+=2.8;const o=this._worldToScreen(a);if(o&&o.visible){n.element.style.left=`${o.x}px`,n.element.style.top=`${o.y}px`,n.element.style.transform="translate(-50%, -100%)";const r=this.approachRadius,c=Math.max(0,1-s/r*.6);n.element.style.opacity=c,n.visible=!0}else n.element.style.opacity="0",n.visible=!1}else{const n=this._getNPCId(i);this.npcLabels.has(n)&&(this.npcLabels.get(n).element.style.opacity="0",this.npcLabels.get(n).visible=!1)}}}_worldToScreen(e){const t=e.clone();if(t.project(this.camera),t.z>1)return{visible:!1};const i=(t.x*.5+.5)*window.innerWidth,s=(-(t.y*.5)+.5)*window.innerHeight;return{x:i,y:s,visible:!0}}_findNearestNPC(e){const t=this.npcManager.getNPCs();let i=null,s=this.interactionRadius;for(const n of t){const a=e.distanceTo(n.position);a<s&&(s=a,i=n)}return i}_faceNPCToPlayer(e,t,i){if(!e.mesh)return;const s=t.x-e.position.x,n=t.z-e.position.z,a=Math.atan2(s,n),o=e.mesh.rotation.y;let r=a-o;for(;r>Math.PI;)r-=Math.PI*2;for(;r<-Math.PI;)r+=Math.PI*2;Math.abs(r)>.05&&(e.mesh.rotation.y+=r*this.facingSpeed*i)}_showPrompt(e){const t=this.npcRoles[e.type]||this.npcRoles.villager;this.promptName.textContent=t.title,this.actionText.textContent=t.action,this.promptContainer.style.display="flex",this.promptContainer.classList.add("active")}_hidePrompt(){this.promptContainer.style.display="none",this.promptContainer.classList.remove("active")}_interact(e){if(!this.interactionMode)switch(this.activeNPC=e,this.audio&&this.audio.play("menuSelect",{volume:.4}),e.type){case"merchant":case"blacksmith":case"healer":this._openShop(e);break;default:this._openDialogue(e);break}}_openShop(e){this.interactionMode="shop",this._hidePrompt(),this.onShopOpen?this.onShopOpen(e):this._showPlaceholderMessage(e,"Shop system coming soon!")}_openDialogue(e){if(this.interactionMode="dialogue",this._hidePrompt(),this.onDialogueOpen)this.onDialogueOpen(e);else{const t=this._getGreetings(e),i=t[Math.floor(Math.random()*t.length)];this._showPlaceholderMessage(e,i)}}_getGreetings(e){const t={merchant:["Looking to buy something, traveler?","I have wares if you have coin.","Best prices in the village!"],blacksmith:["Need your blade sharpened?","I forge the finest steel in these lands.","Weapons and armor, made to last."],healer:["You look weary, traveler. Let me help.","Rest and healing, that's what I offer.","The darkness takes its toll. Allow me to mend you."],guard:["Stay vigilant. Enemies lurk beyond the village.","Keep your weapon ready.","The roads aren't safe anymore."],elder:["Ah, a traveler. It's been long since we've had visitors.","The corruption spreads... be careful out there.","Seek the ancient ruins. Answers may lie within."],villager:["Good day to you.","Strange times we live in...","The village is safe, for now.","Have you seen the lights in the ruins at night?"]};return t[e.type]||t.villager}_showPlaceholderMessage(e,t){const i=this.npcRoles[e.type]||this.npcRoles.villager,s=document.createElement("div");s.id="temp-dialogue",s.style.cssText=`
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      max-width: 500px;
      padding: 20px 30px;
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid rgba(255, 200, 100, 0.4);
      border-radius: 8px;
      z-index: 200;
    `;const n=document.createElement("div");n.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 16px;
      font-weight: bold;
      color: #ffd088;
      margin-bottom: 12px;
      letter-spacing: 2px;
    `,n.textContent=`${i.icon} ${i.title}`,s.appendChild(n);const a=document.createElement("div");a.style.cssText=`
      font-family: 'Georgia', serif;
      font-size: 15px;
      color: #ddd;
      line-height: 1.6;
      font-style: italic;
    `,a.textContent=`"${t}"`,s.appendChild(a);const o=document.createElement("div");o.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 11px;
      color: #888;
      margin-top: 16px;
      text-align: center;
    `,o.textContent="Press E or click to close",s.appendChild(o),document.body.appendChild(s);const r=()=>{this.input.consumeBuffer("KeyE"),s.remove(),this.interactionMode=null,this.activeNPC=null,document.removeEventListener("click",r),document.removeEventListener("keydown",c)},c=h=>{(h.code==="KeyE"||h.code==="Escape")&&r()};setTimeout(()=>{document.addEventListener("click",r),document.addEventListener("keydown",c)},100)}closeInteraction(){this.interactionMode=null,this.activeNPC=null;const e=document.getElementById("temp-dialogue");e&&e.remove()}isInteracting(){return this.interactionMode!==null}update(e,t){if(this.interactionMode)return;this._updateLabels(e),this.nearbyNPC=this._findNearestNPC(e);const i=this.npcManager.getNPCs();for(const s of i)e.distanceTo(s.position)<this.approachRadius&&this._faceNPCToPlayer(s,e,t);this.nearbyNPC?(this._showPrompt(this.nearbyNPC),this.input.interact&&this._interact(this.nearbyNPC)):this._hidePrompt()}setShopCallback(e){this.onShopOpen=e}setDialogueCallback(e){this.onDialogueOpen=e}getNearbyNPC(){return this.nearbyNPC}dispose(){this.promptContainer&&this.promptContainer.remove();for(const[,e]of this.npcLabels)e.element.remove();this.npcLabels.clear()}}const $m={common:1,uncommon:1.5,rare:2.5,epic:4},Xm=.5,za={iron_sword:{id:"iron_sword",name:"Iron Sword",type:"equipment",slot:ot.WEAPON,basePrice:150,rarity:qe.COMMON,description:"A sturdy iron blade. Good for beginners.",stats:{damage:10},weaponModel:"sword",levelRequired:1,category:"weapon"},steel_sword:{id:"steel_sword",name:"Steel Sword",type:"equipment",slot:ot.WEAPON,basePrice:350,rarity:qe.UNCOMMON,description:"Tempered steel, sharp and reliable.",stats:{damage:18,critChance:3},weaponModel:"longsword",levelRequired:5,category:"weapon"},knight_blade:{id:"knight_blade",name:"Knight's Blade",type:"equipment",slot:ot.WEAPON,basePrice:800,rarity:qe.RARE,description:"A finely crafted sword bearing a knight's crest.",stats:{damage:25,critChance:5,attackSpeed:5},weaponModel:"longsword",levelRequired:10,category:"weapon"},dark_edge:{id:"dark_edge",name:"Dark Edge",type:"equipment",slot:ot.WEAPON,basePrice:1500,rarity:qe.EPIC,description:"A blade forged in shadow. Hungers for souls.",stats:{damage:35,critChance:8,critDamage:20},weaponModel:"longsword",levelRequired:15,category:"weapon"},hand_axe:{id:"hand_axe",name:"Hand Axe",type:"equipment",slot:ot.WEAPON,basePrice:120,rarity:qe.COMMON,description:"A simple woodcutter turned weapon.",stats:{damage:12},weaponModel:"axe",levelRequired:1,category:"weapon"},battle_axe:{id:"battle_axe",name:"Battle Axe",type:"equipment",slot:ot.WEAPON,basePrice:400,rarity:qe.UNCOMMON,description:"Heavy and brutal. Cleaves through armor.",stats:{damage:22,critDamage:15},weaponModel:"axe",levelRequired:6,category:"weapon"},executioner_axe:{id:"executioner_axe",name:"Executioner's Axe",type:"equipment",slot:ot.WEAPON,basePrice:1200,rarity:qe.RARE,description:"Once used for grim justice. Still eager.",stats:{damage:30,critChance:3,critDamage:25},weaponModel:"axe",levelRequired:12,category:"weapon"},wooden_spear:{id:"wooden_spear",name:"Wooden Spear",type:"equipment",slot:ot.WEAPON,basePrice:80,rarity:qe.COMMON,description:"Simple but effective. Keeps enemies at distance.",stats:{damage:8,attackSpeed:10},weaponModel:"spear",levelRequired:1,category:"weapon"},iron_spear:{id:"iron_spear",name:"Iron Spear",type:"equipment",slot:ot.WEAPON,basePrice:280,rarity:qe.UNCOMMON,description:"Iron-tipped for piercing strikes.",stats:{damage:15,attackSpeed:8},weaponModel:"spear",levelRequired:4,category:"weapon"},halberd:{id:"halberd",name:"Halberd",type:"equipment",slot:ot.WEAPON,basePrice:900,rarity:qe.RARE,description:"Versatile polearm with axe blade and spike.",stats:{damage:26,attackSpeed:5,critChance:4},weaponModel:"spear",levelRequired:11,category:"weapon"},leather_armor:{id:"leather_armor",name:"Leather Armor",type:"equipment",slot:ot.ARMOR,basePrice:100,rarity:qe.COMMON,description:"Light armor for mobility.",stats:{defense:8,stamina:10},levelRequired:1,category:"armor"},chainmail_armor:{id:"chainmail_armor",name:"Chainmail",type:"equipment",slot:ot.ARMOR,basePrice:300,rarity:qe.UNCOMMON,description:"Interlocking metal rings provide solid protection.",stats:{defense:15,health:15},levelRequired:5,category:"armor"},knight_armor:{id:"knight_armor",name:"Knight's Plate",type:"equipment",slot:ot.ARMOR,basePrice:750,rarity:qe.RARE,description:"Full plate armor worn by knights of the realm.",stats:{defense:25,health:30},levelRequired:10,category:"armor"},obsidian_mail:{id:"obsidian_mail",name:"Obsidian Mail",type:"equipment",slot:ot.ARMOR,basePrice:1800,rarity:qe.EPIC,description:"Armor of volcanic glass. Absorbs fire damage.",stats:{defense:35,health:50,fireResist:20},levelRequired:18,category:"armor"},iron_shield:{id:"iron_shield",name:"Iron Shield",type:"equipment",slot:ot.ACCESSORY,basePrice:200,rarity:qe.COMMON,description:"A sturdy shield for blocking attacks.",stats:{defense:12},levelRequired:1,category:"shield"},steel_shield:{id:"steel_shield",name:"Steel Kite Shield",type:"equipment",slot:ot.ACCESSORY,basePrice:450,rarity:qe.UNCOMMON,description:"Large shield offering excellent coverage.",stats:{defense:20,stamina:5},levelRequired:7,category:"shield"},tower_shield:{id:"tower_shield",name:"Tower Shield",type:"equipment",slot:ot.ACCESSORY,basePrice:1e3,rarity:qe.RARE,description:"Massive shield. Nearly impenetrable but heavy.",stats:{defense:35,health:20},levelRequired:13,category:"shield"},health_potion_s:{id:"health_potion_s",name:"Small Health Potion",type:"consumable",itemId:"health-potion",basePrice:50,rarity:qe.COMMON,description:"Restores 50 HP.",effect:{healAmount:50},levelRequired:1,category:"potion"},health_potion_m:{id:"health_potion_m",name:"Medium Health Potion",type:"consumable",itemId:"health-potion-m",basePrice:120,rarity:qe.UNCOMMON,description:"Restores 100 HP.",effect:{healAmount:100},levelRequired:5,category:"potion"},health_potion_l:{id:"health_potion_l",name:"Large Health Potion",type:"consumable",itemId:"health-potion-l",basePrice:250,rarity:qe.RARE,description:"Restores 200 HP.",effect:{healAmount:200},levelRequired:10,category:"potion"},health_potion_xl:{id:"health_potion_xl",name:"Greater Health Potion",type:"consumable",itemId:"health-potion-xl",basePrice:500,rarity:qe.EPIC,description:"Restores 400 HP and grants regen.",effect:{healAmount:400,regen:10},levelRequired:15,category:"potion"},stamina_potion:{id:"stamina_potion",name:"Stamina Potion",type:"consumable",itemId:"stamina-potion",basePrice:40,rarity:qe.COMMON,description:"Restores 75 Stamina.",effect:{staminaAmount:75},levelRequired:1,category:"potion"},stamina_potion_l:{id:"stamina_potion_l",name:"Large Stamina Potion",type:"consumable",itemId:"stamina-potion-l",basePrice:100,rarity:qe.UNCOMMON,description:"Restores 150 Stamina.",effect:{staminaAmount:150},levelRequired:8,category:"potion"},antidote:{id:"antidote",name:"Antidote",type:"consumable",itemId:"antidote",basePrice:75,rarity:qe.COMMON,description:"Cures poison effects.",effect:{curePoison:!0},levelRequired:1,category:"potion"},elixir_of_strength:{id:"elixir_of_strength",name:"Elixir of Strength",type:"consumable",itemId:"elixir-strength",basePrice:300,rarity:qe.RARE,description:"+20% damage for 60 seconds.",effect:{buff:"strength",duration:60},levelRequired:12,category:"potion"},elixir_of_iron:{id:"elixir_of_iron",name:"Elixir of Iron",type:"consumable",itemId:"elixir-iron",basePrice:300,rarity:qe.RARE,description:"+25% defense for 60 seconds.",effect:{buff:"defense",duration:60},levelRequired:12,category:"potion"},torch:{id:"torch",name:"Torch",type:"misc",itemId:"torch",basePrice:15,rarity:qe.COMMON,description:"Lights the way in dark places.",levelRequired:1,category:"misc"},rope:{id:"rope",name:"Rope",type:"misc",itemId:"rope",basePrice:25,rarity:qe.COMMON,description:"Useful for climbing and exploration.",levelRequired:1,category:"misc"},map_fragment:{id:"map_fragment",name:"Map Fragment",type:"misc",itemId:"map-fragment",basePrice:100,rarity:qe.UNCOMMON,description:"Reveals a section of the world map.",levelRequired:3,category:"misc"},rusty_key:{id:"rusty_key",name:"Rusty Key",type:"misc",itemId:"rusty-key",basePrice:150,rarity:qe.UNCOMMON,description:"Opens old locks. Consumable.",levelRequired:1,category:"misc"},skeleton_key:{id:"skeleton_key",name:"Skeleton Key",type:"misc",itemId:"skeleton-key",basePrice:400,rarity:qe.RARE,description:"Opens most locked chests and doors.",levelRequired:8,category:"misc"},homeward_bone:{id:"homeward_bone",name:"Homeward Bone",type:"misc",itemId:"homeward-bone",basePrice:200,rarity:qe.UNCOMMON,description:"Returns you to the last checkpoint.",levelRequired:5,category:"misc"},repair_powder:{id:"repair_powder",name:"Repair Powder",type:"misc",itemId:"repair-powder",basePrice:100,rarity:qe.COMMON,description:"Restores weapon durability.",levelRequired:1,category:"misc"},throwing_knife:{id:"throwing_knife",name:"Throwing Knife",type:"misc",itemId:"throwing-knife",basePrice:30,rarity:qe.COMMON,description:"Deals ranged damage. Stackable.",levelRequired:1,category:"misc"},firebomb:{id:"firebomb",name:"Firebomb",type:"misc",itemId:"firebomb",basePrice:80,rarity:qe.UNCOMMON,description:"Throwable explosive. Deals fire damage.",levelRequired:4,category:"misc"},iron_ore_stack:{id:"iron_ore_stack",name:"Iron Ore",type:"material",materialId:"iron_ore",basePrice:15,rarity:qe.COMMON,description:"Raw iron for forging weapons and armor.",levelRequired:1,category:"material",quantity:1},copper_ore_stack:{id:"copper_ore_stack",name:"Copper Ore",type:"material",materialId:"copper_ore",basePrice:10,rarity:qe.COMMON,description:"Soft metal for basic crafting.",levelRequired:1,category:"material",quantity:1},healing_herb:{id:"healing_herb",name:"Healing Herb",type:"material",materialId:"healing_leaf",basePrice:8,rarity:qe.COMMON,description:"Basic herb for health potions.",levelRequired:1,category:"material",quantity:1},mana_bloom:{id:"mana_bloom",name:"Mana Bloom",type:"material",materialId:"mana_bloom",basePrice:12,rarity:qe.COMMON,description:"Mystical flower for mana potions.",levelRequired:3,category:"material",quantity:1},leather_scrap:{id:"leather_scrap",name:"Leather",type:"material",materialId:"crude_leather",basePrice:10,rarity:qe.COMMON,description:"Basic leather for armor crafting.",levelRequired:1,category:"material",quantity:1},cloth_bundle:{id:"cloth_bundle",name:"Cloth",type:"material",materialId:"cloth",basePrice:6,rarity:qe.COMMON,description:"Fabric for light armor and accessories.",levelRequired:1,category:"material",quantity:1},thread_spool:{id:"thread_spool",name:"Thread",type:"material",materialId:"thread",basePrice:4,rarity:qe.COMMON,description:"For sewing and crafting accessories.",levelRequired:1,category:"material",quantity:1},recipe_health_potion:{id:"recipe_health_potion",name:"Recipe: Health Potion",type:"recipe",recipeId:"health_potion",basePrice:100,rarity:qe.UNCOMMON,description:"Learn to craft Health Potions.",levelRequired:1,category:"recipe"},recipe_mana_potion:{id:"recipe_mana_potion",name:"Recipe: Mana Potion",type:"recipe",recipeId:"mana_potion",basePrice:120,rarity:qe.UNCOMMON,description:"Learn to craft Mana Potions.",levelRequired:5,category:"recipe"},recipe_stamina_potion:{id:"recipe_stamina_potion",name:"Recipe: Stamina Potion",type:"recipe",recipeId:"stamina_potion",basePrice:100,rarity:qe.UNCOMMON,description:"Learn to craft Stamina Potions.",levelRequired:3,category:"recipe"},recipe_iron_sword:{id:"recipe_iron_sword",name:"Recipe: Iron Sword",type:"recipe",recipeId:"iron_sword",basePrice:150,rarity:qe.UNCOMMON,description:"Learn to forge Iron Swords.",levelRequired:3,category:"recipe"},recipe_leather_armor:{id:"recipe_leather_armor",name:"Recipe: Leather Armor",type:"recipe",recipeId:"leather_armor",basePrice:180,rarity:qe.UNCOMMON,description:"Learn to craft Leather Armor.",levelRequired:5,category:"recipe"},recipe_strength_elixir:{id:"recipe_strength_elixir",name:"Recipe: Strength Elixir",type:"recipe",recipeId:"strength_elixir",basePrice:300,rarity:qe.RARE,description:"Learn to brew Strength Elixirs.",levelRequired:10,category:"recipe"}},Md={blacksmith:{title:"Blacksmith",icon:"",greeting:"Need something forged? I have the finest steel in the realm.",farewell:"May your blade strike true.",items:["iron_sword","steel_sword","knight_blade","dark_edge","hand_axe","battle_axe","executioner_axe","wooden_spear","iron_spear","halberd","leather_armor","chainmail_armor","knight_armor","obsidian_mail","iron_shield","steel_shield","tower_shield","repair_powder","iron_ore_stack","copper_ore_stack","leather_scrap","recipe_iron_sword","recipe_leather_armor"],specialStock:{14:["dark_edge","obsidian_mail"]}},healer:{title:"Healer",icon:"",greeting:"Rest your weary soul. I have remedies for all ailments.",farewell:"Go forth, and may these potions keep you whole.",items:["health_potion_s","health_potion_m","health_potion_l","health_potion_xl","stamina_potion","stamina_potion_l","antidote","elixir_of_strength","elixir_of_iron","healing_herb","mana_bloom","recipe_health_potion","recipe_mana_potion","recipe_stamina_potion","recipe_strength_elixir"],specialStock:{10:["elixir_of_strength","elixir_of_iron","recipe_strength_elixir"],15:["health_potion_xl"]}},merchant:{title:"General Merchant",icon:"",greeting:"Welcome, traveler! I have all manner of goods.",farewell:"Safe travels, and come back anytime!",items:["health_potion_s","stamina_potion","torch","rope","map_fragment","rusty_key","skeleton_key","homeward_bone","repair_powder","throwing_knife","firebomb","leather_armor","iron_ore_stack","copper_ore_stack","healing_herb","leather_scrap","cloth_bundle","thread_spool"],specialStock:{5:["homeward_bone","map_fragment"],8:["skeleton_key"]}},elder:{title:"Village Elder",icon:"",greeting:"Ah, a traveler. Perhaps I have something of use...",farewell:"The road ahead is perilous. Be cautious.",items:["map_fragment","skeleton_key","homeward_bone"],specialStock:{}}};function cS(l,e){const t=Md[l];return t?t.items.filter(s=>{const n=za[s];return n?n.levelRequired<=e:!1}):[]}function hS(l,e=!1){const t=l.basePrice||100,i=$m[l.rarity?.id||"common"]||1,s=Math.round(t*i);return e?Math.round(s*Xm):s}class dS{constructor(e,t,i,s){this.gm=e,this.lootManager=t,this.equipmentManager=i,this.audio=s,this.isOpen=!1,this.currentNPC=null,this.activeTab="buy",this.selectedItem=null,this.confirmMode=null,this.container=null,this.overlay=null,this.createUI(),console.log("[ShopManager] Initialized")}createUI(){this.overlay=document.createElement("div"),this.overlay.id="shop-overlay",this.overlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1999;
      display: none;
    `,document.body.appendChild(this.overlay),this.container=document.createElement("div"),this.container.id="shop-ui",this.container.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 800px;
      max-height: 85vh;
      background: linear-gradient(145deg, rgba(20, 18, 15, 0.98), rgba(12, 10, 8, 0.99));
      border: 2px solid rgba(180, 150, 80, 0.5);
      border-radius: 8px;
      color: #ddd;
      font-family: 'Cinzel', 'Georgia', serif;
      display: none;
      z-index: 2000;
      box-shadow: 0 0 60px rgba(0, 0, 0, 0.9), inset 0 0 80px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    `,document.body.appendChild(this.container),this._addStyles()}_addStyles(){if(document.getElementById("shop-ui-styles"))return;const e=document.createElement("style");e.id="shop-ui-styles",e.textContent=`
      #shop-ui .shop-tab {
        flex: 1;
        padding: 14px 20px;
        background: rgba(30, 25, 20, 0.8);
        border: none;
        border-bottom: 3px solid transparent;
        color: #888;
        font-family: 'Cinzel', serif;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        letter-spacing: 2px;
      }
      #shop-ui .shop-tab:hover {
        color: #ccc;
        background: rgba(50, 40, 30, 0.8);
      }
      #shop-ui .shop-tab.active {
        color: #ffd088;
        border-bottom-color: #ffd088;
        background: rgba(40, 35, 25, 0.9);
      }
      #shop-ui .shop-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(100, 80, 50, 0.2);
        border-radius: 4px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      #shop-ui .shop-item:hover {
        background: rgba(40, 35, 25, 0.5);
        border-color: rgba(180, 150, 80, 0.4);
        transform: translateX(4px);
      }
      #shop-ui .shop-item.selected {
        background: rgba(60, 50, 30, 0.6);
        border-color: rgba(255, 200, 100, 0.5);
        box-shadow: 0 0 15px rgba(255, 200, 100, 0.1);
      }
      #shop-ui .shop-btn {
        padding: 10px 24px;
        border: 1px solid rgba(100, 100, 100, 0.4);
        border-radius: 4px;
        background: rgba(40, 40, 50, 0.6);
        color: #aaa;
        font-family: 'Cinzel', serif;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.15s ease;
        letter-spacing: 1px;
      }
      #shop-ui .shop-btn:hover:not(:disabled) {
        background: rgba(60, 60, 70, 0.8);
        color: #fff;
        border-color: rgba(150, 150, 150, 0.5);
      }
      #shop-ui .shop-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      #shop-ui .shop-btn.buy {
        background: rgba(50, 80, 50, 0.6);
        border-color: rgba(100, 200, 100, 0.4);
        color: #8f8;
      }
      #shop-ui .shop-btn.buy:hover:not(:disabled) {
        background: rgba(60, 100, 60, 0.8);
        border-color: rgba(100, 255, 100, 0.5);
      }
      #shop-ui .shop-btn.sell {
        background: rgba(80, 70, 40, 0.6);
        border-color: rgba(200, 170, 80, 0.4);
        color: #ffd088;
      }
      #shop-ui .shop-btn.sell:hover:not(:disabled) {
        background: rgba(100, 85, 50, 0.8);
        border-color: rgba(255, 200, 100, 0.5);
      }
      #shop-ui .confirm-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
      }
      #shop-ui .confirm-box {
        background: rgba(30, 25, 20, 0.98);
        border: 2px solid rgba(255, 200, 100, 0.4);
        border-radius: 8px;
        padding: 30px 40px;
        text-align: center;
        max-width: 400px;
      }
      @keyframes shopSlideIn {
        from { opacity: 0; transform: translate(-50%, -48%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
      }
      #shop-ui.open {
        animation: shopSlideIn 0.25s ease-out forwards;
      }
    `,document.head.appendChild(e)}open(e){const t=this.gm?.timeWeatherGameplay;if(t){const i=this._npcTypeToShopType(e.type);if(!t.isShopOpen(i)){const s=t.getShopHoursText(i);return this._showClosedMessage(e.type,s),!1}}return this.isOpen=!0,this.currentNPC=e,this.activeTab="buy",this.selectedItem=null,this.confirmMode=null,this.overlay.style.display="block",this.container.style.display="block",this.container.classList.add("open"),this.render(),this.audio&&this.audio.play("menuSelect",{volume:.5}),console.log(`[ShopManager] Opened shop for ${e.type}`),!0}_npcTypeToShopType(e){return{merchant:"general_store",blacksmith:"blacksmith",alchemist:"alchemist",healer:"alchemist",innkeeper:"tavern",fence:"black_market"}[e]||"general_store"}_showClosedMessage(e,t){const i={merchant:"The merchant is resting.",blacksmith:"The forge is cold. Come back during work hours.",alchemist:"The alchemist's shop is closed.",healer:"The healer is unavailable.",innkeeper:"The tavern is closed.",fence:"The fence only deals at night..."},s=document.querySelector(".shop-closed-message");s&&s.remove();const n=document.createElement("div");n.className="shop-closed-message",n.innerHTML=`
      <div class="closed-text">${i[e]||"Shop is closed."}</div>
      <div class="closed-hours">Hours: ${t}</div>
    `,n.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, rgba(40, 30, 20, 0.95), rgba(60, 45, 30, 0.9));
      border: 2px solid rgba(180, 140, 80, 0.7);
      border-radius: 8px;
      padding: 20px 30px;
      font-family: 'Cinzel', serif;
      color: #e8d5b0;
      text-align: center;
      z-index: 2000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      animation: shopClosedAppear 0.3s ease-out;
    `;const a=document.createElement("style");a.textContent=`
      @keyframes shopClosedAppear {
        from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      }
      .closed-text { font-size: 16px; margin-bottom: 8px; }
      .closed-hours { font-size: 12px; color: rgba(200, 180, 140, 0.8); }
    `,document.head.appendChild(a),document.body.appendChild(n),setTimeout(()=>n.remove(),3e3),this.audio&&this.audio.play("menuBack",{volume:.3})}close(){this.isOpen=!1,this.currentNPC=null,this.selectedItem=null,this.confirmMode=null,this.overlay.style.display="none",this.container.style.display="none",this.container.classList.remove("open"),this.audio&&this.audio.play("menuBack",{volume:.4}),console.log("[ShopManager] Shop closed")}getMerchantInventory(){const e=this.currentNPC?.type||"merchant";return Md[e]||Md.merchant}getPlayerLevel(){return this.gm?.currentLevel||1}getAvailableItems(){const e=this.currentNPC?.type||"merchant",t=this.getPlayerLevel();return cS(e,t)}getItemPrice(e,t=!1){return hS(e,t)}getPlayerGold(){return this.lootManager.getInventory().gold||0}getSellableItems(){const e=[],t=this.lootManager.getInventory();for(const[i,s]of Object.entries(t.items)){const n=Object.values(Fs).find(a=>a.id===i);if(n&&s>0){const a=this._getItemSellPrice(n);e.push({id:i,name:n.name,type:n.type,quantity:s,sellPrice:a,rarity:qe.COMMON,description:n.description})}}for(const i of this.equipmentManager.inventory){const s=this._getEquipmentSellPrice(i);e.push({id:i.id,name:i.name,type:"equipment",slot:i.slot,quantity:1,sellPrice:s,rarity:i.rarity,stats:i.stats,description:`${i.rarity.name} ${i.slot}`,isEquipment:!0})}return e}_getItemSellPrice(e){return{"health-potion":25,"stamina-potion":20,"iron-ore":10,"dark-shard":30,"bone-fragment":5,"spirit-essence":50}[e.id]||10}_getEquipmentSellPrice(e){const i=Ml[e.baseId]?50:30,s=$m[e.rarity.id]||1;return Math.round(i*s*Xm)}buyItem(e){const t=za[e];if(!t)return!1;const i=this.getItemPrice(t);if(this.getPlayerGold()<i)return this._showNotification("Not enough gold!","error"),!1;if(this.lootManager.addGold(-i),t.type==="equipment"){const n=this._createEquipmentFromShop(t);this.equipmentManager.addToInventory(n)}else if(t.type==="consumable"){const n=t.itemId||t.id.replace(/_/g,"-");this.lootManager.addItem(n,1)}else{const n=t.itemId||t.id.replace(/_/g,"-");this.lootManager.addItem(n,1)}return this.audio&&this.audio.play("itemPickup",{volume:.6}),this._showNotification(`Purchased ${t.name} for ${i} gold`,"success"),this.confirmMode=null,this.selectedItem=null,this.render(),!0}_createEquipmentFromShop(e){return{id:`${e.id}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,baseId:e.id,name:e.name,slot:e.slot,rarity:e.rarity,description:e.description,weaponModel:e.weaponModel||null,stats:{...e.stats}}}sellItem(e,t=!1){let i=0,s="";if(t){const n=this.equipmentManager.inventory.findIndex(o=>o.id===e);if(n===-1)return!1;const a=this.equipmentManager.inventory[n];i=this._getEquipmentSellPrice(a),s=a.name,this.equipmentManager.inventory.splice(n,1),this.equipmentManager.saveEquipment()}else{if((this.lootManager.getInventory().items[e]||0)<=0)return!1;const o=Object.values(Fs).find(r=>r.id===e);if(!o)return!1;i=this._getItemSellPrice(o),s=o.name,this.lootManager.removeItem(e,1)}return this.lootManager.addGold(i),this.audio&&this.audio.play("menuConfirm",{volume:.5}),this._showNotification(`Sold ${s} for ${i} gold`,"success"),this.confirmMode=null,this.selectedItem=null,this.render(),!0}_showNotification(e,t="info"){const i={success:"#4ade80",error:"#f87171",info:"#ffd088"},s=document.createElement("div");if(s.style.cssText=`
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid ${i[t]};
      border-radius: 4px;
      color: ${i[t]};
      font-family: 'Cinzel', serif;
      font-size: 14px;
      z-index: 3000;
      animation: notifFade 2s ease-out forwards;
    `,s.textContent=e,!document.getElementById("shop-notif-anim")){const n=document.createElement("style");n.id="shop-notif-anim",n.textContent=`
        @keyframes notifFade {
          0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
          15% { opacity: 1; transform: translateX(-50%) translateY(0); }
          85% { opacity: 1; transform: translateX(-50%) translateY(0); }
          100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }
      `,document.head.appendChild(n)}document.body.appendChild(s),setTimeout(()=>s.remove(),2e3)}render(){const e=this.getMerchantInventory(),t=this.getPlayerGold();this.container.innerHTML=`
      <!-- Header -->
      <div style="
        background: linear-gradient(90deg, rgba(50, 40, 25, 0.9), rgba(40, 35, 25, 0.95), rgba(50, 40, 25, 0.9));
        padding: 18px 24px;
        border-bottom: 1px solid rgba(180, 150, 80, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <div>
          <h2 style="margin: 0; color: #ffd088; font-size: 22px; text-shadow: 0 0 15px rgba(255, 200, 100, 0.4);">
             ${e.title}
          </h2>
          <p style="margin: 6px 0 0 0; color: #999; font-size: 13px; font-style: italic;">
            "${e.greeting}"
          </p>
        </div>
        <div style="
          display: flex;
          align-items: center;
          gap: 10px;
          background: rgba(0, 0, 0, 0.5);
          padding: 10px 20px;
          border-radius: 4px;
          border: 1px solid rgba(255, 215, 0, 0.3);
        ">
          <span style="font-size: 22px;"></span>
          <span style="color: #ffd700; font-size: 20px; font-weight: bold;">${t.toLocaleString()}</span>
        </div>
      </div>
      
      <!-- Tabs -->
      <div style="display: flex; background: rgba(20, 18, 15, 0.8); border-bottom: 1px solid rgba(80, 70, 50, 0.3);">
        <button class="shop-tab ${this.activeTab==="buy"?"active":""}" data-tab="buy">
           BUY
        </button>
        <button class="shop-tab ${this.activeTab==="sell"?"active":""}" data-tab="sell">
           SELL
        </button>
      </div>
      
      <!-- Content -->
      <div style="padding: 20px; max-height: calc(85vh - 180px); overflow-y: auto;">
        ${this.activeTab==="buy"?this._renderBuyTab(e):this._renderSellTab()}
      </div>
      
      <!-- Footer -->
      <div style="
        padding: 12px 24px;
        background: rgba(15, 12, 10, 0.95);
        border-top: 1px solid rgba(80, 70, 50, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <span style="color: #666; font-size: 12px;">Click item to select  Esc to close</span>
        <button class="shop-btn" id="shop-close-btn">Close</button>
      </div>
      
      ${this.confirmMode?this._renderConfirmDialog():""}
    `,this._attachListeners()}_renderBuyTab(e){const i=this.getAvailableItems().map(n=>za[n]).filter(Boolean),s=this.getPlayerGold();return this.getPlayerLevel(),i.length===0?'<p style="color: #666; text-align: center;">No items available</p>':`
      <div style="display: flex; gap: 20px;">
        <!-- Item list -->
        <div style="flex: 1.2;">
          ${i.map(n=>{const a=this.getItemPrice(n),o=s>=a;return`
              <div class="shop-item ${this.selectedItem?.id===n.id?"selected":""}" 
                   data-item-id="${n.id}" data-action="select-buy"
                   style="border-left: 3px solid ${n.rarity.color};">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: ${n.rarity.color}; font-weight: bold;">${n.name}</span>
                    <span style="color: #666; font-size: 11px; text-transform: uppercase;">${n.type}</span>
                  </div>
                  <div style="color: #888; font-size: 12px; margin-top: 4px;">${n.description}</div>
                  ${n.stats?`<div style="color: #8af; font-size: 11px; margin-top: 4px;">
                    ${Object.entries(n.stats).map(([c,h])=>`+${h} ${this._formatStat(c)}`).join("  ")}
                  </div>`:""}
                </div>
                <div style="text-align: right; min-width: 80px;">
                  <div style="color: ${o?"#ffd700":"#f66"}; font-size: 16px; font-weight: bold;">
                     ${a}
                  </div>
                  ${o?"":'<div style="color: #f66; font-size: 10px;">Not enough</div>'}
                </div>
              </div>
            `}).join("")}
        </div>
        
        <!-- Action panel -->
        <div style="width: 180px;">
          ${this.selectedItem?this._renderBuyPanel():`
            <div style="
              height: 200px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #555;
              text-align: center;
              font-size: 13px;
              border: 1px dashed rgba(100, 80, 50, 0.3);
              border-radius: 4px;
            ">
              Select an item<br>to purchase
            </div>
          `}
        </div>
      </div>
    `}_renderBuyPanel(){const e=za[this.selectedItem.id];if(!e)return"";const t=this.getItemPrice(e),s=this.getPlayerGold()>=t;return`
      <div style="
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid ${e.rarity.color}40;
        border-radius: 4px;
        padding: 16px;
      ">
        <div style="color: ${e.rarity.color}; font-weight: bold; margin-bottom: 10px;">
          ${e.name}
        </div>
        <div style="color: #888; font-size: 12px; margin-bottom: 15px;">
          ${e.description}
        </div>
        ${e.stats?`<div style="color: #8af; font-size: 11px; margin-bottom: 15px; line-height: 1.6;">
          ${Object.entries(e.stats).map(([n,a])=>`<div>+${a} ${this._formatStat(n)}</div>`).join("")}
        </div>`:""}
        <div style="
          color: #ffd700;
          font-size: 18px;
          font-weight: bold;
          text-align: center;
          margin-bottom: 15px;
        ">
           ${t}
        </div>
        <button class="shop-btn buy" 
                data-action="confirm-buy" 
                data-item-id="${e.id}"
                ${s?"":"disabled"}>
          ${s?"Purchase":"Cannot Afford"}
        </button>
      </div>
    `}_renderSellTab(){const e=this.getSellableItems();return e.length===0?`
        <div style="
          text-align: center;
          padding: 60px 20px;
          color: #666;
        ">
          <p style="font-size: 16px;">No items to sell</p>
          <p style="font-size: 12px; margin-top: 10px;">Collect loot from enemies and chests!</p>
        </div>
      `:`
      <div style="display: flex; gap: 20px;">
        <!-- Item list -->
        <div style="flex: 1.2;">
          ${e.map(t=>`
              <div class="shop-item ${this.selectedItem?.id===t.id&&this.activeTab==="sell"?"selected":""}" 
                   data-item-id="${t.id}" 
                   data-is-equipment="${t.isEquipment||!1}"
                   data-action="select-sell"
                   style="border-left: 3px solid ${t.rarity?.color||"#888"};">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: ${t.rarity?.color||"#ccc"}; font-weight: bold;">${t.name}</span>
                    ${t.quantity>1?`<span style="color: #888; font-size: 12px;">x${t.quantity}</span>`:""}
                  </div>
                  <div style="color: #666; font-size: 11px; text-transform: capitalize;">${t.type}</div>
                  ${t.stats?`<div style="color: #8af; font-size: 11px; margin-top: 4px;">
                    ${Object.entries(t.stats).map(([s,n])=>`+${n} ${this._formatStat(s)}`).join("  ")}
                  </div>`:""}
                </div>
                <div style="text-align: right; min-width: 80px;">
                  <div style="color: #ffd700; font-size: 16px; font-weight: bold;">
                     ${t.sellPrice}
                  </div>
                </div>
              </div>
            `).join("")}
        </div>
        
        <!-- Action panel -->
        <div style="width: 180px;">
          ${this.selectedItem&&this.activeTab==="sell"?this._renderSellPanel():`
            <div style="
              height: 200px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #555;
              text-align: center;
              font-size: 13px;
              border: 1px dashed rgba(100, 80, 50, 0.3);
              border-radius: 4px;
            ">
              Select an item<br>to sell
            </div>
          `}
        </div>
      </div>
    `}_renderSellPanel(){const e=this.selectedItem;return e?`
      <div style="
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid ${e.rarity?.color||"#888"}40;
        border-radius: 4px;
        padding: 16px;
      ">
        <div style="color: ${e.rarity?.color||"#ccc"}; font-weight: bold; margin-bottom: 10px;">
          ${e.name}
        </div>
        <div style="color: #888; font-size: 12px; margin-bottom: 15px;">
          ${e.description||e.type}
        </div>
        ${e.stats?`<div style="color: #8af; font-size: 11px; margin-bottom: 15px; line-height: 1.6;">
          ${Object.entries(e.stats).map(([t,i])=>`<div>+${i} ${this._formatStat(t)}</div>`).join("")}
        </div>`:""}
        <div style="
          color: #ffd700;
          font-size: 18px;
          font-weight: bold;
          text-align: center;
          margin-bottom: 15px;
        ">
           ${e.sellPrice}
        </div>
        <button class="shop-btn sell" 
                data-action="confirm-sell" 
                data-item-id="${e.id}"
                data-is-equipment="${e.isEquipment||!1}">
          Sell
        </button>
      </div>
    `:""}_renderConfirmDialog(){const e=this.selectedItem;if(!e)return"";const t=this.confirmMode==="buy",i=t?this.getItemPrice(za[e.id]):e.sellPrice;return`
      <div class="confirm-overlay">
        <div class="confirm-box">
          <h3 style="color: #ffd088; margin: 0 0 20px 0;">
            ${t?"Confirm Purchase":"Confirm Sale"}
          </h3>
          <div style="color: ${e.rarity?.color||"#ccc"}; font-size: 18px; margin-bottom: 10px;">
            ${e.name}
          </div>
          <div style="color: #ffd700; font-size: 24px; margin-bottom: 25px;">
             ${i}
          </div>
          <div style="display: flex; gap: 15px; justify-content: center;">
            <button class="shop-btn ${t?"buy":"sell"}" data-action="confirm-yes">
              ${t?"Buy":"Sell"}
            </button>
            <button class="shop-btn" data-action="confirm-no">
              Cancel
            </button>
          </div>
        </div>
      </div>
    `}_formatStat(e){return{damage:"DMG",defense:"DEF",health:"HP",stamina:"STA",critChance:"CRIT%",critDamage:"CRIT DMG",attackSpeed:"ATK SPD"}[e]||e}_attachListeners(){this.container.querySelectorAll(".shop-tab").forEach(t=>{t.addEventListener("click",()=>{this.activeTab=t.dataset.tab,this.selectedItem=null,this.render(),this.audio&&this.audio.play("menuMove",{volume:.3})})});const e=this.container.querySelector("#shop-close-btn");e&&e.addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",()=>this.close()),this.container.querySelectorAll('[data-action="select-buy"]').forEach(t=>{t.addEventListener("click",()=>{const i=t.dataset.itemId,s=za[i];s&&(this.selectedItem={id:i,...s},this.render(),this.audio&&this.audio.play("menuMove",{volume:.2}))})}),this.container.querySelectorAll('[data-action="select-sell"]').forEach(t=>{t.addEventListener("click",()=>{const i=t.dataset.itemId,s=t.dataset.isEquipment==="true",a=this.getSellableItems().find(o=>o.id===i);a&&(this.selectedItem={...a,isEquipment:s},this.render(),this.audio&&this.audio.play("menuMove",{volume:.2}))})}),this.container.querySelectorAll('[data-action="confirm-buy"]').forEach(t=>{t.addEventListener("click",()=>{this.confirmMode="buy",this.render()})}),this.container.querySelectorAll('[data-action="confirm-sell"]').forEach(t=>{t.addEventListener("click",()=>{this.confirmMode="sell",this.render()})}),this.container.querySelectorAll('[data-action="confirm-yes"]').forEach(t=>{t.addEventListener("click",()=>{this.confirmMode==="buy"?this.buyItem(this.selectedItem.id):this.confirmMode==="sell"&&this.sellItem(this.selectedItem.id,this.selectedItem.isEquipment)})}),this.container.querySelectorAll('[data-action="confirm-no"]').forEach(t=>{t.addEventListener("click",()=>{this.confirmMode=null,this.render(),this.audio&&this.audio.play("menuBack",{volume:.3})})}),this._escHandler=t=>{t.code==="Escape"&&this.isOpen&&(this.confirmMode?(this.confirmMode=null,this.render()):this.close())},document.addEventListener("keydown",this._escHandler)}isShopOpen(){return this.isOpen}dispose(){this._escHandler&&document.removeEventListener("keydown",this._escHandler),this.container&&this.container.remove(),this.overlay&&this.overlay.remove()}}class uS{constructor(e,t,i,s,n){this.scene=e,this.camera=t,this.input=i,this.gm=s,this.audio=n,this.isActive=!1,this.currentNPC=null,this.currentDialogue=null,this.currentLineIndex=0,this.displayedText="",this.fullText="",this.typewriterIndex=0,this.isTyping=!1,this.selectedChoice=0,this.choices=[],this.typeSpeed=30,this.typeTimer=0,this.onShopRequest=null,this.onDialogueEnd=null,this.npcRoles={merchant:{title:"Merchant",icon:"",color:"#ffcc66"},blacksmith:{title:"Blacksmith",icon:"",color:"#ff9966"},guard:{title:"Guard",icon:"",color:"#99ccff"},elder:{title:"Village Elder",icon:"",color:"#cc99ff"},villager:{title:"Villager",icon:"",color:"#aaddaa"},healer:{title:"Healer",icon:"",color:"#66ffcc"}},this._createDialogueUI(),this._boundKeyHandler=this._handleKeyDown.bind(this),this._boundClickHandler=this._handleClick.bind(this),console.log("[DialogueManager] Initialized")}_createDialogueUI(){this.dialogueContainer=document.createElement("div"),this.dialogueContainer.id="dialogue-container",this.dialogueContainer.style.cssText=`
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 800px;
      display: none;
      flex-direction: column;
      z-index: 250;
      pointer-events: auto;
    `,this.headerBar=document.createElement("div"),this.headerBar.style.cssText=`
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: -2px;
      padding-left: 20px;
    `,this.npcPortrait=document.createElement("div"),this.npcPortrait.style.cssText=`
      width: 50px;
      height: 50px;
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid rgba(255, 200, 100, 0.6);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    `,this.headerBar.appendChild(this.npcPortrait),this.namePlate=document.createElement("div"),this.namePlate.style.cssText=`
      padding: 8px 20px;
      background: linear-gradient(180deg, rgba(40, 30, 20, 0.95), rgba(20, 15, 10, 0.95));
      border: 2px solid rgba(255, 200, 100, 0.5);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      font-family: 'Cinzel', serif;
      font-size: 16px;
      font-weight: bold;
      color: #ffd088;
      letter-spacing: 2px;
      text-shadow: 0 0 8px rgba(255, 180, 0, 0.3);
    `,this.headerBar.appendChild(this.namePlate),this.dialogueContainer.appendChild(this.headerBar),this.dialogueBox=document.createElement("div"),this.dialogueBox.style.cssText=`
      background: linear-gradient(180deg, rgba(20, 15, 10, 0.95), rgba(10, 8, 5, 0.98));
      border: 2px solid rgba(255, 200, 100, 0.4);
      border-radius: 8px;
      padding: 24px 30px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8), inset 0 0 60px rgba(0, 0, 0, 0.3);
    `,this.textArea=document.createElement("div"),this.textArea.style.cssText=`
      font-family: 'Georgia', serif;
      font-size: 17px;
      color: #e8e0d0;
      line-height: 1.7;
      min-height: 60px;
      margin-bottom: 16px;
    `,this.dialogueBox.appendChild(this.textArea),this.choicesContainer=document.createElement("div"),this.choicesContainer.style.cssText=`
      display: none;
      flex-direction: column;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 200, 100, 0.2);
    `,this.dialogueBox.appendChild(this.choicesContainer),this.continuePrompt=document.createElement("div"),this.continuePrompt.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
      font-family: 'Cinzel', serif;
      font-size: 12px;
      color: #888;
      letter-spacing: 1px;
    `,this.continueArrow=document.createElement("span"),this.continueArrow.textContent="",this.continueArrow.style.cssText=`
      animation: dialogueArrowBounce 0.8s ease-in-out infinite;
    `,this.continueText=document.createElement("span"),this.continueText.textContent="Click or press SPACE to continue",this.continuePrompt.appendChild(this.continueText),this.continuePrompt.appendChild(this.continueArrow),this.dialogueBox.appendChild(this.continuePrompt),this.dialogueContainer.appendChild(this.dialogueBox),document.body.appendChild(this.dialogueContainer);const e=document.createElement("style");e.textContent=`
      @keyframes dialogueArrowBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(4px); }
      }
      @keyframes dialogueFadeIn {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
      }
      #dialogue-container.visible {
        animation: dialogueFadeIn 0.3s ease-out forwards;
      }
      .dialogue-choice {
        padding: 10px 16px;
        background: rgba(40, 30, 20, 0.8);
        border: 1px solid rgba(255, 200, 100, 0.3);
        border-radius: 4px;
        font-family: 'Georgia', serif;
        font-size: 15px;
        color: #ccc;
        cursor: pointer;
        transition: all 0.15s ease-out;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .dialogue-choice:hover,
      .dialogue-choice.selected {
        background: rgba(80, 60, 30, 0.9);
        border-color: rgba(255, 200, 100, 0.6);
        color: #ffd088;
      }
      .dialogue-choice .choice-key {
        width: 24px;
        height: 24px;
        background: linear-gradient(145deg, #4a4a4a, #2a2a2a);
        border: 2px solid #666;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'Cinzel', serif;
        font-size: 12px;
        font-weight: bold;
        color: #fff;
      }
      .dialogue-choice.selected .choice-key {
        background: linear-gradient(145deg, #665522, #443311);
        border-color: #997744;
      }
    `,document.head.appendChild(e)}_getDialogueData(e){const t={merchant:{greeting:["Welcome, traveler! Looking to lighten your coin purse?","Ah, a customer! I have just the wares you need.","Step right up! Best goods this side of the mountains."],lines:[{text:"I source my goods from traders who brave the old roads. Dangerous work, but profitable.",choices:null},{text:"The corruption's been bad for business... but good for selling weapons, I suppose.",choices:null}],tradePrompt:{text:"So, what'll it be? Care to browse my wares?",choices:[{text:"Let me see what you have.",action:"shop"},{text:"What news do you have?",action:"lore"},{text:"Maybe later.",action:"close"}]},lore:["They say the corruption started in the old ruins to the east. Strange lights at night...","A merchant friend of mine went north last week. Haven't heard from him since.","If you're heading out there, stock up on potions. Trust me."]},blacksmith:{greeting:["*clangs hammer* Oh, a warrior! Let me see that blade of yours.","The forge runs hot today. Good day for crafting.","Steel and iron, that's what I know. What do you need?"],lines:[{text:"This forge has been in my family for three generations. We know our craft.",choices:null},{text:"The corruption's twisted the metals in some areas. Have to be careful what ore I use.",choices:null}],tradePrompt:{text:"Need a new weapon? Or perhaps some armor to protect you out there?",choices:[{text:"Show me your weapons and armor.",action:"shop"},{text:"Tell me about the corruption.",action:"lore"},{text:"I'll come back later.",action:"close"}]},lore:["The old knight's armor... it used to gleam silver. Now it's all rusted and dark. Unnatural.","I once forged a blade from corrupted ore. Had to destroy it. The thing whispered at night.","If you find any ancient weapons out there, bring them to me. I can restore them."]},healer:{greeting:["You carry wounds, traveler. Let me help ease your burden.","The light still shines in dark places. Welcome.","Rest here awhile. You're safe within these walls."],lines:[{text:"I've treated many who returned from the wilds. The corruption leaves its mark on the soul as well as the body.",choices:null},{text:"Herbs grow scarce these days. The tainted land won't yield them anymore.",choices:null}],tradePrompt:{text:"Do you need potions or remedies for your journey?",choices:[{text:"Yes, I need supplies.",action:"shop"},{text:"What can you tell me about the corruption?",action:"lore"},{text:"Thank you, but I must go.",action:"close"}]},lore:["The corruption is not just physical. It feeds on despair, on hopelessness.","There was once a great healer who ventured into the heart of darkness. She never returned.","Keep your spirit strong, traveler. That is the best medicine against what lurks out there."]},guard:{greeting:["Halt! Oh, you're not one of those creatures. Forgive me, traveler.","Stay alert. The night brings dangers.","Another survivor? Good to see. We need all the fighters we can get."],lines:[{text:"We've doubled the watch since the attacks started. Still doesn't feel like enough.",choices:null},{text:"Lost two good men last week to those things. They came right up to the walls.",choices:null}],continuePrompt:{text:"Anything else you need to know?",choices:[{text:"What's the situation outside?",action:"lore"},{text:"Where should I explore?",action:"hints"},{text:"Stay vigilant.",action:"close"}]},lore:["The eastern ruins are crawling with corrupted ones. Strong ones too.","We used to trade with the northern villages. Now the roads are too dangerous.","If you're brave enough to clear out those creatures, we'd all be grateful."],hints:["There's an old cave system to the south. Dangerous, but I've heard of treasure within.","The ancient tower to the northeast... some say a powerful enemy guards it.","Stick to the roads at night if you can. The forests hide things."]},elder:{greeting:["Ah, a traveler from beyond. Come, sit. I have much to tell you.","The winds spoke of your coming. Welcome, warrior.","Young one, you seek answers. I may have some."],lines:[{text:"This corruption... it is not the first time our world has seen such darkness.",choices:null},{text:"Long ago, there were those who could purify the taint. Perhaps that knowledge still exists.",choices:null},{text:"The old texts speak of a source, a heart of darkness. If it could be found...",choices:null}],continuePrompt:{text:"What would you know, traveler?",choices:[{text:"Tell me of the corruption's origin.",action:"lore"},{text:"Where should I seek answers?",action:"hints"},{text:"Thank you for your wisdom.",action:"close"}]},lore:["It began in the ancient places, where the veil between worlds grows thin.","There were once guardians who held back the darkness. They fell, one by one.","The corruption has a will, a hunger. It seeks to consume all life."],hints:["Seek the ancient ruins. The old ones left knowledge there.","There is power in the forgotten places. But also great danger.","The corruption fears the light of the old magic. Find the sacred flames."]},villager:{greeting:["Oh! A stranger... are you friendly?","Welcome to our village. It's not much, but it's home.","Haven't seen an outsider in weeks. Where did you come from?","Careful out there. The world's gone mad."],lines:[{text:"We try to live our lives, but the fear is always there.",choices:null},{text:"My family's been here for generations. We won't leave now.",choices:null},{text:"The guards do their best, but they can't be everywhere.",choices:null}],continuePrompt:{text:"Is there something you wanted to ask?",choices:[{text:"What's life like here?",action:"life"},{text:"Have you seen anything strange?",action:"lore"},{text:"Take care of yourself.",action:"close"}]},life:["We grow what we can, trade with the merchants. It's a simple life.","The children can't play outside the walls anymore. Breaks my heart.","Every night we hear things in the darkness. We try not to listen."],lore:["Lights in the ruins at night. Unnatural, flickering lights.","Old Miller says he saw a figure in black robes near the forest. Just watching.","The well water tastes strange some mornings. We've started boiling everything."]}};return t[e.type]||t.villager}startDialogue(e){if(this.isActive)return;this.isActive=!0,this.currentNPC=e,this.currentDialogue=this._getDialogueData(e),this.currentLineIndex=0,this.selectedChoice=0;const t=this.npcRoles[e.type]||this.npcRoles.villager;this.npcPortrait.textContent=t.icon,this.npcPortrait.style.borderColor=t.color,this.namePlate.textContent=t.title,this.namePlate.style.color=t.color,this.dialogueContainer.style.display="flex",this.dialogueContainer.classList.add("visible");const i=this.currentDialogue.greeting,s=i[Math.floor(Math.random()*i.length)];this._displayLine(s,()=>{this._showPromptWithChoices()}),document.addEventListener("keydown",this._boundKeyHandler),document.addEventListener("click",this._boundClickHandler),this.audio&&this.audio.play("menuSelect",{volume:.3}),console.log("[DialogueManager] Started dialogue with",e.type)}_displayLine(e,t=null){this.fullText=e,this.displayedText="",this.typewriterIndex=0,this.isTyping=!0,this.onLineComplete=t,this.choicesContainer.style.display="none",this.continuePrompt.style.display="flex",this.continuePrompt.style.opacity="0.3",this.continueText.textContent="Click or press SPACE to skip",this._typewriterTick()}_typewriterTick(){this.isTyping&&(this.typewriterIndex<this.fullText.length?(this.displayedText+=this.fullText[this.typewriterIndex],this.textArea.innerHTML=`"${this.displayedText}<span style="opacity: 0.5">|</span>"`,this.typewriterIndex++,this.audio&&this.typewriterIndex%3,setTimeout(()=>this._typewriterTick(),this.typeSpeed)):this._finishTyping())}_skipTypewriter(){this.isTyping&&(this.isTyping=!1,this.displayedText=this.fullText,this.textArea.innerHTML=`"${this.displayedText}"`,this._finishTyping())}_finishTyping(){this.isTyping=!1,this.textArea.innerHTML=`"${this.fullText}"`,this.continuePrompt.style.opacity="1",this.choices&&this.choices.length>0?(this.continuePrompt.style.display="none",this._renderChoices()):this.continueText.textContent="Click or press SPACE to continue",this.onLineComplete}_showPromptWithChoices(){const e=this.currentDialogue.tradePrompt||this.currentDialogue.continuePrompt;e?(this.choices=e.choices,this._displayLine(e.text)):this._showRandomLine()}_showRandomLine(){if(this.currentDialogue.lines&&this.currentDialogue.lines.length>0){const e=this.currentDialogue.lines[Math.floor(Math.random()*this.currentDialogue.lines.length)];this.choices=e.choices,this._displayLine(e.text)}else this._showPromptWithChoices()}_showLoreDialogue(){const e=this.currentDialogue.lore;if(e&&e.length>0){const t=e[Math.floor(Math.random()*e.length)];this.choices=null,this._displayLine(t,()=>{setTimeout(()=>this._showPromptWithChoices(),500)})}else this._showPromptWithChoices()}_showHintsDialogue(){const e=this.currentDialogue.hints;if(e&&e.length>0){const t=e[Math.floor(Math.random()*e.length)];this.choices=null,this._displayLine(t,()=>{setTimeout(()=>this._showPromptWithChoices(),500)})}else this._showPromptWithChoices()}_showLifeDialogue(){const e=this.currentDialogue.life;if(e&&e.length>0){const t=e[Math.floor(Math.random()*e.length)];this.choices=null,this._displayLine(t,()=>{setTimeout(()=>this._showPromptWithChoices(),500)})}else this._showPromptWithChoices()}_renderChoices(){if(!this.choices||this.choices.length===0){this.choicesContainer.style.display="none";return}this.choicesContainer.innerHTML="",this.choicesContainer.style.display="flex",this.choices.forEach((e,t)=>{const i=document.createElement("div");i.className="dialogue-choice"+(t===this.selectedChoice?" selected":"");const s=document.createElement("span");s.className="choice-key",s.textContent=(t+1).toString(),i.appendChild(s);const n=document.createElement("span");n.textContent=e.text,i.appendChild(n),i.addEventListener("click",a=>{a.stopPropagation(),this.selectedChoice=t,this._selectChoice()}),i.addEventListener("mouseenter",()=>{this.selectedChoice=t,this._updateChoiceSelection()}),this.choicesContainer.appendChild(i)})}_updateChoiceSelection(){this.choicesContainer.querySelectorAll(".dialogue-choice").forEach((t,i)=>{t.classList.toggle("selected",i===this.selectedChoice)})}_selectChoice(){if(!this.choices||this.choices.length===0)return;const e=this.choices[this.selectedChoice];switch(this.audio&&this.audio.play("menuSelect",{volume:.4}),e.action){case"shop":this._requestShop();break;case"lore":this._showLoreDialogue();break;case"hints":this._showHintsDialogue();break;case"life":this._showLifeDialogue();break;case"close":this.endDialogue();break;default:this._showRandomLine()}}_requestShop(){this._displayLine("Let me show you what I have...",()=>{setTimeout(()=>{this.onShopRequest&&this.onShopRequest(this.currentNPC),this.endDialogue(!0)},300)})}_handleKeyDown(e){if(this.isActive){if(e.key>="1"&&e.key<="9"){const t=parseInt(e.key)-1;if(this.choices&&t<this.choices.length){e.preventDefault(),this.selectedChoice=t,this._selectChoice();return}}switch(e.code){case"Space":case"Enter":case"KeyE":e.preventDefault(),this.isTyping?this._skipTypewriter():this.choices&&this.choices.length>0?this._selectChoice():this.onLineComplete?(this.onLineComplete(),this.onLineComplete=null):this._showPromptWithChoices();break;case"ArrowUp":case"KeyW":e.preventDefault(),this.choices&&this.choices.length>0&&(this.selectedChoice=Math.max(0,this.selectedChoice-1),this._updateChoiceSelection());break;case"ArrowDown":case"KeyS":e.preventDefault(),this.choices&&this.choices.length>0&&(this.selectedChoice=Math.min(this.choices.length-1,this.selectedChoice+1),this._updateChoiceSelection());break;case"Escape":e.preventDefault(),this.endDialogue();break}}}_handleClick(e){if(this.isActive){if(!this.dialogueContainer.contains(e.target)){this.isTyping?this._skipTypewriter():(!this.choices||this.choices.length===0)&&(this.onLineComplete?(this.onLineComplete(),this.onLineComplete=null):this._showPromptWithChoices());return}this.isTyping&&this._skipTypewriter()}}endDialogue(e=!1){this.isActive&&(this.isActive=!1,this.isTyping=!1,this.dialogueContainer.classList.remove("visible"),this.dialogueContainer.style.display="none",document.removeEventListener("keydown",this._boundKeyHandler),document.removeEventListener("click",this._boundClickHandler),!e&&this.audio&&this.audio.play("menuClose",{volume:.3}),this.onDialogueEnd&&this.onDialogueEnd(),this.currentNPC=null,this.currentDialogue=null,this.choices=[],this.onLineComplete=null,console.log("[DialogueManager] Dialogue ended"))}isDialogueActive(){return this.isActive}setShopCallback(e){this.onShopRequest=e}setEndCallback(e){this.onDialogueEnd=e}update(e){}dispose(){this.endDialogue(!0),this.dialogueContainer&&this.dialogueContainer.remove()}}const Pa=4,pS="iron_sword";class fS{constructor(e,t){this.gameManager=e,this.equipmentManager=t,this.activeWeapon=null,this.activeRarity=mi.COMMON,this.quickSlots=[null,null,null,null],this.activeSlot=0,this.isAttacking=!1,this.attackType=null,this.attackProgress=0,this.comboCount=0,this.comboTimer=0,this.lastAttackTime=0,this.isSwitching=!1,this.switchTimer=0,this.switchDuration=.2,this.onAttackStart=null,this.onAttackHit=null,this.onAttackEnd=null,this.loadState(),this.activeWeapon||this.equipWeapon(pS,mi.COMMON,0),console.log("[WeaponManager] Initialized with weapon:",this.activeWeapon?.name)}equipWeapon(e,t=mi.COMMON,i=-1){const s=$c(e);if(!s)return console.warn("[WeaponManager] Unknown weapon:",e),!1;const n={...s,rarity:t,instanceId:`${e}_${Date.now()}`};return i>=0&&i<Pa?(this.quickSlots[i]=n,i===this.activeSlot&&(this.activeWeapon=n,this.activeRarity=t)):(this.activeWeapon=n,this.activeRarity=t,this.quickSlots[this.activeSlot]=n),this.saveState(),this.updateEquipmentBonuses(),console.log(`[WeaponManager] Equipped ${n.name} (${t.name})`),!0}equipFromInventory(e,t=-1){if(!e||e.slot!=="weapon")return!1;const i=e.baseId||e.id,n={common:mi.COMMON,uncommon:mi.UNCOMMON,rare:mi.RARE,epic:mi.EPIC,legendary:mi.LEGENDARY}[e.rarity?.id]||mi.COMMON;return $c(i)?this.equipWeapon(i,n,t):(console.log("[WeaponManager] Creating dynamic weapon entry for:",i),this.equipDynamicWeapon(e,n,t))}equipDynamicWeapon(e,t,i){const n={sword:si.SWORD,longsword:si.SWORD,dagger:si.DAGGER,axe:si.AXE,spear:si.SPEAR,greatsword:si.GREATSWORD}[e.weaponModel]||si.SWORD,a=vi[n.id]||vi.sword,o={id:e.id,name:e.name,category:n,baseDamage:e.stats?.damage||10,baseSpeed:1,baseRange:1,baseCritChance:e.stats?.critChance||5,staminaCost:10,moveset:a,description:e.description||"A weapon.",visualModel:e.weaponModel||"sword",rarity:t,instanceId:e.id,isDynamic:!0};return i>=0&&i<Pa?(this.quickSlots[i]=o,i===this.activeSlot&&(this.activeWeapon=o,this.activeRarity=t)):(this.activeWeapon=o,this.activeRarity=t,this.quickSlots[this.activeSlot]=o),this.saveState(),this.updateEquipmentBonuses(),console.log(`[WeaponManager] Equipped dynamic weapon: ${o.name}`),!0}switchToSlot(e){if(e<0||e>=Pa||e===this.activeSlot||this.isSwitching||this.isAttacking)return;const t=this.quickSlots[e];if(!t){console.log(`[WeaponManager] Slot ${e+1} is empty`);return}this.isSwitching=!0,this.switchTimer=0,setTimeout(()=>{this.activeSlot=e,this.activeWeapon=t,this.activeRarity=t.rarity,this.updateEquipmentBonuses(),this.saveState(),console.log(`[WeaponManager] Switched to: ${t.name}`),this.gameManager.hud&&this.gameManager.hud.showNotification(`Equipped: ${t.name}`,t.rarity.color)},this.switchDuration/2*1e3)}cycleWeapon(){let e=(this.activeSlot+1)%Pa,t=0;for(;!this.quickSlots[e]&&t<Pa;)e=(e+1)%Pa,t++;this.quickSlots[e]&&this.switchToSlot(e)}getDamage(e="light"){if(!this.activeWeapon)return 10;const t=this.getPlayerStats();let i=B1(this.activeWeapon,t,this.activeRarity);const s=this.activeWeapon.moveset[e];return s&&(i*=s.damageMultiplier),this.comboCount>0&&(i*=1+Math.min(this.comboCount*.05,.25)),Math.round(i)}getAttackSpeed(){return this.activeWeapon?z1(this.activeWeapon,this.getPlayerStats()):1}getStaminaCost(e="light"){return this.activeWeapon?F1(this.activeWeapon,e):10}getRange(){return this.activeWeapon?U1(this.activeWeapon):1}getCritChance(e="light"){return this.activeWeapon?G1(this.activeWeapon,this.getPlayerStats(),this.activeRarity,e):5}getAttackInfo(e="light"){return this.activeWeapon&&this.activeWeapon.moveset[e]||null}rollCrit(e="light"){const t=this.getCritChance(e);return Math.random()*100<t}getPlayerStats(){if(this.gameManager&&this.gameManager.stats){const e=this.gameManager.stats;return{STR:e.strength||10,DEX:e.dexterity||10,VIT:e.vitality||10,END:e.endurance||10,LCK:e.luck||10}}return{STR:10,DEX:10,VIT:10,END:10,LCK:10}}updateEquipmentBonuses(){if(!this.gameManager)return;const e=this.getDamage("light"),t=this.getCritChance("light");this.gameManager.weaponDamage=e,this.gameManager.weaponCritChance=t,this.gameManager.weaponRange=this.getRange(),this.gameManager.weaponSpeed=this.getAttackSpeed()}startAttack(e="light"){if(this.isAttacking||this.isSwitching||!this.activeWeapon)return!1;const t=this.getAttackInfo(e);if(!t)return!1;const i=this.getStaminaCost(e);if(this.gameManager&&this.gameManager.stamina<i)return console.log("[WeaponManager] Not enough stamina"),!1;const s=Date.now();return t.canCombo&&this.comboTimer>0&&this.attackType==="light"?this.comboCount++:this.comboCount=0,this.isAttacking=!0,this.attackType=e,this.attackProgress=0,this.lastAttackTime=s,this.gameManager&&(this.gameManager.stamina-=i),this.onAttackStart&&this.onAttackStart({weapon:this.activeWeapon,attackType:e,attackInfo:t,comboCount:this.comboCount}),!0}update(e){if(this.isSwitching&&(this.switchTimer+=e,this.switchTimer>=this.switchDuration&&(this.isSwitching=!1)),this.comboTimer>0&&(this.comboTimer-=e,this.comboTimer<=0&&(this.comboCount=0)),this.isAttacking){const t=this.getAttackInfo(this.attackType);if(!t)return this.isAttacking=!1,null;const i=this.getAttackSpeed(),s=t.duration/i;this.attackProgress+=e;const n=t.windupTime/i,a=this.attackProgress-e<n,o=this.attackProgress>=n;if(a&&o){const r=this.calculateHitData();return t.canCombo&&(this.comboTimer=t.comboWindow/i),this.onAttackHit&&this.onAttackHit(r),r}this.attackProgress>=s&&(this.isAttacking=!1,this.attackType=null,this.onAttackEnd&&this.onAttackEnd())}return null}calculateHitData(){const e=this.getAttackInfo(this.attackType),t=this.rollCrit(this.attackType);let i=this.getDamage(this.attackType);return t&&(i*=1.5),{damage:Math.round(i),isCrit:t,attackType:this.attackType,weapon:this.activeWeapon,hitboxWidth:e.hitboxWidth*this.getRange(),hitboxDepth:e.hitboxDepth*this.getRange(),knockback:e.knockback||0,multiHit:e.multiHit||1,piercing:e.piercing||!1,areaAttack:e.areaAttack||!1,groundPound:e.groundPound||!1,stagger:e.stagger||!1,specialEffect:this.activeWeapon.specialEffect||null,comboCount:this.comboCount}}cancelAttack(){this.isAttacking&&(this.isAttacking=!1,this.attackType=null,this.attackProgress=0,this.comboCount=0,this.comboTimer=0)}getAttackProgress(){if(!this.isAttacking)return 0;const e=this.getAttackInfo(this.attackType);if(!e)return 0;const t=e.duration/this.getAttackSpeed();return Math.min(this.attackProgress/t,1)}getActiveWeaponInfo(){return this.activeWeapon?{name:this.activeWeapon.name,category:this.activeWeapon.category.name,categoryIcon:this.activeWeapon.category.icon,damage:this.getDamage("light"),heavyDamage:this.getDamage("heavy"),speed:this.getAttackSpeed(),range:this.getRange(),critChance:this.getCritChance("light"),staminaCost:this.getStaminaCost("light"),heavyStaminaCost:this.getStaminaCost("heavy"),rarity:this.activeRarity,description:this.activeWeapon.description,specialEffect:this.activeWeapon.specialEffect||null,lightAttack:this.activeWeapon.moveset.light.name,heavyAttack:this.activeWeapon.moveset.heavy.name}:{name:"Unarmed",category:"None",damage:5,speed:1,range:.5,critChance:0,rarity:mi.COMMON}}getQuickSlotsInfo(){return this.quickSlots.map((e,t)=>e?{slot:t+1,empty:!1,name:e.name,category:e.category.icon,rarity:e.rarity,isActive:t===this.activeSlot}:{slot:t+1,empty:!0})}saveState(){const e={activeSlot:this.activeSlot,quickSlots:this.quickSlots.map(t=>t?{id:t.id,rarityId:t.rarity.id,instanceId:t.instanceId,isDynamic:t.isDynamic||!1,...t.isDynamic?{name:t.name,baseDamage:t.baseDamage,baseCritChance:t.baseCritChance,visualModel:t.visualModel,categoryId:t.category.id}:{}}:null)};localStorage.setItem("ashen_weapons",JSON.stringify(e))}loadState(){try{const e=localStorage.getItem("ashen_weapons");if(!e)return;const t=JSON.parse(e);this.activeSlot=t.activeSlot||0,t.quickSlots&&t.quickSlots.forEach((i,s)=>{if(!i)return;const n=Object.values(mi).find(a=>a.id===i.rarityId)||mi.COMMON;if(i.isDynamic){const a=Object.values(si).find(r=>r.id===i.categoryId)||si.SWORD,o={id:i.id,name:i.name,category:a,baseDamage:i.baseDamage,baseCritChance:i.baseCritChance,visualModel:i.visualModel,moveset:vi[a.id]||vi.sword,rarity:n,instanceId:i.instanceId,isDynamic:!0,baseSpeed:1,baseRange:1,staminaCost:10};this.quickSlots[s]=o}else{const a=$c(i.id);a&&(this.quickSlots[s]={...a,rarity:n,instanceId:i.instanceId})}}),this.quickSlots[this.activeSlot]&&(this.activeWeapon=this.quickSlots[this.activeSlot],this.activeRarity=this.activeWeapon.rarity),console.log("[WeaponManager] Loaded saved weapon state")}catch(e){console.error("[WeaponManager] Failed to load state:",e)}}debugInfo(){console.log("=== WeaponManager Debug ==="),console.log("Active Weapon:",this.activeWeapon?.name),console.log("Rarity:",this.activeRarity?.name),console.log("Damage (light):",this.getDamage("light")),console.log("Damage (heavy):",this.getDamage("heavy")),console.log("Attack Speed:",this.getAttackSpeed()),console.log("Range:",this.getRange()),console.log("Crit Chance:",this.getCritChance("light")+"%"),console.log("Quick Slots:",this.quickSlots.map(e=>e?.name||"empty"))}}const Ps={IDLE:"idle",WINDUP:"windup",ACTIVE:"active",RECOVERY:"recovery"},An={sword:{pos:new T(.5,.2,.3),rot:new nt(0,0,-Math.PI/6)},axe:{pos:new T(.55,.15,.25),rot:new nt(0,0,-Math.PI/5)},spear:{pos:new T(.4,.4,.2),rot:new nt(-Math.PI/8,0,-Math.PI/4)},dagger:{pos:new T(.4,.1,.35),rot:new nt(0,0,-Math.PI/8)},greatsword:{pos:new T(.6,.1,.2),rot:new nt(0,-Math.PI/6,-Math.PI/5)}},Da={sword:{light:{name:"Horizontal Slash",windup:{pos:new T(.7,.6,-.2),rot:new nt(0,Math.PI/4,-Math.PI/2)},active:{pos:new T(-.4,.4,.6),rot:new nt(0,-Math.PI/3,Math.PI/4)},recovery:{pos:new T(.3,.3,.4),rot:new nt(0,-Math.PI/6,-Math.PI/8)},trailColor:8965375},heavy:{name:"Overhead Chop",windup:{pos:new T(.2,1.2,-.3),rot:new nt(-Math.PI/3,0,0)},active:{pos:new T(.2,-.2,.8),rot:new nt(Math.PI/4,0,0)},recovery:{pos:new T(.4,.4,.5),rot:new nt(0,0,-Math.PI/6)},trailColor:16746564,screenShake:!0}},axe:{light:{name:"Wide Swing",windup:{pos:new T(.8,.5,-.3),rot:new nt(0,Math.PI/3,-Math.PI/2)},active:{pos:new T(-.5,.3,.7),rot:new nt(0,-Math.PI/2,Math.PI/3)},recovery:{pos:new T(.2,.2,.4),rot:new nt(0,-Math.PI/4,-Math.PI/6)},trailColor:11167283},heavy:{name:"Overhead Slam",windup:{pos:new T(.3,1.4,-.4),rot:new nt(-Math.PI/2.5,0,0)},active:{pos:new T(.2,-.3,.9),rot:new nt(Math.PI/3,0,0)},recovery:{pos:new T(.4,.3,.5),rot:new nt(Math.PI/8,0,-Math.PI/8)},trailColor:16729088,screenShake:!0,groundImpact:!0}},spear:{light:{name:"Forward Thrust",windup:{pos:new T(.3,.4,-.4),rot:new nt(-Math.PI/6,0,-Math.PI/4)},active:{pos:new T(.2,.5,1.2),rot:new nt(0,0,-Math.PI/6)},recovery:{pos:new T(.35,.45,.4),rot:new nt(-Math.PI/10,0,-Math.PI/5)},trailColor:4500223},heavy:{name:"Sweeping Spin",windup:{pos:new T(.8,.5,0),rot:new nt(0,Math.PI/2,-Math.PI/3)},active:{pos:new T(-.6,.5,.4),rot:new nt(0,-Math.PI/2,Math.PI/4)},recovery:{pos:new T(.3,.45,.3),rot:new nt(-Math.PI/8,0,-Math.PI/4)},trailColor:52479,spin:!0}},dagger:{light:{name:"Quick Stab",windup:{pos:new T(.35,.2,-.1),rot:new nt(-Math.PI/8,0,-Math.PI/6)},active:{pos:new T(.3,.3,.7),rot:new nt(0,0,-Math.PI/10)},recovery:{pos:new T(.38,.15,.3),rot:new nt(0,0,-Math.PI/8)},trailColor:13421772},heavy:{name:"Rapid Multi-Stab",windup:{pos:new T(.3,.25,-.1),rot:new nt(-Math.PI/10,0,-Math.PI/8)},active:{pos:new T(.25,.3,.6),rot:new nt(0,0,-Math.PI/12)},recovery:{pos:new T(.35,.12,.32),rot:new nt(0,0,-Math.PI/8)},trailColor:16738047,multiStab:!0,stabCount:4}},greatsword:{light:{name:"Horizontal Sweep",windup:{pos:new T(.9,.6,-.4),rot:new nt(0,Math.PI/3,-Math.PI/2.5)},active:{pos:new T(-.6,.4,.7),rot:new nt(0,-Math.PI/2,Math.PI/3)},recovery:{pos:new T(.3,.3,.4),rot:new nt(0,-Math.PI/4,-Math.PI/6)},trailColor:16763972,screenShake:!0},heavy:{name:"Vertical Slam",windup:{pos:new T(.3,1.6,-.5),rot:new nt(-Math.PI/2.2,0,0)},active:{pos:new T(.2,-.4,1),rot:new nt(Math.PI/2.8,0,0)},recovery:{pos:new T(.5,.2,.5),rot:new nt(Math.PI/10,0,-Math.PI/6)},trailColor:16737792,screenShake:!0,groundImpact:!0}}},Ao={easeOutQuad:l=>l*(2-l),easeInQuad:l=>l*l,easeInOutQuad:l=>l<.5?2*l*l:-1+(4-2*l)*l,easeOutBack:l=>1+2.70158*Math.pow(l-1,3)+1.70158*Math.pow(l-1,2),easeOutElastic:l=>l===0||l===1?l:Math.pow(2,-10*l)*Math.sin((l*10-.75)*(2*Math.PI)/3)+1};class mS{constructor(e,t,i,s){this.equipmentManager=e,this.weaponManager=t,this.particleManager=i,this.cameraController=s,this.state=Ps.IDLE,this.currentWeaponType="sword",this.currentAttackType=null,this.animProgress=0,this.windupDuration=0,this.activeDuration=0,this.recoveryDuration=0,this.totalDuration=0,this.weaponMesh=null,this.trailMesh=null,this.trailPositions=[],this.maxTrailPoints=32,this.trailFadeSpeed=4,this.trailWidth=.15,this.trailSampleRate=.016,this.lastSampleTime=0,this.stabIndex=0,this.stabDirection=1,this.idlePosition=new T,this.idleRotation=new nt,console.log("[AttackAnimator] Initialized")}startAttack(e,t=1){const i=this.weaponManager?.getActiveWeaponInfo();i&&i.category?this.currentWeaponType=i.category.toLowerCase():this.currentWeaponType="sword",Da[this.currentWeaponType]||(this.currentWeaponType="sword"),this.currentAttackType=e,this.state=Ps.WINDUP,this.animProgress=0;const s=this.weaponManager?.getAttackInfo(e);if(s)this.windupDuration=s.windupTime/t,this.activeDuration=(s.duration-s.windupTime-s.recoveryTime)/t,this.recoveryDuration=s.recoveryTime/t;else{const n=e==="heavy";this.windupDuration=n?.25:.08,this.activeDuration=n?.25:.12,this.recoveryDuration=n?.35:.15}if(this.totalDuration=this.windupDuration+this.activeDuration+this.recoveryDuration,this.weaponMesh=this.equipmentManager?.weaponMesh,this.weaponMesh){const n=An[this.currentWeaponType]||An.sword;this.idlePosition.copy(n.pos),this.idleRotation.copy(n.rot)}this.trailPositions=[],this.stabIndex=0,this.stabDirection=1,this._createTrail(),console.log(`[AttackAnimator] Starting ${this.currentWeaponType} ${e} attack`)}update(e){if(this.state===Ps.IDLE){this._updateIdleAnimation(e);return}this.animProgress+=e,this.animProgress<this.windupDuration?(this.state=Ps.WINDUP,this._animateWindup()):this.animProgress<this.windupDuration+this.activeDuration?(this.state=Ps.ACTIVE,this._animateActive()):this.animProgress<this.totalDuration?(this.state=Ps.RECOVERY,this._animateRecovery()):this._finishAnimation(),this._updateTrail(e)}cancel(){this.state=Ps.IDLE,this.currentAttackType=null,this._resetToIdle(),this._removeTrail()}_updateIdleAnimation(e){if(!this.weaponMesh&&(this.weaponMesh=this.equipmentManager?.weaponMesh,!this.weaponMesh))return;const t=Date.now()*.001,i=Math.sin(t*2)*.02,s=Math.sin(t*1.5)*.01,n=this.weaponManager?.getActiveWeaponInfo();n&&n.category&&(this.currentWeaponType=n.category.toLowerCase());const a=An[this.currentWeaponType]||An.sword;this.weaponMesh.position.set(a.pos.x+s,a.pos.y+i,a.pos.z),this.weaponMesh.rotation.set(a.rot.x,a.rot.y+s*.5,a.rot.z)}_animateWindup(){if(!this.weaponMesh)return;const e=Da[this.currentWeaponType]?.[this.currentAttackType];if(!e)return;const t=this.animProgress/this.windupDuration,i=Ao.easeOutQuad(t),s=this.idlePosition,n=this.idleRotation,a=e.windup.pos,o=e.windup.rot;this.weaponMesh.position.lerpVectors(s,a,i),this._lerpEuler(this.weaponMesh.rotation,n,o,i)}_animateActive(){if(!this.weaponMesh)return;const e=Da[this.currentWeaponType]?.[this.currentAttackType];if(!e)return;const t=this.windupDuration,i=(this.animProgress-t)/this.activeDuration,s=Ao.easeInQuad(i),n=e.windup.pos,a=e.windup.rot,o=e.active.pos,r=e.active.rot;if(e.multiStab&&e.stabCount>1){const c=i*e.stabCount,h=c%1;Math.floor(c)%2===0?this.weaponMesh.position.lerpVectors(n,o,Ao.easeInQuad(h)):this.weaponMesh.position.lerpVectors(o,n,Ao.easeOutQuad(h)),this._lerpEuler(this.weaponMesh.rotation,a,r,.5+Math.sin(c*Math.PI)*.3)}else this.weaponMesh.position.lerpVectors(n,o,s),this._lerpEuler(this.weaponMesh.rotation,a,r,s);if(e.screenShake&&i>.7&&i<.8&&this.cameraController&&this.cameraController.shakeLight(),e.groundImpact&&i>.9&&this.particleManager&&!this._groundImpactSpawned){const c=this.equipmentManager?.gameManager?.playerMesh;if(c){const h=c.position.clone();h.y=.1,h.z+=.8,this.particleManager.spawnGroundImpact?.(h,e.trailColor)}this._groundImpactSpawned=!0}this._addTrailPoint()}_animateRecovery(){if(!this.weaponMesh)return;const e=Da[this.currentWeaponType]?.[this.currentAttackType];if(!e)return;const t=this.windupDuration+this.activeDuration,i=(this.animProgress-t)/this.recoveryDuration,s=Ao.easeInOutQuad(i),n=e.active.pos,a=e.active.rot,o=e.recovery.pos,r=e.recovery.rot;this.weaponMesh.position.lerpVectors(n,o,s),this._lerpEuler(this.weaponMesh.rotation,a,r,s)}_finishAnimation(){if(this.state=Ps.IDLE,this.currentAttackType=null,this._groundImpactSpawned=!1,this.weaponMesh){const e=An[this.currentWeaponType]||An.sword;this.weaponMesh.position.copy(e.pos),this.weaponMesh.rotation.copy(e.rot)}this._fadeTrail()}_resetToIdle(){if(!this.weaponMesh)return;const e=An[this.currentWeaponType]||An.sword;this.weaponMesh.position.copy(e.pos),this.weaponMesh.rotation.copy(e.rot)}_lerpEuler(e,t,i,s){e.x=gt.lerp(t.x,i.x,s),e.y=gt.lerp(t.y,i.y,s),e.z=gt.lerp(t.z,i.z,s)}_createTrail(){this.trailMesh&&this._removeTrail();const e=Da[this.currentWeaponType]?.[this.currentAttackType];if(!e)return;const t=new mt,i=this.maxTrailPoints*2,s=new Float32Array(i*3),n=new Float32Array(i*4),a=[];for(let h=0;h<this.maxTrailPoints-1;h++){const d=h*2;a.push(d,d+1,d+2),a.push(d+1,d+3,d+2)}t.setAttribute("position",new Je(s,3)),t.setAttribute("color",new Je(n,4)),t.setIndex(a);const o=new H(e.trailColor||16777215);this.trailColor=o;const r=new B({vertexColors:!0,transparent:!0,side:lt,depthWrite:!1,blending:ui});this.trailMesh=new w(t,r),this.trailMesh.frustumCulled=!1,this.trailMesh.renderOrder=999;const c=this.equipmentManager?.gameManager?.playerMesh;c&&c.parent&&c.parent.add(this.trailMesh),this.lastSampleTime=0}_addTrailPoint(){if(!this.weaponMesh)return;const e=performance.now()/1e3;if(e-this.lastSampleTime<this.trailSampleRate)return;this.lastSampleTime=e;const t=this.equipmentManager?.gameManager?.playerMesh;if(!t)return;const i=new T(0,.5,0),s=new T(0,0,0),n=new ut;n.multiplyMatrices(t.matrixWorld,this.weaponMesh.matrix);const a=i.clone().applyMatrix4(n),o=s.clone().applyMatrix4(n),r=new T().subVectors(a,o).normalize(),c=new T(0,1,0),h=new T().crossVectors(r,c).normalize();for(h.lengthSq()<.01&&h.set(1,0,0),this.trailPositions.push({center:a.clone(),perp:h.clone(),time:e});this.trailPositions.length>this.maxTrailPoints;)this.trailPositions.shift();this._updateTrailGeometry()}_updateTrailGeometry(){if(!this.trailMesh||this.trailPositions.length<2)return;const e=this.trailMesh.geometry.attributes.position.array,t=this.trailMesh.geometry.attributes.color.array,i=this.trailColor||new H(16777215),s=this.trailWidth;for(let n=0;n<this.maxTrailPoints;n++){const a=n*2;if(n<this.trailPositions.length){const o=this.trailPositions[n],r=n/(this.trailPositions.length-1),c=this._smoothstep(0,1,r),h=s*(.2+.8*c),d=o.perp.clone().multiplyScalar(h*.5);e[a*3]=o.center.x+d.x,e[a*3+1]=o.center.y+d.y,e[a*3+2]=o.center.z+d.z,e[(a+1)*3]=o.center.x-d.x,e[(a+1)*3+1]=o.center.y-d.y,e[(a+1)*3+2]=o.center.z-d.z;const u=this._smoothstep(0,.7,r)*this.trailOpacity;t[a*4]=i.r,t[a*4+1]=i.g,t[a*4+2]=i.b,t[a*4+3]=u,t[(a+1)*4]=i.r,t[(a+1)*4+1]=i.g,t[(a+1)*4+2]=i.b,t[(a+1)*4+3]=u}else{const o=this.trailPositions[this.trailPositions.length-1];o&&(e[a*3]=o.center.x,e[a*3+1]=o.center.y,e[a*3+2]=o.center.z,e[(a+1)*3]=o.center.x,e[(a+1)*3+1]=o.center.y,e[(a+1)*3+2]=o.center.z),t[a*4+3]=0,t[(a+1)*4+3]=0}}this.trailMesh.geometry.attributes.position.needsUpdate=!0,this.trailMesh.geometry.attributes.color.needsUpdate=!0,this.trailMesh.geometry.computeBoundingSphere()}_smoothstep(e,t,i){const s=Math.max(0,Math.min(1,(i-e)/(t-e)));return s*s*(3-2*s)}_updateTrail(e){if(this.trailMesh)if(this.trailOpacity===void 0&&(this.trailOpacity=.8),this.state===Ps.ACTIVE)this.trailOpacity=.8;else{if(this.trailOpacity-=e*this.trailFadeSpeed,this.trailPositions.length>0){const t=Math.ceil(e*20);for(let i=0;i<t&&this.trailPositions.length>0;i++)this.trailPositions.shift();this.trailPositions.length>=2&&this._updateTrailGeometry()}(this.trailOpacity<=0||this.trailPositions.length<2)&&this._removeTrail()}}_fadeTrail(){this.trailOpacity=this.trailOpacity||.8}_removeTrail(){this.trailMesh&&(this.trailMesh.parent&&this.trailMesh.parent.remove(this.trailMesh),this.trailMesh.geometry.dispose(),this.trailMesh.material.dispose(),this.trailMesh=null),this.trailPositions=[],this.trailOpacity=.8}get isAnimating(){return this.state!==Ps.IDLE}getCurrentAnimation(){return this.currentAttackType&&Da[this.currentWeaponType]?.[this.currentAttackType]||null}getHitboxInfo(){const e=this.weaponManager?.getAttackInfo(this.currentAttackType);return e?{width:e.hitboxWidth,depth:e.hitboxDepth,knockback:e.knockback||0,piercing:e.piercing||!1,areaAttack:e.areaAttack||!1}:null}}class gS{constructor(e){this.gm=e,this.baseMaxMana=100,this.baseManaRegen=3,this.maxMana=this.baseMaxMana,this.currentMana=this.maxMana,this.manaRegenDelay=1.5,this.manaRegenTimer=0,this.onManaChanged=null,this.onManaInsufficient=null,this._loadMana(),this.recalculateMaxMana()}_loadMana(){try{const e=localStorage.getItem("ashen_mana");if(e){const t=JSON.parse(e);this.currentMana=t.currentMana||this.maxMana}}catch(e){console.warn("[ManaManager] Failed to load mana:",e)}}_saveMana(){try{const e={currentMana:this.currentMana};localStorage.setItem("ashen_mana",JSON.stringify(e))}catch(e){console.warn("[ManaManager] Failed to save mana:",e)}}recalculateMaxMana(){const t=(this.gm.stats?.intelligence||0)*10,i=this.gm.equipmentBonuses?.mana||0;this.maxMana=this.baseMaxMana+t+i,this.currentMana=Math.min(this.currentMana,this.maxMana),this._fireOnManaChanged()}getManaRegenRate(){const t=1+(this.gm.stats?.intelligence||0)*.05;return this.baseManaRegen*t}update(e){if(!this.gm.isDead&&(this.manaRegenTimer+=e,this.manaRegenTimer>=this.manaRegenDelay&&this.currentMana<this.maxMana)){const t=this.getManaRegenRate()*e;this.currentMana=Math.min(this.maxMana,this.currentMana+t),this._fireOnManaChanged()}}canUseMana(e){return this.currentMana>=e?!0:(this.onManaInsufficient&&this.onManaInsufficient(),!1)}useMana(e){return this.canUseMana(e)?(this.currentMana-=e,this.manaRegenTimer=0,this._saveMana(),this._fireOnManaChanged(),!0):!1}restoreMana(e){const t=this.currentMana;return this.currentMana=Math.min(this.maxMana,this.currentMana+e),this.currentMana!==t&&(this._saveMana(),this._fireOnManaChanged()),this.currentMana-t}fullRestore(){this.currentMana=this.maxMana,this._saveMana(),this._fireOnManaChanged()}getManaPercent(){return this.currentMana/this.maxMana}_fireOnManaChanged(){this.onManaChanged&&this.onManaChanged(this.currentMana,this.maxMana)}onRespawn(){this.fullRestore(),this.manaRegenTimer=0}setOnManaChanged(e){this.onManaChanged=e}setOnManaInsufficient(e){this.onManaInsufficient=e}}const oi={OFFENSIVE:"offensive",DEFENSIVE:"defensive",HEALING:"healing",BUFF:"buff"},ii={SELF:"self",ENEMY:"enemy",DIRECTION:"direction",AOE:"aoe",AOE_SELF:"aoe_self"},Ls={FIRE:"fire",LIGHTNING:"lightning",ICE:"ice",ARCANE:"arcane",HOLY:"holy",DARK:"dark"},Qt={fireball:{id:"fireball",name:"Fireball",category:oi.OFFENSIVE,targetType:ii.DIRECTION,damageType:Ls.FIRE,manaCost:25,cooldown:3,castTime:.3,baseDamage:45,range:20,projectileSpeed:18,aoeRadius:3,description:"Hurl a blazing fireball that explodes on impact, dealing fire damage to all nearby enemies.",unlockLevel:1,icon:"",effects:["burn"]},lightningBolt:{id:"lightningBolt",name:"Lightning Bolt",category:oi.OFFENSIVE,targetType:ii.DIRECTION,damageType:Ls.LIGHTNING,manaCost:30,cooldown:4,castTime:.5,baseDamage:60,range:25,projectileSpeed:35,aoeRadius:0,description:"Call down a bolt of lightning that strikes instantly, dealing heavy lightning damage.",unlockLevel:5,icon:"",effects:["stun"]},iceShard:{id:"iceShard",name:"Ice Shard",category:oi.OFFENSIVE,targetType:ii.DIRECTION,damageType:Ls.ICE,manaCost:15,cooldown:1.5,castTime:.2,baseDamage:25,range:18,projectileSpeed:22,aoeRadius:0,description:"Launch a razor-sharp shard of ice. Quick to cast, moderate damage.",unlockLevel:1,icon:"",effects:["slow"]},arcaneMissile:{id:"arcaneMissile",name:"Arcane Missile",category:oi.OFFENSIVE,targetType:ii.DIRECTION,damageType:Ls.ARCANE,manaCost:20,cooldown:2,castTime:.1,baseDamage:35,range:22,projectileSpeed:25,aoeRadius:0,description:"Fire a bolt of pure arcane energy. Fast, reliable, always hits.",unlockLevel:3,icon:"",effects:[]},darkOrb:{id:"darkOrb",name:"Dark Orb",category:oi.OFFENSIVE,targetType:ii.DIRECTION,damageType:Ls.DARK,manaCost:35,cooldown:5,castTime:.8,baseDamage:75,range:15,projectileSpeed:10,aoeRadius:4,description:"Conjure a slow-moving orb of darkness that devastates anything it touches.",unlockLevel:8,icon:"",effects:["weaken"]},flameWave:{id:"flameWave",name:"Flame Wave",category:oi.OFFENSIVE,targetType:ii.AOE_SELF,damageType:Ls.FIRE,manaCost:40,cooldown:6,castTime:.6,baseDamage:55,range:0,projectileSpeed:0,aoeRadius:6,description:"Release a wave of fire in all directions, scorching nearby enemies.",unlockLevel:6,icon:"",effects:["burn"]},spark:{id:"spark",name:"Spark",category:oi.OFFENSIVE,targetType:ii.DIRECTION,damageType:Ls.LIGHTNING,manaCost:8,cooldown:.8,castTime:0,baseDamage:12,range:12,projectileSpeed:30,aoeRadius:0,description:"A quick spark of electricity. Low damage but nearly instant.",unlockLevel:1,icon:"",effects:[]},magicShield:{id:"magicShield",name:"Magic Shield",category:oi.DEFENSIVE,targetType:ii.SELF,damageType:null,manaCost:30,cooldown:15,castTime:.4,baseDamage:0,range:0,projectileSpeed:0,aoeRadius:0,shieldAmount:50,duration:10,description:"Conjure a magical barrier that absorbs incoming damage.",unlockLevel:2,icon:"",effects:["shield"]},ward:{id:"ward",name:"Ward",category:oi.DEFENSIVE,targetType:ii.SELF,damageType:null,manaCost:20,cooldown:8,castTime:.2,baseDamage:0,range:0,projectileSpeed:0,aoeRadius:0,damageReduction:.3,duration:6,description:"Cast a protective ward that reduces all incoming damage.",unlockLevel:4,icon:"",effects:["ward"]},iceArmor:{id:"iceArmor",name:"Ice Armor",category:oi.DEFENSIVE,targetType:ii.SELF,damageType:Ls.ICE,manaCost:35,cooldown:20,castTime:.5,baseDamage:0,range:0,projectileSpeed:0,aoeRadius:0,shieldAmount:40,duration:15,reflectDamage:10,description:"Encase yourself in ice armor. Absorbs damage and hurts melee attackers.",unlockLevel:7,icon:"",effects:["shield","reflect"]},minorHeal:{id:"minorHeal",name:"Minor Heal",category:oi.HEALING,targetType:ii.SELF,damageType:null,manaCost:20,cooldown:5,castTime:.8,baseDamage:0,baseHealing:30,range:0,projectileSpeed:0,aoeRadius:0,description:"Channel healing energy to restore a small amount of health.",unlockLevel:1,icon:"",effects:["heal"]},healSelf:{id:"healSelf",name:"Heal",category:oi.HEALING,targetType:ii.SELF,damageType:null,manaCost:40,cooldown:10,castTime:1.2,baseDamage:0,baseHealing:60,range:0,projectileSpeed:0,aoeRadius:0,description:"A powerful healing spell that restores a significant amount of health.",unlockLevel:5,icon:"",effects:["heal"]},regeneration:{id:"regeneration",name:"Regeneration",category:oi.HEALING,targetType:ii.SELF,damageType:null,manaCost:35,cooldown:20,castTime:.5,baseDamage:0,baseHealing:8,range:0,projectileSpeed:0,aoeRadius:0,duration:15,description:"Gradually restore health over time.",unlockLevel:4,icon:"",effects:["regen"]},lifeSteal:{id:"lifeSteal",name:"Life Steal",category:oi.HEALING,targetType:ii.DIRECTION,damageType:Ls.DARK,manaCost:30,cooldown:8,castTime:.6,baseDamage:25,baseHealing:20,range:15,projectileSpeed:12,aoeRadius:0,description:"Drain life force from an enemy, damaging them and healing yourself.",unlockLevel:9,icon:"",effects:["heal","damage"]},haste:{id:"haste",name:"Haste",category:oi.BUFF,targetType:ii.SELF,damageType:null,manaCost:25,cooldown:30,castTime:.3,baseDamage:0,range:0,projectileSpeed:0,aoeRadius:0,speedBonus:.4,duration:8,description:"Temporarily increase your movement speed.",unlockLevel:3,icon:"",effects:["speed"]},strengthBoost:{id:"strengthBoost",name:"Might",category:oi.BUFF,targetType:ii.SELF,damageType:null,manaCost:30,cooldown:25,castTime:.4,baseDamage:0,range:0,projectileSpeed:0,aoeRadius:0,damageBonus:.5,duration:10,description:"Infuse yourself with magical strength, boosting melee damage.",unlockLevel:4,icon:"",effects:["damage_boost"]},magicBarrier:{id:"magicBarrier",name:"Magic Barrier",category:oi.BUFF,targetType:ii.SELF,damageType:null,manaCost:45,cooldown:40,castTime:.6,baseDamage:0,range:0,projectileSpeed:0,aoeRadius:0,magicResist:.5,duration:12,description:"Create a barrier that greatly reduces incoming magic damage.",unlockLevel:6,icon:"",effects:["magic_resist"]},focus:{id:"focus",name:"Focus",category:oi.BUFF,targetType:ii.SELF,damageType:null,manaCost:20,cooldown:20,castTime:.2,baseDamage:0,range:0,projectileSpeed:0,aoeRadius:0,spellDamageBonus:.35,duration:8,description:"Enter a state of intense focus, increasing spell damage.",unlockLevel:5,icon:"",effects:["spell_boost"]},battleCry:{id:"battleCry",name:"Battle Cry",category:oi.BUFF,targetType:ii.SELF,damageType:null,manaCost:40,cooldown:45,castTime:.3,baseDamage:0,range:0,projectileSpeed:0,aoeRadius:0,damageBonus:.25,speedBonus:.2,attackSpeedBonus:.3,duration:12,description:"A mighty battle cry that boosts all combat abilities temporarily.",unlockLevel:10,icon:"",effects:["damage_boost","speed","attack_speed"]}};function yS(l){return Object.values(Qt).filter(e=>e.category===l)}function Ym(l){return Object.values(Qt).filter(e=>e.unlockLevel<=l)}function vS(){return Ym(1)}function Ul(l,e){if(!l.baseDamage)return 0;const t=1+e*.03;return Math.floor(l.baseDamage*t)}function Yo(l,e,t=0){if(!l.baseHealing)return 0;const s=1+(t>0?(e+t)/2:e)*.03;return Math.floor(l.baseHealing*s)}function Qm(l,e){if(!l.shieldAmount)return 0;const t=1+e*.05;return Math.floor(l.shieldAmount*t)}function jm(l,e){if(!l.duration)return 0;const t=1+e*.02;return l.duration*t}function xS(){return Object.values(Qt).filter(l=>l.unlockLevel>1)}const bS=Object.keys(Qt),nf=Object.freeze(Object.defineProperty({__proto__:null,SPELL_CATEGORIES:oi,SPELL_DAMAGE_TYPE:Ls,SPELL_DATA:Qt,SPELL_IDS:bS,SPELL_TARGET:ii,calculateBuffDuration:jm,calculateShieldAmount:Qm,calculateSpellDamage:Ul,calculateSpellHealing:Yo,default:Qt,getDroppableSpells:xS,getSpellsByCategory:yS,getSpellsForLevel:Ym,getStarterSpells:vS},Symbol.toStringTag,{value:"Module"}));class wS{constructor(e){this.gm=e,this.learnedSpells=new Set,this.hotbarSlots=[null,null,null,null,null,null],this.activeSlot=0,this.cooldowns={},this.activeBuffs={},this.activeShields={},this.activeEffects={},this.effectIdCounter=0,this.onSpellLearned=null,this.onCooldownUpdate=null,this.onHotbarChanged=null,this.onBuffsChanged=null,this.onSpellCast=null,this.onBuffExpired=null,this.onShieldExpired=null,this._loadState(),this.learnedSpells.size===0&&this._initStarterSpells()}_initStarterSpells(){this.learnSpell("spark"),this.learnSpell("minorHeal"),this.equipToHotbar("spark",0),this.equipToHotbar("minorHeal",1),console.log("[SpellManager] Initialized starter spells: Spark, Minor Heal"),this._saveState()}_loadState(){try{const e=localStorage.getItem("ashen_spells");if(e){const t=JSON.parse(e);t.learnedSpells&&(this.learnedSpells=new Set(t.learnedSpells)),t.hotbarSlots&&(this.hotbarSlots=t.hotbarSlots),typeof t.activeSlot=="number"&&(this.activeSlot=t.activeSlot),console.log(`[SpellManager] Loaded ${this.learnedSpells.size} learned spells`)}}catch(e){console.warn("[SpellManager] Failed to load state:",e)}}_saveState(){try{const e={learnedSpells:Array.from(this.learnedSpells),hotbarSlots:this.hotbarSlots,activeSlot:this.activeSlot};localStorage.setItem("ashen_spells",JSON.stringify(e))}catch(e){console.warn("[SpellManager] Failed to save state:",e)}}learnSpell(e){return Qt[e]?this.learnedSpells.has(e)?!1:(this.learnedSpells.add(e),console.log(`[SpellManager] Learned spell: ${Qt[e].name}`),this.onSpellLearned&&this.onSpellLearned(e),this._saveState(),!0):(console.warn(`[SpellManager] Unknown spell: ${e}`),!1)}knowsSpell(e){return this.learnedSpells.has(e)}getLearnedSpells(){return Array.from(this.learnedSpells).filter(e=>Qt[e]).map(e=>Qt[e])}getLearnedSpellsByCategory(e){return this.getLearnedSpells().filter(t=>t.category===e)}equipToHotbar(e,t){if(t<0||t>5)return!1;if(e&&!this.knowsSpell(e))return console.warn(`[SpellManager] Cannot equip unknown spell: ${e}`),!1;if(e){const i=this.hotbarSlots.indexOf(e);i!==-1&&i!==t&&(this.hotbarSlots[i]=null)}return this.hotbarSlots[t]=e,this.onHotbarChanged&&this.onHotbarChanged(this.hotbarSlots),this._saveState(),!0}clearHotbarSlot(e){e<0||e>5||(this.hotbarSlots[e]=null,this.onHotbarChanged&&this.onHotbarChanged(this.hotbarSlots),this._saveState())}selectSlot(e){e<0||e>5||(this.activeSlot=e,this._saveState())}getSelectedSpell(){const e=this.hotbarSlots[this.activeSlot];return e?Qt[e]:null}getSpellInSlot(e){const t=this.hotbarSlots[e];return t?Qt[t]:null}isOnCooldown(e){return(this.cooldowns[e]||0)>0}getCooldownRemaining(e){return this.cooldowns[e]||0}startCooldown(e){const t=Qt[e];t&&(this.cooldowns[e]=t.cooldown)}canCastSpell(e){const t=Qt[e];return t?this.knowsSpell(e)?this.isOnCooldown(e)?{canCast:!1,reason:`On cooldown (${this.getCooldownRemaining(e).toFixed(1)}s)`}:this.gm.manaManager&&!this.gm.manaManager.canUseMana(t.manaCost)?{canCast:!1,reason:"Not enough mana"}:this.gm.isDead?{canCast:!1,reason:"Cannot cast while dead"}:this.gm.isRolling?{canCast:!1,reason:"Cannot cast while dodging"}:this.gm.isAttacking?{canCast:!1,reason:"Cannot cast while attacking"}:{canCast:!0,reason:""}:{canCast:!1,reason:"Spell not learned"}:{canCast:!1,reason:"Unknown spell"}}beginCast(e){const{canCast:t,reason:i}=this.canCastSpell(e);if(!t)return console.log(`[SpellManager] Cannot cast ${e}: ${i}`),!1;const s=Qt[e];return this.gm.manaManager&&this.gm.manaManager.useMana(s.manaCost),this.startCooldown(e),this.onSpellCast&&this.onSpellCast(e,s),console.log(`[SpellManager] Casting: ${s.name}`),!0}getSpellDamage(e){const t=Qt[e];if(!t)return 0;const i=this.gm.stats?.intelligence||0;return Ul(t,i)}getSpellHealing(e){const t=Qt[e];if(!t)return 0;const i=this.gm.stats?.intelligence||0,s=this.gm.stats?.wisdom||0;return Yo(t,i,s)}getShieldAmount(e){const t=Qt[e];if(!t)return 0;const i=this.gm.stats?.intelligence||0;return Qm(t,i)}getBuffDuration(e){const t=Qt[e];if(!t)return 0;const i=this.gm.stats?.intelligence||0;return jm(t,i)}applyBuff(e){const t=Qt[e];if(!t||!t.duration)return;const i=this.getBuffDuration(e);this.activeBuffs[e]={timeRemaining:i,spell:t},console.log(`[SpellManager] Buff applied: ${t.name} for ${i.toFixed(1)}s`),this.onBuffsChanged&&this.onBuffsChanged(this.activeBuffs)}applyShield(e){const t=Qt[e];if(!t)return;const i=this.getShieldAmount(e),s=t.duration||10;this.activeShields[e]={remainingShield:i,timeRemaining:s,spell:t},console.log(`[SpellManager] Shield applied: ${t.name} (${i} HP, ${s}s)`),this.onBuffsChanged&&this.onBuffsChanged(this.activeBuffs)}getActiveBuff(e){return this.activeBuffs[e]||null}isBuffActive(e){return!!this.activeBuffs[e]}getTotalShieldAmount(){let e=0;for(const t of Object.values(this.activeShields))e+=t.remainingShield;return e}absorbDamage(e){let t=e;const i=[];for(const[s,n]of Object.entries(this.activeShields))if(n.remainingShield>0&&t>0){const a=Math.min(n.remainingShield,t);n.remainingShield-=a,t-=a,console.log(`[SpellManager] Shield absorbed ${a} damage`),n.remainingShield<=0&&(i.push(s),delete this.activeShields[s],console.log(`[SpellManager] Shield broken: ${Qt[s]?.name}`))}for(const s of i)this.onShieldExpired&&this.onShieldExpired(s);return this.onBuffsChanged&&this.onBuffsChanged(this.activeBuffs),t}getDamageBonus(){let e=1;for(const t of Object.values(this.activeBuffs))t.spell.damageBonus&&(e+=t.spell.damageBonus);return e}getSpellDamageBonus(){let e=1;for(const t of Object.values(this.activeBuffs))t.spell.spellDamageBonus&&(e+=t.spell.spellDamageBonus);return e}getSpeedBonus(){let e=1;for(const t of Object.values(this.activeBuffs))t.spell.speedBonus&&(e+=t.spell.speedBonus);return e}getDamageReduction(){let e=0;for(const t of Object.values(this.activeBuffs))t.spell.damageReduction&&(e=Math.max(e,t.spell.damageReduction));return e}update(e){for(const n in this.cooldowns)if(this.cooldowns[n]-=e,this.cooldowns[n]<=0&&delete this.cooldowns[n],this.onCooldownUpdate){const a=this.hotbarSlots.indexOf(n);if(a!==-1){const o=Qt[n];this.onCooldownUpdate(a,this.cooldowns[n]||0,o?.cooldown||0)}}let t=!1;const i=[];for(const n in this.activeBuffs)this.activeBuffs[n].timeRemaining-=e,this.activeBuffs[n].timeRemaining<=0&&(console.log(`[SpellManager] Buff expired: ${Qt[n]?.name}`),i.push(n),delete this.activeBuffs[n],t=!0);const s=[];for(const n in this.activeShields)this.activeShields[n].timeRemaining-=e,this.activeShields[n].timeRemaining<=0&&(console.log(`[SpellManager] Shield timed out: ${Qt[n]?.name}`),s.push(n),delete this.activeShields[n],t=!0);for(const n of i)this.onBuffExpired&&this.onBuffExpired(n);for(const n of s)this.onShieldExpired&&this.onShieldExpired(n);t&&this.onBuffsChanged&&this.onBuffsChanged(this.activeBuffs),this._updateEffects(e)}_updateEffects(e){for(const t in this.activeEffects){const i=this.activeEffects[t];i.nextTick-=e,i.nextTick<=0&&(i.type==="heal"?this.gm.heal(i.tickDamage):i.type,i.ticksRemaining--,i.nextTick=i.tickInterval,i.ticksRemaining<=0&&delete this.activeEffects[t])}}applyRegen(e,t){const i=++this.effectIdCounter;this.activeEffects[i]={type:"heal",tickDamage:e,ticksRemaining:Math.floor(t),tickInterval:1,nextTick:1},console.log(`[SpellManager] Regen applied: ${e}/s for ${t}s`)}clearAllEffects(){for(const e of Object.keys(this.activeBuffs))this.onBuffExpired&&this.onBuffExpired(e);for(const e of Object.keys(this.activeShields))this.onShieldExpired&&this.onShieldExpired(e);this.activeBuffs={},this.activeShields={},this.activeEffects={},this.onBuffsChanged&&this.onBuffsChanged(this.activeBuffs)}resetCooldowns(){this.cooldowns={}}getSpellsUnlockedAtLevel(e){return Object.values(Qt).filter(t=>t.unlockLevel===e&&!this.knowsSpell(t.id))}setOnSpellLearned(e){this.onSpellLearned=e}setOnCooldownUpdate(e){this.onCooldownUpdate=e}setOnHotbarChanged(e){this.onHotbarChanged=e}setOnBuffsChanged(e){this.onBuffsChanged=e}setOnSpellCast(e){this.onSpellCast=e}}class _S{constructor(e,t,i,s){this.gm=e,this.spellManager=t,this.particleManager=i,this.audioManager=s,this.scene=null,this.player=null,this.enemyManager=null,this.isCasting=!1,this.currentCastSpell=null,this.castTimer=0,this.castDuration=0,this.projectiles=[],this.projectileIdCounter=0,this.activeAOEs=[],this.aoeIdCounter=0,this.castingGlow=null,this.castingEffectId=null,this.spellEffects=null,this.onCastStart=null,this.onCastComplete=null,this.onCastInterrupt=null,this.onSpellHit=null}setScene(e){this.scene=e}setPlayer(e){this.player=e}setEnemyManager(e){this.enemyManager=e}castSpell(e){const t=Qt[e];return t?this.isCasting?(console.log("[SpellCaster] Already casting"),!1):this.spellManager.beginCast(e)?(t.castTime>0?(this.isCasting=!0,this.currentCastSpell=t,this.castTimer=0,this.castDuration=t.castTime,this._startCastingVisual(),this.onCastStart&&this.onCastStart(t),this.audioManager&&this.audioManager.play("spell_charge",{volume:.4}),console.log(`[SpellCaster] Casting ${t.name} (${t.castTime}s cast time)`)):this._executeSpell(t),!0):!1:(console.warn("[SpellCaster] Unknown spell:",e),!1)}castFromSlot(e){const t=this.spellManager.hotbarSlots[e];return t?this.castSpell(t):(console.log("[SpellCaster] No spell in slot",e),!1)}interruptCast(){this.isCasting&&(console.log(`[SpellCaster] Cast interrupted: ${this.currentCastSpell.name}`),this.onCastInterrupt&&this.onCastInterrupt(this.currentCastSpell),this._endCasting(),this.gm.floatingText&&this.player&&this.gm.floatingText.spawn(this.player.mesh.position.clone().add(new T(0,2,0)),"Interrupted!","#ff6666"))}update(e){if(this.isCasting&&(this.castTimer+=e,this._updateCastingVisual(e),this.castTimer>=this.castDuration)){const t=this.currentCastSpell;this._endCasting(),this._executeSpell(t),this.onCastComplete&&this.onCastComplete(t)}this._updateProjectiles(e),this._updateAOEs(e)}_executeSpell(e){switch(console.log(`[SpellCaster] Executing: ${e.name}`),this.audioManager&&this._playCastSound(e),e.targetType){case ii.SELF:this._executeSelfSpell(e);break;case ii.DIRECTION:this._executeDirectionalSpell(e);break;case ii.AOE_SELF:this._executeAOESelfSpell(e);break;case ii.AOE:this._executeAOETargetSpell(e);break;case ii.ENEMY:this._executeEnemyTargetSpell(e);break}}_executeSelfSpell(e){if(!this.player)return;const t=this.gm.stats?.intelligence||0,i=this.gm.stats?.wisdom||0;if(e.category===oi.HEALING){if(e.baseHealing&&!e.duration){const s=Yo(e,t,i);this.gm.heal(s),this.spellEffects?this.spellEffects.spawnHealingEffect(this.player.mesh.position,1):this.particleManager&&this._spawnHealingParticles(this.player.mesh.position),console.log(`[SpellCaster] Healed for ${s}`)}else if(e.id==="regeneration"){const s=Yo(e,t,i);this.spellManager.applyRegen(s,e.duration),this.spellEffects?(this.spellEffects.createBuffAura("regeneration",6750105,"Regeneration"),this.spellEffects.spawnHealingEffect(this.player.mesh.position,.5)):this.particleManager&&this._spawnRegenParticles(this.player.mesh.position)}}if(e.category===oi.DEFENSIVE)if(e.shieldAmount)if(this.spellManager.applyShield(e.id),this.spellEffects){const s=e.id==="barrier"?11167487:6728447;this.spellEffects.createShieldAura(s,.3)}else this.particleManager&&this._spawnShieldParticles(this.player.mesh.position);else e.damageReduction&&(this.spellManager.applyBuff(e.id),this.spellEffects&&this.spellEffects.createBuffAura(e.id,8947967,e.name));if(e.category===oi.BUFF){this.spellManager.applyBuff(e.id);let s=16777062;e.speedBonus&&(s=6750207),e.damageBonus&&(s=16737894),e.spellDamageBonus&&(s=11167487),e.damageReduction&&(s=8947848),this.spellEffects?(this.spellEffects.createBuffAura(e.id,s,e.name),this._spawnBuffParticles(this.player.mesh.position,e)):this.particleManager&&this._spawnBuffParticles(this.player.mesh.position,e)}}_executeDirectionalSpell(e){if(!this.player||!this.scene)return;const t=new T(0,0,-1);t.applyQuaternion(this.player.mesh.quaternion),t.y=0,t.normalize();const i=this.player.mesh.position.clone();i.y+=1.2,i.add(t.clone().multiplyScalar(.8)),this._createProjectile(e,i,t)}_executeAOESelfSpell(e){if(!this.player)return;const t=this.player.mesh.position.clone();this._dealAOEDamage(e,t),this.particleManager&&this._spawnAOEParticles(t,e)}_executeAOETargetSpell(e){if(!this.player)return;const t=new T(0,0,-1);t.applyQuaternion(this.player.mesh.quaternion),t.y=0,t.normalize();const i=this.player.mesh.position.clone().add(t.multiplyScalar(e.range*.5));i.y=0,this._dealAOEDamage(e,i),this.particleManager&&this._spawnAOEParticles(i,e)}_executeEnemyTargetSpell(e){this._executeDirectionalSpell(e)}_createProjectile(e,t,i){const s=++this.projectileIdCounter,n=this.gm.stats?.intelligence||0;let a=Ul(e,n);a*=this.spellManager.getSpellDamageBonus();let o=null,r=null;if(this.spellEffects){let h=null;switch(e.id){case"fireball":h=this.spellEffects.createFireballEffect(t,i);break;case"iceShard":h=this.spellEffects.createIceShardEffect(t,i);break;case"lightningBolt":h=this.spellEffects.createLightningEffect(t,i);break;case"arcaneMissile":h=this.spellEffects.createArcaneMissileEffect(t);break;default:o=this._createProjectileMesh(e),o.position.copy(t),this.scene.add(o)}h&&(o=h.mesh,r=h.id)}else o=this._createProjectileMesh(e),o.position.copy(t),this.scene.add(o);const c={id:s,mesh:o,effectId:r,velocity:i.clone().multiplyScalar(e.projectileSpeed),spell:e,damage:Math.floor(a),distanceTraveled:0,maxDistance:e.range,aoeRadius:e.aoeRadius||0};this.projectiles.push(c),console.log(`[SpellCaster] Projectile created: ${e.name} (${Math.floor(a)} damage)`)}_createProjectileMesh(e){let t,i;switch(e.id){case"fireball":t=new re(.4,12,12),i=new B({color:16737792,transparent:!0,opacity:.9});break;case"iceShard":t=new wt(.15,.6,6),i=new B({color:6737151,transparent:!0,opacity:.85});break;case"lightningBolt":t=new ce(.08,.08,1.5,6),i=new B({color:16777062,transparent:!0,opacity:.95});break;case"arcaneMissile":t=new re(.25,8,8),i=new B({color:11167487,transparent:!0,opacity:.9});break;case"darkOrb":t=new re(.5,12,12),i=new B({color:3342438,transparent:!0,opacity:.85});break;case"spark":t=new re(.15,6,6),i=new B({color:16776960,transparent:!0,opacity:.9});break;case"lifeSteal":t=new re(.3,8,8),i=new B({color:8912896,transparent:!0,opacity:.85});break;default:t=new re(.3,8,8),i=new B({color:16777215,transparent:!0,opacity:.8})}const s=new w(t,i),n=new We(i.color,1,5);return s.add(n),s}_updateProjectiles(e){const t=[];for(const i of this.projectiles){const s=i.velocity.clone().multiplyScalar(e);if(i.mesh.position.add(s),i.distanceTraveled+=s.length(),this.spellEffects&&i.effectId?this.spellEffects.updateEffectPosition(i.effectId,i.mesh.position):(i.mesh.rotation.z+=e*5,this.particleManager&&Math.random()<.3&&this._spawnProjectileTrail(i)),this.enemyManager){const n=this._checkProjectileCollision(i);if(n){this._onProjectileHit(i,n),t.push(i.id);continue}}i.distanceTraveled>=i.maxDistance&&(i.aoeRadius>0&&(this._dealAOEDamage(i.spell,i.mesh.position,i.damage),this.spellEffects?this.spellEffects.spawnAOERingEffect(i.mesh.position,i.spell.aoeRadius,i.spell):this._spawnAOEParticles(i.mesh.position,i.spell)),t.push(i.id)),i.mesh.position.y<0&&(i.aoeRadius>0&&(i.mesh.position.y=0,this._dealAOEDamage(i.spell,i.mesh.position,i.damage),this.spellEffects?this.spellEffects.spawnAOERingEffect(i.mesh.position,i.spell.aoeRadius,i.spell):this._spawnAOEParticles(i.mesh.position,i.spell)),t.push(i.id))}for(const i of t){const s=this.projectiles.findIndex(n=>n.id===i);if(s!==-1){const n=this.projectiles[s];this.spellEffects&&n.effectId?this.spellEffects._removeEffect(n.effectId):(this.scene.remove(n.mesh),n.mesh.geometry&&n.mesh.geometry.dispose(),n.mesh.material&&n.mesh.material.dispose()),this.projectiles.splice(s,1)}}}_checkProjectileCollision(e){if(!this.enemyManager)return null;const t=e.mesh.position,i=.5;for(const s of this.enemyManager.enemies){if(!s.mesh||s.isDead)continue;const n=t.distanceTo(s.mesh.position),a=s.hitRadius||1;if(n<i+a)return s}return null}_onProjectileHit(e,t){if(console.log(`[SpellCaster] ${e.spell.name} hit enemy for ${e.damage} damage`),t.takeDamage&&t.takeDamage(e.damage,e.spell.damageType||"magical"),e.spell.id==="lifeSteal"&&e.spell.baseHealing){const i=this.gm.stats?.intelligence||0,s=this.gm.stats?.wisdom||0,n=Yo(e.spell,i,s);this.gm.heal(n),this.spellEffects&&this.player?this.spellEffects.spawnHealingEffect(this.player.mesh.position,.5):this.particleManager&&this.player&&this._spawnHealingParticles(this.player.mesh.position)}e.aoeRadius>0&&(this._dealAOEDamage(e.spell,e.mesh.position,e.damage,t),this.spellEffects&&this.spellEffects.spawnAOERingEffect(e.mesh.position,e.spell.aoeRadius,e.spell)),this.spellEffects?this.spellEffects.spawnImpactEffect(e.mesh.position,e.spell):this.particleManager&&this._spawnImpactParticles(e.mesh.position,e.spell),this.audioManager&&this.audioManager.play("spell_impact",{volume:.5}),this.onSpellHit&&this.onSpellHit(e.spell,t,e.damage)}_dealAOEDamage(e,t,i=null,s=null){if(!this.enemyManager)return;const n=e.aoeRadius,a=this.gm.stats?.intelligence||0;let o=i||Ul(e,a);o*=this.spellManager.getSpellDamageBonus(),o=Math.floor(o);let r=0;for(const c of this.enemyManager.enemies){if(!c.mesh||c.isDead||c===s)continue;const h=t.distanceTo(c.mesh.position);if(h<=n){const d=1-h/n*.3,u=Math.floor(o*d);c.takeDamage&&(c.takeDamage(u,e.damageType||"magical"),r++)}}r>0&&console.log(`[SpellCaster] AOE ${e.name} hit ${r} enemies`)}_updateAOEs(e){}_startCastingVisual(){if(!this.player)return;if(this.spellEffects&&this.currentCastSpell){const s=this.spellEffects.createCastingEffect(this.currentCastSpell);if(s){this.castingEffectId=s.id;return}}const e=new re(.2,8,8),t=new B({color:6728447,transparent:!0,opacity:.6});this.castingGlow=new w(e,t),this.castingGlow.position.set(0,1.2,.3),this.player.mesh.add(this.castingGlow);const i=new We(6728447,.5,3);this.castingGlow.add(i)}_updateCastingVisual(e){if(this.castingEffectId||!this.castingGlow)return;const t=1+Math.sin(this.castTimer*10)*.3;this.castingGlow.scale.setScalar(t);const i=this.castTimer/this.castDuration;if(this.castingGlow.material.opacity=.4+i*.5,this.particleManager&&Math.random()<.2){const s=this.player.mesh.position.clone();s.y+=1.2,this.particleManager.spawnParticles(s,{count:2,color:6728447,size:.1,spread:.3,lifetime:.3})}}_endCasting(){if(this.isCasting=!1,this.currentCastSpell=null,this.castTimer=0,this.castDuration=0,this.spellEffects&&this.castingEffectId){this.spellEffects.removeCastingEffect(this.castingEffectId),this.castingEffectId=null;return}this.castingGlow&&this.player&&(this.player.mesh.remove(this.castingGlow),this.castingGlow.geometry.dispose(),this.castingGlow.material.dispose(),this.castingGlow=null)}_spawnHealingParticles(e){this.particleManager&&this.particleManager.spawnParticles(e.clone(),{count:15,color:65382,size:.15,spread:1,lifetime:1,velocity:{x:0,y:2,z:0}})}_spawnRegenParticles(e){this.particleManager&&this.particleManager.spawnParticles(e.clone(),{count:10,color:6750105,size:.1,spread:.8,lifetime:.8,velocity:{x:0,y:1.5,z:0}})}_spawnShieldParticles(e){if(this.particleManager)for(let t=0;t<20;t++){const i=t/20*Math.PI*2,s=new T(Math.cos(i)*1.2,1,Math.sin(i)*1.2);this.particleManager.spawnParticles(e.clone().add(s),{count:2,color:6728447,size:.12,spread:.2,lifetime:.6})}}_spawnBuffParticles(e,t){if(!this.particleManager)return;let i=16777062;t.speedBonus&&(i=6750207),t.damageBonus&&(i=16737894),t.spellDamageBonus&&(i=11167487),this.particleManager.spawnParticles(e.clone(),{count:20,color:i,size:.12,spread:1.5,lifetime:1,velocity:{x:0,y:3,z:0}})}_spawnProjectileTrail(e){if(!this.particleManager)return;let t=16777215;switch(e.spell.id){case"fireball":t=16737792;break;case"iceShard":t=6737151;break;case"lightningBolt":t=16777062;break;case"arcaneMissile":t=11167487;break;case"darkOrb":t=6684774;break;case"spark":t=16776960;break;case"lifeSteal":t=8912896;break}this.particleManager.spawnParticles(e.mesh.position.clone(),{count:2,color:t,size:.08,spread:.1,lifetime:.3})}_spawnImpactParticles(e,t){if(!this.particleManager)return;let i=16777215,s=15;switch(t.damageType){case"fire":i=16737792,s=25;break;case"ice":i=6737151;break;case"lightning":i=16777062;break;case"arcane":i=11167487;break;case"dark":i=3342438;break}this.particleManager.spawnParticles(e.clone(),{count:s,color:i,size:.15,spread:2,lifetime:.5})}_spawnAOEParticles(e,t){if(!this.particleManager)return;let i=16777215;switch(t.damageType){case"fire":i=16737792;break;case"ice":i=6737151;break;case"lightning":i=16777062;break}const s=t.aoeRadius;for(let n=0;n<30;n++){const a=n/30*Math.PI*2,o=new T(Math.cos(a)*s,.5,Math.sin(a)*s);this.particleManager.spawnParticles(e.clone().add(o),{count:3,color:i,size:.2,spread:.3,lifetime:.8,velocity:{x:0,y:2,z:0}})}this.particleManager.spawnParticles(e.clone(),{count:40,color:i,size:.25,spread:s,lifetime:.6})}_playCastSound(e){if(this.audioManager)switch(e.damageType){case"fire":this.audioManager.play("spell_fire",{volume:.5});break;case"ice":this.audioManager.play("spell_ice",{volume:.5});break;case"lightning":this.audioManager.play("spell_lightning",{volume:.5});break;default:this.audioManager.play("spell_cast",{volume:.5})}}getCastProgress(){return this.isCasting?Math.min(1,this.castTimer/this.castDuration):0}getIsCasting(){return this.isCasting}getCurrentCastSpell(){return this.currentCastSpell}clearAllProjectiles(){for(const e of this.projectiles)this.scene.remove(e.mesh);this.projectiles=[],this.isCasting&&this._endCasting()}}class MS{constructor(e,t){this.scene=e,this.particleManager=t,this.activeEffects=[],this.effectIdCounter=0,this.player=null,this.shieldAura=null,this.buffAuras={}}setPlayer(e){this.player=e}update(e){const t=[];for(const i of this.activeEffects)i.elapsed+=e,i.update&&i.update(e,i),i.lifetime>0&&i.elapsed>=i.lifetime&&t.push(i.id);for(const i of t)this._removeEffect(i);this._updateShieldAura(e),this._updateBuffAuras(e)}createFireballEffect(e,t){const i=++this.effectIdCounter,s=new ne,n=new re(.35,16,16),a=new B({color:16737792,transparent:!0,opacity:.95}),o=new w(n,a);s.add(o);const r=new re(.45,12,12),c=new B({color:16729088,transparent:!0,opacity:.5}),h=new w(r,c);s.add(h);const d=new re(.6,8,8),u=new B({color:16720384,transparent:!0,opacity:.25}),p=new w(d,u);s.add(p);const f=new We(16737792,2,8);s.add(f),s.position.copy(e),this.scene.add(s);const y={id:i,type:"fireball",mesh:s,core:o,inner:h,outer:p,light:f,elapsed:0,lifetime:5,update:(m,g)=>{const x=Math.sin(g.elapsed*15)*.1+1;g.core.scale.setScalar(x),g.inner.scale.setScalar(x*.95),g.light.intensity=1.5+Math.random()*1,this.particleManager&&Math.random()<.6&&this.particleManager.spawnParticles(s.position.clone(),{count:3,color:Math.random()>.5?16737792:16720384,size:.1+Math.random()*.1,spread:.2,lifetime:.4,velocity:{x:(Math.random()-.5)*2,y:1,z:(Math.random()-.5)*2}})}};return this.activeEffects.push(y),{id:i,mesh:s}}createIceShardEffect(e,t){const i=++this.effectIdCounter,s=new ne,n=new wt(.12,.7,6),a=new B({color:8969727,transparent:!0,opacity:.85}),o=new w(n,a);o.rotation.x=Math.PI/2,s.add(o);const r=new re(.2,8,8),c=new B({color:6737151,transparent:!0,opacity:.4}),h=new w(r,c);s.add(h);const d=[];for(let f=0;f<4;f++){const y=new Ji(.05),m=new B({color:11202303,transparent:!0,opacity:.7}),g=new w(y,m);d.push(g),s.add(g)}const u=new We(6737151,1,5);s.add(u),s.position.copy(e),this.scene.add(s);const p={id:i,type:"iceShard",mesh:s,shard:o,crystals:d,elapsed:0,lifetime:5,update:(f,y)=>{y.shard.rotation.z+=f*8,y.crystals.forEach((m,g)=>{const x=y.elapsed*6+g*Math.PI/2;m.position.x=Math.cos(x)*.25,m.position.y=Math.sin(x)*.25}),this.particleManager&&Math.random()<.4&&this.particleManager.spawnParticles(s.position.clone(),{count:2,color:8969727,size:.06,spread:.15,lifetime:.5,velocity:{x:0,y:-.5,z:0}})}};return this.activeEffects.push(p),{id:i,mesh:s}}createLightningEffect(e,t){const i=++this.effectIdCounter,s=new ne,n=new ce(.06,.06,1.2,6),a=new B({color:16777096,transparent:!0,opacity:.95}),o=new w(n,a);o.rotation.x=Math.PI/2,s.add(o);const r=new ce(.15,.15,1.2,6),c=new B({color:16777130,transparent:!0,opacity:.3}),h=new w(r,c);h.rotation.x=Math.PI/2,s.add(h);const d=[];for(let f=0;f<3;f++){const y=new Kd({color:16777164,transparent:!0,opacity:.8}),m=new mt,g=[new T(0,0,0),new T(0,0,0)];m.setFromPoints(g);const x=new Vl(m,y);d.push(x),s.add(x)}const u=new We(16777130,3,10);s.add(u),s.position.copy(e),this.scene.add(s);const p={id:i,type:"lightning",mesh:s,bolt:o,arcs:d,light:u,elapsed:0,lifetime:3,update:(f,y)=>{const m=Math.random()>.2;y.bolt.visible=m,y.light.intensity=m?2+Math.random()*2:.5,y.arcs.forEach((g,x)=>{const v=g.geometry.attributes.position;if(v){const b=x/3*Math.PI*2+y.elapsed*5,_=.2+Math.random()*.3;v.setXYZ(0,0,0,Math.random()*.3-.15),v.setXYZ(1,Math.cos(b)*_,Math.sin(b)*_,-.3),v.needsUpdate=!0}g.visible=Math.random()>.3}),this.particleManager&&Math.random()<.5&&this.particleManager.spawnParticles(s.position.clone(),{count:2,color:16777130,size:.05,spread:.3,lifetime:.2})}};return this.activeEffects.push(p),{id:i,mesh:s}}createArcaneMissileEffect(e){const t=++this.effectIdCounter,i=new ne,s=new re(.2,12,12),n=new B({color:11167487,transparent:!0,opacity:.9}),a=new w(s,n);i.add(a);const o=new re(.35,8,8),r=new B({color:8930508,transparent:!0,opacity:.4}),c=new w(o,r);i.add(c);const h=[];for(let p=0;p<3;p++){const f=new Dt(.15,.15),y=new B({color:13404415,transparent:!0,opacity:.6,side:lt}),m=new w(f,y);h.push(m),i.add(m)}const d=new We(11167487,1.5,6);i.add(d),i.position.copy(e),this.scene.add(i);const u={id:t,type:"arcaneMissile",mesh:i,core:a,runes:h,elapsed:0,lifetime:5,update:(p,f)=>{const y=Math.sin(f.elapsed*8)*.15+1;f.core.scale.setScalar(y),f.runes.forEach((m,g)=>{const x=f.elapsed*4+g*Math.PI*2/3;m.position.x=Math.cos(x)*.3,m.position.z=Math.sin(x)*.3,m.rotation.y=x}),this.particleManager&&Math.random()<.4&&this.particleManager.spawnParticles(i.position.clone(),{count:2,color:11167487,size:.08,spread:.15,lifetime:.4})}};return this.activeEffects.push(u),{id:t,mesh:i}}spawnHealingEffect(e,t=1){if(!this.particleManager)return;const i=Math.floor(20*t);for(let s=0;s<i;s++){const n=new T((Math.random()-.5)*1.5,Math.random()*.5,(Math.random()-.5)*1.5);setTimeout(()=>{this.particleManager&&this.particleManager.spawnParticles(e.clone().add(n),{count:3,color:Math.random()>.3?65382:8978346,size:.1+Math.random()*.08,spread:.2,lifetime:1+Math.random()*.5,velocity:{x:0,y:2.5+Math.random(),z:0}})},s*30)}}createShieldAura(e=6728447,t=.3){this.shieldAura&&this.removeShieldAura();const i=new ne,s=new re(1.2,24,24),n=new B({color:e,transparent:!0,opacity:t,side:wi}),a=new w(s,n);i.add(a);const o=new re(1.15,16,16),r=new B({color:e,transparent:!0,opacity:t*.5,side:Xs}),c=new w(o,r);i.add(c);const h=new Ni(1.22,1),d=new B({color:16777215,transparent:!0,opacity:.15,wireframe:!0}),u=new w(h,d);return i.add(u),this.shieldAura={group:i,shield:a,inner:c,hex:u,elapsed:0},this.player&&this.player.mesh?this.player.mesh.add(i):this.scene.add(i),this.shieldAura}removeShieldAura(){if(!this.shieldAura)return;const e=this.shieldAura.group;this.player&&this.player.mesh?this.player.mesh.remove(e):this.scene.remove(e),e.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}),this.shieldAura=null}_updateShieldAura(e){if(!this.shieldAura)return;this.shieldAura.elapsed+=e;const t=Math.sin(this.shieldAura.elapsed*2)*.03+1;if(this.shieldAura.shield.scale.setScalar(t),this.shieldAura.hex.rotation.y+=e*.3,this.shieldAura.hex.rotation.x+=e*.1,this.particleManager&&this.player&&Math.random()<.05){const i=Math.random()*Math.PI*2,s=this.player.mesh.position.clone();s.x+=Math.cos(i)*1.2,s.y+=.5+Math.random(),s.z+=Math.sin(i)*1.2,this.particleManager.spawnParticles(s,{count:1,color:8965375,size:.08,spread:.1,lifetime:.5,velocity:{x:0,y:.5,z:0}})}}createBuffAura(e,t,i){return this.buffAuras[e]?this.buffAuras[e]:(this.buffAuras[e]={color:t,name:i,elapsed:0,particleTimer:0},this.buffAuras[e])}removeBuffAura(e){delete this.buffAuras[e]}_updateBuffAuras(e){if(!(!this.player||!this.particleManager)){for(const[t,i]of Object.entries(this.buffAuras))if(i.elapsed+=e,i.particleTimer+=e,i.particleTimer>=.2){i.particleTimer=0;const s=i.elapsed*2+Math.random()*Math.PI,n=this.player.mesh.position.clone();n.x+=Math.cos(s)*.8,n.y+=.1,n.z+=Math.sin(s)*.8,this.particleManager.spawnParticles(n,{count:2,color:i.color,size:.1,spread:.2,lifetime:1,velocity:{x:0,y:1.5,z:0}})}}}spawnImpactEffect(e,t){if(!this.particleManager)return;let i=16777215,s=25,n=.15;switch(t.damageType){case"fire":i=16737792,s=35,n=.18;for(let a=0;a<10;a++)setTimeout(()=>{this.particleManager&&this.particleManager.spawnParticles(e.clone(),{count:3,color:16729088,size:.12,spread:1.5,lifetime:.3,velocity:{x:0,y:2,z:0}})},a*20);break;case"ice":i=8969727;for(let a=0;a<8;a++){const o=a/8*Math.PI*2,r=new T(Math.cos(o)*.5,0,Math.sin(o)*.5);this.particleManager.spawnParticles(e.clone().add(r),{count:2,color:11202303,size:.1,spread:.3,lifetime:.6,velocity:{x:Math.cos(o)*3,y:1,z:Math.sin(o)*3}})}break;case"lightning":i=16777130,this._createLightningFlash(e);break;case"arcane":i=11167487;for(let a=0;a<15;a++)setTimeout(()=>{if(this.particleManager){const o=a*.5,r=.3+a*.1,c=new T(Math.cos(o)*r,a*.1,Math.sin(o)*r);this.particleManager.spawnParticles(e.clone().add(c),{count:2,color:13404415,size:.1,spread:.1,lifetime:.5})}},a*25);break;case"dark":i=6684774,s=30;break}this.particleManager.spawnParticles(e.clone(),{count:s,color:i,size:n,spread:2,lifetime:.5})}_createLightningFlash(e){const t=new We(16777130,5,15);t.position.copy(e),this.scene.add(t);let i=5;const s=setInterval(()=>{i-=.5,i<=0?(clearInterval(s),this.scene.remove(t)):t.intensity=i},16)}spawnAOERingEffect(e,t,i){if(!this.particleManager)return;let s=16777215;switch(i.damageType){case"fire":s=16737792;break;case"ice":s=6737151;break;case"lightning":s=16777062;break;case"arcane":s=11167487;break}for(let n=0;n<3;n++)setTimeout(()=>{const a=t*(.3+n*.35),o=Math.floor(20+n*10);for(let r=0;r<o;r++){const c=r/o*Math.PI*2,h=new T(Math.cos(c)*a,.2,Math.sin(c)*a);this.particleManager&&this.particleManager.spawnParticles(e.clone().add(h),{count:2,color:s,size:.15-n*.03,spread:.2,lifetime:.8-n*.15,velocity:{x:0,y:2+n,z:0}})}},n*80);this.particleManager.spawnParticles(e.clone(),{count:50,color:s,size:.2,spread:t,lifetime:.6})}createCastingEffect(e){if(!this.player||!this.player.mesh)return null;let t=6728447;switch(e.damageType){case"fire":t=16737792;break;case"ice":t=6737151;break;case"lightning":t=16777062;break;case"arcane":t=11167487;break;case"dark":t=6684774;break}e.category==="healing"&&(t=65382),e.category==="defensive"&&(t=6728447),e.category==="buff"&&(t=16777062);const i=++this.effectIdCounter,s=new ne,n=new re(.15,12,12),a=new B({color:t,transparent:!0,opacity:.7}),o=new w(n,a);s.add(o);const r=new re(.25,8,8),c=new B({color:t,transparent:!0,opacity:.3}),h=new w(r,c);s.add(h);const d=new We(t,1,4);s.add(d),s.position.set(0,1.2,.4),this.player.mesh.add(s);const u={id:i,type:"casting",mesh:s,orb:o,glow:h,light:d,elapsed:0,lifetime:-1,update:(p,f)=>{const y=.5+Math.min(f.elapsed*.5,1);f.orb.scale.setScalar(y),f.glow.scale.setScalar(y*1.3),f.light.intensity=.5+y;const m=Math.sin(f.elapsed*10)*.1;if(f.orb.scale.multiplyScalar(1+m),this.particleManager&&Math.random()<.3){const g=f.elapsed*5+Math.random()*Math.PI*2,x=1-Math.min(f.elapsed*.3,.8),v=s.getWorldPosition(new T);v.x+=Math.cos(g)*x,v.y+=Math.random()*.5,v.z+=Math.sin(g)*x,this.particleManager.spawnParticles(v,{count:1,color:t,size:.06,spread:.05,lifetime:.3})}}};return this.activeEffects.push(u),{id:i,group:s}}removeCastingEffect(e){this._removeEffect(e)}_removeEffect(e){const t=this.activeEffects.findIndex(s=>s.id===e);if(t===-1)return;const i=this.activeEffects[t];i.mesh&&(i.mesh.parent?i.mesh.parent.remove(i.mesh):this.scene.remove(i.mesh),i.mesh.traverse(s=>{s.geometry&&s.geometry.dispose(),s.material&&s.material.dispose()})),this.activeEffects.splice(t,1)}getEffectMesh(e){const t=this.activeEffects.find(i=>i.id===e);return t?t.mesh:null}updateEffectPosition(e,t){const i=this.activeEffects.find(s=>s.id===e);i&&i.mesh&&i.mesh.position.copy(t)}clearAll(){for(const e of this.activeEffects)e.mesh&&(e.mesh.parent?e.mesh.parent.remove(e.mesh):this.scene.remove(e.mesh),e.mesh.traverse(t=>{t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()}));this.activeEffects=[],this.removeShieldAura(),this.buffAuras={}}}class SS{constructor(e=null){this.gm=e,this.activeBoss=null,this.bossAI=null,this.bossData=null,this.isVisible=!1,this.lastHealth=0,this.lastMaxHealth=0,this.lastPhase=1,this.damageChunkTimer=0,this.damageChunkHealth=0,this.enrageTimerActive=!1,this.enrageTimeRemaining=0,this.healthBarAnimating=!1,this.phaseTransitionAnimating=!1,this._createContainer(),this._createNameDisplay(),this._createHealthBar(),this._createPhaseIndicators(),this._createEnrageTimer(),this._createDamageNumbers(),this._addStyles(),this.hide()}_createContainer(){this.container=document.createElement("div"),this.container.id="boss-ui-container",this.container.style.cssText=`
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 600px;
      max-width: 90vw;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      z-index: 150;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease-out;
    `,document.body.appendChild(this.container)}_createNameDisplay(){this.nameContainer=document.createElement("div"),this.nameContainer.style.cssText=`
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    `,this.titleLabel=document.createElement("div"),this.titleLabel.className="boss-title",this.titleLabel.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 12px;
      color: #aa8866;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.9);
    `,this.titleLabel.textContent="",this.nameContainer.appendChild(this.titleLabel),this.nameLabel=document.createElement("div"),this.nameLabel.className="boss-name",this.nameLabel.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 24px;
      font-weight: bold;
      color: #ffddaa;
      text-shadow: 0 0 12px rgba(255, 180, 80, 0.5), 0 2px 4px rgba(0, 0, 0, 0.9);
      letter-spacing: 2px;
    `,this.nameLabel.textContent="",this.nameContainer.appendChild(this.nameLabel),this.phaseNameLabel=document.createElement("div"),this.phaseNameLabel.className="boss-phase-name",this.phaseNameLabel.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 11px;
      color: #888888;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 0 6px rgba(0, 0, 0, 0.8);
      margin-top: 4px;
      opacity: 0;
      transition: opacity 0.3s, color 0.5s;
    `,this.phaseNameLabel.textContent="",this.nameContainer.appendChild(this.phaseNameLabel),this.container.appendChild(this.nameContainer)}_createHealthBar(){this.healthBarContainer=document.createElement("div"),this.healthBarContainer.style.cssText=`
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    `,this.healthBarWrapper=document.createElement("div"),this.healthBarWrapper.style.cssText=`
      width: 100%;
      height: 24px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(180, 120, 60, 0.6);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.8), inset 0 0 10px rgba(0, 0, 0, 0.5);
    `,this.damageChunkBar=document.createElement("div"),this.damageChunkBar.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: linear-gradient(90deg, #ffcccc, #ff8888);
      transition: width 0.8s ease-out;
      z-index: 1;
    `,this.healthBarWrapper.appendChild(this.damageChunkBar),this.healthBarFill=document.createElement("div"),this.healthBarFill.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: linear-gradient(180deg, #cc3333 0%, #aa2222 50%, #881111 100%);
      box-shadow: inset 0 2px 4px rgba(255, 100, 100, 0.3), 0 0 10px rgba(200, 50, 50, 0.4);
      transition: width 0.15s ease-out;
      z-index: 2;
    `,this.healthBarWrapper.appendChild(this.healthBarFill),this.phaseMarkerContainer=document.createElement("div"),this.phaseMarkerContainer.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 3;
      pointer-events: none;
    `,this.healthBarWrapper.appendChild(this.phaseMarkerContainer),this.healthBarShimmer=document.createElement("div"),this.healthBarShimmer.style.cssText=`
      position: absolute;
      top: 0;
      left: -100%;
      width: 50%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
      z-index: 4;
      animation: bossHealthShimmer 3s ease-in-out infinite;
    `,this.healthBarWrapper.appendChild(this.healthBarShimmer),this.healthText=document.createElement("div"),this.healthText.style.cssText=`
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: 'Cinzel', serif;
      font-size: 12px;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 0 0 4px rgba(0, 0, 0, 1), 0 0 8px rgba(0, 0, 0, 0.8);
      z-index: 5;
      letter-spacing: 1px;
    `,this.healthText.textContent="",this.healthBarWrapper.appendChild(this.healthText),this.healthBarContainer.appendChild(this.healthBarWrapper),this.container.appendChild(this.healthBarContainer),this.phaseMarkers=[]}_createPhaseIndicators(){this.phaseContainer=document.createElement("div"),this.phaseContainer.style.cssText=`
      display: flex;
      flex-direction: row;
      gap: 12px;
      margin-top: 4px;
    `,this.phaseIndicators=[],this.container.appendChild(this.phaseContainer)}_createEnrageTimer(){this.enrageContainer=document.createElement("div"),this.enrageContainer.style.cssText=`
      position: absolute;
      top: -30px;
      right: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
      opacity: 0;
      transition: opacity 0.3s;
    `,this.enrageIcon=document.createElement("div"),this.enrageIcon.style.cssText=`
      font-size: 16px;
      animation: enragePulse 0.5s ease-in-out infinite;
    `,this.enrageIcon.textContent="",this.enrageContainer.appendChild(this.enrageIcon),this.enrageText=document.createElement("div"),this.enrageText.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 14px;
      font-weight: bold;
      color: #ff4400;
      text-shadow: 0 0 8px rgba(255, 68, 0, 0.6);
      letter-spacing: 1px;
    `,this.enrageText.textContent="ENRAGED",this.enrageContainer.appendChild(this.enrageText),this.container.appendChild(this.enrageContainer)}_createDamageNumbers(){this.damageNumberPool=[],this.activeDamageNumbers=[];for(let e=0;e<10;e++){const t=document.createElement("div");t.className="boss-damage-number",t.style.cssText=`
        position: fixed;
        font-family: 'Cinzel', serif;
        font-size: 28px;
        font-weight: bold;
        color: #ffdd44;
        text-shadow: 0 0 10px rgba(255, 200, 0, 0.8), 0 2px 4px rgba(0, 0, 0, 0.9);
        pointer-events: none;
        z-index: 200;
        opacity: 0;
        transform: translateY(0) scale(1);
        transition: none;
      `,document.body.appendChild(t),this.damageNumberPool.push({element:t,active:!1,timer:0})}}_addStyles(){if(document.getElementById("boss-ui-styles"))return;const e=document.createElement("style");e.id="boss-ui-styles",e.textContent=`
      @keyframes bossHealthShimmer {
        0% { left: -50%; }
        50% { left: 100%; }
        100% { left: 100%; }
      }
      
      @keyframes enragePulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
      }
      
      @keyframes phaseTransitionGlow {
        0% { box-shadow: 0 0 20px rgba(255, 200, 100, 0.8); }
        50% { box-shadow: 0 0 40px rgba(255, 220, 150, 1), 0 0 60px rgba(255, 180, 80, 0.6); }
        100% { box-shadow: 0 0 20px rgba(255, 200, 100, 0.8); }
      }
      
      @keyframes damageNumberFloat {
        0% { 
          opacity: 1; 
          transform: translateY(0) scale(1.2);
        }
        20% {
          transform: translateY(-20px) scale(1);
        }
        100% { 
          opacity: 0; 
          transform: translateY(-60px) scale(0.8);
        }
      }
      
      @keyframes phaseIndicatorPulse {
        0%, 100% { 
          transform: scale(1);
          box-shadow: 0 0 8px currentColor;
        }
        50% { 
          transform: scale(1.1);
          box-shadow: 0 0 16px currentColor, 0 0 24px currentColor;
        }
      }
      
      @keyframes bossAppear {
        0% {
          opacity: 0;
          transform: translateX(-50%) translateY(30px);
        }
        100% {
          opacity: 1;
          transform: translateX(-50%) translateY(0);
        }
      }
      
      @keyframes healthBarDanger {
        0%, 100% { 
          border-color: rgba(255, 60, 60, 0.8);
          box-shadow: 0 0 15px rgba(255, 0, 0, 0.3), inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
        50% { 
          border-color: rgba(255, 120, 60, 1);
          box-shadow: 0 0 25px rgba(255, 50, 0, 0.5), inset 0 0 10px rgba(0, 0, 0, 0.5);
        }
      }
      
      .boss-damage-number.critical {
        color: #ff6644 !important;
        font-size: 36px !important;
        text-shadow: 0 0 15px rgba(255, 100, 50, 1), 0 2px 6px rgba(0, 0, 0, 1) !important;
      }
      
      .boss-damage-number.weak {
        color: #aaaaaa !important;
        font-size: 20px !important;
      }
    `,document.head.appendChild(e)}setBoss(e,t,i){if(this.activeBoss=e,this.bossAI=t,this.bossData=i,!i){this.hide();return}this.nameLabel.textContent=i.name||"Unknown Boss",this.titleLabel.textContent=i.title||"",this.lastHealth=i.stats?.maxHealth||1e3,this.lastMaxHealth=this.lastHealth,this.damageChunkHealth=this.lastHealth,this._updateHealthBar(this.lastHealth,this.lastMaxHealth),this._createPhaseMarkers(i.phases),this._createPhaseIndicatorElements(i.phases),this.lastPhase=1,this._updatePhaseDisplay(1,i.phases[0])}_createPhaseMarkers(e){if(this.phaseMarkerContainer.innerHTML="",this.phaseMarkers=[],!(!e||e.length<=1))for(let t=1;t<e.length;t++){const i=e[t],s=i.threshold,n=document.createElement("div");n.style.cssText=`
        position: absolute;
        top: 0;
        left: ${s*100}%;
        width: 3px;
        height: 100%;
        background: linear-gradient(180deg, rgba(255,200,100,0.9) 0%, rgba(200,150,50,0.7) 100%);
        box-shadow: 0 0 6px rgba(255, 200, 100, 0.5);
        transform: translateX(-50%);
      `,n.dataset.phase=i.id,n.dataset.threshold=s,this.phaseMarkerContainer.appendChild(n),this.phaseMarkers.push({element:n,threshold:s,phase:i.id,triggered:!1})}}_createPhaseIndicatorElements(e){if(this.phaseContainer.innerHTML="",this.phaseIndicators=[],!!e){for(const t of e){const i=document.createElement("div");i.style.cssText=`
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(100, 100, 100, 0.4);
        border-radius: 4px;
        opacity: 0.5;
        transition: opacity 0.3s, border-color 0.3s, box-shadow 0.3s;
      `,i.dataset.phaseId=t.id;const s=document.createElement("div");s.style.cssText=`
        font-family: 'Cinzel', serif;
        font-size: 10px;
        color: #888888;
        font-weight: bold;
      `,s.textContent=`P${t.id}`,i.appendChild(s);const n=document.createElement("div");n.style.cssText=`
        font-family: 'Cinzel', serif;
        font-size: 10px;
        color: #aaaaaa;
        letter-spacing: 1px;
      `,n.textContent=t.name||`Phase ${t.id}`,i.appendChild(n),this.phaseContainer.appendChild(i),this.phaseIndicators.push({element:i,phaseId:t.id,name:t.name})}this.phaseIndicators.length>0&&this._highlightPhaseIndicator(1)}}_highlightPhaseIndicator(e){for(const t of this.phaseIndicators)t.phaseId===e?(t.element.style.opacity="1",t.element.style.borderColor="rgba(255, 180, 80, 0.8)",t.element.style.boxShadow="0 0 10px rgba(255, 180, 80, 0.4)",t.element.style.animation="phaseIndicatorPulse 2s ease-in-out infinite"):t.phaseId<e?(t.element.style.opacity="0.4",t.element.style.borderColor="rgba(100, 100, 100, 0.3)",t.element.style.boxShadow="none",t.element.style.animation="none"):(t.element.style.opacity="0.5",t.element.style.borderColor="rgba(100, 100, 100, 0.4)",t.element.style.boxShadow="none",t.element.style.animation="none")}_updatePhaseDisplay(e,t){t&&t.name&&(this.phaseNameLabel.textContent=t.name.toUpperCase(),this.phaseNameLabel.style.opacity="1",e===1?this.phaseNameLabel.style.color="#888888":e===2?this.phaseNameLabel.style.color="#ffaa44":this.phaseNameLabel.style.color="#ff6644"),this._highlightPhaseIndicator(e);for(const i of this.phaseMarkers)i.phase<=e&&!i.triggered&&(i.triggered=!0,i.element.style.background="linear-gradient(180deg, rgba(255,100,50,0.9) 0%, rgba(200,50,20,0.7) 100%)")}_updateHealthBar(e,t){const i=Math.max(0,Math.min(100,e/t*100));this.healthBarFill.style.width=`${i}%`,this.healthText.textContent=`${Math.ceil(e)} / ${Math.ceil(t)}`,i<=20?(this.healthBarFill.style.background="linear-gradient(180deg, #ff4422 0%, #cc2200 50%, #991100 100%)",this.healthBarWrapper.style.animation="healthBarDanger 0.5s ease-in-out infinite"):i<=50?(this.healthBarFill.style.background="linear-gradient(180deg, #dd6633 0%, #bb4422 50%, #992211 100%)",this.healthBarWrapper.style.animation="none"):(this.healthBarFill.style.background="linear-gradient(180deg, #cc3333 0%, #aa2222 50%, #881111 100%)",this.healthBarWrapper.style.animation="none")}_updateDamageChunk(e,t,i){const s=e/t*100,n=this.damageChunkHealth/t*100;e<this.lastHealth&&(this.damageChunkBar.style.width=`${n}%`,this.damageChunkTimer=.8),this.damageChunkTimer>0?(this.damageChunkTimer-=i,this.damageChunkTimer<=0&&(this.damageChunkHealth=e,this.damageChunkBar.style.width=`${s}%`)):(this.damageChunkHealth=e,this.damageChunkBar.style.width=`${s}%`),this.lastHealth=e}showDamageNumber(e,t,i=!1,s=!1){const n=this.damageNumberPool.find(c=>!c.active);if(!n)return;n.active=!0,n.timer=1;const a=n.element;let o,r;t&&t.x!==void 0&&t.y!==void 0&&t.z!==void 0?(o=window.innerWidth/2+(Math.random()-.5)*200,r=window.innerHeight-140+(Math.random()-.5)*40):(o=window.innerWidth/2+(Math.random()-.5)*200,r=window.innerHeight-140),a.style.left=`${o}px`,a.style.top=`${r}px`,a.textContent=Math.ceil(e).toString(),a.style.opacity="1",a.style.transform="translateY(0) scale(1.2)",a.classList.remove("critical","weak"),i?a.classList.add("critical"):s&&a.classList.add("weak"),a.style.animation="damageNumberFloat 1s ease-out forwards",this.activeDamageNumbers.push(n)}_updateDamageNumbers(e){for(let t=this.activeDamageNumbers.length-1;t>=0;t--){const i=this.activeDamageNumbers[t];i.timer-=e,i.timer<=0&&(i.active=!1,i.element.style.opacity="0",i.element.style.animation="none",i.element.classList.remove("critical","weak"),this.activeDamageNumbers.splice(t,1))}}showEnrage(e,t=0){this.enrageTimerActive=e,this.enrageTimeRemaining=t,e?(this.enrageContainer.style.opacity="1",t>0?this.enrageText.textContent=`ENRAGED ${Math.ceil(t)}s`:this.enrageText.textContent="ENRAGED",this.healthBarWrapper.style.borderColor="rgba(255, 100, 50, 0.9)"):(this.enrageContainer.style.opacity="0",this.healthBarWrapper.style.borderColor="rgba(180, 120, 60, 0.6)")}playPhaseTransition(e,t){this.phaseTransitionAnimating=!0,this.healthBarWrapper.style.animation="phaseTransitionGlow 0.5s ease-out 3",this._updatePhaseDisplay(e,t),this.nameLabel.style.textShadow="0 0 30px rgba(255, 200, 100, 1), 0 0 60px rgba(255, 180, 80, 0.8)",setTimeout(()=>{this.nameLabel.style.textShadow="0 0 12px rgba(255, 180, 80, 0.5), 0 2px 4px rgba(0, 0, 0, 0.9)",this.healthBarWrapper.style.animation="none",this.phaseTransitionAnimating=!1},1500)}update(e){if(!this.isVisible||!this.bossAI)return;const t=this.bossAI.getStateInfo();if(!t||t.isDead){this.hide();return}if(this._updateHealthBar(t.health,t.maxHealth),this._updateDamageChunk(t.health,t.maxHealth,e),t.phase!==this.lastPhase){const i=this.bossData?.phases?.find(s=>s.id===t.phase);this.playPhaseTransition(t.phase,i),this.lastPhase=t.phase}this.showEnrage(t.isEnraged),this._updateDamageNumbers(e)}show(){this.isVisible||(this.isVisible=!0,this.container.style.opacity="1",this.container.style.animation="bossAppear 0.8s ease-out forwards")}hide(){if(this.isVisible){this.isVisible=!1,this.container.style.opacity="0",this.container.style.animation="none",this.activeBoss=null,this.bossAI=null,this.enrageTimerActive=!1,this.lastPhase=1;for(const e of this.phaseMarkers)e.triggered=!1}}reset(){this.hide();for(const e of this.activeDamageNumbers)e.active=!1,e.element.style.opacity="0";this.activeDamageNumbers=[],this.lastHealth=0,this.damageChunkHealth=0,this.damageChunkTimer=0}dispose(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container);for(const t of this.damageNumberPool)t.element&&t.element.parentNode&&t.element.parentNode.removeChild(t.element);const e=document.getElementById("boss-ui-styles");e&&e.parentNode.removeChild(e)}}const Ds={golem:{body:5921386,accent:4491519,eye:4500223,glow:4491519,aura:2241382,phase2:16737860,phase3:16720384},wraith:{body:1710634,accent:6693546,eye:11150079,glow:6693546,aura:2228275,phase2:11158783,phase3:16711935},treant:{body:3820074,accent:6728260,eye:8978244,glow:4500002,aura:2245649,phase2:11193412,phase3:16746564},knight:{body:2763317,accent:8912964,eye:16720452,glow:8912964,aura:3342370,phase2:11149909,phase3:16711748}};class TS{constructor(){this.modelCache=new Map,this.particleSystems=new Map,this.activeEffects=[],console.log("[BossRenderer] Initialized")}createBossModel(e,t={}){const i=e.toLowerCase(),s=new ne;switch(s.userData.bossType=i,s.userData.bossData=t,s.userData.currentPhase=1,i){case"golem":this.buildGolem(s,t);break;case"wraith":this.buildWraith(s,t);break;case"treant":case"guardian":this.buildTreant(s,t);break;case"knight":this.buildKnight(s,t);break;default:this.buildGolem(s,t)}return this.addBossAura(s,i),this.addPhaseIndicator(s,i),s}buildGolem(e,t){const i=Ds.golem,s=t.scale||3.5,n=new ne;e.add(n),e.userData.body=n;const a=new X({color:i.body,roughness:.9,metalness:.1,flatShading:!0}),o=new Ni(1,1),r=new w(o,a);r.position.set(0,1.8,0),r.scale.set(1.4,1.2,1.1),r.castShadow=!0,n.add(r);const c=new Ni(.8,1),h=new w(c,a);h.position.set(0,2.8,.1),h.scale.set(1.3,1,1),h.castShadow=!0,n.add(h);const d=new X({color:i.accent,emissive:i.accent,emissiveIntensity:2.5,transparent:!0,opacity:.85}),u=new Ji(.35,0),p=new w(u,d);p.position.set(0,2,.55),p.rotation.z=Math.PI/4,n.add(p),e.userData.core=p;const f=new We(i.accent,1.5,6);f.position.copy(p.position),n.add(f),e.userData.coreLight=f,this.addGolemCrystals(n,i);const y=new X({color:4868698,roughness:.85,metalness:.15,flatShading:!0}),m=new js(.4,0),g=new w(m,y);g.position.set(0,3.5,.25),g.scale.set(1,.8,.9),g.castShadow=!0,n.add(g);const x=new X({color:i.eye,emissive:i.eye,emissiveIntensity:5}),v=new Ji(.12,0),b=new w(v,x.clone());b.position.set(-.15,3.55,.5),b.rotation.z=Math.PI/4,n.add(b);const _=new w(v,x.clone());_.position.set(.15,3.55,.5),_.rotation.z=Math.PI/4,n.add(_),e.userData.eyes=[b,_];const S=new We(i.eye,.8,3);S.position.set(0,3.55,.6),n.add(S),e.userData.eyeLight=S,this.buildGolemArms(n,i),this.buildGolemLegs(n,i);const A=this.createRockDebrisParticles(i);e.add(A),e.userData.particles=A,e.scale.setScalar(s),e.userData.bodyMaterial=a,e.userData.coreMaterial=d,e.userData.eyeMaterial=x}addGolemCrystals(e,t){const i=new X({color:t.accent,emissive:t.accent,emissiveIntensity:1.5,transparent:!0,opacity:.75}),s=[{x:-.6,y:2.5,z:.3,scale:.25,rot:.3},{x:.65,y:2.3,z:.2,scale:.2,rot:-.4},{x:0,y:3.2,z:-.3,scale:.3,rot:.6},{x:-.45,y:1.5,z:.5,scale:.18,rot:.1},{x:.5,y:1.7,z:.45,scale:.22,rot:-.2},{x:.2,y:2.9,z:-.25,scale:.15,rot:.5}],n=[];s.forEach(a=>{const o=new wt(a.scale,a.scale*2.5,5),r=new w(o,i.clone());r.position.set(a.x,a.y,a.z),r.rotation.set(a.rot,Math.random()*Math.PI,a.rot*.5),r.castShadow=!0,e.add(r),n.push(r)}),e.userData.crystals=n}buildGolemArms(e,t){const i=new X({color:t.body,roughness:.9,metalness:.1,flatShading:!0}),s=new ne;s.position.set(-1.2,2.2,0);const n=new Ni(.4,0),a=new w(n,i);a.position.set(-.3,0,0),a.scale.set(.9,1.4,.8),a.castShadow=!0,s.add(a);const o=new Ni(.35,0),r=new w(o,i);r.position.set(-.6,-.6,.1),r.scale.set(.8,1.3,.75),r.castShadow=!0,s.add(r);const c=new Ni(.5,1),h=new w(c,i);h.position.set(-.85,-1.3,.15),h.castShadow=!0,s.add(h),s.rotation.z=.3,e.add(s),e.userData.leftArm=s;const d=new ne;d.position.set(1.2,2.2,0);const u=new w(n,i);u.position.set(.3,0,0),u.scale.set(.9,1.4,.8),u.castShadow=!0,d.add(u);const p=new w(o,i);p.position.set(.6,-.6,.1),p.scale.set(.8,1.3,.75),p.castShadow=!0,d.add(p);const f=new w(c,i);f.position.set(.85,-1.3,.15),f.castShadow=!0,d.add(f),d.rotation.z=-.3,e.add(d),e.userData.rightArm=d}buildGolemLegs(e,t){const i=new X({color:4868693,roughness:.9,metalness:.1,flatShading:!0}),s=new ce(.35,.45,1.4,8),n=new w(s,i);n.position.set(-.5,.7,0),n.castShadow=!0,e.add(n);const a=new w(s,i);a.position.set(.5,.7,0),a.castShadow=!0,e.add(a);const o=new ce(.5,.55,.2,8),r=new w(o,i);r.position.set(-.5,.1,.05),r.castShadow=!0,e.add(r);const c=new w(o,i);c.position.set(.5,.1,.05),c.castShadow=!0,e.add(c)}createRockDebrisParticles(e){const i=new Float32Array(90),s=new Float32Array(90),n=new Float32Array(30),a=new H(e.body);for(let h=0;h<30;h++){i[h*3]=(Math.random()-.5)*2,i[h*3+1]=Math.random()*3+.5,i[h*3+2]=(Math.random()-.5)*1.5;const d=.8+Math.random()*.4;s[h*3]=a.r*d,s[h*3+1]=a.g*d,s[h*3+2]=a.b*d,n[h]=.05+Math.random()*.08}const o=new mt;o.setAttribute("position",new Je(i,3)),o.setAttribute("color",new Je(s,3)),o.setAttribute("size",new Je(n,1));const r=new Ri({size:.1,vertexColors:!0,transparent:!0,opacity:.6,depthWrite:!1}),c=new Bi(o,r);return c.userData.time=0,c.userData.basePositions=i.slice(),c.userData.type="rock_debris",c}buildWraith(e,t){const i=Ds.wraith,s=t.scale||2.5,n=new ne;e.add(n),e.userData.body=n;const a=new X({color:i.body,roughness:.3,metalness:.2,transparent:!0,opacity:.85,side:lt}),o=new Pt(.5,.8,12,20),r=new w(o,a);r.position.set(0,2,0),r.scale.set(1,1.2,.7),r.castShadow=!0,n.add(r);const c=new Pt(.35,.5,10,16),h=new w(c,a);h.position.set(0,2.9,.1),h.scale.set(.9,1,.8),h.castShadow=!0,n.add(h);const d=new X({color:i.accent,emissive:i.accent,emissiveIntensity:3,transparent:!0,opacity:.6}),u=new re(.25,16,12),p=new w(u,d);p.position.set(0,2.2,0),n.add(p),e.userData.core=p;const f=new We(i.accent,1,5);f.position.copy(p.position),n.add(f),e.userData.coreLight=f;const y=new X({color:1710629,roughness:.4,metalness:.1,transparent:!0,opacity:.9}),m=new re(.4,16,12,0,Math.PI*2,0,Math.PI*.7),g=new w(m,y);g.position.set(0,3.3,0),g.rotation.x=.3,g.scale.set(1.1,1,1),g.castShadow=!0,n.add(g);const x=new X({color:i.eye,emissive:i.eye,emissiveIntensity:6}),v=new re(.08,12,8),b=new w(v,x.clone());b.position.set(-.12,3.25,.32),n.add(b);const _=new w(v,x.clone());_.position.set(.12,3.25,.32),n.add(_),e.userData.eyes=[b,_];const S=new X({color:i.eye,emissive:i.eye,emissiveIntensity:3,transparent:!0,opacity:.5}),A=new Pt(.03,.15,4,8),R=new w(A,S);R.position.set(-.15,3.25,.25),R.rotation.x=Math.PI/2,R.rotation.z=.3,n.add(R);const M=new w(A,S);M.position.set(.15,3.25,.25),M.rotation.x=Math.PI/2,M.rotation.z=-.3,n.add(M);const C=new We(i.eye,.6,3);C.position.set(0,3.25,.4),n.add(C),e.userData.eyeLight=C,this.buildWraithArms(n,i),this.buildWraithTail(n,i);const k=this.createShadowWispParticles(i);e.add(k),e.userData.particles=k,e.scale.setScalar(s),e.userData.bodyMaterial=a,e.userData.coreMaterial=d,e.userData.eyeMaterial=x}buildWraithArms(e,t){const i=new X({color:t.body,roughness:.3,metalness:.1,transparent:!0,opacity:.75}),s=new ne;s.position.set(-.5,2.4,0);for(let o=0;o<5;o++){const r=.12-o*.015,c=new Pt(r,.25,6,10),h=new w(c,i);h.position.set(-o*.22,-o*.15,o*.08),h.rotation.z=.2+o*.1,h.castShadow=!0,s.add(h)}const n=new X({color:1118488,roughness:.4,metalness:.3,emissive:t.accent,emissiveIntensity:.5});for(let o=0;o<4;o++){const r=new wt(.03,.2,4),c=new w(r,n);c.position.set(-1+o*.06,-.85,.4+Math.abs(o-1.5)*.03),c.rotation.x=.6,c.rotation.z=.2-o*.1,s.add(c)}e.add(s),e.userData.leftArm=s;const a=new ne;a.position.set(.5,2.4,0);for(let o=0;o<5;o++){const r=.12-o*.015,c=new Pt(r,.25,6,10),h=new w(c,i);h.position.set(o*.22,-o*.15,o*.08),h.rotation.z=-.2-o*.1,h.castShadow=!0,a.add(h)}for(let o=0;o<4;o++){const r=new wt(.03,.2,4),c=new w(r,n);c.position.set(1-o*.06,-.85,.4+Math.abs(o-1.5)*.03),c.rotation.x=.6,c.rotation.z=-.2+o*.1,a.add(c)}e.add(a),e.userData.rightArm=a}buildWraithTail(e,t){const i=new X({color:t.body,roughness:.3,metalness:.1,transparent:!0,opacity:.6,side:lt}),s=[];for(let n=0;n<6;n++){const a=.6-n*.08,o=.4,r=new Dt(a,o,4,2),c=r.attributes.position;for(let d=0;d<c.count;d++){const u=c.getY(d);c.setZ(d,Math.sin((u+.2)*2)*.1)}r.computeVertexNormals();const h=new w(r,i.clone());h.material.opacity=.6-n*.08,h.position.set(0,1-n*.35,-.1-n*.1),h.rotation.x=-.3-n*.1,s.push(h),e.add(h)}e.userData.tailSegments=s}createShadowWispParticles(e){const i=new Float32Array(120),s=new Float32Array(120),n=new H(e.glow);for(let c=0;c<40;c++){i[c*3]=(Math.random()-.5)*1.5,i[c*3+1]=Math.random()*3.5+.5,i[c*3+2]=(Math.random()-.5)*1.2;const h=.7+Math.random()*.5;s[c*3]=n.r*h,s[c*3+1]=n.g*h,s[c*3+2]=n.b*h}const a=new mt;a.setAttribute("position",new Je(i,3)),a.setAttribute("color",new Je(s,3));const o=new Ri({size:.12,vertexColors:!0,transparent:!0,opacity:.7,blending:ui,depthWrite:!1}),r=new Bi(a,o);return r.userData.time=0,r.userData.basePositions=i.slice(),r.userData.type="shadow_wisp",r}buildTreant(e,t){const i=Ds.treant,s=t.scale||4,n=new ne;e.add(n),e.userData.body=n;const a=new X({color:i.body,roughness:.95,metalness:.05}),o=new ce(.5,.7,2,12,4,!1),r=o.attributes.position;for(let M=0;M<r.count;M++){const C=r.getX(M),k=r.getZ(M),L=r.getY(M),O=Math.sin(L*3+M*.5)*.08;r.setX(M,C+O),r.setZ(M,k+O*.7)}o.computeVertexNormals();const c=new w(o,a);c.position.set(0,1.3,0),c.castShadow=!0,n.add(c);const h=new re(.7,12,10),d=new w(h,a);d.position.set(0,2.5,0),d.scale.set(1.3,.8,1),d.castShadow=!0,n.add(d);const u=new X({color:3815978,roughness:.9,metalness:.05}),p=new re(.5,12,10),f=new w(p,u);f.position.set(0,3.2,.25),f.scale.set(.9,1.1,.8),f.castShadow=!0,n.add(f);const y=new X({color:i.eye,emissive:i.eye,emissiveIntensity:4}),m=new re(.1,10,8),g=new w(m,y.clone());g.position.set(-.18,3.3,.5),n.add(g);const x=new w(m,y.clone());x.position.set(.18,3.3,.5),n.add(x),e.userData.eyes=[g,x];const v=new We(i.eye,.7,4);v.position.set(0,3.3,.6),n.add(v),e.userData.eyeLight=v,this.buildTreantCrown(n,i),this.buildTreantArms(n,i),this.buildTreantLegs(n,i),this.addTreantFoliage(n,i);const b=this.createLeafParticles(i);e.add(b),e.userData.particles=b;const _=new X({color:i.glow,emissive:i.glow,emissiveIntensity:2,transparent:!0,opacity:.6}),S=new re(.3,12,10),A=new w(S,_);A.position.set(0,2,0),n.add(A),e.userData.core=A;const R=new We(i.glow,.5,4);R.position.copy(A.position),n.add(R),e.userData.coreLight=R,e.scale.setScalar(s),e.userData.bodyMaterial=a,e.userData.coreMaterial=_,e.userData.eyeMaterial=y}buildTreantCrown(e,t){const i=new X({color:4864554,roughness:.9,metalness:.05});[{x:-.3,angle:.5,height:.8},{x:.3,angle:-.5,height:.8},{x:-.15,angle:.3,height:.6},{x:.15,angle:-.3,height:.6},{x:0,angle:0,height:.5}].forEach(n=>{const a=new ce(.04,.08,n.height,6),o=new w(a,i);o.position.set(n.x,3.6+n.height*.4,-.1),o.rotation.z=n.angle,o.rotation.x=-.2,o.castShadow=!0,e.add(o);for(let r=0;r<2;r++){const c=new ce(.02,.035,.25,5),h=new w(c,i);h.position.set(n.x+(r===0?-.15:.15),3.9+n.height*.3,-.05),h.rotation.z=n.angle+(r===0?.4:-.4),e.add(h)}})}buildTreantArms(e,t){const i=new X({color:t.body,roughness:.9,metalness:.05}),s=new ne;s.position.set(-.9,2.3,0);const n=new ce(.12,.18,.8,8),a=new w(n,i);a.position.set(-.25,0,0),a.rotation.z=Math.PI/2+.3,a.castShadow=!0,s.add(a);const o=new ce(.08,.12,.7,8),r=new w(o,i);r.position.set(-.65,-.3,.1),r.rotation.z=.5,r.castShadow=!0,s.add(r);const c=new X({color:4872762,roughness:.85});for(let p=0;p<4;p++){const f=new ce(.02,.04,.35,5),y=new w(f,c);y.position.set(-.9+p*.08,-.6,.15+Math.abs(p-1.5)*.03),y.rotation.z=.3-p*.15,y.rotation.x=.2,s.add(y)}e.add(s),e.userData.leftArm=s;const h=new ne;h.position.set(.9,2.3,0);const d=new w(n,i);d.position.set(.25,0,0),d.rotation.z=-Math.PI/2-.3,d.castShadow=!0,h.add(d);const u=new w(o,i);u.position.set(.65,-.3,.1),u.rotation.z=-.5,u.castShadow=!0,h.add(u);for(let p=0;p<4;p++){const f=new ce(.02,.04,.35,5),y=new w(f,c);y.position.set(.9-p*.08,-.6,.15+Math.abs(p-1.5)*.03),y.rotation.z=-.3+p*.15,y.rotation.x=.2,h.add(y)}e.add(h),e.userData.rightArm=h}buildTreantLegs(e,t){const i=new X({color:3813408,roughness:.95,metalness:.02});[{x:-.4,z:.2,angle:.15},{x:.4,z:.2,angle:-.15},{x:-.3,z:-.25,angle:.1},{x:.3,z:-.25,angle:-.1}].forEach(n=>{const a=new ce(.1,.15,.6,8),o=new w(a,i);o.position.set(n.x,.3,n.z),o.rotation.z=n.angle,o.castShadow=!0,e.add(o);for(let r=0;r<2;r++){const c=new ce(.03,.06,.3,6),h=new w(c,i);h.position.set(n.x+(r===0?-.15:.15),.08,n.z+.15),h.rotation.x=Math.PI/4,h.rotation.z=(r===0?.3:-.3)+n.angle,e.add(h)}})}addTreantFoliage(e,t){const i=new X({color:t.accent,roughness:.8,metalness:0,side:lt});[{x:-.5,y:3.8,z:.1},{x:.5,y:3.8,z:.1},{x:0,y:4,z:-.1},{x:-.35,y:3.5,z:.3},{x:.35,y:3.5,z:.3},{x:-.8,y:2.8,z:.2},{x:.8,y:2.8,z:.2}].forEach(a=>{const o=new re(.18,8,6),r=new w(o,i);r.position.set(a.x,a.y,a.z),r.scale.set(1.2,.8,1),e.add(r)});const n=new X({color:3824170,roughness:.9});for(let a=0;a<4;a++){const o=new ce(.015,.02,.6,5),r=new w(o,n);r.position.set((Math.random()-.5)*.8,2.6-Math.random()*.3,.4+Math.random()*.2),r.rotation.x=.1,r.rotation.z=(Math.random()-.5)*.3,e.add(r)}}createLeafParticles(e){const i=new Float32Array(150),s=new Float32Array(150),n=new H(e.accent);for(let c=0;c<50;c++){i[c*3]=(Math.random()-.5)*2.5,i[c*3+1]=Math.random()*4+.5,i[c*3+2]=(Math.random()-.5)*2;const h=.7+Math.random()*.5;s[c*3]=n.r*h,s[c*3+1]=n.g*h,s[c*3+2]=n.b*h}const a=new mt;a.setAttribute("position",new Je(i,3)),a.setAttribute("color",new Je(s,3));const o=new Ri({size:.08,vertexColors:!0,transparent:!0,opacity:.8,depthWrite:!1}),r=new Bi(a,o);return r.userData.time=0,r.userData.basePositions=i.slice(),r.userData.type="leaves",r}buildKnight(e,t){const i=Ds.knight,s=t.scale||2,n=new ne;e.add(n),e.userData.body=n;const a=new X({color:i.body,roughness:.4,metalness:.85}),o=new ie(.7,.8,.45),r=new w(o,a);r.position.set(0,1.6,0),r.castShadow=!0,n.add(r);const c=new X({color:i.accent,emissive:i.accent,emissiveIntensity:2});for(let U=0;U<3;U++){const $=new ie(.02,.5,.02),G=new w($,c);G.position.set(-.15+U*.15,1.6,.24),n.add(G)}const h=new re(.22,10,8),d=new w(h,a);d.position.set(-.5,1.9,0),d.scale.set(1.3,1,1.1),d.castShadow=!0,n.add(d);const u=new w(h,a);u.position.set(.5,1.9,0),u.scale.set(1.3,1,1.1),u.castShadow=!0,n.add(u);const p=new X({color:1710624,roughness:.3,metalness:.9});[-.6,.6].forEach(U=>{const $=new wt(.04,.2,5),G=new w($,p);G.position.set(U,2.1,0),G.rotation.z=U>0?-.3:.3,n.add(G)});const f=new X({color:2763312,roughness:.35,metalness:.9}),y=new re(.25,12,10),m=new w(y,f);m.position.set(0,2.35,0),m.scale.set(1.1,1.2,1),m.castShadow=!0,n.add(m);const g=new ie(.28,.08,.12),x=new w(g,f);x.position.set(0,2.32,.2),n.add(x);const v=new X({color:i.eye,emissive:i.eye,emissiveIntensity:5}),b=new re(.04,8,6),_=new w(b,v.clone());_.position.set(-.07,2.32,.22),n.add(_);const S=new w(b,v.clone());S.position.set(.07,2.32,.22),n.add(S),e.userData.eyes=[_,S];const A=new We(i.eye,.6,2);A.position.set(0,2.32,.3),n.add(A),e.userData.eyeLight=A,this.buildKnightCape(n,i),this.buildKnightArms(n,i),this.buildKnightLegs(n,i);const R=this.buildKnightSword(i);R.position.set(.75,1.2,.2),R.rotation.z=-.4,n.add(R),e.userData.weapon=R;const M=this.buildKnightShield(i);M.position.set(-.65,1.4,.15),M.rotation.y=.3,n.add(M),e.userData.shield=M;const C=this.createDarkFlameParticles(i);e.add(C),e.userData.particles=C;const k=new X({color:i.glow,emissive:i.glow,emissiveIntensity:2,transparent:!0,opacity:.7}),L=new re(.15,10,8),O=new w(L,k);O.position.set(0,1.6,.15),n.add(O),e.userData.core=O;const W=new We(i.glow,.4,3);W.position.copy(O.position),n.add(W),e.userData.coreLight=W,e.scale.setScalar(s),e.userData.bodyMaterial=a,e.userData.coreMaterial=k,e.userData.eyeMaterial=v}buildKnightCape(e,t){const i=new X({color:2756640,roughness:.9,metalness:.1,side:lt}),s=new Dt(.8,1.2,6,10),n=s.attributes.position;for(let r=0;r<n.count;r++){const c=n.getY(r),h=n.getX(r);n.setZ(r,-.15-c*.2-Math.abs(h)*.15)}s.computeVertexNormals();const a=new w(s,i);a.position.set(0,1.2,-.25),a.rotation.x=.1,a.castShadow=!0,e.add(a),e.userData.cape=a;const o=new X({color:1706512,roughness:.95,side:lt});for(let r=0;r<5;r++){const c=new mt,h=new Float32Array([-.1,0,0,.1,0,0,0,-.2-Math.random()*.15,-.05]);c.setAttribute("position",new Je(h,3)),c.computeVertexNormals();const d=new w(c,o);d.position.set(-.3+r*.15,.55,-.35),e.add(d)}}buildKnightArms(e,t){const i=new X({color:t.body,roughness:.4,metalness:.85}),s=new ne;s.position.set(-.45,1.7,0);const n=new ce(.1,.12,.4,8),a=new w(n,i);a.position.set(-.15,-.1,0),a.rotation.z=.4,a.castShadow=!0,s.add(a);const o=new ce(.08,.1,.35,8),r=new w(o,i);r.position.set(-.35,-.35,.05),r.rotation.z=.2,r.castShadow=!0,s.add(r);const c=new ie(.12,.1,.14),h=new w(c,i);h.position.set(-.45,-.55,.08),h.castShadow=!0,s.add(h),e.add(s),e.userData.leftArm=s;const d=new ne;d.position.set(.45,1.7,0);const u=new w(n,i);u.position.set(.15,-.1,0),u.rotation.z=-.4,u.castShadow=!0,d.add(u);const p=new w(o,i);p.position.set(.35,-.35,.05),p.rotation.z=-.2,p.castShadow=!0,d.add(p);const f=new w(c,i);f.position.set(.45,-.55,.08),f.castShadow=!0,d.add(f),e.add(d),e.userData.rightArm=d}buildKnightLegs(e,t){const i=new X({color:t.body,roughness:.4,metalness:.85}),s=new ie(.7,.25,.35),n=new w(s,i);n.position.set(0,1.15,0),n.castShadow=!0,e.add(n);const a=new ce(.12,.14,.5,8),o=new w(a,i);o.position.set(-.2,.75,0),o.castShadow=!0,e.add(o);const r=new ce(.1,.12,.45,8),c=new w(r,i);c.position.set(-.2,.3,.02),c.castShadow=!0,e.add(c);const h=new ie(.14,.1,.25),d=new w(h,i);d.position.set(-.2,.05,.05),d.castShadow=!0,e.add(d);const u=new w(a,i);u.position.set(.2,.75,0),u.castShadow=!0,e.add(u);const p=new w(r,i);p.position.set(.2,.3,.02),p.castShadow=!0,e.add(p);const f=new w(h,i);f.position.set(.2,.05,.05),f.castShadow=!0,e.add(f)}buildKnightSword(e){const t=new ne,i=new X({color:3816005,roughness:.25,metalness:.95,emissive:e.accent,emissiveIntensity:.3}),s=new ie(.06,1.2,.02),n=new w(s,i);n.position.y=.6,n.castShadow=!0,t.add(n);const a=new wt(.03,.15,4),o=new w(a,i);o.position.y=1.25,t.add(o);const r=new X({color:e.accent,emissive:e.accent,emissiveIntensity:3}),c=new ie(.015,1,.015),h=new w(c,r);h.position.set(0,.55,.015),t.add(h);const d=new X({color:2760741,roughness:.4,metalness:.8}),u=new ie(.25,.04,.04),p=new w(u,d);p.position.y=0,t.add(p);const f=new ce(.025,.03,.25,8),y=new w(f,new X({color:1708053,roughness:.8}));y.position.y=-.15,t.add(y);const m=new re(.04,8,6),g=new w(m,d);return g.position.y=-.3,t.add(g),t}buildKnightShield(e){const t=new ne,i=new X({color:2763317,roughness:.4,metalness:.8}),s=new ie(.35,.5,.05),n=new w(s,i);n.castShadow=!0,t.add(n);const a=new X({color:e.accent,emissive:e.accent,emissiveIntensity:1.5,roughness:.3,metalness:.7}),o=new re(.08,10,8),r=new w(o,a);r.position.z=.04,r.scale.z=.5,t.add(r);for(let c=0;c<4;c++){const h=new ie(.01,.15,.01),d=new w(h,a);d.position.set(Math.cos(c*Math.PI/2)*.12,Math.sin(c*Math.PI/2)*.12,.03),d.rotation.z=c*Math.PI/2,t.add(d)}return t}createDarkFlameParticles(e){const i=new Float32Array(105),s=new Float32Array(105),n=new H(e.glow);for(let c=0;c<35;c++){i[c*3]=(Math.random()-.5)*1.2,i[c*3+1]=Math.random()*2.5+.3,i[c*3+2]=(Math.random()-.5)*.8;const h=.6+Math.random()*.6;s[c*3]=n.r*h,s[c*3+1]=n.g*h,s[c*3+2]=n.b*h}const a=new mt;a.setAttribute("position",new Je(i,3)),a.setAttribute("color",new Je(s,3));const o=new Ri({size:.1,vertexColors:!0,transparent:!0,opacity:.75,blending:ui,depthWrite:!1}),r=new Bi(a,o);return r.userData.time=0,r.userData.basePositions=i.slice(),r.userData.type="dark_flame",r}addBossAura(e,t){const i=Ds[t]||Ds.golem,s=new Ki(1.5,2,32),n=new B({color:i.aura,transparent:!0,opacity:.3,side:lt}),a=new w(s,n);a.rotation.x=-Math.PI/2,a.position.y=.05,e.add(a),e.userData.aura=a}addPhaseIndicator(e,t){const i=Ds[t]||Ds.golem,s=new re(.15,12,8),n=new X({color:i.glow,emissive:i.glow,emissiveIntensity:2,transparent:!0,opacity:.8}),a=new w(s,n);a.position.y=4.5,e.add(a),e.userData.phaseIndicator=a}applyPhaseVisual(e,t,i={}){const s=e.userData.bossType,n=Ds[s]||Ds.golem;let a;switch(t){case 2:a=n.phase2;break;case 3:a=n.phase3;break;default:a=n.glow}e.userData.phaseIndicator&&(e.userData.phaseIndicator.material.color.setHex(a),e.userData.phaseIndicator.material.emissive&&(e.userData.phaseIndicator.material.emissive.setHex(a),e.userData.phaseIndicator.material.emissiveIntensity=2+t)),e.userData.eyes&&e.userData.eyes.forEach(o=>{o.material.color.setHex(a),o.material.emissive&&(o.material.emissive.setHex(a),o.material.emissiveIntensity=4+t*2)}),e.userData.eyeLight&&(e.userData.eyeLight.color.setHex(a),e.userData.eyeLight.intensity=.5+t*.3),e.userData.core&&e.userData.core.material.emissive&&(e.userData.core.material.emissive.setHex(a),e.userData.core.material.emissiveIntensity=2+t),e.userData.coreLight&&(e.userData.coreLight.color.setHex(a),e.userData.coreLight.intensity=1+t*.5),i.sizeScale&&e.userData.body.scale.setScalar(i.sizeScale),e.userData.aura&&(e.userData.aura.material.color.setHex(a),e.userData.aura.material.opacity=.3+t*.15),e.userData.currentPhase=t}updateBossModel(e,t){e.userData.particles&&this.updateParticles(e.userData.particles,t);const i=Date.now()*.001,s=e.userData.bossType;if(e.userData.eyes){const n=4+Math.sin(i*3)*2;e.userData.eyes.forEach(a=>{a.material.emissive&&(a.material.emissiveIntensity=n)})}if(e.userData.core){const n=2+Math.sin(i*2.5)*1;e.userData.core.material.emissive&&(e.userData.core.material.emissiveIntensity=n)}switch(e.userData.aura&&(e.userData.aura.rotation.z+=t*.3),e.userData.phaseIndicator&&(e.userData.phaseIndicator.position.y=4.5+Math.sin(i*2)*.1),s){case"wraith":this.updateWraithAnimation(e,t,i);break;case"treant":case"guardian":this.updateTreantAnimation(e,t,i);break;case"golem":this.updateGolemAnimation(e,t,i);break;case"knight":this.updateKnightAnimation(e,t,i);break}}updateParticles(e,t){if(!e||!e.userData.basePositions)return;e.userData.time+=t;const i=e.userData.time,s=e.userData.type,n=e.geometry.attributes.position.array,a=e.userData.basePositions;for(let o=0;o<n.length/3;o++){const r=o*.5;switch(s){case"rock_debris":n[o*3]=a[o*3]+Math.sin(i*.5+r)*.2,n[o*3+1]=a[o*3+1]+Math.sin(i+r)*.15,n[o*3+2]=a[o*3+2]+Math.cos(i*.5+r)*.2;break;case"shadow_wisp":n[o*3]=a[o*3]+Math.sin(i*2+r)*.3,n[o*3+1]=a[o*3+1]+(i*.5+r)%3,n[o*3+2]=a[o*3+2]+Math.cos(i*2+r)*.3,n[o*3+1]>4&&(n[o*3+1]=a[o*3+1]);break;case"leaves":n[o*3]=a[o*3]+Math.sin(i+r)*.25,n[o*3+1]=a[o*3+1]+Math.sin(i*.7+r*2)*.2,n[o*3+2]=a[o*3+2]+Math.cos(i*.8+r)*.2;break;case"dark_flame":n[o*3]=a[o*3]+Math.sin(i*3+r)*.15,n[o*3+1]=a[o*3+1]+(i*.8+r)%2.5,n[o*3+2]=a[o*3+2]+Math.cos(i*3+r)*.15,n[o*3+1]>3&&(n[o*3+1]=a[o*3+1]);break}}e.geometry.attributes.position.needsUpdate=!0}updateWraithAnimation(e,t,i){const s=e.userData.body;s&&(s.position.y=Math.sin(i*1.5)*.15,s.rotation.z=Math.sin(i*.8)*.05,s.userData.tailSegments&&s.userData.tailSegments.forEach((n,a)=>{n.rotation.x=-.3-a*.1+Math.sin(i*2+a*.5)*.1}))}updateTreantAnimation(e,t,i){const s=e.userData.body;s&&(s.rotation.z=Math.sin(i*.5)*.02,s.scale.y=1+Math.sin(i*.8)*.01)}updateGolemAnimation(e,t,i){const s=e.userData.body;s&&(s.scale.y=1+Math.sin(i*1.2)*.015,s.userData.crystals&&s.userData.crystals.forEach((n,a)=>{const o=1+Math.sin(i*2+a)*.3;n.material.emissive&&(n.material.emissiveIntensity=o)}))}updateKnightAnimation(e,t,i){const s=e.userData.body;if(s&&(s.scale.y=1+Math.sin(i*1.5)*.01,s.userData.cape)){const n=s.userData.cape.geometry.attributes.position;for(let a=0;a<n.count;a++){const o=-.15-n.getY(a)*.2;n.setZ(a,o+Math.sin(i*3+a*.2)*.03)}s.userData.cape.geometry.attributes.position.needsUpdate=!0}}createGroundCrack(e,t,i=16729088){const s=new ne;s.position.copy(e),s.position.y=.05;const n=new X({color:i,emissive:i,emissiveIntensity:3,transparent:!0,opacity:1});for(let c=0;c<8;c++){const h=c/8*Math.PI*2,d=t*(.6+Math.random()*.4),u=new ie(.05,.02,d),p=new w(u,n.clone());p.position.set(Math.cos(h)*d*.5,0,Math.sin(h)*d*.5),p.rotation.y=-h,s.add(p)}const a=new Ki(.5,t,32),o=new B({color:i,transparent:!0,opacity:.6,side:lt}),r=new w(a,o);return r.rotation.x=-Math.PI/2,s.add(r),s.userData.fadeTime=0,s.userData.maxFadeTime=1.5,this.activeEffects.push({mesh:s,update:c=>{s.userData.fadeTime+=c;const h=s.userData.fadeTime/s.userData.maxFadeTime,d=1-h;return s.traverse(u=>{u.material&&(u.material.opacity=d)}),h<1}}),s}createSummonCircle(e,t=3,i=4500036){const s=new ne;s.position.copy(e),s.position.y=.1;const n=new Ki(t-.1,t,64),a=new B({color:i,transparent:!0,opacity:.8,side:lt}),o=new w(n,a);o.rotation.x=-Math.PI/2,s.add(o);const r=new Zi(t*.8,32),c=new B({color:i,transparent:!0,opacity:.3,side:lt}),h=new w(r,c);h.rotation.x=-Math.PI/2,s.add(h);for(let d=0;d<8;d++){const u=d/8*Math.PI*2,p=new Zi(.15,6),f=new w(p,a.clone());f.position.set(Math.cos(u)*(t-.3),.01,Math.sin(u)*(t-.3)),f.rotation.x=-Math.PI/2,s.add(f)}return s}createProjectileTrail(e=6693546){const t=new ce(.05,.15,.8,8),i=new X({color:e,emissive:e,emissiveIntensity:3,transparent:!0,opacity:.7}),s=new w(t,i);return s.rotation.x=Math.PI/2,s}playDeathAnimation(e,t){const i=e.userData.body;if(!i){t&&t();return}const s=e.userData.bossType;let n=0;const a=4,o=()=>{n+=.016;const r=Math.min(1,n/a);switch(s){case"golem":i.position.y=-r*2,i.rotation.z=Math.sin(n*20)*.1*(1-r),e.userData.particles&&(e.userData.particles.material.size=.1+r*.2);break;case"wraith":i.traverse(c=>{c.material&&(c.material.opacity=1-r)}),i.scale.setScalar(1+r*.5);break;case"treant":case"guardian":i.rotation.x=r*.8,i.position.y=-r*.5,i.position.z=r*1.5;break;case"knight":r<.5?i.position.y=-r*.6:(i.rotation.x=(r-.5)*2*.6,i.position.z=(r-.5)*2*.8);break}e.userData.eyes&&e.userData.eyes.forEach(c=>{c.material.emissive&&(c.material.emissiveIntensity=5*(1-r))}),e.userData.eyeLight&&(e.userData.eyeLight.intensity=.8*(1-r)),e.userData.coreLight&&(e.userData.coreLight.intensity=1.5*(1-r)),r<1?requestAnimationFrame(o):(e.visible=!1,t&&t())};o()}updateEffects(e){this.activeEffects=this.activeEffects.filter(t=>{const i=t.update(e);return!i&&t.mesh.parent&&t.mesh.parent.remove(t.mesh),i})}dispose(){this.modelCache.clear(),this.particleSystems.clear(),this.activeEffects=[]}}const La=new TS,af={stone_pillars:[{type:"pillar",height:6,radius:.8,count:8,ringRadius:22},{type:"debris",count:15}],shadow_barrier:[{type:"obelisk",height:8,count:6,ringRadius:28},{type:"void_crack",count:8}],thick_vegetation:[{type:"tree",count:12,ringRadius:32},{type:"roots",count:20}],ruined_walls:[{type:"wall_segment",count:6,ringRadius:18},{type:"rubble",count:10}]};class ES{constructor(e,t,i,s=null){this.scene=e,this.world=t,this.enemyManager=i,this.saveManager=s,this.activeBosses=new Map,this.arenas=new Map,this.respawnTimers=new Map,this.player=null,this.currentBossFight=null,this.arenaColliders=[],this.onBossActivate=null,this.onBossDefeated=null,this.onArenaEnter=null,this.onArenaExit=null,console.log("[BossSpawner] Initialized")}initialize(e){this.player=e,this.loadState();const t=P1();t.forEach(i=>{this.createBossArena(i)}),console.log(`[BossSpawner] Created ${t.length} boss arenas`)}createBossArena(e){const{bossId:t,name:i,title:s,x:n,z:a,areaName:o,arena:r}=e,c=wd(t);if(!c){console.warn(`[BossSpawner] Unknown boss: ${t}`);return}const h=this.world?this.world.getFloorY(n,a):0,d=new ne;d.position.set(n,h,a),d.userData.bossId=t,this.scene.add(d),this.createArenaVisuals(d,c,r);const u=this.createArenaBoundary(r.radius,r.boundaryType);u.visible=!1,d.add(u);const p=this.createArenaAtmosphere(r);d.add(p);const f=this.createSpawnMarker(c);d.add(f),this.arenas.set(t,{group:d,boundary:u,atmosphere:p,spawnMarker:f,active:!1,position:new T(n,h,a),radius:r.radius,bossData:c}),this.shouldSpawnBoss(t)&&this.spawnBoss(t)}createArenaVisuals(e,t,i){const s=af[i.boundaryType]||af.stone_pillars,n=this.getBossPalette(t.modelType);s.forEach(a=>{switch(a.type){case"pillar":this.createPillars(e,a,n);break;case"obelisk":this.createObelisks(e,a,n);break;case"debris":this.createDebris(e,a,n);break;case"tree":this.createArenaTrees(e,a);break;case"wall_segment":this.createWallSegments(e,a,n);break;case"rubble":this.createRubble(e,a,n);break;case"void_crack":this.createVoidCracks(e,a,n);break;case"roots":this.createRoots(e,a);break}})}createPillars(e,t,i){const s=new X({color:5921386,roughness:.85,metalness:.1});for(let n=0;n<t.count;n++){const a=n/t.count*Math.PI*2,o=Math.cos(a)*t.ringRadius,r=Math.sin(a)*t.ringRadius,c=new ce(t.radius*.8,t.radius,t.height,8),h=new w(c,s);h.position.set(o,t.height/2,r),h.castShadow=!0,h.receiveShadow=!0,e.add(h),Math.random()>.6&&(h.scale.y=.4+Math.random()*.4,h.position.y=t.height*h.scale.y/2)}}createObelisks(e,t,i){const s=new X({color:1710634,roughness:.4,metalness:.3,emissive:2228275,emissiveIntensity:.3});for(let n=0;n<t.count;n++){const a=n/t.count*Math.PI*2,o=Math.cos(a)*t.ringRadius,r=Math.sin(a)*t.ringRadius,c=new ce(.3,.8,t.height,4),h=new w(c,s);h.position.set(o,t.height/2,r),h.rotation.y=Math.random()*Math.PI,h.castShadow=!0,e.add(h);const d=new X({color:6693546,emissive:6693546,emissiveIntensity:2,transparent:!0,opacity:.8}),u=new Dt(.3,.8),p=new w(u,d);p.position.set(o+Math.cos(a+Math.PI/2)*.35,t.height*.6,r+Math.sin(a+Math.PI/2)*.35),p.rotation.y=-a,e.add(p)}}createDebris(e,t,i){const s=new X({color:6974074,roughness:.9,metalness:.05});for(let n=0;n<t.count;n++){const a=Math.random()*18+3,o=Math.random()*Math.PI*2,r=Math.cos(o)*a,c=Math.sin(o)*a,h=.3+Math.random()*.5,d=new Ni(h,0),u=new w(d,s);u.position.set(r,h*.5,c),u.rotation.set(Math.random()*Math.PI,Math.random()*Math.PI,Math.random()*Math.PI),u.castShadow=!0,e.add(u)}}createArenaTrees(e,t){const i=new X({color:3820074,roughness:.9});for(let s=0;s<t.count;s++){const n=s/t.count*Math.PI*2+Math.random()*.3,a=Math.cos(n)*t.ringRadius,o=Math.sin(n)*t.ringRadius,r=6+Math.random()*4,c=new ce(.3,.5,r,6),h=new w(c,i);h.position.set(a,r/2,o),h.castShadow=!0,e.add(h);const d=new X({color:4482611,roughness:.8}),u=new re(2,8,6),p=new w(u,d);p.position.set(a,r+1,o),p.scale.set(1.2,1,1.2),p.castShadow=!0,e.add(p)}}createWallSegments(e,t,i){const s=new X({color:4868693,roughness:.85,metalness:.1});for(let n=0;n<t.count;n++){const a=n/t.count*Math.PI*2,o=Math.cos(a)*t.ringRadius,r=Math.sin(a)*t.ringRadius,c=4+Math.random()*3,h=3+Math.random()*2,d=new ie(c,h,.8),u=new w(d,s);u.position.set(o,h/2,r),u.rotation.y=-a+Math.PI/2,u.castShadow=!0,u.receiveShadow=!0,e.add(u)}}createRubble(e,t,i){const s=new X({color:5921381,roughness:.9});for(let n=0;n<t.count;n++){const a=Math.random()*15+2,o=Math.random()*Math.PI*2,r=Math.cos(o)*a,c=Math.sin(o)*a,h=new ie(.5+Math.random()*1,.3+Math.random()*.5,.5+Math.random()*1),d=new w(h,s);d.position.set(r,.15,c),d.rotation.y=Math.random()*Math.PI,d.castShadow=!0,e.add(d)}}createVoidCracks(e,t,i){const s=new X({color:1114146,emissive:3342421,emissiveIntensity:1.5});for(let n=0;n<t.count;n++){const a=5+Math.random()*15,o=Math.random()*Math.PI*2,r=Math.cos(o)*a,c=Math.sin(o)*a,h=2+Math.random()*3,d=new Dt(.3,h),u=new w(d,s);u.position.set(r,.05,c),u.rotation.x=-Math.PI/2,u.rotation.z=Math.random()*Math.PI,e.add(u)}}createRoots(e,t){const i=new X({color:3813408,roughness:.9});for(let s=0;s<t.count;s++){const n=Math.random()*20+5,a=Math.random()*Math.PI*2,o=Math.cos(a)*n,r=Math.sin(a)*n,c=new ce(.1,.2,2+Math.random()*2,5),h=new w(c,i);h.position.set(o,.2,r),h.rotation.x=Math.PI/4,h.rotation.y=Math.random()*Math.PI,h.castShadow=!0,e.add(h)}}createArenaBoundary(e,t){const i=new ne,s=new ce(e,e,10,32,1,!0),n=new B({color:16711680,transparent:!0,opacity:0,side:lt}),a=new w(s,n);a.position.y=5,i.add(a);const o=new B({color:8934690,transparent:!0,opacity:0,side:lt}),r=new ce(e-.5,e-.5,8,32,1,!0),c=new w(r,o);return c.position.y=4,i.add(c),i.userData.fog=c,i}createArenaAtmosphere(e){const t=new ne,i=50,s=new Float32Array(i*3),n=new Float32Array(i*3),a=new H(e.ambientColor||4478310);for(let h=0;h<i;h++){const d=Math.random()*e.radius,u=Math.random()*Math.PI*2;s[h*3]=Math.cos(u)*d,s[h*3+1]=.5+Math.random()*4,s[h*3+2]=Math.sin(u)*d,n[h*3]=a.r*(.5+Math.random()*.5),n[h*3+1]=a.g*(.5+Math.random()*.5),n[h*3+2]=a.b*(.5+Math.random()*.5)}const o=new mt;o.setAttribute("position",new Je(s,3)),o.setAttribute("color",new Je(n,3));const r=new Ri({size:.15,vertexColors:!0,transparent:!0,opacity:.5,depthWrite:!1}),c=new Bi(o,r);return c.userData.basePositions=s.slice(),t.add(c),t.userData.particles=c,t}createSpawnMarker(e){const t=new ne,i=new X({color:e.glowColor||16729088,emissive:e.glowColor||16729088,emissiveIntensity:1.5,transparent:!0,opacity:.6}),s=new Ki(3,3.5,32),n=new w(s,i);n.rotation.x=-Math.PI/2,n.position.y=.05,t.add(n);const a=new Zi(1.5,6),o=new w(a,i.clone());o.material.opacity=.3,o.rotation.x=-Math.PI/2,o.position.y=.03,t.add(o);const r=new X({color:e.glowColor||16729088,emissive:e.glowColor||16729088,emissiveIntensity:2,transparent:!0,opacity:.8}),c=new re(.3,16,12),h=new w(c,r);h.position.y=5,t.add(h);const d=new We(e.glowColor||16729088,1,10);return d.position.y=5,t.add(d),t.userData.indicator=h,t.userData.light=d,t}spawnBoss(e){const t=this.arenas.get(e);if(!t)return console.warn(`[BossSpawner] No arena for boss: ${e}`),null;const i=t.bossData,s=La.createBossModel(i.modelType,i);s.position.copy(t.position),s.position.y=t.position.y,this.scene.add(s);const n={id:e,mesh:s,data:i,state:"idle",currentPhase:1,health:i.stats.maxHealth,posture:0,isActivated:!1,target:null};return this.activeBosses.set(e,n),t.spawnMarker&&(t.spawnMarker.visible=!1),console.log(`[BossSpawner] Spawned boss: ${i.name}`),n}shouldSpawnBoss(e){const t=this.respawnTimers.get(e);return!(t&&(Date.now()-t.lastKilledAt)/1e3<t.respawnTime||this.activeBosses.has(e))}activateBossFight(e){const t=this.activeBosses.get(e),i=this.arenas.get(e);if(!(!t||!i||t.isActivated)){if(t.isActivated=!0,t.state="aggro",t.target=this.player,i.active=!0,this.currentBossFight=e,i.boundary){i.boundary.visible=!0;const s=i.boundary.userData.fog;s&&(s.material.opacity=.3)}this.arenaColliders.push({type:"cylinder",position:i.position.clone(),radius:i.radius,height:10}),this.onBossActivate&&this.onBossActivate(t.data),this.onArenaEnter&&this.onArenaEnter(e,i),console.log(`[BossSpawner] Boss fight activated: ${t.data.name}`)}}deactivateBossFight(e,t=!1){const i=this.activeBosses.get(e),s=this.arenas.get(e);if(!(!i||!s)){if(s.active=!1,this.currentBossFight=null,s.boundary){s.boundary.visible=!1;const n=s.boundary.userData.fog;n&&(n.material.opacity=0)}this.arenaColliders=this.arenaColliders.filter(n=>!(n.type==="cylinder"&&n.position.equals(s.position))),t&&this.onBossDefeated?.(i.data,s),this.onArenaExit&&this.onArenaExit(e,s)}}defeatBoss(e){const t=this.activeBosses.get(e),i=this.arenas.get(e);if(!t)return;t.state="defeated",La.playDeathAnimation(t.mesh,()=>{this.scene.remove(t.mesh),this.activeBosses.delete(e),i&&i.spawnMarker&&(i.spawnMarker.visible=!0)});const s=wd(e);s&&this.respawnTimers.set(e,{lastKilledAt:Date.now(),respawnTime:s.respawnTime}),this.deactivateBossFight(e,!0),this.saveState(),console.log(`[BossSpawner] Boss defeated: ${t.data.name}`)}updateBossPhase(e,t,i){const s=this.activeBosses.get(e);s&&(s.currentPhase=t,La.applyPhaseVisual(s.mesh,t,i))}update(e){if(!this.player)return;const t=this.player.position||this.player.mesh?.position;t&&(this.arenas.forEach((i,s)=>{if(t.distanceTo(i.position)<i.radius-5&&!i.active){const a=this.activeBosses.get(s);a&&!a.isActivated&&this.activateBossFight(s)}i.atmosphere?.userData.particles&&this.updateAtmosphereParticles(i.atmosphere.userData.particles,e),i.spawnMarker?.visible&&this.updateSpawnMarker(i.spawnMarker,e)}),this.activeBosses.forEach((i,s)=>{i.mesh&&La.updateBossModel(i.mesh,e)}),La.updateEffects(e),this.checkRespawns())}updateAtmosphereParticles(e,t){if(!e.userData.basePositions)return;const i=Date.now()*.001,s=e.geometry.attributes.position.array,n=e.userData.basePositions;for(let a=0;a<s.length/3;a++){const o=a*.3;s[a*3]=n[a*3]+Math.sin(i+o)*.5,s[a*3+1]=n[a*3+1]+Math.sin(i*.5+o)*.3,s[a*3+2]=n[a*3+2]+Math.cos(i+o)*.5}e.geometry.attributes.position.needsUpdate=!0}updateSpawnMarker(e,t){const i=Date.now()*.001;e.userData.indicator&&(e.userData.indicator.position.y=5+Math.sin(i*2)*.3),e.userData.light&&(e.userData.light.intensity=1+Math.sin(i*3)*.5),e.children[0]&&(e.children[0].rotation.z+=t*.2)}checkRespawns(){const e=Date.now();this.respawnTimers.forEach((t,i)=>{(e-t.lastKilledAt)/1e3>=t.respawnTime&&(this.activeBosses.has(i)||(this.spawnBoss(i),this.respawnTimers.delete(i),console.log(`[BossSpawner] Boss respawned: ${i}`)))})}checkArenaBoundaryCollision(e,t=.4){if(!this.currentBossFight)return null;const i=this.arenas.get(this.currentBossFight);if(!i||!i.active)return null;const s=e.x-i.position.x,n=e.z-i.position.z,a=Math.sqrt(s*s+n*n);if(a>i.radius-t){const o=a-(i.radius-t),r=s/a,c=n/a;return new T(-r*o,0,-c*o)}return null}getBossPalette(e){const t={golem:{main:5921386,accent:4491519,glow:4500223},wraith:{main:1710634,accent:6693546,glow:11150079},treant:{main:3820074,accent:6728260,glow:8978244},knight:{main:2763317,accent:8912964,glow:16720452}};return t[e]||t.golem}saveState(){if(!this.saveManager)return;const e={respawnTimers:Array.from(this.respawnTimers.entries())};this.saveManager.setBossState?.(e)}loadState(){if(!this.saveManager)return;const e=this.saveManager.getBossState?.();e?.respawnTimers&&(this.respawnTimers=new Map(e.respawnTimers))}getActiveBoss(e){return this.activeBosses.get(e)}getCurrentBossFight(){return this.currentBossFight?this.activeBosses.get(this.currentBossFight):null}isInBossFight(){return this.currentBossFight!==null}dispose(){this.activeBosses.forEach(e=>{e.mesh&&this.scene.remove(e.mesh)}),this.arenas.forEach(e=>{e.group&&this.scene.remove(e.group)}),this.activeBosses.clear(),this.arenas.clear(),this.respawnTimers.clear(),this.arenaColliders=[],La.dispose()}}function CS(l,e,t,i){return new ES(l,e,t,i)}const Fe={ENTRANCE:"entrance",COMBAT:"combat",PUZZLE:"puzzle",TREASURE:"treasure",REST:"rest",MINIBOSS:"miniboss",BOSS:"boss",CORRIDOR:"corridor"},Li={SMALL:{width:8,height:4,depth:8},MEDIUM:{width:12,height:5,depth:12},LARGE:{width:18,height:6,depth:18},CORRIDOR:{width:4,height:3.5,depth:10},BOSS:{width:24,height:8,depth:24}},rr={NONE:{id:"none",name:"Normal",description:"Standard dungeon difficulty.",effects:{}},ELITE:{id:"elite",name:"Elite",description:"Enemies are stronger and more numerous. Better loot.",effects:{enemyHealthMult:1.5,enemyDamageMult:1.3,enemyCountMult:1.25,lootRarityBoost:1,xpMult:1.75},requiredItem:"elite_dungeon_key"},CURSED:{id:"cursed",name:"Cursed",description:"Dark magic fills this place. Healing reduced, enemies enraged.",effects:{healingReduction:.5,enemyDamageMult:1.2,enemyEnraged:!0,trapDamageMult:1.5,lootRarityBoost:2,xpMult:2},requiredItem:"cursed_dungeon_key",playerDebuffs:["reduced_healing","darkness_vision"]},BLESSED:{id:"blessed",name:"Blessed",description:"Ancient blessings linger. Player empowered, easier enemies.",effects:{playerDamageMult:1.25,playerDefenseMult:1.15,enemyHealthMult:.85,healingBonus:1.25,xpMult:.8},playerBuffs:["blessed_strength","blessed_ward"]},TIMED:{id:"timed",name:"Time Trial",description:"Complete within the time limit for bonus rewards.",effects:{timeLimitSeconds:600,bonusLootOnTime:!0,xpMult:1.5}}},AS={SPIKE:{id:"spike",name:"Spike Trap",damage:25,triggerType:"pressure",resetTime:3,visualType:"floor_spikes"},ARROW:{id:"arrow",name:"Arrow Trap",damage:30,triggerType:"tripwire",projectileCount:3,resetTime:5,visualType:"wall_arrows"},FIRE:{id:"fire",name:"Fire Jet",damage:40,damageType:"fire",triggerType:"timed",activeTime:2,cooldownTime:4,visualType:"fire_grate"},POISON:{id:"poison",name:"Poison Cloud",damage:15,damageType:"poison",triggerType:"proximity",duration:5,visualType:"poison_vent"},FALLING:{id:"falling",name:"Falling Rocks",damage:50,triggerType:"pressure",oneShot:!0,visualType:"cracked_ceiling"},PIT:{id:"pit",name:"Hidden Pit",damage:35,triggerType:"weight",visualType:"hidden_floor",effect:"fall"}},RS={PRESSURE_PLATES:{id:"pressure_plates",name:"Pressure Plate Sequence",description:"Step on plates in the correct order.",difficulty:1,componentCount:{min:3,max:5},failurePenalty:"spawn_enemies",visualType:"floor_plates"},LEVER_SEQUENCE:{id:"lever_sequence",name:"Lever Sequence",description:"Pull levers in the correct order.",difficulty:2,componentCount:{min:3,max:6},failurePenalty:"trap_activation",visualType:"wall_levers",hint:"symbols_on_walls"},CRYSTAL_ALIGNMENT:{id:"crystal_alignment",name:"Crystal Alignment",description:"Rotate crystals to focus light on the target.",difficulty:2,componentCount:{min:4,max:6},failurePenalty:"none",visualType:"rotating_crystals",hint:"light_beams"},KEY_AND_LOCK:{id:"key_and_lock",name:"Key Hunt",description:"Find the key hidden elsewhere in the dungeon.",difficulty:1,componentCount:{min:1,max:1},failurePenalty:"none",visualType:"locked_door",requiresExploration:!0},SYMBOL_MATCH:{id:"symbol_match",name:"Symbol Matching",description:"Match symbols on rotating pillars.",difficulty:3,componentCount:{min:4,max:8},failurePenalty:"damage_pulse",visualType:"symbol_pillars",hint:"mural_reference"},TORCH_LIGHTING:{id:"torch_lighting",name:"Torch Sequence",description:"Light torches in a specific pattern.",difficulty:2,componentCount:{min:4,max:7},failurePenalty:"extinguish_all",visualType:"wall_torches",hint:"shadow_patterns"},WEIGHT_BALANCE:{id:"weight_balance",name:"Weight Balance",description:"Place items on scales to balance them.",difficulty:3,componentCount:{min:2,max:4},failurePenalty:"trap_activation",visualType:"balance_scales",requiresItems:!0}},il={catacombs:{common:["skeleton_warrior","skeleton_archer","zombie_shambler"],uncommon:["skeleton_knight","wraith","ghoul"],rare:["bone_golem","lich_apprentice"],miniboss:["crypt_guardian","bone_colossus"],boss:["lich_lord"]},caverns:{common:["cave_spider","crystal_bat","miner_ghost"],uncommon:["rock_elemental","gem_hoarder","cave_troll"],rare:["crystal_golem","deep_dweller"],miniboss:["spider_queen","crystal_guardian"],boss:["ancient_crystal_wurm"]},hideout:{common:["bandit_thug","bandit_archer","bandit_brute"],uncommon:["bandit_assassin","bandit_mage","guard_dog"],rare:["bandit_captain","mercenary_veteran"],miniboss:["bandit_lieutenant","arena_champion"],boss:["bandit_warlord"]},temple:{common:["corrupted_acolyte","shadow_wisp","temple_guardian"],uncommon:["dark_priest","void_spawn","corrupted_knight"],rare:["shadow_assassin","void_walker"],miniboss:["high_priest","corrupted_paladin"],boss:["avatar_of_corruption"]}},sl={catacombs:{common:[{id:"bone_dust",name:"Bone Dust",type:"material",value:15},{id:"grave_moss",name:"Grave Moss",type:"material",value:20},{id:"tattered_cloth",name:"Tattered Cloth",type:"material",value:10}],uncommon:[{id:"ancient_coin",name:"Ancient Coin",type:"treasure",value:50},{id:"crypt_key_fragment",name:"Crypt Key Fragment",type:"quest",value:0},{id:"unholy_essence",name:"Unholy Essence",type:"material",value:75}],rare:[{id:"lich_phylactery",name:"Lich Phylactery",type:"rare_material",value:200},{id:"death_shard",name:"Death Shard",type:"rare_material",value:150}],equipment:["bone_sword","grave_keeper_helm","crypt_walker_boots","undead_bane_ring"]},caverns:{common:[{id:"raw_crystal",name:"Raw Crystal",type:"material",value:25},{id:"cave_fungus",name:"Cave Fungus",type:"material",value:15},{id:"stone_ore",name:"Stone Ore",type:"material",value:20}],uncommon:[{id:"glowing_gem",name:"Glowing Gem",type:"treasure",value:80},{id:"spider_silk",name:"Spider Silk",type:"material",value:60},{id:"crystal_dust",name:"Crystal Dust",type:"material",value:45}],rare:[{id:"perfect_crystal",name:"Perfect Crystal",type:"rare_material",value:250},{id:"deep_diamond",name:"Deep Diamond",type:"rare_material",value:300}],equipment:["crystal_blade","miners_helm","spider_silk_armor","cave_delver_ring"]},hideout:{common:[{id:"stolen_goods",name:"Stolen Goods",type:"treasure",value:30},{id:"leather_scraps",name:"Leather Scraps",type:"material",value:15},{id:"cheap_lockpick",name:"Cheap Lockpick",type:"consumable",value:10}],uncommon:[{id:"gold_pouch",name:"Gold Pouch",type:"treasure",value:100},{id:"bandit_map",name:"Bandit Treasure Map",type:"quest",value:0},{id:"poison_vial",name:"Poison Vial",type:"consumable",value:50}],rare:[{id:"warlord_medallion",name:"Warlord's Medallion",type:"rare_material",value:200},{id:"master_key",name:"Master Skeleton Key",type:"tool",value:175}],equipment:["bandit_dagger","rogues_hood","thieves_gloves","shadow_step_boots"]},temple:{common:[{id:"corrupted_incense",name:"Corrupted Incense",type:"material",value:20},{id:"shadow_essence",name:"Shadow Essence",type:"material",value:25},{id:"ritual_candle",name:"Ritual Candle",type:"material",value:15}],uncommon:[{id:"void_fragment",name:"Void Fragment",type:"material",value:70},{id:"temple_relic",name:"Temple Relic",type:"treasure",value:90},{id:"dark_scripture",name:"Dark Scripture",type:"quest",value:0}],rare:[{id:"corruption_heart",name:"Heart of Corruption",type:"rare_material",value:275},{id:"void_crystal",name:"Void Crystal",type:"rare_material",value:225}],equipment:["shadow_staff","cultist_robes","void_touched_amulet","temple_guardian_shield"]}},Jn={FORGOTTEN_CATACOMBS:{id:"forgotten_catacombs",name:"Forgotten Catacombs",shortName:"Catacombs",description:"Ancient burial chambers where the dead refuse to rest. Filled with undead horrors and deadly traps.",biome:"undead",theme:"catacombs",ambientColor:1709344,fogColor:657424,fogDensity:.08,roomCount:{min:7,max:10},corridorChance:.4,branchingFactor:.3,deadEndChance:.2,roomDistribution:{[Fe.COMBAT]:4,[Fe.PUZZLE]:1,[Fe.TREASURE]:1,[Fe.REST]:1,[Fe.MINIBOSS]:1},recommendedLevel:10,enemyLevelRange:{min:8,max:15},enemies:il.catacombs,enemiesPerRoom:{min:2,max:5},eliteChance:.15,trapTypes:["spike","poison","falling","pit"],trapsPerRoom:{min:0,max:2},trapChance:.4,puzzleTypes:["pressure_plates","lever_sequence","torch_lighting"],miniboss:{id:"crypt_guardian",name:"The Crypt Guardian",health:800,damage:45,abilities:["tomb_slam","summon_skeletons","bone_shield"]},boss:{id:"lich_lord_valkorin",name:"Lich Lord Valkorin",title:"The Undying",health:1800,damage:60,phases:3,abilities:["death_bolt","raise_dead","soul_drain","necrotic_burst"],loot:{guaranteed:[{id:"lich_soul",name:"Valkorin's Soul",type:"boss_soul"},{id:"lich_crown",name:"Crown of the Lich",type:"equipment",rarity:"legendary"}],rare:[{id:"staff_of_undeath",name:"Staff of Undeath",type:"weapon",rarity:"legendary",chance:.2}]}},lootPool:sl.catacombs,lootTier:2,chestCount:{min:3,max:6},props:["coffins","bones","candles","cobwebs","skulls","broken_tombs"],lighting:"torches",floorTexture:"stone_worn",wallTexture:"stone_brick_dark",ceilingTexture:"stone_arch",ambientSound:"catacombs_ambient",combatMusic:"undead_battle",bossMusic:"lich_theme",completionRewards:{remnants:2e3,xp:1500,firstClearBonus:{remnants:1e3,items:[{id:"catacombs_trophy",name:"Catacombs Conqueror Trophy",type:"trophy"}]}},specialMechanics:["darkness_zones","respawning_skeletons"]},CRYSTAL_CAVERNS:{id:"crystal_caverns",name:"Crystal Caverns",shortName:"Caverns",description:"A network of glittering caves filled with precious crystals and dangerous creatures that guard them.",biome:"underground",theme:"caverns",ambientColor:1056816,fogColor:660768,fogDensity:.05,roomCount:{min:8,max:12},corridorChance:.5,branchingFactor:.4,deadEndChance:.25,roomDistribution:{[Fe.COMBAT]:4,[Fe.PUZZLE]:2,[Fe.TREASURE]:2,[Fe.REST]:1,[Fe.MINIBOSS]:1},recommendedLevel:15,enemyLevelRange:{min:12,max:20},enemies:il.caverns,enemiesPerRoom:{min:2,max:4},eliteChance:.12,trapTypes:["spike","falling","pit"],trapsPerRoom:{min:0,max:3},trapChance:.35,puzzleTypes:["crystal_alignment","weight_balance","lever_sequence"],miniboss:{id:"crystal_guardian",name:"Crystal Guardian",health:1e3,damage:50,abilities:["crystal_barrage","reflect_shield","ground_crystals"]},boss:{id:"ancient_crystal_wurm",name:"Ancient Crystal Wurm",title:"The Deep Terror",health:2200,damage:55,phases:3,abilities:["crystal_breath","burrow_strike","crystal_storm","summon_spiders"],loot:{guaranteed:[{id:"wurm_soul",name:"Crystal Wurm's Soul",type:"boss_soul"},{id:"wurm_scale",name:"Prismatic Wurm Scale",type:"equipment",rarity:"legendary"}],rare:[{id:"crystal_fang",name:"Crystal Fang Blade",type:"weapon",rarity:"legendary",chance:.2}]}},lootPool:sl.caverns,lootTier:3,chestCount:{min:4,max:8},props:["crystal_formations","stalactites","mining_equipment","glowing_mushrooms","spider_webs","mine_carts"],lighting:"crystals",floorTexture:"cave_rock",wallTexture:"crystal_vein",ceilingTexture:"stalactite",ambientSound:"cave_ambient",combatMusic:"cavern_battle",bossMusic:"wurm_theme",completionRewards:{remnants:2500,xp:2e3,firstClearBonus:{remnants:1500,items:[{id:"caverns_trophy",name:"Crystal Delver Trophy",type:"trophy"}]}},specialMechanics:["crystal_light_puzzles","destructible_walls","gem_collection"]},BANDIT_HIDEOUT:{id:"bandit_hideout",name:"Bandit Hideout",shortName:"Hideout",description:"A fortified outlaw stronghold. The bandits have rigged it with alarms and locked doors.",biome:"man_made",theme:"hideout",ambientColor:2760728,fogColor:1709328,fogDensity:.03,roomCount:{min:6,max:9},corridorChance:.6,branchingFactor:.25,deadEndChance:.15,roomDistribution:{[Fe.COMBAT]:5,[Fe.PUZZLE]:1,[Fe.TREASURE]:2,[Fe.REST]:0,[Fe.MINIBOSS]:1},recommendedLevel:8,enemyLevelRange:{min:6,max:12},enemies:il.hideout,enemiesPerRoom:{min:3,max:6},eliteChance:.1,trapTypes:["arrow","spike","pit"],trapsPerRoom:{min:1,max:3},trapChance:.5,puzzleTypes:["key_and_lock","lever_sequence"],miniboss:{id:"bandit_lieutenant",name:"Lieutenant Grax",health:600,damage:40,abilities:["dual_strike","smoke_bomb","call_reinforcements"]},boss:{id:"bandit_warlord",name:"Warlord Krag",title:"The Iron Fist",health:1400,damage:55,phases:2,abilities:["heavy_slam","axe_throw","rally_troops","enrage"],loot:{guaranteed:[{id:"warlord_soul",name:"Krag's Soul",type:"boss_soul"},{id:"warlord_axe",name:"Krag's Waraxe",type:"weapon",rarity:"epic"}],rare:[{id:"bandit_lord_armor",name:"Bandit Lord Armor",type:"equipment",rarity:"legendary",chance:.2}]}},lootPool:sl.hideout,lootTier:1,chestCount:{min:5,max:10},props:["crates","barrels","weapon_racks","tables","beds","treasure_piles"],lighting:"torches_dim",floorTexture:"wood_planks",wallTexture:"stone_rough",ceilingTexture:"wood_beams",ambientSound:"hideout_ambient",combatMusic:"bandit_battle",bossMusic:"warlord_theme",completionRewards:{remnants:1500,xp:1200,firstClearBonus:{remnants:800,items:[{id:"hideout_trophy",name:"Bandit Slayer Trophy",type:"trophy"}]}},specialMechanics:["alarm_system","locked_doors","hostage_rescue"]},CORRUPTED_TEMPLE:{id:"corrupted_temple",name:"Corrupted Temple",shortName:"Temple",description:"Once a holy sanctuary, now twisted by dark magic. Corrupted priests perform dark rituals within.",biome:"corrupted",theme:"temple",ambientColor:1706528,fogColor:1050648,fogDensity:.06,roomCount:{min:8,max:11},corridorChance:.35,branchingFactor:.35,deadEndChance:.2,roomDistribution:{[Fe.COMBAT]:3,[Fe.PUZZLE]:3,[Fe.TREASURE]:1,[Fe.REST]:1,[Fe.MINIBOSS]:1},recommendedLevel:20,enemyLevelRange:{min:18,max:28},enemies:il.temple,enemiesPerRoom:{min:2,max:4},eliteChance:.2,trapTypes:["fire","poison","spike"],trapsPerRoom:{min:0,max:2},trapChance:.3,puzzleTypes:["symbol_match","crystal_alignment","torch_lighting","pressure_plates"],miniboss:{id:"high_priest",name:"High Priest Malachar",health:1200,damage:60,abilities:["shadow_bolt","dark_heal","summon_void","corruption_wave"]},boss:{id:"avatar_of_corruption",name:"Avatar of Corruption",title:"The Void Made Flesh",health:3e3,damage:75,phases:4,abilities:["void_beam","corruption_zone","dark_tendrils","phase_shift","reality_tear"],loot:{guaranteed:[{id:"avatar_soul",name:"Avatar's Soul",type:"boss_soul"},{id:"void_heart",name:"Heart of the Void",type:"equipment",rarity:"legendary"}],rare:[{id:"corruption_blade",name:"Blade of Corruption",type:"weapon",rarity:"legendary",chance:.15},{id:"void_robes",name:"Robes of the Void",type:"equipment",rarity:"legendary",chance:.15}]}},lootPool:sl.temple,lootTier:4,chestCount:{min:3,max:5},props:["altars","statues","ritual_circles","corrupted_banners","void_cracks","floating_debris"],lighting:"magic_glow",floorTexture:"marble_corrupted",wallTexture:"temple_stone_dark",ceilingTexture:"vaulted_corrupted",ambientSound:"temple_ambient",combatMusic:"corruption_battle",bossMusic:"avatar_theme",completionRewards:{remnants:4e3,xp:3500,firstClearBonus:{remnants:2500,items:[{id:"temple_trophy",name:"Corruption Vanquisher Trophy",type:"trophy"},{id:"void_blessing",name:"Blessing of the Void",type:"permanent_buff"}]}},specialMechanics:["corruption_spread","altar_rituals","void_portals","reality_distortion"]}},IS={combat_basic:{type:Fe.COMBAT,size:Li.MEDIUM,doorPositions:["north","south"],propZones:["corners","walls"],enemySpawns:["center","sides"]},combat_pillars:{type:Fe.COMBAT,size:Li.LARGE,doorPositions:["north","south","east"],features:["pillars"],propZones:["between_pillars"],enemySpawns:["behind_pillars","center"]},combat_arena:{type:Fe.COMBAT,size:Li.LARGE,doorPositions:["south"],features:["raised_platform","pit"],propZones:["edges"],enemySpawns:["platform","pit"]},puzzle_shrine:{type:Fe.PUZZLE,size:Li.MEDIUM,doorPositions:["south"],features:["central_altar","pedestals"],propZones:["altar_area"],interactables:["pedestals","altar"]},puzzle_gallery:{type:Fe.PUZZLE,size:Li.LARGE,doorPositions:["north","south"],features:["wall_panels","floor_tiles"],propZones:["walls"],interactables:["panels","tiles"]},treasure_vault:{type:Fe.TREASURE,size:Li.SMALL,doorPositions:["south"],features:["treasure_pile","trapped_floor"],propZones:["around_treasure"],chestCount:{min:2,max:4}},treasure_hidden:{type:Fe.TREASURE,size:Li.SMALL,doorPositions:["secret"],features:["single_chest"],propZones:["corners"],chestCount:{min:1,max:1},isSecret:!0},rest_checkpoint:{type:Fe.REST,size:Li.SMALL,doorPositions:["north","south"],features:["bonfire","bench"],propZones:["around_bonfire"],healsPlayer:!0,savesProgress:!0},boss_chamber:{type:Fe.BOSS,size:Li.BOSS,doorPositions:["south"],features:["boss_altar","pillars","exit_portal"],propZones:["edges","altar_area"],bossSpawn:"center_north"},corridor_straight:{type:Fe.CORRIDOR,size:Li.CORRIDOR,doorPositions:["north","south"],propZones:["walls"],trapPositions:["center"]},corridor_bend:{type:Fe.CORRIDOR,size:{width:4,height:3.5,depth:4},doorPositions:["north","east"],propZones:["corner"]}};function Hs(l){const e=l.toUpperCase().replace(/-/g,"_");if(Jn[e])return Jn[e];for(const t of Object.keys(Jn))if(Jn[t].id===l)return Jn[t];return null}function kS(l,e="none"){const t=Hs(l);if(!t)return 5;let i=t.roomCount.min+Math.floor(Math.random()*(t.roomCount.max-t.roomCount.min+1));return e==="elite"&&(i+=2),i}function Qc(l,e,t="none"){const i=Hs(l);if(!i)return{enemies:[],count:0};const n=(rr[t.toUpperCase()]||rr.NONE).effects.enemyCountMult||1;let a=i.enemiesPerRoom.min+Math.floor(Math.random()*(i.enemiesPerRoom.max-i.enemiesPerRoom.min+1));a=Math.round(a*n);const o=[];for(let r=0;r<a;r++){const c=Math.random();let h;c<.6?h=i.enemies.common:c<.9?h=i.enemies.uncommon:h=i.enemies.rare;const d=h[Math.floor(Math.random()*h.length)],u=Math.random()<i.eliteChance;o.push({type:d,isElite:u})}return{enemies:o,count:a}}function jc(l,e){const t=Hs(l);if(!t||e!==Fe.COMBAT)return[];if(Math.random()>t.trapChance)return[];const i=t.trapsPerRoom.min+Math.floor(Math.random()*(t.trapsPerRoom.max-t.trapsPerRoom.min+1)),s=[];for(let n=0;n<i;n++){const a=t.trapTypes[Math.floor(Math.random()*t.trapTypes.length)],o=AS[a.toUpperCase()];o&&s.push({...o})}return s}function PS(l){const e=Hs(l);if(!e)return null;const t=e.puzzleTypes[Math.floor(Math.random()*e.puzzleTypes.length)],i=RS[t.toUpperCase().replace(/-/g,"_")];if(!i)return null;const s=i.componentCount.min+Math.floor(Math.random()*(i.componentCount.max-i.componentCount.min+1));return{...i,componentCount:s,solution:DS(i.id,s)}}function DS(l,e){const t=[];switch(l){case"pressure_plates":case"lever_sequence":case"torch_lighting":for(let s=0;s<e;s++){let n;do n=Math.floor(Math.random()*e);while(t.includes(n)&&t.length<e);t.push(n)}break;case"crystal_alignment":for(let s=0;s<e;s++)t.push(Math.floor(Math.random()*4)*90);break;case"symbol_match":const i=["sun","moon","star","skull","eye","hand","flame","wave"];for(let s=0;s<e;s++)t.push(i[Math.floor(Math.random()*i.length)]);break;default:for(let s=0;s<e;s++)t.push(s)}return t}function Ro(l,e="normal",t="none"){const i=Hs(l);if(!i)return{items:[],remnants:0};const n=(rr[t.toUpperCase()]||rr.NONE).effects.lootRarityBoost||0,a={items:[],remnants:50+Math.floor(Math.random()*100)},o=i.lootPool,r=e==="boss"?3:e==="treasure"?2:1;for(let c=0;c<r;c++){const h=Math.random()+n*.1;let d;h<.5?d=o.common:h<.85?d=o.uncommon:d=o.rare;const u=d[Math.floor(Math.random()*d.length)];a.items.push({...u,quantity:1})}if(Math.random()<.2+n*.1){const c=o.equipment[Math.floor(Math.random()*o.equipment.length)];a.items.push({id:c,type:"equipment",quantity:1})}return a}function LS(l,e){const t=Object.values(IS).filter(i=>i.type===l);return t.length===0?null:t[Math.floor(Math.random()*t.length)]}const of=20,OS=10;class rf{constructor(e=null){this.seed=e||Date.now(),this.random=this._createSeededRandom(this.seed),this.grid=new Map,this.rooms=[],this.connections=[],this.criticalPath=[],this.bounds={minX:0,maxX:0,minZ:0,maxZ:0}}_createSeededRandom(e){let t=e;return()=>(t=(t*9301+49297)%233280,t/233280)}generate(e,t="none"){const i=Hs(e);if(!i)return console.error(`[DungeonGenerator] Unknown dungeon: ${e}`),null;console.log(`[DungeonGenerator] Generating ${i.name} (${t})`),this.grid.clear(),this.rooms=[],this.connections=[],this.criticalPath=[],this.bounds={minX:0,maxX:0,minZ:0,maxZ:0};const s=kS(e,t);console.log(`[DungeonGenerator] Target room count: ${s}`);const n=this._generateRoomTypes(i,s);if(this._placeRooms(n,i),this._generateConnections(i),!this._validatePath())return console.warn("[DungeonGenerator] Invalid path, regenerating..."),this.generate(e,t);this._populateRooms(i,t),this._calculateBounds();const a={id:`${e}_${this.seed}`,dungeonId:e,dungeonData:i,modifier:t,seed:this.seed,rooms:this.rooms,connections:this.connections,criticalPath:this.criticalPath,bounds:this.bounds,entranceRoom:this.rooms.find(o=>o.type===Fe.ENTRANCE),bossRoom:this.rooms.find(o=>o.type===Fe.BOSS),stats:{roomCount:this.rooms.length,enemyCount:this.rooms.reduce((o,r)=>o+(r.enemies?.length||0),0),trapCount:this.rooms.reduce((o,r)=>o+(r.traps?.length||0),0),chestCount:this.rooms.reduce((o,r)=>o+(r.chests?.length||0),0),puzzleCount:this.rooms.filter(o=>o.puzzle).length}};return console.log(`[DungeonGenerator] Generated dungeon with ${a.stats.roomCount} rooms, ${a.stats.enemyCount} enemies, ${a.stats.chestCount} chests`),a}_generateRoomTypes(e,t){const i=[];i.push(Fe.ENTRANCE),i.push(Fe.BOSS),e.miniboss&&i.push(Fe.MINIBOSS);const s=t-i.length,n=e.roomDistribution,a=Object.values(n).reduce((c,h)=>c+h,0);for(let c=0;c<s;c++){const h=this.random()*a;let d=0;for(const[u,p]of Object.entries(n))if(d+=p,h<d){i.push(u);break}}const o=i.shift(),r=i.splice(i.indexOf(Fe.BOSS),1)[0];for(let c=i.length-1;c>0;c--){const h=Math.floor(this.random()*(c+1));[i[c],i[h]]=[i[h],i[c]]}return i.unshift(o),i.push(r),i}_placeRooms(e,t){const i=this._createRoom(Fe.ENTRANCE,0,0,t);this.rooms.push(i),this.grid.set("0,0",i),this.criticalPath.push(i);const s=[i];let n=1;const a=e.length-1;for(;n<e.length&&s.length>0;){const o=this._pickFrontierRoom(s),r=this._getValidAdjacentPositions(o);if(r.length===0){const u=s.indexOf(o);u!==-1&&s.splice(u,1);continue}const c=r[Math.floor(this.random()*r.length)],h=e[n],d=this._createRoom(h,c.x,c.z,t);if(d.direction=c.direction,this.rooms.push(d),this.grid.set(`${c.x},${c.z}`,d),this.connections.push({from:o.id,to:d.id,direction:c.direction,type:this.random()<t.corridorChance?"corridor":"door"}),o.connections.push(d.id),d.connections.push(o.id),n<=a&&this.criticalPath.push(d),s.push(d),n<a&&this.random()<t.branchingFactor){const u=s[Math.floor(this.random()*s.length)],p=this._getValidAdjacentPositions(u);if(p.length>0){const f=p[Math.floor(this.random()*p.length)],y=this.random()<t.deadEndChance?Fe.TREASURE:Fe.COMBAT,m=this._createRoom(y,f.x,f.z,t);m.isBranch=!0,m.isDeadEnd=this.random()<.5,this.rooms.push(m),this.grid.set(`${f.x},${f.z}`,m),this.connections.push({from:u.id,to:m.id,direction:f.direction,type:"door"}),u.connections.push(m.id),m.connections.push(u.id),m.isDeadEnd||s.push(m)}}n++;for(let u=s.length-1;u>=0;u--)s[u].connections.length>=3&&s.splice(u,1)}}_createRoom(e,t,i,s){const n=LS(e,s.theme)||{},a=n.size||Li.MEDIUM,o=e===Fe.BOSS?Li.BOSS:e===Fe.ENTRANCE?Li.MEDIUM:e===Fe.CORRIDOR?Li.CORRIDOR:a;return{id:`room_${this.rooms.length}`,type:e,gridX:t,gridZ:i,position:{x:t*of,y:0,z:i*of},width:o.width,height:o.height,depth:o.depth,template:n,doorPositions:n.doorPositions||["north","south"],features:n.features||[],propZones:n.propZones||[],connections:[],enemies:[],traps:[],chests:[],props:[],lights:[],puzzle:null,isCleared:!1,isExplored:!1,isBranch:!1,isDeadEnd:!1,isSecret:n.isSecret||!1}}_pickFrontierRoom(e){const t=Math.min(...e.map(s=>s.connections.length)),i=e.filter(s=>s.connections.length===t);return i[Math.floor(this.random()*i.length)]}_getValidAdjacentPositions(e){const t=[{dx:0,dz:-1,direction:"north"},{dx:0,dz:1,direction:"south"},{dx:-1,dz:0,direction:"west"},{dx:1,dz:0,direction:"east"}],i=[];for(const s of t){const n=e.gridX+s.dx,a=e.gridZ+s.dz,o=`${n},${a}`;this.grid.has(o)||(this._getOppositeDirection(s.direction),(e.doorPositions.includes(s.direction)||e.doorPositions.includes("all"))&&i.push({x:n,z:a,direction:s.direction}))}return i}_getOppositeDirection(e){return{north:"south",south:"north",east:"west",west:"east"}[e]}_generateConnections(e){for(const t of this.connections)if(t.type==="corridor"){const i=this.rooms.find(o=>o.id===t.from),s=this.rooms.find(o=>o.id===t.to);if(!i||!s)continue;const n=(i.position.x+s.position.x)/2,a=(i.position.z+s.position.z)/2;if(t.corridor={position:{x:n,y:0,z:a},width:Li.CORRIDOR.width,height:Li.CORRIDOR.height,length:OS,direction:t.direction,hasDoor:this.random()<.3,hasTrap:this.random()<e.trapChance*.5},t.corridor.hasTrap){const o=jc(e.id,Fe.COMBAT);o.length>0&&(t.corridor.trap=o[0])}}}_validatePath(){const e=this.rooms.find(n=>n.type===Fe.ENTRANCE),t=this.rooms.find(n=>n.type===Fe.BOSS);if(!e||!t)return!1;const i=new Set,s=[e.id];for(;s.length>0;){const n=s.shift();if(n===t.id)return!0;if(i.has(n))continue;i.add(n);const a=this.rooms.find(o=>o.id===n);if(a)for(const o of a.connections)i.has(o)||s.push(o)}return!1}_populateRooms(e,t){for(const i of this.rooms){switch(i.type){case Fe.ENTRANCE:this._populateEntrance(i,e);break;case Fe.COMBAT:this._populateCombatRoom(i,e,t);break;case Fe.PUZZLE:this._populatePuzzleRoom(i,e);break;case Fe.TREASURE:this._populateTreasureRoom(i,e,t);break;case Fe.REST:this._populateRestRoom(i,e);break;case Fe.MINIBOSS:this._populateMinibossRoom(i,e,t);break;case Fe.BOSS:this._populateBossRoom(i,e);break}this._addProps(i,e),this._addLighting(i,e)}}_populateEntrance(e,t){e.isCleared=!0,e.isExplored=!0,e.features.push({type:"entrance_portal",position:{x:0,y:0,z:e.depth/2-1}}),this.random()<.5&&e.props.push({type:"sign",position:{x:2,y:1.5,z:0},text:`${t.name}
Beware: ${t.boss.name} lurks within`})}_populateCombatRoom(e,t,i){const s=Qc(t.id,e.type,i);for(let a=0;a<s.enemies.length;a++){const o=s.enemies[a],r=a/s.enemies.length*Math.PI*2,c=e.width*.3;e.enemies.push({...o,id:`enemy_${e.id}_${a}`,spawnPosition:{x:Math.cos(r)*c,y:0,z:Math.sin(r)*c},levelRange:t.enemyLevelRange})}const n=jc(t.id,e.type);for(let a=0;a<n.length;a++){const o=n[a];e.traps.push({...o,id:`trap_${e.id}_${a}`,position:{x:(this.random()-.5)*e.width*.6,y:0,z:(this.random()-.5)*e.depth*.6},isArmed:!0})}if(this.random()<.2){const a=Ro(t.id,"normal",i);e.chests.push({id:`chest_${e.id}_0`,type:"normal",position:{x:0,y:0,z:-e.depth/2+2},loot:a,isOpen:!1,isLocked:!1})}}_populatePuzzleRoom(e,t){const i=PS(t.id);if(i){e.puzzle={...i,id:`puzzle_${e.id}`,isSolved:!1,currentState:new Array(i.componentCount).fill(0),reward:Ro(t.id,"treasure")};for(let s=0;s<i.componentCount;s++)e.features.push({type:i.visualType,index:s,position:this._getPuzzleComponentPosition(s,i.componentCount,e)})}if(e.enemiesOnFail=[],i&&i.failurePenalty==="spawn_enemies"){const s=Qc(t.id);e.enemiesOnFail=s.enemies.slice(0,2)}}_getPuzzleComponentPosition(e,t,i){if(t<=4)return{x:i.width/(t+1)*(e+1)-i.width/2,y:1,z:0};{const s=e/t*Math.PI*2,n=Math.min(i.width,i.depth)*.35;return{x:Math.cos(s)*n,y:1,z:Math.sin(s)*n}}}_populateTreasureRoom(e,t,i){const s=Ro(t.id,"treasure",i);e.chests.push({id:`chest_${e.id}_main`,type:"treasure",position:{x:0,y:0,z:-e.depth/2+2},loot:s,isOpen:!1,isLocked:this.random()<.3,keyId:e.isSecret?`key_secret_${e.id}`:null});const n=Math.floor(this.random()*2)+1;for(let a=0;a<n;a++){const o=Ro(t.id,"normal",i);e.chests.push({id:`chest_${e.id}_${a}`,type:"normal",position:{x:(a===0?-1:1)*(e.width/3),y:0,z:-e.depth/2+2},loot:o,isOpen:!1,isLocked:!1})}if(this.random()<.4){const a=jc(t.id,Fe.COMBAT);a.length>0&&e.traps.push({...a[0],id:`trap_${e.id}_guard`,position:{x:0,y:0,z:0},isArmed:!0})}}_populateRestRoom(e,t){e.isCleared=!0,e.features.push({type:"bonfire",position:{x:0,y:0,z:0},isLit:!0}),e.props.push({type:"bench",position:{x:-3,y:0,z:0},rotation:Math.PI/2}),this.random()<.3&&(e.npc={type:"merchant",position:{x:3,y:0,z:0},inventory:"dungeon_supplies"})}_populateMinibossRoom(e,t,i){const s=t.miniboss;if(!s)return;e.miniboss={...s,id:`miniboss_${e.id}`,spawnPosition:{x:0,y:0,z:-e.depth/4},isDefeated:!1};const n=Qc(t.id,e.type,i);e.enemies=n.enemies.slice(0,2).map((a,o)=>({...a,id:`miniboss_add_${e.id}_${o}`,spawnPosition:{x:(o===0?-1:1)*5,y:0,z:-e.depth/4}})),e.chests.push({id:`chest_${e.id}_miniboss`,type:"boss",position:{x:0,y:0,z:-e.depth/2+2},loot:Ro(t.id,"boss",i),isOpen:!1,isLocked:!0,unlocksOnClear:!0})}_populateBossRoom(e,t){const i=t.boss;e.boss={...i,id:`boss_${e.id}`,spawnPosition:{x:0,y:0,z:-e.depth/3},isDefeated:!1,currentPhase:1},e.features.push({type:"boss_altar",position:{x:0,y:0,z:-e.depth/2+3}});for(let s=0;s<4;s++){const n=s/4*Math.PI*2+Math.PI/4;e.props.push({type:"pillar",position:{x:Math.cos(n)*(e.width/3),y:0,z:Math.sin(n)*(e.depth/3)},destructible:!0})}e.features.push({type:"exit_portal",position:{x:0,y:0,z:-e.depth/2+1},isActive:!1})}_addProps(e,t){const i=t.props,s=Math.floor(this.random()*5)+2;for(let n=0;n<s;n++){const a=i[Math.floor(this.random()*i.length)];let o;if(this.random()<.5)switch(Math.floor(this.random()*4)){case 0:o={x:(this.random()-.5)*e.width*.8,y:0,z:-e.depth/2+1};break;case 1:o={x:(this.random()-.5)*e.width*.8,y:0,z:e.depth/2-1};break;case 2:o={x:e.width/2-1,y:0,z:(this.random()-.5)*e.depth*.8};break;case 3:o={x:-e.width/2+1,y:0,z:(this.random()-.5)*e.depth*.8};break}else{const r=Math.floor(this.random()*4),c=r<2?-1:1,h=r%2===0?-1:1;o={x:c*(e.width/2-2),y:0,z:h*(e.depth/2-2)}}e.props.push({type:a,position:o,rotation:this.random()*Math.PI*2,scale:.8+this.random()*.4})}}_addLighting(e,t){const i=t.lighting;switch(e.lights.push({type:"ambient",position:{x:0,y:e.height-1,z:0},color:t.ambientColor,intensity:.3}),i){case"torches":case"torches_dim":const s=Math.floor(e.width/6)*2;for(let a=0;a<s;a++){const o=a%2===0?-1:1;e.lights.push({type:"torch",position:{x:o*(e.width/2-.5),y:2.5,z:(a/2/(s/2-1)-.5)*e.depth*.8},color:16737826,intensity:i==="torches_dim"?.6:1,flicker:!0})}break;case"crystals":const n=Math.floor(this.random()*4)+3;for(let a=0;a<n;a++)e.lights.push({type:"crystal",position:{x:(this.random()-.5)*e.width*.9,y:this.random()*e.height*.6+1,z:(this.random()-.5)*e.depth*.9},color:this.random()<.5?65535:11167487,intensity:.8,pulse:!0});break;case"magic_glow":e.lights.push({type:"magic",position:{x:0,y:e.height/2,z:0},color:6693546,intensity:.5,pulse:!0});for(let a=0;a<3;a++)e.lights.push({type:"void_crack",position:{x:(this.random()-.5)*e.width,y:.1,z:(this.random()-.5)*e.depth},color:8930559,intensity:.4,flicker:!0});break}}_calculateBounds(){for(const e of this.rooms){const t=e.width/2,i=e.depth/2;this.bounds.minX=Math.min(this.bounds.minX,e.position.x-t),this.bounds.maxX=Math.max(this.bounds.maxX,e.position.x+t),this.bounds.minZ=Math.min(this.bounds.minZ,e.position.z-i),this.bounds.maxZ=Math.max(this.bounds.maxZ,e.position.z+i)}}getRoomAt(e,t){return this.grid.get(`${e},${t}`)}getRoomById(e){return this.rooms.find(t=>t.id===e)}getConnectedRooms(e){const t=this.getRoomById(e);return t?t.connections.map(i=>this.getRoomById(i)).filter(Boolean):[]}}const lf={catacombs:{floor:2762016,wall:3814704,ceiling:2433045,accent:4866101,trim:1709328,light:16742178,fog:657424,ambient:1709344},caverns:{floor:2764853,wall:3817541,ceiling:1712165,accent:4874368,trim:2109504,light:4500223,fog:660768,ambient:1056816},hideout:{floor:3813413,wall:4866101,ceiling:2762016,accent:5917237,trim:2760725,light:16737843,fog:1709328,ambient:2760728},temple:{floor:2759216,wall:3810624,ceiling:1708064,accent:5910624,trim:1378328,light:11158783,fog:1050648,ambient:1706528}},NS={coffins:{geometry:"box",size:[1.2,.5,.6],color:3813413,offset:[0,.25,0]},bones:{geometry:"scattered",color:9075290,count:5},candles:{geometry:"cylinder",size:[.05,.15],color:15654280,emissive:16742178,light:!0},cobwebs:{geometry:"plane",size:[1,1],color:8947848,transparent:!0},skulls:{geometry:"sphere",size:[.12],color:10127978},broken_tombs:{geometry:"box",size:[1.5,.4,.8],color:3814704,broken:!0},crystal_formations:{geometry:"crystal",color:4500223,emissive:2263295,light:!0},stalactites:{geometry:"cone",size:[.2,.8],color:4868693,ceiling:!0},mining_equipment:{geometry:"group",parts:["pickaxe","cart","lantern"]},glowing_mushrooms:{geometry:"mushroom",color:4521864,emissive:2271812,light:!0},spider_webs:{geometry:"plane",size:[2,2],color:13421772,transparent:!0},mine_carts:{geometry:"box",size:[.8,.5,.5],color:5917242,wheels:!0},crates:{geometry:"box",size:[.7,.7,.7],color:5915952},barrels:{geometry:"cylinder",size:[.4,.8],color:4864549},weapon_racks:{geometry:"rack",color:3811872},tables:{geometry:"table",color:4864554},beds:{geometry:"bed",color:5918789},treasure_piles:{geometry:"pile",color:14527044,metallic:!0},altars:{geometry:"altar",color:4863312,emissive:6693546},statues:{geometry:"statue",color:5917280},ritual_circles:{geometry:"circle",color:6693546,emissive:6693546,floor:!0},corrupted_banners:{geometry:"banner",color:3805248},void_cracks:{geometry:"crack",color:8930559,emissive:6693546,floor:!0},floating_debris:{geometry:"debris",color:4864592,float:!0},pillar:{geometry:"cylinder",size:[.4,4],color:5921370},torch_holder:{geometry:"torch",color:3815994},chest:{geometry:"chest",color:5915952},door_frame:{geometry:"doorframe",color:3814704}};class BS{constructor(e){this.scene=e,this.dungeonGroup=new ne,this.dungeonGroup.name="DungeonInstance",e.add(this.dungeonGroup),this.roomsGroup=new ne,this.roomsGroup.name="Rooms",this.dungeonGroup.add(this.roomsGroup),this.doorsGroup=new ne,this.doorsGroup.name="Doors",this.dungeonGroup.add(this.doorsGroup),this.propsGroup=new ne,this.propsGroup.name="Props",this.dungeonGroup.add(this.propsGroup),this.lightsGroup=new ne,this.lightsGroup.name="Lights",this.dungeonGroup.add(this.lightsGroup),this.effectsGroup=new ne,this.effectsGroup.name="Effects",this.dungeonGroup.add(this.effectsGroup),this.currentDungeon=null,this.renderedRooms=new Map,this.doors=new Map,this.activeLights=[],this.particleSystems=[],this.materialsCache=new Map,this.minimapRooms=[],console.log("[DungeonRenderer] Initialized")}renderDungeon(e){console.log(`[DungeonRenderer] Rendering dungeon: ${e.dungeonData.name}`),this.clearDungeon(),this.currentDungeon=e;const t=e.dungeonData.theme,i=lf[t]||lf.catacombs;this.setupFog(e.dungeonData);for(const s of e.rooms)this.renderRoom(s,t,i);for(const s of e.connections)this.renderConnection(s,e,t,i);this.addAtmosphericParticles(e.dungeonData,e.bounds),console.log(`[DungeonRenderer] Rendered ${e.rooms.length} rooms`)}clearDungeon(){this.clearGroup(this.roomsGroup),this.clearGroup(this.doorsGroup),this.clearGroup(this.propsGroup),this.clearGroup(this.lightsGroup),this.clearGroup(this.effectsGroup),this.renderedRooms.clear(),this.doors.clear(),this.activeLights=[],this.particleSystems=[],this.minimapRooms=[],this.currentDungeon=null,this.scene.fog&&(this.scene.fog=null)}clearGroup(e){for(;e.children.length>0;){const t=e.children[0];t.geometry&&t.geometry.dispose(),t.material&&(Array.isArray(t.material)?t.material.forEach(i=>i.dispose()):t.material.dispose()),e.remove(t)}}setupFog(e){const t=e.fogColor||657930,i=e.fogDensity||.05;this.scene.fog=new hr(t,i)}renderRoom(e,t,i){const s=new ne;s.name=`Room_${e.id}`,s.position.set(e.position.x,e.position.y,e.position.z);const n=e.width,a=e.height,o=e.depth;this.createRoomGeometry(s,n,a,o,i,e.type),this.addRoomFeatures(s,e,t,i),this.addRoomProps(s,e,t,i),this.addRoomLighting(s,e,t,i),this.roomsGroup.add(s),this.renderedRooms.set(e.id,s),this.minimapRooms.push({id:e.id,gridX:e.gridX,gridZ:e.gridZ,type:e.type,isExplored:e.isExplored,isCleared:e.isCleared})}createRoomGeometry(e,t,i,s,n,a){const o=t/2,r=s/2,c=this.getMaterial("floor",n.floor,{roughness:.9,metalness:.05}),h=new Dt(t,s,4,4),d=new w(h,c);d.rotation.x=-Math.PI/2,d.position.y=0,d.receiveShadow=!0,e.add(d),this.addFloorDetails(e,t,s,n);const u=this.getMaterial("ceiling",n.ceiling,{roughness:.85,metalness:.05}),p=new Dt(t,s,2,2),f=new w(p,u);f.rotation.x=Math.PI/2,f.position.y=i,f.receiveShadow=!0,e.add(f),this.addCeilingDetails(e,t,i,s,n);const y=this.getMaterial("wall",n.wall,{roughness:.85,metalness:.1}),m=this.createWall(t,i,y);m.position.set(0,i/2,-r),e.add(m);const g=this.createWall(t,i,y);g.position.set(0,i/2,r),g.rotation.y=Math.PI,e.add(g);const x=this.createWall(s,i,y);x.position.set(o,i/2,0),x.rotation.y=-Math.PI/2,e.add(x);const v=this.createWall(s,i,y);v.position.set(-o,i/2,0),v.rotation.y=Math.PI/2,e.add(v),this.addWallDetails(e,t,i,s,n)}createWall(e,t,i){const s=new Dt(e,t,2,2),n=new w(s,i);return n.receiveShadow=!0,n.castShadow=!0,n}addFloorDetails(e,t,i,s){const n=this.getMaterial("trim",s.trim,{roughness:.8,metalness:.2}),a=.3,o=.05,r=new ie(t+a*2,o,a),c=new w(r,n);c.position.set(0,o/2,-i/2+a/2),e.add(c);const h=new w(r,n);h.position.set(0,o/2,i/2-a/2),e.add(h);const d=new ie(a,o,i),u=new w(d,n);u.position.set(t/2-a/2,o/2,0),e.add(u);const p=new w(d,n);p.position.set(-t/2+a/2,o/2,0),e.add(p)}addCeilingDetails(e,t,i,s,n){const a=this.getMaterial("beam",n.accent,{roughness:.7,metalness:.15}),o=.3,r=.2,c=new ie(t*.9,r,o),h=new w(c,a);if(h.position.set(0,i-r/2,0),h.castShadow=!0,e.add(h),t>10){const d=new ie(o,r,s*.9),u=new w(d,a);u.position.set(0,i-r/2,0),u.castShadow=!0,e.add(u)}}addWallDetails(e,t,i,s,n){const a=this.getMaterial("wall_trim",n.accent,{roughness:.75,metalness:.2}),o=.15,r=.05,c=new ie(t,o,r),h=new w(c,a);h.position.set(0,o/2,-s/2+r/2),e.add(h);const d=new w(c,a);d.position.set(0,o/2,s/2-r/2),e.add(d);const u=new ie(r,o,s),p=new w(u,a);p.position.set(t/2-r/2,o/2,0),e.add(p);const f=new w(u,a);f.position.set(-t/2+r/2,o/2,0),e.add(f)}addRoomFeatures(e,t,i,s){switch(t.type){case Fe.ENTRANCE:this.addEntranceFeatures(e,t,s);break;case Fe.BOSS:this.addBossRoomFeatures(e,t,s);break;case Fe.COMBAT:this.addCombatFeatures(e,t,s);break;case Fe.PUZZLE:this.addPuzzleFeatures(e,t,s);break;case Fe.TREASURE:this.addTreasureFeatures(e,t,s);break;case Fe.REST:this.addRestFeatures(e,t,s);break;case Fe.MINIBOSS:this.addMinibossFeatures(e,t,s);break}if(t.features)for(const n of t.features)this.addFeature(e,n,s)}addEntranceFeatures(e,t,i){const s=this.getMaterial("arch",i.accent,{roughness:.7,metalness:.3}),n=new Ai(1.5,.2,8,12,Math.PI),a=new w(n,s);a.position.set(0,2.5,t.depth/2-.5),a.rotation.x=Math.PI/2,a.castShadow=!0,e.add(a);const o=new ce(.2,.25,2.5,8),r=new w(o,s);r.position.set(-1.5,1.25,t.depth/2-.5),r.castShadow=!0,e.add(r);const c=new w(o,s);c.position.set(1.5,1.25,t.depth/2-.5),c.castShadow=!0,e.add(c);const h=new X({color:i.light,emissive:i.light,emissiveIntensity:2,transparent:!0,opacity:.8}),d=new Ki(.8,1,6),u=new w(d,h);u.position.set(0,.01,t.depth/2-1.5),u.rotation.x=-Math.PI/2,e.add(u)}addBossRoomFeatures(e,t,i){const s=new Ki(4,5,32),n=new X({color:i.accent,emissive:i.light,emissiveIntensity:.5,transparent:!0,opacity:.4}),a=new w(s,n);a.position.set(0,.02,0),a.rotation.x=-Math.PI/2,e.add(a);const o=this.getMaterial("altar",i.accent,{roughness:.5,metalness:.4}),r=new ie(3,.8,2),c=new w(r,o);c.position.set(0,.4,-t.depth/2+3),c.castShadow=!0,e.add(c);const h=new ie(4,.2,1);for(let g=0;g<3;g++){const x=new w(h,o);x.position.set(0,.1+g*.2,-t.depth/2+4.5+g*.5),x.castShadow=!0,e.add(x)}const d=new ce(.5,.6,t.height*.9,8),u=this.getMaterial("pillar",i.wall,{roughness:.7,metalness:.2}),p=[{x:-t.width/2+2,z:-t.depth/2+2},{x:t.width/2-2,z:-t.depth/2+2},{x:-t.width/2+2,z:t.depth/2-2},{x:t.width/2-2,z:t.depth/2-2}];for(const g of p){const x=new w(d,u);x.position.set(g.x,t.height*.45,g.z),x.castShadow=!0,e.add(x);const v=new We(i.light,.8,8);v.position.set(g.x,t.height-.5,g.z),e.add(v),this.activeLights.push(v)}const f=new Ai(1.5,.15,8,24),y=new X({color:4521864,emissive:4521864,emissiveIntensity:.2,transparent:!0,opacity:.3}),m=new w(f,y);m.position.set(0,2,-t.depth/2+1),m.rotation.x=Math.PI/2,m.userData.isExitPortal=!0,m.userData.isActive=!1,e.add(m)}addCombatFeatures(e,t,i){const s=new ce(.35,.4,t.height*.8,8),n=this.getMaterial("pillar",i.wall,{roughness:.75,metalness:.15}),a=Math.floor(Math.min(t.width,t.depth)/5);for(let o=0;o<a;o++){const r=o/a*Math.PI*2,c=Math.min(t.width,t.depth)*.3,h=new w(s,n);h.position.set(Math.cos(r)*c,t.height*.4,Math.sin(r)*c),h.castShadow=!0,h.userData.destructible=!0,e.add(h)}}addPuzzleFeatures(e,t,i){const s=this.getMaterial("pedestal",i.accent,{roughness:.6,metalness:.3}),n=new ce(.5,.6,1.2,8),a=new w(n,s);a.position.set(0,.6,0),a.castShadow=!0,e.add(a);const o=new ce(.6,.5,.1,8),r=new w(o,s);r.position.set(0,1.25,0),r.castShadow=!0,e.add(r);const c=new X({color:i.light,emissive:i.light,emissiveIntensity:1.5,transparent:!0,opacity:.6});for(let h=0;h<4;h++){const d=h/4*Math.PI*2,u=2.5,p=new Zi(.3,6),f=new w(p,c);f.position.set(Math.cos(d)*u,.02,Math.sin(d)*u),f.rotation.x=-Math.PI/2,e.add(f)}}addTreasureFeatures(e,t,i){const s=new wt(1.5,.8,8),n=new X({color:14527044,roughness:.4,metalness:.8}),a=new w(s,n);a.position.set(0,.3,-t.depth/4),a.castShadow=!0,e.add(a);const o=new ce(.08,.08,.02,8),r=new X({color:16763972,roughness:.3,metalness:.9});for(let h=0;h<20;h++){const d=new w(o,r);d.position.set((Math.random()-.5)*t.width*.6,.01,(Math.random()-.5)*t.depth*.6),d.rotation.x=Math.PI/2,d.rotation.z=Math.random()*Math.PI,e.add(d)}const c=new We(16763972,1,6);c.position.set(0,2,-t.depth/4),e.add(c),this.activeLights.push(c)}addRestFeatures(e,t,i){const s=new ne;s.position.set(0,0,0);const n=new ce(.15,.15,1,6),a=new X({color:3811872,roughness:.9});for(let y=0;y<4;y++){const m=new w(n,a),g=y/4*Math.PI*2;m.position.set(Math.cos(g)*.3,.1,Math.sin(g)*.3),m.rotation.z=Math.PI/2,m.rotation.y=g,s.add(m)}const o=new We(16737826,2,8);o.position.set(0,1,0),s.add(o),this.activeLights.push(o);const r=new re(.05,4,4),c=new X({color:16729088,emissive:16729088,emissiveIntensity:3});for(let y=0;y<8;y++){const m=new w(r,c);m.position.set((Math.random()-.5)*.5,.3+Math.random()*.5,(Math.random()-.5)*.5),s.add(m)}e.add(s);const h=new X({color:4864554,roughness:.8}),d=new w(new ie(1.5,.1,.5),h);d.position.set(-2.5,.5,0),d.castShadow=!0,e.add(d);const u=new ie(.1,.5,.4),p=new w(u,h);p.position.set(-3.1,.25,0),e.add(p);const f=new w(u,h);f.position.set(-1.9,.25,0),e.add(f)}addMinibossFeatures(e,t,i){const s=new Ki(2.5,3,24),n=new X({color:i.accent,emissive:i.light,emissiveIntensity:.3,transparent:!0,opacity:.3}),a=new w(s,n);a.position.set(0,.02,0),a.rotation.x=-Math.PI/2,e.add(a);const o=new ce(.3,.35,t.height*.7,6),r=this.getMaterial("pillar",i.wall,{roughness:.7});for(let c=0;c<4;c++){const h=c/4*Math.PI*2+Math.PI/4,d=3.5,u=new w(o,r);u.position.set(Math.cos(h)*d,t.height*.35,Math.sin(h)*d),u.castShadow=!0,e.add(u)}}addFeature(e,t,i){const{type:s,position:n}=t;switch(s){case"entrance_portal":break;case"exit_portal":break;case"bonfire":break;case"boss_altar":break;default:console.log(`[DungeonRenderer] Unknown feature type: ${s}`)}}addRoomProps(e,t,i,s){if(!(!t.props||t.props.length===0))for(const n of t.props){const a=this.createProp(n,i,s);a&&(a.position.set(n.position?.x||0,n.position?.y||0,n.position?.z||0),n.rotation&&(a.rotation.y=n.rotation),n.scale&&a.scale.setScalar(n.scale),e.add(a))}}createProp(e,t,i){const s=NS[e.type];if(!s)return this.createGenericProp(e,i);const n=s.color||i.accent,a=new X({color:n,roughness:.8,metalness:s.metallic?.7:.1});s.emissive&&a.emissive&&(a.emissive=new H(s.emissive),a.emissiveIntensity=1.5);let o;switch(s.geometry){case"box":o=new w(new ie(...s.size||[1,1,1]),a);break;case"cylinder":o=new w(new ce(s.size?.[0]||.5,s.size?.[0]||.5,s.size?.[1]||1,8),a);break;case"sphere":o=new w(new re(s.size?.[0]||.5,8,6),a);break;case"cone":o=new w(new wt(s.size?.[0]||.5,s.size?.[1]||1,6),a);break;case"crystal":o=this.createCrystal(n,s.emissive);break;case"mushroom":o=this.createMushroom(n,s.emissive);break;default:o=new w(new ie(.5,.5,.5),a)}if(o.castShadow=!0,o.receiveShadow=!0,s.light){const r=new We(s.emissive||n,.5,4);r.position.y=(s.size?.[1]||1)/2,o.add(r),this.activeLights.push(r)}return o}createCrystal(e,t){const i=new ne,s=new X({color:e,emissive:t||e,emissiveIntensity:1.5,transparent:!0,opacity:.85}),n=new Ji(.2,0);for(let o=0;o<4;o++){const r=new w(n,s),c=o/4*Math.PI*2,h=.3+Math.random()*.4;r.position.set(Math.cos(c)*.2,h,Math.sin(c)*.2),r.scale.set(.5+Math.random()*.5,1.5+Math.random(),.5+Math.random()*.5),r.rotation.y=Math.random()*Math.PI,i.add(r)}const a=new w(n,s);return a.position.y=.6,a.scale.set(1,2,1),i.add(a),i}createMushroom(e,t){const i=new ne,s=new X({color:9075306,roughness:.9}),n=new X({color:e,emissive:t||e,emissiveIntensity:1.2}),a=new ce(.08,.1,.3,6),o=new w(a,s);o.position.y=.15,i.add(o);const r=new re(.18,8,6,0,Math.PI*2,0,Math.PI/2),c=new w(r,n);return c.position.y=.3,i.add(c),i}createGenericProp(e,t){const i=new X({color:t.accent,roughness:.8}),s=new w(new ie(.5,.5,.5),i);return s.castShadow=!0,s}addRoomLighting(e,t,i,s){const n=new We(s.ambient,.3,t.width*2);if(n.position.set(0,t.height-1,0),e.add(n),this.activeLights.push(n),t.lights)for(const a of t.lights){const o=this.createLight(a,s);o&&(e.add(o),this.activeLights.push(o))}t.type!==Fe.REST&&this.addWallTorches(e,t,s)}createLight(e,t){const i=new ne,s=e.color||t.light,n=e.intensity||1,a=6,o=new We(s,n,a);switch(o.position.set(e.position?.x||0,e.position?.y||2,e.position?.z||0),i.add(o),e.type){case"torch":this.addTorchVisual(i,e.position,s);break;case"crystal":this.addCrystalVisual(i,e.position,s);break;case"magic":this.addMagicVisual(i,e.position,s);break}return i.userData.lightData=e,i.userData.light=o,i}addTorchVisual(e,t,i){const s=new X({color:3815994,roughness:.6,metalness:.4}),n=new ce(.05,.08,.3,6),a=new w(n,s);a.position.set(t?.x||0,(t?.y||2)-.3,t?.z||0),e.add(a);const o=new X({color:i,emissive:i,emissiveIntensity:3,transparent:!0,opacity:.8}),r=new re(.08,6,4),c=new w(r,o);c.position.set(t?.x||0,t?.y||2,t?.z||0),c.scale.set(1,1.5,1),e.add(c),e.userData.flame=c}addCrystalVisual(e,t,i){const s=new X({color:i,emissive:i,emissiveIntensity:2,transparent:!0,opacity:.85}),n=new Ji(.15,0),a=new w(n,s);a.position.set(t?.x||0,t?.y||2,t?.z||0),a.rotation.y=Math.random()*Math.PI,e.add(a),e.userData.crystal=a}addMagicVisual(e,t,i){const s=new X({color:i,emissive:i,emissiveIntensity:2.5,transparent:!0,opacity:.7}),n=new re(.2,12,8),a=new w(n,s);a.position.set(t?.x||0,t?.y||2,t?.z||0),e.add(a);const o=new X({color:i,emissive:i,emissiveIntensity:1.5,transparent:!0,opacity:.4}),r=new Ai(.35,.02,6,16),c=new w(r,o);c.position.copy(a.position),c.rotation.x=Math.PI/2,e.add(c),e.userData.orb=a,e.userData.ring=c}addWallTorches(e,t,i){const a=Math.max(1,Math.floor(t.width/6)),o=Math.max(1,Math.floor(t.depth/6));for(let r=0;r<a;r++){const c=(r+.5)/a*t.width-t.width/2,h=this.createWallTorch(i.light);h.position.set(c,2.5,-t.depth/2+.2),e.add(h);const d=this.createWallTorch(i.light);d.position.set(c,2.5,t.depth/2-.2),d.rotation.y=Math.PI,e.add(d)}for(let r=0;r<o;r++){const c=(r+.5)/o*t.depth-t.depth/2,h=this.createWallTorch(i.light);h.position.set(t.width/2-.2,2.5,c),h.rotation.y=-Math.PI/2,e.add(h);const d=this.createWallTorch(i.light);d.position.set(-t.width/2+.2,2.5,c),d.rotation.y=Math.PI/2,e.add(d)}}createWallTorch(e){const t=new ne,i=new X({color:3813424,roughness:.6,metalness:.5}),s=new ie(.1,.15,.25),n=new w(s,i);n.position.z=.1,t.add(n);const a=new ce(.04,.06,.35,6),o=new w(a,i);o.position.set(0,.15,.25),o.rotation.x=-.3,t.add(o);const r=new X({color:e,emissive:e,emissiveIntensity:3,transparent:!0,opacity:.9}),c=new re(.06,6,4),h=new w(c,r);h.position.set(0,.35,.35),h.scale.set(1,1.4,1),t.add(h);const d=new We(e,.6,5);return d.position.copy(h.position),t.add(d),this.activeLights.push(d),t.userData.flame=h,t.userData.light=d,t}renderConnection(e,t,i,s){const n=t.rooms.find(o=>o.id===e.from),a=t.rooms.find(o=>o.id===e.to);!n||!a||(e.type==="corridor"&&e.corridor&&this.renderCorridor(e.corridor,s),this.renderDoor(n,a,e,s))}renderCorridor(e,t){const i=new ne;i.name="Corridor",i.position.set(e.position.x,e.position.y,e.position.z);const s=e.width,n=e.height,a=e.length,o=e.direction==="north"||e.direction==="south",r=this.getMaterial("corridor_floor",t.floor,{roughness:.9}),c=new Dt(o?s:a,o?a:s),h=new w(c,r);h.rotation.x=-Math.PI/2,h.receiveShadow=!0,i.add(h);const d=this.getMaterial("corridor_ceiling",t.ceiling,{roughness:.85}),u=new w(c,d);u.rotation.x=Math.PI/2,u.position.y=n,i.add(u);const p=this.getMaterial("corridor_wall",t.wall,{roughness:.85});if(o){const y=this.createWall(a,n,p);y.position.set(s/2,n/2,0),y.rotation.y=-Math.PI/2,i.add(y);const m=this.createWall(a,n,p);m.position.set(-s/2,n/2,0),m.rotation.y=Math.PI/2,i.add(m)}else{const y=this.createWall(a,n,p);y.position.set(0,n/2,-s/2),i.add(y);const m=this.createWall(a,n,p);m.position.set(0,n/2,s/2),m.rotation.y=Math.PI,i.add(m)}const f=new We(t.light,.4,6);f.position.set(0,n-.5,0),i.add(f),this.activeLights.push(f),e.trap&&this.addCorridorTrap(i,e.trap,t),this.roomsGroup.add(i)}addCorridorTrap(e,t,i){const s=new X({color:4868682,roughness:.7,metalness:.3});switch(t.visualType){case"floor_spikes":const n=new ie(2,.05,2),a=new w(n,s);a.position.y=.025,a.userData.isTrap=!0,a.userData.trapData=t,e.add(a);break;case"wall_arrows":const o=new X({color:1710618,roughness:.9}),r=new ie(.05,.3,.1);for(let c=0;c<3;c++){const h=new w(r,o);h.position.set(2,1.5,(c-1)*.5),h.userData.isTrap=!0,e.add(h)}break}}renderDoor(e,t,i,s){const n=new ne;n.name=`Door_${i.from}_${i.to}`;const a=(e.position.x+t.position.x)/2,o=(e.position.z+t.position.z)/2;n.position.set(a,0,o),i.direction==="north"||i.direction==="south"||(n.rotation.y=Math.PI/2);const c=this.getMaterial("door_frame",s.accent,{roughness:.7,metalness:.2}),h=new ie(.2,3,.3),d=new w(h,c);d.position.set(-1.1,1.5,0),n.add(d);const u=new w(h,c);u.position.set(1.1,1.5,0),n.add(u);const p=new ie(2.4,.2,.3),f=new w(p,c);f.position.set(0,3.1,0),n.add(f);const y=this.getMaterial("door",s.wall,{roughness:.8,metalness:.15}),m=new ie(1.8,2.8,.1),g=new w(m,y);g.position.set(0,1.5,0),g.userData.isDoor=!0,g.userData.isOpen=!0,g.userData.connection=i,n.add(g);const x=new X({color:5921370,roughness:.4,metalness:.7}),v=new re(.08,8,6),b=new w(v,x);b.position.set(.7,1.5,.1),n.add(b),this.doorsGroup.add(n),this.doors.set(`${i.from}_${i.to}`,{group:n,door:g,isOpen:!0,isLocked:!1})}addAtmosphericParticles(e,t){const s=new Float32Array(600),n=new Float32Array(600),a=t.maxX-t.minX+20,o=t.maxZ-t.minZ+20,r=(t.maxX+t.minX)/2,c=(t.maxZ+t.minZ)/2,h=new H(e.ambientColor||4473924);for(let f=0;f<200;f++)s[f*3]=r+(Math.random()-.5)*a,s[f*3+1]=Math.random()*5+1,s[f*3+2]=c+(Math.random()-.5)*o,n[f*3]=h.r,n[f*3+1]=h.g,n[f*3+2]=h.b;const d=new mt;d.setAttribute("position",new Je(s,3)),d.setAttribute("color",new Je(n,3));const u=new Ri({size:.08,vertexColors:!0,transparent:!0,opacity:.4,blending:ui,depthWrite:!1}),p=new Bi(d,u);p.userData.basePositions=s.slice(),p.userData.time=0,this.effectsGroup.add(p),this.particleSystems.push(p)}getMaterial(e,t,i={}){const s=`${e}_${t}`;if(this.materialsCache.has(s))return this.materialsCache.get(s);const n=new X({color:t,roughness:i.roughness??.8,metalness:i.metalness??.1,...i});return this.materialsCache.set(s,n),n}update(e){for(const t of this.particleSystems){if(!t.userData.basePositions)continue;t.userData.time+=e;const i=t.userData.time,s=t.geometry.attributes.position.array,n=t.userData.basePositions;for(let a=0;a<s.length/3;a++){const o=a*.5;s[a*3]=n[a*3]+Math.sin(i+o)*.3,s[a*3+1]=n[a*3+1]+Math.sin(i*.5+o)*.2,s[a*3+2]=n[a*3+2]+Math.cos(i+o)*.3}t.geometry.attributes.position.needsUpdate=!0}this.effectsGroup.traverse(t=>{if(t.userData.flame){const i=1+Math.sin(Date.now()*.01)*.1;t.userData.flame.scale.y=1.4*i}t.userData.ring&&(t.userData.ring.rotation.z+=e*.5),t.userData.crystal&&(t.userData.crystal.rotation.y+=e*.3)});for(const t of this.activeLights)t.userData?.flicker&&(t.intensity=t.userData.baseIntensity*(.9+Math.random()*.2))}openDoor(e){const t=this.doors.get(e);t&&!t.isOpen&&!t.isLocked&&(t.isOpen=!0,t.door.rotation.y=Math.PI/2,t.door.position.x=.9)}closeDoor(e){const t=this.doors.get(e);t&&t.isOpen&&(t.isOpen=!1,t.door.rotation.y=0,t.door.position.x=0)}lockDoor(e){const t=this.doors.get(e);t&&(t.isLocked=!0,this.closeDoor(e))}unlockDoor(e){const t=this.doors.get(e);t&&(t.isLocked=!1)}markRoomExplored(e){const t=this.minimapRooms.find(s=>s.id===e);t&&(t.isExplored=!0);const i=this.renderedRooms.get(e);i&&(i.userData.isExplored=!0)}markRoomCleared(e){const t=this.minimapRooms.find(i=>i.id===e);t&&(t.isCleared=!0)}getMinimapData(){return{rooms:this.minimapRooms,bounds:this.currentDungeon?.bounds,dungeonName:this.currentDungeon?.dungeonData?.name}}activateExitPortal(){if(!this.currentDungeon)return;const e=this.renderedRooms.get(this.currentDungeon.bossRoom?.id);e&&e.traverse(t=>{if(t.userData.isExitPortal){t.userData.isActive=!0,t.material.opacity=.8,t.material.emissive&&(t.material.emissiveIntensity=2);const i=new We(4521864,2,8);i.position.copy(t.position),e.add(i),this.activeLights.push(i)}})}dispose(){this.clearDungeon(),this.materialsCache.forEach(e=>e.dispose()),this.materialsCache.clear(),this.dungeonGroup.parent&&this.dungeonGroup.parent.remove(this.dungeonGroup)}}let ti=null;const nl={initialize(l){return ti||(ti=new BS(l)),ti},getInstance(){return ti},renderDungeon(l){return ti?ti.renderDungeon(l):(console.warn("[DungeonRenderer] Not initialized"),null)},clearDungeon(){ti&&ti.clearDungeon()},update(l){ti&&ti.update(l)},openDoor(l){ti&&ti.openDoor(l)},unlockDoor(l){ti&&ti.unlockDoor(l)},markRoomExplored(l){ti&&ti.markRoomExplored(l)},markRoomCleared(l){ti&&ti.markRoomCleared(l)},getMinimapData(){return ti?ti.getMinimapData():null},activateExitPortal(){ti&&ti.activateExitPortal()},dispose(){ti&&(ti.dispose(),ti=null)}},os={OVERWORLD:"overworld",ENTERING:"entering",LOADING:"loading",IN_DUNGEON:"in_dungeon",EXITING:"exiting"},al={promptDistance:5,interactCooldown:.5},ol={fadeInDuration:.8,loadingMinTime:.5,fadeOutDuration:.6};class zS{constructor(e,t,i,s,n,a=null){this.scene=e,this.world=t,this.player=i,this.gameManager=s,this.inputManager=n,this.audioManager=a,this.state=os.OVERWORLD,this.currentDungeon=null,this.currentDungeonId=null,this.currentModifier="none",this.generator=new rf,this.overworldState=null,this.nearestEntrance=null,this.entranceDistance=1/0,this.interactCooldown=0,this.dungeonProgress=new Map,this.exitPortal=null,this.exitPortalMesh=null,this.transitionOverlay=null,this.transitionProgress=0,this.transitionCallback=null,this.promptElement=null,this.loadingElement=null,this._createUI(),this._loadProgress(),console.log("[DungeonManager] Initialized")}_createUI(){this.promptElement=document.createElement("div"),this.promptElement.id="dungeon-prompt",this.promptElement.innerHTML=`
      <div class="dungeon-prompt-inner">
        <div class="dungeon-name">Forgotten Catacombs</div>
        <div class="dungeon-level">Recommended Lv. <span class="level-num">10</span></div>
        <div class="dungeon-modifier"></div>
        <div class="dungeon-action">[E] Enter Dungeon</div>
      </div>
    `,this.promptElement.style.cssText=`
      position: fixed;
      bottom: 180px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(180deg, rgba(20,15,25,0.95) 0%, rgba(10,8,15,0.98) 100%);
      border: 2px solid rgba(160, 120, 80, 0.7);
      border-radius: 8px;
      padding: 16px 24px;
      text-align: center;
      font-family: 'Times New Roman', serif;
      color: #e8dcc8;
      display: none;
      z-index: 100;
      box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 20px rgba(160,120,80,0.1);
      min-width: 220px;
    `,document.body.appendChild(this.promptElement);const e=document.createElement("style");e.textContent=`
      #dungeon-prompt .dungeon-name {
        font-size: 22px;
        font-weight: bold;
        color: #d4a055;
        text-shadow: 0 0 10px rgba(212,160,85,0.5);
        margin-bottom: 6px;
      }
      #dungeon-prompt .dungeon-level {
        font-size: 14px;
        color: #aaa;
        margin-bottom: 4px;
      }
      #dungeon-prompt .dungeon-level .level-num {
        color: #ff9944;
        font-weight: bold;
      }
      #dungeon-prompt .dungeon-modifier {
        font-size: 13px;
        color: #cc66ff;
        font-style: italic;
        margin-bottom: 8px;
      }
      #dungeon-prompt .dungeon-modifier.elite { color: #ff6644; }
      #dungeon-prompt .dungeon-modifier.cursed { color: #aa44ff; }
      #dungeon-prompt .dungeon-modifier.blessed { color: #44ff88; }
      #dungeon-prompt .dungeon-modifier.timed { color: #44aaff; }
      #dungeon-prompt .dungeon-action {
        font-size: 16px;
        color: #88cc88;
        margin-top: 10px;
      }
      #dungeon-prompt.in-progress .dungeon-action::after {
        content: ' (Resume)';
        color: #ffcc44;
      }
      
      #dungeon-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }
      #dungeon-loading.active {
        opacity: 1;
        pointer-events: auto;
      }
      #dungeon-loading .loading-title {
        font-family: 'Times New Roman', serif;
        font-size: 36px;
        color: #d4a055;
        text-shadow: 0 0 20px rgba(212,160,85,0.6);
        margin-bottom: 20px;
      }
      #dungeon-loading .loading-subtitle {
        font-family: 'Times New Roman', serif;
        font-size: 18px;
        color: #888;
        font-style: italic;
        margin-bottom: 40px;
      }
      #dungeon-loading .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid rgba(160,120,80,0.3);
        border-top: 4px solid #d4a055;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      #dungeon-transition {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 999;
        opacity: 0;
        pointer-events: none;
        transition: none;
      }
      
      #dungeon-exit-prompt {
        position: fixed;
        bottom: 150px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(15,12,20,0.9);
        border: 2px solid rgba(100,180,255,0.6);
        border-radius: 6px;
        padding: 12px 20px;
        font-family: 'Times New Roman', serif;
        color: #88ccff;
        text-align: center;
        display: none;
        z-index: 100;
        box-shadow: 0 0 20px rgba(100,180,255,0.3);
      }
      #dungeon-exit-prompt .exit-title {
        font-size: 18px;
        margin-bottom: 4px;
      }
      #dungeon-exit-prompt .exit-action {
        font-size: 14px;
        color: #88cc88;
      }
    `,document.head.appendChild(e),this.loadingElement=document.createElement("div"),this.loadingElement.id="dungeon-loading",this.loadingElement.innerHTML=`
      <div class="loading-title">Entering Dungeon</div>
      <div class="loading-subtitle">Prepare yourself...</div>
      <div class="loading-spinner"></div>
    `,document.body.appendChild(this.loadingElement),this.transitionOverlay=document.createElement("div"),this.transitionOverlay.id="dungeon-transition",document.body.appendChild(this.transitionOverlay),this.exitPromptElement=document.createElement("div"),this.exitPromptElement.id="dungeon-exit-prompt",this.exitPromptElement.innerHTML=`
      <div class="exit-title">Exit Portal</div>
      <div class="exit-action">[E] Return to Overworld</div>
    `,document.body.appendChild(this.exitPromptElement)}_checkEntrances(){if(!this.world.caveManager)return;const e=this.player.mesh.position,t=this.world.caveManager.caves;this.nearestEntrance=null,this.entranceDistance=1/0;for(const i of t){const s=e.x-i.x,n=e.z-i.z,a=Math.sqrt(s*s+n*n);a<this.entranceDistance&&(this.entranceDistance=a,this.nearestEntrance=i)}this.nearestEntrance&&this.entranceDistance<al.promptDistance?this._showEntrancePrompt():this._hideEntrancePrompt()}_showEntrancePrompt(){if(!this.nearestEntrance)return;const e=this._getDungeonIdForCave(this.nearestEntrance),t=Hs(e);if(!t){this.promptElement.style.display="none";return}const i=this.dungeonProgress.get(e),s=i&&!i.completed,n=this.promptElement.querySelector(".dungeon-name"),a=this.promptElement.querySelector(".level-num"),o=this.promptElement.querySelector(".dungeon-modifier");if(n.textContent=t.name,a.textContent=t.recommendedLevel,this.currentModifier!=="none"){const r=rr[this.currentModifier.toUpperCase()];o.textContent=r?r.name:"",o.className=`dungeon-modifier ${this.currentModifier}`}else o.textContent="",o.className="dungeon-modifier";s?this.promptElement.classList.add("in-progress"):this.promptElement.classList.remove("in-progress"),this.promptElement.style.display="block"}_hideEntrancePrompt(){this.promptElement.style.display="none"}_getDungeonIdForCave(e){const t=Math.floor(e.x*7+e.z*13),i=Object.keys(Jn),s=Math.abs(t)%i.length,n=i[s],a=Jn[n];return a?a.id:"forgotten_catacombs"}enterDungeon(e,t="none"){if(this.state!==os.OVERWORLD){console.warn("[DungeonManager] Cannot enter dungeon - not in overworld");return}const i=Hs(e);if(!i){console.error(`[DungeonManager] Unknown dungeon: ${e}`);return}console.log(`[DungeonManager] Entering ${i.name} (${t})`),this.state=os.ENTERING,this.currentDungeonId=e,this.currentModifier=t,this._hideEntrancePrompt(),this.audioManager&&this.audioManager.play("doorOpen",{volume:.6}),this._saveOverworldState(),this._startTransition("enter",()=>{this._loadDungeon(e,t)})}exitDungeon(){if(this.state!==os.IN_DUNGEON){console.warn("[DungeonManager] Cannot exit - not in dungeon");return}console.log("[DungeonManager] Exiting dungeon, returning to overworld"),this.state=os.EXITING,this.exitPromptElement.style.display="none",this.audioManager&&this.audioManager.play("teleport",{volume:.6}),this._saveDungeonProgress(),this._startTransition("exit",()=>{this._unloadDungeon(),this._restoreOverworldState()})}_startTransition(e,t){this.transitionProgress=0,this.transitionCallback=t;const i=e==="enter"?ol.fadeInDuration:ol.fadeOutDuration,s=this.loadingElement.querySelector(".loading-title"),n=this.loadingElement.querySelector(".loading-subtitle");if(e==="enter"){const r=Hs(this.currentDungeonId);s.textContent=r?`Entering ${r.name}`:"Entering Dungeon",n.textContent="Prepare yourself..."}else s.textContent="Returning to Overworld",n.textContent="The light awaits...";const a=performance.now(),o=()=>{const r=(performance.now()-a)/1e3;this.transitionProgress=Math.min(r/i,1),this.transitionOverlay.style.opacity=this.transitionProgress,this.transitionProgress>=1?(this.loadingElement.classList.add("active"),setTimeout(()=>{this.transitionCallback&&this.transitionCallback()},ol.loadingMinTime*1e3)):requestAnimationFrame(o)};requestAnimationFrame(o)}_endTransition(){const e=ol.fadeOutDuration,t=performance.now();this.loadingElement.classList.remove("active");const i=()=>{const s=(performance.now()-t)/1e3,n=Math.min(s/e,1);this.transitionOverlay.style.opacity=1-n,n<1?requestAnimationFrame(i):this.transitionOverlay.style.opacity=0};requestAnimationFrame(i)}_saveOverworldState(){this.overworldState={playerPosition:this.player.mesh.position.clone(),playerRotation:this.player.mesh.rotation.y,worldVisible:!0},console.log("[DungeonManager] Saved overworld state")}_restoreOverworldState(){this.overworldState&&(this.player.mesh.position.copy(this.overworldState.playerPosition),this.player.mesh.position.y=this.world.terrain.getTerrainHeight(this.overworldState.playerPosition.x,this.overworldState.playerPosition.z),this.player.mesh.rotation.y=this.overworldState.playerRotation+Math.PI,this.player.velocity.set(0,0,0),this._setOverworldVisible(!0),this.currentDungeon=null,this.currentDungeonId=null,this.currentModifier="none",this.state=os.OVERWORLD,this._endTransition(),console.log("[DungeonManager] Restored overworld state"))}_loadDungeon(e,t){this.state=os.LOADING;const i=this.dungeonProgress.get(e);let s=null;if(i&&!i.completed&&(s=i.seed,console.log(`[DungeonManager] Resuming dungeon with seed ${s}`)),this.generator=new rf(s),this.currentDungeon=this.generator.generate(e,t),!this.currentDungeon){console.error("[DungeonManager] Failed to generate dungeon"),this._restoreOverworldState();return}this._setOverworldVisible(!1),nl.initialize(this.scene),nl.renderDungeon(this.currentDungeon),this._setupDungeonLighting();const n=this.currentDungeon.rooms.find(a=>a.type==="entrance");if(n){const a=n.worldX+n.width/2,o=n.worldZ+n.depth/2;this.player.mesh.position.set(a,.5,o),this.player.mesh.rotation.y=0,this.player.velocity.set(0,0,0)}this._createExitPortal(),(!i||i.completed)&&this.dungeonProgress.set(e,{seed:this.generator.seed,modifier:t,roomsCleared:new Set,chestsLooted:new Set,puzzlesSolved:new Set,minibossDefeated:!1,bossDefeated:!1,completed:!1,startedAt:Date.now(),timeSpent:0,enemiesKilled:0}),this.state=os.IN_DUNGEON,this._endTransition(),console.log(`[DungeonManager] Dungeon loaded - ${this.currentDungeon.rooms.length} rooms`),this.audioManager&&(this.audioManager.stopAmbientMusic(),this.audioManager.play("dungeonAmbient",{volume:.4,loop:!0}))}_unloadDungeon(){this.currentDungeon&&(nl.clearDungeon(),this.exitPortalMesh&&(this.scene.remove(this.exitPortalMesh),this.exitPortalMesh.geometry&&this.exitPortalMesh.geometry.dispose(),this.exitPortalMesh=null),this.exitPortal=null,this._removeDungeonLighting(),this.audioManager&&(this.audioManager.stop("dungeonAmbient"),this.audioManager.startAmbientMusic()),console.log("[DungeonManager] Dungeon unloaded"))}_setOverworldVisible(e){this.world.terrain&&this.world.terrain.chunkGroup&&(this.world.terrain.chunkGroup.visible=e),this.world.foliage&&this.world.foliage.foliageGroup&&(this.world.foliage.foliageGroup.visible=e),this.world.villages&&this.world.villages.regions&&this.world.villages.regions.forEach(t=>{t.meshes.forEach(i=>i.visible=e)}),this.world.caveManager&&this.world.caveManager.regions&&this.world.caveManager.regions.forEach(t=>{t.meshes.forEach(i=>i.visible=e)}),this.world.ruinsManager&&this.world.ruinsManager.regions&&this.world.ruinsManager.regions.forEach(t=>{t.meshes.forEach(i=>i.visible=e)}),e?(this.scene.background=new H(8900331),this.scene.fog=null):(this.scene.background=new H(328968),this.scene.fog=new hr(328968,.04))}_setupDungeonLighting(){const e=Hs(this.currentDungeonId);if(!e)return;this.dungeonLights=[];const t=new Vo(e.ambientColor||1381664,.3);t.name="dungeon-ambient",this.scene.add(t),this.dungeonLights.push(t)}_removeDungeonLighting(){if(this.dungeonLights){for(const e of this.dungeonLights)this.scene.remove(e);this.dungeonLights=[]}}_createExitPortal(){if(!this.currentDungeon)return;const e=this.currentDungeon.rooms.find(m=>m.type==="boss");if(!e){console.warn("[DungeonManager] No boss room found for exit portal");return}const t=e.worldX+e.width/2,i=e.worldZ+e.depth-2,s=0;this.exitPortal={x:t,y:s,z:i,active:!1};const n=new ne;n.position.set(t,s,i);const a=new Ai(1.5,.15,16,32),o=new X({color:4491519,emissive:2245802,emissiveIntensity:.8,roughness:.3,metalness:.7}),r=new w(a,o);r.rotation.x=Math.PI/2,r.position.y=1.8,n.add(r);const c=new Zi(1.4,32),h=new B({color:1710640,transparent:!0,opacity:.7,side:lt}),d=new w(c,h);d.rotation.x=Math.PI/2,d.position.y=1.8,d.name="portal-surface",n.add(d);const u=new ce(.8,1,.3,16),p=new X({color:3816016,roughness:.8,metalness:.2}),f=new w(u,p);f.position.y=.15,n.add(f);const y=new We(4491519,.3,5);y.position.y=2,y.name="portal-light",n.add(y),this.exitPortalMesh=n,this.scene.add(n)}activateExitPortal(){if(!this.exitPortal||!this.exitPortalMesh)return;this.exitPortal.active=!0;const e=this.exitPortalMesh.getObjectByName("portal-surface");e&&(e.material.color.setHex(4500223),e.material.opacity=.9);const t=this.exitPortalMesh.getObjectByName("portal-light");t&&(t.intensity=2),console.log("[DungeonManager] Exit portal activated")}_checkExitPortal(){if(!this.exitPortal||!this.exitPortal.active){this.exitPromptElement.style.display="none";return}const e=this.player.mesh.position,t=e.x-this.exitPortal.x,i=e.z-this.exitPortal.z;Math.sqrt(t*t+i*i)<3?(this.exitPromptElement.style.display="block",this.inputManager.interact&&this.interactCooldown<=0&&(this.interactCooldown=al.interactCooldown,this.exitDungeon())):this.exitPromptElement.style.display="none"}markRoomCleared(e){if(!this.currentDungeonId)return;const t=this.dungeonProgress.get(this.currentDungeonId);t&&(t.roomsCleared.add(e),this._saveProgress())}markChestLooted(e){if(!this.currentDungeonId)return;const t=this.dungeonProgress.get(this.currentDungeonId);t&&(t.chestsLooted.add(e),this._saveProgress())}markPuzzleSolved(e){if(!this.currentDungeonId)return;const t=this.dungeonProgress.get(this.currentDungeonId);t&&(t.puzzlesSolved.add(e),this._saveProgress())}markMinibossDefeated(){if(!this.currentDungeonId)return;const e=this.dungeonProgress.get(this.currentDungeonId);e&&(e.minibossDefeated=!0,this._saveProgress())}markBossDefeated(){if(!this.currentDungeonId)return;const e=this.dungeonProgress.get(this.currentDungeonId);e&&(e.bossDefeated=!0,e.completed=!0,e.completedAt=Date.now(),this._saveProgress()),this.activateExitPortal()}incrementEnemyKills(){if(!this.currentDungeonId)return;const e=this.dungeonProgress.get(this.currentDungeonId);e&&e.enemiesKilled++}getProgress(){return this.currentDungeonId?this.dungeonProgress.get(this.currentDungeonId):null}_saveDungeonProgress(){if(!this.currentDungeonId)return;const e=this.dungeonProgress.get(this.currentDungeonId);if(e){const t=Date.now();e.timeSpent+=t-(e.lastUpdateTime||e.startedAt),e.lastUpdateTime=t}this._saveProgress()}_saveProgress(){try{const e={};this.dungeonProgress.forEach((t,i)=>{e[i]={...t,roomsCleared:Array.from(t.roomsCleared),chestsLooted:Array.from(t.chestsLooted),puzzlesSolved:Array.from(t.puzzlesSolved)}}),localStorage.setItem("ashen_dungeon_progress",JSON.stringify(e))}catch(e){console.warn("[DungeonManager] Failed to save progress:",e)}}_loadProgress(){try{const e=localStorage.getItem("ashen_dungeon_progress");if(e){const t=JSON.parse(e);for(const[i,s]of Object.entries(t))this.dungeonProgress.set(i,{...s,roomsCleared:new Set(s.roomsCleared||[]),chestsLooted:new Set(s.chestsLooted||[]),puzzlesSolved:new Set(s.puzzlesSolved||[])});console.log(`[DungeonManager] Loaded progress for ${this.dungeonProgress.size} dungeons`)}}catch(e){console.warn("[DungeonManager] Failed to load progress:",e)}}update(e){switch(this.interactCooldown>0&&(this.interactCooldown-=e),this.state){case os.OVERWORLD:this._updateOverworld(e);break;case os.IN_DUNGEON:this._updateInDungeon(e);break}this.exitPortalMesh&&this.exitPortal&&this.exitPortal.active&&this._animateExitPortal(e)}_updateOverworld(e){if(this._checkEntrances(),this.nearestEntrance&&this.entranceDistance<al.promptDistance&&this.inputManager.interact&&this.interactCooldown<=0){this.interactCooldown=al.interactCooldown;const t=this._getDungeonIdForCave(this.nearestEntrance);this.enterDungeon(t,this.currentModifier)}}_updateInDungeon(e){this._checkExitPortal(),nl.update(e);const t=this.getProgress();t&&(t.lastUpdateTime=Date.now())}_animateExitPortal(e){if(!this.exitPortalMesh)return;const t=performance.now()*.001,i=this.exitPortalMesh.children[0];i&&(i.rotation.z=t*.5);const s=this.exitPortalMesh.getObjectByName("portal-surface");if(s){const a=.7+Math.sin(t*3)*.2;s.material.opacity=a}const n=this.exitPortalMesh.getObjectByName("portal-light");n&&(n.intensity=1.5+Math.sin(t*2)*.5)}isInDungeon(){return this.state===os.IN_DUNGEON}getCurrentDungeon(){return this.currentDungeon}getCurrentDungeonId(){return this.currentDungeonId}getFloorY(e,t){if(this.state!==os.IN_DUNGEON)return null;if(!this.currentDungeon)return 0;for(const i of this.currentDungeon.rooms)if(e>=i.worldX&&e<=i.worldX+i.width&&t>=i.worldZ&&t<=i.worldZ+i.depth)return 0;for(const i of this.currentDungeon.connections||[])if(i.corridor&&e>=i.corridor.worldX&&e<=i.corridor.worldX+i.corridor.width&&t>=i.corridor.worldZ&&t<=i.corridor.worldZ+i.corridor.depth)return 0;return 0}checkWallCollision(e,t=.4){if(this.state!==os.IN_DUNGEON||!this.currentDungeon)return null;const i=new T;let s=!1;for(const n of this.currentDungeon.rooms){const a=n.worldX+t,o=n.worldX+n.width-t,r=n.worldZ+t,c=n.worldZ+n.depth-t;if(e.x>=n.worldX&&e.x<=n.worldX+n.width&&e.z>=n.worldZ&&e.z<=n.worldZ+n.depth){e.x<a?(i.x=a-e.x,s=!0):e.x>o&&(i.x=o-e.x,s=!0),e.z<r?(i.z=r-e.z,s=!0):e.z>c&&(i.z=c-e.z,s=!0);break}}return s?i:null}getDungeonEntrances(){return!this.world||!this.world.caveManager?[]:(this.world.caveManager.caves||[]).map(t=>({x:t.x,z:t.z,name:t.name||"Cave",difficulty:t.difficulty||1}))}dispose(){this.promptElement&&this.promptElement.remove(),this.loadingElement&&this.loadingElement.remove(),this.transitionOverlay&&this.transitionOverlay.remove(),this.exitPromptElement&&this.exitPromptElement.remove(),this.currentDungeon&&this._unloadDungeon(),this.scene=null,this.world=null,this.player=null,this.gameManager=null,this.inputManager=null}}let cf=null;function FS(l,e,t,i,s,n){return cf=new zS(l,e,t,i,s,n),cf}class US{constructor(e,t,i,s,n,a){this.scene=e,this.terrain=t,this.input=i,this.inventory=s,this.particles=n,this.audio=a,this.chunkSize=64,this.loadDistance=2,this.unloadDistance=4,this.nodesPerChunk={ore_vein:3,herb_patch:4,wood_stump:2,crystal_node:1},this.nodeMinDistance=8,this.nodeMaxSlope=.5,this.castleExclusionRadius=40,this.villageExclusionRadius=15,this.chunks=new Map,this.activeNodes=[],this.depletedNodes=new Map,this.nearbyNode=null,this.isGathering=!1,this.gatherProgress=0,this.gatherTarget=null,this.playerPosition=new T,this._createSharedAssets(),this._createGatheringUI(),this.lastPlayerChunkX=null,this.lastPlayerChunkZ=null,console.log("[GatheringManager] Initialized")}_createSharedAssets(){this.oreVeinGeo=new js(.5,0),this.oreVeinMat=new X({color:5592405,roughness:.8,metalness:.2}),this.oreGlintMat=new X({color:11189196,roughness:.3,metalness:.8,emissive:3359829,emissiveIntensity:.3}),this.herbPatchGeo=new wt(.2,.4,5),this.herbPatchGeo.translate(0,.2,0),this.herbMat=new X({color:4500036,roughness:.9}),this.herbFlowerMat=new X({color:8939263,emissive:4465322,emissiveIntensity:.2}),this.stumpGeo=new ce(.4,.5,.6,8),this.stumpGeo.translate(0,.3,0),this.stumpMat=new X({color:5914672,roughness:.95}),this.stumpRingsMat=new X({color:6967360,roughness:.9}),this.crystalGeo=new Ji(.3,0),this.crystalMat=new X({color:8956671,roughness:.2,metalness:.3,emissive:4482730,emissiveIntensity:.5,transparent:!0,opacity:.85})}_createGatheringUI(){this.promptContainer=document.createElement("div"),this.promptContainer.id="gathering-prompt",this.promptContainer.style.cssText=`
      position: fixed;
      bottom: 180px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      z-index: 140;
      pointer-events: none;
    `,this.promptName=document.createElement("div"),this.promptName.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 16px;
      font-weight: bold;
      color: #88ccaa;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.9);
      letter-spacing: 1px;
    `,this.promptContainer.appendChild(this.promptName),this.promptKey=document.createElement("div"),this.promptKey.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(100, 200, 150, 0.4);
      border-radius: 4px;
      font-family: 'Cinzel', serif;
      font-size: 14px;
      color: #aaffcc;
    `,this.promptKey.innerHTML='<span style="background:#3a3a3a;padding:2px 8px;border-radius:3px;border:1px solid #666;">E</span> Gather',this.promptContainer.appendChild(this.promptKey),document.body.appendChild(this.promptContainer),this.progressContainer=document.createElement("div"),this.progressContainer.id="gathering-progress",this.progressContainer.style.cssText=`
      position: fixed;
      bottom: 220px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      z-index: 141;
      pointer-events: none;
    `,this.progressLabel=document.createElement("div"),this.progressLabel.style.cssText=`
      font-family: 'Cinzel', serif;
      font-size: 14px;
      color: #aaffcc;
      text-shadow: 0 0 6px rgba(0, 0, 0, 0.9);
    `,this.progressLabel.textContent="Gathering...",this.progressContainer.appendChild(this.progressLabel),this.progressBarOuter=document.createElement("div"),this.progressBarOuter.style.cssText=`
      width: 160px;
      height: 8px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(100, 200, 150, 0.5);
      border-radius: 4px;
      overflow: hidden;
    `,this.progressBarInner=document.createElement("div"),this.progressBarInner.style.cssText=`
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #44aa66, #66dd88);
      transition: width 0.05s linear;
    `,this.progressBarOuter.appendChild(this.progressBarInner),this.progressContainer.appendChild(this.progressBarOuter),document.body.appendChild(this.progressContainer),this.pickupNotification=document.createElement("div"),this.pickupNotification.id="material-pickup",this.pickupNotification.style.cssText=`
      position: fixed;
      bottom: 260px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      z-index: 142;
      pointer-events: none;
      font-family: 'Cinzel', serif;
      font-size: 15px;
      color: #aaffcc;
      text-shadow: 0 0 8px rgba(0, 0, 0, 0.9);
      opacity: 0;
      transition: opacity 0.3s;
    `,document.body.appendChild(this.pickupNotification)}_seededRandom(e){const t=Math.sin(e*12.9898+78.233)*43758.5453;return t-Math.floor(t)}_chunkKey(e,t){return`${e},${t}`}_worldToChunk(e,t){return{cx:Math.floor(e/this.chunkSize),cz:Math.floor(t/this.chunkSize)}}update(e,t,i){this.playerPosition.set(e,0,t);const{cx:s,cz:n}=this._worldToChunk(e,t);(s!==this.lastPlayerChunkX||n!==this.lastPlayerChunkZ)&&(this.lastPlayerChunkX=s,this.lastPlayerChunkZ=n,this._updateChunks(s,n)),this._updateRespawns(),this._updateInteraction(i)}_updateChunks(e,t){for(let i=-this.loadDistance;i<=this.loadDistance;i++)for(let s=-this.loadDistance;s<=this.loadDistance;s++){const n=e+i,a=t+s,o=this._chunkKey(n,a);this.chunks.has(o)||this._generateChunk(n,a)}for(const[i,s]of this.chunks){const[n,a]=i.split(",").map(Number);Math.max(Math.abs(n-e),Math.abs(a-t))>this.unloadDistance&&this._unloadChunk(i,s)}}_generateChunk(e,t){const i=this._chunkKey(e,t),s={nodes:[],meshes:[]},n=e*73856093+t*19349663,a=e*this.chunkSize+this.chunkSize/2,o=t*this.chunkSize+this.chunkSize/2,r=this.terrain?this.terrain.getBiome(a,o):"plains",c=this._mapBiomeToMaterial(r);let h=0;for(const[d,u]of Object.entries(this.nodesPerChunk)){if(!_d[d.toUpperCase()])continue;const f=this._getNodeCountForBiome(d,c,u);for(let y=0;y<f;y++){const m=n+h*9973;h++;const g=this._seededRandom(m)*this.chunkSize,x=this._seededRandom(m+1)*this.chunkSize,v=e*this.chunkSize+g,b=t*this.chunkSize+x;if(Math.sqrt(v*v+b*b)<this.castleExclusionRadius)continue;const S=this.terrain?this.terrain.getTerrainHeight(v,b):0;if((this.terrain?this.terrain.getTerrainSlope(v,b):0)>this.nodeMaxSlope)continue;const R=this._createNode(d,v,S,b,c,m);R&&(s.nodes.push(R),s.meshes.push(R.mesh),this.activeNodes.push(R))}}this.chunks.set(i,s)}_mapBiomeToMaterial(e){return{plains:be.ANY,forest:be.FOREST,mountains:be.MOUNTAIN,swamp:be.SWAMP,snow:be.SNOW,desert:be.DESERT,hills:be.MOUNTAIN}[e]||be.ANY}_getNodeCountForBiome(e,t,i){const s={ore_vein:{[be.MOUNTAIN]:2,[be.CAVE]:2.5,[be.ANY]:.5},herb_patch:{[be.FOREST]:2,[be.SWAMP]:1.5,[be.ANY]:.8},wood_stump:{[be.FOREST]:2,[be.ANY]:.5},crystal_node:{[be.CAVE]:2,[be.RUINS]:2,[be.MOUNTAIN]:1.2,[be.ANY]:.3}},n=s[e]?.[t]||s[e]?.[be.ANY]||1;return Math.floor(i*n)}_createNode(e,t,i,s,n,a){const o=_d[e.toUpperCase()];if(!o)return null;const r=`node-${t.toFixed(0)}-${s.toFixed(0)}-${a}`;if(this.depletedNodes.has(r))return null;const c={id:r,typeId:e,type:o,position:new T(t,i,s),biome:n,mesh:null,light:null,depleted:!1,respawnTime:0};return c.mesh=this._createNodeMesh(e,a),c.mesh.position.set(t,i,s),c.mesh.userData.gatheringNode=c,this.scene.add(c.mesh),e==="crystal_node"&&(c.light=new We(8956671,.8,6),c.light.position.set(t,i+.5,s),this.scene.add(c.light)),c}_createNodeMesh(e,t){const i=new ne,s=n=>this._seededRandom(t+n);switch(e){case"ore_vein":{for(let n=0;n<3;n++){const a=new w(this.oreVeinGeo,this.oreVeinMat);a.position.set((s(n*10)-.5)*.8,s(n*10+1)*.3,(s(n*10+2)-.5)*.8),a.scale.setScalar(.6+s(n*10+3)*.5),a.rotation.set(s(n*10+4)*Math.PI,s(n*10+5)*Math.PI,s(n*10+6)*Math.PI),i.add(a)}for(let n=0;n<2;n++){const a=new w(new ie(.1,.3,.05),this.oreGlintMat);a.position.set((s(n*20+100)-.5)*.5,.2+s(n*20+101)*.3,(s(n*20+102)-.5)*.5),a.rotation.z=s(n*20+103)*.5,i.add(a)}break}case"herb_patch":{for(let n=0;n<5;n++){const a=new w(this.herbPatchGeo,this.herbMat);a.position.set((s(n*10)-.5)*1,0,(s(n*10+1)-.5)*1),a.scale.setScalar(.7+s(n*10+2)*.5),i.add(a)}for(let n=0;n<2;n++){const a=new w(new re(.08,6,6),this.herbFlowerMat);a.position.set((s(n*20+50)-.5)*.8,.35+s(n*20+51)*.1,(s(n*20+52)-.5)*.8),i.add(a)}break}case"wood_stump":{const n=new w(this.stumpGeo,this.stumpMat);i.add(n);const a=new w(new Zi(.35,8),this.stumpRingsMat);a.rotation.x=-Math.PI/2,a.position.y=.61,i.add(a);for(let o=0;o<2;o++){const r=new w(new re(.06,6,6),new X({color:13404228})),c=s(o*30)*Math.PI*2;r.position.set(Math.cos(c)*.5,.05,Math.sin(c)*.5),i.add(r)}break}case"crystal_node":{for(let n=0;n<4;n++){const a=new w(this.crystalGeo,this.crystalMat.clone());a.position.set((s(n*10)-.5)*.6,.2+s(n*10+1)*.4,(s(n*10+2)-.5)*.6),a.scale.set(.5+s(n*10+3)*.6,.8+s(n*10+4)*.8,.5+s(n*10+5)*.6),a.rotation.set(s(n*10+6)*.3,s(n*10+7)*Math.PI*2,s(n*10+8)*.3),i.add(a)}break}}return i}_unloadChunk(e,t){for(const i of t.meshes)this.scene.remove(i);for(const i of t.nodes){i.light&&this.scene.remove(i.light);const s=this.activeNodes.indexOf(i);s!==-1&&this.activeNodes.splice(s,1)}this.chunks.delete(e)}_updateRespawns(){const e=Date.now();for(const[t,i]of this.depletedNodes)e>=i&&this.depletedNodes.delete(t)}_depleteNode(e){e.depleted=!0;const t=(e.type.respawnTime||180)*1e3,i=Date.now()+t;this.depletedNodes.set(e.id,i);const s=e.mesh,n=.5;let a=0;const o=()=>{a+=.016;const r=Math.min(a/n,1);if(s.scale.setScalar(1-r),s.position.y=e.position.y-r*.3,r<1)requestAnimationFrame(o);else{this.scene.remove(s),e.light&&this.scene.remove(e.light);const c=this.activeNodes.indexOf(e);c!==-1&&this.activeNodes.splice(c,1)}};o()}_updateInteraction(e){if(this.nearbyNode=this._findNearbyNode(),this.nearbyNode&&!this.isGathering?this._showPrompt(this.nearbyNode):this.isGathering||this._hidePrompt(),this.input&&this.input.keys){const t=this.input.keys.KeyE||this.input.keys.e;t&&this.nearbyNode&&!this.isGathering?this._startGathering(this.nearbyNode):t&&this.isGathering?this._continueGathering(e):!t&&this.isGathering&&this._cancelGathering()}}_findNearbyNode(){let e=null,t=2.5;for(const i of this.activeNodes){if(i.depleted)continue;const s=this.playerPosition.distanceTo(i.position);s<t&&(t=s,e=i)}return e}_showPrompt(e){this.promptName.textContent=e.type.name,this.promptContainer.style.display="flex"}_hidePrompt(){this.promptContainer.style.display="none"}_startGathering(e){this.isGathering=!0,this.gatherProgress=0,this.gatherTarget=e,this._hidePrompt(),this.progressLabel.textContent=`Gathering ${e.type.name}...`,this.progressContainer.style.display="flex",this.audio&&this.audio.play("menuHover",{volume:.3})}_continueGathering(e){if(!this.gatherTarget)return;const t=this.gatherTarget.type.gatherTime||2;this.gatherProgress+=e;const i=Math.min(this.gatherProgress/t,1);this.progressBarInner.style.width=`${i*100}%`,Math.random()<.2&&this.particles&&this._spawnGatherParticle(this.gatherTarget),this.gatherProgress>=t&&this._completeGathering(),this.playerPosition.distanceTo(this.gatherTarget.position)>3&&this._cancelGathering()}_cancelGathering(){this.isGathering=!1,this.gatherProgress=0,this.gatherTarget=null,this.progressContainer.style.display="none"}_completeGathering(){const e=this.gatherTarget;this.isGathering=!1,this.gatherProgress=0,this.gatherTarget=null,this.progressContainer.style.display="none";const t=$1(e.typeId.toUpperCase(),e.biome,0),i=[];for(const s of t){const n=On(s.materialId);n&&(this._addMaterialToInventory(s.materialId,s.quantity),i.push(`+${s.quantity} ${n.name}`))}i.length>0&&this._showPickupNotification(i.join(`
`)),this.audio&&this.audio.play("itemPickup",{volume:.5}),this._spawnCompletionParticles(e),this._depleteNode(e)}_addMaterialToInventory(e,t){if(this.inventory&&this.inventory.addMaterial)this.inventory.addMaterial(e,t);else{const i=JSON.parse(localStorage.getItem("ashen-materials")||"{}");i[e]=(i[e]||0)+t,localStorage.setItem("ashen-materials",JSON.stringify(i))}}_showPickupNotification(e){this.pickupNotification.innerHTML=e.split(`
`).map(t=>`<div style="color:#aaffcc;text-shadow:0 0 6px #44aa66;">${t}</div>`).join(""),this.pickupNotification.style.display="flex",this.pickupNotification.style.opacity="1",setTimeout(()=>{this.pickupNotification.style.opacity="0",setTimeout(()=>{this.pickupNotification.style.display="none"},300)},2e3)}_spawnGatherParticle(e){if(!this.particles)return;const t=e.position.clone();t.y+=.5,t.x+=(Math.random()-.5)*.8,t.z+=(Math.random()-.5)*.8;let i=16777215;switch(e.typeId){case"ore_vein":i=11189196;break;case"herb_patch":i=6750054;break;case"wood_stump":i=11176038;break;case"crystal_node":i=8956671;break}this.particles.spawnSparks&&this.particles.spawnSparks(t,1,i)}_spawnCompletionParticles(e){if(!this.particles)return;const t=e.position.clone();t.y+=.5,this.particles.spawnSparks&&this.particles.spawnSparks(t,8,8978346)}getMaterialCount(e){return this.inventory&&this.inventory.getMaterialCount?this.inventory.getMaterialCount(e):JSON.parse(localStorage.getItem("ashen-materials")||"{}")[e]||0}getAllMaterials(){return this.inventory&&this.inventory.getAllMaterials?this.inventory.getAllMaterials():JSON.parse(localStorage.getItem("ashen-materials")||"{}")}spawnNode(e,t,i,s,n=be.ANY){const a=Date.now();return this._createNode(e,t,i,s,n,a)}getActiveNodes(){return this.activeNodes.filter(e=>!e.depleted).map(e=>({x:e.position.x,z:e.position.z,type:e.typeId,name:e.name||e.typeId}))}dispose(){for(const[e,t]of this.chunks)this._unloadChunk(e,t);this.promptContainer?.parentNode&&this.promptContainer.parentNode.removeChild(this.promptContainer),this.progressContainer?.parentNode&&this.progressContainer.parentNode.removeChild(this.progressContainer),this.pickupNotification?.parentNode&&this.pickupNotification.parentNode.removeChild(this.pickupNotification)}}class GS{constructor(e,t=null){this.gm=e,this.inventoryUI=t,this.unlockedRecipes=new Set,this.isCrafting=!1,this.craftingProgress=0,this.craftingTarget=null,this.craftingQuantity=1,this.craftingTimer=null,this.nearbyStation=null,this.nearbyStationPosition=null,this.stats={totalCrafted:0,recipesCrafted:{}},this.onCraftCallbacks=[],this.onRecipeUnlockCallbacks=[],this.onCraftProgressCallbacks=[],this.onCraftFailCallbacks=[],this._loadState(),this._initializeDefaultRecipes(),console.log(`[CraftingManager] Initialized with ${this.unlockedRecipes.size} unlocked recipes`)}_initializeDefaultRecipes(){Y1().forEach(t=>{this.unlockedRecipes.add(t.id)}),this._saveState()}_loadState(){try{const e=localStorage.getItem("ashen-crafting");if(e){const t=JSON.parse(e);this.unlockedRecipes=new Set(t.unlockedRecipes||[]),this.stats=t.stats||this.stats}}catch(e){console.warn("[CraftingManager] Failed to load saved state:",e)}}_saveState(){try{const e={unlockedRecipes:Array.from(this.unlockedRecipes),stats:this.stats};localStorage.setItem("ashen-crafting",JSON.stringify(e))}catch(e){console.warn("[CraftingManager] Failed to save state:",e)}}isRecipeUnlocked(e){return this.unlockedRecipes.has(e)}unlockRecipe(e,t="unknown"){if(this.unlockedRecipes.has(e))return!1;const i=cn(e);return i?(this.unlockedRecipes.add(e),this._saveState(),this.onRecipeUnlockCallbacks.forEach(s=>s(i,t)),console.log(`[CraftingManager] Unlocked recipe: ${i.name} (via ${t})`),!0):(console.warn(`[CraftingManager] Cannot unlock unknown recipe: ${e}`),!1)}getUnlockedRecipes(){return Array.from(this.unlockedRecipes).map(e=>cn(e)).filter(e=>e!==null)}getUnlockedRecipesByCategory(e){return this.getUnlockedRecipes().filter(t=>t.category.id===e)}getLockedRecipes(){return Object.values(fr).filter(e=>!this.unlockedRecipes.has(e.id))}getMaterialCount(e){return this.gm?.gatheringManager?.getMaterialCount?this.gm.gatheringManager.getMaterialCount(e):JSON.parse(localStorage.getItem("ashen-materials")||"{}")[e]||0}getAllMaterials(){return this.gm?.gatheringManager?.getAllMaterials?this.gm.gatheringManager.getAllMaterials():JSON.parse(localStorage.getItem("ashen-materials")||"{}")}_consumeMaterials(e){const t=JSON.parse(localStorage.getItem("ashen-materials")||"{}");for(const i of e){if((t[i.materialId]||0)<i.qty)return!1;t[i.materialId]-=i.qty,t[i.materialId]<=0&&delete t[i.materialId]}return localStorage.setItem("ashen-materials",JSON.stringify(t)),!0}_addMaterial(e,t){const i=JSON.parse(localStorage.getItem("ashen-materials")||"{}");i[e]=(i[e]||0)+t,localStorage.setItem("ashen-materials",JSON.stringify(i))}_getPlayerLevel(){return this.gm?.player?.level||this.gm?.getPlayerLevel?.()||1}canCraft(e,t=1){const i=cn(e);if(!i)return{canCraft:!1,reason:"Recipe does not exist."};if(!this.isRecipeUnlocked(e))return{canCraft:!1,reason:"Recipe not yet discovered."};const s=this._getPlayerLevel();if(s<i.requiredLevel)return{canCraft:!1,reason:`Requires level ${i.requiredLevel} (you are level ${s}).`};if(i.station&&i.station.id!=="none"&&(!this.nearbyStation||this.nearbyStation.id!==i.station.id))return{canCraft:!1,reason:`Requires a ${i.station.name}.`};const n=this.gm?.timeWeatherGameplay;if(n){const o=n.canCraftTimeLocked(e);if(!o.allowed)return{canCraft:!1,reason:o.reason||"Cannot craft at this time.",timeLocked:!0}}const a=[];for(const o of i.materials){const r=o.qty*t,c=this.getMaterialCount(o.materialId);if(c<r){const h=On(o.materialId);a.push({materialId:o.materialId,name:h?.name||o.materialId,required:r,owned:c,missing:r-c})}}return a.length>0?{canCraft:!1,reason:"Missing required materials.",missingMaterials:a}:{canCraft:!0,reason:"Ready to craft."}}getMaxCraftable(e){const t=cn(e);if(!t)return 0;let i=1/0;for(const s of t.materials){const n=this.getMaterialCount(s.materialId),a=Math.floor(n/s.qty);i=Math.min(i,a)}return i===1/0?0:i}startCraft(e,t=1){if(this.isCrafting)return!1;const i=this.canCraft(e,t);if(!i.canCraft)return this._fireCraftFail(e,i.reason),!1;const s=cn(e);this.isCrafting=!0,this.craftingProgress=0,this.craftingTarget=s,this.craftingQuantity=t;const n=s.craftingTime*t;if(n<=.5)return this._completeCraft(),!0;const a=Date.now(),o=a+n*1e3,r=()=>{if(!this.isCrafting||this.craftingTarget!==s)return;const c=Date.now(),h=(c-a)/1e3;this.craftingProgress=Math.min(h/n,1),this.onCraftProgressCallbacks.forEach(d=>d(s,this.craftingProgress,t)),c>=o?this._completeCraft():this.craftingTimer=requestAnimationFrame(r)};return this.craftingTimer=requestAnimationFrame(r),!0}cancelCraft(){this.isCrafting&&(this.craftingTimer&&(cancelAnimationFrame(this.craftingTimer),this.craftingTimer=null),this.isCrafting=!1,this.craftingProgress=0,this.craftingTarget=null,this.craftingQuantity=1)}_completeCraft(){const e=this.craftingTarget,t=this.craftingQuantity;if(!e){this.cancelCraft();return}const i=this.canCraft(e.id,t);if(!i.canCraft){this._fireCraftFail(e.id,i.reason),this.cancelCraft();return}const s=Q1(e.id,t);if(!this._consumeMaterials(s)){this._fireCraftFail(e.id,"Failed to consume materials."),this.cancelCraft();return}const n=e.result.qty*t,a=e.result.itemId;this._addCraftedItem(e,a,n),this.stats.totalCrafted+=t,this.stats.recipesCrafted[e.id]=(this.stats.recipesCrafted[e.id]||0)+t,this._saveState(),this.onCraftCallbacks.forEach(o=>o(e,a,n)),this.gm?.audioManager&&this.gm.audioManager.play("itemPickup",{volume:.6}),this.isCrafting=!1,this.craftingProgress=0,this.craftingTarget=null,this.craftingQuantity=1,this.craftingTimer&&(cancelAnimationFrame(this.craftingTimer),this.craftingTimer=null),console.log(`[CraftingManager] Crafted ${n}x ${e.name}`)}_addCraftedItem(e,t,i){const s=e.category.id;switch(s){case"potion":if(this.gm?.lootManager?.addConsumable)for(let a=0;a<i;a++)this.gm.lootManager.addConsumable({id:t,name:e.name,description:e.description,type:"potion",effect:this._getItemEffect(e)});else{const a=JSON.parse(localStorage.getItem("ashen-potions")||"{}");a[t]=(a[t]||0)+i,localStorage.setItem("ashen-potions",JSON.stringify(a))}break;case"material":this._addMaterial(t,i);break;case"weapon":case"armor":case"accessory":if(this.gm?.lootManager?.addItem)for(let a=0;a<i;a++)this.gm.lootManager.addItem({id:t,name:e.name,description:e.description,type:s,rarity:e.rarity,stats:e.resultStats||{}});else{const a=JSON.parse(localStorage.getItem("ashen-crafted-equipment")||"[]");for(let o=0;o<i;o++)a.push({id:`${t}-${Date.now()}-${o}`,recipeId:e.id,name:e.name,type:s,rarity:e.rarity,stats:e.resultStats||{}});localStorage.setItem("ashen-crafted-equipment",JSON.stringify(a))}break;case"upgrade":const n=JSON.parse(localStorage.getItem("ashen-upgrades")||"{}");n[t]=(n[t]||0)+i,localStorage.setItem("ashen-upgrades",JSON.stringify(n));break;default:console.warn(`[CraftingManager] Unknown item category: ${s}`)}}_getItemEffect(e){const t=e.name.toLowerCase();return t.includes("health")?{type:"heal",value:50}:t.includes("mana")?{type:"mana",value:40}:t.includes("stamina")?{type:"stamina",value:100}:t.includes("strength")?{type:"buff",stat:"strength",value:5,duration:90}:t.includes("speed")?{type:"buff",stat:"speed",value:.3,duration:45}:t.includes("fire resist")?{type:"buff",stat:"fireResist",value:.5,duration:60}:t.includes("antidote")?{type:"cure",ailment:"poison"}:{type:"unknown"}}_fireCraftFail(e,t){this.onCraftFailCallbacks.forEach(i=>i(e,t)),this.gm?.audioManager&&this.gm.audioManager.play("menuBack",{volume:.5})}setNearbyStation(e,t=null){this.nearbyStation=e,this.nearbyStationPosition=t}clearNearbyStation(){this.nearbyStation=null,this.nearbyStationPosition=null}getNearbyStation(){return this.nearbyStation}isNearStation(){return this.nearbyStation!==null}isNearStationType(e){return this.nearbyStation?.id===e}handleRecipeScroll(e){return this.unlockRecipe(e,"scroll")}handleNPCTeach(e,t="merchant"){return this.unlockRecipe(e,`npc:${t}`)}handleBossDropRecipe(e,t){return this.unlockRecipe(e,`boss:${t}`)}handleExplorationDiscovery(e,t="unknown"){return this.unlockRecipe(e,`exploration:${t}`)}onCraft(e){return this.onCraftCallbacks.push(e),()=>{const t=this.onCraftCallbacks.indexOf(e);t!==-1&&this.onCraftCallbacks.splice(t,1)}}onRecipeUnlock(e){return this.onRecipeUnlockCallbacks.push(e),()=>{const t=this.onRecipeUnlockCallbacks.indexOf(e);t!==-1&&this.onRecipeUnlockCallbacks.splice(t,1)}}onCraftProgress(e){return this.onCraftProgressCallbacks.push(e),()=>{const t=this.onCraftProgressCallbacks.indexOf(e);t!==-1&&this.onCraftProgressCallbacks.splice(t,1)}}onCraftFail(e){return this.onCraftFailCallbacks.push(e),()=>{const t=this.onCraftFailCallbacks.indexOf(e);t!==-1&&this.onCraftFailCallbacks.splice(t,1)}}getRecipeMaterialInfo(e){const t=cn(e);return t?t.materials.map(i=>{const s=On(i.materialId),n=this.getMaterialCount(i.materialId);return{materialId:i.materialId,name:s?.name||i.materialId,required:i.qty,owned:n,sufficient:n>=i.qty,iconColor:s?.iconColor||8947848,rarity:s?.rarity?.id||"common"}}):null}getStats(){return{...this.stats}}resetProgress(){this.unlockedRecipes.clear(),this.stats={totalCrafted:0,recipesCrafted:{}},this.cancelCraft(),this._initializeDefaultRecipes(),this._saveState(),console.log("[CraftingManager] Progress reset")}dispose(){this.cancelCraft(),this.onCraftCallbacks=[],this.onRecipeUnlockCallbacks=[],this.onCraftProgressCallbacks=[],this.onCraftFailCallbacks=[]}}class HS{constructor(e,t,i){this.gm=e,this.craftingManager=t,this.inputManager=i,this.isOpen=!1,this.activeCategory="all",this.selectedRecipe=null,this.searchQuery="",this.craftQuantity=1,this.container=null,this.tooltipEl=null,this._onCraftComplete=this._onCraftComplete.bind(this),this._onCraftProgress=this._onCraftProgress.bind(this),this._onCraftFail=this._onCraftFail.bind(this),this._onRecipeUnlock=this._onRecipeUnlock.bind(this),this.createUI(),this.createStyles(),this.registerCallbacks(),console.log("[CraftingUI] Initialized")}registerCallbacks(){this.craftingManager&&(this.craftingManager.onCraft(this._onCraftComplete),this.craftingManager.onCraftProgress(this._onCraftProgress),this.craftingManager.onCraftFail(this._onCraftFail),this.craftingManager.onRecipeUnlock(this._onRecipeUnlock))}_onCraftComplete(e,t,i){this.isOpen&&(this.render(),this._showNotification(`Crafted ${i}x ${e.name}!`,"success"))}_onCraftProgress(e,t,i){const s=this.container?.querySelector(".craft-progress-fill");s&&(s.style.width=`${t*100}%`);const n=this.container?.querySelector(".craft-progress-text");n&&(n.textContent=`Crafting... ${Math.floor(t*100)}%`)}_onCraftFail(e,t){this._showNotification(t,"error")}_onRecipeUnlock(e,t){this._showNotification(`New recipe discovered: ${e.name}!`,"unlock"),this.isOpen&&this.render()}_showNotification(e,t="info"){const i=document.createElement("div");i.className=`crafting-notification ${t}`,i.textContent=e,i.style.cssText=`
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: ${t==="success"?"rgba(50, 120, 50, 0.95)":t==="error"?"rgba(120, 50, 50, 0.95)":t==="unlock"?"rgba(150, 120, 50, 0.95)":"rgba(50, 50, 80, 0.95)"};
      border: 1px solid ${t==="success"?"rgba(100, 200, 100, 0.5)":t==="error"?"rgba(200, 100, 100, 0.5)":t==="unlock"?"rgba(255, 200, 100, 0.5)":"rgba(100, 100, 150, 0.5)"};
      padding: 12px 24px;
      border-radius: 4px;
      color: #fff;
      font-family: 'Cinzel', 'Georgia', serif;
      font-size: 14px;
      z-index: 4000;
      animation: craftNotifyFade 2s ease-out forwards;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    `,document.body.appendChild(i),setTimeout(()=>i.remove(),2e3)}createUI(){this.container=document.createElement("div"),this.container.id="crafting-ui",this.container.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 900px;
      max-height: 85vh;
      background: linear-gradient(145deg, rgba(15, 15, 20, 0.97), rgba(8, 8, 12, 0.99));
      border: 2px solid rgba(200, 170, 100, 0.4);
      border-radius: 6px;
      padding: 0;
      color: #ddd;
      font-family: 'Cinzel', 'Georgia', serif;
      display: none;
      z-index: 2000;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.9), inset 0 0 80px rgba(0, 0, 0, 0.4);
      overflow: hidden;
    `,document.body.appendChild(this.container),this.tooltipEl=document.createElement("div"),this.tooltipEl.id="crafting-tooltip",this.tooltipEl.style.cssText=`
      position: fixed;
      background: rgba(10, 10, 15, 0.98);
      border: 1px solid rgba(200, 170, 100, 0.5);
      border-radius: 4px;
      padding: 12px 16px;
      color: #ccc;
      font-family: 'Cinzel', 'Georgia', serif;
      font-size: 13px;
      max-width: 320px;
      z-index: 3000;
      pointer-events: none;
      display: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
    `,document.body.appendChild(this.tooltipEl)}createStyles(){if(document.getElementById("crafting-ui-styles"))return;const e=document.createElement("style");e.id="crafting-ui-styles",e.textContent=`
      @keyframes craftNotifyFade {
        0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
        10% { opacity: 1; transform: translateX(-50%) translateY(0); }
        80% { opacity: 1; }
        100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
      }
      
      @keyframes craftPulse {
        0%, 100% { box-shadow: 0 0 5px rgba(255, 200, 100, 0.3); }
        50% { box-shadow: 0 0 15px rgba(255, 200, 100, 0.6); }
      }
      
      #crafting-ui .cat-tab {
        background: rgba(30, 30, 40, 0.8);
        border: none;
        border-bottom: 2px solid transparent;
        color: #888;
        padding: 10px 16px;
        font-family: 'Cinzel', 'Georgia', serif;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
      }
      
      #crafting-ui .cat-tab:hover {
        color: #ccc;
        background: rgba(50, 50, 60, 0.8);
      }
      
      #crafting-ui .cat-tab.active {
        color: #ffc864;
        border-bottom-color: #ffc864;
        background: rgba(40, 35, 30, 0.8);
      }
      
      #crafting-ui .recipe-item {
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(80, 80, 80, 0.3);
        border-radius: 4px;
        margin-bottom: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      
      #crafting-ui .recipe-item:hover {
        border-color: rgba(200, 170, 100, 0.5);
        background: rgba(40, 35, 30, 0.4);
      }
      
      #crafting-ui .recipe-item.selected {
        border-color: rgba(255, 200, 100, 0.6);
        background: rgba(50, 45, 35, 0.5);
        box-shadow: 0 0 10px rgba(255, 200, 100, 0.15);
      }
      
      #crafting-ui .recipe-item.locked {
        opacity: 0.5;
        border-style: dashed;
      }
      
      #crafting-ui .recipe-item.can-craft {
        border-left: 3px solid rgba(100, 200, 100, 0.6);
      }
      
      #crafting-ui .recipe-item.cannot-craft {
        border-left: 3px solid rgba(200, 100, 100, 0.4);
      }
      
      #crafting-ui .material-row {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
        margin-bottom: 4px;
      }
      
      #crafting-ui .material-row.sufficient {
        border-left: 3px solid rgba(100, 200, 100, 0.6);
      }
      
      #crafting-ui .material-row.insufficient {
        border-left: 3px solid rgba(200, 100, 100, 0.6);
      }
      
      #crafting-ui .craft-btn {
        padding: 12px 24px;
        border: 1px solid rgba(200, 170, 100, 0.5);
        border-radius: 4px;
        background: linear-gradient(180deg, rgba(80, 70, 50, 0.8), rgba(60, 50, 35, 0.9));
        color: #ffc864;
        font-family: 'Cinzel', 'Georgia', serif;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      
      #crafting-ui .craft-btn:hover:not(:disabled) {
        background: linear-gradient(180deg, rgba(100, 90, 60, 0.9), rgba(80, 70, 50, 0.95));
        box-shadow: 0 0 15px rgba(255, 200, 100, 0.3);
        transform: translateY(-1px);
      }
      
      #crafting-ui .craft-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        color: #666;
        border-color: rgba(100, 100, 100, 0.3);
        background: rgba(40, 40, 50, 0.6);
      }
      
      #crafting-ui .craft-btn.crafting {
        animation: craftPulse 1s ease-in-out infinite;
      }
      
      #crafting-ui .search-input {
        width: 100%;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(100, 100, 100, 0.3);
        border-radius: 4px;
        color: #ccc;
        font-family: 'Cinzel', 'Georgia', serif;
        font-size: 12px;
        outline: none;
        transition: border-color 0.2s ease;
      }
      
      #crafting-ui .search-input:focus {
        border-color: rgba(200, 170, 100, 0.5);
      }
      
      #crafting-ui .search-input::placeholder {
        color: #555;
      }
      
      #crafting-ui .qty-btn {
        width: 28px;
        height: 28px;
        background: rgba(50, 50, 60, 0.8);
        border: 1px solid rgba(100, 100, 100, 0.4);
        border-radius: 4px;
        color: #aaa;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      
      #crafting-ui .qty-btn:hover {
        background: rgba(70, 70, 80, 0.9);
        color: #fff;
        border-color: rgba(150, 150, 150, 0.5);
      }
      
      #crafting-ui .qty-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
      
      #crafting-ui .station-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        font-size: 12px;
      }
      
      #crafting-ui .station-indicator.available {
        border: 1px solid rgba(100, 200, 100, 0.4);
        color: #8f8;
      }
      
      #crafting-ui .station-indicator.unavailable {
        border: 1px solid rgba(200, 100, 100, 0.3);
        color: #f88;
      }
      
      #crafting-ui .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 10px;
      }
      
      #crafting-ui .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ffc864, #ffaa44);
        transition: width 0.1s linear;
      }
    `,document.head.appendChild(e)}toggle(){this.isOpen=!this.isOpen,this.container.style.display=this.isOpen?"block":"none",this.tooltipEl.style.display="none",this.isOpen&&this.render()}open(){this.isOpen||(this.isOpen=!0,this.container.style.display="block",this.render())}close(){this.isOpen&&(this.isOpen=!1,this.container.style.display="none",this.tooltipEl.style.display="none")}render(){const e=this.craftingManager?.getNearbyStation(),t=this.craftingManager?.getUnlockedRecipes()||[],i=this.craftingManager?.getLockedRecipes()||[],s=this.getFilteredRecipes(t,i);this.container.innerHTML=`
      <!-- Header -->
      <div style="
        background: linear-gradient(90deg, rgba(40, 35, 25, 0.9), rgba(30, 28, 22, 0.95), rgba(40, 35, 25, 0.9));
        padding: 15px 20px;
        border-bottom: 1px solid rgba(200, 170, 100, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
      ">
        <h2 style="margin: 0; color: #ffc864; font-size: 20px; text-shadow: 0 0 15px rgba(255, 200, 100, 0.4);">
           Crafting
        </h2>
        <div class="station-indicator ${e?"available":"unavailable"}">
          ${e?`
            <span> ${e.name}</span>
          `:`
            <span>No station nearby</span>
          `}
        </div>
      </div>
      
      <!-- Category Tabs -->
      <div style="
        display: flex;
        background: rgba(20, 20, 25, 0.8);
        border-bottom: 1px solid rgba(80, 80, 80, 0.3);
        overflow-x: auto;
      ">
        <button class="cat-tab ${this.activeCategory==="all"?"active":""}" data-category="all">
           All
        </button>
        ${Object.values(Ft).map(n=>`
          <button class="cat-tab ${this.activeCategory===n.id?"active":""}" data-category="${n.id}">
            ${n.icon} ${n.name}
          </button>
        `).join("")}
      </div>
      
      <!-- Main Content -->
      <div style="display: flex; height: calc(85vh - 140px);">
        <!-- Left Panel: Recipe List -->
        <div style="
          width: 320px;
          border-right: 1px solid rgba(80, 80, 80, 0.3);
          display: flex;
          flex-direction: column;
        ">
          <!-- Search Bar -->
          <div style="padding: 12px;">
            <input 
              type="text" 
              class="search-input" 
              placeholder=" Search recipes..." 
              value="${this.searchQuery}"
            >
          </div>
          
          <!-- Recipe List -->
          <div style="flex: 1; overflow-y: auto; padding: 0 12px 12px;">
            ${s.length===0?`
              <div style="color: #555; text-align: center; padding: 20px; font-size: 13px;">
                No recipes found
              </div>
            `:""}
            ${s.map(({recipe:n,isLocked:a})=>this.renderRecipeItem(n,a)).join("")}
          </div>
        </div>
        
        <!-- Right Panel: Recipe Details -->
        <div style="flex: 1; overflow-y: auto; padding: 20px;">
          ${this.selectedRecipe?this.renderRecipeDetails():`
            <div style="
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              height: 100%;
              color: #555;
            ">
              <div style="font-size: 48px; margin-bottom: 15px;"></div>
              <div style="font-size: 14px;">Select a recipe to view details</div>
            </div>
          `}
        </div>
      </div>
      
      <!-- Footer -->
      <div style="
        padding: 10px 20px;
        background: rgba(15, 15, 20, 0.9);
        border-top: 1px solid rgba(80, 80, 80, 0.3);
        text-align: center;
        color: #666;
        font-size: 12px;
      ">
        <span style="color: #ffc864;">[C]</span> Close  
        <span style="color: #ffc864;">[Click]</span> Select Recipe  
        <span style="color: #8f8;">Green</span> = Craftable  
        <span style="color: #f88;">Red</span> = Missing Materials
      </div>
    `,this.attachEventListeners()}getFilteredRecipes(e,t){const i=[];for(const s of e)this.matchesFilter(s)&&i.push({recipe:s,isLocked:!1});for(const s of t)this.matchesFilter(s)&&i.push({recipe:s,isLocked:!0});return i.sort((s,n)=>{if(s.isLocked!==n.isLocked)return s.isLocked?1:-1;const a=!s.isLocked&&this.craftingManager?.canCraft(s.recipe.id).canCraft,o=!n.isLocked&&this.craftingManager?.canCraft(n.recipe.id).canCraft;return a!==o?a?-1:1:s.recipe.name.localeCompare(n.recipe.name)}),i}matchesFilter(e){if(this.activeCategory!=="all"&&e.category.id!==this.activeCategory)return!1;if(this.searchQuery){const t=this.searchQuery.toLowerCase();return e.name.toLowerCase().includes(t)||e.description?.toLowerCase().includes(t)}return!0}renderRecipeItem(e,t){const i=this.selectedRecipe?.id===e.id,n=(t?{canCraft:!1}:this.craftingManager?.canCraft(e.id))?.canCraft,a=ef(e.id);return t?`
        <div class="recipe-item locked" data-recipe-id="${e.id}" data-locked="true">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="color: #666; font-size: 13px;">??? Unknown Recipe ???</div>
              <div style="color: #444; font-size: 11px; margin-top: 4px;">
                ${this.getUnlockHint(e.unlockMethod)}
              </div>
            </div>
            <span style="color: #555; font-size: 16px;"></span>
          </div>
        </div>
      `:`
      <div class="recipe-item ${i?"selected":""} ${n?"can-craft":"cannot-craft"}" 
           data-recipe-id="${e.id}">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div style="color: ${a}; font-size: 13px;">
              ${e.category.icon} ${e.name}
            </div>
            <div style="color: #666; font-size: 11px; margin-top: 3px;">
              ${e.category.name}  Lv.${e.requiredLevel}
              ${e.station?.id!=="none"?`  ${e.station.name}`:""}
            </div>
          </div>
          <span style="color: ${n?"#8f8":"#f88"}; font-size: 10px;">
            ${n?" Ready":""}
          </span>
        </div>
      </div>
    `}getUnlockHint(e){switch(e){case Mt.FOUND_IN_CHEST:return"Found in treasure chests";case Mt.BOUGHT_FROM_NPC:return"Sold by merchants";case Mt.BOSS_DROP:return"Dropped by a powerful foe";case Mt.EXPLORATION:return"Discovered through exploration";case Mt.QUEST_REWARD:return"Quest reward";case Mt.LEVEL_UP:return"Unlocks at higher level";default:return"Unknown source"}}renderRecipeDetails(){const e=this.selectedRecipe;if(!e)return"";const t=!this.craftingManager?.isRecipeUnlocked(e.id),i=this.craftingManager?.canCraft(e.id,this.craftQuantity),s=i?.canCraft,n=this.craftingManager?.getMaxCraftable(e.id)||0,a=this.craftingManager?.getRecipeMaterialInfo(e.id)||[],o=ef(e.id),r=this.craftingManager?.getNearbyStation(),c=this.craftingManager?.isCrafting,h=e.station?.id!=="none",d=!h||r?.id===e.station?.id;return t?`
        <div style="text-align: center; padding: 40px;">
          <div style="font-size: 48px; margin-bottom: 20px;"></div>
          <div style="color: #888; font-size: 16px; margin-bottom: 10px;">Recipe Locked</div>
          <div style="color: #666; font-size: 13px;">
            ${this.getUnlockHint(e.unlockMethod)}
          </div>
        </div>
      `:`
      <!-- Recipe Header -->
      <div style="margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
          <span style="font-size: 28px;">${e.category.icon}</span>
          <div>
            <h3 style="margin: 0; color: ${o}; font-size: 18px;">${e.name}</h3>
            <div style="color: #888; font-size: 12px;">
              ${e.rarity?.name||"Common"} ${e.category.name}  Level ${e.requiredLevel}
            </div>
          </div>
        </div>
        <p style="color: #aaa; font-size: 13px; margin: 10px 0; line-height: 1.5;">
          ${e.description||"No description available."}
        </p>
      </div>
      
      <!-- Station Requirement -->
      ${h?`
        <div style="
          padding: 10px 14px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid ${d?"rgba(100, 200, 100, 0.3)":"rgba(200, 100, 100, 0.3)"};
          border-radius: 4px;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          gap: 10px;
        ">
          <span style="font-size: 16px;"></span>
          <div>
            <div style="color: ${d?"#8f8":"#f88"}; font-size: 12px;">
              Requires: ${e.station.name}
            </div>
            ${d?"":`
              <div style="color: #666; font-size: 11px; margin-top: 2px;">
                Find a ${e.station.name.toLowerCase()} to craft this item
              </div>
            `}
          </div>
          <span style="margin-left: auto; color: ${d?"#8f8":"#f88"};">
            ${d?"":""}
          </span>
        </div>
      `:""}
      
      <!-- Materials Required -->
      <div style="margin-bottom: 20px;">
        <h4 style="color: #ffc864; font-size: 13px; margin: 0 0 10px 0;">
          Materials Required ${this.craftQuantity>1?`(${this.craftQuantity})`:""}
        </h4>
        ${a.map(u=>{const p=u.required*this.craftQuantity,f=u.owned>=p;On(u.materialId);const y="#"+(u.iconColor||8947848).toString(16).padStart(6,"0");return`
            <div class="material-row ${f?"sufficient":"insufficient"}">
              <div style="
                width: 24px;
                height: 24px;
                background: radial-gradient(circle at 30% 30%, ${y}, ${y}66);
                border-radius: 4px;
                margin-right: 10px;
              "></div>
              <div style="flex: 1;">
                <div style="color: ${y}; font-size: 12px;">${u.name}</div>
                <div style="color: #666; font-size: 10px; text-transform: capitalize;">${u.rarity}</div>
              </div>
              <div style="text-align: right;">
                <span style="color: ${f?"#8f8":"#f88"};">${u.owned}</span>
                <span style="color: #666;"> / ${p}</span>
              </div>
            </div>
          `}).join("")}
      </div>
      
      <!-- Result Preview -->
      <div style="margin-bottom: 20px;">
        <h4 style="color: #ffc864; font-size: 13px; margin: 0 0 10px 0;">Result</h4>
        <div style="
          padding: 12px;
          background: rgba(40, 35, 25, 0.4);
          border: 1px solid rgba(200, 170, 100, 0.3);
          border-radius: 4px;
        ">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">${e.category.icon}</span>
            <div>
              <div style="color: ${o}; font-size: 14px;">
                ${e.result.qty*this.craftQuantity} ${e.name}
              </div>
              ${e.resultStats?`
                <div style="color: #8f8; font-size: 11px; margin-top: 4px;">
                  ${Object.entries(e.resultStats).map(([u,p])=>`+${p} ${this.formatStatName(u)}`).join("  ")}
                </div>
              `:""}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Crafting Time -->
      <div style="color: #888; font-size: 12px; margin-bottom: 15px;">
         Crafting time: ${(e.craftingTime*this.craftQuantity).toFixed(1)}s
      </div>
      
      <!-- Quantity Selector -->
      <div style="
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      ">
        <span style="color: #aaa; font-size: 12px;">Quantity:</span>
        <button class="qty-btn" data-qty-action="decrease" ${this.craftQuantity<=1?"disabled":""}></button>
        <span style="color: #fff; font-size: 16px; min-width: 40px; text-align: center;">
          ${this.craftQuantity}
        </span>
        <button class="qty-btn" data-qty-action="increase" ${this.craftQuantity>=n?"disabled":""}>+</button>
        <button class="qty-btn" data-qty-action="max" style="width: auto; padding: 0 10px; font-size: 11px;"
                ${n<=0?"disabled":""}>
          Max (${n})
        </button>
      </div>
      
      <!-- Craft Button -->
      <div style="text-align: center;">
        <button 
          class="craft-btn ${c?"crafting":""}" 
          ${!s||c?"disabled":""}
        >
          ${c?"Crafting...":`Craft ${this.craftQuantity>1?`(${this.craftQuantity})`:""}`}
        </button>
        
        ${!s&&i?.reason?`
          <div style="color: #f88; font-size: 11px; margin-top: 10px;">
            ${i.reason}
          </div>
        `:""}
        
        ${c?`
          <div class="progress-bar" style="margin-top: 15px;">
            <div class="progress-fill craft-progress-fill" style="width: 0%;"></div>
          </div>
          <div class="craft-progress-text" style="color: #888; font-size: 11px; margin-top: 5px;">
            Crafting... 0%
          </div>
        `:""}
      </div>
    `}formatStatName(e){return{damage:"DMG",defense:"DEF",health:"HP",stamina:"STA",mana:"MP",critChance:"CRIT%",critDamage:"CRIT DMG",attackSpeed:"ATK SPD",healthRegen:"HP/s",staminaRegen:"STA REG",strength:"STR",intelligence:"INT",dexterity:"DEX"}[e]||e.toUpperCase()}attachEventListeners(){window.craftingUI=this,this.container.querySelectorAll(".cat-tab").forEach(i=>{i.addEventListener("click",()=>{this.activeCategory=i.dataset.category,this.selectedRecipe=null,this.craftQuantity=1,this.render()})});const e=this.container.querySelector(".search-input");e&&e.addEventListener("input",i=>{this.searchQuery=i.target.value,this.render();const s=this.container.querySelector(".search-input");s&&(s.focus(),s.setSelectionRange(this.searchQuery.length,this.searchQuery.length))}),this.container.querySelectorAll(".recipe-item").forEach(i=>{i.addEventListener("click",()=>{const s=i.dataset.recipeId;if(i.dataset.locked==="true"){this._showNotification("Recipe not yet discovered!","error");return}this.selectedRecipe=cn(s),this.craftQuantity=1,this.render()})}),this.container.querySelectorAll(".qty-btn").forEach(i=>{i.addEventListener("click",()=>{const s=i.dataset.qtyAction,n=this.craftingManager?.getMaxCraftable(this.selectedRecipe?.id)||1;switch(s){case"decrease":this.craftQuantity=Math.max(1,this.craftQuantity-1);break;case"increase":this.craftQuantity=Math.min(n,this.craftQuantity+1);break;case"max":this.craftQuantity=Math.max(1,n);break}this.render()})});const t=this.container.querySelector(".craft-btn");t&&t.addEventListener("click",()=>{if(!this.selectedRecipe||this.craftingManager?.isCrafting)return;this.craftingManager.startCraft(this.selectedRecipe.id,this.craftQuantity)&&this.render()})}showTooltip(e,t){const i=On(t);if(!i)return;const s="#"+(i.iconColor||8947848).toString(16).padStart(6,"0");this.tooltipEl.innerHTML=`
      <div style="color: ${s}; font-weight: bold; margin-bottom: 4px;">${i.name}</div>
      <div style="color: #888; font-size: 11px; text-transform: capitalize;">${i.rarity?.name||"Common"} ${i.category?.name||"Material"}</div>
      <div style="margin-top: 8px; color: #aaa; line-height: 1.4;">${i.description||""}</div>
    `,this.tooltipEl.style.display="block",this.positionTooltip(e)}positionTooltip(e){const t=e.clientX+15,i=e.clientY+10,s=window.innerWidth-340,n=window.innerHeight-200;this.tooltipEl.style.left=Math.min(t,s)+"px",this.tooltipEl.style.top=Math.min(i,n)+"px"}hideTooltip(){this.tooltipEl.style.display="none"}update(){this.inputManager?.craftingToggle&&(this.toggle(),this.inputManager.craftingToggle=!1),this.isOpen&&this.inputManager?.escape&&this.close()}dispose(){this.container&&this.container.remove(),this.tooltipEl&&this.tooltipEl.remove(),window.craftingUI=null}}const dt={NIGHT:"night",DAWN:"dawn",DAY:"day",DUSK:"dusk"},Zt={DAWN_START:5,DAY_START:7,DUSK_START:18,NIGHT_START:20};class qS{constructor(e){this.scene=e,this.currentHour=10,this.currentMinute=0,this.currentDay=1,this.dayPhase=dt.DAY,this.moonPhase=4,this.moonCycleLength=8,this.timeScale=1,this.accumulator=0,this.isPaused=!1,this.onHourChange=null,this.onPhaseChange=null,this.onDayChange=null,this.onMinuteChange=null,this.sunLight=null,this.sunMesh=null,this.moonLight=null,this.moonMesh=null,this.sunDistance=80,this.moonDistance=70,this.celestialTilt=.15,this.clockElement=null,this.createClockUI(),this.load()}createClockUI(){if(document.getElementById("time-clock")){this.clockElement=document.getElementById("time-clock");return}const e=document.createElement("div");e.id="time-clock",e.innerHTML=`
      <div class="clock-face">
        <span class="clock-time">10:00</span>
        <span class="clock-phase"></span>
      </div>
      <div class="clock-day">Day 1</div>
    `;const t=document.createElement("style");t.textContent=`
      #time-clock {
        position: fixed;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, rgba(20, 15, 10, 0.9), rgba(40, 30, 20, 0.85));
        border: 2px solid rgba(180, 140, 80, 0.6);
        border-radius: 8px;
        padding: 8px 14px;
        font-family: 'Cinzel', 'Times New Roman', serif;
        color: #e8d5b0;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        z-index: 100;
        user-select: none;
        min-width: 85px;
        text-align: center;
        transition: opacity 0.3s, transform 0.3s;
      }
      
      #time-clock:hover {
        transform: scale(1.05);
        border-color: rgba(200, 160, 100, 0.8);
      }
      
      #time-clock .clock-face {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 18px;
        font-weight: bold;
      }
      
      #time-clock .clock-time {
        letter-spacing: 1px;
      }
      
      #time-clock .clock-phase {
        font-size: 16px;
        filter: drop-shadow(0 0 4px rgba(255, 200, 100, 0.5));
      }
      
      #time-clock .clock-day {
        font-size: 11px;
        color: rgba(200, 180, 140, 0.8);
        margin-top: 4px;
        letter-spacing: 0.5px;
      }
      
      /* Phase-specific styles */
      #time-clock.phase-night {
        background: linear-gradient(135deg, rgba(10, 10, 25, 0.95), rgba(20, 20, 45, 0.9));
        border-color: rgba(100, 120, 180, 0.6);
        color: #b0c4de;
      }
      
      #time-clock.phase-dawn {
        background: linear-gradient(135deg, rgba(60, 40, 30, 0.9), rgba(100, 60, 40, 0.85));
        border-color: rgba(220, 160, 100, 0.7);
        color: #ffd4a0;
      }
      
      #time-clock.phase-dusk {
        background: linear-gradient(135deg, rgba(50, 30, 50, 0.9), rgba(80, 40, 60, 0.85));
        border-color: rgba(180, 100, 140, 0.7);
        color: #ffb8d0;
      }
    `,document.head.appendChild(t),document.body.appendChild(e),this.clockElement=e,this.updateClockUI()}updateClockUI(){if(!this.clockElement)return;const e=`${String(this.currentHour).padStart(2,"0")}:${String(this.currentMinute).padStart(2,"0")}`,t=this.getPhaseEmoji(),i=this.clockElement.querySelector(".clock-time"),s=this.clockElement.querySelector(".clock-phase"),n=this.clockElement.querySelector(".clock-day");i&&(i.textContent=e),s&&(s.textContent=t),n&&(n.textContent=`Day ${this.currentDay}`),this.clockElement.className="",this.clockElement.id="time-clock",this.clockElement.classList.add(`phase-${this.dayPhase}`)}getPhaseEmoji(){switch(this.dayPhase){case dt.DAWN:return"";case dt.DAY:return"";case dt.DUSK:return"";case dt.NIGHT:return this.getMoonEmoji();default:return""}}getMoonEmoji(){return["","","","","","","",""][this.moonPhase%8]}calculatePhase(e){return e>=Zt.NIGHT_START||e<Zt.DAWN_START?dt.NIGHT:e>=Zt.DAWN_START&&e<Zt.DAY_START?dt.DAWN:e>=Zt.DAY_START&&e<Zt.DUSK_START?dt.DAY:dt.DUSK}getPhaseProgress(){const e=this.currentHour+this.currentMinute/60;switch(this.dayPhase){case dt.DAWN:return(e-Zt.DAWN_START)/(Zt.DAY_START-Zt.DAWN_START);case dt.DAY:return(e-Zt.DAY_START)/(Zt.DUSK_START-Zt.DAY_START);case dt.DUSK:return(e-Zt.DUSK_START)/(Zt.NIGHT_START-Zt.DUSK_START);case dt.NIGHT:return e>=Zt.NIGHT_START?(e-Zt.NIGHT_START)/(24-Zt.NIGHT_START+Zt.DAWN_START):(24-Zt.NIGHT_START+e)/(24-Zt.NIGHT_START+Zt.DAWN_START);default:return 0}}getSunAngle(){const e=this.currentHour+this.currentMinute/60;return e>=6&&e<=18?(e-6)/12*Math.PI:e>18?Math.PI+(e-18)/12*Math.PI:Math.PI+(e+6)/12*Math.PI}getMoonAngle(){const e=this.getSunAngle(),t=this.moonPhase/this.moonCycleLength*Math.PI*.5;return e+Math.PI+t}getSunPosition(){const e=this.getSunAngle(),t=Math.cos(e)*this.sunDistance,i=Math.sin(e)*this.sunDistance,s=this.currentHour/24*Math.PI*2,n=Math.sin(s)*this.sunDistance*this.celestialTilt;return new T(t,Math.max(i,-20),n)}getMoonPosition(){const e=this.getMoonAngle(),t=Math.cos(e)*this.moonDistance,i=Math.sin(e)*this.moonDistance,s=this.currentHour/24*Math.PI*2,n=-Math.sin(s)*this.moonDistance*this.celestialTilt;return new T(t,Math.max(i,-15),n)}getNormalizedTime(){return(this.currentHour+this.currentMinute/60)/24}isDaytime(){return this.dayPhase===dt.DAY||this.dayPhase===dt.DAWN||this.dayPhase===dt.DUSK}isNighttime(){return this.dayPhase===dt.NIGHT}getMoonBrightness(){const e=this.moonCycleLength/2;return .1+(1-Math.abs(this.moonPhase-e)/e)*.9}setSunLight(e,t=null){this.sunLight=e,this.sunMesh=t,this.updateCelestialPositions()}setMoonLight(e,t=null){this.moonLight=e,this.moonMesh=t,this.updateCelestialPositions()}updateCelestialPositions(){const e=this.getSunPosition(),t=this.getMoonPosition();this.sunLight&&(this.sunLight.position.copy(e),this.sunLight.target.position.set(0,0,0),this.sunLight.target.updateMatrixWorld&&this.sunLight.target.updateMatrixWorld()),this.sunMesh&&(this.sunMesh.position.copy(e),this.sunMesh.visible=e.y>-10),this.moonLight&&(this.moonLight.position.copy(t),this.moonLight.target.position.set(0,0,0),this.moonLight.target.updateMatrixWorld&&this.moonLight.target.updateMatrixWorld()),this.moonMesh&&(this.moonMesh.position.copy(t),this.moonMesh.visible=t.y>-10)}pause(){this.isPaused=!0}resume(){this.isPaused=!1}setTime(e,t=0){const i=this.dayPhase,s=this.currentHour;this.currentHour=Math.floor(e)%24,this.currentMinute=Math.floor(t)%60,this.dayPhase=this.calculatePhase(this.currentHour),this.currentHour!==s&&this.onHourChange&&this.onHourChange(this.currentHour),this.dayPhase!==i&&this.onPhaseChange&&this.onPhaseChange(this.dayPhase,i),this.updateCelestialPositions(),this.updateClockUI()}skipToNextPhase(){switch(this.dayPhase){case dt.NIGHT:this.setTime(Zt.DAWN_START);break;case dt.DAWN:this.setTime(Zt.DAY_START);break;case dt.DAY:this.setTime(Zt.DUSK_START);break;case dt.DUSK:this.setTime(Zt.NIGHT_START);break}}setTimeScale(e){this.timeScale=Math.max(0,e)}update(e){if(!(this.isPaused||this.timeScale<=0)){for(this.accumulator+=e*this.timeScale;this.accumulator>=1;)this.accumulator-=1,this.advanceMinute();this.updateCelestialPositions()}}advanceMinute(){this.currentMinute,this.currentHour;const e=this.dayPhase;if(this.currentMinute++,this.currentMinute>=60){this.currentMinute=0,this.currentHour++,this.currentHour>=24&&(this.currentHour=0,this.advanceDay()),this.onHourChange&&this.onHourChange(this.currentHour);const t=this.calculatePhase(this.currentHour);t!==this.dayPhase&&(this.dayPhase=t,this.onPhaseChange&&this.onPhaseChange(this.dayPhase,e))}this.onMinuteChange&&this.onMinuteChange(this.currentMinute),this.updateClockUI()}advanceDay(){this.currentDay++,this.moonPhase=(this.moonPhase+1)%this.moonCycleLength,this.onDayChange&&this.onDayChange(this.currentDay)}save(){const e={hour:this.currentHour,minute:this.currentMinute,day:this.currentDay,moonPhase:this.moonPhase};localStorage.setItem("ashen-time",JSON.stringify(e))}load(){try{const e=localStorage.getItem("ashen-time");if(e){const t=JSON.parse(e);this.currentHour=t.hour??10,this.currentMinute=t.minute??0,this.currentDay=t.day??1,this.moonPhase=t.moonPhase??4,this.dayPhase=this.calculatePhase(this.currentHour),this.updateClockUI(),console.log(`[TimeManager] Loaded time: Day ${this.currentDay}, ${this.currentHour}:${String(this.currentMinute).padStart(2,"0")}`)}}catch(e){console.warn("[TimeManager] Failed to load saved time:",e)}}getDebugInfo(){return{time:`${String(this.currentHour).padStart(2,"0")}:${String(this.currentMinute).padStart(2,"0")}`,day:this.currentDay,phase:this.dayPhase,moonPhase:this.moonPhase,sunAngle:(this.getSunAngle()*180/Math.PI).toFixed(1)+"",moonBrightness:this.getMoonBrightness().toFixed(2)}}}let Sl=null;function WS(l){return Sl||(Sl=new qS(l)),Sl}function Km(){return Sl}const rl={[dt.NIGHT]:{ambient:new H(657946),sun:new H(0),moon:new H(4482730),sky:new H(328976),fog:new H(526360),fogDensity:.025,ambientIntensity:.15,sunIntensity:0,moonIntensity:.3},[dt.DAWN]:{ambient:new H(4863269),sun:new H(16746564),moon:new H(2245802),sky:new H(16750950),fog:new H(11167300),fogDensity:.015,ambientIntensity:.4,sunIntensity:.6,moonIntensity:.1},[dt.DAY]:{ambient:new H(8952234),sun:new H(16777215),moon:new H(0),sky:new H(8900331),fog:new H(10075016),fogDensity:.002,ambientIntensity:.6,sunIntensity:1.2,moonIntensity:0},[dt.DUSK]:{ambient:new H(5583684),sun:new H(16729122),moon:new H(3364266),sky:new H(13391240),fog:new H(6702165),fogDensity:.018,ambientIntensity:.35,sunIntensity:.4,moonIntensity:.15}},VS=30;class $S{constructor(e,t){this.scene=e,this.renderer=t,this.timeManager=null,this.currentAmbientColor=new H(8952234),this.currentSunColor=new H(16777215),this.currentMoonColor=new H(4482730),this.currentSkyColor=new H(8900331),this.currentFogColor=new H(11189196),this.currentFogDensity=.008,this.currentAmbientIntensity=.6,this.currentSunIntensity=1.2,this.currentMoonIntensity=0,this.targetAmbientColor=new H,this.targetSunColor=new H,this.targetMoonColor=new H,this.targetSkyColor=new H,this.targetFogColor=new H,this.targetFogDensity=.008,this.targetAmbientIntensity=.6,this.targetSunIntensity=1.2,this.targetMoonIntensity=0,this.transitionProgress=1,this.transitionSpeed=1/VS,this.ambientLight=null,this.sunLight=null,this.moonLight=null,this.sunMesh=null,this.moonMesh=null,this.starField=null,this.indoorZones=[],this.isIndoors=!1,this.torches=[],this.createLights(),this.createCelestialBodies(),this.createStarField(),this.setPhaseImmediate(dt.DAY)}createLights(){this.ambientLight=new Vo(13421772,.5),this.scene.add(this.ambientLight),this.sunLight=new gd(16777215,1.2),this.sunLight.position.set(50,80,30),this.sunLight.castShadow=!0,this.sunLight.shadow.mapSize.width=2048,this.sunLight.shadow.mapSize.height=2048,this.sunLight.shadow.camera.near=.5,this.sunLight.shadow.camera.far=200,this.sunLight.shadow.camera.left=-60,this.sunLight.shadow.camera.right=60,this.sunLight.shadow.camera.top=60,this.sunLight.shadow.camera.bottom=-60,this.sunLight.shadow.bias=-5e-4,this.sunLight.target.position.set(0,0,0),this.scene.add(this.sunLight),this.scene.add(this.sunLight.target),this.moonLight=new gd(4482730,0),this.moonLight.position.set(-50,60,-30),this.moonLight.castShadow=!0,this.moonLight.shadow.mapSize.width=1024,this.moonLight.shadow.mapSize.height=1024,this.moonLight.shadow.camera.near=.5,this.moonLight.shadow.camera.far=150,this.moonLight.shadow.camera.left=-40,this.moonLight.shadow.camera.right=40,this.moonLight.shadow.camera.top=40,this.moonLight.shadow.camera.bottom=-40,this.moonLight.target.position.set(0,0,0),this.scene.add(this.moonLight),this.scene.add(this.moonLight.target)}createCelestialBodies(){const e=new re(4,16,16),t=new B({color:16768392,transparent:!0,opacity:.9});this.sunMesh=new w(e,t),this.sunMesh.position.set(50,80,30),this.scene.add(this.sunMesh);const i=new re(8,16,16),s=new B({color:16755268,transparent:!0,opacity:.3,side:wi});this.sunGlow=new w(i,s),this.sunMesh.add(this.sunGlow);const n=new re(2.5,16,16),a=new B({color:15658751,transparent:!0,opacity:.95});this.moonMesh=new w(n,a),this.moonMesh.position.set(-50,60,-30),this.moonMesh.visible=!1,this.scene.add(this.moonMesh);const o=new re(4,16,16),r=new B({color:8952268,transparent:!0,opacity:.2,side:wi});this.moonGlow=new w(o,r),this.moonMesh.add(this.moonGlow)}createStarField(){const t=new Float32Array(6e3),i=new Float32Array(2e3*3),s=new Float32Array(2e3);for(let o=0;o<2e3;o++){const r=Math.random()*Math.PI*2,c=Math.random()*Math.PI*.5,h=150+Math.random()*50;t[o*3]=Math.sin(c)*Math.cos(r)*h,t[o*3+1]=Math.cos(c)*h+20,t[o*3+2]=Math.sin(c)*Math.sin(r)*h;const d=.9+Math.random()*.1;i[o*3]=d,i[o*3+1]=d,i[o*3+2]=1,s[o]=.5+Math.random()*1.5}const n=new mt;n.setAttribute("position",new Je(t,3)),n.setAttribute("color",new Je(i,3)),n.setAttribute("size",new Je(s,1));const a=new Ri({size:1,vertexColors:!0,transparent:!0,opacity:0,sizeAttenuation:!1,blending:ui});this.starField=new Bi(n,a),this.starField.visible=!1,this.scene.add(this.starField)}initialize(e){this.timeManager=e,e.onPhaseChange=(t,i)=>{this.startPhaseTransition(t)},e.setSunLight(this.sunLight,this.sunMesh),e.setMoonLight(this.moonLight,this.moonMesh),this.setPhaseImmediate(e.dayPhase)}setPhaseImmediate(e){const t=rl[e]||rl[dt.DAY];this.currentAmbientColor.copy(t.ambient),this.currentSunColor.copy(t.sun),this.currentMoonColor.copy(t.moon),this.currentSkyColor.copy(t.sky),this.currentFogColor.copy(t.fog),this.currentFogDensity=t.fogDensity,this.currentAmbientIntensity=t.ambientIntensity,this.currentSunIntensity=t.sunIntensity,this.currentMoonIntensity=t.moonIntensity,this.targetAmbientColor.copy(t.ambient),this.targetSunColor.copy(t.sun),this.targetMoonColor.copy(t.moon),this.targetSkyColor.copy(t.sky),this.targetFogColor.copy(t.fog),this.targetFogDensity=t.fogDensity,this.targetAmbientIntensity=t.ambientIntensity,this.targetSunIntensity=t.sunIntensity,this.targetMoonIntensity=t.moonIntensity,this.transitionProgress=1,this.applyCurrentColors()}startPhaseTransition(e){const t=rl[e]||rl[dt.DAY];this.targetAmbientColor.copy(t.ambient),this.targetSunColor.copy(t.sun),this.targetMoonColor.copy(t.moon),this.targetSkyColor.copy(t.sky),this.targetFogColor.copy(t.fog),this.targetFogDensity=t.fogDensity,this.targetAmbientIntensity=t.ambientIntensity,this.targetSunIntensity=t.sunIntensity,this.targetMoonIntensity=t.moonIntensity,this.transitionProgress=0,console.log(`[DayNightLighting] Transitioning to ${e}`)}applyCurrentColors(){if(!this.isIndoors){if(this.ambientLight&&(this.ambientLight.color.copy(this.currentAmbientColor),this.ambientLight.intensity=this.currentAmbientIntensity),this.sunLight&&(this.sunLight.color.copy(this.currentSunColor),this.sunLight.intensity=this.currentSunIntensity),this.moonLight){this.moonLight.color.copy(this.currentMoonColor);let e=this.currentMoonIntensity;this.timeManager&&(e*=this.timeManager.getMoonBrightness()),this.moonLight.intensity=e}if(this.scene.background&&this.scene.background.isColor?this.scene.background.copy(this.currentSkyColor):this.scene.background=this.currentSkyColor.clone(),this.scene.fog?(this.scene.fog.color.copy(this.currentFogColor),this.scene.fog.density=this.currentFogDensity):this.scene.fog=new hr(this.currentFogColor,this.currentFogDensity),this.sunMesh){const e=this.currentSunIntensity>.1;this.sunMesh.visible=e,e&&(this.sunMesh.material.color.copy(this.currentSunColor),this.sunMesh.material.opacity=Math.min(1,this.currentSunIntensity))}if(this.moonMesh){const e=this.currentMoonIntensity>.05;this.moonMesh.visible=e}if(this.starField){const e=this.timeManager&&this.timeManager.isNighttime(),t=this.timeManager&&this.timeManager.dayPhase===dt.DUSK;if(this.starField.visible=e||t,this.starField.visible){let i=0;e?i=.8:t&&(i=this.timeManager.getPhaseProgress()*.5),this.starField.material.opacity=i}}this.updateTorches()}}updateTorches(){const e=this.timeManager&&this.timeManager.isNighttime(),t=this.timeManager&&this.timeManager.dayPhase===dt.DUSK;let i=.3;t?i=.5+this.timeManager.getPhaseProgress()*.5:e&&(i=1);for(const s of this.torches)if(s.light&&(s.light.intensity=s.baseIntensity*i),s.mesh&&s.mesh.material){const n=s.mesh.material.emissive;n&&n.setRGB(s.baseEmissive.r*i,s.baseEmissive.g*i,s.baseEmissive.b*i)}}registerTorch(e,t=null,i=1,s=new H(1,.5,.1)){this.torches.push({mesh:e,light:t,baseIntensity:i,baseEmissive:s.clone()})}addIndoorZone(e){this.indoorZones.push(e)}checkIndoors(e){for(const t of this.indoorZones)if(e.x>=t.minX&&e.x<=t.maxX&&e.z>=t.minZ&&e.z<=t.maxZ)return!0;return!1}updateIndoorState(e){const t=this.isIndoors;this.isIndoors=this.checkIndoors(e),t!==this.isIndoors&&(this.isIndoors?this.applyIndoorLighting():this.applyCurrentColors())}applyIndoorLighting(){this.ambientLight&&(this.ambientLight.color.set(8939093),this.ambientLight.intensity=.5),this.sunLight&&(this.sunLight.intensity=.2),this.moonLight&&(this.moonLight.intensity=0),this.sunMesh&&(this.sunMesh.visible=!1),this.moonMesh&&(this.moonMesh.visible=!1),this.starField&&(this.starField.visible=!1),this.scene.fog}getLightIntensity(){return this.isIndoors?.5:this.currentAmbientIntensity+this.currentSunIntensity*.5}isDark(){return this.getLightIntensity()<.4}update(e,t=null){if(t&&this.updateIndoorState(t),this.transitionProgress<1){this.transitionProgress+=this.transitionSpeed*e,this.transitionProgress=Math.min(1,this.transitionProgress);const i=this.transitionProgress;this.currentAmbientColor.lerpColors(this.currentAmbientColor,this.targetAmbientColor,i*.1),this.currentSunColor.lerpColors(this.currentSunColor,this.targetSunColor,i*.1),this.currentMoonColor.lerpColors(this.currentMoonColor,this.targetMoonColor,i*.1),this.currentSkyColor.lerpColors(this.currentSkyColor,this.targetSkyColor,i*.1),this.currentFogColor.lerpColors(this.currentFogColor,this.targetFogColor,i*.1),this.currentFogDensity+=(this.targetFogDensity-this.currentFogDensity)*i*.1,this.currentAmbientIntensity+=(this.targetAmbientIntensity-this.currentAmbientIntensity)*i*.1,this.currentSunIntensity+=(this.targetSunIntensity-this.currentSunIntensity)*i*.1,this.currentMoonIntensity+=(this.targetMoonIntensity-this.currentMoonIntensity)*i*.1,this.isIndoors||this.applyCurrentColors()}if(this.starField&&this.starField.visible){const i=performance.now()*.001,s=this.starField.geometry.attributes.size;for(let n=0;n<s.count;n+=10){const a=.5+n%3*.5;s.array[n]=a+Math.sin(i*2+n)*.3}s.needsUpdate=!0}}forceDark(){this.isIndoors=!0,this.applyIndoorLighting(),this.ambientLight&&(this.ambientLight.intensity=.15)}forceNormal(){this.isIndoors=!1,this.applyCurrentColors()}getDebugInfo(){return{ambientIntensity:this.currentAmbientIntensity.toFixed(2),sunIntensity:this.currentSunIntensity.toFixed(2),moonIntensity:this.currentMoonIntensity.toFixed(2),fogDensity:this.currentFogDensity.toFixed(4),isIndoors:this.isIndoors,transitionProgress:this.transitionProgress.toFixed(2)}}}let Tl=null;function XS(l,e){return Tl||(Tl=new $S(l,e)),Tl}function YS(){return Tl}const Ye={CLEAR:"clear",CLOUDY:"cloudy",OVERCAST:"overcast",RAIN:"rain",HEAVY_RAIN:"heavy_rain",STORM:"storm",FOG:"fog",SNOW:"snow",BLIZZARD:"blizzard"},Oa={[Ye.CLEAR]:{fogMultiplier:.8,ambientMultiplier:1,sunMultiplier:1,skyTint:new H(1,1,1),particleType:null,particleCount:0,windStrength:.1,soundLoop:null},[Ye.CLOUDY]:{fogMultiplier:1.2,ambientMultiplier:.85,sunMultiplier:.7,skyTint:new H(.9,.9,.95),particleType:null,particleCount:0,windStrength:.3,soundLoop:"wind_light"},[Ye.OVERCAST]:{fogMultiplier:1.5,ambientMultiplier:.7,sunMultiplier:.4,skyTint:new H(.7,.7,.75),particleType:null,particleCount:0,windStrength:.4,soundLoop:"wind_medium"},[Ye.RAIN]:{fogMultiplier:1.8,ambientMultiplier:.6,sunMultiplier:.3,skyTint:new H(.6,.65,.7),particleType:"rain",particleCount:500,windStrength:.5,soundLoop:"rain_light"},[Ye.HEAVY_RAIN]:{fogMultiplier:2.2,ambientMultiplier:.5,sunMultiplier:.2,skyTint:new H(.5,.55,.6),particleType:"rain",particleCount:1500,windStrength:.7,soundLoop:"rain_heavy"},[Ye.STORM]:{fogMultiplier:2.5,ambientMultiplier:.4,sunMultiplier:.1,skyTint:new H(.4,.4,.5),particleType:"rain",particleCount:2e3,windStrength:1,soundLoop:"storm",hasLightning:!0},[Ye.FOG]:{fogMultiplier:4,ambientMultiplier:.65,sunMultiplier:.3,skyTint:new H(.8,.8,.82),particleType:"fog_wisps",particleCount:100,windStrength:.1,soundLoop:null},[Ye.SNOW]:{fogMultiplier:1.5,ambientMultiplier:.8,sunMultiplier:.6,skyTint:new H(.85,.88,.95),particleType:"snow",particleCount:800,windStrength:.3,soundLoop:"wind_light"},[Ye.BLIZZARD]:{fogMultiplier:3,ambientMultiplier:.5,sunMultiplier:.2,skyTint:new H(.75,.78,.85),particleType:"snow",particleCount:2500,windStrength:1.2,soundLoop:"blizzard"}},hf={default:{[Ye.CLEAR]:.4,[Ye.CLOUDY]:.25,[Ye.OVERCAST]:.15,[Ye.RAIN]:.1,[Ye.HEAVY_RAIN]:.05,[Ye.FOG]:.05},forest:{[Ye.CLEAR]:.3,[Ye.CLOUDY]:.2,[Ye.OVERCAST]:.2,[Ye.RAIN]:.15,[Ye.HEAVY_RAIN]:.08,[Ye.FOG]:.07},mountain:{[Ye.CLEAR]:.35,[Ye.CLOUDY]:.2,[Ye.OVERCAST]:.15,[Ye.SNOW]:.15,[Ye.FOG]:.1,[Ye.BLIZZARD]:.05},swamp:{[Ye.FOG]:.35,[Ye.OVERCAST]:.25,[Ye.RAIN]:.2,[Ye.HEAVY_RAIN]:.1,[Ye.CLOUDY]:.1},desert:{[Ye.CLEAR]:.7,[Ye.CLOUDY]:.2,[Ye.OVERCAST]:.1}},QS=60,df=2,jS=8;class KS{constructor(e,t,i){this.scene=e,this.particleManager=t,this.audioManager=i,this.currentWeather=Ye.CLEAR,this.currentBiome="default",this.weatherQueue=[],this.transitionProgress=1,this.transitionSpeed=1/QS,this.previousWeather=null,this.currentFogMult=1,this.currentAmbientMult=1,this.currentSunMult=1,this.currentSkyTint=new H(1,1,1),this.currentWindStrength=.1,this.targetFogMult=1,this.targetAmbientMult=1,this.targetSunMult=1,this.targetSkyTint=new H(1,1,1),this.targetWindStrength=.1,this.nextWeatherChangeHour=0,this.hoursUntilChange=this.getRandomChangeInterval(),this.weatherParticles=null,this.currentParticleType=null,this.lightningTimer=0,this.lightningFlash=null,this.isLightningFlashing=!1,this.onWeatherChange=null,this.createLightningLight(),this.load()}createLightningLight(){this.lightningFlash=new We(11193599,0,200),this.lightningFlash.position.set(0,100,0),this.scene.add(this.lightningFlash)}getRandomChangeInterval(){return df+Math.random()*(jS-df)}selectRandomWeather(e="default"){const t=hf[e]||hf.default,i=Object.values(t).reduce((n,a)=>n+a,0);let s=Math.random()*i;for(const[n,a]of Object.entries(t))if(s-=a,s<=0)return n;return Ye.CLEAR}initialize(e){const t=e.onHourChange;e.onHourChange=i=>{t&&t(i),this.onHourChanged(i)}}onHourChanged(e){if(this.hoursUntilChange--,this.hoursUntilChange<=0){const t=this.selectRandomWeather(this.currentBiome);t!==this.currentWeather&&this.startWeatherTransition(t),this.hoursUntilChange=this.getRandomChangeInterval()}}forceWeather(e,t=!1){if(!Oa[e]){console.warn(`[WeatherManager] Unknown weather type: ${e}`);return}t?this.setWeatherImmediate(e):this.startWeatherTransition(e)}setWeatherImmediate(e){const t=Oa[e];t&&(this.currentWeather=e,this.previousWeather=null,this.transitionProgress=1,this.currentFogMult=t.fogMultiplier,this.currentAmbientMult=t.ambientMultiplier,this.currentSunMult=t.sunMultiplier,this.currentSkyTint.copy(t.skyTint),this.currentWindStrength=t.windStrength,this.targetFogMult=t.fogMultiplier,this.targetAmbientMult=t.ambientMultiplier,this.targetSunMult=t.sunMultiplier,this.targetSkyTint.copy(t.skyTint),this.targetWindStrength=t.windStrength,this.updateWeatherParticles(e),this.updateWeatherAudio(e),this.onWeatherChange&&this.onWeatherChange(e,null),console.log(`[WeatherManager] Weather set to ${e}`))}startWeatherTransition(e){if(e===this.currentWeather)return;const t=Oa[e];t&&(this.previousWeather=this.currentWeather,this.currentWeather=e,this.transitionProgress=0,this.targetFogMult=t.fogMultiplier,this.targetAmbientMult=t.ambientMultiplier,this.targetSunMult=t.sunMultiplier,this.targetSkyTint.copy(t.skyTint),this.targetWindStrength=t.windStrength,this.updateWeatherParticles(e),this.updateWeatherAudio(e),this.onWeatherChange&&this.onWeatherChange(e,this.previousWeather),console.log(`[WeatherManager] Weather transitioning to ${e}`))}updateWeatherParticles(e){const t=Oa[e];if(this.weatherParticles&&(this.scene.remove(this.weatherParticles),this.weatherParticles.geometry.dispose(),this.weatherParticles.material.dispose(),this.weatherParticles=null),!t.particleType||t.particleCount===0){this.currentParticleType=null;return}this.currentParticleType=t.particleType,t.particleType==="rain"?this.createRainParticles(t.particleCount):t.particleType==="snow"?this.createSnowParticles(t.particleCount):t.particleType==="fog_wisps"&&this.createFogWisps(t.particleCount)}createRainParticles(e){const t=new Float32Array(e*3),i=new Float32Array(e*3);for(let a=0;a<e;a++)t[a*3]=(Math.random()-.5)*80,t[a*3+1]=Math.random()*50,t[a*3+2]=(Math.random()-.5)*80,i[a*3]=(Math.random()-.5)*2,i[a*3+1]=-15-Math.random()*10,i[a*3+2]=(Math.random()-.5)*2;const s=new mt;s.setAttribute("position",new Je(t,3)),s.setAttribute("velocity",new Je(i,3));const n=new Ri({color:10070732,size:.15,transparent:!0,opacity:.6,blending:ui});this.weatherParticles=new Bi(s,n),this.weatherParticles.userData.type="rain",this.scene.add(this.weatherParticles)}createSnowParticles(e){const t=new Float32Array(e*3),i=new Float32Array(e*3);for(let a=0;a<e;a++)t[a*3]=(Math.random()-.5)*80,t[a*3+1]=Math.random()*50,t[a*3+2]=(Math.random()-.5)*80,i[a*3]=(Math.random()-.5)*1,i[a*3+1]=-2-Math.random()*2,i[a*3+2]=(Math.random()-.5)*1;const s=new mt;s.setAttribute("position",new Je(t,3)),s.setAttribute("velocity",new Je(i,3));const n=new Ri({color:16777215,size:.3,transparent:!0,opacity:.8,blending:ta});this.weatherParticles=new Bi(s,n),this.weatherParticles.userData.type="snow",this.scene.add(this.weatherParticles)}createFogWisps(e){const t=new Float32Array(e*3),i=new Float32Array(e*3);for(let a=0;a<e;a++)t[a*3]=(Math.random()-.5)*100,t[a*3+1]=Math.random()*5+1,t[a*3+2]=(Math.random()-.5)*100,i[a*3]=(Math.random()-.5)*.5,i[a*3+1]=(Math.random()-.5)*.1,i[a*3+2]=(Math.random()-.5)*.5;const s=new mt;s.setAttribute("position",new Je(t,3)),s.setAttribute("velocity",new Je(i,3));const n=new Ri({color:11189196,size:3,transparent:!0,opacity:.3,blending:ui,sizeAttenuation:!0});this.weatherParticles=new Bi(s,n),this.weatherParticles.userData.type="fog_wisps",this.scene.add(this.weatherParticles)}updateWeatherAudio(e){if(!this.audioManager)return;Oa[e].soundLoop}setBiome(e){this.currentBiome=e}updateParticles(e,t){if(!this.weatherParticles)return;const i=this.weatherParticles.geometry.attributes.position,s=this.weatherParticles.geometry.attributes.velocity,n=Math.sin(performance.now()*.001)*this.currentWindStrength,a=Math.cos(performance.now()*7e-4)*this.currentWindStrength*.5;for(let o=0;o<i.count;o++){let r=i.array[o*3],c=i.array[o*3+1],h=i.array[o*3+2];if(r+=(s.array[o*3]+n)*e,c+=s.array[o*3+1]*e,h+=(s.array[o*3+2]+a)*e,t){const d=r-t.x,u=h-t.z;Math.abs(d)>40&&(r=t.x+(Math.random()-.5)*80),Math.abs(u)>40&&(h=t.z+(Math.random()-.5)*80)}c<0&&(c=50+Math.random()*10,r=(t?.x||0)+(Math.random()-.5)*80,h=(t?.z||0)+(Math.random()-.5)*80),i.array[o*3]=r,i.array[o*3+1]=c,i.array[o*3+2]=h}i.needsUpdate=!0}updateLightning(e){const t=Oa[this.currentWeather];if(!t||!t.hasLightning){this.lightningFlash.intensity=0;return}this.lightningTimer-=e,this.lightningTimer<=0&&!this.isLightningFlashing&&(Math.random()<.01&&this.triggerLightning(),this.lightningTimer=.5+Math.random()*2),this.isLightningFlashing&&(this.lightningFlash.intensity*=.85,this.lightningFlash.intensity<.1&&(this.lightningFlash.intensity=0,this.isLightningFlashing=!1))}triggerLightning(){if(this.isLightningFlashing=!0,this.lightningFlash.intensity=3+Math.random()*2,this.lightningFlash.position.set((Math.random()-.5)*100,80+Math.random()*40,(Math.random()-.5)*100),this.audioManager){const e=.5+Math.random()*2;setTimeout(()=>{},e*1e3)}}getMultipliers(){return{fog:this.currentFogMult,ambient:this.currentAmbientMult,sun:this.currentSunMult,skyTint:this.currentSkyTint,wind:this.currentWindStrength}}applyToLighting(e){}update(e,t=null){if(this.transitionProgress<1){this.transitionProgress+=this.transitionSpeed*e,this.transitionProgress=Math.min(1,this.transitionProgress);const i=this.transitionProgress;this.currentFogMult+=(this.targetFogMult-this.currentFogMult)*i*.05,this.currentAmbientMult+=(this.targetAmbientMult-this.currentAmbientMult)*i*.05,this.currentSunMult+=(this.targetSunMult-this.currentSunMult)*i*.05,this.currentSkyTint.lerp(this.targetSkyTint,i*.05),this.currentWindStrength+=(this.targetWindStrength-this.currentWindStrength)*i*.05}this.updateParticles(e,t),this.updateLightning(e)}save(){const e={weather:this.currentWeather,biome:this.currentBiome,hoursUntilChange:this.hoursUntilChange};localStorage.setItem("ashen-weather",JSON.stringify(e))}load(){try{const e=localStorage.getItem("ashen-weather");if(e){const t=JSON.parse(e);this.currentWeather=t.weather||Ye.CLEAR,this.currentBiome=t.biome||"default",this.hoursUntilChange=t.hoursUntilChange??this.getRandomChangeInterval(),this.setWeatherImmediate(this.currentWeather),console.log(`[WeatherManager] Loaded weather: ${this.currentWeather}, biome: ${this.currentBiome}`)}}catch(e){console.warn("[WeatherManager] Failed to load saved weather:",e)}}getDebugInfo(){return{weather:this.currentWeather,biome:this.currentBiome,fogMult:this.currentFogMult.toFixed(2),sunMult:this.currentSunMult.toFixed(2),wind:this.currentWindStrength.toFixed(2),hoursUntilChange:Math.ceil(this.hoursUntilChange),transitioning:this.transitionProgress<1}}}let El=null;function ZS(l,e,t){return El||(El=new KS(l,e,t)),El}function Zm(){return El}const uf={WRAITH:{id:"wraith",name:"Wraith",spawnChance:.3,minSpawnHour:21,maxSpawnHour:4,moonPhaseBonus:{0:.5,4:.2},baseHealth:80,baseDamage:25,special:"phase_through_walls",loot:["ectoplasm","shadow_essence"]},SHADOW_STALKER:{id:"shadow_stalker",name:"Shadow Stalker",spawnChance:.2,minSpawnHour:22,maxSpawnHour:3,moonPhaseBonus:{0:.8},baseHealth:60,baseDamage:35,special:"backstab",loot:["dark_essence","shadow_cloak_fragment"]},NIGHT_HOWLER:{id:"night_howler",name:"Night Howler",spawnChance:.25,minSpawnHour:20,maxSpawnHour:5,moonPhaseBonus:{4:.4},baseHealth:100,baseDamage:20,special:"howl_fear",loot:["moonstone_shard","beast_fang"]},PHANTOM:{id:"phantom",name:"Phantom",spawnChance:.15,minSpawnHour:23,maxSpawnHour:2,moonPhaseBonus:{},baseHealth:50,baseDamage:40,special:"life_drain",loot:["spirit_essence","phantom_silk"]}},pf={general_store:{open:7,close:20},blacksmith:{open:6,close:22},alchemist:{open:8,close:19},tavern:{open:10,close:2},magic_shop:{open:12,close:24},black_market:{open:22,close:4}},JS={VILLAGER:{wake:6,work:7,lunch:12,resume:13,evening:18,home:20,sleep:22},GUARD:{dayShift:{start:6,end:18},nightShift:{start:18,end:6},patrolDuringShift:!0},MERCHANT:{wake:5,openShop:7,closeShop:20,socialHour:20,sleep:22}},eT={moonlit_blade:{requiredPhase:dt.NIGHT,moonPhases:[3,4,5],description:"Forge under the light of a near-full moon"},sun_essence:{requiredPhase:dt.DAY,hourRange:{min:11,max:13},description:"Harvest when the sun is at its peak"},dawn_elixir:{requiredPhase:dt.DAWN,description:"Brew at the first light of dawn"},dusk_potion:{requiredPhase:dt.DUSK,description:"Infuse as the sun sets"},starlight_crystal:{requiredPhase:dt.NIGHT,hourRange:{min:0,max:3},description:"Channel starlight in the darkest hours"},shadow_cloak:{requiredPhase:dt.NIGHT,moonPhases:[0,1,7],description:"Weave in the darkness of a new moon"}},tT={[Ye.RAIN]:{movementMultiplier:.9,staminaDrainMultiplier:1.1,torchEffectiveness:.7,fireStartChance:.3,detectionRange:.85,debuff:"wet",debuffDuration:300,sounds:["squelching_footsteps"]},[Ye.HEAVY_RAIN]:{movementMultiplier:.8,staminaDrainMultiplier:1.25,torchEffectiveness:.4,fireStartChance:.1,detectionRange:.7,debuff:"soaked",debuffDuration:600,sounds:["squelching_footsteps","heavy_rain_ambient"]},[Ye.STORM]:{movementMultiplier:.7,staminaDrainMultiplier:1.4,torchEffectiveness:.2,fireStartChance:.05,detectionRange:.5,debuff:"storm_battered",debuffDuration:900,lightningDamageChance:.001,sounds:["storm_wind","thunder_rumble"]},[Ye.FOG]:{movementMultiplier:1,staminaDrainMultiplier:1,torchEffectiveness:.5,fireStartChance:.8,detectionRange:.4,debuff:null,ambushChanceMultiplier:1.5,sounds:["eerie_fog_ambient"]},[Ye.SNOW]:{movementMultiplier:.85,staminaDrainMultiplier:1.15,torchEffectiveness:.9,fireStartChance:.6,detectionRange:.9,debuff:"chilled",debuffDuration:180,coldDamage:.5,sounds:["crunching_snow"]},[Ye.BLIZZARD]:{movementMultiplier:.6,staminaDrainMultiplier:1.6,torchEffectiveness:.3,fireStartChance:.2,detectionRange:.3,debuff:"frostbite",debuffDuration:1200,coldDamage:2,sounds:["blizzard_howl","crunching_snow"]}},Io={baseRestDuration:6,healthRegenPerHour:15,staminaRegenPerHour:25,warmthBuffDuration:1800,warmthBuffEffects:{staminaDrainReduction:.3}},iT={[dt.NIGHT]:.6,[dt.DAWN]:.85,[dt.DAY]:1,[dt.DUSK]:.85},sT={[dt.NIGHT]:{hostile:1.8,passive:.3,nightOnly:1},[dt.DAWN]:{hostile:1.2,passive:.7,nightOnly:.2},[dt.DAY]:{hostile:1,passive:1,nightOnly:0},[dt.DUSK]:{hostile:1.3,passive:.6,nightOnly:.3}};class nT{constructor(e){this.gm=e,this.timeManager=null,this.weatherManager=null,this.activeDebuffs=new Map,this.hasWarmthBuff=!1,this.warmthBuffEndTime=0,this.isResting=!1,this.restStartTime=0,this.restTargetHours=0,this.isIndoors=!1,this.nearCampfire=!1,this.campfireWarmthRadius=8,this.shownHints=new Set,this.onDebuffApplied=null,this.onDebuffRemoved=null,this.onRestComplete=null,this.createWeatherHUD(),console.log("[TimeWeatherGameplay] Initialized")}initialize(){if(this.timeManager=Km(),this.weatherManager=Zm(),this.timeManager){const e=this.timeManager.onPhaseChange;this.timeManager.onPhaseChange=(i,s)=>{e&&e(i,s),this.onPhaseChanged(i,s)};const t=this.timeManager.onHourChange;this.timeManager.onHourChange=i=>{t&&t(i),this.onHourChanged(i)}}if(this.weatherManager){const e=this.weatherManager.onWeatherChange;this.weatherManager.onWeatherChange=(t,i)=>{e&&e(t,i),this.onWeatherChanged(t,i)}}this.updateWeatherHUD()}createWeatherHUD(){if(document.getElementById("weather-indicator"))return;const e=document.createElement("div");e.id="weather-indicator",e.innerHTML=`
      <span class="weather-icon"></span>
      <span class="weather-text">Clear</span>
      <div class="debuff-icons"></div>
    `;const t=document.createElement("style");t.textContent=`
      #weather-indicator {
        position: fixed;
        top: 60px;
        right: 10px;
        background: linear-gradient(135deg, rgba(20, 25, 30, 0.85), rgba(30, 35, 45, 0.8));
        border: 2px solid rgba(100, 140, 180, 0.5);
        border-radius: 6px;
        padding: 6px 12px;
        font-family: 'Cinzel', serif;
        color: #c4d4e8;
        font-size: 12px;
        z-index: 100;
        display: flex;
        align-items: center;
        gap: 6px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
      }
      
      #weather-indicator .weather-icon {
        font-size: 16px;
        filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.3));
      }
      
      #weather-indicator .weather-text {
        text-transform: capitalize;
      }
      
      #weather-indicator .debuff-icons {
        display: flex;
        gap: 4px;
        margin-left: 6px;
      }
      
      #weather-indicator .debuff-icon {
        width: 18px;
        height: 18px;
        background: rgba(180, 60, 60, 0.6);
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        animation: debuff-pulse 2s infinite;
      }
      
      @keyframes debuff-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
      }
      
      .tutorial-hint {
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, rgba(40, 30, 20, 0.95), rgba(60, 40, 25, 0.9));
        border: 2px solid rgba(200, 150, 80, 0.7);
        border-radius: 8px;
        padding: 12px 24px;
        font-family: 'Cinzel', serif;
        color: #f0e0c0;
        font-size: 14px;
        z-index: 200;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        animation: hint-appear 0.5s ease-out, hint-fade 0.5s ease-out 4.5s forwards;
      }
      
      @keyframes hint-appear {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
      }
      
      @keyframes hint-fade {
        to { opacity: 0; }
      }
    `,document.head.appendChild(t),document.body.appendChild(e)}updateWeatherHUD(){const e=document.getElementById("weather-indicator");if(!e||!this.weatherManager)return;const t=this.weatherManager.currentWeather,i=this.getWeatherIcon(t),s=t.replace(/_/g," "),n=e.querySelector(".weather-icon"),a=e.querySelector(".weather-text");n&&(n.textContent=i),a&&(a.textContent=s),this.updateDebuffIcons()}getWeatherIcon(e){return{[Ye.CLEAR]:"",[Ye.CLOUDY]:"",[Ye.OVERCAST]:"",[Ye.RAIN]:"",[Ye.HEAVY_RAIN]:"",[Ye.STORM]:"",[Ye.FOG]:"",[Ye.SNOW]:"",[Ye.BLIZZARD]:""}[e]||""}updateDebuffIcons(){const e=document.querySelector("#weather-indicator .debuff-icons");if(!e)return;e.innerHTML="";const t={wet:"",soaked:"",storm_battered:"",chilled:"",frostbite:"",warmth:""};if(this.hasWarmthBuff){const i=document.createElement("div");i.className="debuff-icon",i.style.background="rgba(220, 120, 40, 0.6)",i.textContent=t.warmth,i.title="Warmth Buff",e.appendChild(i)}for(const[i,s]of this.activeDebuffs){const n=document.createElement("div");n.className="debuff-icon",n.textContent=t[s.type]||"",n.title=s.type.replace(/_/g," "),e.appendChild(n)}}showHint(e,t){if(this.shownHints.has(e))return;this.shownHints.add(e),localStorage.setItem("ashen-hints",JSON.stringify([...this.shownHints]));const i=document.createElement("div");i.className="tutorial-hint",i.textContent=t,document.body.appendChild(i),setTimeout(()=>i.remove(),5e3)}onPhaseChanged(e,t){e===dt.NIGHT&&this.showHint("night_danger"," Night brings danger. Creatures of shadow stir..."),e===dt.DAWN&&t===dt.NIGHT&&this.showHint("dawn_safe"," The darkness recedes. You survived the night."),console.log(`[TimeWeatherGameplay] Phase changed: ${t}  ${e}`)}onHourChanged(e){this.updateWeatherHUD()}onWeatherChanged(e,t){this.updateWeatherHUD(),e===Ye.STORM&&this.showHint("storm_warning"," A storm approaches! Seek shelter or risk the lightning."),e===Ye.BLIZZARD&&this.showHint("blizzard_warning"," A blizzard descends! Find warmth quickly."),e===Ye.FOG&&this.showHint("fog_warning"," Thick fog rolls in. Enemies may ambush unseen.")}shouldSpawnNightEnemy(e){if(!this.timeManager)return!1;const t=uf[e];if(!t)return!1;const i=this.timeManager.currentHour,s=this.timeManager.moonPhase;let n;if(t.minSpawnHour>t.maxSpawnHour?n=i>=t.minSpawnHour||i<=t.maxSpawnHour:n=i>=t.minSpawnHour&&i<=t.maxSpawnHour,!n)return!1;let a=t.spawnChance;return t.moonPhaseBonus[s]&&(a+=t.moonPhaseBonus[s]),Math.random()<a}getNightEnemyConfig(e){return uf[e]||null}isShopOpen(e){if(!this.timeManager)return!0;const t=pf[e];if(!t)return!0;const i=this.timeManager.currentHour;return t.close<t.open?i>=t.open||i<t.close:i>=t.open&&i<t.close}getShopHoursText(e){const t=pf[e];if(!t)return"Always Open";const i=s=>{const n=s>=12?"PM":"AM";return`${s>12?s-12:s===0?12:s}${n}`};return`${i(t.open)} - ${i(t.close)}`}getNPCScheduleAction(e){if(!this.timeManager)return"idle";const t=JS[e];if(!t)return"idle";const i=this.timeManager.currentHour;if(e==="GUARD"){const{dayShift:s,nightShift:n}=t;return i>=s.start&&i<s.end?"day_patrol":"night_patrol"}return i<t.wake?"sleeping":i<t.work?"waking":i<t.lunch?"working":i<t.resume?"eating":i<t.evening?"working":i<t.home?"socializing":i<t.sleep?"at_home":"sleeping"}canCraftTimeLocked(e){const t=eT[e];if(!t)return{allowed:!0};if(!this.timeManager)return{allowed:!1,reason:"Time system unavailable"};const i=this.timeManager.dayPhase,s=this.timeManager.currentHour,n=this.timeManager.moonPhase;return t.requiredPhase&&i!==t.requiredPhase?{allowed:!1,reason:t.description,requiredPhase:t.requiredPhase}:t.hourRange&&(s<t.hourRange.min||s>t.hourRange.max)?{allowed:!1,reason:t.description,requiredHours:t.hourRange}:t.moonPhases&&!t.moonPhases.includes(n)?{allowed:!1,reason:t.description,requiredMoonPhases:t.moonPhases}:{allowed:!0}}getCurrentWeatherEffects(){if(!this.weatherManager)return null;const e=this.weatherManager.currentWeather;return tT[e]||null}getDetectionModifier(){let e=1;if(this.timeManager){const i=this.timeManager.dayPhase;e*=iT[i]||1}const t=this.getCurrentWeatherEffects();return t&&t.detectionRange&&(e*=t.detectionRange),e}getMovementModifier(){const e=this.getCurrentWeatherEffects();return e&&e.movementMultiplier||1}getStaminaDrainModifier(){let e=1;const t=this.getCurrentWeatherEffects();return t&&(e*=t.staminaDrainMultiplier||1),this.hasWarmthBuff&&(e*=1-Io.warmthBuffEffects.staminaDrainReduction),e}getSpawnRateModifier(e="hostile"){if(!this.timeManager)return 1;const t=this.timeManager.dayPhase,i=sT[t];return i&&i[e]||1}applyWeatherDebuff(e,t){const i=`weather_${e}_${Date.now()}`;this.activeDebuffs.set(i,{type:e,startTime:Date.now(),duration:t*1e3,effects:this.getDebuffEffects(e)}),this.updateDebuffIcons(),this.onDebuffApplied&&this.onDebuffApplied(e),console.log(`[TimeWeatherGameplay] Applied debuff: ${e}`)}getDebuffEffects(e){return{wet:{fireResist:-.2,lightningVuln:.3},soaked:{fireResist:-.4,lightningVuln:.5,moveSpeed:-.1},storm_battered:{moveSpeed:-.2,accuracy:-.15},chilled:{attackSpeed:-.15,moveSpeed:-.1},frostbite:{attackSpeed:-.3,moveSpeed:-.25,maxStamina:-.2}}[e]||{}}cleanupDebuffs(){const e=Date.now(),t=[];for(const[i,s]of this.activeDebuffs)e-s.startTime>s.duration&&t.push(i);for(const i of t){const s=this.activeDebuffs.get(i);this.activeDebuffs.delete(i),this.onDebuffRemoved&&this.onDebuffRemoved(s.type)}t.length>0&&this.updateDebuffIcons()}isSheltered(){return this.isIndoors||this.nearCampfire}setIndoors(e){this.isIndoors=e}updateCampfireProximity(e,t){if(this.nearCampfire=!1,!(!e||!t))for(const i of e){if(!i.isLit)continue;if(t.distanceTo(i.position)<=this.campfireWarmthRadius){this.nearCampfire=!0;break}}}startRest(e=Io.baseRestDuration){return this.nearCampfire?this.isResting?(console.log("[TimeWeatherGameplay] Already resting"),!1):(this.isResting=!0,this.restStartTime=Date.now(),this.restTargetHours=e,this.timeManager,this.showRestUI(e),console.log(`[TimeWeatherGameplay] Started resting for ${e} hours`),!0):(console.log("[TimeWeatherGameplay] Cannot rest - not near a campfire"),!1)}showRestUI(e){const t=document.getElementById("rest-overlay");t&&t.remove();const i=document.createElement("div");i.id="rest-overlay",i.innerHTML=`
      <div class="rest-content">
        <div class="rest-icon"></div>
        <div class="rest-text">Resting...</div>
        <div class="rest-progress">
          <div class="rest-bar"></div>
        </div>
        <div class="rest-hours">0 / ${e} hours</div>
      </div>
    `;const s=document.createElement("style");s.id="rest-style",s.textContent=`
      #rest-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: rest-fade-in 1s ease;
      }
      
      @keyframes rest-fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .rest-content {
        text-align: center;
        color: #f0d0a0;
        font-family: 'Cinzel', serif;
      }
      
      .rest-icon {
        font-size: 64px;
        margin-bottom: 20px;
        animation: fire-flicker 0.5s infinite alternate;
      }
      
      @keyframes fire-flicker {
        from { filter: brightness(1); }
        to { filter: brightness(1.2); }
      }
      
      .rest-text {
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      .rest-progress {
        width: 300px;
        height: 12px;
        background: rgba(100, 80, 60, 0.5);
        border-radius: 6px;
        overflow: hidden;
        margin: 0 auto 10px;
      }
      
      .rest-bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #d4a04a, #f0c060);
        transition: width 0.5s;
      }
      
      .rest-hours {
        font-size: 14px;
        color: #a08060;
      }
    `,document.head.appendChild(s),document.body.appendChild(i),this.animateRest(e)}animateRest(e){const i=Date.now(),s=()=>{const n=Date.now()-i,a=Math.min(n/3e3,1),o=document.querySelector(".rest-bar"),r=document.querySelector(".rest-hours");o&&(o.style.width=`${a*100}%`),r&&(r.textContent=`${Math.floor(a*e)} / ${e} hours`),a<1?requestAnimationFrame(s):setTimeout(()=>this.completeRest(),500)};requestAnimationFrame(s)}completeRest(){if(this.timeManager)for(let i=0;i<this.restTargetHours;i++){const s=(this.timeManager.currentHour+1)%24;this.timeManager.setTime(s,0)}this.hasWarmthBuff=!0,this.warmthBuffEndTime=Date.now()+Io.warmthBuffDuration*1e3,this.activeDebuffs.clear();const e=document.getElementById("rest-overlay");e&&(e.style.animation="rest-fade-in 1s ease reverse",setTimeout(()=>e.remove(),1e3));const t=document.getElementById("rest-style");t&&setTimeout(()=>t.remove(),1e3),this.isResting=!1,this.onRestComplete&&this.onRestComplete({hoursRested:this.restTargetHours,healthRestored:this.restTargetHours*Io.healthRegenPerHour,staminaRestored:this.restTargetHours*Io.staminaRegenPerHour,warmthBuff:!0}),this.updateDebuffIcons(),console.log(`[TimeWeatherGameplay] Rest complete. ${this.restTargetHours} hours passed.`)}getColdDamage(){if(this.hasWarmthBuff||this.isSheltered())return 0;const e=this.getCurrentWeatherEffects();return!e||!e.coldDamage?0:e.coldDamage}checkLightningStrike(){if(this.isIndoors)return!1;const e=this.getCurrentWeatherEffects();return!e||!e.lightningDamageChance?!1:Math.random()<e.lightningDamageChance}update(e,t,i){if(this.updateCampfireProximity(i,t),this.cleanupDebuffs(),this.hasWarmthBuff&&Date.now()>this.warmthBuffEndTime&&(this.hasWarmthBuff=!1,this.updateDebuffIcons(),console.log("[TimeWeatherGameplay] Warmth buff expired")),!this.isSheltered()){const s=this.getCurrentWeatherEffects();s&&s.debuff&&([...this.activeDebuffs.values()].some(a=>a.type===s.debuff)||this.applyWeatherDebuff(s.debuff,s.debuffDuration))}}save(){const e={shownHints:[...this.shownHints],hasWarmthBuff:this.hasWarmthBuff,warmthBuffEndTime:this.warmthBuffEndTime};localStorage.setItem("ashen-gameplay-time",JSON.stringify(e))}load(){try{const e=localStorage.getItem("ashen-gameplay-time");if(e){const t=JSON.parse(e);this.shownHints=new Set(t.shownHints||[]),this.hasWarmthBuff=t.hasWarmthBuff||!1,this.warmthBuffEndTime=t.warmthBuffEndTime||0,this.hasWarmthBuff&&Date.now()>this.warmthBuffEndTime&&(this.hasWarmthBuff=!1)}}catch(e){console.warn("[TimeWeatherGameplay] Failed to load state:",e)}}}let ll=null;function aT(l){return ll||(ll=new nT(l),ll.load()),ll}const ms={CLEAR:"clear",CLOUDY:"cloudy",OVERCAST:"overcast",RAIN:"rain",HEAVY_RAIN:"heavy_rain",STORM:"storm",FOG:"fog",SNOW:"snow",BLIZZARD:"blizzard"};ms.CLEAR+"",new H(.9,.9,.95),new H(.7,.8,.95),new H(1,1,1),ms.CLOUDY+"",new H(.75,.75,.8),new H(.6,.65,.75),new H(.9,.9,.95),ms.OVERCAST+"",new H(.6,.6,.65),new H(.5,.55,.6),new H(.7,.7,.75),ms.RAIN+"",new H(.5,.55,.6),new H(.45,.5,.55),new H(.6,.65,.7),ms.HEAVY_RAIN+"",new H(.4,.45,.5),new H(.35,.4,.45),new H(.5,.55,.6),ms.STORM+"",new H(.3,.35,.4),new H(.25,.3,.35),new H(.4,.4,.5),ms.FOG+"",new H(.6,.6,.65),new H(.7,.7,.75),new H(.8,.8,.82),ms.SNOW+"",new H(.7,.75,.85),new H(.8,.82,.9),new H(.85,.88,.95),ms.BLIZZARD+"",new H(.5,.55,.65),new H(.7,.72,.8),new H(.75,.78,.85);const Bo={BLOOD_MOON:{id:"blood_moon",name:"Blood Moon",description:"The moon turns crimson, empowering creatures of the night",triggerConditions:{moonPhase:4,chance:.05,minHour:21,maxHour:4},duration:6,visuals:{moonColor:new H(.9,.2,.1),moonGlow:new H(1,.3,.2),ambientTint:new H(.3,.1,.1),fogColor:new H(.4,.15,.1),skyTint:new H(.5,.2,.2)},effects:{enemyDamageMultiplier:1.5,enemyHealthMultiplier:1.3,nightEnemySpawnMultiplier:3,lootQualityMultiplier:2,playerDetectionMultiplier:.5,specialDrops:["blood_essence","crimson_moon_shard","lunar_blood"],uniqueSpawns:["blood_wraith","crimson_hunter","moon_beast"]},soundLoop:"blood_moon_ambient",startSound:"blood_moon_rise"},METEOR_SHOWER:{id:"meteor_shower",name:"Meteor Shower",description:"Stars fall from the heavens, leaving precious materials",triggerConditions:{weather:[ms.CLEAR],dayPhase:"NIGHT",chance:.03,minHour:22,maxHour:3},duration:4,visuals:{particleType:"meteor",particleCount:30,trailColor:new H(1,.8,.4),impactFlash:new H(1,.9,.7)},effects:{meteoritesDropped:{min:3,max:8},meteoriteTypes:["iron_meteorite","star_metal","celestial_ore"],rareMeteoriteChance:.1,rareMeteoriteTypes:["void_crystal","fallen_star_core"],impactGlowDuration:300,lightIntensityPulses:!0},soundLoop:"meteor_ambient",impactSound:"meteor_impact"},AURORA:{id:"aurora",name:"Aurora Borealis",description:"Mystical lights dance across the sky, enhancing magical power",triggerConditions:{biomes:["mountain","tundra"],dayPhase:"NIGHT",chance:.08,weather:[ms.CLEAR,ms.SNOW]},duration:8,visuals:{colors:[new H(.2,.8,.4),new H(.3,.4,.9),new H(.6,.2,.8)],waveSpeed:.5,intensity:.7},effects:{magicDamageMultiplier:1.25,manaCostReduction:.2,manaRegenMultiplier:1.5,rareHerbSpawns:["aurora_flower","starlight_moss","frost_bloom"],enemyAggroRangeMultiplier:.7},soundLoop:"aurora_hum"},SOLAR_ECLIPSE:{id:"solar_eclipse",name:"Solar Eclipse",description:"The sun is devoured, bringing unnatural darkness at noon",triggerConditions:{dayPhase:"DAY",hourRange:{min:10,max:14},chance:.01,dayInterval:30},duration:2,visuals:{sunColor:new H(.1,.1,.1),coronaColor:new H(.8,.3,.1),ambientDarkness:.2,skyColor:new H(.1,.05,.15)},effects:{nightCreaturesActive:!0,shadowDamageMultiplier:2,lightDamageMultiplier:.5,bossSpawn:"eclipse_devourer",unlockRecipes:["eclipse_blade","corona_shield","twilight_essence"]},soundLoop:"eclipse_ambient",startSound:"eclipse_begin"},SPIRIT_NIGHT:{id:"spirit_night",name:"Night of Spirits",description:"The veil between worlds thins, allowing spirits to wander",triggerConditions:{moonPhase:0,chance:.08,dayPhase:"NIGHT"},duration:10,visuals:{spiritGlow:new H(.4,.6,.9),fogType:"ethereal",ambientParticles:"spirit_wisps"},effects:{ghostNPCsActive:!0,ghostQuests:["lost_soul","unfinished_business","ancestral_blessing"],spiritEnemyMultiplier:2,physicalDamageReduction:.3,deadNPCDialogue:!0,spiritDrops:["ectoplasm","spirit_essence","soul_fragment","ghost_lantern"]},soundLoop:"spirit_whispers"}};function oT(l,e){const t=Bo[l];if(!t)return!1;const i=t.triggerConditions;if(i.moonPhase!==void 0&&e.moonPhase!==i.moonPhase||i.dayPhase&&e.dayPhase!==i.dayPhase)return!1;if(i.minHour!==void 0){const s=e.currentHour;if(i.minHour>i.maxHour){if(s<i.minHour&&s>i.maxHour)return!1}else if(s<i.minHour||s>i.maxHour)return!1}return i.weather&&!i.weather.includes(e.currentWeather)||i.biomes&&!i.biomes.includes(e.currentBiome)||i.dayInterval&&e.currentDay%i.dayInterval!==0?!1:Math.random()<i.chance}class rT{constructor(e){this.scene=e,this.timeManager=null,this.weatherManager=null,this.lighting=null,this.activeEvent=null,this.eventStartTime=0,this.eventDuration=0,this.lastEventCheck=0,this.eventCheckInterval=3e5,this.eventCooldowns=new Map,this.eventCooldownDuration=36e5,this.eventParticles=null,this.eventLights=[],this.meteorites=[],this.onEventStart=null,this.onEventEnd=null,this.createEventUI(),this.originalLightingState=null,console.log("[RareEventManager] Initialized")}initialize(){if(this.timeManager=Km(),this.weatherManager=Zm(),this.lighting=YS(),this.timeManager){const e=this.timeManager.onHourChange;this.timeManager.onHourChange=t=>{e&&e(t),this.checkForRareEvents()}}this.load()}createEventUI(){if(document.getElementById("rare-event-banner"))return;const e=document.createElement("div");e.id="rare-event-banner",e.className="hidden",e.innerHTML=`
      <div class="event-icon"></div>
      <div class="event-content">
        <div class="event-name">Event Name</div>
        <div class="event-desc">Event description...</div>
      </div>
    `;const t=document.createElement("style");t.textContent=`
      #rare-event-banner {
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(-20px);
        background: linear-gradient(135deg, rgba(60, 20, 40, 0.95), rgba(80, 30, 50, 0.9));
        border: 3px solid rgba(200, 100, 100, 0.7);
        border-radius: 12px;
        padding: 16px 32px;
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 300;
        opacity: 0;
        transition: opacity 0.5s, transform 0.5s;
        box-shadow: 0 0 40px rgba(200, 50, 50, 0.4);
      }
      
      #rare-event-banner.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
      
      #rare-event-banner.hidden {
        pointer-events: none;
      }
      
      #rare-event-banner .event-icon {
        font-size: 48px;
        filter: drop-shadow(0 0 10px rgba(255, 100, 100, 0.5));
        animation: event-pulse 2s infinite;
      }
      
      @keyframes event-pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
      
      #rare-event-banner .event-name {
        font-family: 'Cinzel', serif;
        font-size: 24px;
        color: #ffd0a0;
        text-shadow: 0 0 10px rgba(255, 150, 100, 0.5);
        margin-bottom: 4px;
      }
      
      #rare-event-banner .event-desc {
        font-family: 'Crimson Text', serif;
        font-size: 14px;
        color: #c4a080;
        font-style: italic;
      }
      
      /* Blood Moon specific */
      #rare-event-banner.blood-moon {
        background: linear-gradient(135deg, rgba(100, 20, 20, 0.95), rgba(60, 10, 10, 0.9));
        border-color: rgba(200, 50, 50, 0.8);
        box-shadow: 0 0 60px rgba(200, 30, 30, 0.6);
      }
      
      /* Meteor Shower specific */
      #rare-event-banner.meteor-shower {
        background: linear-gradient(135deg, rgba(40, 40, 80, 0.95), rgba(20, 20, 50, 0.9));
        border-color: rgba(150, 150, 255, 0.8);
        box-shadow: 0 0 40px rgba(100, 100, 200, 0.4);
      }
      
      /* Aurora specific */
      #rare-event-banner.aurora {
        background: linear-gradient(135deg, rgba(20, 60, 40, 0.95), rgba(20, 40, 60, 0.9));
        border-color: rgba(100, 200, 150, 0.8);
        box-shadow: 0 0 40px rgba(50, 200, 100, 0.4);
      }
      
      /* Eclipse specific */
      #rare-event-banner.solar-eclipse {
        background: linear-gradient(135deg, rgba(10, 10, 20, 0.95), rgba(30, 20, 40, 0.9));
        border-color: rgba(255, 200, 100, 0.8);
        box-shadow: 0 0 60px rgba(255, 150, 50, 0.5);
      }
      
      /* Spirit Night specific */
      #rare-event-banner.spirit-night {
        background: linear-gradient(135deg, rgba(40, 50, 80, 0.95), rgba(30, 40, 70, 0.9));
        border-color: rgba(150, 180, 255, 0.8);
        box-shadow: 0 0 40px rgba(100, 150, 255, 0.4);
      }
    `,document.head.appendChild(t),document.body.appendChild(e)}showEventBanner(e){const t=document.getElementById("rare-event-banner");if(!t)return;const i={blood_moon:"",meteor_shower:"",aurora:"",solar_eclipse:"",spirit_night:""};t.querySelector(".event-icon").textContent=i[e.id]||"",t.querySelector(".event-name").textContent=e.name,t.querySelector(".event-desc").textContent=e.description,t.className=e.id.replace(/_/g,"-"),setTimeout(()=>t.classList.add("visible"),50),setTimeout(()=>{t.classList.remove("visible"),setTimeout(()=>t.classList.add("hidden"),500)},8e3)}checkForRareEvents(){if(this.activeEvent)return;const e=Date.now();if(e-this.lastEventCheck<this.eventCheckInterval||(this.lastEventCheck=e,!this.timeManager))return;const t={currentHour:this.timeManager.currentHour,currentDay:this.timeManager.currentDay,moonPhase:this.timeManager.moonPhase,dayPhase:this.timeManager.dayPhase,currentWeather:this.weatherManager?.currentWeather||Ye.CLEAR,currentBiome:this.weatherManager?.currentBiome||"default"};for(const[i,s]of Object.entries(Bo)){const n=this.eventCooldowns.get(i)||0;if(!(e-n<this.eventCooldownDuration)&&oT(i,t)){this.startEvent(i);break}}}startEvent(e){const t=Bo[e];t&&(this.activeEvent=t,this.eventStartTime=Date.now(),this.eventDuration=t.duration*60*1e3,console.log(`[RareEventManager] Starting rare event: ${t.name}`),this.showEventBanner(t),this.storeLightingState(),this.applyEventVisuals(e),this.eventCooldowns.set(e,Date.now()),this.onEventStart&&this.onEventStart(t),this.save())}endEvent(){if(!this.activeEvent)return;const e=this.activeEvent;console.log(`[RareEventManager] Ending rare event: ${e.name}`),this.clearEventVisuals(),this.restoreLightingState(),this.onEventEnd&&this.onEventEnd(e),this.activeEvent=null,this.save()}storeLightingState(){this.lighting&&(this.originalLightingState={})}restoreLightingState(){}applyEventVisuals(e){const t=Bo[e];if(t?.visuals)switch(e){case"BLOOD_MOON":this.applyBloodMoonVisuals(t.visuals);break;case"METEOR_SHOWER":this.applyMeteorShowerVisuals(t.visuals);break;case"AURORA":this.applyAuroraVisuals(t.visuals);break;case"SOLAR_ECLIPSE":this.applyEclipseVisuals(t.visuals);break;case"SPIRIT_NIGHT":this.applySpiritNightVisuals(t.visuals);break}}applyBloodMoonVisuals(e){const t=new Vo(e.ambientTint,.3);t.name="bloodMoonAmbient",this.scene.add(t),this.eventLights.push(t),this.scene.fog&&this.scene.fog.color.copy(e.fogColor)}applyMeteorShowerVisuals(e){const t=e.particleCount||30,i=new Float32Array(t*3),s=new Float32Array(t*3),n=new Float32Array(t);for(let r=0;r<t;r++)i[r*3]=(Math.random()-.5)*200,i[r*3+1]=100+Math.random()*50,i[r*3+2]=(Math.random()-.5)*200,s[r*3]=(Math.random()-.5)*20,s[r*3+1]=-30-Math.random()*20,s[r*3+2]=(Math.random()-.5)*20,n[r]=Math.random()*10;const a=new mt;a.setAttribute("position",new Je(i,3)),a.setAttribute("velocity",new Je(s,3)),a.setAttribute("delay",new Je(n,1));const o=new Ri({color:e.trailColor,size:2,transparent:!0,opacity:.9,blending:ui});this.eventParticles=new Bi(a,o),this.eventParticles.userData.type="meteor",this.eventParticles.userData.elapsed=0,this.scene.add(this.eventParticles)}applyAuroraVisuals(e){const t=e.colors||[new H(.2,.8,.4),new H(.3,.4,.9)];for(let i=0;i<t.length;i++){const s=new Yy(t[i],e.intensity||.5,100,20);s.position.set((i-.5)*50,80,-50),s.lookAt(0,0,0),s.name=`auroraLight${i}`,this.scene.add(s),this.eventLights.push(s)}}applyEclipseVisuals(e){const t=new Vo(1118498,.1);t.name="eclipseAmbient",this.scene.add(t),this.eventLights.push(t);const i=new We(e.coronaColor,2,200);i.position.set(0,100,0),i.name="coronaLight",this.scene.add(i),this.eventLights.push(i),this.scene.fog&&this.scene.fog.color.copy(e.skyColor)}applySpiritNightVisuals(e){const i=new Float32Array(150),s=new Float32Array(150);for(let r=0;r<50;r++)i[r*3]=(Math.random()-.5)*60,i[r*3+1]=1+Math.random()*8,i[r*3+2]=(Math.random()-.5)*60,s[r*3]=(Math.random()-.5)*.5,s[r*3+1]=(Math.random()-.5)*.3,s[r*3+2]=(Math.random()-.5)*.5;const n=new mt;n.setAttribute("position",new Je(i,3)),n.setAttribute("velocity",new Je(s,3));const a=new Ri({color:e.spiritGlow,size:1.5,transparent:!0,opacity:.6,blending:ui});this.eventParticles=new Bi(n,a),this.eventParticles.userData.type="spirit",this.scene.add(this.eventParticles);const o=new Vo(e.spiritGlow,.2);o.name="spiritAmbient",this.scene.add(o),this.eventLights.push(o)}clearEventVisuals(){this.eventParticles&&(this.scene.remove(this.eventParticles),this.eventParticles.geometry.dispose(),this.eventParticles.material.dispose(),this.eventParticles=null);for(const e of this.eventLights)this.scene.remove(e),e.dispose&&e.dispose();this.eventLights=[];for(const e of this.meteorites)this.scene.remove(e);this.meteorites=[]}getEventEffects(){return this.activeEvent?this.activeEvent.effects:null}isEventActive(e){return this.activeEvent?.id===e}getMeteoriteLocations(){return this.meteorites.map(e=>({position:e.position.clone(),type:e.userData.type,collected:e.userData.collected}))}collectMeteorite(e){if(e<0||e>=this.meteorites.length)return null;const t=this.meteorites[e];return t.userData.collected?null:(t.userData.collected=!0,t.visible=!1,{type:t.userData.type,position:t.position.clone()})}updateMeteorParticles(e){if(!this.eventParticles||this.eventParticles.userData.type!=="meteor")return;const t=this.eventParticles.geometry.attributes.position,i=this.eventParticles.geometry.attributes.velocity,s=this.eventParticles.geometry.attributes.delay;this.eventParticles.userData.elapsed+=e;for(let n=0;n<t.count;n++)this.eventParticles.userData.elapsed<s.array[n]||(t.array[n*3+1],t.array[n*3]+=i.array[n*3]*e,t.array[n*3+1]+=i.array[n*3+1]*e,t.array[n*3+2]+=i.array[n*3+2]*e,t.array[n*3+1]<0&&(this.spawnMeteorite(t.array[n*3],t.array[n*3+2]),t.array[n*3]=(Math.random()-.5)*200,t.array[n*3+1]=100+Math.random()*50,t.array[n*3+2]=(Math.random()-.5)*200,s.array[n]=this.eventParticles.userData.elapsed+Math.random()*5));t.needsUpdate=!0}spawnMeteorite(e,t){if(!this.activeEvent?.effects?.meteoritesDropped)return;const i=this.activeEvent.effects.meteoritesDropped.max||8;if(this.meteorites.length>=i)return;const s=this.activeEvent.effects;let n;if(Math.random()<(s.rareMeteoriteChance||0)){const d=s.rareMeteoriteTypes||["void_crystal"];n=d[Math.floor(Math.random()*d.length)]}else{const d=s.meteoriteTypes||["iron_meteorite"];n=d[Math.floor(Math.random()*d.length)]}const a=new re(.5,8,8),o=new B({color:16755200,transparent:!0,opacity:.8}),r=new w(a,o);r.position.set(e,.5,t),r.userData={type:n,collected:!1,spawnTime:Date.now()},this.scene.add(r),this.meteorites.push(r);const c=new We(16763904,3,20);c.position.set(e,2,t),this.scene.add(c);const h=()=>{c.intensity*=.9,c.intensity>.1?requestAnimationFrame(h):(this.scene.remove(c),c.dispose())};h()}updateSpiritParticles(e,t){if(!this.eventParticles||this.eventParticles.userData.type!=="spirit")return;const i=this.eventParticles.geometry.attributes.position,s=this.eventParticles.geometry.attributes.velocity,n=performance.now()*.001;for(let a=0;a<i.count;a++){if(i.array[a*3]+=(s.array[a*3]+Math.sin(n+a)*.3)*e,i.array[a*3+1]+=(s.array[a*3+1]+Math.cos(n*.7+a)*.2)*e,i.array[a*3+2]+=(s.array[a*3+2]+Math.sin(n*.5+a)*.3)*e,t){const o=i.array[a*3]-t.x,r=i.array[a*3+2]-t.z;Math.abs(o)>30&&(i.array[a*3]=t.x+(Math.random()-.5)*60),Math.abs(r)>30&&(i.array[a*3+2]=t.z+(Math.random()-.5)*60)}i.array[a*3+1]<1&&(i.array[a*3+1]=1),i.array[a*3+1]>10&&(i.array[a*3+1]=10)}i.needsUpdate=!0,this.eventParticles.material.opacity=.4+Math.sin(n*2)*.2}update(e,t=null){if(!this.activeEvent)return;if(Date.now()-this.eventStartTime>this.eventDuration){this.endEvent();return}switch(this.activeEvent.id){case"meteor_shower":this.updateMeteorParticles(e);break;case"spirit_night":this.updateSpiritParticles(e,t);break}const i=performance.now()*.001;for(const s of this.eventLights)s.name?.includes("aurora")?s.intensity=.3+Math.sin(i*.5+parseFloat(s.name.slice(-1))*2)*.2:s.name==="coronaLight"&&(s.intensity=1.5+Math.sin(i*3)*.5);for(const s of this.meteorites){if(s.userData.collected)continue;const n=(Date.now()-s.userData.spawnTime)/1e3,a=this.activeEvent.effects?.impactGlowDuration||300;n>a?s.visible=!1:s.material.opacity=.4+Math.sin(n*3)*.3}}forceEvent(e){this.activeEvent&&this.endEvent(),this.startEvent(e)}save(){const e={cooldowns:Object.fromEntries(this.eventCooldowns),activeEvent:this.activeEvent?.id||null,eventStartTime:this.eventStartTime};localStorage.setItem("ashen-rare-events",JSON.stringify(e))}load(){try{const e=localStorage.getItem("ashen-rare-events");if(e){const t=JSON.parse(e);if(t.cooldowns)for(const[i,s]of Object.entries(t.cooldowns))this.eventCooldowns.set(i,s);if(t.activeEvent&&t.eventStartTime){const i=Bo[t.activeEvent];if(i){const s=Date.now()-t.eventStartTime,n=i.duration*60*1e3;s<n&&(this.activeEvent=i,this.eventStartTime=t.eventStartTime,this.eventDuration=n,this.applyEventVisuals(t.activeEvent),console.log(`[RareEventManager] Resumed event: ${i.name}`))}}}}catch(e){console.warn("[RareEventManager] Failed to load state:",e)}}getDebugInfo(){return{activeEvent:this.activeEvent?.name||"None",timeRemaining:this.activeEvent?Math.ceil((this.eventDuration-(Date.now()-this.eventStartTime))/1e3)+"s":"N/A",meteorites:this.meteorites.filter(e=>!e.userData.collected).length,cooldowns:Object.fromEntries([...this.eventCooldowns.entries()].map(([e,t])=>[e,Math.max(0,Math.ceil((this.eventCooldownDuration-(Date.now()-t))/6e4))+"m"]))}}}let Kc=null;function lT(l){return Kc||(Kc=new rT(l)),Kc}const ri={KILL:"kill",GATHER:"gather",EXPLORE:"explore",DELIVER:"deliver",ESCORT:"escort",BOSS:"boss"},Ns={ACTIVE:"active",READY_TO_TURN_IN:"ready"},li={TRIVIAL:"trivial",EASY:"easy",NORMAL:"normal",HARD:"hard",ELITE:"elite",LEGENDARY:"legendary"},ke={KILL_ENEMY:"kill_enemy",KILL_ANY:"kill_any",GATHER_ITEM:"gather_item",VISIT_LOCATION:"visit_location",TALK_TO_NPC:"talk_to_npc",DELIVER_ITEM:"deliver_item",ESCORT_NPC:"escort_npc",DEFEAT_BOSS:"defeat_boss",USE_ITEM:"use_item",CRAFT_ITEM:"craft_item"},Sd={ELDER_MARCUS:{id:"elder_marcus",name:"Elder Marcus",title:"Village Elder",location:"ashvale_village",position:{x:0,y:0,z:5},icon:""},BLACKSMITH_GRETA:{id:"blacksmith_greta",name:"Greta",title:"Master Blacksmith",location:"ashvale_village",position:{x:15,y:0,z:10},icon:""},HUNTER_JORIK:{id:"hunter_jorik",name:"Jorik",title:"Beast Hunter",location:"forest_camp",position:{x:-30,y:0,z:40},icon:""},MAGE_SELENE:{id:"mage_selene",name:"Selene",title:"Arcane Scholar",location:"mage_tower",position:{x:50,y:0,z:-20},icon:""},GUARD_CAPTAIN_THERON:{id:"guard_captain_theron",name:"Captain Theron",title:"Guard Captain",location:"ashvale_village",position:{x:-10,y:0,z:0},icon:""},MERCHANT_LYDIA:{id:"merchant_lydia",name:"Lydia",title:"Traveling Merchant",location:"crossroads",position:{x:25,y:0,z:25},icon:""},HERBALIST_MIRA:{id:"herbalist_mira",name:"Mira",title:"Village Herbalist",location:"ashvale_village",position:{x:8,y:0,z:-5},icon:""},MYSTERIOUS_STRANGER:{id:"mysterious_stranger",name:"???",title:"Mysterious Stranger",location:"crossroads",position:{x:30,y:0,z:-30},icon:""}},cT={ASHVALE_VILLAGE:{id:"ashvale_village",name:"Ashvale Village",position:{x:0,y:0,z:0},radius:30},DARKWOOD_ENTRANCE:{id:"darkwood_entrance",name:"Darkwood Entrance",position:{x:-50,y:0,z:50},radius:15},ANCIENT_RUINS:{id:"ancient_ruins",name:"Ancient Ruins",position:{x:80,y:0,z:30},radius:25},CRYSTAL_CAVE:{id:"crystal_cave",name:"Crystal Cave",position:{x:-40,y:0,z:-60},radius:20},MOUNTAIN_PASS:{id:"mountain_pass",name:"Mountain Pass",position:{x:100,y:20,z:-50},radius:30},HAUNTED_CEMETERY:{id:"haunted_cemetery",name:"Haunted Cemetery",position:{x:-80,y:0,z:-20},radius:25},GOLEM_SANCTUM:{id:"golem_sanctum",name:"Golem Sanctum",position:{x:60,y:0,z:-80},radius:20},SHADOW_REALM_RIFT:{id:"shadow_realm_rift",name:"Shadow Realm Rift",position:{x:-100,y:0,z:0},radius:15}},Jt=(l=0,e=0,t=[])=>({gold:l,xp:e,items:t.map(i=>typeof i=="string"?{id:i,quantity:1}:i)}),Td={FIRST_STEPS:{id:"first_steps",title:"First Steps",description:"Elder Marcus wants you to prove yourself by eliminating a few of the wolves that have been threatening the village livestock.",type:ri.KILL,difficulty:li.EASY,recommendedLevel:1,giver:"elder_marcus",turnIn:"elder_marcus",objectives:[{id:"obj_1",type:ke.KILL_ENEMY,target:"wolf",targetName:"Wolves",required:3,current:0,isOptional:!1}],optionalObjectives:[{id:"opt_1",type:ke.KILL_ENEMY,target:"alpha_wolf",targetName:"Alpha Wolf",required:1,current:0,bonusReward:Jt(25,50)}],rewards:Jt(50,100,["health_potion"]),prerequisites:[],unlocks:["gathering_herbs","guard_duty"],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"Ah, a capable-looking adventurer! Our village has been troubled by wolves. Would you help us?",accept:"Thank you! Be careful out there, they lurk in the forest to the north.",progress:"Still hunting those wolves? Don't give up!",complete:"You've done it! The village is safer thanks to you."}},GATHERING_HERBS:{id:"gathering_herbs",title:"Gathering Herbs",description:"The village herbalist Mira needs healing herbs from the forest. Gather some for her remedy preparations.",type:ri.GATHER,difficulty:li.EASY,recommendedLevel:1,giver:"herbalist_mira",turnIn:"herbalist_mira",objectives:[{id:"obj_1",type:ke.GATHER_ITEM,target:"healing_herb",targetName:"Healing Herbs",required:5,current:0,isOptional:!1}],optionalObjectives:[{id:"opt_1",type:ke.GATHER_ITEM,target:"moonpetal",targetName:"Moonpetal",required:2,current:0,bonusReward:Jt(30,40,["mana_potion"])}],rewards:Jt(40,80,[{id:"health_potion",quantity:3}]),prerequisites:["first_steps"],unlocks:["miras_special_brew"],isRepeatable:!0,cooldownHours:6,timeLimitMinutes:0,dialogue:{intro:"Oh dear, I'm running low on healing herbs! Could you gather some from the forest?",accept:"Wonderful! Look for the green-leafed plants near water.",progress:"Keep searching! The herbs grow near streams.",complete:"Perfect! These are exactly what I needed."}},GUARD_DUTY:{id:"guard_duty",title:"Guard Duty",description:"Captain Theron needs help patrolling the village perimeter. Explore the key checkpoints and report any threats.",type:ri.EXPLORE,difficulty:li.EASY,recommendedLevel:2,giver:"guard_captain_theron",turnIn:"guard_captain_theron",objectives:[{id:"obj_1",type:ke.VISIT_LOCATION,target:"north_gate",targetName:"North Gate",position:{x:0,y:0,z:40},radius:10,required:1,current:0,isOptional:!1},{id:"obj_2",type:ke.VISIT_LOCATION,target:"east_tower",targetName:"East Watchtower",position:{x:35,y:0,z:0},radius:10,required:1,current:0,isOptional:!1},{id:"obj_3",type:ke.VISIT_LOCATION,target:"south_bridge",targetName:"South Bridge",position:{x:0,y:0,z:-35},radius:10,required:1,current:0,isOptional:!1}],optionalObjectives:[],rewards:Jt(60,120),prerequisites:["first_steps"],unlocks:["bandit_problem"],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"I need someone reliable to check our patrol points. Interested?",accept:"Head to the North Gate, East Watchtower, and South Bridge. Report back.",progress:"Still have checkpoints to visit. Keep moving.",complete:"All clear? Good. You've got potential, soldier."}},BANDIT_PROBLEM:{id:"bandit_problem",title:"The Bandit Problem",description:"Bandits have set up camp near the village. Captain Theron wants you to thin their numbers and recover stolen supplies.",type:ri.KILL,difficulty:li.NORMAL,recommendedLevel:3,giver:"guard_captain_theron",turnIn:"guard_captain_theron",objectives:[{id:"obj_1",type:ke.KILL_ENEMY,target:"bandit",targetName:"Bandits",required:8,current:0,isOptional:!1},{id:"obj_2",type:ke.GATHER_ITEM,target:"stolen_supplies",targetName:"Stolen Supplies",required:3,current:0,isOptional:!1,questItem:!0}],optionalObjectives:[{id:"opt_1",type:ke.KILL_ENEMY,target:"bandit_leader",targetName:"Bandit Leader",required:1,current:0,bonusReward:Jt(100,150,["iron_sword"])}],rewards:Jt(150,250,["leather_armor"]),prerequisites:["guard_duty"],unlocks:["the_captains_trust"],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"Those damn bandits have been raiding our supply caravans. We need to put a stop to this.",accept:"Their camp is east of the crossroads. Be careful - they're well armed.",progress:"Keep at it. Those bandits need to learn we're not easy prey.",complete:"Outstanding work! The roads are safer now."}},MIRAS_SPECIAL_BREW:{id:"miras_special_brew",title:"Mira's Special Brew",description:"Mira needs rare ingredients for a powerful healing elixir. Gather ingredients from dangerous areas.",type:ri.GATHER,difficulty:li.NORMAL,recommendedLevel:4,giver:"herbalist_mira",turnIn:"herbalist_mira",objectives:[{id:"obj_1",type:ke.GATHER_ITEM,target:"glowing_mushroom",targetName:"Glowing Mushrooms",required:5,current:0,isOptional:!1},{id:"obj_2",type:ke.GATHER_ITEM,target:"spider_venom",targetName:"Spider Venom Sacs",required:3,current:0,isOptional:!1},{id:"obj_3",type:ke.GATHER_ITEM,target:"crystal_water",targetName:"Crystal Spring Water",required:1,current:0,isOptional:!1}],optionalObjectives:[],rewards:Jt(100,200,[{id:"elixir_of_vitality",quantity:5},{id:"herbalism_kit",quantity:1}]),prerequisites:["gathering_herbs"],unlocks:[],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"I'm working on something special - but I need rare ingredients from... dangerous places.",accept:"Mushrooms from the cave, venom from forest spiders, and water from the crystal spring.",progress:"Did you find them all? These ingredients are quite rare.",complete:"Marvelous! Here, take some of the elixirs I made. You've earned them!"}},FORGE_MATERIALS:{id:"forge_materials",title:"Forge Materials",description:"Blacksmith Greta needs quality ore to forge better weapons. Mine iron ore from the nearby caves.",type:ri.GATHER,difficulty:li.NORMAL,recommendedLevel:3,giver:"blacksmith_greta",turnIn:"blacksmith_greta",objectives:[{id:"obj_1",type:ke.GATHER_ITEM,target:"iron_ore",targetName:"Iron Ore",required:10,current:0,isOptional:!1}],optionalObjectives:[{id:"opt_1",type:ke.GATHER_ITEM,target:"gold_ore",targetName:"Gold Ore",required:3,current:0,bonusReward:Jt(150,100)}],rewards:Jt(120,180,["steel_sword"]),prerequisites:[],unlocks:["master_craftsmanship"],isRepeatable:!0,cooldownHours:12,timeLimitMinutes:0,dialogue:{intro:"I'm running low on quality ore. The caves to the west have plenty, if you're brave enough.",accept:"Bring me iron ore - at least 10 pieces. Watch out for cave creatures.",progress:"Need more ore! The forge is hungry.",complete:"Fine ore! Here, let me craft something special for you."}},EXPLORE_THE_RUINS:{id:"explore_the_ruins",title:"Explore the Ruins",description:"Mage Selene has sensed magical energy from the ancient ruins. Explore them and report your findings.",type:ri.EXPLORE,difficulty:li.NORMAL,recommendedLevel:5,giver:"mage_selene",turnIn:"mage_selene",objectives:[{id:"obj_1",type:ke.VISIT_LOCATION,target:"ancient_ruins",targetName:"Ancient Ruins Entrance",position:{x:80,y:0,z:30},radius:15,required:1,current:0,isOptional:!1},{id:"obj_2",type:ke.VISIT_LOCATION,target:"ruins_altar",targetName:"Ruined Altar",position:{x:90,y:0,z:45},radius:8,required:1,current:0,isOptional:!1},{id:"obj_3",type:ke.GATHER_ITEM,target:"ancient_tablet",targetName:"Ancient Tablet",required:1,current:0,isOptional:!1,questItem:!0}],optionalObjectives:[],rewards:Jt(200,300,["arcane_ring"]),prerequisites:[],unlocks:["selenes_research"],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"I've detected strange magical signatures from the old ruins. Someone needs to investigate.",accept:"Explore the ruins, find the altar, and bring back any artifacts you find.",progress:"What have you discovered? The ruins hold many secrets.",complete:"Fascinating! This tablet... the writings speak of an ancient power. Thank you."}},MERCHANT_DELIVERY:{id:"merchant_delivery",title:"Special Delivery",description:"Lydia the merchant needs a package delivered to the blacksmith. Quick and simple.",type:ri.DELIVER,difficulty:li.EASY,recommendedLevel:2,giver:"merchant_lydia",turnIn:"blacksmith_greta",objectives:[{id:"obj_1",type:ke.DELIVER_ITEM,target:"merchant_package",targetName:"Lydia's Package",recipient:"blacksmith_greta",recipientName:"Greta",required:1,current:0,isOptional:!1,questItem:!0,autoReceived:!0}],optionalObjectives:[],rewards:Jt(30,50),prerequisites:[],unlocks:[],isRepeatable:!0,cooldownHours:4,timeLimitMinutes:30,dialogue:{intro:"I have a package for the blacksmith. Would you deliver it? I'll pay for your trouble.",accept:"Here's the package. Don't take too long - Greta is expecting it!",progress:"Please hurry! Greta needs that package.",complete:"Perfect timing! Here's your payment from Lydia."}},URGENT_MEDICINE:{id:"urgent_medicine",title:"Urgent Medicine",description:"A farmer outside village is sick. Deliver Mira's medicine before it's too late.",type:ri.DELIVER,difficulty:li.NORMAL,recommendedLevel:3,giver:"herbalist_mira",turnIn:"farmer_tom",objectives:[{id:"obj_1",type:ke.DELIVER_ITEM,target:"healing_medicine",targetName:"Mira's Medicine",recipient:"farmer_tom",recipientName:"Farmer Tom",position:{x:45,y:0,z:60},required:1,current:0,isOptional:!1,questItem:!0,autoReceived:!0}],optionalObjectives:[],rewards:Jt(80,120),prerequisites:[],unlocks:[],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:15,dialogue:{intro:"Please, help! Farmer Tom is gravely ill. I have the medicine but I cannot leave the village!",accept:"Take this medicine to Tom's farm, northeast of the village. Hurry!",progress:"Please! He doesn't have much time!",complete:"*cough* Thank you, stranger. Mira's medicine... I feel better already."}},ESCORT_THE_MERCHANT:{id:"escort_the_merchant",title:"Escort the Merchant",description:"Lydia needs protection traveling to the crossroads. Bandits have been active lately.",type:ri.ESCORT,difficulty:li.NORMAL,recommendedLevel:4,giver:"merchant_lydia",turnIn:"merchant_lydia",objectives:[{id:"obj_1",type:ke.ESCORT_NPC,target:"merchant_lydia",targetName:"Lydia",destination:"crossroads_market",destinationName:"Crossroads Market",destinationPosition:{x:50,y:0,z:50},destinationRadius:10,required:1,current:0,isOptional:!1,npcHealth:100,npcCurrentHealth:100}],optionalObjectives:[{id:"opt_1",type:ke.KILL_ENEMY,target:"bandit",targetName:"Ambushing Bandits",required:5,current:0,bonusReward:Jt(75,100)}],rewards:Jt(200,300,["merchant_discount_token"]),prerequisites:["merchant_delivery"],unlocks:[],isRepeatable:!0,cooldownHours:24,timeLimitMinutes:0,dialogue:{intro:"I need to get to the crossroads market, but the roads are dangerous. Will you escort me?",accept:"Stay close to me and keep those bandits away!",progress:"We must keep moving! Is the path clear?",complete:"We made it! Thank you for keeping me safe. Here's your reward."}},GOLEM_THREAT:{id:"golem_threat",title:"The Golem Threat",description:"An ancient golem has awakened in the ruins and threatens the region. Defeat it before it reaches the village.",type:ri.BOSS,difficulty:li.HARD,recommendedLevel:8,giver:"guard_captain_theron",turnIn:"guard_captain_theron",objectives:[{id:"obj_1",type:ke.DEFEAT_BOSS,target:"ancient_golem",targetName:"Ancient Golem",required:1,current:0,isOptional:!1}],optionalObjectives:[{id:"opt_1",type:ke.GATHER_ITEM,target:"golem_core",targetName:"Golem Power Core",required:1,current:0,bonusReward:Jt(500,500,["golem_shard_weapon"])}],rewards:Jt(500,800,["champions_armor"]),prerequisites:["explore_the_ruins"],unlocks:["shadow_wraith_hunt"],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"The earth shakes! The ruins have unleashed something terrible - an ancient golem!",accept:"Find the golem in the Golem Sanctum and destroy it. May the gods protect you.",progress:"The golem still lives? We can hear its footsteps from here!",complete:"Incredible! You've saved us all. You are a true champion!"}},SHADOW_WRAITH_HUNT:{id:"shadow_wraith_hunt",title:"Shadow Wraith Hunt",description:"A shadow wraith has been terrorizing travelers. Hunt it down and banish it from this realm.",type:ri.BOSS,difficulty:li.HARD,recommendedLevel:10,giver:"mage_selene",turnIn:"mage_selene",objectives:[{id:"obj_1",type:ke.DEFEAT_BOSS,target:"shadow_wraith",targetName:"Shadow Wraith",required:1,current:0,isOptional:!1}],optionalObjectives:[{id:"opt_1",type:ke.GATHER_ITEM,target:"wraith_essence",targetName:"Wraith Essence",required:1,current:0,bonusReward:Jt(300,400,["shadow_cloak"])}],rewards:Jt(600,1e3,["wraithbane_sword","shadow_ward_ring"]),prerequisites:["golem_threat"],unlocks:["the_final_challenge"],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"A creature of pure shadow haunts the cemetery. It must be stopped.",accept:"The Shadow Wraith dwells in the Haunted Cemetery. Take this enchanted oil - your weapon will need it.",progress:"The shadow still lingers? You must destroy its anchor to this world!",complete:"The shadow has dispersed! You've done what many thought impossible."}},THE_CAPTAINS_TRUST:{id:"the_captains_trust",title:"The Captain's Trust",description:"Captain Theron has a dangerous mission for someone he trusts. Investigate reports of cult activity.",type:ri.KILL,difficulty:li.HARD,recommendedLevel:6,giver:"guard_captain_theron",turnIn:"guard_captain_theron",objectives:[{id:"obj_1",type:ke.VISIT_LOCATION,target:"cult_hideout",targetName:"Hidden Cave",position:{x:-60,y:0,z:-40},radius:15,required:1,current:0,isOptional:!1},{id:"obj_2",type:ke.KILL_ENEMY,target:"cultist",targetName:"Dark Cultists",required:10,current:0,isOptional:!1},{id:"obj_3",type:ke.GATHER_ITEM,target:"cult_documents",targetName:"Cult Documents",required:1,current:0,isOptional:!1,questItem:!0}],optionalObjectives:[],rewards:Jt(300,400,["captains_signet"]),prerequisites:["bandit_problem"],unlocks:["cult_conspiracy"],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"You've proven yourself trustworthy. I have a delicate matter... cultists, operating near the village.",accept:"Find their hideout, deal with them, and bring me evidence of their plans.",progress:"What have you found? I need those documents.",complete:"This is worse than I feared. Thank you for bringing this to me."}},MASTER_CRAFTSMANSHIP:{id:"master_craftsmanship",title:"Master Craftsmanship",description:"Greta wants to forge a masterwork weapon. Help her gather rare materials from dangerous places.",type:ri.GATHER,difficulty:li.HARD,recommendedLevel:7,giver:"blacksmith_greta",turnIn:"blacksmith_greta",objectives:[{id:"obj_1",type:ke.GATHER_ITEM,target:"mithril_ore",targetName:"Mithril Ore",required:5,current:0,isOptional:!1},{id:"obj_2",type:ke.GATHER_ITEM,target:"fire_crystal",targetName:"Fire Crystals",required:3,current:0,isOptional:!1},{id:"obj_3",type:ke.GATHER_ITEM,target:"dragon_scale",targetName:"Dragon Scale",required:1,current:0,isOptional:!1}],optionalObjectives:[],rewards:Jt(400,600,["masterwork_weapon_choice"]),prerequisites:["forge_materials"],unlocks:[],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"I want to forge a TRUE masterwork - something legendary. But I need... impossible materials.",accept:"Mithril from the deep caves, fire crystals from the volcano, and... a dragon scale.",progress:"Keep searching. These materials don't come easy.",complete:"By the forge! You actually found everything! Watch this..."}},SELENES_RESEARCH:{id:"selenes_research",title:"Selene's Research",description:"Help Selene understand the ancient tablet by finding more artifacts in various locations.",type:ri.EXPLORE,difficulty:li.NORMAL,recommendedLevel:6,giver:"mage_selene",turnIn:"mage_selene",objectives:[{id:"obj_1",type:ke.VISIT_LOCATION,target:"crystal_cave",targetName:"Crystal Cave",position:{x:-40,y:0,z:-60},radius:20,required:1,current:0,isOptional:!1},{id:"obj_2",type:ke.GATHER_ITEM,target:"crystal_shard_artifact",targetName:"Crystal Shard Artifact",required:1,current:0,isOptional:!1,questItem:!0},{id:"obj_3",type:ke.VISIT_LOCATION,target:"mountain_shrine",targetName:"Mountain Shrine",position:{x:100,y:20,z:-50},radius:15,required:1,current:0,isOptional:!1}],optionalObjectives:[],rewards:Jt(250,350,["tome_of_knowledge"]),prerequisites:["explore_the_ruins"],unlocks:[],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"The tablet speaks of other sites of power. I need you to investigate them.",accept:"Visit the Crystal Cave and the Mountain Shrine. Bring back any artifacts you find.",progress:"Have you found the other sites? The magic grows stronger...",complete:"Yes! The pieces are coming together. The ancients were preparing for something..."}},STRANGER_INTRODUCTION:{id:"stranger_introduction",title:"A Mysterious Task",description:"A mysterious stranger offers gold for a simple task - gathering shadow essence from the night.",type:ri.GATHER,difficulty:li.NORMAL,recommendedLevel:5,giver:"mysterious_stranger",turnIn:"mysterious_stranger",objectives:[{id:"obj_1",type:ke.GATHER_ITEM,target:"shadow_essence",targetName:"Shadow Essence",required:5,current:0,isOptional:!1}],optionalObjectives:[{id:"opt_1",type:ke.GATHER_ITEM,target:"void_crystal",targetName:"Void Crystal",required:1,current:0,bonusReward:Jt(200,200)}],rewards:Jt(300,250),prerequisites:[],unlocks:["stranger_true_purpose"],isRepeatable:!1,cooldownHours:0,timeLimitMinutes:0,dialogue:{intro:"Ah, an adventurer. I have need of... certain materials. Shadow essence, gathered only at night.",accept:"Collect shadow essence from creatures of darkness. Return when you have enough.",progress:"Patience. The darkness yields its secrets slowly.",complete:"Excellent. You are more capable than you appear. Perhaps we can work together again."}},DAILY_HUNT:{id:"daily_hunt",title:"Daily Hunt",description:"Hunter Jorik has marked dangerous beasts in the area. Hunt them before sundown for a reward.",type:ri.KILL,difficulty:li.NORMAL,recommendedLevel:4,giver:"hunter_jorik",turnIn:"hunter_jorik",objectives:[{id:"obj_1",type:ke.KILL_ANY,target:"beast",targetName:"Wild Beasts",validTargets:["wolf","bear","boar","giant_spider"],required:10,current:0,isOptional:!1}],optionalObjectives:[{id:"opt_1",type:ke.GATHER_ITEM,target:"pristine_pelt",targetName:"Pristine Pelts",required:3,current:0,bonusReward:Jt(50,75)}],rewards:Jt(100,150),prerequisites:[],unlocks:[],isRepeatable:!0,cooldownHours:24,timeLimitMinutes:60,dailyReset:!0,dialogue:{intro:"The beasts are restless today. Hunt them before they become a real problem.",accept:"Kill 10 beasts - wolves, bears, whatever you find. Be quick about it.",progress:"Still hunting? Time's wasting, friend.",complete:"Good hunt! Here's your pay. Come back tomorrow for more work."}}},ff={[li.TRIVIAL]:{xpMult:.5,goldMult:.5,labelColor:"#888888"},[li.EASY]:{xpMult:.8,goldMult:.8,labelColor:"#44aa44"},[li.NORMAL]:{xpMult:1,goldMult:1,labelColor:"#aaaa44"},[li.HARD]:{xpMult:1.3,goldMult:1.3,labelColor:"#dd8844"},[li.ELITE]:{xpMult:1.6,goldMult:1.6,labelColor:"#dd4444"},[li.LEGENDARY]:{xpMult:2,goldMult:2,labelColor:"#aa44dd"}};function ei(l){return Td[l.toUpperCase()]||Object.values(Td).find(e=>e.id===l)}function Zc(l,e=[]){const t=ei(l);return t?!t.prerequisites||t.prerequisites.length===0?!0:t.prerequisites.every(i=>e.includes(i)):!1}function Ed(l){return Sd[l.toUpperCase()]||Object.values(Sd).find(e=>e.id===l)}const cl=10,mf="ashen_quest_state";class hT{constructor(){this.activeQuests=new Map,this.completedQuests=new Set,this.availableQuests=new Set,this.failedQuests=new Set,this.questCooldowns=new Map,this.questStartTimes=new Map,this.eventListeners={onQuestAccepted:[],onObjectiveProgress:[],onObjectiveComplete:[],onQuestComplete:[],onQuestTurnedIn:[],onQuestFailed:[],onQuestAbandoned:[],onQuestAvailable:[]},this.questUI=null,this.questMarkers=new Map,this.playerInventory=null,this.playerStats=null,this.loadState(),this.updateAvailableQuests()}init(e={}){this.playerInventory=e.inventory||null,this.playerStats=e.stats||null,this.scene=e.scene||null,this.createQuestUI(),this.startTimedQuestChecker(),console.log("[QuestManager] Initialized with",this.activeQuests.size,"active quests")}acceptQuest(e){const t=ei(e);if(!t)return console.warn(`[QuestManager] Quest not found: ${e}`),{success:!1,reason:"Quest not found"};if(this.activeQuests.has(e))return{success:!1,reason:"Quest already active"};if(this.completedQuests.has(e)&&!t.isRepeatable)return{success:!1,reason:"Quest already completed"};if(t.isRepeatable&&this.questCooldowns.has(e)){const s=this.questCooldowns.get(e);if(Date.now()<s)return{success:!1,reason:`Quest on cooldown (${Math.ceil((s-Date.now())/6e4)} min remaining)`}}if(this.activeQuests.size>=cl)return{success:!1,reason:`Max ${cl} active quests`};if(!Zc(e,Array.from(this.completedQuests)))return{success:!1,reason:"Prerequisites not met"};const i={id:e,status:Ns.ACTIVE,objectives:t.objectives.map(s=>({...s,current:0})),optionalObjectives:(t.optionalObjectives||[]).map(s=>({...s,current:0})),acceptedAt:Date.now(),timeLimit:t.timeLimitMinutes?t.timeLimitMinutes*60*1e3:null};return this.activeQuests.set(e,i),this.questStartTimes.set(e,Date.now()),this.availableQuests.delete(e),t.objectives.forEach(s=>{s.autoReceived&&s.questItem&&this.playerInventory&&this.playerInventory.addItem({id:s.target,quantity:1,isQuestItem:!0})}),this.emit("onQuestAccepted",{questId:e,quest:t,state:i}),this.updateQuestUI(),this.saveState(),this.showNotification(`Quest Accepted: ${t.title}`,"accept"),console.log(`[QuestManager] Accepted quest: ${t.title}`),{success:!0,quest:t}}updateProgress(e,t,i=1){let s=!1;return this.activeQuests.forEach((n,a)=>{ei(a)&&(n.objectives.forEach((r,c)=>{if(this.objectiveMatches(r,e,t)&&r.current<r.required){const h=r.current;r.current=Math.min(r.current+i,r.required),r.current>h&&(s=!0,this.emit("onObjectiveProgress",{questId:a,objectiveId:r.id,objective:r,progress:r.current,required:r.required}),r.current>=r.required?(this.emit("onObjectiveComplete",{questId:a,objectiveId:r.id,objective:r}),this.showNotification(`Objective Complete: ${r.targetName}`,"progress")):this.showNotification(`${r.targetName}: ${r.current}/${r.required}`,"progress",!0))}}),(n.optionalObjectives||[]).forEach(r=>{this.objectiveMatches(r,e,t)&&r.current<r.required&&(r.current=Math.min(r.current+i,r.required),r.current>=r.required&&this.showNotification(`Bonus Objective: ${r.targetName}`,"bonus"))}),this.checkQuestCompletion(a))}),s&&(this.updateQuestUI(),this.saveState()),s}objectiveMatches(e,t,i){return({kill:[ke.KILL_ENEMY,ke.KILL_ANY,ke.DEFEAT_BOSS],gather:[ke.GATHER_ITEM],explore:[ke.VISIT_LOCATION],deliver:[ke.DELIVER_ITEM],escort:[ke.ESCORT_NPC],boss:[ke.DEFEAT_BOSS],talk:[ke.TALK_TO_NPC],use:[ke.USE_ITEM],craft:[ke.CRAFT_ITEM]}[t]||[t]).includes(e.type)?e.type===ke.KILL_ANY&&e.validTargets?e.validTargets.includes(i):e.target===i||e.target===i.toLowerCase():!1}checkQuestCompletion(e){const t=this.activeQuests.get(e);if(!t)return!1;if(t.objectives.every(s=>s.current>=s.required)&&t.status!==Ns.READY_TO_TURN_IN){t.status=Ns.READY_TO_TURN_IN;const s=ei(e);return this.emit("onQuestComplete",{questId:e,quest:s,state:t}),this.showNotification(`Quest Complete: ${s.title}`,"complete"),console.log(`[QuestManager] Quest ready for turn-in: ${s.title}`),!0}return!1}turnInQuest(e){const t=this.activeQuests.get(e);if(!t)return{success:!1,reason:"Quest not active"};if(t.status!==Ns.READY_TO_TURN_IN)return{success:!1,reason:"Quest objectives not complete"};const i=ei(e),s={...i.rewards};let n={gold:0,xp:0,items:[]};(t.optionalObjectives||[]).forEach(c=>{c.current>=c.required&&c.bonusReward&&(n.gold+=c.bonusReward.gold||0,n.xp+=c.bonusReward.xp||0,n.items.push(...c.bonusReward.items||[]))});const a=s.gold+n.gold,o=s.xp+n.xp,r=[...s.items||[],...n.items];if(this.playerStats&&(a>0&&this.playerStats.addGold(a),o>0&&this.playerStats.addXp(o)),this.playerInventory&&r.length>0&&r.forEach(c=>{this.playerInventory.addItem({id:c.id,quantity:c.quantity||1})}),i.objectives.forEach(c=>{c.questItem&&this.playerInventory&&this.playerInventory.removeItem(c.target,c.required)}),this.activeQuests.delete(e),this.completedQuests.add(e),this.questStartTimes.delete(e),i.isRepeatable&&i.cooldownHours>0){const c=Date.now()+i.cooldownHours*60*60*1e3;this.questCooldowns.set(e,c)}return i.unlocks&&i.unlocks.forEach(c=>{Zc(c,Array.from(this.completedQuests))&&(this.availableQuests.add(c),this.emit("onQuestAvailable",{questId:c}))}),this.emit("onQuestTurnedIn",{questId:e,quest:i,rewards:{gold:a,xp:o,items:r}}),this.updateQuestUI(),this.updateAvailableQuests(),this.saveState(),this.showRewardNotification(a,o,r),console.log(`[QuestManager] Turned in quest: ${i.title}`),{success:!0,rewards:{gold:a,xp:o,items:r}}}abandonQuest(e){if(!this.activeQuests.get(e))return{success:!1,reason:"Quest not active"};const i=ei(e);return i.objectives.forEach(s=>{s.questItem&&this.playerInventory&&this.playerInventory.removeItem(s.target)}),this.activeQuests.delete(e),this.questStartTimes.delete(e),(!i.isRepeatable||!this.completedQuests.has(e))&&this.availableQuests.add(e),this.emit("onQuestAbandoned",{questId:e,quest:i}),this.updateQuestUI(),this.saveState(),this.showNotification(`Quest Abandoned: ${i.title}`,"abandon"),console.log(`[QuestManager] Abandoned quest: ${i.title}`),{success:!0}}failQuest(e,t="Failed"){if(!this.activeQuests.get(e))return;const s=ei(e);if(s.objectives.forEach(n=>{n.questItem&&this.playerInventory&&this.playerInventory.removeItem(n.target)}),this.activeQuests.delete(e),this.questStartTimes.delete(e),s.isRepeatable){const n=Date.now()+18e5;this.questCooldowns.set(e,n)}else this.failedQuests.add(e);this.emit("onQuestFailed",{questId:e,quest:s,reason:t}),this.updateQuestUI(),this.saveState(),this.showNotification(`Quest Failed: ${s.title} - ${t}`,"fail"),console.log(`[QuestManager] Quest failed: ${s.title} - ${t}`)}startTimedQuestChecker(){setInterval(()=>{const e=Date.now();this.activeQuests.forEach((t,i)=>{t.timeLimit&&e-t.acceptedAt>=t.timeLimit&&this.failQuest(i,"Time expired")}),this.questCooldowns.forEach((t,i)=>{if(e>=t){this.questCooldowns.delete(i);const s=ei(i);s&&s.isRepeatable&&this.availableQuests.add(i)}})},5e3)}updateAvailableQuests(){const e=Array.from(this.completedQuests);Object.values(Td).forEach(t=>{const i=t.id;if(!this.activeQuests.has(i)&&!(this.completedQuests.has(i)&&!t.isRepeatable)&&!this.failedQuests.has(i)){if(this.questCooldowns.has(i)){if(Date.now()<this.questCooldowns.get(i))return;this.questCooldowns.delete(i)}Zc(i,e)?this.availableQuests.add(i):this.availableQuests.delete(i)}})}getAvailableQuestsForNpc(e){return Array.from(this.availableQuests).map(t=>ei(t)).filter(t=>t&&t.giver===e)}getTurnInQuestsForNpc(e){const t=[];return this.activeQuests.forEach((i,s)=>{const n=ei(s);n&&n.turnIn===e&&i.status===Ns.READY_TO_TURN_IN&&t.push({quest:n,state:i})}),t}checkLocation(e){this.activeQuests.forEach((t,i)=>{t.objectives.forEach(s=>{if(s.type===ke.VISIT_LOCATION&&s.current<s.required){const n=s.position,a=s.radius||10,o=e.x-n.x,r=e.z-n.z;Math.sqrt(o*o+r*r)<=a&&this.updateProgress("explore",s.target,1)}}),t.objectives.forEach(s=>{if(s.type===ke.ESCORT_NPC&&s.destinationPosition){const n=s.destinationPosition,a=s.destinationRadius||10,o=e.x-n.x,r=e.z-n.z;Math.sqrt(o*o+r*r)<=a&&(s.current=s.required,this.checkQuestCompletion(i))}})})}on(e,t){return this.eventListeners[e]&&this.eventListeners[e].push(t),()=>this.off(e,t)}off(e,t){this.eventListeners[e]&&(this.eventListeners[e]=this.eventListeners[e].filter(i=>i!==t))}emit(e,t){this.eventListeners[e]&&this.eventListeners[e].forEach(i=>{try{i(t)}catch(s){console.error("[QuestManager] Event handler error:",s)}})}saveState(){const e={activeQuests:Array.from(this.activeQuests.entries()),completedQuests:Array.from(this.completedQuests),failedQuests:Array.from(this.failedQuests),questCooldowns:Array.from(this.questCooldowns.entries()),questStartTimes:Array.from(this.questStartTimes.entries())};try{localStorage.setItem(mf,JSON.stringify(e))}catch(t){console.warn("[QuestManager] Failed to save state:",t)}}loadState(){try{const e=localStorage.getItem(mf);if(!e)return;const t=JSON.parse(e);this.activeQuests=new Map(t.activeQuests||[]),this.completedQuests=new Set(t.completedQuests||[]),this.failedQuests=new Set(t.failedQuests||[]),this.questCooldowns=new Map(t.questCooldowns||[]),this.questStartTimes=new Map(t.questStartTimes||[]),console.log("[QuestManager] Loaded state:",{active:this.activeQuests.size,completed:this.completedQuests.size})}catch(e){console.warn("[QuestManager] Failed to load state:",e)}}resetAllProgress(){this.activeQuests.clear(),this.completedQuests.clear(),this.failedQuests.clear(),this.questCooldowns.clear(),this.questStartTimes.clear(),this.updateAvailableQuests(),this.updateQuestUI(),this.saveState(),console.log("[QuestManager] Reset all progress")}createQuestUI(){const e=document.getElementById("quest-tracker");e&&e.remove();const t=document.createElement("div");t.id="quest-tracker",t.innerHTML=`
      <style>
        #quest-tracker {
          position: fixed;
          top: 120px;
          right: 10px;
          width: 280px;
          max-height: 400px;
          background: rgba(0, 0, 0, 0.75);
          border: 1px solid #444;
          border-radius: 8px;
          color: #fff;
          font-family: 'Segoe UI', sans-serif;
          font-size: 12px;
          z-index: 1000;
          overflow: hidden;
        }
        
        #quest-tracker-header {
          background: linear-gradient(180deg, #3a3a3a, #2a2a2a);
          padding: 8px 12px;
          font-weight: bold;
          font-size: 14px;
          border-bottom: 1px solid #444;
          cursor: pointer;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        #quest-tracker-header:hover {
          background: linear-gradient(180deg, #4a4a4a, #3a3a3a);
        }
        
        #quest-tracker-content {
          max-height: 340px;
          overflow-y: auto;
          padding: 8px;
        }
        
        .quest-entry {
          background: rgba(50, 50, 50, 0.6);
          border-radius: 6px;
          padding: 8px;
          margin-bottom: 8px;
        }
        
        .quest-entry:last-child {
          margin-bottom: 0;
        }
        
        .quest-title {
          font-weight: bold;
          font-size: 13px;
          margin-bottom: 6px;
          display: flex;
          justify-content: space-between;
        }
        
        .quest-title-text {
          color: #ffd700;
        }
        
        .quest-status {
          font-size: 10px;
          padding: 2px 6px;
          border-radius: 3px;
        }
        
        .quest-status.ready { background: #2d5a2d; color: #7fff7f; }
        .quest-status.active { background: #3a3a3a; color: #aaa; }
        
        .quest-objective {
          display: flex;
          align-items: center;
          margin: 4px 0;
          font-size: 11px;
        }
        
        .quest-objective.complete {
          color: #7fff7f;
          text-decoration: line-through;
          opacity: 0.7;
        }
        
        .quest-objective.optional {
          color: #aaaaff;
        }
        
        .objective-icon {
          margin-right: 6px;
          font-size: 10px;
        }
        
        .objective-progress {
          margin-left: auto;
          color: #aaa;
        }
        
        .quest-time {
          font-size: 10px;
          color: #ff8844;
          margin-top: 4px;
        }
        
        #quest-notification {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.9);
          border: 2px solid #ffd700;
          border-radius: 10px;
          padding: 20px 40px;
          color: #fff;
          font-family: 'Segoe UI', sans-serif;
          z-index: 2000;
          text-align: center;
          opacity: 0;
          pointer-events: none;
          transition: opacity 0.3s;
        }
        
        #quest-notification.show {
          opacity: 1;
        }
        
        #quest-notification.accept { border-color: #4488ff; }
        #quest-notification.complete { border-color: #44ff44; }
        #quest-notification.fail { border-color: #ff4444; }
        #quest-notification.abandon { border-color: #888; }
        
        #quest-notification-title {
          font-size: 18px;
          font-weight: bold;
          margin-bottom: 8px;
        }
        
        #quest-notification-text {
          font-size: 14px;
          color: #ccc;
        }
        
        .quest-empty {
          color: #666;
          text-align: center;
          padding: 20px;
          font-style: italic;
        }
      </style>
      
      <div id="quest-tracker-header">
        <span> Active Quests</span>
        <span id="quest-count">0/${cl}</span>
      </div>
      
      <div id="quest-tracker-content">
        <div class="quest-empty">No active quests</div>
      </div>
    `;const i=document.createElement("div");i.id="quest-notification",i.innerHTML=`
      <div id="quest-notification-title"></div>
      <div id="quest-notification-text"></div>
    `,document.body.appendChild(t),document.body.appendChild(i);const s=document.getElementById("quest-tracker-header"),n=document.getElementById("quest-tracker-content");let a=!1;s.addEventListener("click",()=>{a=!a,n.style.display=a?"none":"block"}),this.questUI=t,this.updateQuestUI()}updateQuestUI(){const e=document.getElementById("quest-tracker-content"),t=document.getElementById("quest-count");if(!e)return;if(t.textContent=`${this.activeQuests.size}/${cl}`,this.activeQuests.size===0){e.innerHTML='<div class="quest-empty">No active quests</div>';return}let i="";this.activeQuests.forEach((s,n)=>{const a=ei(n);if(!a)return;const o=s.status===Ns.READY_TO_TURN_IN,r=o?"ready":"active",c=o?"Turn In":"In Progress";if(i+=`
        <div class="quest-entry" data-quest-id="${n}">
          <div class="quest-title">
            <span class="quest-title-text">${a.title}</span>
            <span class="quest-status ${r}">${c}</span>
          </div>
      `,s.objectives.forEach(h=>{const d=h.current>=h.required,u=this.getObjectiveIcon(h.type);i+=`
          <div class="quest-objective ${d?"complete":""}">
            <span class="objective-icon">${u}</span>
            <span>${h.targetName}</span>
            <span class="objective-progress">${h.current}/${h.required}</span>
          </div>
        `}),(s.optionalObjectives||[]).forEach(h=>{const d=h.current>=h.required;this.getObjectiveIcon(h.type),i+=`
          <div class="quest-objective optional ${d?"complete":""}">
            <span class="objective-icon"></span>
            <span>(Bonus) ${h.targetName}</span>
            <span class="objective-progress">${h.current}/${h.required}</span>
          </div>
        `}),s.timeLimit){const h=Date.now()-s.acceptedAt,d=Math.max(0,s.timeLimit-h),u=Math.floor(d/6e4),p=Math.floor(d%6e4/1e3);i+=`<div class="quest-time"> Time: ${u}:${p.toString().padStart(2,"0")}</div>`}i+="</div>"}),e.innerHTML=i}getObjectiveIcon(e){return{[ke.KILL_ENEMY]:"",[ke.KILL_ANY]:"",[ke.GATHER_ITEM]:"",[ke.VISIT_LOCATION]:"",[ke.TALK_TO_NPC]:"",[ke.DELIVER_ITEM]:"",[ke.ESCORT_NPC]:"",[ke.DEFEAT_BOSS]:"",[ke.USE_ITEM]:"",[ke.CRAFT_ITEM]:""}[e]||""}showNotification(e,t="info",i=!1){const s=document.getElementById("quest-notification");if(!s)return;const n=document.getElementById("quest-notification-title"),a=document.getElementById("quest-notification-text");s.className=`show ${t}`,t==="accept"?(n.textContent=" Quest Accepted",a.textContent=e.replace("Quest Accepted: ","")):t==="complete"?(n.textContent=" Quest Complete!",a.textContent=e.replace("Quest Complete: ","")):t==="fail"?(n.textContent=" Quest Failed",a.textContent=e.replace("Quest Failed: ","")):t==="progress"?(n.textContent=" Progress",a.textContent=e):t==="bonus"?(n.textContent=" Bonus Complete!",a.textContent=e):(n.textContent=e,a.textContent=""),setTimeout(()=>{s.classList.remove("show")},i?1500:3e3)}showRewardNotification(e,t,i){const s=document.getElementById("quest-notification");if(!s)return;const n=document.getElementById("quest-notification-title"),a=document.getElementById("quest-notification-text");s.className="show complete",n.textContent=" Rewards!";let o="";e>0&&(o+=` ${e} Gold  `),t>0&&(o+=` ${t} XP  `),i.length>0&&(o+=i.map(r=>` ${r.quantity||1}x ${r.id}`).join("  ")),a.textContent=o,setTimeout(()=>{s.classList.remove("show")},4e3)}getQuestState(e){return this.activeQuests.get(e)}getActiveQuests(){return Array.from(this.activeQuests.entries()).map(([e,t])=>({id:e,quest:ei(e),state:t}))}getCompletedQuests(){return Array.from(this.completedQuests)}getAvailableQuests(){return Array.from(this.availableQuests)}hasActiveQuest(e){return this.activeQuests.has(e)}hasCompletedQuest(e){return this.completedQuests.has(e)}getQuestMarkers(){const e=[];return this.availableQuests.forEach(t=>{const i=ei(t);if(!i)return;const s=Ed(i.giver);s&&e.push({type:"available",position:s.position,questId:t,npcId:i.giver,icon:"!",color:"#ffff00"})}),this.activeQuests.forEach((t,i)=>{const s=ei(i);if(s){if(t.status===Ns.READY_TO_TURN_IN){const n=Ed(s.turnIn);n&&e.push({type:"turn_in",position:n.position,questId:i,npcId:s.turnIn,icon:"?",color:"#ffff00"})}t.objectives.forEach(n=>{n.current>=n.required||(n.type===ke.VISIT_LOCATION&&n.position&&e.push({type:"objective",position:n.position,questId:i,objectiveId:n.id,icon:"",color:"#44aaff"}),n.type===ke.ESCORT_NPC&&n.destinationPosition&&e.push({type:"destination",position:n.destinationPosition,questId:i,objectiveId:n.id,icon:"",color:"#44ff44"}))})}}),e}shouldDropQuestItem(e){let t=!1;return this.activeQuests.forEach(i=>{i.objectives.forEach(s=>{s.questItem&&s.target===e&&s.current<s.required&&(t=!0)})}),t}}let Cl=null;function dT(){return Cl||(Cl=new hT),Cl}function Jm(){return Cl}const gf=3,yf=32,uT=2,pT=4521983;class fT{constructor(){this.questManager=null,this.scene=null,this.explorationMarkers=new Map,this.questEnemySpawns=new Map,this.questItemEffects=new Map,this.animationTime=0,this.enemyManager=null,this.itemManager=null,this.npcManager=null,this.bossManager=null,this.boundHandlers={}}init(e={}){this.questManager=e.questManager||Jm(),this.scene=e.scene||null,this.enemyManager=e.enemyManager||null,this.itemManager=e.itemManager||null,this.npcManager=e.npcManager||null,this.bossManager=e.bossManager||null,this.player=e.player||null,this.setupQuestListeners(),this.setupWorldHooks(),this.updateExplorationMarkers(),console.log("[QuestWorldHooks] Initialized")}setupQuestListeners(){this.questManager&&(this.questManager.on("onQuestAccepted",e=>{this.onQuestAccepted(e.questId,e.quest)}),this.questManager.on("onQuestTurnedIn",e=>{this.onQuestEnded(e.questId)}),this.questManager.on("onQuestAbandoned",e=>{this.onQuestEnded(e.questId)}),this.questManager.on("onQuestFailed",e=>{this.onQuestEnded(e.questId)}),this.questManager.on("onObjectiveComplete",e=>{this.updateExplorationMarkers()}))}setupWorldHooks(){console.log("[QuestWorldHooks] World hooks ready")}onEnemyKilled(e,t={}){if(this.questManager&&(this.questManager.updateProgress("kill",e,1),this.checkQuestItemDrop(e,t),this.questEnemySpawns.has(e))){const i=this.questEnemySpawns.get(e);i.killed=(i.killed||0)+1}}onBossKilled(e,t={}){this.questManager&&(this.questManager.updateProgress("boss",e,1),this.questManager.updateProgress("kill",e,1),this.checkQuestItemDrop(e,t),console.log(`[QuestWorldHooks] Boss killed: ${e}`))}onItemPickup(e,t=1){this.questManager&&(this.questManager.updateProgress("gather",e,t),this.questItemEffects.has(e)&&this.removeQuestItemEffect(e))}checkQuestItemDrop(e,t={}){if(!this.questManager)return null;const i=this.questManager.getActiveQuests();for(const{id:s,quest:n,state:a}of i)for(const o of a.objectives)if(o.questItem&&o.current<o.required&&this.canDropQuestItem(e,o.target,t))return{itemId:o.target,questId:s,dropChance:1};return null}canDropQuestItem(e,t,i={}){return({stolen_supplies:["bandit","bandit_leader"],cult_documents:["cultist","cult_leader"],spider_venom:["giant_spider","spider"],pristine_pelt:["wolf","bear","boar"],shadow_essence:["shadow_stalker","wraith","phantom"],golem_core:["ancient_golem"],wraith_essence:["shadow_wraith"],dragon_scale:["dragon","drake"]}[t]||[]).includes(e)}onAreaEnter(e){this.questManager&&(this.questManager.updateProgress("explore",e,1),this.removeExplorationMarker(e))}updatePlayerPosition(e){this.questManager&&(this.questManager.checkLocation(e),this.checkExplorationMarkers(e))}checkExplorationMarkers(e){this.explorationMarkers.forEach((t,i)=>{const s=e.x-t.position.x,n=e.z-t.position.z,a=Math.sqrt(s*s+n*n),o=t.userData.radius||10;a<=o&&this.onAreaEnter(i)})}onNpcInteraction(e,t={}){this.questManager&&(this.checkDeliveryQuests(e),this.questManager.updateProgress("talk",e,1))}checkDeliveryQuests(e){const t=this.questManager.getTurnInQuestsForNpc(e);t.length>0&&console.log(`[QuestWorldHooks] ${t.length} quests to turn in at ${e}`),this.questManager.getActiveQuests().forEach(({id:s,state:n})=>{n.objectives.forEach(a=>{a.type===ke.DELIVER_ITEM&&a.recipient===e&&this.questManager.updateProgress("deliver",a.target,1)})})}onEscortDamage(e,t,i){const s=this.questManager.getQuestState(e);s&&s.objectives.forEach(n=>{n.type===ke.ESCORT_NPC&&(n.npcCurrentHealth=t,t<=0&&this.questManager.failQuest(e,"Escort target died"))})}onEscortArrived(e){const t=this.questManager.getQuestState(e);t&&(t.objectives.forEach(i=>{i.type===ke.ESCORT_NPC&&(i.current=i.required)}),this.questManager.checkQuestCompletion(e))}updateExplorationMarkers(){if(!this.scene)return;const e=this.questManager?.getActiveQuests()||[],t=new Set;e.forEach(({id:i,state:s})=>{s.objectives.forEach(n=>{n.type===ke.VISIT_LOCATION&&n.current<n.required&&t.add(n.target)})}),this.explorationMarkers.forEach((i,s)=>{t.has(s)||(this.scene.remove(i),this.explorationMarkers.delete(s))}),t.forEach(i=>{this.explorationMarkers.has(i)||this.createExplorationMarker(i)})}createExplorationMarker(e){if(!this.scene)return;let t=null,i=10;const s=this.questManager?.getActiveQuests()||[];for(const{state:m}of s){for(const g of m.objectives)if(g.target===e&&g.position){t=g.position,i=g.radius||10;break}if(t)break}if(!t){const m=Object.values(cT).find(g=>g.id===e);m&&(t=m.position,i=m.radius)}if(!t)return;const n=new ne;n.position.set(t.x,(t.y||0)+gf,t.z),n.userData.radius=i,n.userData.locationId=e;const a=new Ki(.8,1.2,yf),o=new B({color:4521983,side:lt,transparent:!0,opacity:.8}),r=new w(a,o);r.rotation.x=Math.PI/2,n.add(r);const c=new Zi(.6,yf),h=new B({color:8978431,transparent:!0,opacity:.4}),d=new w(c,h);d.rotation.x=-Math.PI/2,d.position.y=.1,n.add(d);const u=new ce(.1,.3,10,8),p=new B({color:4521983,transparent:!0,opacity:.3}),f=new w(u,p);f.position.y=5,n.add(f);const y=new We(4521983,1,10);y.position.y=1,n.add(y),this.scene.add(n),this.explorationMarkers.set(e,n),console.log(`[QuestWorldHooks] Created exploration marker: ${e}`)}removeExplorationMarker(e){const t=this.explorationMarkers.get(e);t&&this.scene&&(this.scene.remove(t),this.explorationMarkers.delete(e),console.log(`[QuestWorldHooks] Removed exploration marker: ${e}`))}onQuestAccepted(e,t){const i=this.questManager.getQuestState(e);i&&(i.objectives.forEach(s=>{(s.type===ke.KILL_ENEMY||s.type===ke.KILL_ANY)&&(s.validTargets||[s.target]).forEach(a=>{this.questEnemySpawns.has(a)||this.questEnemySpawns.set(a,{needed:0,spawned:0,killed:0});const o=this.questEnemySpawns.get(a);o.needed+=s.required})}),this.updateExplorationMarkers(),this.ensureQuestEnemies())}onQuestEnded(e){this.updateExplorationMarkers(),this.recalculateSpawnNeeds()}recalculateSpawnNeeds(){this.questEnemySpawns.clear(),(this.questManager?.getActiveQuests()||[]).forEach(({state:t})=>{t.objectives.forEach(i=>{if(i.type===ke.KILL_ENEMY||i.type===ke.KILL_ANY){const s=i.validTargets||[i.target],n=i.required-i.current;n>0&&s.forEach(a=>{this.questEnemySpawns.has(a)||this.questEnemySpawns.set(a,{needed:0,spawned:0,killed:0});const o=this.questEnemySpawns.get(a);o.needed+=n})}})})}ensureQuestEnemies(){this.enemyManager&&this.questEnemySpawns.forEach((e,t)=>{const i=e.needed-e.killed,s=Math.max(0,i-e.spawned);s>0&&this.enemyManager.requestQuestSpawn&&(this.enemyManager.requestQuestSpawn(t,s),e.spawned+=s)})}isQuestEnemy(e){const t=this.questEnemySpawns.get(e);return t?t.needed>t.killed:!1}addQuestItemEffect(e,t){if(!e)return;const i=new B({color:pT,transparent:!0,opacity:.5}),s=e.geometry.clone(),n=new w(s,i);n.scale.setScalar(1.3),n.position.copy(e.position),this.scene&&this.scene.add(n),this.questItemEffects.set(t,{mesh:n,baseY:e.position.y})}removeQuestItemEffect(e){const t=this.questItemEffects.get(e);t&&this.scene&&(this.scene.remove(t.mesh),this.questItemEffects.delete(e))}update(e,t){this.animationTime+=e,this.explorationMarkers.forEach(i=>{i.children[0]&&(i.children[0].rotation.z=this.animationTime*uT),i.children[1]&&(i.children[1].material.opacity=.3+Math.sin(this.animationTime*3)*.2),i.position.y=(i.userData.baseY||gf)+Math.sin(this.animationTime*2)*.3}),this.questItemEffects.forEach(i=>{i.mesh&&(i.mesh.material.opacity=.3+Math.sin(this.animationTime*4)*.2,i.mesh.position.y=i.baseY+Math.sin(this.animationTime*2)*.2)}),t&&this.updatePlayerPosition(t)}cleanup(){this.explorationMarkers.forEach(e=>{this.scene&&this.scene.remove(e)}),this.explorationMarkers.clear(),this.questItemEffects.forEach(e=>{this.scene&&this.scene.remove(e.mesh)}),this.questItemEffects.clear(),this.questEnemySpawns.clear(),console.log("[QuestWorldHooks] Cleaned up")}getDebugInfo(){return{explorationMarkers:this.explorationMarkers.size,questEnemySpawns:Object.fromEntries(this.questEnemySpawns),questItemEffects:this.questItemEffects.size}}}let Jc=null;function mT(){return Jc||(Jc=new fT),Jc}const eh=3,gT=4e3,yT=5e3;class vT{constructor(){this.isOpen=!1,this.currentTab="active",this.trackedQuests=new Set,this.sortBy="difficulty",this.filterType="all",this.journalPanel=null,this.hudTracker=null,this.notificationQueue=[],this.isShowingNotification=!1,this.questManager=null,this.playerPosition={x:0,y:0,z:0},this.createStyles(),this.createJournalPanel(),this.createHUDTracker(),this.createCompletionPopup(),this.createNotificationContainer(),this.setupKeyBindings()}init(e){this.questManager=e,e.on("onQuestAccepted",t=>this.onQuestAccepted(t)),e.on("onObjectiveProgress",t=>this.onObjectiveProgress(t)),e.on("onObjectiveComplete",t=>this.onObjectiveComplete(t)),e.on("onQuestComplete",t=>this.onQuestReadyForTurnIn(t)),e.on("onQuestTurnedIn",t=>this.onQuestTurnedIn(t)),e.on("onQuestFailed",t=>this.onQuestFailed(t)),e.on("onQuestAvailable",t=>this.onQuestAvailable(t)),this.updateHUDTracker(),console.log("[QuestUI] Initialized")}createStyles(){if(document.getElementById("quest-ui-styles"))return;const e=document.createElement("style");e.id="quest-ui-styles",e.textContent=`
      /* ===== QUEST JOURNAL ===== */
      #quest-journal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 700px;
        height: 550px;
        background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid #4a4a6a;
        border-radius: 12px;
        box-shadow: 0 0 40px rgba(0,0,0,0.8), inset 0 0 60px rgba(100,100,150,0.1);
        font-family: 'Segoe UI', Tahoma, sans-serif;
        color: #e0e0e0;
        z-index: 2000;
        display: none;
        flex-direction: column;
        overflow: hidden;
      }

      #quest-journal.open {
        display: flex;
        animation: journalOpen 0.3s ease-out;
      }

      @keyframes journalOpen {
        from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      }

      /* Header */
      .quest-journal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(180deg, #2a2a4a, #1a1a3a);
        border-bottom: 1px solid #4a4a6a;
      }

      .quest-journal-title {
        font-size: 22px;
        font-weight: bold;
        color: #ffd700;
        text-shadow: 0 0 10px rgba(255,215,0,0.3);
      }

      .quest-journal-close {
        width: 32px;
        height: 32px;
        background: #3a3a5a;
        border: 1px solid #5a5a7a;
        border-radius: 6px;
        color: #aaa;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quest-journal-close:hover {
        background: #5a3a3a;
        color: #ff6666;
      }

      /* Tabs */
      .quest-journal-tabs {
        display: flex;
        background: #1a1a2e;
        border-bottom: 1px solid #3a3a5a;
      }

      .quest-tab {
        flex: 1;
        padding: 12px 20px;
        background: transparent;
        border: none;
        color: #888;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        border-bottom: 3px solid transparent;
      }

      .quest-tab:hover {
        color: #aaa;
        background: rgba(100,100,150,0.1);
      }

      .quest-tab.active {
        color: #ffd700;
        border-bottom-color: #ffd700;
        background: rgba(255,215,0,0.05);
      }

      .quest-tab-count {
        background: #3a3a5a;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        margin-left: 6px;
      }

      .quest-tab.active .quest-tab-count {
        background: rgba(255,215,0,0.3);
        color: #ffd700;
      }

      /* Filter/Sort Bar */
      .quest-filter-bar {
        display: flex;
        gap: 15px;
        padding: 10px 20px;
        background: rgba(0,0,0,0.2);
        border-bottom: 1px solid #2a2a4a;
      }

      .quest-filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .quest-filter-label {
        color: #888;
        font-size: 12px;
      }

      .quest-filter-select {
        background: #2a2a4a;
        border: 1px solid #4a4a6a;
        border-radius: 4px;
        color: #e0e0e0;
        padding: 5px 10px;
        font-size: 12px;
        cursor: pointer;
      }

      .quest-filter-select:focus {
        outline: none;
        border-color: #6a6a8a;
      }

      /* Content */
      .quest-journal-content {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      /* Quest List */
      .quest-list {
        width: 260px;
        border-right: 1px solid #3a3a5a;
        overflow-y: auto;
        padding: 10px;
      }

      .quest-list-item {
        padding: 12px;
        background: rgba(40,40,60,0.5);
        border: 1px solid #3a3a5a;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quest-list-item:hover {
        background: rgba(60,60,80,0.7);
        border-color: #5a5a7a;
      }

      .quest-list-item.selected {
        background: rgba(255,215,0,0.1);
        border-color: #ffd700;
      }

      .quest-list-item.completed {
        opacity: 0.6;
      }

      .quest-list-item.ready {
        border-color: #44ff44;
        background: rgba(68,255,68,0.1);
      }

      .quest-list-name {
        font-weight: bold;
        font-size: 13px;
        color: #e0e0e0;
        margin-bottom: 4px;
      }

      .quest-list-item.completed .quest-list-name {
        color: #888;
      }

      .quest-list-meta {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #888;
      }

      .quest-difficulty {
        padding: 1px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 600;
      }

      .quest-difficulty.trivial { background: #333; color: #888; }
      .quest-difficulty.easy { background: #2d4a2d; color: #7fff7f; }
      .quest-difficulty.normal { background: #4a4a2d; color: #ffff7f; }
      .quest-difficulty.hard { background: #5a3a2d; color: #ffaa44; }
      .quest-difficulty.elite { background: #5a2d2d; color: #ff6666; }
      .quest-difficulty.legendary { background: #4a2d5a; color: #cc66ff; }

      /* Quest Details */
      .quest-details {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }

      .quest-details-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #666;
        font-style: italic;
      }

      .quest-details-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }

      .quest-details-title {
        font-size: 20px;
        font-weight: bold;
        color: #ffd700;
        margin-bottom: 5px;
      }

      .quest-details-giver {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #aaa;
        font-size: 12px;
      }

      .quest-giver-portrait {
        width: 40px;
        height: 40px;
        background: #2a2a4a;
        border: 2px solid #4a4a6a;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .quest-details-description {
        color: #ccc;
        font-size: 13px;
        line-height: 1.6;
        margin-bottom: 20px;
        padding: 15px;
        background: rgba(0,0,0,0.2);
        border-radius: 6px;
        border-left: 3px solid #4a4a6a;
      }

      /* Objectives */
      .quest-objectives-title {
        font-size: 14px;
        font-weight: bold;
        color: #aaa;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .quest-objective {
        display: flex;
        align-items: center;
        padding: 10px;
        background: rgba(40,40,60,0.4);
        border-radius: 6px;
        margin-bottom: 8px;
      }

      .quest-objective.complete {
        background: rgba(68,255,68,0.1);
      }

      .quest-objective.optional {
        border-left: 3px solid #7777ff;
      }

      .quest-objective-icon {
        font-size: 18px;
        margin-right: 10px;
      }

      .quest-objective-text {
        flex: 1;
      }

      .quest-objective-name {
        font-size: 13px;
        color: #e0e0e0;
      }

      .quest-objective.complete .quest-objective-name {
        text-decoration: line-through;
        color: #7fff7f;
      }

      .quest-objective-progress {
        margin-top: 4px;
      }

      .quest-progress-bar {
        width: 100%;
        height: 6px;
        background: #2a2a4a;
        border-radius: 3px;
        overflow: hidden;
      }

      .quest-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4488ff, #44aaff);
        transition: width 0.3s ease;
      }

      .quest-objective.complete .quest-progress-fill {
        background: linear-gradient(90deg, #44ff44, #88ff88);
      }

      .quest-progress-text {
        font-size: 11px;
        color: #888;
        margin-top: 2px;
        text-align: right;
      }

      /* Rewards Preview */
      .quest-rewards-section {
        margin-top: 20px;
        padding: 15px;
        background: rgba(255,215,0,0.05);
        border: 1px solid rgba(255,215,0,0.2);
        border-radius: 6px;
      }

      .quest-rewards-title {
        font-size: 14px;
        font-weight: bold;
        color: #ffd700;
        margin-bottom: 10px;
      }

      .quest-rewards-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .quest-reward-item {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 6px 12px;
        background: rgba(255,215,0,0.1);
        border-radius: 4px;
        font-size: 13px;
      }

      .quest-reward-item.gold { color: #ffd700; }
      .quest-reward-item.xp { color: #88ff88; }
      .quest-reward-item.item { color: #88aaff; }
      .quest-reward-item.rep { color: #ff88ff; }

      /* Action Buttons */
      .quest-details-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #3a3a5a;
      }

      .quest-action-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quest-action-btn.track {
        background: linear-gradient(180deg, #2d4a6a, #1d3a5a);
        color: #88ccff;
        border: 1px solid #4a6a8a;
      }

      .quest-action-btn.track:hover {
        background: linear-gradient(180deg, #3d5a7a, #2d4a6a);
      }

      .quest-action-btn.track.tracking {
        background: linear-gradient(180deg, #2d5a2d, #1d4a1d);
        color: #88ff88;
        border-color: #4a8a4a;
      }

      .quest-action-btn.abandon {
        background: linear-gradient(180deg, #5a3a3a, #4a2a2a);
        color: #ff8888;
        border: 1px solid #7a4a4a;
      }

      .quest-action-btn.abandon:hover {
        background: linear-gradient(180deg, #6a4a4a, #5a3a3a);
      }

      .quest-action-btn.accept {
        background: linear-gradient(180deg, #4a6a2d, #3a5a1d);
        color: #bbff88;
        border: 1px solid #6a8a4a;
      }

      .quest-action-btn.accept:hover {
        background: linear-gradient(180deg, #5a7a3d, #4a6a2d);
      }

      /* ===== HUD TRACKER ===== */
      #quest-hud-tracker {
        position: fixed;
        top: 178px;
        right: 10px;
        width: 260px;
        background: rgba(0,0,0,0.7);
        border: 1px solid #444;
        border-radius: 8px;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        color: #e0e0e0;
        font-size: 12px;
        z-index: 500;
        overflow: hidden;
        backdrop-filter: blur(5px);
      }

      .hud-tracker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(50,50,50,0.8);
        border-bottom: 1px solid #444;
      }

      .hud-tracker-title {
        font-weight: bold;
        color: #ffd700;
      }

      .hud-tracker-toggle {
        background: none;
        border: none;
        color: #888;
        cursor: pointer;
        font-size: 14px;
      }

      .hud-tracker-content {
        max-height: 300px;
        overflow-y: auto;
        padding: 8px;
      }

      .hud-quest-entry {
        padding: 8px;
        background: rgba(50,50,50,0.5);
        border-radius: 4px;
        margin-bottom: 6px;
      }

      .hud-quest-entry:last-child {
        margin-bottom: 0;
      }

      .hud-quest-entry.ready {
        border-left: 3px solid #44ff44;
      }

      .hud-quest-title {
        font-weight: bold;
        color: #ffd700;
        margin-bottom: 6px;
        font-size: 12px;
      }

      .hud-objective {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3px 0;
        font-size: 11px;
      }

      .hud-objective.complete {
        color: #7fff7f;
        text-decoration: line-through;
        opacity: 0.7;
      }

      .hud-objective-name {
        flex: 1;
        margin-right: 8px;
      }

      .hud-objective-progress {
        color: #aaa;
        font-weight: 600;
      }

      .hud-tracker-empty {
        color: #666;
        text-align: center;
        padding: 15px;
        font-style: italic;
      }

      /* ===== COMPLETION POPUP ===== */
      #quest-completion-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 400px;
        background: linear-gradient(180deg, #1a2a1a, #0a1a0a);
        border: 3px solid #44ff44;
        border-radius: 12px;
        box-shadow: 0 0 60px rgba(68,255,68,0.4);
        padding: 30px;
        text-align: center;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        z-index: 3000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
      }

      #quest-completion-popup.show {
        opacity: 1;
        pointer-events: auto;
        animation: completionPulse 0.5s ease-out;
      }

      @keyframes completionPulse {
        0% { transform: translate(-50%, -50%) scale(0.8); }
        50% { transform: translate(-50%, -50%) scale(1.05); }
        100% { transform: translate(-50%, -50%) scale(1); }
      }

      .completion-banner {
        font-size: 28px;
        font-weight: bold;
        color: #44ff44;
        text-shadow: 0 0 20px rgba(68,255,68,0.6);
        margin-bottom: 15px;
        letter-spacing: 2px;
      }

      .completion-quest-name {
        font-size: 20px;
        color: #ffd700;
        margin-bottom: 25px;
      }

      .completion-rewards {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 25px;
      }

      .completion-reward {
        padding: 10px 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 6px;
        font-size: 16px;
      }

      .completion-reward.gold { color: #ffd700; }
      .completion-reward.xp { color: #88ff88; }
      .completion-reward.item { color: #88aaff; }

      .completion-close-btn {
        padding: 12px 40px;
        background: linear-gradient(180deg, #3a5a3a, #2a4a2a);
        border: 2px solid #44ff44;
        border-radius: 6px;
        color: #88ff88;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      }

      .completion-close-btn:hover {
        background: linear-gradient(180deg, #4a6a4a, #3a5a3a);
      }

      /* ===== NOTIFICATIONS ===== */
      #quest-notifications {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 300px;
        z-index: 2500;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: none;
      }

      .quest-notification {
        padding: 15px 20px;
        background: rgba(20,20,30,0.95);
        border-radius: 8px;
        border-left: 4px solid #ffd700;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        font-family: 'Segoe UI', Tahoma, sans-serif;
        animation: notifSlideIn 0.3s ease-out;
        pointer-events: auto;
      }

      @keyframes notifSlideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .quest-notification.hiding {
        animation: notifSlideOut 0.3s ease-in forwards;
      }

      @keyframes notifSlideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }

      .quest-notification.new-quest {
        border-left-color: #4488ff;
      }

      .quest-notification.complete {
        border-left-color: #44ff44;
      }

      .quest-notification.failed {
        border-left-color: #ff4444;
      }

      .quest-notification.available {
        border-left-color: #ffaa44;
      }

      .notification-header {
        font-size: 12px;
        color: #888;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .notification-text {
        font-size: 14px;
        color: #e0e0e0;
        font-weight: 600;
      }

      /* ===== ABANDON CONFIRMATION ===== */
      #quest-abandon-confirm {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(40,30,30,0.98);
        border: 2px solid #ff6666;
        border-radius: 10px;
        padding: 25px 35px;
        text-align: center;
        z-index: 3500;
        display: none;
      }

      #quest-abandon-confirm.show {
        display: block;
        animation: journalOpen 0.2s ease-out;
      }

      .abandon-confirm-title {
        font-size: 18px;
        color: #ff6666;
        margin-bottom: 15px;
      }

      .abandon-confirm-text {
        color: #ccc;
        margin-bottom: 20px;
        font-size: 14px;
      }

      .abandon-confirm-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .abandon-confirm-btn {
        padding: 10px 25px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        font-weight: 600;
      }

      .abandon-confirm-btn.yes {
        background: #5a2a2a;
        color: #ff8888;
        border: 1px solid #ff6666;
      }

      .abandon-confirm-btn.no {
        background: #2a2a4a;
        color: #aaa;
        border: 1px solid #4a4a6a;
      }

      .abandon-confirm-btn:hover {
        filter: brightness(1.2);
      }
    `,document.head.appendChild(e)}createJournalPanel(){if(document.getElementById("quest-journal"))return;const e=document.createElement("div");e.id="quest-journal",e.innerHTML=`
      <div class="quest-journal-header">
        <span class="quest-journal-title"> Quest Journal</span>
        <button class="quest-journal-close"></button>
      </div>
      
      <div class="quest-journal-tabs">
        <button class="quest-tab active" data-tab="active">
          Active <span class="quest-tab-count" id="tab-count-active">0</span>
        </button>
        <button class="quest-tab" data-tab="available">
          Available <span class="quest-tab-count" id="tab-count-available">0</span>
        </button>
        <button class="quest-tab" data-tab="completed">
          Completed <span class="quest-tab-count" id="tab-count-completed">0</span>
        </button>
      </div>
      
      <div class="quest-filter-bar">
        <div class="quest-filter-group">
          <span class="quest-filter-label">Type:</span>
          <select class="quest-filter-select" id="quest-filter-type">
            <option value="all">All Types</option>
            <option value="kill">Kill</option>
            <option value="gather">Gather</option>
            <option value="explore">Explore</option>
            <option value="deliver">Deliver</option>
            <option value="escort">Escort</option>
            <option value="boss">Boss</option>
          </select>
        </div>
        <div class="quest-filter-group">
          <span class="quest-filter-label">Sort:</span>
          <select class="quest-filter-select" id="quest-sort">
            <option value="difficulty">Difficulty</option>
            <option value="type">Type</option>
            <option value="name">Name</option>
          </select>
        </div>
      </div>
      
      <div class="quest-journal-content">
        <div class="quest-list" id="quest-list"></div>
        <div class="quest-details" id="quest-details">
          <div class="quest-details-empty">Select a quest to view details</div>
        </div>
      </div>
    `,document.body.appendChild(e),this.journalPanel=e,e.querySelector(".quest-journal-close").onclick=()=>this.close(),e.querySelectorAll(".quest-tab").forEach(i=>{i.onclick=()=>this.switchTab(i.dataset.tab)}),e.querySelector("#quest-filter-type").onchange=i=>{this.filterType=i.target.value,this.updateQuestList()},e.querySelector("#quest-sort").onchange=i=>{this.sortBy=i.target.value,this.updateQuestList()};const t=document.createElement("div");t.id="quest-abandon-confirm",t.innerHTML=`
      <div class="abandon-confirm-title"> Abandon Quest?</div>
      <div class="abandon-confirm-text" id="abandon-quest-name"></div>
      <div class="abandon-confirm-buttons">
        <button class="abandon-confirm-btn yes">Abandon</button>
        <button class="abandon-confirm-btn no">Cancel</button>
      </div>
    `,document.body.appendChild(t),t.querySelector(".abandon-confirm-btn.no").onclick=()=>{t.classList.remove("show")}}createHUDTracker(){const e=document.getElementById("quest-tracker");if(e&&e.remove(),document.getElementById("quest-hud-tracker"))return;const t=document.createElement("div");t.id="quest-hud-tracker",t.innerHTML=`
      <div class="hud-tracker-header">
        <span class="hud-tracker-title"> Tracked Quests</span>
        <button class="hud-tracker-toggle"></button>
      </div>
      <div class="hud-tracker-content" id="hud-tracker-content">
        <div class="hud-tracker-empty">Press J to open Quest Journal</div>
      </div>
    `,document.body.appendChild(t),this.hudTracker=t;const i=t.querySelector(".hud-tracker-header"),s=t.querySelector(".hud-tracker-content"),n=t.querySelector(".hud-tracker-toggle");let a=!1;i.style.cursor="pointer",i.onclick=()=>{a=!a,s.style.display=a?"none":"block",n.textContent=a?"+":""}}createCompletionPopup(){if(document.getElementById("quest-completion-popup"))return;const e=document.createElement("div");e.id="quest-completion-popup",e.innerHTML=`
      <div class="completion-banner"> QUEST COMPLETE!</div>
      <div class="completion-quest-name" id="completion-quest-name"></div>
      <div class="completion-rewards" id="completion-rewards"></div>
      <button class="completion-close-btn">Continue</button>
    `,document.body.appendChild(e),e.querySelector(".completion-close-btn").onclick=()=>{e.classList.remove("show")}}createNotificationContainer(){if(document.getElementById("quest-notifications"))return;const e=document.createElement("div");e.id="quest-notifications",document.body.appendChild(e)}showNotification(e,t,i="default"){const s=document.getElementById("quest-notifications");if(!s)return;const n=document.createElement("div");n.className=`quest-notification ${i}`,n.innerHTML=`
      <div class="notification-header">${e}</div>
      <div class="notification-text">${t}</div>
    `,s.appendChild(n),setTimeout(()=>{n.classList.add("hiding"),setTimeout(()=>n.remove(),300)},gT)}setupKeyBindings(){window.addEventListener("keydown",e=>{e.key.toLowerCase()==="j"&&!this.isInputFocused()&&(e.preventDefault(),this.toggle()),e.key==="Escape"&&this.isOpen&&this.close()})}isInputFocused(){const e=document.activeElement;return e&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA")}toggle(){this.isOpen?this.close():this.open()}open(){this.journalPanel&&(this.isOpen=!0,this.journalPanel.classList.add("open"),this.updateQuestList(),this.updateTabCounts())}close(){this.journalPanel&&(this.isOpen=!1,this.journalPanel.classList.remove("open"),document.getElementById("quest-abandon-confirm")?.classList.remove("show"))}switchTab(e){this.currentTab=e,this.journalPanel.querySelectorAll(".quest-tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),this.updateQuestList()}updateTabCounts(){this.questManager&&(document.getElementById("tab-count-active").textContent=this.questManager.activeQuests.size,document.getElementById("tab-count-available").textContent=this.questManager.availableQuests.size,document.getElementById("tab-count-completed").textContent=this.questManager.completedQuests.size)}updateQuestList(){if(!this.questManager)return;const e=document.getElementById("quest-list");if(!e)return;let t=[];if(this.currentTab==="active"?this.questManager.activeQuests.forEach((i,s)=>{const n=ei(s);n&&t.push({quest:n,state:i,id:s})}):this.currentTab==="available"?this.questManager.availableQuests.forEach(i=>{const s=ei(i);s&&t.push({quest:s,state:null,id:i})}):this.currentTab==="completed"&&this.questManager.completedQuests.forEach(i=>{const s=ei(i);s&&t.push({quest:s,state:null,id:i,completed:!0})}),this.filterType!=="all"&&(t=t.filter(i=>i.quest.type===this.filterType)),t.sort((i,s)=>{if(this.sortBy==="difficulty"){const n=["trivial","easy","normal","hard","elite","legendary"];return n.indexOf(i.quest.difficulty)-n.indexOf(s.quest.difficulty)}else{if(this.sortBy==="type")return i.quest.type.localeCompare(s.quest.type);if(this.sortBy==="name")return i.quest.title.localeCompare(s.quest.title)}return 0}),t.length===0){e.innerHTML='<div class="hud-tracker-empty">No quests in this category</div>';return}e.innerHTML=t.map(({quest:i,state:s,id:n,completed:a})=>{const o=s&&s.status===Ns.READY_TO_TURN_IN;return`
        <div class="${["quest-list-item",a?"completed":"",o?"ready":""].filter(Boolean).join(" ")}" data-quest-id="${n}">
          <div class="quest-list-name">${i.title}</div>
          <div class="quest-list-meta">
            <span class="quest-difficulty ${i.difficulty}">${i.difficulty}</span>
            <span>${this.getQuestTypeIcon(i.type)} ${i.type}</span>
          </div>
        </div>
      `}).join(""),e.querySelectorAll(".quest-list-item").forEach(i=>{i.onclick=()=>{e.querySelectorAll(".quest-list-item").forEach(s=>s.classList.remove("selected")),i.classList.add("selected"),this.showQuestDetails(i.dataset.questId)}}),this.updateTabCounts()}showQuestDetails(e){const t=document.getElementById("quest-details");if(!t)return;const i=ei(e);if(!i){t.innerHTML='<div class="quest-details-empty">Quest not found</div>';return}const s=this.questManager?.getQuestState(e),n=Ed(i.giver),a=this.questManager?.hasActiveQuest(e);this.questManager?.hasCompletedQuest(e);const o=this.questManager?.availableQuests.has(e),r=this.trackedQuests.has(e),c=s?.status===Ns.READY_TO_TURN_IN;let h="";s?(h=s.objectives.map(f=>{const y=f.current>=f.required,m=Math.min(100,f.current/f.required*100);return`
          <div class="quest-objective ${y?"complete":""}">
            <span class="quest-objective-icon">${this.getObjectiveIcon(f.type)}</span>
            <div class="quest-objective-text">
              <div class="quest-objective-name">${f.targetName}</div>
              <div class="quest-objective-progress">
                <div class="quest-progress-bar">
                  <div class="quest-progress-fill" style="width: ${m}%"></div>
                </div>
                <div class="quest-progress-text">${f.current} / ${f.required}</div>
              </div>
            </div>
          </div>
        `}).join(""),s.optionalObjectives?.length>0&&(h+='<div class="quest-objectives-title" style="margin-top: 15px;">Bonus Objectives</div>',h+=s.optionalObjectives.map(f=>{const y=f.current>=f.required,m=Math.min(100,f.current/f.required*100);return`
            <div class="quest-objective optional ${y?"complete":""}">
              <span class="quest-objective-icon"></span>
              <div class="quest-objective-text">
                <div class="quest-objective-name">${f.targetName}</div>
                <div class="quest-objective-progress">
                  <div class="quest-progress-bar">
                    <div class="quest-progress-fill" style="width: ${m}%"></div>
                  </div>
                  <div class="quest-progress-text">${f.current} / ${f.required}</div>
                </div>
              </div>
            </div>
          `}).join(""))):h=i.objectives.map(f=>`
        <div class="quest-objective">
          <span class="quest-objective-icon">${this.getObjectiveIcon(f.type)}</span>
          <div class="quest-objective-text">
            <div class="quest-objective-name">${f.targetName}</div>
            <div class="quest-objective-progress">
              <div class="quest-progress-bar">
                <div class="quest-progress-fill" style="width: 0%"></div>
              </div>
              <div class="quest-progress-text">0 / ${f.required}</div>
            </div>
          </div>
        </div>
      `).join("");const d=i.rewards;let u="";d.gold>0&&(u+=`<span class="quest-reward-item gold"> ${d.gold} Gold</span>`),d.xp>0&&(u+=`<span class="quest-reward-item xp"> ${d.xp} XP</span>`),d.items?.length>0&&d.items.forEach(f=>{const y=f.quantity>1?`${f.quantity}x `:"";u+=`<span class="quest-reward-item item"> ${y}${f.id}</span>`});let p="";a?p=`
        <button class="quest-action-btn track ${r?"tracking":""}" data-action="track">
          ${r?" Tracking":"Track Quest"}
        </button>
        <button class="quest-action-btn abandon" data-action="abandon">
          Abandon
        </button>
      `:o&&(p=`
        <button class="quest-action-btn accept" data-action="accept">
          Accept Quest
        </button>
      `),t.innerHTML=`
      <div class="quest-details-header">
        <div>
          <div class="quest-details-title">${i.title}</div>
          ${c?'<span style="color: #44ff44; font-size: 12px;"> Ready to turn in!</span>':""}
        </div>
        <div class="quest-details-giver">
          <div class="quest-giver-portrait">${n?.icon||""}</div>
          <div>
            <div style="color: #e0e0e0;">${n?.name||"Unknown"}</div>
            <div style="color: #888; font-size: 11px;">${n?.title||""}</div>
          </div>
        </div>
      </div>
      
      <div class="quest-details-description">${i.description}</div>
      
      <div class="quest-objectives-title">Objectives</div>
      ${h}
      
      <div class="quest-rewards-section">
        <div class="quest-rewards-title">Rewards</div>
        <div class="quest-rewards-list">${u}</div>
      </div>
      
      ${p?`<div class="quest-details-actions">${p}</div>`:""}
    `,t.querySelectorAll(".quest-action-btn").forEach(f=>{f.onclick=()=>this.handleQuestAction(f.dataset.action,e)})}handleQuestAction(e,t){const i=ei(t);if(e==="track"){if(this.trackedQuests.has(t))this.trackedQuests.delete(t);else{if(this.trackedQuests.size>=eh){const s=this.trackedQuests.values().next().value;this.trackedQuests.delete(s)}this.trackedQuests.add(t)}this.updateHUDTracker(),this.showQuestDetails(t)}else if(e==="abandon"){const s=document.getElementById("quest-abandon-confirm");document.getElementById("abandon-quest-name").textContent=`Are you sure you want to abandon "${i?.title}"?`,s.classList.add("show"),s.querySelector(".abandon-confirm-btn.yes").onclick=()=>{this.questManager?.abandonQuest(t),this.trackedQuests.delete(t),s.classList.remove("show"),this.updateQuestList(),this.updateHUDTracker(),document.getElementById("quest-details").innerHTML='<div class="quest-details-empty">Select a quest to view details</div>'}}else e==="accept"&&this.questManager?.acceptQuest(t)?.success&&(this.trackedQuests.size<eh&&this.trackedQuests.add(t),this.switchTab("active"),this.showQuestDetails(t),this.updateHUDTracker())}updateHUDTracker(){const e=document.getElementById("hud-tracker-content");if(!e||!this.questManager)return;let t=Array.from(this.trackedQuests);if(t.length===0&&(t=Array.from(this.questManager.activeQuests.keys()).slice(0,eh)),t.length===0){e.innerHTML='<div class="hud-tracker-empty">No active quests  Press J to browse</div>';return}e.innerHTML=t.map(i=>{const s=ei(i),n=this.questManager.getQuestState(i);if(!s||!n)return"";const a=n.status===Ns.READY_TO_TURN_IN,o=n.objectives.slice(0,3).map(r=>`
          <div class="hud-objective ${r.current>=r.required?"complete":""}">
            <span class="hud-objective-name">${r.targetName}</span>
            <span class="hud-objective-progress">${r.current}/${r.required}</span>
          </div>
        `).join("");return`
        <div class="hud-quest-entry ${a?"ready":""}">
          <div class="hud-quest-title">${s.title}</div>
          ${o}
        </div>
      `}).join("")}onQuestAccepted(e){this.showNotification("New Quest",e.quest.title,"new-quest"),this.updateQuestList(),this.updateHUDTracker()}onObjectiveProgress(e){this.updateHUDTracker(),this.isOpen&&this.showQuestDetails(e.questId)}onObjectiveComplete(e){this.updateHUDTracker()}onQuestReadyForTurnIn(e){this.showNotification("Quest Complete",`${e.quest.title}  Return to ${e.quest.turnIn}`,"complete"),this.updateQuestList(),this.updateHUDTracker()}onQuestTurnedIn(e){this.trackedQuests.delete(e.questId),this.showCompletionPopup(e.quest,e.rewards),this.updateQuestList(),this.updateHUDTracker()}onQuestFailed(e){this.trackedQuests.delete(e.questId),this.showNotification("Quest Failed",`${e.quest.title}  ${e.reason}`,"failed"),this.updateQuestList(),this.updateHUDTracker()}onQuestAvailable(e){const t=ei(e.questId);t&&this.showNotification("Quest Available",t.title,"available"),this.updateQuestList()}showCompletionPopup(e,t){const i=document.getElementById("quest-completion-popup");if(!i)return;document.getElementById("completion-quest-name").textContent=e.title;let s="";t.gold>0&&(s+=`<span class="completion-reward gold"> ${t.gold} Gold</span>`),t.xp>0&&(s+=`<span class="completion-reward xp"> ${t.xp} XP</span>`),t.items?.length>0&&t.items.forEach(n=>{const a=n.quantity>1?`${n.quantity}x `:"";s+=`<span class="completion-reward item"> ${a}${n.id}</span>`}),document.getElementById("completion-rewards").innerHTML=s,i.classList.add("show"),setTimeout(()=>{i.classList.remove("show")},yT)}getQuestTypeIcon(e){return{[ri.KILL]:"",[ri.GATHER]:"",[ri.EXPLORE]:"",[ri.DELIVER]:"",[ri.ESCORT]:"",[ri.BOSS]:""}[e]||""}getObjectiveIcon(e){return{kill_enemy:"",kill_any:"",gather_item:"",visit_location:"",talk_to_npc:"",deliver_item:"",escort_npc:"",defeat_boss:"",use_item:"",craft_item:""}[e]||""}updatePlayerPosition(e){this.playerPosition=e}destroy(){this.journalPanel?.remove(),this.hudTracker?.remove(),document.getElementById("quest-completion-popup")?.remove(),document.getElementById("quest-notifications")?.remove(),document.getElementById("quest-abandon-confirm")?.remove(),document.getElementById("quest-ui-styles")?.remove()}}let th=null;function xT(){return th||(th=new vT),th}const vf=2.5,bT=2,wT=.15,_T=5,ko={QUEST_AVAILABLE:16776960,QUEST_TURN_IN:16776960,QUEST_IN_PROGRESS:11184810,DAILY_AVAILABLE:4491519,NONE:0};class MT{constructor(e,t){this.id=e.id,this.npcData=e,this.scene=t,this.mesh=null,this.marker=null,this.markerType="none",this.time=0,this.createNPCMesh(),this.createMarker()}createNPCMesh(){const e=new ne,t=new Pt(.4,1,4,8),i=new B({color:this.getNPCColor()}),s=new w(t,i);s.position.y=.9,s.castShadow=!0,e.add(s);const n=new re(.3,8,8),a=new w(n,i);a.position.y=1.8,a.castShadow=!0,e.add(a),e.position.set(this.npcData.position.x,this.npcData.position.y||0,this.npcData.position.z),this.createNamePlate(e),this.mesh=e,this.scene.add(e)}getNPCColor(){return{elder_marcus:9127187,blacksmith_greta:4868682,hunter_jorik:2263842,mage_selene:4915330,guard_captain_theron:7372944,merchant_lydia:14329120,herbalist_mira:3329330,mysterious_stranger:1710618}[this.id]||6710886}createNamePlate(e){const t=document.createElement("canvas");t.width=256,t.height=64;const i=t.getContext("2d");i.fillStyle="rgba(0,0,0,0.5)",i.fillRect(0,20,256,44),i.font="bold 24px Arial",i.fillStyle="#ffffff",i.textAlign="center",i.fillText(this.npcData.name,128,48),this.npcData.title&&(i.font="16px Arial",i.fillStyle="#aaaaaa",i.fillText(this.npcData.title,128,18));const s=new Zd(t),n=new Xd({map:s,transparent:!0}),a=new mm(n);a.position.y=2.5,a.scale.set(2,.5,1),e.add(a)}createMarker(){const e=new ne,t=new ne,i=new ce(.08,.15,.5,6),s=new B({color:16776960}),n=new w(i,s);n.position.y=.15,t.add(n);const a=new re(.1,8,8),o=new w(a,s);o.position.y=-.2,t.add(o),t.name="exclamation",t.visible=!1,e.add(t);const r=new ne,c=new Ai(.15,.06,8,16,Math.PI*1.5),h=new B({color:16776960}),d=new w(c,h);d.rotation.x=Math.PI/2,d.rotation.z=Math.PI,d.position.y=.2,r.add(d);const u=new ce(.06,.06,.2,6),p=new w(u,h);p.position.y=-.05,r.add(p);const f=new w(a,h);f.position.y=-.3,r.add(f),r.name="question",r.visible=!1,e.add(r);const y=new re(.5,16,16),m=new B({color:16776960,transparent:!0,opacity:.15}),g=new w(y,m);g.name="glow",e.add(g);const x=new We(16776960,.5,5);x.name="light",e.add(x),e.position.set(this.npcData.position.x,(this.npcData.position.y||0)+vf,this.npcData.position.z),e.visible=!1,this.marker=e,this.scene.add(e)}updateMarker(e){if(!e)return;if(e.getTurnInQuestsForNpc(this.id).length>0){this.setMarkerType("turn_in");return}const i=e.getAvailableQuestsForNpc(this.id);if(i.length>0){const n=i.some(a=>a.isRepeatable);this.setMarkerType(n?"daily":"quest_available");return}let s=!1;if(e.activeQuests.forEach((n,a)=>{const o=ei(a);o&&(o.giver===this.id||o.turnIn===this.id)&&(s=!0)}),s){this.setMarkerType("in_progress");return}this.setMarkerType("none")}setMarkerType(e){if(this.markerType===e)return;this.markerType=e;const t=this.marker.getObjectByName("exclamation"),i=this.marker.getObjectByName("question"),s=this.marker.getObjectByName("glow"),n=this.marker.getObjectByName("light");let a=ko.NONE,o=!1,r=!1;switch(e){case"quest_available":a=ko.QUEST_AVAILABLE,o=!0;break;case"daily":a=ko.DAILY_AVAILABLE,o=!0;break;case"turn_in":a=ko.QUEST_TURN_IN,r=!0;break;case"in_progress":a=ko.QUEST_IN_PROGRESS,r=!0;break;default:this.marker.visible=!1;return}this.marker.visible=!0,t.children.forEach(c=>{c.material&&c.material.color.setHex(a)}),i.children.forEach(c=>{c.material&&c.material.color.setHex(a)}),s.material.color.setHex(a),n.color.setHex(a),t.visible=o,i.visible=r}update(e){if(this.time+=e,this.marker.visible){this.marker.position.y=(this.npcData.position.y||0)+vf+Math.sin(this.time*bT)*wT;const t=this.marker.getObjectByName("exclamation"),i=this.marker.getObjectByName("question");t.rotation.y+=e*1.5,i.rotation.y+=e*1.5;const s=this.marker.getObjectByName("glow");s.material.opacity=.1+Math.sin(this.time*3)*.05}}getPosition(){return new T(this.npcData.position.x,this.npcData.position.y||0,this.npcData.position.z)}destroy(){this.scene.remove(this.mesh),this.scene.remove(this.marker),this.mesh.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&(Array.isArray(e.material)?e.material.forEach(t=>t.dispose()):e.material.dispose())})}}class ST{constructor(e){this.scene=e,this.npcs=new Map,this.questManager=null,this.dialogueUI=null,this.currentDialogue=null,this.createStyles(),this.createDialogueUI(),this.createNoticeBoard()}init(e){this.questManager=e,Object.values(Sd).forEach(t=>{const i=new MT(t,this.scene);this.npcs.set(t.id,i)}),this.updateAllMarkers(),e.on("onQuestAccepted",()=>this.updateAllMarkers()),e.on("onQuestTurnedIn",()=>this.updateAllMarkers()),e.on("onQuestAbandoned",()=>this.updateAllMarkers()),e.on("onQuestComplete",()=>this.updateAllMarkers()),e.on("onQuestAvailable",()=>this.updateAllMarkers()),console.log("[NPCQuestGivers] Initialized with",this.npcs.size,"NPCs")}createStyles(){if(document.getElementById("npc-dialogue-styles"))return;const e=document.createElement("style");e.id="npc-dialogue-styles",e.textContent=`
      /* ===== DIALOGUE UI ===== */
      #npc-dialogue {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        width: 600px;
        background: linear-gradient(180deg, #1a1a2e, #0a0a1e);
        border: 2px solid #4a4a6a;
        border-radius: 12px;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        color: #e0e0e0;
        z-index: 2000;
        display: none;
        box-shadow: 0 0 40px rgba(0,0,0,0.8);
      }

      #npc-dialogue.show {
        display: block;
        animation: dialogueSlideUp 0.3s ease-out;
      }

      @keyframes dialogueSlideUp {
        from { transform: translateX(-50%) translateY(30px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }

      .dialogue-header {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(180deg, #2a2a4a, #1a1a3a);
        border-bottom: 1px solid #4a4a6a;
        border-radius: 10px 10px 0 0;
      }

      .dialogue-portrait {
        width: 60px;
        height: 60px;
        background: #2a2a4a;
        border: 2px solid #5a5a7a;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
        margin-right: 15px;
      }

      .dialogue-npc-info {
        flex: 1;
      }

      .dialogue-npc-name {
        font-size: 18px;
        font-weight: bold;
        color: #ffd700;
      }

      .dialogue-npc-title {
        font-size: 12px;
        color: #888;
      }

      .dialogue-close {
        width: 30px;
        height: 30px;
        background: #3a3a5a;
        border: 1px solid #5a5a7a;
        border-radius: 6px;
        color: #aaa;
        cursor: pointer;
        font-size: 16px;
      }

      .dialogue-close:hover {
        background: #5a3a3a;
        color: #ff6666;
      }

      .dialogue-content {
        padding: 20px;
        max-height: 200px;
        overflow-y: auto;
      }

      .dialogue-text {
        font-size: 15px;
        line-height: 1.6;
        color: #ddd;
        margin-bottom: 15px;
      }

      .dialogue-quest-info {
        background: rgba(255,215,0,0.1);
        border: 1px solid rgba(255,215,0,0.3);
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 15px;
      }

      .dialogue-quest-title {
        font-size: 16px;
        font-weight: bold;
        color: #ffd700;
        margin-bottom: 8px;
      }

      .dialogue-quest-desc {
        font-size: 13px;
        color: #aaa;
        margin-bottom: 10px;
      }

      .dialogue-quest-objectives {
        font-size: 12px;
        color: #888;
      }

      .dialogue-quest-objectives li {
        margin: 4px 0;
        padding-left: 5px;
      }

      .dialogue-rewards-preview {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      .dialogue-reward {
        padding: 4px 10px;
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
        font-size: 12px;
      }

      .dialogue-reward.gold { color: #ffd700; }
      .dialogue-reward.xp { color: #88ff88; }
      .dialogue-reward.item { color: #88aaff; }

      .dialogue-actions {
        display: flex;
        gap: 10px;
        padding: 15px 20px;
        background: rgba(0,0,0,0.2);
        border-top: 1px solid #3a3a5a;
        border-radius: 0 0 10px 10px;
      }

      .dialogue-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .dialogue-btn.accept {
        background: linear-gradient(180deg, #3a5a3a, #2a4a2a);
        color: #88ff88;
        border: 1px solid #4a8a4a;
      }

      .dialogue-btn.accept:hover {
        background: linear-gradient(180deg, #4a6a4a, #3a5a3a);
      }

      .dialogue-btn.decline {
        background: linear-gradient(180deg, #3a3a5a, #2a2a4a);
        color: #aaa;
        border: 1px solid #4a4a6a;
      }

      .dialogue-btn.decline:hover {
        background: linear-gradient(180deg, #4a4a6a, #3a3a5a);
      }

      .dialogue-btn.turn-in {
        background: linear-gradient(180deg, #5a5a2a, #4a4a1a);
        color: #ffdd88;
        border: 1px solid #8a8a4a;
      }

      .dialogue-btn.continue {
        background: linear-gradient(180deg, #2a3a5a, #1a2a4a);
        color: #88aaff;
        border: 1px solid #4a6a8a;
      }

      /* Progress dialogue */
      .dialogue-progress {
        background: rgba(100,100,150,0.1);
        border-radius: 6px;
        padding: 12px;
      }

      .dialogue-progress-title {
        font-weight: bold;
        color: #aaa;
        margin-bottom: 8px;
      }

      .dialogue-progress-obj {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 13px;
      }

      .dialogue-progress-obj.complete {
        color: #7fff7f;
        text-decoration: line-through;
      }

      /* ===== NOTICE BOARD ===== */
      #notice-board-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 500px;
        max-height: 500px;
        background: linear-gradient(180deg, #2a1a0a, #1a0a00);
        border: 3px solid #8b4513;
        border-radius: 8px;
        box-shadow: 0 0 40px rgba(0,0,0,0.8);
        font-family: 'Segoe UI', Tahoma, sans-serif;
        z-index: 2000;
        display: none;
      }

      #notice-board-panel.show {
        display: block;
        animation: journalOpen 0.3s ease-out;
      }

      .notice-board-header {
        padding: 15px 20px;
        background: #3a2a1a;
        border-bottom: 2px solid #5a3a1a;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .notice-board-title {
        font-size: 20px;
        font-weight: bold;
        color: #daa520;
      }

      .notice-board-content {
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
      }

      .notice-quest {
        background: rgba(139,69,19,0.3);
        border: 1px solid #8b4513;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .notice-quest:hover {
        background: rgba(139,69,19,0.5);
        border-color: #daa520;
      }

      .notice-quest-title {
        font-weight: bold;
        color: #daa520;
        margin-bottom: 5px;
      }

      .notice-quest-desc {
        font-size: 13px;
        color: #bbb;
        margin-bottom: 8px;
      }

      .notice-quest-meta {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #888;
      }

      .notice-empty {
        text-align: center;
        color: #666;
        padding: 30px;
        font-style: italic;
      }
    `,document.head.appendChild(e)}createDialogueUI(){if(document.getElementById("npc-dialogue"))return;const e=document.createElement("div");e.id="npc-dialogue",e.innerHTML=`
      <div class="dialogue-header">
        <div class="dialogue-portrait" id="dialogue-portrait"></div>
        <div class="dialogue-npc-info">
          <div class="dialogue-npc-name" id="dialogue-npc-name"></div>
          <div class="dialogue-npc-title" id="dialogue-npc-title"></div>
        </div>
        <button class="dialogue-close"></button>
      </div>
      <div class="dialogue-content" id="dialogue-content"></div>
      <div class="dialogue-actions" id="dialogue-actions"></div>
    `,document.body.appendChild(e),this.dialogueUI=e,e.querySelector(".dialogue-close").onclick=()=>this.closeDialogue(),window.addEventListener("keydown",t=>{t.key==="Escape"&&e.classList.contains("show")&&this.closeDialogue()})}createNoticeBoard(){if(document.getElementById("notice-board-panel"))return;const e=document.createElement("div");e.id="notice-board-panel",e.innerHTML=`
      <div class="notice-board-header">
        <span class="notice-board-title"> Notice Board</span>
        <button class="dialogue-close"></button>
      </div>
      <div class="notice-board-content" id="notice-board-content"></div>
    `,document.body.appendChild(e),e.querySelector(".dialogue-close").onclick=()=>{e.classList.remove("show")}}interactWithNPC(e){const t=this.npcs.get(e);if(!t||!this.questManager)return;const i=t.npcData,s=this.questManager.getTurnInQuestsForNpc(e);if(s.length>0){this.showTurnInDialogue(i,s[0]);return}const n=this.questManager.getAvailableQuestsForNpc(e);if(n.length>0){this.showQuestOfferDialogue(i,n[0]);return}let a=null;if(this.questManager.activeQuests.forEach((o,r)=>{const c=ei(r);c&&(c.giver===e||c.turnIn===e)&&(a={quest:c,state:o})}),a){this.showProgressDialogue(i,a);return}this.showIdleDialogue(i)}showQuestOfferDialogue(e,t){const i=this.dialogueUI;document.getElementById("dialogue-portrait").textContent=e.icon,document.getElementById("dialogue-npc-name").textContent=e.name,document.getElementById("dialogue-npc-title").textContent=e.title;let s="";t.rewards.gold>0&&(s+=`<span class="dialogue-reward gold"> ${t.rewards.gold}</span>`),t.rewards.xp>0&&(s+=`<span class="dialogue-reward xp"> ${t.rewards.xp}</span>`),t.rewards.items?.forEach(a=>{s+=`<span class="dialogue-reward item"> ${a.id}</span>`});const n=t.objectives.map(a=>`<li>${a.targetName} (${a.required})</li>`).join("");document.getElementById("dialogue-content").innerHTML=`
      <div class="dialogue-text">"${t.dialogue.intro}"</div>
      <div class="dialogue-quest-info">
        <div class="dialogue-quest-title">${t.title}</div>
        <div class="dialogue-quest-desc">${t.description}</div>
        <div class="dialogue-quest-objectives">
          <strong>Objectives:</strong>
          <ul>${n}</ul>
        </div>
        <div class="dialogue-rewards-preview">
          <strong style="width:100%">Rewards:</strong>
          ${s}
        </div>
      </div>
    `,document.getElementById("dialogue-actions").innerHTML=`
      <button class="dialogue-btn accept" data-action="accept" data-quest="${t.id}">
        Accept Quest
      </button>
      <button class="dialogue-btn decline" data-action="decline">
        Decline
      </button>
    `,this.setupDialogueActions(),i.classList.add("show"),this.currentDialogue={type:"offer",quest:t,npc:e}}showTurnInDialogue(e,{quest:t,state:i}){const s=this.dialogueUI;document.getElementById("dialogue-portrait").textContent=e.icon,document.getElementById("dialogue-npc-name").textContent=e.name,document.getElementById("dialogue-npc-title").textContent=e.title;let n="";const a=t.rewards;a.gold>0&&(n+=`<span class="dialogue-reward gold"> ${a.gold}</span>`),a.xp>0&&(n+=`<span class="dialogue-reward xp"> ${a.xp}</span>`),a.items?.forEach(r=>{n+=`<span class="dialogue-reward item"> ${r.id}</span>`});let o="";i.optionalObjectives?.forEach(r=>{r.current>=r.required&&r.bonusReward&&(o+='<div style="color: #88ff88; margin-top: 10px;"> Bonus objective complete!</div>')}),document.getElementById("dialogue-content").innerHTML=`
      <div class="dialogue-text">"${t.dialogue.complete}"</div>
      <div class="dialogue-quest-info">
        <div class="dialogue-quest-title"> ${t.title}</div>
        <div style="color: #7fff7f; margin-bottom: 10px;">All objectives complete!</div>
        ${o}
        <div class="dialogue-rewards-preview">
          <strong style="width:100%">Your Rewards:</strong>
          ${n}
        </div>
      </div>
    `,document.getElementById("dialogue-actions").innerHTML=`
      <button class="dialogue-btn turn-in" data-action="turn-in" data-quest="${t.id}">
        Complete Quest
      </button>
    `,this.setupDialogueActions(),s.classList.add("show"),this.currentDialogue={type:"turn-in",quest:t,state:i,npc:e}}showProgressDialogue(e,{quest:t,state:i}){const s=this.dialogueUI;document.getElementById("dialogue-portrait").textContent=e.icon,document.getElementById("dialogue-npc-name").textContent=e.name,document.getElementById("dialogue-npc-title").textContent=e.title;let n=t.dialogue.progress;const a=i.objectives.reduce((h,d)=>h+d.current,0),o=i.objectives.reduce((h,d)=>h+d.required,0),r=a/o;r>=.75?n="Almost there! Just a bit more.":r>=.5?n="Good progress! Keep at it.":r>=.25&&(n=t.dialogue.progress);const c=i.objectives.map(h=>`
        <div class="dialogue-progress-obj ${h.current>=h.required?"complete":""}">
          <span>${h.targetName}</span>
          <span>${h.current}/${h.required}</span>
        </div>
      `).join("");document.getElementById("dialogue-content").innerHTML=`
      <div class="dialogue-text">"${n}"</div>
      <div class="dialogue-progress">
        <div class="dialogue-progress-title"> ${t.title}</div>
        ${c}
      </div>
    `,document.getElementById("dialogue-actions").innerHTML=`
      <button class="dialogue-btn continue" data-action="close">
        Continue
      </button>
    `,this.setupDialogueActions(),s.classList.add("show"),this.currentDialogue={type:"progress",quest:t,state:i,npc:e}}showIdleDialogue(e){const t=this.dialogueUI;document.getElementById("dialogue-portrait").textContent=e.icon,document.getElementById("dialogue-npc-name").textContent=e.name,document.getElementById("dialogue-npc-title").textContent=e.title;const i={elder_marcus:"The village is peaceful today. Come back if you need guidance.",blacksmith_greta:"My forge burns bright! Need anything crafted?",hunter_jorik:"The hunt never ends. Stay sharp out there.",mage_selene:"The arcane energies flow... I sense great potential in you.",guard_captain_theron:"Keep your weapon ready. Threats lurk everywhere.",merchant_lydia:"Looking to trade? I have fine wares!",herbalist_mira:"The herbs are growing well today. Take care!",mysterious_stranger:"Not yet... the time will come."};document.getElementById("dialogue-content").innerHTML=`
      <div class="dialogue-text">"${i[e.id]||"Hello, adventurer."}"</div>
    `,document.getElementById("dialogue-actions").innerHTML=`
      <button class="dialogue-btn continue" data-action="close">
        Goodbye
      </button>
    `,this.setupDialogueActions(),t.classList.add("show"),this.currentDialogue={type:"idle",npc:e}}setupDialogueActions(){document.getElementById("dialogue-actions").querySelectorAll(".dialogue-btn").forEach(t=>{t.onclick=()=>{const i=t.dataset.action,s=t.dataset.quest;if(i==="accept"&&s){if(this.questManager?.acceptQuest(s)?.success){const a=ei(s);document.getElementById("dialogue-content").innerHTML=`
              <div class="dialogue-text">"${a.dialogue.accept}"</div>
              <div style="color: #88ff88; text-align: center; margin-top: 10px;">
                Quest Accepted!
              </div>
            `,document.getElementById("dialogue-actions").innerHTML=`
              <button class="dialogue-btn continue" data-action="close">
                Let's go!
              </button>
            `,this.setupDialogueActions(),this.updateAllMarkers()}}else i==="turn-in"&&s?this.questManager?.turnInQuest(s)?.success&&(this.closeDialogue(),this.updateAllMarkers()):(i==="decline"||i==="close")&&this.closeDialogue()}})}closeDialogue(){this.dialogueUI.classList.remove("show"),this.currentDialogue=null}openNoticeBoard(){const e=document.getElementById("notice-board-panel"),t=document.getElementById("notice-board-content");if(!this.questManager)return;const i=[];this.questManager.availableQuests.forEach(s=>{const n=ei(s);n&&n.isRepeatable&&i.push(n)}),i.length===0?t.innerHTML='<div class="notice-empty">No notices posted today. Check back later!</div>':(t.innerHTML=i.map(s=>`
        <div class="notice-quest" data-quest="${s.id}">
          <div class="notice-quest-title">${s.title}</div>
          <div class="notice-quest-desc">${s.description}</div>
          <div class="notice-quest-meta">
            <span> ${s.timeLimitMinutes||"No"} time limit</span>
            <span> ${s.rewards.gold} gold</span>
            <span> ${s.rewards.xp} XP</span>
          </div>
        </div>
      `).join(""),t.querySelectorAll(".notice-quest").forEach(s=>{s.onclick=()=>{const n=s.dataset.quest;this.questManager?.acceptQuest(n)?.success&&(e.classList.remove("show"),this.updateAllMarkers())}})),e.classList.add("show")}updateAllMarkers(){this.npcs.forEach(e=>{e.updateMarker(this.questManager)})}update(e){this.npcs.forEach(t=>{t.update(e)})}getNearestNPC(e,t=_T){let i=null,s=t;return this.npcs.forEach(n=>{const a=n.getPosition(),o=e.distanceTo(a);o<s&&(s=o,i=n)}),i}getNPCById(e){return this.npcs.get(e)}isDialogueOpen(){return this.dialogueUI?.classList.contains("show")||!1}destroy(){this.npcs.forEach(e=>e.destroy()),this.npcs.clear(),this.dialogueUI?.remove(),document.getElementById("notice-board-panel")?.remove(),document.getElementById("npc-dialogue-styles")?.remove()}}let ih=null;function TT(l){return ih||(ih=new ST(l)),ih}const xf="ashen_reputation",bf=1.25,hl={VILLAGE:{id:"village",name:"Ashvale Village",description:"The humble folk of Ashvale appreciate your help.",icon:"",color:"#8b4513"},HUNTERS_GUILD:{id:"hunters_guild",name:"Hunters Guild",description:"Elite trackers and beast slayers.",icon:"",color:"#228b22"},MAGES_CIRCLE:{id:"mages_circle",name:"Mages Circle",description:"Arcane scholars seeking ancient knowledge.",icon:"",color:"#4b0082"},MERCHANTS_UNION:{id:"merchants_union",name:"Merchants Union",description:"Traders and craftsmen across the land.",icon:"",color:"#daa520"},SHADOW_BROKERS:{id:"shadow_brokers",name:"Shadow Brokers",description:"Those who deal in secrets and shadows.",icon:"",color:"#1a1a1a"}},sh={HATED:{name:"Hated",min:-3e3,color:"#ff0000",discount:.5},HOSTILE:{name:"Hostile",min:-1e3,color:"#ff4444",discount:.8},UNFRIENDLY:{name:"Unfriendly",min:-100,color:"#ff8844",discount:.95},NEUTRAL:{name:"Neutral",min:0,color:"#aaaaaa",discount:1},FRIENDLY:{name:"Friendly",min:500,color:"#88ff88",discount:.95},HONORED:{name:"Honored",min:2e3,color:"#44ff44",discount:.9},REVERED:{name:"Revered",min:5e3,color:"#44ffff",discount:.85},EXALTED:{name:"Exalted",min:1e4,color:"#ffff44",discount:.8}},ET={village:[{rep:500,type:"title",value:"Friend of Ashvale",description:"Reach Friendly with Ashvale Village"},{rep:2e3,type:"unlock",value:"village_shop_tier2",description:"Access to rare village goods"},{rep:5e3,type:"title",value:"Champion of Ashvale",description:"Reach Revered with Ashvale Village"},{rep:1e4,type:"cosmetic",value:"village_banner_cape",description:"Exclusive village banner cape"}],hunters_guild:[{rep:500,type:"title",value:"Apprentice Hunter",description:"Join the Hunters Guild"},{rep:2e3,type:"unlock",value:"beast_tracking",description:"Learn beast tracking ability"},{rep:5e3,type:"title",value:"Master Hunter",description:"Earn Master Hunter rank"},{rep:1e4,type:"cosmetic",value:"legendary_bow_skin",description:"Legendary bow appearance"}],mages_circle:[{rep:500,type:"title",value:"Initiate Mage",description:"Gain access to basic spells"},{rep:2e3,type:"unlock",value:"arcane_shop",description:"Access to arcane artifacts"},{rep:5e3,type:"title",value:"Archmage",description:"Achieve Archmage status"},{rep:1e4,type:"cosmetic",value:"arcane_aura",description:"Arcane aura effect"}],merchants_union:[{rep:500,type:"discount",value:.05,description:"5% discount at all shops"},{rep:2e3,type:"unlock",value:"merchant_routes",description:"Access to merchant caravans"},{rep:5e3,type:"discount",value:.15,description:"15% discount at all shops"},{rep:1e4,type:"title",value:"Trade Prince",description:"Honorary Trade Prince title"}],shadow_brokers:[{rep:500,type:"unlock",value:"black_market",description:"Access to black market"},{rep:2e3,type:"title",value:"Shadow Agent",description:"Recognized as Shadow Agent"},{rep:5e3,type:"unlock",value:"shadow_missions",description:"Access to shadow missions"},{rep:1e4,type:"cosmetic",value:"shadow_cloak",description:"Shadowy cloak effect"}]},CT={first_steps:{village:100},guard_duty:{village:75},bandit_problem:{village:150},the_captains_trust:{village:200},urgent_medicine:{village:100},daily_hunt:{hunters_guild:50},golem_threat:{hunters_guild:200,village:100},shadow_wraith_hunt:{hunters_guild:300},explore_the_ruins:{mages_circle:100},selenes_research:{mages_circle:150},merchant_delivery:{merchants_union:50},escort_the_merchant:{merchants_union:150},forge_materials:{merchants_union:75},master_craftsmanship:{merchants_union:200},stranger_introduction:{shadow_brokers:100},gathering_herbs:{village:50},miras_special_brew:{village:100}},AT={QUEST_NOVICE:{id:"quest_novice",name:"Quest Novice",description:"Complete your first quest",icon:"",requirement:1,type:"quest_count"},QUEST_ADEPT:{id:"quest_adept",name:"Quest Adept",description:"Complete 10 quests",icon:"",requirement:10,type:"quest_count"},QUEST_MASTER:{id:"quest_master",name:"Quest Master",description:"Complete 25 quests",icon:"",requirement:25,type:"quest_count"},QUEST_LEGEND:{id:"quest_legend",name:"Quest Legend",description:"Complete 50 quests",icon:"",requirement:50,type:"quest_count"},BOSS_SLAYER:{id:"boss_slayer",name:"Boss Slayer",description:"Complete 5 boss quests",icon:"",requirement:5,type:"boss_count"},DAILY_DEVOTEE:{id:"daily_devotee",name:"Daily Devotee",description:"Complete 20 daily quests",icon:"",requirement:20,type:"daily_count"},REP_FRIENDLY:{id:"rep_friendly",name:"Making Friends",description:"Reach Friendly with any faction",icon:"",requirement:500,type:"rep_any"},REP_EXALTED:{id:"rep_exalted",name:"Legend Among Legends",description:"Reach Exalted with any faction",icon:"",requirement:1e4,type:"rep_any"}};class RT{constructor(){this.reputation={},this.unlockedMilestones=new Set,this.titles=[],this.currentTitle=null,this.achievements=new Set,this.stats={questsCompleted:0,bossQuestsCompleted:0,dailyQuestsCompleted:0,totalGoldEarned:0,totalXpEarned:0},this.rewardChest=null,this.scene=null,this.eventListeners={onReputationChange:[],onMilestoneUnlocked:[],onAchievementUnlocked:[],onTitleUnlocked:[]},this.loadState(),this.createStyles(),this.createReputationPanel(),this.createAchievementsPanel(),this.createRewardChestUI()}init(e,t=null){this.scene=t,e.on("onQuestTurnedIn",i=>{this.handleQuestCompletion(i)}),console.log("[QuestRewards] Initialized")}handleQuestCompletion(e){const{questId:t,quest:i,rewards:s}=e;this.stats.questsCompleted++,this.stats.totalGoldEarned+=s.gold||0,this.stats.totalXpEarned+=s.xp||0,i.type==="boss"&&this.stats.bossQuestsCompleted++,i.isRepeatable&&this.stats.dailyQuestsCompleted++;const n=CT[t];n&&Object.entries(n).forEach(([a,o])=>{this.addReputation(a,o)}),this.checkAchievements(),this.scene&&this.showRewardChest(s),this.saveState()}calculateRewards(e,t=1){const i=ei(e);if(!i)return null;const s={...i.rewards},n=ff[i.difficulty]||ff.normal;s.gold=Math.round(s.gold*n.goldMult),s.xp=Math.round(s.xp*n.xpMult);const a=Jm();return a&&!a.hasCompletedQuest(e)&&(s.gold=Math.round(s.gold*bf),s.xp=Math.round(s.xp*bf),s.isFirstTime=!0),s}getMerchantDiscount(e="merchants_union"){const t=this.reputation[e]||0;return this.getRepTier(t).discount}addReputation(e,t){if(!hl[e.toUpperCase()]&&!Object.values(hl).find(r=>r.id===e)){console.warn(`[QuestRewards] Unknown faction: ${e}`);return}const i=e.toLowerCase(),s=this.reputation[i]||0,n=s+t;this.reputation[i]=n;const a=this.getRepTier(s),o=this.getRepTier(n);a.name!==o.name&&this.showReputationChange(i,t,o),this.checkMilestones(i,n),this.emit("onReputationChange",{factionId:i,oldRep:s,newRep:n,change:t,tier:o}),this.updateReputationPanel(),this.saveState()}getReputation(e){return this.reputation[e.toLowerCase()]||0}getRepTier(e){const t=Object.values(sh).sort((i,s)=>s.min-i.min);for(const i of t)if(e>=i.min)return i;return sh.HATED}checkMilestones(e,t){(ET[e]||[]).forEach(s=>{const n=`${e}_${s.rep}`;t>=s.rep&&!this.unlockedMilestones.has(n)&&(this.unlockedMilestones.add(n),s.type==="title"&&(this.titles.push(s.value),this.emit("onTitleUnlocked",{title:s.value,description:s.description})),this.emit("onMilestoneUnlocked",{factionId:e,milestone:s}),this.showMilestoneUnlocked(s))})}checkAchievements(){Object.values(AT).forEach(e=>{if(this.achievements.has(e.id))return;let t=!1;switch(e.type){case"quest_count":t=this.stats.questsCompleted>=e.requirement;break;case"boss_count":t=this.stats.bossQuestsCompleted>=e.requirement;break;case"daily_count":t=this.stats.dailyQuestsCompleted>=e.requirement;break;case"rep_any":t=Object.values(this.reputation).some(i=>i>=e.requirement);break}t&&(this.achievements.add(e.id),this.emit("onAchievementUnlocked",{achievement:e}),this.showAchievementUnlocked(e))})}hasAchievement(e){return this.achievements.has(e)}createStyles(){if(document.getElementById("quest-rewards-styles"))return;const e=document.createElement("style");e.id="quest-rewards-styles",e.textContent=`
      /* ===== REPUTATION PANEL ===== */
      #reputation-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 500px;
        max-height: 600px;
        background: linear-gradient(180deg, #1a1a2e, #0a0a1e);
        border: 2px solid #4a4a6a;
        border-radius: 12px;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        color: #e0e0e0;
        z-index: 2000;
        display: none;
        overflow: hidden;
      }

      #reputation-panel.show {
        display: block;
        animation: panelOpen 0.3s ease-out;
      }

      @keyframes panelOpen {
        from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
        to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      }

      .rep-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: linear-gradient(180deg, #2a2a4a, #1a1a3a);
        border-bottom: 1px solid #4a4a6a;
      }

      .rep-panel-title {
        font-size: 20px;
        font-weight: bold;
        color: #ffd700;
      }

      .rep-panel-content {
        padding: 15px;
        max-height: 500px;
        overflow-y: auto;
      }

      .rep-faction {
        background: rgba(40,40,60,0.5);
        border: 1px solid #3a3a5a;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
      }

      .rep-faction-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .rep-faction-icon {
        font-size: 28px;
        margin-right: 12px;
      }

      .rep-faction-info {
        flex: 1;
      }

      .rep-faction-name {
        font-size: 16px;
        font-weight: bold;
        color: #e0e0e0;
      }

      .rep-faction-tier {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 4px;
      }

      .rep-bar-container {
        margin-top: 10px;
      }

      .rep-bar {
        width: 100%;
        height: 8px;
        background: #2a2a4a;
        border-radius: 4px;
        overflow: hidden;
      }

      .rep-bar-fill {
        height: 100%;
        transition: width 0.5s ease;
      }

      .rep-bar-text {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #888;
        margin-top: 4px;
      }

      /* ===== REWARD CHEST ===== */
      #reward-chest-ui {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 350px;
        background: linear-gradient(180deg, #2a1a0a, #1a0a00);
        border: 3px solid #daa520;
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        z-index: 2500;
        display: none;
        box-shadow: 0 0 60px rgba(218,165,32,0.5);
      }

      #reward-chest-ui.show {
        display: block;
        animation: chestOpen 0.5s ease-out;
      }

      @keyframes chestOpen {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
        50% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      }

      .chest-icon {
        font-size: 60px;
        margin-bottom: 15px;
        animation: chestBounce 0.5s ease-out 0.3s;
      }

      @keyframes chestBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
      }

      .chest-title {
        font-size: 22px;
        color: #ffd700;
        font-weight: bold;
        margin-bottom: 20px;
        text-shadow: 0 0 10px rgba(255,215,0,0.5);
      }

      .chest-rewards {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
      }

      .chest-reward-item {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 10px;
        background: rgba(255,215,0,0.1);
        border-radius: 6px;
        font-size: 16px;
        animation: rewardAppear 0.3s ease-out backwards;
      }

      .chest-reward-item:nth-child(1) { animation-delay: 0.5s; }
      .chest-reward-item:nth-child(2) { animation-delay: 0.7s; }
      .chest-reward-item:nth-child(3) { animation-delay: 0.9s; }

      @keyframes rewardAppear {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .chest-reward-item.gold { color: #ffd700; }
      .chest-reward-item.xp { color: #88ff88; }
      .chest-reward-item.item { color: #88aaff; }
      .chest-reward-item.rep { color: #ff88ff; }

      .chest-close-btn {
        padding: 12px 40px;
        background: linear-gradient(180deg, #5a4a2a, #4a3a1a);
        border: 2px solid #daa520;
        border-radius: 6px;
        color: #ffd700;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      }

      .chest-close-btn:hover {
        background: linear-gradient(180deg, #6a5a3a, #5a4a2a);
      }

      /* ===== NOTIFICATIONS ===== */
      .rep-notification {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        padding: 15px 30px;
        background: rgba(20,20,30,0.95);
        border-radius: 8px;
        font-family: 'Segoe UI', sans-serif;
        z-index: 2200;
        animation: notifFadeIn 0.3s ease-out;
      }

      @keyframes notifFadeIn {
        from { opacity: 0; transform: translateX(-50%) translateY(20px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
      }

      .rep-notification.hiding {
        animation: notifFadeOut 0.3s ease-in forwards;
      }

      @keyframes notifFadeOut {
        from { opacity: 1; transform: translateX(-50%) translateY(0); }
        to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      }

      .rep-notif-title {
        font-size: 14px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .rep-notif-text {
        font-size: 12px;
        color: #aaa;
      }

      /* ===== MILESTONE POPUP ===== */
      .milestone-popup {
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translateX(-50%);
        padding: 25px 40px;
        background: linear-gradient(180deg, #2a2a4a, #1a1a3a);
        border: 2px solid #ffaa00;
        border-radius: 10px;
        text-align: center;
        z-index: 2300;
        animation: milestonePop 0.5s ease-out;
      }

      @keyframes milestonePop {
        0% { transform: translateX(-50%) scale(0); }
        50% { transform: translateX(-50%) scale(1.2); }
        100% { transform: translateX(-50%) scale(1); }
      }

      .milestone-icon {
        font-size: 40px;
        margin-bottom: 10px;
      }

      .milestone-title {
        font-size: 18px;
        color: #ffaa00;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .milestone-desc {
        font-size: 13px;
        color: #ccc;
      }

      /* ===== ACHIEVEMENT POPUP ===== */
      .achievement-popup {
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px 25px;
        background: linear-gradient(180deg, #3a2a1a, #2a1a0a);
        border: 2px solid #ffd700;
        border-radius: 8px;
        z-index: 2300;
        animation: achievementSlide 0.5s ease-out;
      }

      @keyframes achievementSlide {
        from { transform: translateX(-50%) translateY(-50px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }

      .achievement-icon {
        font-size: 35px;
      }

      .achievement-info {
        text-align: left;
      }

      .achievement-label {
        font-size: 11px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .achievement-name {
        font-size: 16px;
        color: #ffd700;
        font-weight: bold;
      }
    `,document.head.appendChild(e)}createReputationPanel(){if(document.getElementById("reputation-panel"))return;const e=document.createElement("div");e.id="reputation-panel",e.innerHTML=`
      <div class="rep-panel-header">
        <span class="rep-panel-title"> Reputation</span>
        <button class="dialogue-close" style="width:30px;height:30px;background:#3a3a5a;border:1px solid #5a5a7a;border-radius:6px;color:#aaa;cursor:pointer;"></button>
      </div>
      <div class="rep-panel-content" id="rep-panel-content"></div>
    `,document.body.appendChild(e),e.querySelector(".dialogue-close").onclick=()=>{e.classList.remove("show")},window.addEventListener("keydown",t=>{t.key.toLowerCase()==="u"&&!this.isInputFocused()&&(t.preventDefault(),e.classList.toggle("show"),e.classList.contains("show")&&this.updateReputationPanel())})}updateReputationPanel(){const e=document.getElementById("rep-panel-content");e&&(e.innerHTML=Object.values(hl).map(t=>{const i=this.reputation[t.id]||0,s=this.getRepTier(i),n=this.getNextTier(i);let a=0;if(n){const o=n.min-s.min,r=i-s.min;a=Math.min(100,r/o*100)}else a=100;return`
        <div class="rep-faction">
          <div class="rep-faction-header">
            <span class="rep-faction-icon">${t.icon}</span>
            <div class="rep-faction-info">
              <div class="rep-faction-name">${t.name}</div>
              <span class="rep-faction-tier" style="background:${s.color}20;color:${s.color}">
                ${s.name}
              </span>
            </div>
          </div>
          <div class="rep-bar-container">
            <div class="rep-bar">
              <div class="rep-bar-fill" style="width:${a}%;background:${s.color}"></div>
            </div>
            <div class="rep-bar-text">
              <span>${i.toLocaleString()} rep</span>
              <span>${n?`Next: ${n.name} (${n.min.toLocaleString()})`:"Max Rank"}</span>
            </div>
          </div>
        </div>
      `}).join(""))}getNextTier(e){const t=Object.values(sh).sort((i,s)=>i.min-s.min);for(const i of t)if(e<i.min)return i;return null}createAchievementsPanel(){}createRewardChestUI(){if(document.getElementById("reward-chest-ui"))return;const e=document.createElement("div");e.id="reward-chest-ui",e.innerHTML=`
      <div class="chest-icon"></div>
      <div class="chest-title">Rewards!</div>
      <div class="chest-rewards" id="chest-rewards"></div>
      <button class="chest-close-btn">Collect</button>
    `,document.body.appendChild(e),e.querySelector(".chest-close-btn").onclick=()=>{e.classList.remove("show")}}showRewardChest(e){const t=document.getElementById("reward-chest-ui"),i=document.getElementById("chest-rewards");if(!t||!i)return;let s="";e.gold>0&&(s+=`<div class="chest-reward-item gold"> ${e.gold} Gold</div>`),e.xp>0&&(s+=`<div class="chest-reward-item xp"> ${e.xp} XP</div>`),e.items?.forEach(n=>{const a=n.quantity>1?`${n.quantity}x `:"";s+=`<div class="chest-reward-item item"> ${a}${n.id}</div>`}),i.innerHTML=s,t.classList.add("show"),setTimeout(()=>{t.classList.remove("show")},5e3)}showReputationChange(e,t,i){const s=Object.values(hl).find(a=>a.id===e);if(!s)return;const n=document.createElement("div");n.className="rep-notification",n.innerHTML=`
      <div class="rep-notif-title" style="color:${i.color}">
        ${s.icon} ${s.name} +${t}
      </div>
      <div class="rep-notif-text">Now: ${i.name}</div>
    `,document.body.appendChild(n),setTimeout(()=>{n.classList.add("hiding"),setTimeout(()=>n.remove(),300)},3e3)}showMilestoneUnlocked(e){const t=document.createElement("div");t.className="milestone-popup",t.innerHTML=`
      <div class="milestone-icon"></div>
      <div class="milestone-title">Milestone Unlocked!</div>
      <div class="milestone-desc">${e.description}</div>
    `,document.body.appendChild(t),setTimeout(()=>{t.style.animation="notifFadeOut 0.3s ease-in forwards",setTimeout(()=>t.remove(),300)},4e3)}showAchievementUnlocked(e){const t=document.createElement("div");t.className="achievement-popup",t.innerHTML=`
      <div class="achievement-icon">${e.icon}</div>
      <div class="achievement-info">
        <div class="achievement-label">Achievement Unlocked</div>
        <div class="achievement-name">${e.name}</div>
      </div>
    `,document.body.appendChild(t),setTimeout(()=>{t.style.animation="notifFadeOut 0.3s ease-in forwards",setTimeout(()=>t.remove(),300)},4e3)}on(e,t){this.eventListeners[e]&&this.eventListeners[e].push(t)}off(e,t){this.eventListeners[e]&&(this.eventListeners[e]=this.eventListeners[e].filter(i=>i!==t))}emit(e,t){this.eventListeners[e]&&this.eventListeners[e].forEach(i=>{try{i(t)}catch(s){console.error(s)}})}saveState(){const e={reputation:this.reputation,unlockedMilestones:Array.from(this.unlockedMilestones),titles:this.titles,currentTitle:this.currentTitle,achievements:Array.from(this.achievements),stats:this.stats};try{localStorage.setItem(xf,JSON.stringify(e))}catch(t){console.warn("[QuestRewards] Failed to save state:",t)}}loadState(){try{const e=localStorage.getItem(xf);if(!e)return;const t=JSON.parse(e);this.reputation=t.reputation||{},this.unlockedMilestones=new Set(t.unlockedMilestones||[]),this.titles=t.titles||[],this.currentTitle=t.currentTitle||null,this.achievements=new Set(t.achievements||[]),this.stats=t.stats||this.stats,console.log("[QuestRewards] Loaded state")}catch(e){console.warn("[QuestRewards] Failed to load state:",e)}}resetState(){this.reputation={},this.unlockedMilestones.clear(),this.titles=[],this.currentTitle=null,this.achievements.clear(),this.stats={questsCompleted:0,bossQuestsCompleted:0,dailyQuestsCompleted:0,totalGoldEarned:0,totalXpEarned:0},this.saveState(),this.updateReputationPanel()}isInputFocused(){const e=document.activeElement;return e&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA")}destroy(){document.getElementById("reputation-panel")?.remove(),document.getElementById("reward-chest-ui")?.remove(),document.getElementById("quest-rewards-styles")?.remove()}}let nh=null;function IT(){return nh||(nh=new RT),nh}function kT(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}var ah={exports:{}},wf;function PT(){return wf||(wf=1,(function(l){var e=(function(){var t=String.fromCharCode,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function a(r,c){if(!n[r]){n[r]={};for(var h=0;h<r.length;h++)n[r][r.charAt(h)]=h}return n[r][c]}var o={compressToBase64:function(r){if(r==null)return"";var c=o._compress(r,6,function(h){return i.charAt(h)});switch(c.length%4){default:case 0:return c;case 1:return c+"===";case 2:return c+"==";case 3:return c+"="}},decompressFromBase64:function(r){return r==null?"":r==""?null:o._decompress(r.length,32,function(c){return a(i,r.charAt(c))})},compressToUTF16:function(r){return r==null?"":o._compress(r,15,function(c){return t(c+32)})+" "},decompressFromUTF16:function(r){return r==null?"":r==""?null:o._decompress(r.length,16384,function(c){return r.charCodeAt(c)-32})},compressToUint8Array:function(r){for(var c=o.compress(r),h=new Uint8Array(c.length*2),d=0,u=c.length;d<u;d++){var p=c.charCodeAt(d);h[d*2]=p>>>8,h[d*2+1]=p%256}return h},decompressFromUint8Array:function(r){if(r==null)return o.decompress(r);for(var c=new Array(r.length/2),h=0,d=c.length;h<d;h++)c[h]=r[h*2]*256+r[h*2+1];var u=[];return c.forEach(function(p){u.push(t(p))}),o.decompress(u.join(""))},compressToEncodedURIComponent:function(r){return r==null?"":o._compress(r,6,function(c){return s.charAt(c)})},decompressFromEncodedURIComponent:function(r){return r==null?"":r==""?null:(r=r.replace(/ /g,"+"),o._decompress(r.length,32,function(c){return a(s,r.charAt(c))}))},compress:function(r){return o._compress(r,16,function(c){return t(c)})},_compress:function(r,c,h){if(r==null)return"";var d,u,p={},f={},y="",m="",g="",x=2,v=3,b=2,_=[],S=0,A=0,R;for(R=0;R<r.length;R+=1)if(y=r.charAt(R),Object.prototype.hasOwnProperty.call(p,y)||(p[y]=v++,f[y]=!0),m=g+y,Object.prototype.hasOwnProperty.call(p,m))g=m;else{if(Object.prototype.hasOwnProperty.call(f,g)){if(g.charCodeAt(0)<256){for(d=0;d<b;d++)S=S<<1,A==c-1?(A=0,_.push(h(S)),S=0):A++;for(u=g.charCodeAt(0),d=0;d<8;d++)S=S<<1|u&1,A==c-1?(A=0,_.push(h(S)),S=0):A++,u=u>>1}else{for(u=1,d=0;d<b;d++)S=S<<1|u,A==c-1?(A=0,_.push(h(S)),S=0):A++,u=0;for(u=g.charCodeAt(0),d=0;d<16;d++)S=S<<1|u&1,A==c-1?(A=0,_.push(h(S)),S=0):A++,u=u>>1}x--,x==0&&(x=Math.pow(2,b),b++),delete f[g]}else for(u=p[g],d=0;d<b;d++)S=S<<1|u&1,A==c-1?(A=0,_.push(h(S)),S=0):A++,u=u>>1;x--,x==0&&(x=Math.pow(2,b),b++),p[m]=v++,g=String(y)}if(g!==""){if(Object.prototype.hasOwnProperty.call(f,g)){if(g.charCodeAt(0)<256){for(d=0;d<b;d++)S=S<<1,A==c-1?(A=0,_.push(h(S)),S=0):A++;for(u=g.charCodeAt(0),d=0;d<8;d++)S=S<<1|u&1,A==c-1?(A=0,_.push(h(S)),S=0):A++,u=u>>1}else{for(u=1,d=0;d<b;d++)S=S<<1|u,A==c-1?(A=0,_.push(h(S)),S=0):A++,u=0;for(u=g.charCodeAt(0),d=0;d<16;d++)S=S<<1|u&1,A==c-1?(A=0,_.push(h(S)),S=0):A++,u=u>>1}x--,x==0&&(x=Math.pow(2,b),b++),delete f[g]}else for(u=p[g],d=0;d<b;d++)S=S<<1|u&1,A==c-1?(A=0,_.push(h(S)),S=0):A++,u=u>>1;x--,x==0&&(x=Math.pow(2,b),b++)}for(u=2,d=0;d<b;d++)S=S<<1|u&1,A==c-1?(A=0,_.push(h(S)),S=0):A++,u=u>>1;for(;;)if(S=S<<1,A==c-1){_.push(h(S));break}else A++;return _.join("")},decompress:function(r){return r==null?"":r==""?null:o._decompress(r.length,32768,function(c){return r.charCodeAt(c)})},_decompress:function(r,c,h){var d=[],u=4,p=4,f=3,y="",m=[],g,x,v,b,_,S,A,R={val:h(0),position:c,index:1};for(g=0;g<3;g+=1)d[g]=g;for(v=0,_=Math.pow(2,2),S=1;S!=_;)b=R.val&R.position,R.position>>=1,R.position==0&&(R.position=c,R.val=h(R.index++)),v|=(b>0?1:0)*S,S<<=1;switch(v){case 0:for(v=0,_=Math.pow(2,8),S=1;S!=_;)b=R.val&R.position,R.position>>=1,R.position==0&&(R.position=c,R.val=h(R.index++)),v|=(b>0?1:0)*S,S<<=1;A=t(v);break;case 1:for(v=0,_=Math.pow(2,16),S=1;S!=_;)b=R.val&R.position,R.position>>=1,R.position==0&&(R.position=c,R.val=h(R.index++)),v|=(b>0?1:0)*S,S<<=1;A=t(v);break;case 2:return""}for(d[3]=A,x=A,m.push(A);;){if(R.index>r)return"";for(v=0,_=Math.pow(2,f),S=1;S!=_;)b=R.val&R.position,R.position>>=1,R.position==0&&(R.position=c,R.val=h(R.index++)),v|=(b>0?1:0)*S,S<<=1;switch(A=v){case 0:for(v=0,_=Math.pow(2,8),S=1;S!=_;)b=R.val&R.position,R.position>>=1,R.position==0&&(R.position=c,R.val=h(R.index++)),v|=(b>0?1:0)*S,S<<=1;d[p++]=t(v),A=p-1,u--;break;case 1:for(v=0,_=Math.pow(2,16),S=1;S!=_;)b=R.val&R.position,R.position>>=1,R.position==0&&(R.position=c,R.val=h(R.index++)),v|=(b>0?1:0)*S,S<<=1;d[p++]=t(v),A=p-1,u--;break;case 2:return m.join("")}if(u==0&&(u=Math.pow(2,f),f++),d[A])y=d[A];else if(A===p)y=x+x.charAt(0);else return null;m.push(y),d[p++]=x+y.charAt(0),u--,x=y,u==0&&(u=Math.pow(2,f),f++)}}};return o})();l!=null?l.exports=e:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return e})})(ah)),ah.exports}var DT=PT();const dl=kT(DT),Pn=1,Dn={MANUAL:"manual",AUTOSAVE:"autosave"};function Yl(){return{position:{x:0,y:50,z:5},rotation:{x:0,y:0,z:0},checkpoint:{x:0,y:400,z:5},health:100,maxHealth:100,stamina:100,maxStamina:100,mana:50,maxMana:50,posture:0,maxPosture:100,level:1,currentXP:0,totalXPEarned:0,remnant:0,heldRemnant:0,stats:{vigor:0,endurance:0,strength:0,dexterity:0,mind:0,intelligence:0},spentStatPoints:0,infusions:{strength:0,vitality:0,stamina:0,spirit:0},unlockedAbilities:[],abilityCooldowns:{dash:0,heavyCharge:0,parry:0,warCry:0},unlockedSpells:["fireball"],equippedSpells:["fireball",null,null,null],spellCooldowns:{},deathCount:0,deathLessons:{},bloodstain:null}}function ou(){return{gold:0,items:[],equipment:[],weapons:[],bossSouls:[],bossTrophies:[],keys:[]}}function ru(){return{equipped:{weapon:null,armor:null,accessory:null},weaponSlots:[null,null,null,null],activeWeaponSlot:0,potionSlots:[null,null]}}function Ql(){return{activeQuests:[],completedQuests:[],failedQuests:[],availableQuests:[],questCooldowns:{},questStats:{totalCompleted:0,totalFailed:0,totalAbandoned:0,questsCompletedByType:{}},trackedQuests:[]}}function lu(){return{factions:{village:0,hunters_guild:0,mages_circle:0,merchants_union:0,shadow_brokers:0},titles:[],activeTitle:null,unlockedMilestones:[],achievements:[],repStats:{totalRepEarned:0,highestTierReached:{}}}}function lr(){return{time:{currentHour:10,currentMinute:0,currentDay:1,dayPhase:"day",moonPhase:4,isPaused:!1},weather:{currentWeather:"clear",intensity:0,transitionProgress:0,lastWeatherChange:0},discoveredLocations:[],fastTravelPoints:["ashvale_village"],worldFlags:{},bossesDefeated:[],dungeons:{},npcStates:{},rareEvents:{triggeredEvents:[],lastRareEventTime:0}}}function cu(){return{unlockedRecipes:[],craftingStats:{totalCrafted:0,recipesCrafted:{}},unlockedStations:["basic_workbench"]}}function hu(){return{nodeCooldowns:{},gatheringStats:{totalGathered:0,gatheredByType:{}},rareNodesFound:[]}}function du(){return{killCounts:{},bossKillCounts:{},damageStats:{totalDamageDealt:0,totalDamageTaken:0,highestHit:0,criticalHits:0},records:{longestCombo:0,perfectParries:0,noHitBossKills:[]}}}function uu(){return{purchasedItems:{},shopRefreshTimes:{},totalGoldSpent:0,haggleSuccesses:0}}function _f(l){const e=l.player||Yl(),t=l.world||lr(),i=l.quest||Ql();return{slotId:l.slotId||0,slotType:l.slotType||Dn.MANUAL,timestamp:Date.now(),playtime:l.playtime||0,playerLevel:e.level,playerName:l.playerName||"Ashen One",locationName:l.locationName||"Unknown",questsCompleted:i.completedQuests?.length||0,bossesDefeated:t.bossesDefeated?.length||0,currentHour:t.time?.currentHour||10,dayCount:t.time?.currentDay||1,version:Pn}}function e0(l=0,e=Dn.MANUAL){return{version:Pn,slotId:l,slotType:e,createdAt:Date.now(),updatedAt:Date.now(),playtime:0,sessionStartTime:Date.now(),playerName:"Ashen One",locationName:"Ashvale Village",player:Yl(),inventory:ou(),equipment:ru(),quest:Ql(),reputation:lu(),world:lr(),crafting:cu(),gathering:hu(),combat:du(),shop:uu(),settings:null}}function oh(l){const e=[],t=[];l.version?l.version>Pn?e.push(`Save version ${l.version} is newer than supported ${Pn}`):l.version<Pn&&t.push(`Save version ${l.version} will be migrated to ${Pn}`):e.push("Missing save version");const i=["player","inventory","equipment","quest","world"];for(const s of i)l[s]||e.push(`Missing required section: ${s}`);return l.player&&((typeof l.player.level!="number"||l.player.level<1)&&e.push("Invalid player level"),(typeof l.player.health!="number"||l.player.health<0)&&e.push("Invalid player health"),(!l.player.position||typeof l.player.position.x!="number")&&e.push("Invalid player position")),l.inventory&&(Array.isArray(l.inventory.items)||t.push("Inventory items should be an array"),typeof l.inventory.gold!="number"&&t.push("Inventory gold should be a number")),l.world&&(!l.world.time||typeof l.world.time.currentHour!="number")&&t.push("Invalid world time data"),{valid:e.length===0,errors:e,warnings:t}}function Mf(l){let e={...l},t=[];return e.version||(e.version=0),e.version<1&&(e.player={...Yl(),...e.player},e.inventory={...ou(),...e.inventory},e.equipment={...ru(),...e.equipment},e.quest={...Ql(),...e.quest},e.reputation={...lu(),...e.reputation},e.world={...lr(),...e.world},e.crafting={...cu(),...e.crafting},e.gathering={...hu(),...e.gathering},e.combat={...du(),...e.combat},e.shop={...uu(),...e.shop},e.version=1,t.push("v0 -> v1: Added missing sections")),{data:e,migrationsApplied:t}}function At(l){return JSON.parse(JSON.stringify(l))}function cr(l){const e=Math.floor(l/3600),t=Math.floor(l%3600/60),i=Math.floor(l%60);return e>0?`${e}:${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${t}:${i.toString().padStart(2,"0")}`}function t0(l){const e=new Date(l);return e.toLocaleDateString()+" "+e.toLocaleTimeString()}const LT=["time","weather","world","player","inventory","equipment","quest","reputation","crafting","gathering","combat","shop","bosses","dungeons"];class OT{constructor(){this.systems={},this.saveData=null,this.validationErrors=[],this.validationWarnings=[],this.onGameLoaded=[],this.onRestorationError=[],this.onValidationComplete=[],console.log("[StateRestoration] Created")}registerSystems(e){this.systems={gameManager:e.gameManager||null,player:e.player||null,inventoryUI:e.inventoryUI||null,equipmentManager:e.equipmentManager||null,lootManager:e.lootManager||null,questManager:e.questManager||null,questRewards:e.questRewards||null,timeManager:e.timeManager||null,weatherManager:e.weatherManager||null,craftingManager:e.craftingManager||null,gatheringManager:e.gatheringManager||null,shopManager:e.shopManager||null,bossSpawner:e.bossSpawner||null,dungeonManager:e.dungeonManager||null,spellManager:e.spellManager||null,manaManager:e.manaManager||null,npcManager:e.npcManager||null,scene:e.scene||null,hud:e.hud||null,questUI:e.questUI||null},console.log("[StateRestoration] Systems registered")}async restoreGameState(e){this.saveData=e,this.validationErrors=[],this.validationWarnings=[],console.log("[StateRestoration] Starting state restoration...");try{this.validateSaveData(e);for(const t of LT)try{await this.restoreSystem(t,e)}catch(i){this.validationWarnings.push(`Failed to restore ${t}: ${i.message}`),console.warn(`[StateRestoration] ${t} restoration failed:`,i)}return this.postLoadValidation(e),this.refreshAllUI(),this.emitEvent("onGameLoaded",{saveData:e,warnings:this.validationWarnings}),console.log("[StateRestoration] State restoration complete"),{success:!0,errors:this.validationErrors,warnings:this.validationWarnings}}catch(t){return console.error("[StateRestoration] Critical restoration error:",t),this.emitEvent("onRestorationError",{error:t.message}),{success:!1,errors:[...this.validationErrors,t.message],warnings:this.validationWarnings}}}async restoreSystem(e,t){switch(e){case"time":this.restoreTime(t.world?.time);break;case"weather":this.restoreWeather(t.world?.weather);break;case"world":this.restoreWorld(t.world);break;case"player":this.restorePlayer(t.player);break;case"inventory":this.restoreInventory(t.inventory);break;case"equipment":this.restoreEquipment(t.equipment);break;case"quest":this.restoreQuests(t.quest);break;case"reputation":this.restoreReputation(t.reputation);break;case"crafting":this.restoreCrafting(t.crafting);break;case"gathering":this.restoreGathering(t.gathering);break;case"combat":this.restoreCombat(t.combat);break;case"shop":this.restoreShop(t.shop);break;case"bosses":this.restoreBosses(t.world?.bossesDefeated);break;case"dungeons":this.restoreDungeons(t.world?.dungeons);break}}restoreTime(e){const t=this.systems.timeManager;if(!t||!e)return;const s={...lr().time,...e};t.currentHour=s.currentHour,t.currentMinute=s.currentMinute,t.currentDay=s.currentDay,t.dayPhase=s.dayPhase,t.moonPhase=s.moonPhase,t.isPaused=s.isPaused,t.updateCelestials&&t.updateCelestials(),t.updateClockUI&&t.updateClockUI(),t.updateDayPhase&&t.updateDayPhase(),console.log(`[StateRestoration] Time restored: Day ${s.currentDay}, ${s.currentHour}:${s.currentMinute.toString().padStart(2,"0")}`)}restoreWeather(e){const t=this.systems.weatherManager;if(!t||!e)return;const s={...lr().weather,...e};t.currentWeather=s.currentWeather,t.intensity=s.intensity,t.transitionProgress=s.transitionProgress,t.lastWeatherChange=s.lastWeatherChange,t.applyWeather&&t.applyWeather(),t.setWeather&&t.setWeather(s.currentWeather,s.intensity),console.log(`[StateRestoration] Weather restored: ${s.currentWeather}`)}restoreWorld(e){e&&(this.worldFlags=e.worldFlags||{},this.discoveredLocations=new Set(e.discoveredLocations||[]),this.fastTravelPoints=new Set(e.fastTravelPoints||["ashvale_village"]),console.log(`[StateRestoration] World restored: ${this.discoveredLocations.size} locations discovered`))}restorePlayer(e){if(!e)return;const i={...Yl(),...e};this.systems.player&&i.position&&(this.systems.player.position.set(i.position.x,i.position.y,i.position.z),i.rotation&&this.systems.player.rotation.set(i.rotation.x,i.rotation.y,i.rotation.z));const s=this.systems.gameManager;s&&(s.health=i.health,s.maxHealth=i.maxHealth,s.stamina=i.stamina,s.maxStamina=i.maxStamina,s.posture=i.posture,s.maxPosture=i.maxPosture,s.currentLevel=i.level,s.currentXP=i.currentXP,s.remnant=i.remnant,s.heldRemnant=i.heldRemnant,s.stats={...i.stats},s.spentStatPoints=i.spentStatPoints,s.infusions={...i.infusions},s.unlockedAbilities=new Set(i.unlockedAbilities||[]),s.abilityCooldowns={...i.abilityCooldowns},s.deathCount=i.deathCount,s.deathLessons={...i.deathLessons},i.checkpoint&&s.checkpoint&&s.checkpoint.set(i.checkpoint.x,i.checkpoint.y,i.checkpoint.z),i.bloodstain?(s.bloodstain=new T(i.bloodstain.position.x,i.bloodstain.position.y,i.bloodstain.position.z),s.bloodstainRemnant=i.bloodstain.remnant):(s.bloodstain=null,s.bloodstainRemnant=0),s.recalculateStats&&s.recalculateStats()),this.systems.manaManager&&(this.systems.manaManager.currentMana=i.mana,this.systems.manaManager.maxMana=i.maxMana),this.systems.spellManager&&(this.systems.spellManager.unlockedSpells=new Set(i.unlockedSpells||["fireball"]),this.systems.spellManager.equippedSpells=[...i.equippedSpells||["fireball",null,null,null]]),console.log(`[StateRestoration] Player restored: Level ${i.level}, HP ${i.health}/${i.maxHealth}`)}restoreInventory(e){const t=this.systems.lootManager;if(!t||!e)return;const s={...ou(),...e};t.gold=s.gold,t.inventory=At(s.items||[]),t.collectedSouls=new Set(s.bossSouls||[]),t.collectedTrophies=new Set(s.bossTrophies||[]),this.validateInventoryItems(t.inventory),this.systems.inventoryUI?.refresh&&this.systems.inventoryUI.refresh(),console.log(`[StateRestoration] Inventory restored: ${s.gold} gold, ${s.items.length} items`)}restoreEquipment(e){const t=this.systems.equipmentManager;if(!t||!e)return;const s={...ru(),...e};t.equipped={weapon:s.equipped?.weapon?At(s.equipped.weapon):null,armor:s.equipped?.armor?At(s.equipped.armor):null,accessory:s.equipped?.accessory?At(s.equipped.accessory):null},t.weaponSlots=(s.weaponSlots||[null,null,null,null]).map(n=>n?At(n):null),t.activeWeaponSlot=s.activeWeaponSlot||0,t.potionSlots=[...s.potionSlots||[null,null]],t.refreshEquippedWeapon&&t.refreshEquippedWeapon(),t.updateEquipmentUI&&t.updateEquipmentUI(),console.log("[StateRestoration] Equipment restored")}restoreQuests(e){const t=this.systems.questManager;if(!t||!e)return;const s={...Ql(),...e};t.activeQuests=new Map,(s.activeQuests||[]).forEach(n=>{const{questId:a,...o}=n;this.validateQuestExists(a)?t.activeQuests.set(a,o):this.validationWarnings.push(`Quest '${a}' no longer exists, removed from active`)}),t.completedQuests=new Set(s.completedQuests||[]),t.failedQuests=new Set(s.failedQuests||[]),t.availableQuests=new Set(s.availableQuests||[]),t.questCooldowns=new Map,Object.entries(s.questCooldowns||{}).forEach(([n,a])=>{t.questCooldowns.set(n,a)}),t.trackedQuests=[...s.trackedQuests||[]],t.updateQuestUI&&t.updateQuestUI(),this.systems.questUI?.refresh&&this.systems.questUI.refresh(),console.log(`[StateRestoration] Quests restored: ${t.activeQuests.size} active, ${t.completedQuests.size} completed`)}restoreReputation(e){const t=this.systems.questRewards;if(!t||!e)return;const s={...lu(),...e};t.reputation={...s.factions},t.unlockedTitles=new Set(s.titles||[]),t.activeTitle=s.activeTitle,t.unlockedMilestones=new Set(s.unlockedMilestones||[]),t.unlockedAchievements=new Set(s.achievements||[]),console.log("[StateRestoration] Reputation restored")}restoreCrafting(e){const t=this.systems.craftingManager;if(!t||!e)return;const s={...cu(),...e};t.unlockedRecipes=new Set(s.unlockedRecipes||[]),t.stats=At(s.craftingStats||{totalCrafted:0,recipesCrafted:{}}),this.validateRecipes(t.unlockedRecipes),console.log(`[StateRestoration] Crafting restored: ${t.unlockedRecipes.size} recipes`)}restoreGathering(e){const t=this.systems.gatheringManager;if(!t||!e)return;const s={...hu(),...e};t.nodeCooldowns=new Map,Object.entries(s.nodeCooldowns||{}).forEach(([n,a])=>{t.nodeCooldowns.set(n,a)}),t.stats=At(s.gatheringStats||{totalGathered:0,gatheredByType:{}}),console.log("[StateRestoration] Gathering restored")}restoreCombat(e){const t=this.systems.gameManager;if(!t||!e)return;const s={...du(),...e};t.killCounts=At(s.killCounts||{}),this.systems.bossSpawner&&(this.systems.bossSpawner.killCounts=At(s.bossKillCounts||{})),s.records&&(t.longestCombo=s.records.longestCombo||0,t.perfectParries=s.records.perfectParries||0,t.noHitBossKills=new Set(s.records.noHitBossKills||[])),console.log("[StateRestoration] Combat stats restored")}restoreShop(e){const t=this.systems.shopManager;if(!t||!e)return;const s={...uu(),...e};t.purchasedItems=At(s.purchasedItems||{}),t.refreshTimes=At(s.shopRefreshTimes||{}),t.totalGoldSpent=s.totalGoldSpent||0,console.log("[StateRestoration] Shop state restored")}restoreBosses(e){const t=this.systems.bossSpawner;t&&(t.defeatedBosses=new Set(e||[]),t.updateBossStates&&t.updateBossStates(),console.log(`[StateRestoration] Bosses restored: ${t.defeatedBosses.size} defeated`))}restoreDungeons(e){const t=this.systems.dungeonManager;t&&(t.dungeonStates=At(e||{}),console.log("[StateRestoration] Dungeon states restored"))}validateSaveData(e){e.version||this.validationWarnings.push("Save has no version number");const t=["player","inventory","equipment"];for(const i of t)e[i]||this.validationWarnings.push(`Missing ${i} data, using defaults`);e.player?.level&&e.player.level<1&&this.validationErrors.push("Invalid player level")}postLoadValidation(e){this.validateActiveQuests(),this.validateEquippedItems(),this.emitEvent("onValidationComplete",{errors:this.validationErrors,warnings:this.validationWarnings})}validateInventoryItems(e){e.forEach((t,i)=>{t.id||this.validationWarnings.push(`Inventory item at index ${i} has no ID`)})}validateQuestExists(e){return!0}validateActiveQuests(){const e=this.systems.questManager;e?.activeQuests&&e.activeQuests.forEach((t,i)=>{(!t.objectives||!Array.isArray(t.objectives))&&this.validationWarnings.push(`Quest '${i}' has invalid objectives`)})}validateEquippedItems(){const e=this.systems.equipmentManager;if(e?.equipped)for(const[t,i]of Object.entries(e.equipped))i&&!i.id&&this.validationWarnings.push(`Equipped ${t} has no ID`)}validateRecipes(e){}refreshAllUI(){this.systems.hud?.updateAll&&this.systems.hud.updateAll(),this.systems.gameManager?.updateHUD&&this.systems.gameManager.updateHUD(),this.systems.questUI?.refresh&&this.systems.questUI.refresh(),this.systems.questManager?.updateQuestUI&&this.systems.questManager.updateQuestUI(),this.systems.inventoryUI?.refresh&&this.systems.inventoryUI.refresh(),this.systems.equipmentManager?.updateEquipmentUI&&this.systems.equipmentManager.updateEquipmentUI(),this.systems.timeManager?.updateClockUI&&this.systems.timeManager.updateClockUI(),console.log("[StateRestoration] UI refreshed")}on(e,t){this[e]&&Array.isArray(this[e])&&this[e].push(t)}off(e,t){if(this[e]&&Array.isArray(this[e])){const i=this[e].indexOf(t);i>-1&&this[e].splice(i,1)}}emitEvent(e,t){this[e]&&Array.isArray(this[e])&&this[e].forEach(i=>{try{i(t)}catch(s){console.error("[StateRestoration] Event callback error:",s)}})}}let rh=null;function NT(){return rh||(rh=new OT),rh}const Na="ashen_save_",lh="ashen_save_meta",zo=0,BT=3,Sf=300*1e3,zT=5*1024*1024,FT=.8;class UT{constructor(){this.systems={},this.currentSlot=null,this.lastSaveTime=0,this.sessionStartTime=Date.now(),this.totalPlaytime=0,this.autosaveEnabled=!0,this.autosaveTimer=null,this.lastAutosaveTime=0,this.isSaving=!1,this.isLoading=!1,this.saveBlocked=!1,this.saveBlockReason=null,this.onSaveStart=[],this.onSaveComplete=[],this.onSaveError=[],this.onLoadStart=[],this.onLoadComplete=[],this.onLoadError=[],this.onAutosaveTrigger=[],this.slotMetadataCache={},this.loadSlotMetadata(),console.log("[SaveManager] Initialized")}init(e){this.systems={gameManager:e.gameManager||null,player:e.player||null,inventoryUI:e.inventoryUI||null,equipmentManager:e.equipmentManager||null,lootManager:e.lootManager||null,questManager:e.questManager||null,questRewards:e.questRewards||null,timeManager:e.timeManager||null,weatherManager:e.weatherManager||null,craftingManager:e.craftingManager||null,gatheringManager:e.gatheringManager||null,shopManager:e.shopManager||null,bossSpawner:e.bossSpawner||null,dungeonManager:e.dungeonManager||null,spellManager:e.spellManager||null,manaManager:e.manaManager||null,npcManager:e.npcManager||null,scene:e.scene||null,hud:e.hud||null,questUI:e.questUI||null,renderer:e.renderer||null,camera:e.camera||null,audioManager:e.audioManager||null,terrain:e.terrain||null,world:e.world||null},this.stateRestoration=NT(),this.stateRestoration.registerSystems(this.systems),this.startAutosaveTimer(),console.log("[SaveManager] Systems registered")}async save(e,t={}){const{silent:i=!1,isAutosave:s=!1}=t;if(this.saveBlocked&&!t.force)return console.warn(`[SaveManager] Save blocked: ${this.saveBlockReason}`),this.emitEvent("onSaveError",{slotId:e,error:`Cannot save: ${this.saveBlockReason}`}),{success:!1,error:this.saveBlockReason};if(this.isSaving)return console.warn("[SaveManager] Save already in progress"),{success:!1,error:"Save in progress"};this.isSaving=!0,this.emitEvent("onSaveStart",{slotId:e,isAutosave:s});try{const n=this.gatherGameState(e,s),a=oh(n);if(!a.valid)throw new Error(`Invalid save data: ${a.errors.join(", ")}`);const o=this.compressSaveData(n),r=`${Na}${e}`,c=o.length*2;if(c>zT)throw new Error(`Save size (${(c/1024).toFixed(1)}KB) exceeds limit`);const h=this.safeStorageSet(r,o);if(!h.success)throw new Error(h.error);const d=_f(n);return this.slotMetadataCache[e]=d,this.saveSlotMetadata(),this.currentSlot=e,this.lastSaveTime=Date.now(),s&&(this.lastAutosaveTime=Date.now()),this.emitEvent("onSaveComplete",{slotId:e,isAutosave:s,size:c,timestamp:d.timestamp}),i||console.log(`[SaveManager] Saved to slot ${e} (${(c/1024).toFixed(1)}KB)`),{success:!0,slotId:e,size:c}}catch(n){return console.error("[SaveManager] Save failed:",n),this.emitEvent("onSaveError",{slotId:e,error:n.message}),{success:!1,error:n.message}}finally{this.isSaving=!1}}async load(e){if(this.isLoading)return console.warn("[SaveManager] Load already in progress"),{success:!1,error:"Load in progress"};this.isLoading=!0,this.emitEvent("onLoadStart",{slotId:e});try{const t=`${Na}${e}`,i=localStorage.getItem(t);if(!i)throw new Error("Save slot is empty");let s;try{s=this.decompressSaveData(i)}catch{if(console.warn("[SaveManager] Attempting corrupt save recovery..."),s=this.attemptRecovery(i),!s)throw new Error("Save data corrupted and unrecoverable")}const n=oh(s);if(n.warnings.length>0&&console.warn("[SaveManager] Save warnings:",n.warnings),!n.valid&&n.errors.some(a=>a.includes("newer")))throw new Error("Save from newer game version");if(s.version<Pn){const a=Mf(s);s=a.data,console.log("[SaveManager] Migrations applied:",a.migrationsApplied)}if(this.stateRestoration){const a=await this.stateRestoration.restoreGameState(s);a.warnings.length>0&&console.warn("[SaveManager] Restoration warnings:",a.warnings)}else this.distributeGameState(s);return this.currentSlot=e,this.totalPlaytime=s.playtime||0,this.sessionStartTime=Date.now(),this.emitEvent("onLoadComplete",{slotId:e,playerLevel:s.player?.level,playtime:s.playtime}),console.log(`[SaveManager] Loaded from slot ${e}`),{success:!0,slotId:e,saveData:s}}catch(t){return console.error("[SaveManager] Load failed:",t),this.emitEvent("onLoadError",{slotId:e,error:t.message}),{success:!1,error:t.message}}finally{this.isLoading=!1}}deleteSave(e){try{const t=`${Na}${e}`;return localStorage.removeItem(t),delete this.slotMetadataCache[e],this.saveSlotMetadata(),this.currentSlot===e&&(this.currentSlot=null),console.log(`[SaveManager] Deleted slot ${e}`),{success:!0}}catch(t){return console.error("[SaveManager] Delete failed:",t),{success:!1,error:t.message}}}gatherGameState(e,t=!1){const i=e0(e,t?Dn.AUTOSAVE:Dn.MANUAL),s=(Date.now()-this.sessionStartTime)/1e3;if(i.playtime=this.totalPlaytime+s,i.updatedAt=Date.now(),this.systems.player){const n=this.systems.player;i.player.position={x:n.position?.x||0,y:n.position?.y||0,z:n.position?.z||5},i.player.rotation={x:n.rotation?.x||0,y:n.rotation?.y||0,z:n.rotation?.z||0}}if(this.systems.gameManager){const n=this.systems.gameManager;i.player.health=n.health||100,i.player.maxHealth=n.maxHealth||100,i.player.stamina=n.stamina||100,i.player.maxStamina=n.maxStamina||100,i.player.posture=n.posture||0,i.player.maxPosture=n.maxPosture||100,i.player.level=n.currentLevel||1,i.player.currentXP=n.currentXP||0,i.player.remnant=n.remnant||0,i.player.heldRemnant=n.heldRemnant||0,i.player.stats={...n.stats},i.player.spentStatPoints=n.spentStatPoints||0,i.player.infusions={...n.infusions},i.player.unlockedAbilities=Array.from(n.unlockedAbilities||[]),i.player.abilityCooldowns={...n.abilityCooldowns},i.player.deathCount=n.deathCount||0,i.player.deathLessons={...n.deathLessons},n.checkpoint&&(i.player.checkpoint={x:n.checkpoint.x,y:n.checkpoint.y,z:n.checkpoint.z}),n.bloodstain&&(i.player.bloodstain={position:{x:n.bloodstain.x,y:n.bloodstain.y,z:n.bloodstain.z},remnant:n.bloodstainRemnant||0})}if(this.systems.manaManager){const n=this.systems.manaManager;i.player.mana=n.currentMana||50,i.player.maxMana=n.maxMana||50}if(this.systems.spellManager){const n=this.systems.spellManager;i.player.unlockedSpells=Array.from(n.unlockedSpells||["fireball"]),i.player.equippedSpells=[...n.equippedSpells||["fireball",null,null,null]]}if(this.systems.lootManager){const n=this.systems.lootManager;i.inventory.gold=n.gold||0,i.inventory.items=At(n.inventory||[]),i.inventory.bossSouls=Array.from(n.collectedSouls||[]),i.inventory.bossTrophies=Array.from(n.collectedTrophies||[])}if(this.systems.equipmentManager){const n=this.systems.equipmentManager;i.equipment.equipped={weapon:n.equipped?.weapon?At(n.equipped.weapon):null,armor:n.equipped?.armor?At(n.equipped.armor):null,accessory:n.equipped?.accessory?At(n.equipped.accessory):null},i.equipment.weaponSlots=(n.weaponSlots||[]).map(a=>a?At(a):null),i.equipment.activeWeaponSlot=n.activeWeaponSlot||0,i.equipment.potionSlots=[...n.potionSlots||[null,null]]}if(this.systems.questManager){const n=this.systems.questManager;i.quest.activeQuests=[],n.activeQuests&&n.activeQuests.forEach((a,o)=>{i.quest.activeQuests.push({questId:o,...At(a)})}),i.quest.completedQuests=Array.from(n.completedQuests||[]),i.quest.failedQuests=Array.from(n.failedQuests||[]),i.quest.availableQuests=Array.from(n.availableQuests||[]),i.quest.questCooldowns={},n.questCooldowns&&n.questCooldowns.forEach((a,o)=>{i.quest.questCooldowns[o]=a}),i.quest.trackedQuests=[...n.trackedQuests||[]]}if(this.systems.questRewards){const n=this.systems.questRewards;i.reputation.factions={...n.reputation},i.reputation.titles=Array.from(n.unlockedTitles||[]),i.reputation.activeTitle=n.activeTitle||null,i.reputation.unlockedMilestones=Array.from(n.unlockedMilestones||[]),i.reputation.achievements=Array.from(n.unlockedAchievements||[])}if(this.systems.timeManager){const n=this.systems.timeManager;i.world.time={currentHour:n.currentHour||10,currentMinute:n.currentMinute||0,currentDay:n.currentDay||1,dayPhase:n.dayPhase||"day",moonPhase:n.moonPhase||4,isPaused:n.isPaused||!1}}if(this.systems.weatherManager){const n=this.systems.weatherManager;i.world.weather={currentWeather:n.currentWeather||"clear",intensity:n.intensity||0,transitionProgress:n.transitionProgress||0,lastWeatherChange:n.lastWeatherChange||0}}if(this.systems.bossSpawner&&(i.world.bossesDefeated=Array.from(this.systems.bossSpawner.defeatedBosses||[])),this.systems.dungeonManager){const n=this.systems.dungeonManager;i.world.dungeons=At(n.dungeonStates||{})}if(this.systems.craftingManager){const n=this.systems.craftingManager;i.crafting.unlockedRecipes=Array.from(n.unlockedRecipes||[]),i.crafting.craftingStats=At(n.stats||{})}if(this.systems.gatheringManager){const n=this.systems.gatheringManager;i.gathering.nodeCooldowns={},n.nodeCooldowns&&(n.nodeCooldowns instanceof Map?n.nodeCooldowns.forEach((a,o)=>{i.gathering.nodeCooldowns[o]=a}):i.gathering.nodeCooldowns={...n.nodeCooldowns}),i.gathering.gatheringStats=At(n.stats||{})}if(this.systems.shopManager){const n=this.systems.shopManager;i.shop.purchasedItems=At(n.purchasedItems||{}),i.shop.shopRefreshTimes=At(n.refreshTimes||{}),i.shop.totalGoldSpent=n.totalGoldSpent||0}return i.combat.killCounts=At(this.systems.gameManager?.killCounts||{}),i.combat.bossKillCounts=At(this.systems.bossSpawner?.killCounts||{}),i.locationName=this.getCurrentLocationName(),i}distributeGameState(e){if(this.systems.player&&e.player.position){const t=e.player.position,i=5;let n=50,a=0,o=!1;const r=this.systems.terrain;if(r){r.forceGenerateAt&&r.forceGenerateAt(t.x,t.z);const c=r.getHeightAt||r.getTerrainHeight;c&&(a=c.call(r,t.x,t.z),o=!isNaN(a)&&isFinite(a)&&a>-100)}else this.systems.world&&this.systems.world.getFloorY&&(a=this.systems.world.getFloorY(t.x,t.z),o=!isNaN(a)&&isFinite(a)&&a>-100);o&&(n=a+i),console.log(`[SaveManager] Setting player position: (${t.x}, ${n}, ${t.z}) [terrain=${a}, ready=${o}]`),this.systems.player.position.set(t.x,n,t.z),e.player.rotation&&this.systems.player.rotation.set(e.player.rotation.x,e.player.rotation.y,e.player.rotation.z),this.systems.gameManager&&this.systems.gameManager.player&&this.systems.gameManager.player.recalculateSafeSpawn&&this.systems.gameManager.player.recalculateSafeSpawn()}if(this.systems.gameManager){const t=this.systems.gameManager,i=e.player;t.health=i.health,t.maxHealth=i.maxHealth,t.stamina=i.stamina,t.maxStamina=i.maxStamina,t.posture=i.posture,t.maxPosture=i.maxPosture,t.currentLevel=i.level,t.currentXP=i.currentXP,t.remnant=i.remnant,t.heldRemnant=i.heldRemnant,t.stats={...i.stats},t.spentStatPoints=i.spentStatPoints,t.infusions={...i.infusions},t.unlockedAbilities=new Set(i.unlockedAbilities||[]),t.abilityCooldowns={...i.abilityCooldowns},t.deathCount=i.deathCount,t.deathLessons={...i.deathLessons},i.checkpoint&&t.checkpoint.set(i.checkpoint.x,i.checkpoint.y,i.checkpoint.z),i.bloodstain?(t.bloodstain=new T(i.bloodstain.position.x,i.bloodstain.position.y,i.bloodstain.position.z),t.bloodstainRemnant=i.bloodstain.remnant):(t.bloodstain=null,t.bloodstainRemnant=0),t.updateHUD&&t.updateHUD()}if(this.systems.manaManager&&e.player&&(this.systems.manaManager.currentMana=e.player.mana,this.systems.manaManager.maxMana=e.player.maxMana),this.systems.spellManager&&e.player&&(this.systems.spellManager.unlockedSpells=new Set(e.player.unlockedSpells),this.systems.spellManager.equippedSpells=[...e.player.equippedSpells]),this.systems.lootManager&&e.inventory){const t=this.systems.lootManager,i=e.inventory;t.gold=i.gold,t.inventory=At(i.items),t.collectedSouls=new Set(i.bossSouls),t.collectedTrophies=new Set(i.bossTrophies)}if(this.systems.equipmentManager&&e.equipment){const t=this.systems.equipmentManager,i=e.equipment;t.equipped={weapon:i.equipped.weapon?At(i.equipped.weapon):null,armor:i.equipped.armor?At(i.equipped.armor):null,accessory:i.equipped.accessory?At(i.equipped.accessory):null},t.weaponSlots=i.weaponSlots.map(s=>s?At(s):null),t.activeWeaponSlot=i.activeWeaponSlot,t.potionSlots=[...i.potionSlots],t.refreshEquippedWeapon&&t.refreshEquippedWeapon()}if(this.systems.questManager&&e.quest){const t=this.systems.questManager,i=e.quest;t.activeQuests=new Map,(i.activeQuests||[]).forEach(s=>{const{questId:n,...a}=s;t.activeQuests.set(n,a)}),t.completedQuests=new Set(i.completedQuests),t.failedQuests=new Set(i.failedQuests),t.availableQuests=new Set(i.availableQuests),t.questCooldowns=new Map,Object.entries(i.questCooldowns||{}).forEach(([s,n])=>{t.questCooldowns.set(s,n)}),t.trackedQuests=[...i.trackedQuests||[]],t.updateQuestUI&&t.updateQuestUI()}if(this.systems.questRewards&&e.reputation){const t=this.systems.questRewards,i=e.reputation;t.reputation={...i.factions},t.unlockedTitles=new Set(i.titles),t.activeTitle=i.activeTitle,t.unlockedMilestones=new Set(i.unlockedMilestones),t.unlockedAchievements=new Set(i.achievements)}if(this.systems.timeManager&&e.world?.time){const t=this.systems.timeManager,i=e.world.time;t.currentHour=i.currentHour,t.currentMinute=i.currentMinute,t.currentDay=i.currentDay,t.dayPhase=i.dayPhase,t.moonPhase=i.moonPhase,t.isPaused=i.isPaused,t.updateCelestials&&t.updateCelestials(),t.updateClockUI&&t.updateClockUI()}if(this.systems.weatherManager&&e.world?.weather){const t=this.systems.weatherManager,i=e.world.weather;t.currentWeather=i.currentWeather,t.intensity=i.intensity,t.transitionProgress=i.transitionProgress,t.lastWeatherChange=i.lastWeatherChange,t.applyWeather&&t.applyWeather()}if(this.systems.bossSpawner&&e.world?.bossesDefeated&&(this.systems.bossSpawner.defeatedBosses=new Set(e.world.bossesDefeated)),this.systems.dungeonManager&&e.world?.dungeons&&(this.systems.dungeonManager.dungeonStates=At(e.world.dungeons)),this.systems.craftingManager&&e.crafting){const t=this.systems.craftingManager;t.unlockedRecipes=new Set(e.crafting.unlockedRecipes),t.stats=At(e.crafting.craftingStats)}if(this.systems.gatheringManager&&e.gathering){const t=this.systems.gatheringManager;t.nodeCooldowns=new Map,Object.entries(e.gathering.nodeCooldowns||{}).forEach(([i,s])=>{t.nodeCooldowns.set(i,s)}),t.stats=At(e.gathering.gatheringStats)}if(this.systems.shopManager&&e.shop){const t=this.systems.shopManager;t.purchasedItems=At(e.shop.purchasedItems),t.refreshTimes=At(e.shop.shopRefreshTimes),t.totalGoldSpent=e.shop.totalGoldSpent}this.systems.gameManager&&e.combat&&(this.systems.gameManager.killCounts=At(e.combat.killCounts)),this.systems.bossSpawner&&e.combat&&(this.systems.bossSpawner.killCounts=At(e.combat.bossKillCounts)),console.log("[SaveManager] Game state distributed to all systems")}compressSaveData(e){const t=JSON.stringify(e);return dl.compressToUTF16(t)}decompressSaveData(e){const t=dl.decompressFromUTF16(e);if(!t)throw new Error("Failed to decompress save data");return JSON.parse(t)}attemptRecovery(e){try{let t=dl.decompressFromUTF16(e);t||(t=dl.decompress(e)),t||(t=e);const i=JSON.parse(t);return console.log("[SaveManager] Recovery successful with alternate method"),i}catch(t){return console.error("[SaveManager] Recovery failed:",t),null}}getSaveInfo(e){return this.slotMetadataCache[e]||null}listSaves(){const e=[];e.push({slotId:zo,slotType:Dn.AUTOSAVE,label:"Autosave",metadata:this.slotMetadataCache[zo]||null,isEmpty:!this.slotMetadataCache[zo]});for(let t=1;t<=BT;t++)e.push({slotId:t,slotType:Dn.MANUAL,label:`Save Slot ${t}`,metadata:this.slotMetadataCache[t]||null,isEmpty:!this.slotMetadataCache[t]});return e}getMostRecentSave(){let e=null,t=0;for(const[i,s]of Object.entries(this.slotMetadataCache))s.timestamp>t&&(t=s.timestamp,e={slotId:parseInt(i),metadata:s});return e}hasSaves(){return Object.keys(this.slotMetadataCache).length>0}startAutosaveTimer(){this.autosaveTimer&&clearInterval(this.autosaveTimer),this.autosaveTimer=setInterval(()=>{this.autosaveEnabled&&!this.saveBlocked&&this.triggerAutosave("timer")},Sf),console.log(`[SaveManager] Autosave timer started (every ${Sf/6e4} min)`)}stopAutosaveTimer(){this.autosaveTimer&&(clearInterval(this.autosaveTimer),this.autosaveTimer=null)}async triggerAutosave(e="manual"){return console.log(`[SaveManager] Autosave triggered: ${e}`),this.emitEvent("onAutosaveTrigger",{reason:e}),this.save(zo,{silent:!1,isAutosave:!0})}blockSaving(e){this.saveBlocked=!0,this.saveBlockReason=e,console.log(`[SaveManager] Saving blocked: ${e}`)}unblockSaving(){this.saveBlocked=!1,this.saveBlockReason=null,console.log("[SaveManager] Saving unblocked")}canSave(){return!this.saveBlocked&&!this.isSaving}exportSave(e){try{const t=`${Na}${e}`,i=localStorage.getItem(t);if(!i)throw new Error("Save slot is empty");const s=this.decompressSaveData(i),n=JSON.stringify(s,null,2),a=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(a),r=document.createElement("a");return r.href=o,r.download=`ashen_save_slot${e}_${Date.now()}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),console.log(`[SaveManager] Exported slot ${e}`),{success:!0}}catch(t){return console.error("[SaveManager] Export failed:",t),{success:!1,error:t.message}}}async importSave(e,t){return new Promise(i=>{const s=new FileReader;s.onload=n=>{try{const a=JSON.parse(n.target.result),o=oh(a);if(!o.valid)throw new Error(`Invalid save: ${o.errors.join(", ")}`);let r=a;a.version<Pn&&(r=Mf(a).data),r.slotId=e,r.updatedAt=Date.now();const c=this.compressSaveData(r),h=`${Na}${e}`;localStorage.setItem(h,c);const d=_f(r);this.slotMetadataCache[e]=d,this.saveSlotMetadata(),console.log(`[SaveManager] Imported to slot ${e}`),i({success:!0,slotId:e})}catch(a){console.error("[SaveManager] Import failed:",a),i({success:!1,error:a.message})}},s.onerror=()=>{i({success:!1,error:"Failed to read file"})},s.readAsText(t)})}loadSlotMetadata(){try{const e=localStorage.getItem(lh);e&&(this.slotMetadataCache=JSON.parse(e))}catch(e){console.warn("[SaveManager] Failed to load metadata:",e),this.slotMetadataCache={}}}saveSlotMetadata(){try{localStorage.setItem(lh,JSON.stringify(this.slotMetadataCache))}catch(e){console.warn("[SaveManager] Failed to save metadata:",e)}}getCurrentLocationName(){return this.systems.dungeonManager?.currentDungeon?this.systems.dungeonManager.currentDungeon.name||"Unknown Dungeon":"Ashvale Village"}getCurrentPlaytime(){const e=(Date.now()-this.sessionStartTime)/1e3;return this.totalPlaytime+e}getFormattedPlaytime(){return cr(this.getCurrentPlaytime())}getStorageInfo(){try{let e=0,t=0;for(let a=0;a<localStorage.length;a++){const o=localStorage.key(a),r=localStorage.getItem(o),c=(o.length+r.length)*2;e+=c,(o.startsWith(Na)||o===lh)&&(t+=c)}const i=5*1024*1024,s=Math.max(0,i-e),n=e/i;return{totalUsed:e,savesUsed:t,available:s,usagePercent:n,isNearLimit:n>FT,formatted:{totalUsed:this.formatBytes(e),savesUsed:this.formatBytes(t),available:this.formatBytes(s)}}}catch(e){return console.warn("[SaveManager] Failed to get storage info:",e),null}}formatBytes(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(2)} MB`}isStorageNearLimit(){return this.getStorageInfo()?.isNearLimit||!1}freeStorageSpace(){let e=0;try{const t="ashen_save_screenshots",i=localStorage.getItem(t);i&&(e+=i.length*2,localStorage.removeItem(t),console.log("[SaveManager] Cleared screenshots to free space"))}catch(t){console.warn("[SaveManager] Failed to free storage:",t)}return e}safeStorageSet(e,t){try{return localStorage.setItem(e,t),{success:!0}}catch(i){if(i.name==="QuotaExceededError"||i.code===22){console.warn("[SaveManager] Storage quota exceeded, attempting cleanup...");const s=this.freeStorageSpace();if(s>0)try{return localStorage.setItem(e,t),{success:!0,freedSpace:s}}catch{return{success:!1,error:"Storage full. Please delete old saves to continue.",quotaExceeded:!0}}return{success:!1,error:"Storage full. Please delete old saves or export to file.",quotaExceeded:!0}}return{success:!1,error:i.message}}}on(e,t){this[e]&&Array.isArray(this[e])&&this[e].push(t)}off(e,t){if(this[e]&&Array.isArray(this[e])){const i=this[e].indexOf(t);i>-1&&this[e].splice(i,1)}}emitEvent(e,t){this[e]&&Array.isArray(this[e])&&this[e].forEach(i=>{try{i(t)}catch(s){console.error("[SaveManager] Event callback error:",s)}})}dispose(){this.stopAutosaveTimer(),this.systems={},console.log("[SaveManager] Disposed")}}let ch=null;function GT(){return ch||(ch=new UT),ch}const Tf=320,Ef=180,HT=160,qT=90,WT=2e3,ul=500;class VT{constructor(){this.saveManager=null,this.renderer=null,this.scene=null,this.camera=null,this.screenshots={},this.toastContainer=null,this.fadeOverlay=null,this.statisticsPanel=null,this.focusedSlotIndex=0,this.isMenuActive=!1,this.menuMode=null,this.statistics={enemiesKilled:0,bossesKilled:0,questsCompleted:0,deathCount:0,distanceTraveled:0,goldEarned:0,goldSpent:0,itemsCrafted:0,resourcesGathered:0,criticalHits:0,perfectParries:0},this.sounds={save:null,load:null,menuOpen:null,menuClose:null,select:null,error:null},console.log("[SaveUI] Created")}init(e,t,i,s,n=null){this.saveManager=e,this.renderer=t,this.scene=i,this.camera=s,n&&(this.sounds.save=()=>n.playSound?.("save",{volume:.6}),this.sounds.load=()=>n.playSound?.("load",{volume:.6}),this.sounds.menuOpen=()=>n.playSound?.("menu_open",{volume:.4}),this.sounds.menuClose=()=>n.playSound?.("menu_close",{volume:.4}),this.sounds.select=()=>n.playSound?.("menu_select",{volume:.3}),this.sounds.error=()=>n.playSound?.("error",{volume:.5})),this.loadScreenshots(),this.createToastContainer(),this.createFadeOverlay(),this.createStatisticsPanel(),this.injectEnhancedStyles(),this.hookSaveEvents(),console.log("[SaveUI] Initialized")}captureScreenshot(){if(!this.renderer||!this.scene||!this.camera)return console.warn("[SaveUI] Cannot capture screenshot - renderer not available"),null;try{const e=this.renderer.getSize(new le),t=document.createElement("canvas");return t.width=Tf,t.height=Ef,this.renderer.render(this.scene,this.camera),t.getContext("2d").drawImage(this.renderer.domElement,0,0,e.x,e.y,0,0,Tf,Ef),t.toDataURL("image/jpeg",.7)}catch(e){return console.error("[SaveUI] Screenshot capture failed:",e),null}}saveScreenshot(e){const t=this.captureScreenshot();return t&&(this.screenshots[e]=t,this.persistScreenshots()),t}loadScreenshots(){try{const e=localStorage.getItem("ashen_save_screenshots");e&&(this.screenshots=JSON.parse(e))}catch(e){console.warn("[SaveUI] Failed to load screenshots:",e),this.screenshots={}}}persistScreenshots(){try{localStorage.setItem("ashen_save_screenshots",JSON.stringify(this.screenshots))}catch(e){console.warn("[SaveUI] Failed to persist screenshots (storage full?):",e)}}getScreenshot(e){return this.screenshots[e]||null}deleteScreenshot(e){delete this.screenshots[e],this.persistScreenshots()}createToastContainer(){if(document.getElementById("save-toast-container")){this.toastContainer=document.getElementById("save-toast-container");return}this.toastContainer=document.createElement("div"),this.toastContainer.id="save-toast-container",document.body.appendChild(this.toastContainer)}showSaveToast(e,t=!1){const i=t?"Autosaved":`Saved to ${e}`;this.showToast(i,"success",""),this.sounds.save?.()}showLoadToast(e){this.showToast(`Loaded ${e}`,"success",""),this.sounds.load?.()}showErrorToast(e){this.showToast(e,"error",""),this.sounds.error?.()}showToast(e,t="info",i=""){const s=document.createElement("div");s.className=`save-toast ${t}`,s.innerHTML=`
      <span class="toast-icon">${i}</span>
      <span class="toast-message">${e}</span>
    `,this.toastContainer.appendChild(s),requestAnimationFrame(()=>{s.classList.add("visible")}),setTimeout(()=>{s.classList.remove("visible"),s.classList.add("hiding"),setTimeout(()=>s.remove(),300)},WT)}createFadeOverlay(){if(document.getElementById("save-fade-overlay")){this.fadeOverlay=document.getElementById("save-fade-overlay");return}this.fadeOverlay=document.createElement("div"),this.fadeOverlay.id="save-fade-overlay",document.body.appendChild(this.fadeOverlay)}async fadeToBlack(){return new Promise(e=>{this.fadeOverlay.classList.add("active"),setTimeout(e,ul)})}async fadeFromBlack(){return new Promise(e=>{this.fadeOverlay.classList.remove("active"),setTimeout(e,ul)})}async fadeTransition(e){await this.fadeToBlack(),await e(),await this.fadeFromBlack()}createStatisticsPanel(){if(document.getElementById("statistics-panel")){this.statisticsPanel=document.getElementById("statistics-panel");return}this.statisticsPanel=document.createElement("div"),this.statisticsPanel.id="statistics-panel",this.statisticsPanel.innerHTML=`
      <div class="stats-content">
        <h2> STATISTICS</h2>
        <div class="stats-grid" id="stats-grid"></div>
        <button class="menu-btn secondary stats-close-btn">Close</button>
      </div>
    `,document.body.appendChild(this.statisticsPanel),this.statisticsPanel.querySelector(".stats-close-btn").onclick=()=>{this.hideStatistics()}}showStatistics(){this.updateStatisticsDisplay(),this.statisticsPanel.classList.add("active"),this.sounds.menuOpen?.()}hideStatistics(){this.statisticsPanel.classList.remove("active"),this.sounds.menuClose?.()}updateStatisticsDisplay(){const e=document.getElementById("stats-grid");if(!e)return;this.gatherStatistics();const t=this.saveManager?.getCurrentPlaytime()||0;e.innerHTML=`
      <div class="stat-item">
        <span class="stat-label"> Total Playtime</span>
        <span class="stat-value">${cr(t)}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Enemies Killed</span>
        <span class="stat-value">${this.statistics.enemiesKilled.toLocaleString()}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Bosses Defeated</span>
        <span class="stat-value">${this.statistics.bossesKilled}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Quests Completed</span>
        <span class="stat-value">${this.statistics.questsCompleted}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Deaths</span>
        <span class="stat-value">${this.statistics.deathCount}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Distance Traveled</span>
        <span class="stat-value">${Math.floor(this.statistics.distanceTraveled).toLocaleString()}m</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Gold Earned</span>
        <span class="stat-value">${this.statistics.goldEarned.toLocaleString()}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Gold Spent</span>
        <span class="stat-value">${this.statistics.goldSpent.toLocaleString()}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Items Crafted</span>
        <span class="stat-value">${this.statistics.itemsCrafted}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Resources Gathered</span>
        <span class="stat-value">${this.statistics.resourcesGathered}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Critical Hits</span>
        <span class="stat-value">${this.statistics.criticalHits}</span>
      </div>
      <div class="stat-item">
        <span class="stat-label"> Perfect Parries</span>
        <span class="stat-value">${this.statistics.perfectParries}</span>
      </div>
    `}gatherStatistics(){const e=this.saveManager?.systems||{};e.gameManager?.killCounts&&(this.statistics.enemiesKilled=Object.values(e.gameManager.killCounts).reduce((t,i)=>t+i,0)),e.bossSpawner?.defeatedBosses&&(this.statistics.bossesKilled=e.bossSpawner.defeatedBosses.size||0),e.questManager?.completedQuests&&(this.statistics.questsCompleted=e.questManager.completedQuests.size||0),e.gameManager?.deathCount!==void 0&&(this.statistics.deathCount=e.gameManager.deathCount),e.shopManager&&(this.statistics.goldSpent=e.shopManager.totalGoldSpent||0),e.craftingManager?.stats?.totalCrafted!==void 0&&(this.statistics.itemsCrafted=e.craftingManager.stats.totalCrafted),e.gatheringManager?.stats?.totalGathered!==void 0&&(this.statistics.resourcesGathered=e.gatheringManager.stats.totalGathered)}addDistance(e){this.statistics.distanceTraveled+=e}incrementStat(e,t=1){this.statistics[e]!==void 0&&(this.statistics[e]+=t)}renderSlot(e,t="load"){const i=this.getScreenshot(e.slotId),s=e.slotType===Dn.AUTOSAVE||e.slotType==="autosave",n=document.createElement("div");if(n.className=`save-slot enhanced ${e.isEmpty?"empty":""} ${s?"autosave":""}`,n.dataset.slotId=e.slotId,n.tabIndex=0,e.isEmpty)n.innerHTML=`
        <div class="slot-thumbnail empty-thumb">
          <span class="empty-icon"></span>
        </div>
        <div class="slot-info">
          <div class="slot-name">${e.label}</div>
          <div class="slot-details">Empty Slot</div>
        </div>
        ${t==="save"?`
          <div class="slot-actions">
            <button class="slot-btn save-btn primary">Save Here</button>
          </div>
        `:""}
      `;else{const a=e.metadata,o=cr(a.playtime||0),r=t0(a.timestamp);n.innerHTML=`
        <div class="slot-thumbnail">
          ${i?`<img src="${i}" alt="Screenshot" />`:'<div class="no-thumb"></div>'}
          ${s?'<span class="autosave-badge">AUTO</span>':""}
        </div>
        <div class="slot-info">
          <div class="slot-name">${e.label}</div>
          <div class="slot-level">Level ${a.playerLevel} ${a.playerName||""}</div>
          <div class="slot-location"> ${a.locationName||"Unknown"}</div>
          <div class="slot-details">
            <span class="playtime"> ${o}</span>
            <span class="timestamp"> ${r}</span>
          </div>
          <div class="slot-progress">
            <span> ${a.bossesDefeated||0} Bosses</span>
            <span> ${a.questsCompleted||0} Quests</span>
          </div>
        </div>
        <div class="slot-actions">
          ${t==="load"?`
            <button class="slot-btn load-btn primary">Load</button>
            <button class="slot-btn delete-btn danger"></button>
            <button class="slot-btn export-btn"></button>
          `:`
            <button class="slot-btn save-btn primary">Overwrite</button>
          `}
        </div>
      `}return n}populateSlots(e,t="load",i={}){const s=document.getElementById(e);if(!s||!this.saveManager)return;const n=this.saveManager.listSaves();s.innerHTML="";let a=n;t==="save"&&!i.includeAutosave&&(a=n.filter(o=>o.slotType!=="autosave"&&o.slotType!==Dn.AUTOSAVE)),t==="load"&&i.sortByRecent&&a.sort((o,r)=>{const c=o.metadata?.timestamp||0;return(r.metadata?.timestamp||0)-c}),a.forEach((o,r)=>{const c=this.renderSlot(o,t);this.attachSlotListeners(c,o,t,i),s.appendChild(c)}),this.setupKeyboardNav(s)}attachSlotListeners(e,t,i,s){const n=e.querySelector(".load-btn");n&&(n.onclick=async c=>{c.stopPropagation(),this.sounds.select?.(),s.onLoad&&await s.onLoad(t.slotId)});const a=e.querySelector(".save-btn");a&&(a.onclick=async c=>{c.stopPropagation(),this.sounds.select?.(),this.saveScreenshot(t.slotId),s.onSave&&await s.onSave(t.slotId,!t.isEmpty)});const o=e.querySelector(".delete-btn");o&&(o.onclick=c=>{c.stopPropagation(),this.sounds.select?.(),s.onDelete&&s.onDelete(t.slotId,t.label)});const r=e.querySelector(".export-btn");r&&(r.onclick=c=>{c.stopPropagation(),this.sounds.select?.(),this.saveManager.exportSave(t.slotId),this.showToast("Save exported","success","")}),e.onclick=()=>{this.sounds.select?.(),this.selectSlot(e)}}selectSlot(e){e.parentElement.querySelectorAll(".save-slot").forEach(i=>i.classList.remove("selected")),e.classList.add("selected"),e.focus()}setupKeyboardNav(e){e.addEventListener("keydown",t=>{const i=e.querySelectorAll(".save-slot"),s=e.querySelector(".save-slot.selected, .save-slot:focus"),n=Array.from(i).indexOf(s);switch(t.key){case"ArrowUp":case"ArrowLeft":t.preventDefault(),n>0&&this.selectSlot(i[n-1]);break;case"ArrowDown":case"ArrowRight":t.preventDefault(),n<i.length-1&&this.selectSlot(i[n+1]);break;case"Enter":case" ":if(t.preventDefault(),s){const a=s.querySelector(".primary");a&&a.click()}break;case"Delete":case"Backspace":if(t.preventDefault(),s){const a=s.querySelector(".delete-btn");a&&a.click()}break}})}hookSaveEvents(){this.saveManager&&(this.saveManager.on("onSaveComplete",({slotId:e,isAutosave:t})=>{const n=this.saveManager.listSaves().find(a=>a.slotId===e)?.label||`Slot ${e}`;this.showSaveToast(n,t)}),this.saveManager.on("onSaveError",({error:e})=>{this.showErrorToast(`Save failed: ${e}`)}),this.saveManager.on("onLoadComplete",({slotId:e})=>{const s=this.saveManager.listSaves().find(n=>n.slotId===e)?.label||`Slot ${e}`;setTimeout(()=>{this.showLoadToast(s)},ul)}),this.saveManager.on("onLoadError",({error:e})=>{this.showErrorToast(`Load failed: ${e}`)}),this.saveManager.on("onAutosaveTrigger",({reason:e})=>{this.saveScreenshot(zo)}))}async loadWithFade(e){await this.fadeToBlack();const t=await this.saveManager.load(e);return t.success?await this.fadeFromBlack():this.fadeOverlay.classList.remove("active"),t}injectEnhancedStyles(){if(document.getElementById("save-ui-enhanced-styles"))return;const e=document.createElement("style");e.id="save-ui-enhanced-styles",e.textContent=`
      /* Toast Container */
      #save-toast-container {
        position: fixed;
        top: 80px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 10001;
        pointer-events: none;
      }
      
      .save-toast {
        background: rgba(20, 20, 30, 0.95);
        border: 1px solid rgba(200, 170, 100, 0.5);
        border-radius: 6px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #ddd;
        font-family: 'Cinzel', Georgia, serif;
        font-size: 14px;
        transform: translateX(120%);
        transition: transform 0.3s ease, opacity 0.3s ease;
        pointer-events: auto;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }
      
      .save-toast.visible {
        transform: translateX(0);
      }
      
      .save-toast.hiding {
        opacity: 0;
        transform: translateX(50px);
      }
      
      .save-toast.success {
        border-color: rgba(100, 200, 100, 0.6);
      }
      
      .save-toast.error {
        border-color: rgba(200, 80, 80, 0.6);
        background: rgba(40, 20, 20, 0.95);
      }
      
      .toast-icon {
        font-size: 20px;
      }
      
      /* Fade Overlay */
      #save-fade-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        opacity: 0;
        pointer-events: none;
        transition: opacity ${ul}ms ease;
        z-index: 9998;
      }
      
      #save-fade-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      
      /* Enhanced Slot Styles */
      .save-slot.enhanced {
        display: flex;
        gap: 16px;
        padding: 14px;
        background: rgba(25, 25, 35, 0.9);
        border: 1px solid rgba(100, 100, 120, 0.3);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .save-slot.enhanced:hover,
      .save-slot.enhanced.selected {
        background: rgba(35, 35, 50, 0.95);
        border-color: rgba(200, 170, 100, 0.5);
        transform: translateX(4px);
      }
      
      .save-slot.enhanced:focus {
        outline: none;
        border-color: rgba(200, 170, 100, 0.7);
        box-shadow: 0 0 10px rgba(200, 170, 100, 0.2);
      }
      
      .save-slot.enhanced.autosave {
        border-left: 3px solid rgba(100, 180, 100, 0.6);
      }
      
      .save-slot.enhanced.empty {
        opacity: 0.7;
      }
      
      /* Slot Thumbnail */
      .slot-thumbnail {
        width: ${HT}px;
        height: ${qT}px;
        background: rgba(10, 10, 15, 0.9);
        border-radius: 4px;
        overflow: hidden;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      
      .slot-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .slot-thumbnail .no-thumb,
      .slot-thumbnail .empty-icon {
        font-size: 32px;
        opacity: 0.4;
      }
      
      .autosave-badge {
        position: absolute;
        top: 4px;
        left: 4px;
        background: rgba(60, 140, 60, 0.9);
        color: #fff;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
        letter-spacing: 1px;
      }
      
      /* Slot Info */
      .save-slot.enhanced .slot-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }
      
      .save-slot.enhanced .slot-name {
        font-size: 16px;
        color: #c8a55a;
        font-weight: 600;
      }
      
      .save-slot.enhanced .slot-level {
        font-size: 14px;
        color: #ddd;
      }
      
      .save-slot.enhanced .slot-location {
        font-size: 12px;
        color: #aaa;
      }
      
      .save-slot.enhanced .slot-details {
        display: flex;
        gap: 16px;
        font-size: 11px;
        color: #888;
      }
      
      .save-slot.enhanced .slot-progress {
        display: flex;
        gap: 12px;
        font-size: 11px;
        color: #999;
        margin-top: 4px;
      }
      
      /* Slot Actions */
      .save-slot.enhanced .slot-actions {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-self: center;
      }
      
      .save-slot.enhanced .slot-btn {
        padding: 6px 12px;
        font-size: 12px;
        min-width: 80px;
      }
      
      .save-slot.enhanced .slot-btn.primary {
        background: linear-gradient(145deg, rgba(80, 65, 45, 0.9), rgba(60, 50, 35, 0.95));
        border-color: rgba(200, 170, 100, 0.5);
      }
      
      .save-slot.enhanced .slot-btn.primary:hover {
        background: linear-gradient(145deg, rgba(100, 80, 55, 0.9), rgba(80, 65, 45, 0.95));
        border-color: rgba(200, 170, 100, 0.7);
      }
      
      .save-slot.enhanced .slot-btn.danger {
        background: rgba(60, 30, 30, 0.8);
        border-color: rgba(180, 60, 60, 0.4);
        padding: 6px 8px;
        min-width: auto;
      }
      
      /* Statistics Panel */
      #statistics-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      
      #statistics-panel.active {
        display: flex;
      }
      
      .stats-content {
        background: linear-gradient(145deg, rgba(25, 25, 35, 0.98), rgba(15, 15, 20, 0.99));
        border: 2px solid rgba(200, 170, 100, 0.4);
        border-radius: 8px;
        padding: 30px 40px;
        min-width: 500px;
        max-width: 700px;
        animation: statsSlideIn 0.3s ease;
      }
      
      @keyframes statsSlideIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
      }
      
      .stats-content h2 {
        color: #c8a55a;
        font-family: 'Cinzel', Georgia, serif;
        font-size: 24px;
        margin-bottom: 24px;
        text-align: center;
        letter-spacing: 3px;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-bottom: 24px;
      }
      
      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        background: rgba(30, 30, 40, 0.6);
        border: 1px solid rgba(100, 100, 120, 0.2);
        border-radius: 4px;
      }
      
      .stat-label {
        color: #aaa;
        font-family: 'Cinzel', Georgia, serif;
        font-size: 12px;
      }
      
      .stat-value {
        color: #ddd;
        font-family: 'Cinzel', Georgia, serif;
        font-size: 14px;
        font-weight: 600;
      }
      
      .stats-close-btn {
        display: block;
        margin: 0 auto;
      }
    `,document.head.appendChild(e)}dispose(){this.toastContainer?.remove(),this.fadeOverlay?.remove(),this.statisticsPanel?.remove(),document.getElementById("save-ui-enhanced-styles")?.remove(),this.screenshots={},console.log("[SaveUI] Disposed")}}let hh=null;function i0(){return hh||(hh=new VT),hh}const $T=50,Cf={x:0,z:5},pl="ashen_tutorial_save_shown";class XT{constructor(){this.saveManager=null,this.saveUI=null,this.systems={},this.isInVillage=!1,this.wasInVillage=!1,this.isInCombat=!1,this.isInCutscene=!1,this.isInDialogue=!1,this.tutorialSaveShown=!1,this.saveIndicator=null,this.mainMenuOverlay=null,this.pauseMenuOverlay=null,this.loadMenuOverlay=null,this.saveMenuOverlay=null,this.confirmOverlay=null,this.isPaused=!1,this.gameStarted=!1,console.log("[SaveIntegration] Created")}init(e,t){this.saveManager=e,this.systems=t,this.saveUI=i0(),t.renderer&&t.scene&&t.camera&&this.saveUI.init(e,t.renderer,t.scene,t.camera,t.audioManager),this.tutorialSaveShown=localStorage.getItem(pl)==="true",this.createSaveIndicator(),this.createMainMenu(),this.createPauseMenu(),this.createLoadMenu(),this.createSaveMenu(),this.createConfirmDialog(),this.hookSaveEvents(),this.hookGameSystems(),this.setupKeyboardShortcuts();const s=new URLSearchParams(window.location.search).get("autostart");this.gameStarted||(s==="true"||s==="1"?(console.log("[SaveIntegration] Autostart enabled - skipping main menu"),this.startNewGame()):this.showMainMenu()),console.log("[SaveIntegration] Initialized")}createSaveIndicator(){if(document.getElementById("save-indicator")){this.saveIndicator=document.getElementById("save-indicator");return}this.saveIndicator=document.createElement("div"),this.saveIndicator.id="save-indicator",this.saveIndicator.innerHTML=`
      <div class="save-icon"></div>
      <span>Saving...</span>
    `;const e=document.createElement("style");e.textContent=`
      #save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.85);
        border: 1px solid rgba(200, 170, 100, 0.4);
        border-radius: 4px;
        padding: 10px 16px;
        color: #c8a55a;
        font-family: 'Cinzel', Georgia, serif;
        font-size: 14px;
        display: none;
        align-items: center;
        gap: 10px;
        z-index: 10000;
        animation: saveSlideIn 0.3s ease;
      }
      
      #save-indicator.active {
        display: flex;
      }
      
      #save-indicator .save-icon {
        animation: savePulse 1s infinite;
      }
      
      @keyframes saveSlideIn {
        from { transform: translateX(100px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      @keyframes savePulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
      }
    `,document.head.appendChild(e),document.body.appendChild(this.saveIndicator)}createMainMenu(){if(document.getElementById("main-menu-overlay")){this.mainMenuOverlay=document.getElementById("main-menu-overlay");return}this.mainMenuOverlay=document.createElement("div"),this.mainMenuOverlay.id="main-menu-overlay",this.mainMenuOverlay.innerHTML=`
      <div class="menu-content">
        <h1 class="game-title">PROJECT ASHEN</h1>
        <div class="menu-subtitle">A Souls-Like Adventure</div>
        <div class="menu-buttons">
          <button class="menu-btn" id="btn-continue" style="display:none">Continue</button>
          <button class="menu-btn" id="btn-new-game">New Game</button>
          <button class="menu-btn" id="btn-load-game">Load Game</button>
          <button class="menu-btn secondary" id="btn-settings">Settings</button>
        </div>
        <div class="menu-footer">Phase 26 Build  Save System</div>
      </div>
    `,this.addMenuStyles(),document.body.appendChild(this.mainMenuOverlay),document.getElementById("btn-continue").onclick=()=>this.handleContinue(),document.getElementById("btn-new-game").onclick=()=>this.handleNewGame(),document.getElementById("btn-load-game").onclick=()=>this.showLoadMenu(),document.getElementById("btn-settings").onclick=()=>this.showSettings()}createPauseMenu(){if(document.getElementById("pause-menu-overlay")){this.pauseMenuOverlay=document.getElementById("pause-menu-overlay");return}this.pauseMenuOverlay=document.createElement("div"),this.pauseMenuOverlay.id="pause-menu-overlay",this.pauseMenuOverlay.innerHTML=`
      <div class="menu-content pause-menu">
        <h2>PAUSED</h2>
        <div class="menu-buttons">
          <button class="menu-btn" id="btn-resume">Resume</button>
          <button class="menu-btn" id="btn-save-game">Save Game</button>
          <button class="menu-btn" id="btn-load-pause">Load Game</button>
          <button class="menu-btn secondary" id="btn-settings-pause">Settings</button>
          <button class="menu-btn danger" id="btn-main-menu">Return to Main Menu</button>
        </div>
        <div class="pause-info">
          <span id="pause-playtime">Playtime: 00:00</span>
        </div>
      </div>
    `,document.body.appendChild(this.pauseMenuOverlay),document.getElementById("btn-resume").onclick=()=>this.resumeGame(),document.getElementById("btn-save-game").onclick=()=>this.showSaveMenu(),document.getElementById("btn-load-pause").onclick=()=>this.showLoadMenu(),document.getElementById("btn-settings-pause").onclick=()=>this.showSettings(),document.getElementById("btn-main-menu").onclick=()=>this.confirmReturnToMainMenu()}createLoadMenu(){if(document.getElementById("load-menu-overlay")){this.loadMenuOverlay=document.getElementById("load-menu-overlay");return}this.loadMenuOverlay=document.createElement("div"),this.loadMenuOverlay.id="load-menu-overlay",this.loadMenuOverlay.innerHTML=`
      <div class="menu-content load-menu">
        <h2>LOAD GAME</h2>
        <div class="save-slots" id="load-slots"></div>
        <div class="menu-actions">
          <button class="menu-btn secondary" id="btn-import-save">Import Save</button>
          <button class="menu-btn secondary" id="btn-load-back">Back</button>
        </div>
      </div>
      <input type="file" id="import-file-input" accept=".json" style="display:none">
    `,document.body.appendChild(this.loadMenuOverlay),document.getElementById("btn-load-back").onclick=()=>this.hideLoadMenu(),document.getElementById("btn-import-save").onclick=()=>{document.getElementById("import-file-input").click()},document.getElementById("import-file-input").onchange=e=>this.handleImport(e)}createSaveMenu(){if(document.getElementById("save-menu-overlay")){this.saveMenuOverlay=document.getElementById("save-menu-overlay");return}this.saveMenuOverlay=document.createElement("div"),this.saveMenuOverlay.id="save-menu-overlay",this.saveMenuOverlay.innerHTML=`
      <div class="menu-content save-menu">
        <h2>SAVE GAME</h2>
        <div class="save-slots" id="save-slots"></div>
        <div class="menu-actions">
          <button class="menu-btn secondary" id="btn-save-back">Back</button>
        </div>
      </div>
    `,document.body.appendChild(this.saveMenuOverlay),document.getElementById("btn-save-back").onclick=()=>this.hideSaveMenu()}createConfirmDialog(){if(document.getElementById("confirm-overlay")){this.confirmOverlay=document.getElementById("confirm-overlay");return}this.confirmOverlay=document.createElement("div"),this.confirmOverlay.id="confirm-overlay",this.confirmOverlay.innerHTML=`
      <div class="confirm-dialog">
        <p id="confirm-message">Are you sure?</p>
        <div class="confirm-buttons">
          <button class="menu-btn danger" id="btn-confirm-yes">Yes</button>
          <button class="menu-btn secondary" id="btn-confirm-no">No</button>
        </div>
      </div>
    `,document.body.appendChild(this.confirmOverlay),document.getElementById("btn-confirm-no").onclick=()=>this.hideConfirmDialog()}addMenuStyles(){if(document.getElementById("save-menu-styles"))return;const e=document.createElement("style");e.id="save-menu-styles",e.textContent=`
      #main-menu-overlay,
      #pause-menu-overlay,
      #load-menu-overlay,
      #save-menu-overlay,
      #confirm-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-family: 'Cinzel', Georgia, serif;
      }
      
      #main-menu-overlay.active,
      #pause-menu-overlay.active,
      #load-menu-overlay.active,
      #save-menu-overlay.active,
      #confirm-overlay.active {
        display: flex;
      }
      
      .menu-content {
        background: linear-gradient(145deg, rgba(20, 20, 25, 0.98), rgba(10, 10, 15, 0.99));
        border: 2px solid rgba(200, 170, 100, 0.4);
        border-radius: 8px;
        padding: 40px 60px;
        text-align: center;
        min-width: 400px;
        max-width: 600px;
        animation: menuFadeIn 0.3s ease;
      }
      
      @keyframes menuFadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
      
      .game-title {
        font-size: 48px;
        color: #c8a55a;
        text-shadow: 0 0 20px rgba(200, 170, 100, 0.5);
        margin-bottom: 10px;
        letter-spacing: 8px;
      }
      
      .menu-subtitle {
        color: #888;
        font-size: 14px;
        margin-bottom: 40px;
        letter-spacing: 2px;
      }
      
      .menu-content h2 {
        color: #c8a55a;
        font-size: 28px;
        margin-bottom: 30px;
        letter-spacing: 4px;
      }
      
      .menu-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .menu-btn {
        background: linear-gradient(145deg, rgba(60, 50, 35, 0.9), rgba(40, 35, 25, 0.95));
        border: 1px solid rgba(200, 170, 100, 0.4);
        color: #ddd;
        padding: 14px 40px;
        font-size: 16px;
        font-family: 'Cinzel', Georgia, serif;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 4px;
        letter-spacing: 2px;
      }
      
      .menu-btn:hover {
        background: linear-gradient(145deg, rgba(80, 65, 45, 0.9), rgba(60, 50, 35, 0.95));
        border-color: rgba(200, 170, 100, 0.7);
        transform: scale(1.02);
      }
      
      .menu-btn.secondary {
        background: rgba(40, 40, 50, 0.8);
        border-color: rgba(100, 100, 120, 0.4);
      }
      
      .menu-btn.secondary:hover {
        background: rgba(50, 50, 60, 0.9);
        border-color: rgba(100, 100, 120, 0.7);
      }
      
      .menu-btn.danger {
        border-color: rgba(180, 60, 60, 0.5);
        color: #e88;
      }
      
      .menu-btn.danger:hover {
        border-color: rgba(200, 80, 80, 0.7);
        background: linear-gradient(145deg, rgba(80, 40, 40, 0.9), rgba(60, 30, 30, 0.95));
      }
      
      .menu-footer {
        margin-top: 40px;
        color: #555;
        font-size: 12px;
      }
      
      .pause-info {
        margin-top: 20px;
        color: #888;
        font-size: 14px;
      }
      
      /* Save Slots */
      .save-slots {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
        max-height: 400px;
        overflow-y: auto;
      }
      
      .save-slot {
        background: rgba(30, 30, 40, 0.8);
        border: 1px solid rgba(100, 100, 120, 0.3);
        border-radius: 4px;
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .save-slot:hover {
        background: rgba(40, 40, 55, 0.9);
        border-color: rgba(200, 170, 100, 0.4);
      }
      
      .save-slot.empty {
        opacity: 0.6;
        cursor: default;
      }
      
      .save-slot.empty:hover {
        background: rgba(30, 30, 40, 0.8);
        border-color: rgba(100, 100, 120, 0.3);
      }
      
      .save-slot.autosave {
        border-color: rgba(100, 180, 100, 0.4);
      }
      
      .slot-info {
        text-align: left;
      }
      
      .slot-name {
        color: #ddd;
        font-size: 16px;
        margin-bottom: 4px;
      }
      
      .slot-details {
        color: #888;
        font-size: 12px;
      }
      
      .slot-actions {
        display: flex;
        gap: 8px;
      }
      
      .slot-btn {
        background: rgba(60, 50, 35, 0.8);
        border: 1px solid rgba(200, 170, 100, 0.3);
        color: #ccc;
        padding: 6px 14px;
        font-size: 12px;
        font-family: 'Cinzel', Georgia, serif;
        cursor: pointer;
        border-radius: 3px;
        transition: all 0.2s;
      }
      
      .slot-btn:hover {
        background: rgba(80, 65, 45, 0.9);
        border-color: rgba(200, 170, 100, 0.6);
      }
      
      .slot-btn.delete {
        border-color: rgba(180, 60, 60, 0.4);
        color: #c88;
      }
      
      .slot-btn.delete:hover {
        border-color: rgba(200, 80, 80, 0.7);
        background: rgba(80, 40, 40, 0.8);
      }
      
      .menu-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 20px;
      }
      
      /* Confirm Dialog */
      .confirm-dialog {
        background: rgba(25, 25, 35, 0.98);
        border: 2px solid rgba(200, 170, 100, 0.5);
        border-radius: 8px;
        padding: 30px 40px;
        text-align: center;
      }
      
      .confirm-dialog p {
        color: #ddd;
        font-size: 16px;
        margin-bottom: 24px;
      }
      
      .confirm-buttons {
        display: flex;
        gap: 16px;
        justify-content: center;
      }
      
      /* Death screen addition */
      #death-screen .load-save-btn {
        margin-top: 20px;
        background: linear-gradient(145deg, rgba(60, 50, 35, 0.9), rgba(40, 35, 25, 0.95));
        border: 1px solid rgba(200, 170, 100, 0.4);
        color: #ddd;
        padding: 12px 30px;
        font-size: 14px;
        font-family: 'Cinzel', Georgia, serif;
        cursor: pointer;
        border-radius: 4px;
        letter-spacing: 2px;
      }
      
      /* Tutorial prompt */
      .tutorial-save-prompt {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(20, 20, 30, 0.95);
        border: 1px solid rgba(200, 170, 100, 0.5);
        border-radius: 6px;
        padding: 20px 30px;
        text-align: center;
        z-index: 5000;
        animation: promptSlideUp 0.4s ease;
      }
      
      @keyframes promptSlideUp {
        from { transform: translateX(-50%) translateY(100px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
      }
      
      .tutorial-save-prompt p {
        color: #ddd;
        margin-bottom: 15px;
        font-family: 'Cinzel', Georgia, serif;
      }
      
      .tutorial-save-prompt .prompt-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
      }
    `,document.head.appendChild(e)}hookSaveEvents(){this.saveManager&&(this.saveManager.on("onSaveStart",({isAutosave:e})=>{this.showSaveIndicator()}),this.saveManager.on("onSaveComplete",({slotId:e,isAutosave:t})=>{setTimeout(()=>this.hideSaveIndicator(),1e3)}),this.saveManager.on("onSaveError",({error:e})=>{this.hideSaveIndicator(),this.showNotification(`Save failed: ${e}`,"error")}),this.saveManager.on("onLoadComplete",({slotId:e})=>{this.hideAllMenus(),this.gameStarted=!0,this.showNotification("Game loaded","success")}),this.saveManager.on("onLoadError",({error:e})=>{this.showNotification(`Load failed: ${e}`,"error")}))}hookGameSystems(){this.systems.questManager&&this.systems.questManager.on?.("onQuestTurnedIn",()=>{this.triggerAutosaveIfAllowed("Quest completed")}),this.systems.gameManager,this.systems.dialogueManager}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{e.key==="Escape"&&(this.loadMenuOverlay?.classList.contains("active")?this.hideLoadMenu():this.saveMenuOverlay?.classList.contains("active")?this.hideSaveMenu():this.confirmOverlay?.classList.contains("active")?this.hideConfirmDialog():this.isPaused?this.resumeGame():this.gameStarted&&!this.mainMenuOverlay?.classList.contains("active")&&this.pauseGame(),e.preventDefault()),e.key==="F5"&&this.gameStarted&&!this.isPaused&&(this.quickSave(),e.preventDefault()),e.key==="F9"&&this.gameStarted&&(this.quickLoad(),e.preventDefault())})}updatePlayerPosition(e){const t=Math.sqrt(Math.pow(e.x-Cf.x,2)+Math.pow(e.z-Cf.z,2));this.isInVillage=t<$T,this.isInVillage&&!this.wasInVillage&&(this.triggerAutosaveIfAllowed("Entered village"),this.tutorialSaveShown||this.showTutorialSavePrompt()),this.wasInVillage=this.isInVillage}triggerAutosaveIfAllowed(e){if(this.isInCombat||this.isInCutscene||this.isInDialogue){console.log(`[SaveIntegration] Autosave blocked (${e}): combat/cutscene/dialogue active`);return}this.saveManager?.canSave()&&this.saveManager.triggerAutosave(e)}onCombatStart(){this.isInCombat=!0,this.saveManager?.blockSaving("In combat")}onCombatEnd(){this.isInCombat=!1,!this.isInCutscene&&!this.isInDialogue&&this.saveManager?.unblockSaving()}onCutsceneStart(){this.isInCutscene=!0,this.saveManager?.blockSaving("In cutscene")}onCutsceneEnd(){this.isInCutscene=!1,!this.isInCombat&&!this.isInDialogue&&this.saveManager?.unblockSaving()}onDialogueStart(){this.isInDialogue=!0,this.saveManager?.blockSaving("In dialogue")}onDialogueEnd(){this.isInDialogue=!1,!this.isInCombat&&!this.isInCutscene&&this.saveManager?.unblockSaving()}showMainMenu(){const e=document.getElementById("btn-continue");this.saveManager?.hasSaves()?e.style.display="block":e.style.display="none",this.mainMenuOverlay.classList.add("active"),this.isPaused=!0}hideMainMenu(){this.mainMenuOverlay?.classList.remove("active")}async handleContinue(){const e=this.saveManager?.getMostRecentSave();e&&(await this.saveManager.load(e.slotId)).success&&(this._positionCameraSafely(),this.hideMainMenu(),this.gameStarted=!0,this.isPaused=!1)}_positionCameraSafely(){const i=this.systems.player,s=this.systems.gameManager,n=this.systems.camera,a=s?.player?.world?.terrain||this.systems.terrain,o=s?.cameraController;if(!n||!i)return;const r=i.position.x,c=i.position.z+6;let h=i.position.y+8;if(a){const d=a.getHeightAt||a.getTerrainHeight;if(d){a.forceGenerateAt&&a.forceGenerateAt(r,c);const u=d.call(a,r,c);!isNaN(u)&&isFinite(u)&&u>-100&&(h=Math.max(h,u+8))}}h=Math.max(h,15),n.position.set(r,h,c),o&&(o.currentPos&&o.currentPos.set(r,h,c),o._firstFrame=!1,o._spawnSafetyFrames=120,o._terrainClampOffset=8),n.lookAt(i.position.x,i.position.y+1.5,i.position.z),n.updateProjectionMatrix(),n.updateMatrixWorld(!0),console.log(`[SaveIntegration] Camera positioned safely at Y=${h}`)}handleNewGame(){this.saveManager?.hasSaves()?this.showConfirmDialog("Start a new game? Your current saves will remain.",()=>this.startNewGame()):this.startNewGame()}startNewGame(){const e=window.AUTOSTART_MODE===!0;e&&console.log("[SaveIntegration] AUTOSTART MODE - Deferring spawn positioning to main.js IIFE");const t=e0(0);if(this.saveManager?.distributeGameState(t),e){console.log("[SaveIntegration] Skipping spawn positioning in autostart mode - main.js IIFE will handle it"),this.hideMainMenu(),this.gameStarted=!0,this.isPaused=!1,this.tutorialSaveShown=!1,localStorage.removeItem(pl),this.showNotification("New game started","success");return}const i=5,s=50,n=20,a=30,o=15,r=this.systems.player,c=this.systems.gameManager,h=this.systems.camera,d=c?.player?.world?.terrain||this.systems.terrain;if(d&&r)if(d.forceGenerateAt){const u=r.position.x,p=r.position.z;for(let f=-1;f<=1;f++)for(let y=-1;y<=1;y++)d.forceGenerateAt(u+f*64,p+y*64)}else d.update&&(d.lastPlayerChunkX=null,d.lastPlayerChunkZ=null,d.update(r.position.x,r.position.z));if(r&&r.position){let u=0,p=!1;if(d){const y=d.getHeightAt||d.getTerrainHeight;y&&(u=y.call(d,r.position.x,r.position.z),p=!isNaN(u)&&isFinite(u)&&u>-100)}const f=p?u+i:s;console.log(`[SaveIntegration] Player spawn: Y=${f} (terrain=${u}, ready=${p})`),r.position.y=f,c?.player?.velocity&&(c.player.velocity.y=0)}if(h&&r){const u=c?.cameraController,p=r.position.x,f=r.position.z+6;d&&d.forceGenerateAt&&d.forceGenerateAt(p,f);let y=r.position.y+n;if(d){const m=d.getHeightAt||d.getTerrainHeight;if(m){const g=m.call(d,p,f);if(!isNaN(g)&&isFinite(g)&&g>-100){const x=Math.max(g+o,a);y=Math.max(y,x)}}}y=Math.max(y,a),h.position.set(p,y,f),u&&(u.currentPos&&u.currentPos.set(p,y,f),u._firstFrame=!1,u._spawnSafetyFrames=300,u._terrainClampOffset=20,u._minCameraY=a,u._isAutostart=!1,u._terrainConfirmedReady=!1,u._terrainReadyFrames=0),h.lookAt(r.position.x,r.position.y+1.5,r.position.z),h.updateProjectionMatrix(),h.updateMatrixWorld(!0),console.log(`[SaveIntegration] Camera positioned at Y=${y.toFixed(2)}`)}c?.player?.recalculateSafeSpawn&&c.player.recalculateSafeSpawn(),this.hideMainMenu(),this.gameStarted=!0,this.isPaused=!1,this.tutorialSaveShown=!1,localStorage.removeItem(pl),this.showNotification("New game started","success")}pauseGame(){if(!this.gameStarted)return;this.isPaused=!0;const e=document.getElementById("pause-playtime");e&&this.saveManager&&(e.textContent=`Playtime: ${this.saveManager.getFormattedPlaytime()}`),this.pauseMenuOverlay?.classList.add("active"),this.systems.timeManager&&(this.systems.timeManager.isPaused=!0)}resumeGame(){this.isPaused=!1,this.pauseMenuOverlay?.classList.remove("active"),this.systems.timeManager&&(this.systems.timeManager.isPaused=!1)}confirmReturnToMainMenu(){this.showConfirmDialog("Return to main menu? Unsaved progress will be lost.",()=>{this.hidePauseMenu(),this.gameStarted=!1,this.showMainMenu()})}hidePauseMenu(){this.pauseMenuOverlay?.classList.remove("active"),this.isPaused=!1}showLoadMenu(){this.populateLoadSlots(),this.loadMenuOverlay?.classList.add("active")}hideLoadMenu(){this.loadMenuOverlay?.classList.remove("active")}populateLoadSlots(){const e=document.getElementById("load-slots");if(!e||!this.saveManager)return;if(this.saveUI){this.saveUI.populateSlots("load-slots","load",{sortByRecent:!0,onLoad:async i=>{await this.loadSlotWithFade(i)},onDelete:(i,s)=>{this.confirmDeleteSlot(i,s)}});return}const t=this.saveManager.listSaves();e.innerHTML="",t.forEach(i=>{const s=document.createElement("div");if(s.className=`save-slot ${i.isEmpty?"empty":""} ${i.slotType==="autosave"?"autosave":""}`,i.isEmpty)s.innerHTML=`
          <div class="slot-info">
            <div class="slot-name">${i.label}</div>
            <div class="slot-details">Empty</div>
          </div>
        `;else{const n=i.metadata;s.innerHTML=`
          <div class="slot-info">
            <div class="slot-name">${i.label} - Level ${n.playerLevel} ${n.playerName}</div>
            <div class="slot-details">
              ${n.locationName}  ${cr(n.playtime)}  ${t0(n.timestamp)}
            </div>
          </div>
          <div class="slot-actions">
            <button class="slot-btn load-btn">Load</button>
            <button class="slot-btn delete">Delete</button>
            <button class="slot-btn">Export</button>
          </div>
        `,s.querySelector(".load-btn").onclick=a=>{a.stopPropagation(),this.loadSlot(i.slotId)},s.querySelector(".delete").onclick=a=>{a.stopPropagation(),this.confirmDeleteSlot(i.slotId,i.label)},s.querySelectorAll(".slot-btn")[2].onclick=a=>{a.stopPropagation(),this.saveManager.exportSave(i.slotId)}}e.appendChild(s)})}async loadSlotWithFade(e){this.saveUI?(await this.saveUI.loadWithFade(e))?.success&&(this.hideLoadMenu(),this.hidePauseMenu(),this.hideMainMenu(),this.gameStarted=!0,this.isPaused=!1):await this.loadSlot(e)}async loadSlot(e){(await this.saveManager?.load(e))?.success&&(this._positionCameraSafely(),this.hideLoadMenu(),this.hidePauseMenu(),this.hideMainMenu(),this.gameStarted=!0,this.isPaused=!1)}showSaveMenu(){if(!this.saveManager?.canSave()){this.showNotification(`Cannot save: ${this.saveManager?.saveBlockReason||"Unknown"}`,"error");return}this.populateSaveSlots(),this.saveMenuOverlay?.classList.add("active")}hideSaveMenu(){this.saveMenuOverlay?.classList.remove("active")}populateSaveSlots(){const e=document.getElementById("save-slots");if(!e||!this.saveManager)return;if(this.saveUI){this.saveUI.populateSlots("save-slots","save",{includeAutosave:!1,onSave:async(i,s)=>{s?this.confirmOverwriteSlot(i,`Slot ${i}`):await this.saveToSlot(i)}});return}const t=this.saveManager.listSaves();e.innerHTML="",t.filter(i=>i.slotType!=="autosave").forEach(i=>{const s=document.createElement("div");if(s.className=`save-slot ${i.isEmpty?"empty":""}`,i.isEmpty)s.innerHTML=`
          <div class="slot-info">
            <div class="slot-name">${i.label}</div>
            <div class="slot-details">Empty Slot</div>
          </div>
          <div class="slot-actions">
            <button class="slot-btn save-btn">Save</button>
          </div>
        `;else{const n=i.metadata;s.innerHTML=`
          <div class="slot-info">
            <div class="slot-name">${i.label} - Level ${n.playerLevel}</div>
            <div class="slot-details">
              ${n.locationName}  ${cr(n.playtime)}
            </div>
          </div>
          <div class="slot-actions">
            <button class="slot-btn save-btn">Overwrite</button>
          </div>
        `}s.querySelector(".save-btn").onclick=n=>{n.stopPropagation(),i.isEmpty?this.saveToSlot(i.slotId):this.confirmOverwriteSlot(i.slotId,i.label)},e.appendChild(s)})}async saveToSlot(e){(await this.saveManager?.save(e))?.success&&(this.hideSaveMenu(),this.showNotification("Game saved","success"))}confirmOverwriteSlot(e,t){this.showConfirmDialog(`Overwrite ${t}?`,()=>this.saveToSlot(e))}confirmDeleteSlot(e,t){this.showConfirmDialog(`Delete ${t}? This cannot be undone.`,()=>{this.saveManager?.deleteSave(e),this.populateLoadSlots(),this.showNotification("Save deleted","success")})}async quickSave(){if(!this.saveManager?.canSave()){this.showNotification("Cannot save right now","error");return}(await this.saveManager.save(1))?.success&&this.showNotification("Quick saved","success")}async quickLoad(){const e=this.saveManager?.getMostRecentSave();e?(await this.saveManager.load(e.slotId))?.success&&(this._positionCameraSafely(),this.showNotification("Quick loaded","success")):this.showNotification("No saves found","error")}showConfirmDialog(e,t){document.getElementById("confirm-message").textContent=e,document.getElementById("btn-confirm-yes").onclick=()=>{this.hideConfirmDialog(),t()},this.confirmOverlay?.classList.add("active")}hideConfirmDialog(){this.confirmOverlay?.classList.remove("active")}async handleImport(e){const t=e.target.files[0];if(!t)return;const n=(this.saveManager?.listSaves()||[]).find(o=>o.slotType!=="autosave"&&o.isEmpty)?.slotId||3,a=await this.saveManager?.importSave(n,t);a?.success?(this.populateLoadSlots(),this.showNotification(`Imported to Slot ${n}`,"success")):this.showNotification(`Import failed: ${a?.error}`,"error"),e.target.value=""}showTutorialSavePrompt(){const e=document.createElement("div");e.className="tutorial-save-prompt",e.innerHTML=`
      <p> You've reached the village! Would you like to save your progress?</p>
      <div class="prompt-buttons">
        <button class="menu-btn" id="tutorial-save-yes">Save Now</button>
        <button class="menu-btn secondary" id="tutorial-save-no">Later</button>
      </div>
    `,document.body.appendChild(e),document.getElementById("tutorial-save-yes").onclick=()=>{e.remove(),this.showSaveMenu(),this.markTutorialSaveShown()},document.getElementById("tutorial-save-no").onclick=()=>{e.remove(),this.markTutorialSaveShown()}}markTutorialSaveShown(){this.tutorialSaveShown=!0,localStorage.setItem(pl,"true")}addLoadButtonToDeathScreen(){const e=document.getElementById("death-screen");if(!e||e.querySelector(".load-save-btn"))return;const t=document.createElement("button");t.className="load-save-btn",t.textContent="Load Last Save",t.onclick=()=>this.quickLoad(),e.appendChild(t)}showSaveIndicator(){this.saveIndicator?.classList.add("active")}hideSaveIndicator(){this.saveIndicator?.classList.remove("active")}showNotification(e,t="info"){const i=document.createElement("div");i.className=`save-notification ${t}`,i.textContent=e,i.style.cssText=`
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: ${t==="error"?"rgba(150, 40, 40, 0.95)":"rgba(40, 40, 60, 0.95)"};
      border: 1px solid ${t==="error"?"rgba(200, 80, 80, 0.6)":"rgba(200, 170, 100, 0.5)"};
      color: #ddd;
      padding: 12px 24px;
      border-radius: 4px;
      font-family: 'Cinzel', Georgia, serif;
      font-size: 14px;
      z-index: 10000;
      animation: notifSlide 0.3s ease;
    `,document.body.appendChild(i),setTimeout(()=>{i.style.opacity="0",i.style.transition="opacity 0.3s",setTimeout(()=>i.remove(),300)},2e3)}hideAllMenus(){this.mainMenuOverlay?.classList.remove("active"),this.pauseMenuOverlay?.classList.remove("active"),this.loadMenuOverlay?.classList.remove("active"),this.saveMenuOverlay?.classList.remove("active"),this.confirmOverlay?.classList.remove("active")}showSettings(){this.showNotification("Settings coming soon","info")}update(e){e&&this.updatePlayerPosition(e)}}let dh=null;function YT(){return dh||(dh=new XT),dh}const Af={castle:"#555555",safe_meadow:"#7aaa60",grassland:"#5a8a40",dense_woods:"#3a6030",dark_frontier:"#4a5a40",water:"#3a5a8a",village:"#8a7a60",ruins:"#6a6a6a",cave:"#3a3a40",dungeon:"#2a2a35"},Ss={player:{color:"#ffffff",size:8,shape:"arrow"},enemy:{color:"#ff4040",size:4,shape:"circle"},npc_friendly:{color:"#40ff40",size:5,shape:"circle"},npc_quest:{color:"#ffdd00",size:6,shape:"diamond"},quest_objective:{color:"#ffd700",size:7,shape:"star"},village:{color:"#d4a56a",size:8,shape:"house"},dungeon:{color:"#8040ff",size:7,shape:"skull"},gathering:{color:"#40c0c0",size:4,shape:"circle"},boss:{color:"#ff0000",size:10,shape:"skull"},waypoint:{color:"#00ffff",size:6,shape:"marker"},bonfire:{color:"#ff8800",size:6,shape:"flame"},crucible:{color:"#ffaa00",size:6,shape:"diamond"}};class QT{constructor(e={}){this.enabled=!0,this.visible=!0,this.size=e.size||150,this.padding=e.padding||15,this.zoomLevels=[50,100,200],this.currentZoomIndex=1,this.zoomRadius=this.zoomLevels[this.currentZoomIndex],this.gridResolution=64,this.sampleCache=new Map,this.cacheChunkSize=10,this.terrain=null,this.player=null,this.camera=null,this.enemyManager=null,this.npcManager=null,this.questManager=null,this.villageManager=null,this.dungeonManager=null,this.gatheringManager=null,this.bossSpawner=null,this.iconSources=[],this.customWaypoint=null,this.opacity=e.opacity||.85,this.pings=[],this.pingDuration=3e3,this.showWaypointDistance=!0,this._createMinimapDOM(),this._setupKeyBindings(),this.lastUpdateTime=0,this.updateInterval=50}init(e){this.terrain=e.terrain,this.player=e.player,this.camera=e.camera,this.enemyManager=e.enemyManager||null,this.npcManager=e.npcManager||null,this.questManager=e.questManager||null,this.villageManager=e.villageManager||null,this.dungeonManager=e.dungeonManager||null,this.gatheringManager=e.gatheringManager||null,this.bossSpawner=e.bossSpawner||null,this.gameManager=e.gameManager||null,this.fastTravelManager=e.fastTravelManager||null,this.player&&this.terrain&&this._renderTerrain()}setFastTravelManager(e){this.fastTravelManager=e}_createMinimapDOM(){this.container=document.createElement("div"),this.container.id="minimap-container",this.container.style.cssText=`
      position: fixed;
      top: ${this.padding}px;
      right: ${this.padding}px;
      width: ${this.size}px;
      height: ${this.size}px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid rgba(30, 20, 10, 0.9);
      box-shadow: 
        0 0 15px rgba(0, 0, 0, 0.6),
        inset 0 0 20px rgba(0, 0, 0, 0.4),
        0 0 0 2px rgba(180, 140, 80, 0.4);
      background: rgba(20, 15, 10, 0.85);
      z-index: 1000;
      pointer-events: auto;
      user-select: none;
    `,this.terrainCanvas=document.createElement("canvas"),this.terrainCanvas.width=this.size*2,this.terrainCanvas.height=this.size*2,this.terrainCanvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
    `,this.terrainCtx=this.terrainCanvas.getContext("2d"),this.iconsCanvas=document.createElement("canvas"),this.iconsCanvas.width=this.size*2,this.iconsCanvas.height=this.size*2,this.iconsCanvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      pointer-events: none;
    `,this.iconsCtx=this.iconsCanvas.getContext("2d"),this.playerCanvas=document.createElement("canvas"),this.playerCanvas.width=this.size*2,this.playerCanvas.height=this.size*2,this.playerCanvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      pointer-events: none;
    `,this.playerCtx=this.playerCanvas.getContext("2d"),this.northIndicator=document.createElement("div"),this.northIndicator.style.cssText=`
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      color: #ffd700;
      font-size: 12px;
      font-weight: bold;
      text-shadow: 0 0 3px black, 0 0 5px black;
      pointer-events: none;
      z-index: 10;
    `,this.northIndicator.textContent="N",this.zoomIndicator=document.createElement("div"),this.zoomIndicator.style.cssText=`
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.7);
      font-size: 10px;
      text-shadow: 0 0 3px black;
      pointer-events: none;
      z-index: 10;
    `,this._updateZoomIndicator(),this.waypointDistDisplay=document.createElement("div"),this.waypointDistDisplay.style.cssText=`
      position: absolute;
      bottom: ${this.size+this.padding+5}px;
      right: 0;
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(0, 255, 255, 0.5);
      border-radius: 4px;
      color: #00ffff;
      font-size: 11px;
      text-shadow: 0 0 3px black;
      pointer-events: none;
      z-index: 1001;
      display: none;
    `,this.container.parentNode?.appendChild(this.waypointDistDisplay),this.compassRing=document.createElement("div"),this.compassRing.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      border: 1px solid rgba(180, 140, 80, 0.3);
      pointer-events: none;
      box-sizing: border-box;
    `,this.legendButton=document.createElement("div"),this.legendButton.style.cssText=`
      position: absolute;
      top: 4px;
      right: 4px;
      width: 16px;
      height: 16px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #fff;
      z-index: 15;
    `,this.legendButton.textContent="?",this.legendButton.title="Toggle Legend",this.legendButton.addEventListener("click",e=>{e.stopPropagation(),this._toggleLegend()}),this.container.appendChild(this.terrainCanvas),this.container.appendChild(this.iconsCanvas),this.container.appendChild(this.playerCanvas),this.container.appendChild(this.compassRing),this.container.appendChild(this.northIndicator),this.container.appendChild(this.zoomIndicator),this.container.appendChild(this.legendButton),this._createLegendPanel(),document.body.appendChild(this.container),this.container.addEventListener("click",e=>{e.target!==this.legendButton&&this._cycleZoom()}),this.container.addEventListener("dblclick",e=>{e.target!==this.legendButton&&this._handleFastTravelClick(e)}),this.container.addEventListener("contextmenu",e=>{e.preventDefault(),this._placeWaypoint(e)})}_createLegendPanel(){this.legendPanel=document.createElement("div"),this.legendPanel.style.cssText=`
      position: absolute;
      top: ${this.padding}px;
      right: ${this.size+this.padding+10}px;
      background: rgba(20, 15, 10, 0.95);
      border: 2px solid rgba(180, 140, 80, 0.6);
      border-radius: 8px;
      padding: 10px 12px;
      color: #ddd;
      font-size: 11px;
      z-index: 999;
      display: none;
      min-width: 120px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
    `;const e=document.createElement("div");e.style.cssText=`
      font-weight: bold;
      color: #ffd700;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(180, 140, 80, 0.4);
      padding-bottom: 4px;
    `,e.textContent="Map Legend",this.legendPanel.appendChild(e);const t=[{icon:Ss.player,label:"You"},{icon:Ss.enemy,label:"Enemy"},{icon:Ss.npc_quest,label:"Quest NPC"},{icon:Ss.quest_objective,label:"Objective"},{icon:Ss.village,label:"Village"},{icon:Ss.dungeon,label:"Dungeon"},{icon:Ss.boss,label:"World Boss"},{icon:Ss.bonfire,label:"Bonfire"},{icon:Ss.waypoint,label:"Waypoint"}];for(const s of t){const n=document.createElement("div");n.style.cssText=`
        display: flex;
        align-items: center;
        margin: 4px 0;
      `;const a=document.createElement("span");a.style.cssText=`
        display: inline-block;
        width: 12px;
        height: 12px;
        background: ${s.icon.color};
        border-radius: ${s.icon.shape==="circle"?"50%":"2px"};
        margin-right: 8px;
      `;const o=document.createElement("span");o.textContent=s.label,n.appendChild(a),n.appendChild(o),this.legendPanel.appendChild(n)}const i=document.createElement("div");i.style.cssText=`
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid rgba(180, 140, 80, 0.4);
      font-size: 10px;
      color: #999;
    `,i.innerHTML=`
      <div><b>M</b> - Toggle map</div>
      <div><b>Click</b> - Zoom</div>
      <div><b>Double-click</b> - Fast travel</div>
      <div><b>Right-click</b> - Waypoint</div>
    `,this.legendPanel.appendChild(i),document.body.appendChild(this.legendPanel)}_toggleLegend(){const e=this.legendPanel.style.display!=="none";this.legendPanel.style.display=e?"none":"block"}_setupKeyBindings(){document.addEventListener("keydown",e=>{(e.key==="m"||e.key==="M")&&this.toggle()})}toggle(){this.visible=!this.visible,this.container.style.display=this.visible?"block":"none",this.visible||(this.legendPanel.style.display="none")}show(){this.visible=!0,this.container.style.display="block"}hide(){this.visible=!1,this.container.style.display="none",this.legendPanel.style.display="none"}_cycleZoom(){this.currentZoomIndex=(this.currentZoomIndex+1)%this.zoomLevels.length,this.zoomRadius=this.zoomLevels[this.currentZoomIndex],this._updateZoomIndicator(),this.sampleCache.clear(),this._renderTerrain()}setZoom(e){e>=0&&e<this.zoomLevels.length&&(this.currentZoomIndex=e,this.zoomRadius=this.zoomLevels[this.currentZoomIndex],this._updateZoomIndicator(),this.sampleCache.clear(),this._renderTerrain())}_updateZoomIndicator(){this.zoomIndicator.textContent=`${this.zoomRadius}m`}_handleFastTravelClick(e){if(!this.fastTravelManager||!this.player)return;const t=this.container.getBoundingClientRect(),i=t.width/2,s=t.height/2,n=e.clientX-t.left-i,a=e.clientY-t.top-s,o=this.zoomRadius/(this.size/2),r=n*o,c=a*o,h=this._getCameraAngle(),d=Math.cos(h),u=Math.sin(h),p=r*d-c*u,f=r*u+c*d,y=this.player.position||this.player,m=y.x+p,g=y.z+f,x=this.fastTravelManager.getDiscoveredLocations(),v=15*o;for(const b of x){const _=b.x-m,S=b.z-g;if(Math.sqrt(_*_+S*S)<v){const R=this._getLocationId(b);this.fastTravelManager.startTravel(R);return}}if(this.customWaypoint){const b=this.customWaypoint.x-m,_=this.customWaypoint.z-g;if(Math.sqrt(b*b+_*_)<v){this.fastTravelManager.travelToCoordinates(this.customWaypoint.x,this.customWaypoint.z,"Custom Waypoint");return}}}_getLocationId(e){if(this.fastTravelManager){const t=this.fastTravelManager.discoveredLocations;for(const[i,s]of t)if(s.x===e.x&&s.z===e.z)return i}return e.name.toLowerCase().replace(/\s+/g,"_")}_placeWaypoint(e){if(!this.player)return;const t=this.container.getBoundingClientRect(),i=t.width/2,s=t.height/2,n=e.clientX-t.left-i,a=e.clientY-t.top-s,o=this.zoomRadius/(this.size/2),r=n*o,c=a*o,h=this._getCameraAngle(),d=Math.cos(h),u=Math.sin(h),p=r*d-c*u,f=r*u+c*d,y=this.player.position||this.player;this.customWaypoint=new T(y.x+p,0,y.z+f),this._showWaypointFeedback()}clearWaypoint(){this.customWaypoint=null}_showWaypointFeedback(){const e=document.createElement("div");e.style.cssText=`
      position: fixed;
      top: ${this.padding+this.size+10}px;
      right: ${this.padding}px;
      background: rgba(0, 0, 0, 0.8);
      color: #00ffff;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 1001;
      animation: fadeOut 2s forwards;
    `,e.textContent="Waypoint placed (right-click to clear)",document.body.appendChild(e),setTimeout(()=>e.remove(),2e3)}_getCameraAngle(){if(!this.camera)return 0;const e=new T(0,0,-1);return e.applyQuaternion(this.camera.quaternion),Math.atan2(e.x,e.z)}_renderTerrain(){if(!this.terrain||!this.player)return;const e=this.terrainCtx,t=this.size*2,i=t/2,s=this.player.position||this.player,n=s.x,a=s.z;e.fillStyle="#1a1510",e.fillRect(0,0,t,t);const o=this.zoomRadius,r=i/o,c=this._getCameraAngle();o*2/this.gridResolution,e.save(),e.translate(i,i),e.rotate(-c);for(let h=0;h<=this.gridResolution;h++)for(let d=0;d<=this.gridResolution;d++){const u=(h/this.gridResolution-.5)*o*2,p=(d/this.gridResolution-.5)*o*2,f=n+u,y=a+p,m=this.terrain.getBiome(f,y),g=this.terrain.getTerrainHeight(f,y);let x=Af[m]||Af.grassland;const b=.6+gt.clamp((g+10)/40,0,1)*.4,_=this._parseColor(x),S={r:Math.floor(_.r*b),g:Math.floor(_.g*b),b:Math.floor(_.b*b)};e.fillStyle=`rgb(${S.r}, ${S.g}, ${S.b})`;const A=u*r,R=p*r,M=Math.ceil(o*2*r/this.gridResolution)+1;e.fillRect(A-M/2,R-M/2,M,M)}e.restore(),this._applyCircularMask(e,t)}_parseColor(e){if(e.startsWith("#")){const t=e.slice(1);return{r:parseInt(t.slice(0,2),16),g:parseInt(t.slice(2,4),16),b:parseInt(t.slice(4,6),16)}}return{r:100,g:100,b:100}}_applyCircularMask(e,t){e.globalCompositeOperation="destination-in",e.beginPath(),e.arc(t/2,t/2,t/2,0,Math.PI*2),e.fill(),e.globalCompositeOperation="source-over"}_renderIcons(){if(!this.player)return;const e=this.iconsCtx,t=this.size*2,i=t/2;e.clearRect(0,0,t,t);const s=this.player.position||this.player,n=this._getCameraAngle(),a=i/this.zoomRadius;e.save(),e.translate(i,i),e.rotate(-n);const o=this._collectIcons();for(const r of o){const c=r.x-s.x,h=r.z-s.z,d=Math.sqrt(c*c+h*h);if(d>this.zoomRadius*1.2)continue;const u=c*a,p=h*a;let f=1;d>this.zoomRadius*.8&&(f=1-(d-this.zoomRadius*.8)/(this.zoomRadius*.4)),e.globalAlpha=Math.max(0,f),this._drawIcon(e,u,p,r.type,r.size)}if(this.customWaypoint){const r=this.customWaypoint.x-s.x,c=this.customWaypoint.z-s.z,h=r*a,d=c*a;e.globalAlpha=1,this._drawIcon(e,h,d,"waypoint",8)}e.restore(),e.globalAlpha=1,this._applyCircularMask(e,t)}_collectIcons(){const e=[];if(this.enemyManager&&this.enemyManager.enemies)for(const t of this.enemyManager.enemies)!t.mesh||t.isDead||e.push({x:t.mesh.position.x,z:t.mesh.position.z,type:t.isBoss?"boss":"enemy",size:t.isBoss?10:(t.threat||1)*3+3});if(this.npcManager&&this.npcManager.npcs)for(const t of this.npcManager.npcs){if(!t.mesh)continue;const i=t.hasQuest||t.questAvailable;e.push({x:t.mesh.position.x,z:t.mesh.position.z,type:i?"npc_quest":"npc_friendly",size:i?6:5})}if(this.villageManager&&this.villageManager.getVillagePositions){const t=this.villageManager.getVillagePositions();for(const i of t)e.push({x:i.x,z:i.z,type:"village",size:8})}if(this.dungeonManager&&this.dungeonManager.getDungeonEntrances){const t=this.dungeonManager.getDungeonEntrances();for(const i of t)e.push({x:i.x,z:i.z,type:"dungeon",size:7})}if(this.questManager&&this.questManager.getQuestMarkers){const t=this.questManager.getQuestMarkers();for(const i of t)if(i.position){let s="quest_objective";(i.type==="available"||i.type==="turn_in")&&(s="npc_quest"),e.push({x:i.position.x,z:i.position.z,type:s,size:i.type==="objective"?7:6})}}if(this.gameManager&&this.gameManager.getDiscoveredBonfires){const t=this.gameManager.getDiscoveredBonfires();for(const i of t)e.push({x:i.x,z:i.z,type:"bonfire",size:6})}if(this.showGatheringNodes&&this.gatheringManager&&this.gatheringManager.getActiveNodes){const t=this.gatheringManager.getActiveNodes();for(const i of t)e.push({x:i.x,z:i.z,type:"gathering",size:4})}return e}_drawIcon(e,t,i,s,n){const a=Ss[s]||Ss.enemy;switch(e.fillStyle=a.color,e.strokeStyle="#000",e.lineWidth=1,a.shape){case"circle":e.beginPath(),e.arc(t,i,n,0,Math.PI*2),e.fill(),e.stroke();break;case"diamond":e.beginPath(),e.moveTo(t,i-n),e.lineTo(t+n,i),e.lineTo(t,i+n),e.lineTo(t-n,i),e.closePath(),e.fill(),e.stroke();break;case"star":this._drawStar(e,t,i,n,5);break;case"skull":e.beginPath(),e.arc(t,i-n*.2,n*.7,0,Math.PI*2),e.fill(),e.stroke(),e.fillRect(t-n*.3,i+n*.2,n*.6,n*.5);break;case"house":e.beginPath(),e.moveTo(t-n*.6,i+n*.4),e.lineTo(t-n*.6,i-n*.2),e.lineTo(t,i-n*.7),e.lineTo(t+n*.6,i-n*.2),e.lineTo(t+n*.6,i+n*.4),e.closePath(),e.fill(),e.stroke();break;case"flame":e.beginPath(),e.moveTo(t,i-n),e.quadraticCurveTo(t+n,i-n*.3,t+n*.5,i+n*.5),e.quadraticCurveTo(t,i+n*.2,t-n*.5,i+n*.5),e.quadraticCurveTo(t-n,i-n*.3,t,i-n),e.fill(),e.stroke();break;case"marker":e.beginPath(),e.arc(t,i-n*.5,n*.5,0,Math.PI*2),e.fill(),e.stroke(),e.beginPath(),e.moveTo(t-n*.4,i),e.lineTo(t,i+n),e.lineTo(t+n*.4,i),e.fill(),e.stroke();break;default:e.beginPath(),e.moveTo(t,i-n),e.lineTo(t+n*.6,i+n),e.lineTo(t,i+n*.5),e.lineTo(t-n*.6,i+n),e.closePath(),e.fill(),e.stroke();break}}_drawStar(e,t,i,s,n){e.beginPath();for(let a=0;a<n*2;a++){const o=a*Math.PI/n-Math.PI/2,r=a%2===0?s:s*.5,c=t+Math.cos(o)*r,h=i+Math.sin(o)*r;a===0?e.moveTo(c,h):e.lineTo(c,h)}e.closePath(),e.fill(),e.stroke()}_renderPlayer(){const e=this.playerCtx,t=this.size*2,i=t/2;e.clearRect(0,0,t,t),e.save(),e.translate(i,i);const s=12;e.fillStyle="#ffffff",e.strokeStyle="#000",e.lineWidth=2,e.beginPath(),e.moveTo(0,-s),e.lineTo(s*.6,s*.6),e.lineTo(0,s*.2),e.lineTo(-s*.6,s*.6),e.closePath(),e.fill(),e.stroke(),e.shadowColor="#ffffff",e.shadowBlur=5,e.fill(),e.shadowBlur=0,e.restore()}update(e){if(!this.visible||!this.enabled||!this.player)return;const t=performance.now();if(!(t-this.lastUpdateTime<this.updateInterval)&&(this.lastUpdateTime=t,this._updatePings(),this._updateWaypointDistanceDisplay(),this._renderTerrain(),this._renderIcons(),this._renderPlayer(),this.pings.length>0&&this.player)){const i=this.iconsCtx,s=this.size*2,n=s/2,a=s/2/this.zoomRadius;this._renderPings(i,n,a)}}addIconSource(e){this.iconSources.push(e)}removeIconSource(e){const t=this.iconSources.indexOf(e);t>=0&&this.iconSources.splice(t,1)}toggleGatheringNodes(){this.showGatheringNodes=!this.showGatheringNodes}getWaypointDistance(){if(!this.customWaypoint||!this.player)return null;const e=this.player.position||this.player,t=this.customWaypoint.x-e.x,i=this.customWaypoint.z-e.z;return Math.sqrt(t*t+i*i)}setOpacity(e){this.opacity=Math.max(.3,Math.min(1,e)),this.container.style.opacity=this.opacity,localStorage.setItem("ashen-minimap-opacity",this.opacity.toString())}getOpacity(){return this.opacity}loadOpacity(){const e=localStorage.getItem("ashen-minimap-opacity");e&&this.setOpacity(parseFloat(e))}addPing(e,t,i="#00ffff"){this.pings.push({x:e,z:t,timestamp:performance.now(),color:i}),this.pings.length>5&&this.pings.shift()}_updatePings(){const e=performance.now();this.pings=this.pings.filter(t=>e-t.timestamp<this.pingDuration)}_renderPings(e,t,i){if(!this.player)return;const s=performance.now(),n=this.player.position||this.player;for(const a of this.pings){const o=s-a.timestamp,r=1-o/this.pingDuration,c=1+Math.sin(o/100)*.3,h=a.x-n.x,d=a.z-n.z,u=t+h*i,p=t+d*i;Math.sqrt((u-t)**2+(p-t)**2)>this.size-10||(e.beginPath(),e.arc(u,p,8*c,0,Math.PI*2),e.strokeStyle=a.color,e.lineWidth=2,e.globalAlpha=r*.8,e.stroke(),e.beginPath(),e.arc(u,p,3,0,Math.PI*2),e.fillStyle=a.color,e.globalAlpha=r,e.fill(),e.globalAlpha=1)}}_updateWaypointDistanceDisplay(){if(!this.waypointDistDisplay)return;const e=this.getWaypointDistance();if(e!==null&&this.showWaypointDistance){let t;e<10?t=`${e.toFixed(1)}m`:t=`${Math.round(e)}m`,this.waypointDistDisplay.textContent=` ${t}`,this.waypointDistDisplay.style.display="block"}else this.waypointDistDisplay.style.display="none"}dispose(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.legendPanel&&this.legendPanel.parentNode&&this.legendPanel.parentNode.removeChild(this.legendPanel)}}let uh=null;function jT(l){return uh||(uh=new QT(l)),uh}const Rf=["Rest at bonfires to fully restore health and mana.","Dodge rolling grants brief invincibility frames.","Heavy attacks break enemy guard faster.","Infuse your stats at crucibles to grow stronger.","Explore ruins for hidden chests and rare equipment.","Weather affects combat - rain reduces fire damage.","Night brings stronger enemies but better loot.","Crafting stations in villages offer powerful recipes.","Quest NPCs have golden markers above their heads.","Parrying at the right moment staggers enemies.","Gathering nodes respawn after time passes.","Dungeons contain unique bosses and rewards.","Your stamina regenerates faster while standing still.","Spells consume mana - choose wisely in combat.","Explore caves to find dungeon entrances.","Check your quest log with J for objectives.","Villages are safe zones where enemies won't follow.","Equip better gear to increase your stats.","World bosses drop legendary equipment.","Save often - the world is dangerous."],rs={IDLE:"idle",CONFIRMING:"confirming",TRANSITIONING:"transitioning",LOADING:"loading",ARRIVING:"arriving"};class KT{constructor(){this.state=rs.IDLE,this.discoveredLocations=new Map,this.targetLocation=null,this.player=null,this.gameManager=null,this.saveManager=null,this.dungeonManager=null,this.enemyManager=null,this.terrain=null,this.world=null,this.audioManager=null,this.minimapManager=null,this.fadeOutDuration=1e3,this.loadingMinDuration=1500,this.fadeInDuration=1e3,this.transitionStartTime=0,this.loadingStartTime=0,this.currentTip="",this._createUI(),this._loadDiscovered(),console.log("[FastTravelManager] Initialized")}init(e){this.player=e.player,this.gameManager=e.gameManager,this.saveManager=e.saveManager||null,this.dungeonManager=e.dungeonManager||null,this.enemyManager=e.enemyManager||null,this.terrain=e.terrain||null,this.world=e.world||null,this.audioManager=e.audioManager||null,this.minimapManager=e.minimapManager||null,this.gameManager&&this.gameManager.bonfirePosition&&this.discoverLocation("starting_bonfire",{x:this.gameManager.bonfirePosition.x,z:this.gameManager.bonfirePosition.z,name:"Starting Bonfire",type:"bonfire"})}_createUI(){this.confirmDialog=document.createElement("div"),this.confirmDialog.id="fast-travel-confirm",this.confirmDialog.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(20, 15, 10, 0.95);
      border: 2px solid rgba(180, 140, 80, 0.7);
      border-radius: 8px;
      padding: 20px 30px;
      color: #ddd;
      font-family: 'Crimson Text', Georgia, serif;
      z-index: 2000;
      display: none;
      min-width: 300px;
      text-align: center;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
    `,this.confirmDialog.innerHTML=`
      <h3 style="color: #ffd700; margin: 0 0 15px; font-size: 18px;">Fast Travel</h3>
      <p id="travel-destination" style="margin: 10px 0; font-size: 16px;">Destination</p>
      <p id="travel-distance" style="margin: 10px 0; font-size: 13px; color: #aaa;">Distance: 0m</p>
      <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: center;">
        <button id="travel-confirm-btn" style="
          background: rgba(80, 140, 80, 0.8);
          border: 1px solid rgba(120, 180, 120, 0.6);
          color: #fff;
          padding: 8px 20px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          font-family: inherit;
        ">Travel</button>
        <button id="travel-cancel-btn" style="
          background: rgba(140, 80, 80, 0.8);
          border: 1px solid rgba(180, 120, 120, 0.6);
          color: #fff;
          padding: 8px 20px;
          border-radius: 4px;
          cursor: pointer;
          font-size: 14px;
          font-family: inherit;
        ">Cancel</button>
      </div>
      <p id="travel-warning" style="margin-top: 15px; font-size: 12px; color: #ff8888; display: none;"></p>
    `,document.body.appendChild(this.confirmDialog),document.getElementById("travel-confirm-btn").addEventListener("click",()=>this._confirmTravel()),document.getElementById("travel-cancel-btn").addEventListener("click",()=>this._cancelTravel()),this.transitionOverlay=document.createElement("div"),this.transitionOverlay.id="fast-travel-transition",this.transitionOverlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0806;
      z-index: 2500;
      opacity: 0;
      pointer-events: none;
      display: none;
    `,document.body.appendChild(this.transitionOverlay),this.loadingScreen=document.createElement("div"),this.loadingScreen.id="fast-travel-loading",this.loadingScreen.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0a0806;
      z-index: 2600;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #ddd;
      font-family: 'Crimson Text', Georgia, serif;
    `,this.loadingScreen.innerHTML=`
      <div style="text-align: center; max-width: 500px; padding: 20px;">
        <h2 style="color: #ffd700; margin-bottom: 20px; font-size: 24px;">Traveling...</h2>
        <div id="loading-destination" style="font-size: 18px; margin-bottom: 30px;">to Destination</div>
        
        <div style="width: 200px; height: 4px; background: rgba(100, 80, 60, 0.5); border-radius: 2px; margin: 20px auto;">
          <div id="loading-progress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #ffd700, #ffaa00); border-radius: 2px; transition: width 0.3s;"></div>
        </div>
        
        <div style="margin-top: 40px; padding: 15px; background: rgba(50, 40, 30, 0.6); border-radius: 6px; border-left: 3px solid #ffd700;">
          <div style="font-size: 11px; color: #888; margin-bottom: 5px;">TIP</div>
          <div id="loading-tip" style="font-size: 14px; line-height: 1.5;"></div>
        </div>
      </div>
    `,document.body.appendChild(this.loadingScreen),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.state===rs.CONFIRMING&&this._cancelTravel()})}_loadDiscovered(){try{const e=localStorage.getItem("ashen-fast-travel");if(e){const t=JSON.parse(e);for(const[i,s]of Object.entries(t))this.discoveredLocations.set(i,s);console.log(`[FastTravelManager] Loaded ${this.discoveredLocations.size} discovered locations`)}}catch(e){console.warn("[FastTravelManager] Failed to load discovered locations:",e)}}_saveDiscovered(){try{const e=Object.fromEntries(this.discoveredLocations);localStorage.setItem("ashen-fast-travel",JSON.stringify(e))}catch(e){console.warn("[FastTravelManager] Failed to save discovered locations:",e)}}discoverLocation(e,t){this.discoveredLocations.has(e)||(this.discoveredLocations.set(e,{...t,discovered:Date.now()}),this._saveDiscovered(),this._showDiscoveryNotification(t.name),console.log(`[FastTravelManager] Discovered: ${t.name}`))}_showDiscoveryNotification(e){const t=document.createElement("div");if(t.style.cssText=`
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(20, 15, 10, 0.9);
      border: 1px solid rgba(180, 140, 80, 0.6);
      border-radius: 6px;
      padding: 12px 25px;
      color: #ffd700;
      font-family: 'Crimson Text', Georgia, serif;
      font-size: 16px;
      z-index: 1500;
      animation: slideDown 0.3s ease-out, fadeOut 0.5s 2.5s forwards;
    `,t.innerHTML=`<span style="color: #ff8800;"></span> Fast Travel Unlocked: <strong>${e}</strong>`,!document.getElementById("fast-travel-animations")){const i=document.createElement("style");i.id="fast-travel-animations",i.textContent=`
        @keyframes slideDown {
          from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
          to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
          to { opacity: 0; }
        }
      `,document.head.appendChild(i)}document.body.appendChild(t),setTimeout(()=>t.remove(),3e3)}getDiscoveredLocations(){return Array.from(this.discoveredLocations.values())}isDiscovered(e){return this.discoveredLocations.has(e)}canFastTravel(){return this.gameManager&&this.gameManager.inCombat?{allowed:!1,reason:"Cannot fast travel while in combat"}:this.dungeonManager&&this.dungeonManager.isInDungeon()?{allowed:!1,reason:"Cannot fast travel inside dungeons"}:this.gameManager&&this.gameManager.isDead?{allowed:!1,reason:"Cannot fast travel while dead"}:this.gameManager&&this.gameManager.bossSpawner&&this.gameManager.bossSpawner.getCurrentBossFight()?{allowed:!1,reason:"Cannot fast travel during boss fight"}:{allowed:!0}}startTravel(e){const t=this.discoveredLocations.get(e);if(!t){console.warn(`[FastTravelManager] Unknown location: ${e}`);return}const i=this.canFastTravel();if(!i.allowed){this._showWarning(i.reason);return}let s=0;if(this.player){const n=this.player.position||this.player,a=t.x-n.x,o=t.z-n.z;s=Math.sqrt(a*a+o*o)}if(s<10){this._showWarning("You are already at this location");return}this.targetLocation={...t,id:e},this.state=rs.CONFIRMING,document.getElementById("travel-destination").textContent=t.name,document.getElementById("travel-distance").textContent=`Distance: ${Math.round(s)}m`,document.getElementById("travel-warning").style.display="none",this.confirmDialog.style.display="block",this.audioManager&&this.audioManager.play("uiOpen",{volume:.4})}_showWarning(e){const t=document.getElementById("travel-warning");if(t.textContent=e,t.style.display="block",this.state!==rs.CONFIRMING){const i=document.createElement("div");i.style.cssText=`
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(80, 40, 40, 0.9);
        border: 1px solid rgba(180, 100, 100, 0.6);
        border-radius: 4px;
        padding: 10px 20px;
        color: #ff8888;
        font-size: 14px;
        z-index: 1500;
      `,i.textContent=e,document.body.appendChild(i),setTimeout(()=>i.remove(),2500)}}_confirmTravel(){this.targetLocation&&(this.confirmDialog.style.display="none",this.state=rs.TRANSITIONING,this.transitionStartTime=performance.now(),this.audioManager&&this.audioManager.play("crucibleActivate",{volume:.5}),this.transitionOverlay.style.display="block",this.transitionOverlay.style.opacity="0",this.transitionOverlay.style.pointerEvents="auto",this._animateFadeOut())}_cancelTravel(){this.confirmDialog.style.display="none",this.targetLocation=null,this.state=rs.IDLE,this.audioManager&&this.audioManager.play("uiClose",{volume:.3})}_animateFadeOut(){const e=performance.now()-this.transitionStartTime,t=Math.min(e/this.fadeOutDuration,1);this.transitionOverlay.style.opacity=t.toString(),t<1?requestAnimationFrame(()=>this._animateFadeOut()):this._showLoading()}_showLoading(){this.state=rs.LOADING,this.loadingStartTime=performance.now(),this.currentTip=Rf[Math.floor(Math.random()*Rf.length)],document.getElementById("loading-destination").textContent=`to ${this.targetLocation.name}`,document.getElementById("loading-tip").textContent=this.currentTip,document.getElementById("loading-progress").style.width="0%",this.loadingScreen.style.display="flex",this.transitionOverlay.style.display="none",this._animateLoading()}_animateLoading(){const e=performance.now()-this.loadingStartTime,t=Math.min(e/this.loadingMinDuration,1);document.getElementById("loading-progress").style.width=`${t*100}%`,t<1?requestAnimationFrame(()=>this._animateLoading()):this._performTeleport()}_performTeleport(){if(!this.targetLocation||!this.player)return;const e=this.targetLocation;let t=0;this.terrain&&(t=this.terrain.getTerrainHeight(e.x,e.z)),this.player.position?this.player.position.set(e.x,t+.5,e.z):this.player.x!==void 0&&(this.player.x=e.x,this.player.y=t+.5,this.player.z=e.z),this.player.velocity&&this.player.velocity.set(0,0,0),this.terrain&&this.terrain.update&&this.terrain.update(e.x,e.z),this.world&&(this.world.foliage&&this.world.foliage.update&&this.world.foliage.update(e.x,e.z),this.world.villages&&this.world.villages.update&&this.world.villages.update(e.x,e.z),this.world.ruinsManager&&this.world.ruinsManager.update&&this.world.ruinsManager.update(e.x,e.z),this.world.caveManager&&this.world.caveManager.update&&this.world.caveManager.update(e.x,e.z)),this.enemyManager&&this.enemyManager.respawnEnemies&&this.enemyManager.respawnEnemies(e.x,e.z),setTimeout(()=>this._startFadeIn(),200)}_startFadeIn(){this.state=rs.ARRIVING,this.transitionStartTime=performance.now(),this.loadingScreen.style.display="none",this.transitionOverlay.style.display="block",this.transitionOverlay.style.opacity="1",this._animateFadeIn()}_animateFadeIn(){const e=performance.now()-this.transitionStartTime,t=Math.min(e/this.fadeInDuration,1);this.transitionOverlay.style.opacity=(1-t).toString(),t<1?requestAnimationFrame(()=>this._animateFadeIn()):this._completeTravel()}_completeTravel(){this.transitionOverlay.style.display="none",this.transitionOverlay.style.pointerEvents="none",this.state=rs.IDLE;const e=this.targetLocation?.name||"destination";this.targetLocation=null,this._showArrivalNotification(e),this.audioManager&&this.audioManager.play("levelUp",{volume:.4}),this.saveManager&&this.saveManager.autosave&&setTimeout(()=>{this.saveManager.autosave("fast_travel")},500),console.log(`[FastTravelManager] Arrived at ${e}`)}_showArrivalNotification(e){const t=document.createElement("div");if(t.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(20, 15, 10, 0.9);
      border: 2px solid rgba(180, 140, 80, 0.6);
      border-radius: 8px;
      padding: 20px 40px;
      color: #ffd700;
      font-family: 'Crimson Text', Georgia, serif;
      font-size: 20px;
      z-index: 1500;
      animation: arrivalPulse 2s forwards;
      text-align: center;
    `,t.innerHTML=`
      <div style="font-size: 12px; color: #888; margin-bottom: 5px;">ARRIVED AT</div>
      <div>${e}</div>
    `,!document.getElementById("arrival-animation")){const i=document.createElement("style");i.id="arrival-animation",i.textContent=`
        @keyframes arrivalPulse {
          0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
          20% { transform: translate(-50%, -50%) scale(1.05); opacity: 1; }
          30% { transform: translate(-50%, -50%) scale(1); }
          80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
      `,document.head.appendChild(i)}document.body.appendChild(t),setTimeout(()=>t.remove(),2e3)}travelToCoordinates(e,t,i="Waypoint"){const s=this.canFastTravel();if(!s.allowed){this._showWarning(s.reason);return}this.targetLocation={x:e,z:t,name:i,type:"waypoint"};let n=0;if(this.player){const a=this.player.position||this.player,o=e-a.x,r=t-a.z;n=Math.sqrt(o*o+r*r)}this.state=rs.CONFIRMING,document.getElementById("travel-destination").textContent=i,document.getElementById("travel-distance").textContent=`Distance: ${Math.round(n)}m`,document.getElementById("travel-warning").style.display="none",this.confirmDialog.style.display="block"}isTraveling(){return this.state!==rs.IDLE&&this.state!==rs.CONFIRMING}update(e){}getSaveData(){return{discoveredLocations:Object.fromEntries(this.discoveredLocations)}}loadSaveData(e){if(e&&e.discoveredLocations){this.discoveredLocations.clear();for(const[t,i]of Object.entries(e.discoveredLocations))this.discoveredLocations.set(t,i);this._saveDiscovered()}}reset(){this.discoveredLocations.clear(),this._saveDiscovered(),this.state=rs.IDLE,this.targetLocation=null,this.gameManager&&this.gameManager.bonfirePosition&&this.discoverLocation("starting_bonfire",{x:this.gameManager.bonfirePosition.x,z:this.gameManager.bonfirePosition.z,name:"Starting Bonfire",type:"bonfire"})}dispose(){this.confirmDialog&&this.confirmDialog.parentNode&&this.confirmDialog.parentNode.removeChild(this.confirmDialog),this.transitionOverlay&&this.transitionOverlay.parentNode&&this.transitionOverlay.parentNode.removeChild(this.transitionOverlay),this.loadingScreen&&this.loadingScreen.parentNode&&this.loadingScreen.parentNode.removeChild(this.loadingScreen)}}let ph=null;function ZT(){return ph||(ph=new KT),ph}const If={castle:"#555555",safe_meadow:"#7aaa60",grassland:"#5a8a40",dense_woods:"#3a6030",dark_frontier:"#4a5a40",water:"#3a5a8a",village:"#8a7a60",ruins:"#6a6a6a",cave:"#3a3a40",dungeon:"#2a2a35",default:"#4a5a40"},kf=[{id:"castle",name:"The Forsaken Keep",center:{x:0,z:0},radius:50},{id:"meadow",name:"Verdant Meadows",center:{x:100,z:50},radius:150},{id:"woods",name:"The Darkwood",center:{x:-150,z:100},radius:200},{id:"frontier",name:"Ashen Frontier",center:{x:200,z:-100},radius:250},{id:"ruins",name:"Ancient Ruins",center:{x:-50,z:-200},radius:100},{id:"lake",name:"Mirror Lake",center:{x:150,z:200},radius:80},{id:"mountains",name:"Shattered Peaks",center:{x:-200,z:-150},radius:180},{id:"swamp",name:"The Mire",center:{x:300,z:150},radius:120}],fl={player:{emoji:"",color:"#00ff88",size:16},quest:{emoji:"!",color:"#ffd700",size:14},quest_complete:{emoji:"?",color:"#00ff00",size:14},npc:{emoji:"",color:"#40ff40",size:10},village:{emoji:"",color:"#d4a56a",size:14},dungeon:{emoji:"",color:"#8040ff",size:14},boss:{emoji:"",color:"#ff0000",size:16},bonfire:{emoji:"",color:"#ff8800",size:12},crucible:{emoji:"",color:"#ffaa00",size:12},gathering:{emoji:"",color:"#40c0c0",size:8},waypoint:{emoji:"",color:"#00ffff",size:14},cave:{emoji:"",color:"#3a3a40",size:10},ruins:{emoji:"",color:"#6a6a6a",size:10}},fh=[{id:"quests",label:"Quests",icon:"!",types:["quest","quest_complete"]},{id:"npcs",label:"NPCs",icon:"",types:["npc"]},{id:"villages",label:"Villages",icon:"",types:["village"]},{id:"dungeons",label:"Dungeons",icon:"",types:["dungeon","cave"]},{id:"bonfires",label:"Bonfires",icon:"",types:["bonfire","crucible"]},{id:"gathering",label:"Resources",icon:"",types:["gathering"]},{id:"bosses",label:"Bosses",icon:"",types:["boss"]}];class JT{constructor(e={}){this.visible=!1,this.enabled=!0,this.worldBounds={minX:-500,maxX:500,minZ:-500,maxZ:500},this.zoomLevels=[.5,1,2,4],this.currentZoomIndex=1,this.zoom=this.zoomLevels[this.currentZoomIndex],this.panOffset={x:0,z:0},this.targetPanOffset={x:0,z:0},this.isDragging=!1,this.dragStart={x:0,y:0},this.panStart={x:0,z:0},this.panSpeed=300,this.keysPressed={w:!1,a:!1,s:!1,d:!1},this.filters={},fh.forEach(t=>{this.filters[t.id]=!0}),this.searchQuery="",this.searchResults=[],this.terrain=null,this.player=null,this.discoveryManager=null,this.questManager=null,this.villageManager=null,this.dungeonManager=null,this.npcManager=null,this.enemyManager=null,this.bossSpawner=null,this.gatheringManager=null,this.gameManager=null,this.minimapManager=null,this.terrainCacheCanvas=null,this.terrainCacheDirty=!0,this.lastTerrainRenderZoom=0,this.poiCache=[],this.poiCacheDirty=!0,this.animationFrame=null,this.lastFrameTime=0,this.hoveredPOI=null,this.mouseWorldPos={x:0,z:0},this._createDOM(),this._setupEventListeners()}init(e){if(this.terrain=e.terrain,this.player=e.player,this.discoveryManager=e.discoveryManager||null,this.questManager=e.questManager||null,this.villageManager=e.villageManager||null,this.dungeonManager=e.dungeonManager||null,this.npcManager=e.npcManager||null,this.enemyManager=e.enemyManager||null,this.bossSpawner=e.bossSpawner||null,this.gatheringManager=e.gatheringManager||null,this.gameManager=e.gameManager||null,this.minimapManager=e.minimapManager||null,this.terrain){const t=this.terrain.terrainSize||1e3;this.worldBounds={minX:-t/2,maxX:t/2,minZ:-t/2,maxZ:t/2}}this._renderTerrainCache()}_createDOM(){this.overlay=document.createElement("div"),this.overlay.id="world-map-overlay",this.overlay.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(10, 8, 6, 0.95);
      z-index: 2000;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      font-family: 'Cinzel', serif;
    `,this._createHeader(),this.mapContainer=document.createElement("div"),this.mapContainer.style.cssText=`
      position: absolute;
      top: 60px;
      left: 0;
      right: 250px;
      bottom: 0;
      overflow: hidden;
      cursor: grab;
    `,this.mapCanvas=document.createElement("canvas"),this.mapCanvas.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    `,this.mapCtx=this.mapCanvas.getContext("2d"),this.mapContainer.appendChild(this.mapCanvas),this.tooltip=document.createElement("div"),this.tooltip.style.cssText=`
      position: absolute;
      padding: 8px 12px;
      background: rgba(20, 15, 10, 0.95);
      border: 1px solid rgba(180, 140, 80, 0.6);
      border-radius: 4px;
      color: #e0d0b8;
      font-size: 12px;
      pointer-events: none;
      display: none;
      z-index: 100;
      max-width: 200px;
    `,this.mapContainer.appendChild(this.tooltip),this._createSidebar(),this._createCoordinatesDisplay(),this.overlay.appendChild(this.mapContainer),document.body.appendChild(this.overlay)}_createHeader(){this.header=document.createElement("div"),this.header.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(to bottom, rgba(40, 30, 20, 0.98), rgba(30, 20, 15, 0.95));
      border-bottom: 2px solid rgba(180, 140, 80, 0.4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 10;
    `;const e=document.createElement("div");e.style.cssText=`
      font-size: 24px;
      color: #ffd088;
      text-shadow: 0 0 10px rgba(255, 180, 0, 0.3);
      letter-spacing: 2px;
    `,e.textContent="WORLD MAP";const t=document.createElement("div");t.style.cssText=`
      display: flex;
      align-items: center;
      gap: 10px;
    `,this.searchInput=document.createElement("input"),this.searchInput.type="text",this.searchInput.placeholder="Search locations...",this.searchInput.style.cssText=`
      width: 200px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(180, 140, 80, 0.4);
      border-radius: 4px;
      color: #e0d0b8;
      font-family: inherit;
      font-size: 14px;
      outline: none;
    `,this.searchInput.addEventListener("input",()=>this._handleSearch()),this.searchInput.addEventListener("keydown",r=>{r.key==="Escape"&&(this.searchInput.value="",this._handleSearch(),this.searchInput.blur())}),this.searchDropdown=document.createElement("div"),this.searchDropdown.style.cssText=`
      position: absolute;
      top: 50px;
      width: 200px;
      max-height: 200px;
      overflow-y: auto;
      background: rgba(30, 25, 20, 0.98);
      border: 1px solid rgba(180, 140, 80, 0.4);
      border-radius: 4px;
      display: none;
      z-index: 20;
    `,t.style.position="relative",t.appendChild(this.searchInput),t.appendChild(this.searchDropdown);const i=document.createElement("div");i.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
    `;const s=document.createElement("button");s.textContent="",s.style.cssText=this._getButtonStyle(),s.addEventListener("click",()=>this._zoomOut()),this.zoomLabel=document.createElement("span"),this.zoomLabel.style.cssText=`
      color: #a0a0a0;
      font-size: 12px;
      min-width: 40px;
      text-align: center;
    `,this._updateZoomLabel();const n=document.createElement("button");n.textContent="+",n.style.cssText=this._getButtonStyle(),n.addEventListener("click",()=>this._zoomIn()),i.appendChild(s),i.appendChild(this.zoomLabel),i.appendChild(n);const a=document.createElement("button");a.innerHTML="",a.style.cssText=`
      ${this._getButtonStyle()}
      font-size: 18px;
      width: 36px;
      height: 36px;
    `,a.addEventListener("click",()=>this.hide());const o=document.createElement("div");o.style.cssText=`
      display: flex;
      align-items: center;
      gap: 20px;
    `,o.appendChild(t),o.appendChild(i),o.appendChild(a),this.header.appendChild(e),this.header.appendChild(o),this.overlay.appendChild(this.header)}_createSidebar(){this.sidebar=document.createElement("div"),this.sidebar.style.cssText=`
      position: absolute;
      top: 60px;
      right: 0;
      width: 250px;
      bottom: 0;
      background: rgba(25, 20, 15, 0.95);
      border-left: 2px solid rgba(180, 140, 80, 0.3);
      padding: 20px;
      overflow-y: auto;
    `;const e=document.createElement("div");e.style.cssText=`
      color: #ffd088;
      font-size: 14px;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
    `,e.textContent="Filters",this.sidebar.appendChild(e),this.filterButtons={},fh.forEach(a=>{const o=document.createElement("div");o.style.cssText=`
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 12px;
        margin-bottom: 8px;
        background: rgba(60, 50, 40, 0.6);
        border: 1px solid rgba(180, 140, 80, 0.3);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
      `,o.innerHTML=`
        <span style="font-size: 16px;">${a.icon}</span>
        <span style="color: #e0d0b8; font-size: 13px; flex: 1;">${a.label}</span>
        <span class="filter-check" style="color: #00ff88; font-size: 12px;"></span>
      `,o.addEventListener("click",()=>this._toggleFilter(a.id)),o.addEventListener("mouseenter",()=>{o.style.background="rgba(80, 70, 60, 0.6)"}),o.addEventListener("mouseleave",()=>{o.style.background=this.filters[a.id]?"rgba(60, 50, 40, 0.6)":"rgba(30, 25, 20, 0.6)"}),this.filterButtons[a.id]=o,this.sidebar.appendChild(o)});const t=document.createElement("div");t.style.cssText=`
      color: #ffd088;
      font-size: 14px;
      margin: 25px 0 15px 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    `,t.textContent="Legend",this.sidebar.appendChild(t),[{icon:"",color:"#00ff88",label:"Your Position"},{icon:"!",color:"#ffd700",label:"Active Quest"},{icon:"",color:"#d4a56a",label:"Village"},{icon:"",color:"#8040ff",label:"Dungeon"},{icon:"",color:"#ff8800",label:"Bonfire"},{icon:"",color:"#ff0000",label:"World Boss"},{icon:"",color:"#40c0c0",label:"Resource Node"},{icon:"",color:"#40ff40",label:"Friendly NPC"}].forEach(a=>{const o=document.createElement("div");o.style.cssText=`
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 0;
        color: #a0a0a0;
        font-size: 12px;
      `,o.innerHTML=`
        <span style="color: ${a.color}; font-size: 14px; width: 20px; text-align: center;">${a.icon}</span>
        <span>${a.label}</span>
      `,this.sidebar.appendChild(o)});const s=document.createElement("div");s.style.cssText=`
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(180, 140, 80, 0.2);
    `,s.innerHTML=`
      <div style="color: #ffd088; font-size: 12px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Exploration</div>
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
        <div style="width: 20px; height: 20px; background: #1a1a1a; border: 1px solid #333;"></div>
        <span style="color: #888; font-size: 11px;">Unexplored</span>
      </div>
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
        <div style="width: 20px; height: 20px; background: rgba(74, 90, 64, 0.5); border: 1px solid #555;"></div>
        <span style="color: #888; font-size: 11px;">Previously Seen</span>
      </div>
      <div style="display: flex; align-items: center; gap: 10px;">
        <div style="width: 20px; height: 20px; background: #5a8a40; border: 1px solid #777;"></div>
        <span style="color: #888; font-size: 11px;">Currently Visible</span>
      </div>
    `,this.sidebar.appendChild(s),this.explorationStats=document.createElement("div"),this.explorationStats.style.cssText=`
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    `,this.explorationStats.innerHTML=`
      <div style="color: #ffd088; font-size: 12px; margin-bottom: 10px;">Exploration Progress</div>
      <div style="color: #888; font-size: 11px;">Loading...</div>
    `,this.sidebar.appendChild(this.explorationStats);const n=document.createElement("div");n.style.cssText=`
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(180, 140, 80, 0.2);
      color: #666;
      font-size: 10px;
      line-height: 1.6;
    `,n.innerHTML=`
      <div style="color: #888; margin-bottom: 5px;">Controls:</div>
      <div> Drag or WASD to pan</div>
      <div> Scroll to zoom</div>
      <div> Click POI for details</div>
      <div> Tab or Esc to close</div>
    `,this.sidebar.appendChild(n),this.overlay.appendChild(this.sidebar)}_createCoordinatesDisplay(){this.coordsDisplay=document.createElement("div"),this.coordsDisplay.style.cssText=`
      position: absolute;
      bottom: 15px;
      left: 15px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(180, 140, 80, 0.3);
      border-radius: 4px;
      color: #888;
      font-size: 11px;
      font-family: monospace;
      pointer-events: none;
    `,this.coordsDisplay.textContent="X: 0, Z: 0",this.mapContainer.appendChild(this.coordsDisplay)}_getButtonStyle(){return`
      padding: 8px 12px;
      background: rgba(60, 50, 40, 0.8);
      border: 1px solid rgba(180, 140, 80, 0.4);
      border-radius: 4px;
      color: #e0d0b8;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    `}_setupEventListeners(){document.addEventListener("keydown",e=>this._handleKeyDown(e)),document.addEventListener("keyup",e=>this._handleKeyUp(e)),this.mapContainer.addEventListener("mousedown",e=>this._handleMouseDown(e)),this.mapContainer.addEventListener("mousemove",e=>this._handleMouseMove(e)),this.mapContainer.addEventListener("mouseup",()=>this._handleMouseUp()),this.mapContainer.addEventListener("mouseleave",()=>this._handleMouseUp()),this.mapContainer.addEventListener("wheel",e=>this._handleWheel(e)),this.mapContainer.addEventListener("click",e=>this._handleClick(e)),this.mapContainer.addEventListener("dblclick",e=>this._handleDoubleClick(e)),window.addEventListener("resize",()=>this._handleResize())}_handleKeyDown(e){if(e.key==="Tab"&&!e.ctrlKey&&!e.altKey){if(document.activeElement===this.searchInput)return;e.preventDefault(),this.toggle();return}if(e.key==="Escape"&&this.visible){e.preventDefault(),this.hide();return}if(!this.visible)return;const t=e.key.toLowerCase();["w","a","s","d"].includes(t)&&(this.keysPressed[t]=!0),t==="c"&&this._centerOnPlayer()}_handleKeyUp(e){const t=e.key.toLowerCase();["w","a","s","d"].includes(t)&&(this.keysPressed[t]=!1)}_handleMouseDown(e){e.button===0&&(this.isDragging=!0,this.dragStart={x:e.clientX,y:e.clientY},this.panStart={...this.panOffset},this.mapContainer.style.cursor="grabbing")}_handleMouseMove(e){if(this._updateMouseWorldPos(e),this.isDragging){const t=e.clientX-this.dragStart.x,i=e.clientY-this.dragStart.y;this.panOffset.x=this.panStart.x-t/this.zoom,this.panOffset.z=this.panStart.z-i/this.zoom,this._clampPan()}this._updateHover()}_handleMouseUp(){this.isDragging=!1,this.mapContainer.style.cursor="grab"}_handleWheel(e){e.preventDefault(),e.deltaY<0?this._zoomIn(e):this._zoomOut(e)}_handleClick(e){if(e.button===1||e.button===0&&e.ctrlKey){this.addPing(this.mouseWorldPos.x,this.mouseWorldPos.z),this.minimapManager&&this.minimapManager.addPing&&this.minimapManager.addPing(this.mouseWorldPos.x,this.mouseWorldPos.z);return}this.hoveredPOI&&this._showPOIDetails(this.hoveredPOI)}_handleDoubleClick(e){this.hoveredPOI&&this.hoveredPOI.canFastTravel&&this._triggerFastTravel(this.hoveredPOI)}_handleContextMenu(e){e.button===1&&e.preventDefault()}_handleResize(){this.visible&&(this.mapCanvas.width=this.mapContainer.clientWidth,this.mapCanvas.height=this.mapContainer.clientHeight,this.terrainCacheDirty=!0)}_updateMouseWorldPos(e){const t=this.mapCanvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top,n=this.mapCanvas.width/2,a=this.mapCanvas.height/2;this.mouseWorldPos={x:this.panOffset.x+(i-n)/this.zoom,z:this.panOffset.z+(s-a)/this.zoom},this.coordsDisplay.textContent=`X: ${Math.round(this.mouseWorldPos.x)}, Z: ${Math.round(this.mouseWorldPos.z)}`}_updateHover(){const e=15/this.zoom;let t=null,i=1/0;for(const s of this.poiCache){if(!this._isFilterVisible(s.type))continue;const n=s.x-this.mouseWorldPos.x,a=s.z-this.mouseWorldPos.z,o=Math.sqrt(n*n+a*a);o<e&&o<i&&(t=s,i=o)}this.hoveredPOI=t,t?this._showTooltip(t):this.tooltip.style.display="none"}_showTooltip(e){let t=`<div style="font-weight: bold; color: #ffd088; margin-bottom: 4px;">${e.name}</div>`;e.description&&(t+=`<div style="margin-bottom: 4px;">${e.description}</div>`),e.canFastTravel&&(t+='<div style="color: #888; font-size: 10px;">Double-click to fast travel</div>'),this.tooltip.innerHTML=t,this.tooltip.style.display="block",this.mapCanvas.getBoundingClientRect();let i=this.mouseWorldPos.x-this.panOffset.x,s=this.mouseWorldPos.z-this.panOffset.z;const n=i*this.zoom+this.mapCanvas.width/2+15,a=s*this.zoom+this.mapCanvas.height/2-15;this.tooltip.style.left=`${n}px`,this.tooltip.style.top=`${a}px`}_showPOIDetails(e){console.log("POI Details:",e)}_triggerFastTravel(e){this.hide(),this.minimapManager&&this.minimapManager.fastTravelManager&&this.minimapManager.fastTravelManager.requestFastTravel({x:e.x,z:e.z,name:e.name})}_zoomIn(e=null){if(this.currentZoomIndex<this.zoomLevels.length-1){const t=e?{...this.mouseWorldPos}:null;if(this.currentZoomIndex++,this.zoom=this.zoomLevels[this.currentZoomIndex],this._updateZoomLabel(),this.terrainCacheDirty=!0,t&&e){const i=this.mapCanvas.getBoundingClientRect(),s=e.clientX-i.left,n=e.clientY-i.top,a=this.mapCanvas.width/2,o=this.mapCanvas.height/2;this.panOffset.x=t.x-(s-a)/this.zoom,this.panOffset.z=t.z-(n-o)/this.zoom,this._clampPan()}}}_zoomOut(e=null){if(this.currentZoomIndex>0){const t=e?{...this.mouseWorldPos}:null;if(this.currentZoomIndex--,this.zoom=this.zoomLevels[this.currentZoomIndex],this._updateZoomLabel(),this.terrainCacheDirty=!0,t&&e){const i=this.mapCanvas.getBoundingClientRect(),s=e.clientX-i.left,n=e.clientY-i.top,a=this.mapCanvas.width/2,o=this.mapCanvas.height/2;this.panOffset.x=t.x-(s-a)/this.zoom,this.panOffset.z=t.z-(n-o)/this.zoom,this._clampPan()}}}_updateZoomLabel(){const e=Math.round(this.zoom*100);this.zoomLabel.textContent=`${e}%`}_clampPan(){const e=this.mapCanvas.width/this.zoom,t=this.mapCanvas.height/this.zoom;this.panOffset.x=Math.max(this.worldBounds.minX+e/2,Math.min(this.worldBounds.maxX-e/2,this.panOffset.x)),this.panOffset.z=Math.max(this.worldBounds.minZ+t/2,Math.min(this.worldBounds.maxZ-t/2,this.panOffset.z))}_centerOnPlayer(){this.player&&(this.panOffset.x=this.player.position.x,this.panOffset.z=this.player.position.z,this._clampPan())}_toggleFilter(e){this.filters[e]=!this.filters[e];const t=this.filterButtons[e],i=t.querySelector(".filter-check");this.filters[e]?(t.style.background="rgba(60, 50, 40, 0.6)",i.style.display="inline"):(t.style.background="rgba(30, 25, 20, 0.6)",i.style.display="none")}_isFilterVisible(e){for(const t of fh)if(t.types.includes(e))return this.filters[t.id];return!0}_handleSearch(){if(this.searchQuery=this.searchInput.value.toLowerCase().trim(),!this.searchQuery){this.searchDropdown.style.display="none",this.searchResults=[];return}this.searchResults=this.poiCache.filter(e=>e.name.toLowerCase().includes(this.searchQuery)),this.searchResults.length>0?(this.searchDropdown.innerHTML="",this.searchResults.slice(0,10).forEach(e=>{const t=document.createElement("div");t.style.cssText=`
          padding: 8px 12px;
          cursor: pointer;
          color: #e0d0b8;
          font-size: 12px;
          border-bottom: 1px solid rgba(180, 140, 80, 0.2);
        `,t.innerHTML=`
          <span style="color: ${fl[e.type]?.color||"#fff"}; margin-right: 8px;">
            ${fl[e.type]?.emoji||""}
          </span>
          ${e.name}
        `,t.addEventListener("click",()=>{this.panOffset.x=e.x,this.panOffset.z=e.z,this._clampPan(),this.searchDropdown.style.display="none",this.searchInput.value="",this.searchQuery=""}),t.addEventListener("mouseenter",()=>{t.style.background="rgba(60, 50, 40, 0.6)"}),t.addEventListener("mouseleave",()=>{t.style.background="transparent"}),this.searchDropdown.appendChild(t)}),this.searchDropdown.style.display="block"):(this.searchDropdown.innerHTML='<div style="padding: 8px 12px; color: #888; font-size: 12px;">No results found</div>',this.searchDropdown.style.display="block")}show(){if(!this.visible){if(window.AUTOSTART_MODE){console.log("[WorldMapUI] Blocked show() in autostart mode");return}this.visible=!0,this.overlay.style.display="block",this.mapCanvas.width=this.mapContainer.clientWidth,this.mapCanvas.height=this.mapContainer.clientHeight,this._centerOnPlayer(),this._refreshPOICache(),this._updateExplorationStats(),requestAnimationFrame(()=>{this.overlay.style.opacity="1"}),this._startRenderLoop(),this.terrainCacheDirty=!0}}hide(){this.visible&&(this.visible=!1,this.overlay.style.opacity="0",this.keysPressed={w:!1,a:!1,s:!1,d:!1},this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=null),setTimeout(()=>{this.overlay.style.display="none"},300))}toggle(){this.visible?this.hide():this.show()}_startRenderLoop(){const e=t=>{if(!this.visible)return;const i=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t,this._updatePan(i),this._render(),this.animationFrame=requestAnimationFrame(e)};this.lastFrameTime=performance.now(),this.animationFrame=requestAnimationFrame(e)}_updatePan(e){let t=0,i=0;this.keysPressed.w&&(i-=this.panSpeed*e),this.keysPressed.s&&(i+=this.panSpeed*e),this.keysPressed.a&&(t-=this.panSpeed*e),this.keysPressed.d&&(t+=this.panSpeed*e),(t!==0||i!==0)&&(this.panOffset.x+=t/this.zoom,this.panOffset.z+=i/this.zoom,this._clampPan())}_refreshPOICache(){if(this.poiCache=[],this.villageManager&&this.villageManager.getVillagePositions&&this.villageManager.getVillagePositions().forEach(t=>{this.poiCache.push({type:"village",name:t.name||"Village",x:t.x,z:t.z,canFastTravel:!1})}),this.dungeonManager&&this.dungeonManager.getDungeonEntrances&&this.dungeonManager.getDungeonEntrances().forEach(t=>{this.poiCache.push({type:"dungeon",name:t.name||"Dungeon",x:t.x,z:t.z,canFastTravel:!1})}),this.gameManager&&this.gameManager.getDiscoveredBonfires&&this.gameManager.getDiscoveredBonfires().forEach(t=>{this.poiCache.push({type:t.type||"bonfire",name:t.name||"Bonfire",x:t.x,z:t.z,canFastTravel:!0,description:"Fast travel point"})}),this.questManager&&this.questManager.getQuestMarkers&&this.questManager.getQuestMarkers().forEach(t=>{this.poiCache.push({type:t.complete?"quest_complete":"quest",name:t.questName||"Quest Objective",x:t.x,z:t.z,description:t.objective,canFastTravel:!1})}),this.npcManager&&this.npcManager.npcs&&this.npcManager.npcs.forEach(e=>{e.mesh&&e.mesh.position&&this.poiCache.push({type:"npc",name:e.name||"NPC",x:e.mesh.position.x,z:e.mesh.position.z,canFastTravel:!1})}),this.bossSpawner&&this.bossSpawner.activeBoss){const e=this.bossSpawner.activeBoss;e.mesh&&e.mesh.position&&this.poiCache.push({type:"boss",name:e.name||"World Boss",x:e.mesh.position.x,z:e.mesh.position.z,canFastTravel:!1})}if(this.gatheringManager&&this.gatheringManager.getActiveNodes&&this.gatheringManager.getActiveNodes().forEach(t=>{this.poiCache.push({type:"gathering",name:t.name||"Resource",x:t.x,z:t.z,canFastTravel:!1})}),this.minimapManager&&this.minimapManager.customWaypoint){const e=this.minimapManager.customWaypoint;this.poiCache.push({type:"waypoint",name:"Custom Waypoint",x:e.x,z:e.z,canFastTravel:!1})}kf.forEach(e=>{this.poiCache.push({type:"region",name:e.name,x:e.center.x,z:e.center.z,isRegion:!0,canFastTravel:!1})}),this.poiCacheDirty=!1}_updateExplorationStats(){if(!this.discoveryManager){this.explorationStats.innerHTML=`
        <div style="color: #ffd088; font-size: 12px; margin-bottom: 10px;">Exploration Progress</div>
        <div style="color: #888; font-size: 11px;">Discovery system loading...</div>
      `;return}const e=this.discoveryManager.getExplorationStats?.()||{totalPercent:0,regionsExplored:0,totalRegions:8};this.explorationStats.innerHTML=`
      <div style="color: #ffd088; font-size: 12px; margin-bottom: 10px;">Exploration Progress</div>
      <div style="color: #e0d0b8; font-size: 14px; margin-bottom: 8px;">${e.totalPercent.toFixed(1)}%</div>
      <div style="height: 6px; background: rgba(0,0,0,0.4); border-radius: 3px; overflow: hidden;">
        <div style="height: 100%; width: ${e.totalPercent}%; background: linear-gradient(to right, #4a8040, #6ac040);"></div>
      </div>
      <div style="color: #666; font-size: 10px; margin-top: 8px;">
        Regions: ${e.regionsExplored}/${e.totalRegions}
      </div>
    `}_renderTerrainCache(){if(!this.terrain)return;const e=1024;this.terrainCacheCanvas||(this.terrainCacheCanvas=document.createElement("canvas"),this.terrainCacheCanvas.width=e,this.terrainCacheCanvas.height=e);const t=this.terrainCacheCanvas.getContext("2d"),i=this.worldBounds.maxX-this.worldBounds.minX,s=this.worldBounds.maxZ-this.worldBounds.minZ;for(let n=0;n<e;n++)for(let a=0;a<e;a++){const o=this.worldBounds.minX+a/e*i,r=this.worldBounds.minZ+n/e*s,c=this.terrain.getHeightAt?.(o,r)||0,h=this.terrain.getBiomeAt?.(o,r)||"default";let d=If[h]||If.default;const u=Math.max(0,Math.min(1,(c+20)/60));d=this._adjustColorBrightness(d,.7+u*.6),t.fillStyle=d,t.fillRect(a,n,1,1)}this.terrainCacheDirty=!1,this.lastTerrainRenderZoom=this.zoom}_adjustColorBrightness(e,t){const i=parseInt(e.slice(1,3),16),s=parseInt(e.slice(3,5),16),n=parseInt(e.slice(5,7),16),a=Math.round(Math.min(255,i*t)),o=Math.round(Math.min(255,s*t)),r=Math.round(Math.min(255,n*t));return`rgb(${a}, ${o}, ${r})`}_render(){const e=this.mapCtx,t=this.mapCanvas.width,i=this.mapCanvas.height;e.fillStyle="#0a0806",e.fillRect(0,0,t,i);const s=t/2,n=i/2;this._renderTerrain(e,s,n),this._renderFogOfWar(e,s,n),this._renderQuestPaths(e,s,n),this._renderRegionNames(e,s,n),this._renderPOIs(e,s,n),this._renderPlayer(e,s,n),this._renderGrid(e,s,n),this._renderPings(e,s,n)}_renderQuestPaths(e,t,i){if(!this.questManager||!this.player||!this.filters.quests)return;const s=this.questManager.getQuestMarkers?.()||[],n=this.player.position.x,a=this.player.position.z,o=t+(n-this.panOffset.x)*this.zoom,r=i+(a-this.panOffset.z)*this.zoom;e.setLineDash([8,4]),e.lineWidth=2,s.forEach((c,h)=>{if(this.discoveryManager&&(this.discoveryManager.getFogLevel?.(c.x,c.z)??0)===1)return;const d=t+(c.x-this.panOffset.x)*this.zoom,u=i+(c.z-this.panOffset.z)*this.zoom;e.beginPath(),e.moveTo(o,r),e.lineTo(d,u);const p=e.createLinearGradient(o,r,d,u);p.addColorStop(0,"rgba(255, 215, 0, 0.3)"),p.addColorStop(1,"rgba(255, 215, 0, 0.7)"),e.strokeStyle=p,e.stroke()}),e.setLineDash([])}_renderPings(e,t,i){if(!this.pings||this.pings.length===0)return;const s=performance.now();this.pings=this.pings.filter(n=>{const a=s-n.timestamp;if(a>5e3)return!1;const o=1-a/5e3,r=1+Math.sin(a/100)*.3,c=t+(n.x-this.panOffset.x)*this.zoom,h=i+(n.z-this.panOffset.z)*this.zoom;return e.beginPath(),e.arc(c,h,12*r,0,Math.PI*2),e.strokeStyle=n.color||"#00ffff",e.lineWidth=3,e.globalAlpha=o*.8,e.stroke(),e.beginPath(),e.arc(c,h,4,0,Math.PI*2),e.fillStyle=n.color||"#00ffff",e.globalAlpha=o,e.fill(),e.globalAlpha=1,!0})}addPing(e,t,i="#00ffff"){this.pings||(this.pings=[]),this.pings.push({x:e,z:t,timestamp:performance.now(),color:i}),this.pings.length>10&&this.pings.shift()}_renderTerrain(e,t,i){if(this.terrainCacheCanvas||this._renderTerrainCache(),!this.terrainCacheCanvas)return;const s=this.worldBounds.maxX-this.worldBounds.minX,n=this.worldBounds.maxZ-this.worldBounds.minZ,a=s*this.zoom,o=n*this.zoom,r=t-(this.panOffset.x-this.worldBounds.minX)*this.zoom,c=i-(this.panOffset.z-this.worldBounds.minZ)*this.zoom;e.drawImage(this.terrainCacheCanvas,r,c,a,o)}_renderFogOfWar(e,t,i){if(!this.discoveryManager)return;const s=20,n=this.mapCanvas.width,a=this.mapCanvas.height,o=this.panOffset.x-n/(2*this.zoom),r=this.panOffset.x+n/(2*this.zoom),c=this.panOffset.z-a/(2*this.zoom),h=this.panOffset.z+a/(2*this.zoom);for(let d=Math.floor(o/s)*s;d<r;d+=s)for(let u=Math.floor(c/s)*s;u<h;u+=s){const p=this.discoveryManager.getFogLevel?.(d,u)??1;if(p===0)continue;const f=t+(d-this.panOffset.x)*this.zoom,y=i+(u-this.panOffset.z)*this.zoom,m=s*this.zoom;p===1?e.fillStyle="rgba(10, 8, 6, 0.95)":p===.5&&(e.fillStyle="rgba(10, 8, 6, 0.6)"),e.fillRect(f,y,m,m)}}_renderRegionNames(e,t,i){e.font="bold 14px Cinzel, serif",e.textAlign="center",e.textBaseline="middle",kf.forEach(s=>{const n=t+(s.center.x-this.panOffset.x)*this.zoom,a=i+(s.center.z-this.panOffset.z)*this.zoom;if(n<-100||n>this.mapCanvas.width+100||a<-50||a>this.mapCanvas.height+50)return;let o=.8;this.discoveryManager&&this.discoveryManager.isRegionDiscovered&&(this.discoveryManager.isRegionDiscovered(s.id)||(o=.2)),e.fillStyle=`rgba(0, 0, 0, ${o})`,e.fillText(s.name,n+1,a+1),e.fillStyle=`rgba(255, 208, 136, ${o})`,e.fillText(s.name,n,a)})}_renderPOIs(e,t,i){for(const s of this.poiCache){if(s.isRegion||!this._isFilterVisible(s.type)||this.discoveryManager&&(this.discoveryManager.getFogLevel?.(s.x,s.z)??0)===1)continue;const n=t+(s.x-this.panOffset.x)*this.zoom,a=i+(s.z-this.panOffset.z)*this.zoom;if(n<-20||n>this.mapCanvas.width+20||a<-20||a>this.mapCanvas.height+20)continue;const o=fl[s.type]||fl.npc;s===this.hoveredPOI&&(e.beginPath(),e.arc(n,a,o.size+4,0,Math.PI*2),e.fillStyle="rgba(255, 255, 255, 0.3)",e.fill()),e.font=`${o.size}px sans-serif`,e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillText(o.emoji,n+1,a+1),e.fillStyle=o.color,e.fillText(o.emoji,n,a)}}_renderPlayer(e,t,i){if(!this.player)return;const s=t+(this.player.position.x-this.panOffset.x)*this.zoom,n=i+(this.player.position.z-this.panOffset.z)*this.zoom,a=this.player.rotation?.y||0;e.save(),e.translate(s,n),e.rotate(-a+Math.PI),e.beginPath(),e.arc(0,0,12,0,Math.PI*2),e.fillStyle="rgba(0, 255, 136, 0.3)",e.fill(),e.beginPath(),e.moveTo(0,-10),e.lineTo(-7,8),e.lineTo(0,4),e.lineTo(7,8),e.closePath(),e.fillStyle="#00ff88",e.fill(),e.strokeStyle="#ffffff",e.lineWidth=1,e.stroke(),e.restore()}_renderGrid(e,t,i){e.strokeStyle=`rgba(180, 140, 80, ${.1})`,e.lineWidth=1;const a=this.mapCanvas.width,o=this.mapCanvas.height,r=Math.floor((this.panOffset.x-a/(2*this.zoom))/100)*100,c=Math.ceil((this.panOffset.x+a/(2*this.zoom))/100)*100,h=Math.floor((this.panOffset.z-o/(2*this.zoom))/100)*100,d=Math.ceil((this.panOffset.z+o/(2*this.zoom))/100)*100;e.beginPath();for(let u=r;u<=c;u+=100){const p=t+(u-this.panOffset.x)*this.zoom;e.moveTo(p,0),e.lineTo(p,o)}for(let u=h;u<=d;u+=100){const p=i+(u-this.panOffset.z)*this.zoom;e.moveTo(0,p),e.lineTo(a,p)}e.stroke()}update(e){}getSaveData(){return{lastZoomIndex:this.currentZoomIndex,lastPanOffset:{...this.panOffset},filters:{...this.filters}}}loadSaveData(e){e.lastZoomIndex!==void 0&&(this.currentZoomIndex=e.lastZoomIndex,this.zoom=this.zoomLevels[this.currentZoomIndex],this._updateZoomLabel()),e.lastPanOffset&&(this.panOffset={...e.lastPanOffset}),e.filters&&(this.filters={...e.filters},Object.keys(this.filters).forEach(t=>{const i=this.filterButtons[t];if(i){const s=i.querySelector(".filter-check");this.filters[t]?(i.style.background="rgba(60, 50, 40, 0.6)",s.style.display="inline"):(i.style.background="rgba(30, 25, 20, 0.6)",s.style.display="none")}}))}dispose(){this.animationFrame&&cancelAnimationFrame(this.animationFrame),this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay)}}let mh=null;function eE(l){return mh||(mh=new JT(l)),mh}const Rn=[{id:"castle",name:"The Forsaken Keep",center:{x:0,z:0},radius:50},{id:"meadow",name:"Verdant Meadows",center:{x:100,z:50},radius:150},{id:"woods",name:"The Darkwood",center:{x:-150,z:100},radius:200},{id:"frontier",name:"Ashen Frontier",center:{x:200,z:-100},radius:250},{id:"ruins",name:"Ancient Ruins",center:{x:-50,z:-200},radius:100},{id:"lake",name:"Mirror Lake",center:{x:150,z:200},radius:80},{id:"mountains",name:"Shattered Peaks",center:{x:-200,z:-150},radius:180},{id:"swamp",name:"The Mire",center:{x:300,z:150},radius:120}],Po={chunk:5,region_first:100,poi_village:50,poi_dungeon:75,poi_cave:30,poi_ruins:40,poi_bonfire:25,poi_crucible:25,poi_landmark:35,poi_shrine:50,poi_boss_arena:100,region_complete:250,world_complete:1e3};class tE{constructor(e={}){this.chunkSize=e.chunkSize||20,this.revealRadius=e.revealRadius||50,this.worldBounds={minX:-500,maxX:500,minZ:-500,maxZ:500},this.exploredChunks=new Map,this.currentlyVisibleChunks=new Set,this.discoveredPOIs=new Set,this.discoveredRegions=new Map,this.completedRegions=new Set,this.player=null,this.gameManager=null,this.questManager=null,this.villageManager=null,this.dungeonManager=null,this.onDiscovery=e.onDiscovery||null,this.lastUpdateTime=0,this.updateInterval=200,this.totalChunksExplored=0,this.totalPOIsDiscovered=0,this.notificationQueue=[],this.notificationTimeout=null,this._createNotificationDOM()}init(e){if(this.player=e.player,this.gameManager=e.gameManager,this.questManager=e.questManager,this.villageManager=e.villageManager,this.dungeonManager=e.dungeonManager,e.terrain){const t=e.terrain.terrainSize||1e3;this.worldBounds={minX:-t/2,maxX:t/2,minZ:-t/2,maxZ:t/2}}this._calculateTotalChunks(),this.player&&this._revealAroundPlayer()}_calculateTotalChunks(){const e=this.worldBounds.maxX-this.worldBounds.minX,t=this.worldBounds.maxZ-this.worldBounds.minZ;this.totalChunks=Math.ceil(e/this.chunkSize)*Math.ceil(t/this.chunkSize),this.chunksPerRegion={},Rn.forEach(i=>{const s=Math.ceil(i.radius*2/this.chunkSize);this.chunksPerRegion[i.id]=s*s*.785})}_createNotificationDOM(){this.notificationContainer=document.createElement("div"),this.notificationContainer.id="discovery-notifications",this.notificationContainer.style.cssText=`
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      z-index: 1500;
      pointer-events: none;
    `,document.body.appendChild(this.notificationContainer)}_showNotification(e,t,i=0){this._notifQueue||(this._notifQueue=[]),this._notifActive||(this._notifActive=!1),this._notifQueue.push({type:e,name:t,xpReward:i}),this._notifActive||this._showNextNotification()}_showNextNotification(){if(!this._notifQueue||this._notifQueue.length===0){this._notifActive=!1;return}this._notifActive=!0;const{type:e,name:t,xpReward:i}=this._notifQueue.shift(),s=document.createElement("div");s.style.cssText=`
      padding: 12px 24px;
      background: linear-gradient(to right, rgba(30, 25, 20, 0.95), rgba(40, 35, 25, 0.95), rgba(30, 25, 20, 0.95));
      border: 2px solid rgba(255, 200, 100, 0.6);
      border-radius: 4px;
      color: #ffd088;
      font-family: 'Cinzel', serif;
      text-align: center;
      opacity: 0;
      transform: translateY(-20px) scale(0.9);
      transition: all 0.4s ease;
      box-shadow: 0 0 20px rgba(255, 180, 0, 0.3);
    `;let n="",a="Location Discovered";switch(e){case"region":n="",a="New Region Discovered";break;case"village":n="",a="Village Discovered";break;case"dungeon":n="",a="Dungeon Discovered";break;case"cave":n="",a="Cave Discovered";break;case"ruins":n="",a="Ancient Ruins Discovered";break;case"bonfire":case"crucible":n="",a="Rest Point Discovered";break;case"boss_arena":n="",a="Boss Arena Discovered";break;case"landmark":n="",a="Landmark Discovered";break;case"region_complete":n="",a="Region Fully Explored";break;case"world_complete":n="",a="World Fully Explored";break}const o=this._notifQueue.length,r=o>0?`<div style="font-size: 10px; color: #886644; margin-top: 4px;">+${o} more</div>`:"";s.innerHTML=`
      <div style="font-size: 24px; margin-bottom: 4px;">${n}</div>
      <div style="font-size: 12px; color: #a08060; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 4px;">${a}</div>
      <div style="font-size: 16px; color: #fff; text-shadow: 0 0 10px rgba(255, 200, 100, 0.5);">${t}</div>
      ${i>0?`<div style="font-size: 11px; color: #8aff8a; margin-top: 6px;">+${i} XP</div>`:""}
      ${r}
    `,this.notificationContainer.innerHTML="",this.notificationContainer.appendChild(s),requestAnimationFrame(()=>{s.style.opacity="1",s.style.transform="translateY(0) scale(1)"}),this._playDiscoverySound(e),setTimeout(()=>{s.style.opacity="0",s.style.transform="translateY(-20px) scale(0.9)",setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s),this._showNextNotification()},400)},3e3)}_playDiscoverySound(e){}update(e){const t=performance.now();if(t-this.lastUpdateTime<this.updateInterval||(this.lastUpdateTime=t,!this.player))return;this._startTime||(this._startTime=t);const i=t-this._startTime;this._revealAroundPlayer(),!(i<5e3)&&(this._checkPOIDiscoveries(),this._checkRegionDiscoveries(),this._updateRegionProgress())}_revealAroundPlayer(){if(!this.player)return;const e=this.player.position.x,t=this.player.position.z,i=new Set(this.currentlyVisibleChunks);this.currentlyVisibleChunks.clear();const s=Math.floor((e-this.revealRadius)/this.chunkSize),n=Math.ceil((e+this.revealRadius)/this.chunkSize),a=Math.floor((t-this.revealRadius)/this.chunkSize),o=Math.ceil((t+this.revealRadius)/this.chunkSize);let r=0;for(let c=s;c<=n;c++)for(let h=a;h<=o;h++){const d=c*this.chunkSize+this.chunkSize/2,u=h*this.chunkSize+this.chunkSize/2,p=d-e,f=u-t;if(Math.sqrt(p*p+f*f)<=this.revealRadius){const m=`${c},${h}`;this.currentlyVisibleChunks.add(m),this.exploredChunks.has(m)?this.exploredChunks.set(m,0):(this.exploredChunks.set(m,0),r++,this.totalChunksExplored++)}}for(const c of i)this.currentlyVisibleChunks.has(c)||this.exploredChunks.set(c,.5);r>0&&this.gameManager}_checkPOIDiscoveries(){if(!this.player)return;const e=this.player.position.x,t=this.player.position.z,i=30;this.villageManager&&this.villageManager.getVillagePositions&&this.villageManager.getVillagePositions().forEach(n=>{const a=`village_${n.x}_${n.z}`;if(this.discoveredPOIs.has(a))return;const o=n.x-e,r=n.z-t;Math.sqrt(o*o+r*r)<i&&(this._discoverPOI("village",n.name||"Village",a),this._revealArea(n.x,n.z,50))}),this.dungeonManager&&this.dungeonManager.getDungeonEntrances&&this.dungeonManager.getDungeonEntrances().forEach(n=>{const a=`dungeon_${n.x}_${n.z}`;if(this.discoveredPOIs.has(a))return;const o=n.x-e,r=n.z-t;Math.sqrt(o*o+r*r)<i&&this._discoverPOI("dungeon",n.name||"Dungeon",a)}),this.gameManager&&this.gameManager.getDiscoveredBonfires&&this.gameManager.getDiscoveredBonfires().forEach(n=>{const a=`bonfire_${n.x}_${n.z}`;if(this.discoveredPOIs.has(a))return;const o=n.x-e,r=n.z-t;Math.sqrt(o*o+r*r)<i&&this._discoverPOI(n.type||"bonfire",n.name||"Bonfire",a)})}_discoverPOI(e,t,i){if(this.discoveredPOIs.has(i))return;this.discoveredPOIs.add(i),this.totalPOIsDiscovered++;const s=`poi_${e}`,n=Po[s]||25;this.gameManager&&this.gameManager.addXP&&this.gameManager.addXP(n),this._showNotification(e,t,n),this.onDiscovery&&this.onDiscovery({type:e,name:t,poiId:i,xpReward:n}),this.questManager&&this.questManager.checkDiscovery&&this.questManager.checkDiscovery(e,t,i)}_revealArea(e,t,i){const s=Math.floor((e-i)/this.chunkSize),n=Math.ceil((e+i)/this.chunkSize),a=Math.floor((t-i)/this.chunkSize),o=Math.ceil((t+i)/this.chunkSize);for(let r=s;r<=n;r++)for(let c=a;c<=o;c++){const h=r*this.chunkSize+this.chunkSize/2,d=c*this.chunkSize+this.chunkSize/2,u=h-e,p=d-t;if(Math.sqrt(u*u+p*p)<=i){const f=`${r},${c}`;this.exploredChunks.has(f)||(this.exploredChunks.set(f,.5),this.totalChunksExplored++)}}}_checkRegionDiscoveries(){if(!this.player)return;const e=this.player.position.x,t=this.player.position.z;Rn.forEach(i=>{if(this.discoveredRegions.has(i.id))return;const s=i.center.x-e,n=i.center.z-t;if(Math.sqrt(s*s+n*n)<i.radius){this.discoveredRegions.set(i.id,{firstVisit:Date.now(),percentExplored:0});const o=Po.region_first;this.gameManager&&this.gameManager.addXP&&this.gameManager.addXP(o),this._showNotification("region",i.name,o)}})}_updateRegionProgress(){Rn.forEach(e=>{if(!this.discoveredRegions.has(e.id))return;let t=0,i=0;const s=Math.floor((e.center.x-e.radius)/this.chunkSize),n=Math.ceil((e.center.x+e.radius)/this.chunkSize),a=Math.floor((e.center.z-e.radius)/this.chunkSize),o=Math.ceil((e.center.z+e.radius)/this.chunkSize);for(let h=s;h<=n;h++)for(let d=a;d<=o;d++){const u=h*this.chunkSize+this.chunkSize/2,p=d*this.chunkSize+this.chunkSize/2,f=u-e.center.x,y=p-e.center.z;if(Math.sqrt(f*f+y*y)<=e.radius){i++;const m=`${h},${d}`;this.exploredChunks.has(m)&&t++}}const r=i>0?t/i*100:0,c=this.discoveredRegions.get(e.id);if(c.percentExplored=r,r>=100&&!this.completedRegions.has(e.id)){this.completedRegions.add(e.id);const h=Po.region_complete;this.gameManager&&this.gameManager.addXP&&this.gameManager.addXP(h),this._showNotification("region_complete",e.name,h),this.completedRegions.size>=Rn.length&&this._onWorldComplete()}})}_onWorldComplete(){const e=Po.world_complete;this.gameManager&&this.gameManager.addXP&&this.gameManager.addXP(e),this._showNotification("world_complete","The Ashen Lands",e),this.gameManager&&this.gameManager.unlockAchievement&&this.gameManager.unlockAchievement("world_explorer")}getFogLevel(e,t){const i=Math.floor(e/this.chunkSize),s=Math.floor(t/this.chunkSize),n=`${i},${s}`;return this.currentlyVisibleChunks.has(n)?0:this.exploredChunks.has(n)?this.exploredChunks.get(n):1}isRegionDiscovered(e){return this.discoveredRegions.has(e)}getExplorationStats(){const e=this.totalChunks>0?this.totalChunksExplored/this.totalChunks*100:0,t=[];return Rn.forEach(i=>{const s=this.discoveredRegions.get(i.id);t.push({id:i.id,name:i.name,discovered:s!==void 0,percentExplored:s?.percentExplored||0,complete:this.completedRegions.has(i.id)})}),{totalPercent:Math.min(100,e),chunksExplored:this.totalChunksExplored,totalChunks:this.totalChunks,poisDiscovered:this.totalPOIsDiscovered,regionsExplored:this.discoveredRegions.size,totalRegions:Rn.length,regionsComplete:this.completedRegions.size,regions:t}}getCurrentRegion(){if(!this.player)return null;const e=this.player.position.x,t=this.player.position.z;let i=null,s=1/0;return Rn.forEach(n=>{const a=n.center.x-e,o=n.center.z-t,r=Math.sqrt(a*a+o*o);r<n.radius&&r<s&&(i=n,s=r)}),i}markPOIDiscovered(e,t,i,s,n=!1){const a=`${e}_${i}_${s}`;if(!this.discoveredPOIs.has(a)&&(this.discoveredPOIs.add(a),this.totalPOIsDiscovered++,!n)){const o=`poi_${e}`,r=Po[o]||25;this._showNotification(e,t,r)}}revealAll(){const e=Math.floor(this.worldBounds.minX/this.chunkSize),t=Math.ceil(this.worldBounds.maxX/this.chunkSize),i=Math.floor(this.worldBounds.minZ/this.chunkSize),s=Math.ceil(this.worldBounds.maxZ/this.chunkSize);for(let n=e;n<=t;n++)for(let a=i;a<=s;a++){const o=`${n},${a}`;this.exploredChunks.has(o)||(this.exploredChunks.set(o,.5),this.totalChunksExplored++)}Rn.forEach(n=>{this.discoveredRegions.has(n.id)||this.discoveredRegions.set(n.id,{firstVisit:Date.now(),percentExplored:100})}),console.log("[DiscoveryManager] Map fully revealed")}getSaveData(){const e=[];this.exploredChunks.forEach((i,s)=>{e.push({key:s,fogLevel:i})});const t=[];return this.discoveredRegions.forEach((i,s)=>{t.push({id:s,...i})}),{exploredChunks:e,discoveredPOIs:Array.from(this.discoveredPOIs),discoveredRegions:t,completedRegions:Array.from(this.completedRegions),totalChunksExplored:this.totalChunksExplored,totalPOIsDiscovered:this.totalPOIsDiscovered}}loadSaveData(e){this.exploredChunks.clear(),this.discoveredPOIs.clear(),this.discoveredRegions.clear(),this.completedRegions.clear(),this.currentlyVisibleChunks.clear(),e.exploredChunks&&e.exploredChunks.forEach(t=>{this.exploredChunks.set(t.key,t.fogLevel)}),e.discoveredPOIs&&e.discoveredPOIs.forEach(t=>{this.discoveredPOIs.add(t)}),e.discoveredRegions&&e.discoveredRegions.forEach(t=>{this.discoveredRegions.set(t.id,{firstVisit:t.firstVisit,percentExplored:t.percentExplored})}),e.completedRegions&&e.completedRegions.forEach(t=>{this.completedRegions.add(t)}),this.totalChunksExplored=e.totalChunksExplored||this.exploredChunks.size,this.totalPOIsDiscovered=e.totalPOIsDiscovered||this.discoveredPOIs.size,console.log(`[DiscoveryManager] Loaded: ${this.totalChunksExplored} chunks, ${this.totalPOIsDiscovered} POIs`)}dispose(){this.notificationContainer&&this.notificationContainer.parentNode&&this.notificationContainer.parentNode.removeChild(this.notificationContainer),this.notificationTimeout&&clearTimeout(this.notificationTimeout)}}let gh=null;function iE(l){return gh||(gh=new tE(l)),gh}const Pf=10,sE=15,nE=2.2;class aE{constructor(e){this.camera=e,this.enemyManager=null,this.container=document.createElement("div"),this.container.id="enemy-health-bars",this.container.style.cssText=`
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 400;
      overflow: hidden;
    `,document.body.appendChild(this.container);const t=document.createElement("style");t.textContent=`
      .enemy-hbar {
        position: absolute;
        width: 80px;
        transform: translate(-50%, -100%);
        opacity: 0;
        transition: opacity 0.25s ease;
        pointer-events: none;
      }
      .enemy-hbar.visible { opacity: 1; }
      .enemy-hbar.dying {
        opacity: 0;
        transition: opacity 0.6s ease;
      }
      .enemy-hbar-name {
        font-family: 'Cinzel', serif;
        font-size: 10px;
        color: #e0d0b0;
        text-shadow: 0 0 3px #000, 0 1px 2px #000;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 2px;
        line-height: 1.2;
      }
      .enemy-hbar-level {
        font-size: 9px;
        color: #aaa;
        margin-left: 4px;
      }
      .enemy-hbar-bg {
        width: 100%;
        height: 6px;
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(100, 40, 40, 0.6);
        border-radius: 3px;
        overflow: hidden;
      }
      .enemy-hbar-fill {
        height: 100%;
        background: linear-gradient(90deg, #aa2222, #dd4444);
        transition: width 0.15s ease;
        border-radius: 2px;
      }
    `,document.head.appendChild(t),this.pool=[];for(let i=0;i<Pf;i++){const s=this._createBarElement();this.container.appendChild(s.root),this.pool.push(s)}this._screenPos=new T}_createBarElement(){const e=document.createElement("div");e.className="enemy-hbar";const t=document.createElement("div");t.className="enemy-hbar-name",e.appendChild(t);const i=document.createElement("div");i.className="enemy-hbar-bg";const s=document.createElement("div");return s.className="enemy-hbar-fill",s.style.width="100%",i.appendChild(s),e.appendChild(i),{root:e,nameEl:t,fill:s,active:!1,enemyRef:null,dying:!1,dyingTimer:0}}setEnemyManager(e){this.enemyManager=e}_acquireBar(){for(const e of this.pool)if(!e.active)return e;return this.pool[this.pool.length-1]}_releaseBar(e){e.active=!1,e.enemyRef=null,e.dying=!1,e.dyingTimer=0,e.root.classList.remove("visible","dying")}update(e,t){if(!this.enemyManager||!t)return;const i=this.enemyManager.enemies||[],s=window.innerWidth,n=window.innerHeight,a=[];for(const r of i){if(!r.mesh||!r.mesh.visible)continue;const c=r.mesh.position,h=c.x-t.x,d=c.z-t.z,u=Math.sqrt(h*h+d*d),p=r.state!=="idle"&&r.state!=="patrol"&&r.state!=="dormant"&&r.state!=="dead",f=u<sE,y=r.health>0,m=r.isDead&&r.health<=0;(p||f)&&(y||m)&&a.push({enemy:r,dist:u,justDied:m})}a.sort((r,c)=>r.dist-c.dist);const o=new Set;for(const r of this.pool){if(!r.active)continue;if(r.dying&&(r.dyingTimer+=e,r.dyingTimer>.7)){this._releaseBar(r);continue}if(!a.find(h=>h.enemy===r.enemyRef)&&!r.dying){this._releaseBar(r);continue}r.enemyRef&&o.add(r.enemyRef)}for(const r of a){if(o.has(r.enemy))continue;if(o.size>=Pf)break;const c=this._acquireBar();c.active=!0,c.enemyRef=r.enemy,c.dying=!1,c.dyingTimer=0;const h=r.enemy.config.name||"Enemy",d=r.enemy.config.level||"";c.nameEl.innerHTML=`${h}${d?`<span class="enemy-hbar-level">Lv${d}</span>`:""}`,r.justDied&&(c.dying=!0,c.root.classList.add("dying"),c.root.classList.remove("visible")),o.add(r.enemy)}for(const r of this.pool){if(!r.active||!r.enemyRef){r.root.classList.remove("visible");continue}const c=r.enemyRef;c.isDead&&!r.dying&&(r.dying=!0,r.dyingTimer=0,r.root.classList.add("dying"),r.root.classList.remove("visible"));const h=Math.max(0,c.health/c.maxHealth);if(r.fill.style.width=`${h*100}%`,h>.5?r.fill.style.background="linear-gradient(90deg, #aa2222, #dd4444)":h>.25?r.fill.style.background="linear-gradient(90deg, #aa6622, #dd8844)":r.fill.style.background="linear-gradient(90deg, #aa2222, #ff3333)",this._screenPos.set(c.mesh.position.x,c.mesh.position.y+nE,c.mesh.position.z),this._screenPos.project(this.camera),this._screenPos.z>1){r.root.classList.remove("visible");continue}const d=(this._screenPos.x*.5+.5)*s,u=(-this._screenPos.y*.5+.5)*n;if(d<-60||d>s+60||u<-40||u>n+40){r.root.classList.remove("visible");continue}r.root.style.left=`${d}px`,r.root.style.top=`${u}px`,r.dying||r.root.classList.add("visible")}}dispose(){for(const e of this.pool)e.root.remove();this.pool=[],this.container.remove()}}const oE=10,Df=1,Lf=3;class rE{constructor(e){this.camera=e,this.container=document.createElement("div"),this.container.id="damage-numbers",this.container.style.cssText=`
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 450;
      overflow: hidden;
    `,document.body.appendChild(this.container);const t=document.createElement("style");t.textContent=`
      .dmg-num {
        position: absolute;
        font-family: 'Cinzel', serif;
        font-weight: bold;
        transform: translate(-50%, -50%);
        pointer-events: none;
        opacity: 0;
        white-space: nowrap;
        will-change: transform, opacity;
      }
    `,document.head.appendChild(t),this.pool=[];for(let i=0;i<oE;i++){const s=document.createElement("div");s.className="dmg-num",this.container.appendChild(s),this.pool.push({element:s,active:!1,worldPos:new T,age:0,duration:Df,floatSpeed:Lf})}this._screenPos=new T}spawn(e,t,i="normal"){let s=null,n=-1,a=null;for(const d of this.pool){if(!d.active){s=d;break}d.age>n&&(n=d.age,a=d)}s||(s=a),s.active=!0,s.age=0,s.duration=Df,s.floatSpeed=Lf,s.worldPos.copy(t),s.worldPos.x+=(Math.random()-.5)*.6,s.worldPos.z+=(Math.random()-.5)*.6,s.worldPos.y+=1.5;const o=Math.round(e);let r,c,h;switch(i){case"critical":r="#ffdd00",c=22,h="text-shadow: 0 0 6px #ffaa00, 0 0 12px rgba(255,200,0,0.5), 0 1px 3px #000;",s.element.textContent=`${o}!`,s.floatSpeed=3.5;break;case"player-hit":r="#ff4444",c=20,h="text-shadow: 0 0 6px #cc0000, 0 1px 3px #000;",s.element.textContent=`-${o}`,s.floatSpeed=2.5;break;default:r="#ffffff",c=18,h="text-shadow: 0 0 4px rgba(0,0,0,0.9), 0 1px 2px #000;",s.element.textContent=`${o}`;break}s.element.style.color=r,s.element.style.fontSize=`${c}px`,s.element.style.cssText+=h,s.element.style.opacity="1"}update(e){const t=window.innerWidth,i=window.innerHeight;for(const s of this.pool){if(!s.active)continue;s.age+=e,s.worldPos.y+=s.floatSpeed*e;const n=s.age/s.duration;if(n>=1){s.active=!1,s.element.style.opacity="0";continue}const a=.4,o=n<a?1:1-(n-a)/(1-a);s.element.style.opacity=String(Math.max(0,o));const r=n<.1?.5+n*5:1-n*.2;if(this._screenPos.copy(s.worldPos).project(this.camera),this._screenPos.z>1){s.element.style.opacity="0";continue}const c=(this._screenPos.x*.5+.5)*t,h=(-this._screenPos.y*.5+.5)*i;if(c<-50||c>t+50||h<-50||h>i+50){s.element.style.opacity="0";continue}s.element.style.left=`${c}px`,s.element.style.top=`${h}px`,s.element.style.transform=`translate(-50%, -50%) scale(${r.toFixed(2)})`}}dispose(){for(const e of this.pool)e.element.remove();this.pool=[],this.container.remove()}}const lE=30,cE=4,Of=.3,Nf=4,Bf=.35,yh=4;class hE{constructor(e,t){this.scene=e,this.camera=t,this.geometry=new re(.08,Nf,Nf),this.materials=[new B({color:16777164,transparent:!0,opacity:1}),new B({color:16768392,transparent:!0,opacity:1}),new B({color:16755268,transparent:!0,opacity:1}),new B({color:16777215,transparent:!0,opacity:1})],this.pool=[];for(let i=0;i<lE;i++){const s=this.materials[i%this.materials.length].clone(),n=new w(this.geometry,s);n.visible=!1,e.add(n),this.pool.push({mesh:n,active:!1,age:0,duration:Of,velocity:new T,startPos:new T})}this._shakeActive=!1,this._shakeTimer=0,this._shakeDuration=.1,this._shakeIntensity=.15,this._origCamPos=new T}spawnBurst(e){let t=0;for(const i of this.pool)if(!i.active){if(t>=cE)break;i.active=!0,i.age=0,i.duration=Of+Math.random()*.1,i.startPos.set(e.x+(Math.random()-.5)*.3,e.y+.8+Math.random()*.5,e.z+(Math.random()-.5)*.3),i.mesh.position.copy(i.startPos),i.velocity.set((Math.random()-.5)*yh,Math.random()*yh*.8+1,(Math.random()-.5)*yh),i.mesh.scale.setScalar(.5),i.mesh.material.opacity=1,i.mesh.visible=!0,t++}}screenShake(){this._shakeActive=!0,this._shakeTimer=0}update(e){for(const t of this.pool){if(!t.active)continue;t.age+=e;const i=t.age/t.duration;if(i>=1){t.active=!1,t.mesh.visible=!1;continue}t.mesh.position.x+=t.velocity.x*e,t.mesh.position.y+=t.velocity.y*e,t.mesh.position.z+=t.velocity.z*e,t.velocity.y-=8*e;const s=i<.3?.5+i*(Bf/.3):Bf*(1-(i-.3)/.7);t.mesh.scale.setScalar(Math.max(.01,s)),t.mesh.material.opacity=1-i}if(this._shakeActive)if(this._shakeTimer+=e,this._shakeTimer>=this._shakeDuration)this._shakeActive=!1;else{const t=this._shakeIntensity*(1-this._shakeTimer/this._shakeDuration);this.camera.position.x+=(Math.random()-.5)*t,this.camera.position.y+=(Math.random()-.5)*t*.5}}dispose(){for(const e of this.pool)this.scene.remove(e.mesh),e.mesh.geometry.dispose(),e.mesh.material.dispose();this.pool=[],this.geometry.dispose();for(const e of this.materials)e.dispose()}}const dE=12,uE=3.2,pE=40;class fE{constructor(e){this.camera=e,this.npcQuestGivers=null,this.container=document.createElement("div"),this.container.id="npc-quest-markers",this.container.style.cssText=`
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 380;
      overflow: hidden;
    `,document.body.appendChild(this.container);const t=document.createElement("style");t.textContent=`
      .npc-qm {
        position: absolute;
        transform: translate(-50%, -100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        text-align: center;
      }
      .npc-qm.visible { opacity: 1; }
      .npc-qm-icon {
        font-size: 24px;
        font-weight: bold;
        font-family: 'Georgia', serif;
        line-height: 1;
        animation: npcQmBob 2s ease-in-out infinite;
        text-shadow: 0 0 8px currentColor, 0 2px 4px rgba(0,0,0,0.8);
      }
      .npc-qm-icon.quest-available {
        color: #ffdd00;
      }
      .npc-qm-icon.quest-turnin {
        color: #ffdd00;
      }
      .npc-qm-icon.quest-progress {
        color: #aaaaaa;
      }
      .npc-qm-name {
        font-family: 'Cinzel', serif;
        font-size: 10px;
        color: #ccbb99;
        text-shadow: 0 1px 3px #000;
        white-space: nowrap;
        margin-top: 2px;
      }
      @keyframes npcQmBob {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-6px); }
      }
    `,document.head.appendChild(t),this.pool=[];for(let i=0;i<dE;i++){const s=document.createElement("div");s.className="npc-qm";const n=document.createElement("div");n.className="npc-qm-icon",s.appendChild(n);const a=document.createElement("div");a.className="npc-qm-name",s.appendChild(a),this.container.appendChild(s),this.pool.push({root:s,icon:n,name:a,active:!1,npcId:null})}this._screenPos=new T}setNPCQuestGivers(e){this.npcQuestGivers=e}update(e,t){if(!this.npcQuestGivers||!t){for(const o of this.pool)o.root.classList.remove("visible");return}const i=window.innerWidth,s=window.innerHeight,n=this.npcQuestGivers.npcs,a=[];n.forEach(o=>{if(!o.marker||!o.marker.visible||o.markerType==="none")return;const r=o.getPosition(),c=r.x-t.x,h=r.z-t.z,d=Math.sqrt(c*c+h*h);d>pE||a.push({npc:o,dist:d})}),a.sort((o,r)=>o.dist-r.dist);for(let o=0;o<this.pool.length;o++){const r=this.pool[o];if(o<a.length){const{npc:c}=a[o];r.active=!0,r.npcId=c.id;let h,d;switch(c.markerType){case"quest_available":case"daily":h="!",d="quest-available";break;case"turn_in":h="?",d="quest-turnin";break;case"in_progress":h="?",d="quest-progress";break;default:r.root.classList.remove("visible"),r.active=!1;continue}r.icon.textContent=h,r.icon.className=`npc-qm-icon ${d}`,r.name.textContent=c.npcData.name||"";const u=c.getPosition();if(this._screenPos.set(u.x,u.y+uE,u.z),this._screenPos.project(this.camera),this._screenPos.z>1){r.root.classList.remove("visible");continue}const p=(this._screenPos.x*.5+.5)*i,f=(-this._screenPos.y*.5+.5)*s;if(p<-40||p>i+40||f<-40||f>s+40){r.root.classList.remove("visible");continue}r.root.style.left=`${p}px`,r.root.style.top=`${f}px`,r.root.classList.add("visible")}else r.root.classList.remove("visible"),r.active=!1}}dispose(){for(const e of this.pool)e.root.remove();this.pool=[],this.container.remove()}}class mE{constructor(e){this.game=e,this.results=[],this.currentTest=null,this.testQueue=[],this.isRunning=!1,window.GameTester=this,this.checkAutotest()}checkAutotest(){const t=new URLSearchParams(window.location.search).get("autotest");t&&setTimeout(()=>{if(t==="all")this.runAll();else{const i=t.split(",").map(s=>s.trim());this.runTests(i)}},3e3)}log(e,t,i={}){const s={type:e,test:this.currentTest,message:t,timestamp:Date.now(),...i};return console.log(`[GameTester] ${JSON.stringify(s)}`),s}async runAll(){const e=["init","movement","combat","minimap","worldmap","inventory","hud","save-load"];return this.runTests(e)}async runTests(e){if(this.isRunning){this.log("error","Tests already running");return}this.isRunning=!0,this.results=[],this.log("start",`Starting test suite: ${e.join(", ")}`);for(const t of e)await this.runSingleTest(t),await this.sleep(500);return this.isRunning=!1,this.reportSummary(),this.results}async run(e){return this.runTests([e])}async runSingleTest(e){this.currentTest=e;const t=Date.now();try{this.log("test-start",`Running test: ${e}`);const i=this[`test_${e.replace(/-/g,"_")}`];if(!i)throw new Error(`Unknown test: ${e}`);const s=await i.call(this),n=Date.now()-t;this.results.push({test:e,status:s.pass?"PASS":"FAIL",duration:n,details:s}),this.log(s.pass?"pass":"fail",s.message,{duration:n,details:s})}catch(i){const s=Date.now()-t;this.results.push({test:e,status:"ERROR",duration:s,error:i.message}),this.log("error",`Test error: ${i.message}`,{duration:s,stack:i.stack})}this.currentTest=null}reportSummary(){const e=this.results.filter(n=>n.status==="PASS").length,t=this.results.filter(n=>n.status==="FAIL").length,i=this.results.filter(n=>n.status==="ERROR").length,s={type:"summary",total:this.results.length,passed:e,failed:t,errors:i,success:t===0&&i===0,results:this.results};return console.log(`[GameTester] ${JSON.stringify(s)}`),console.log(`
========== TEST RESULTS ==========`),console.log(`Total: ${this.results.length} | Pass: ${e} | Fail: ${t} | Error: ${i}`),this.results.forEach(n=>{const a=n.status==="PASS"?"":n.status==="FAIL"?"":"";console.log(`${a} ${n.test}: ${n.status} (${n.duration}ms)`)}),console.log(`==================================
`),s}sleep(e){return new Promise(t=>setTimeout(t,e))}async test_init(){const e={gameExists:!!this.game,sceneExists:!!this.game?.scene,cameraExists:!!this.game?.camera,rendererExists:!!this.game?.renderer,playerExists:!!this.game?.player,worldExists:!!this.game?.world||!!this.game?.terrain},t=Object.values(e).every(i=>i);return{pass:t,message:t?"Game initialized correctly":"Missing core components",checks:e}}async test_movement(){const e=this.game?.player;if(!e)return{pass:!1,message:"No player found"};const t=e.position?{x:e.position.x,y:e.position.y,z:e.position.z}:{x:e.x,y:e.y,z:e.z||0};this.simulateKey("w",500),await this.sleep(600);const i=e.position?{x:e.position.x,y:e.position.y,z:e.position.z}:{x:e.x,y:e.y,z:e.z||0},s=Math.abs(i.x-t.x)>.1||Math.abs(i.z-t.z)>.1||Math.abs(i.y-t.y)>.1;return{pass:s,message:s?"Player movement working":"Player did not move",startPos:t,endPos:i,delta:{x:i.x-t.x,y:i.y-t.y,z:i.z-t.z}}}async test_combat(){const e=this.game?.player,t=this.game?.combatSystem||this.game?.combat||window.CombatSystem;if(!e)return{pass:!1,message:"No player found"};const i=e.stamina??e.stats?.stamina??100;this.simulateKey(" ",100),await this.sleep(300);const s=e.stamina??e.stats?.stamina??100,n=s<i,a=e.isAttacking||e.state==="attacking"||e.attacking,o=n||a;return{pass:o,message:o?"Combat system responding":"Attack did not register",initialStamina:i,afterStamina:s,staminaConsumed:n,isAttacking:a,combatSystemExists:!!t}}async test_minimap(){const e=this.game?.minimapManager||this.game?.minimap||window.MinimapManager;if(!e)return{pass:!1,message:"MinimapManager not found"};const t={exists:!!e,hasCanvas:!!e.canvas||!!e.ctx,isVisible:e.visible!==!1,hasPlayerMarker:typeof e.drawPlayer=="function"||e.playerMarker!==void 0};if(typeof e.toggle=="function"){const s=e.visible;e.toggle();const n=e.visible;e.toggle(),t.toggleWorks=s!==n}const i=t.exists&&t.hasCanvas;return{pass:i,message:i?"Minimap functioning":"Minimap issues detected",checks:t}}async test_worldmap(){const e=this.game?.worldMapUI||this.game?.worldMap||window.WorldMapUI;if(!e)return{pass:!1,message:"WorldMapUI not found"};const t={exists:!!e,hasContainer:!!e.container||!!e.element,canOpen:typeof e.open=="function"||typeof e.show=="function"||typeof e.toggle=="function"};if(t.canOpen){(e.open||e.show||e.toggle).call(e),await this.sleep(200),t.isVisible=e.visible!==!1||e.container&&e.container.style.display!=="none";const n=e.close||e.hide||e.toggle;n&&n.call(e)}const i=t.exists&&t.canOpen;return{pass:i,message:i?"World map functioning":"World map issues detected",checks:t}}async test_inventory(){const e=this.game?.inventory||this.game?.inventoryManager||window.InventoryManager,t=this.game?.player,i={systemExists:!!e,playerHasInventory:!!(t?.inventory||t?.items),canAddItem:typeof e?.addItem=="function"||typeof t?.addItem=="function"};if(i.canAddItem)try{const n=e?.addItem||t?.addItem,a={id:"test_item",name:"Test Item",type:"misc"},o=e?.items?.length||t?.inventory?.length||0;n.call(e||t,a);const r=e?.items?.length||t?.inventory?.length||0;i.itemAdded=r>o,e?.removeItem?e.removeItem("test_item"):t?.removeItem&&t.removeItem("test_item")}catch(n){i.addItemError=n.message}const s=i.systemExists||i.playerHasInventory;return{pass:s,message:s?"Inventory system present":"Inventory system not found",checks:i}}async test_hud(){const e={hudElement:!!document.getElementById("hud"),healthBar:!!document.querySelector(".health-fill, .health-bar, [data-health]"),staminaBar:!!document.querySelector(".stamina-fill, .stamina-bar, [data-stamina]"),crosshair:!!document.getElementById("crosshair")||!!document.querySelector(".crosshair"),canvas:!!document.querySelector("canvas")},t=document.querySelector("canvas");if(t)try{const s=t.getContext("2d")||t.getContext("webgl")||t.getContext("webgl2");e.contextExists=!!s,e.canvasSize={width:t.width,height:t.height},e.canvasVisible=t.offsetWidth>0&&t.offsetHeight>0}catch(s){e.canvasError=s.message}const i=e.canvas&&e.hudElement;return{pass:i,message:i?"HUD elements present":"HUD issues detected",checks:e}}async test_save_load(){const e=this.game?.saveManager||this.game?.saveSystem||window.SaveManager;if(!e){const s=typeof localStorage<"u";return{pass:s,message:s?"localStorage available (no dedicated save manager)":"No save system found",checks:{hasLocalStorage:s}}}const t={exists:!!e,canSave:typeof e.save=="function"||typeof e.saveGame=="function",canLoad:typeof e.load=="function"||typeof e.loadGame=="function"};if(t.canSave)try{(e.save||e.saveGame).call(e),t.saveSucceeded=!0}catch(s){t.saveError=s.message}const i=t.exists&&t.canSave;return{pass:i,message:i?"Save system functional":"Save system issues",checks:t}}simulateKey(e,t=100){const i=this.getKeyCode(e),s=new KeyboardEvent("keydown",{key:e,code:i,keyCode:this.getKeyCodeNumber(e),bubbles:!0});document.dispatchEvent(s),t>0&&setTimeout(()=>{const n=new KeyboardEvent("keyup",{key:e,code:i,keyCode:this.getKeyCodeNumber(e),bubbles:!0});document.dispatchEvent(n)},t)}getKeyCode(e){return{w:"KeyW",a:"KeyA",s:"KeyS",d:"KeyD"," ":"Space",Space:"Space",Enter:"Enter",Escape:"Escape",Tab:"Tab",m:"KeyM",i:"KeyI",e:"KeyE"}[e]||`Key${e.toUpperCase()}`}getKeyCodeNumber(e){return{w:87,a:65,s:83,d:68," ":32,Space:32,Enter:13,Escape:27,Tab:9,m:77,i:73,e:69}[e]||e.toUpperCase().charCodeAt(0)}simulateClick(e,t){const i=document.querySelector("canvas");if(!i)return;const s=i.getBoundingClientRect(),n=new MouseEvent("click",{clientX:s.left+e,clientY:s.top+t,bubbles:!0});i.dispatchEvent(n)}getGameState(){const e=this.game?.player;return{timestamp:Date.now(),player:e?{position:e.position||{x:e.x,y:e.y,z:e.z},health:e.health??e.stats?.health,stamina:e.stamina??e.stats?.stamina,level:e.level,state:e.state}:null,world:{time:this.game?.worldTime||this.game?.timeOfDay,weather:this.game?.weather,currentArea:this.game?.currentArea||this.game?.currentRegion},ui:{minimapVisible:this.game?.minimapManager?.visible,worldMapOpen:this.game?.worldMapUI?.visible,menuOpen:this.game?.menuOpen,dialogOpen:this.game?.dialogOpen}}}dumpState(){const e=this.getGameState();return console.log(`[GameTester] STATE: ${JSON.stringify(e)}`),e}}const gE={uniforms:{tDiffuse:{value:null},brightness:{value:.05},contrast:{value:1.1},saturation:{value:1.1},vignetteIntensity:{value:.2},vignetteRadius:{value:.9}},vertexShader:`
    varying vec2 vUv;
    void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float brightness;
    uniform float contrast;
    uniform float saturation;
    uniform float vignetteIntensity;
    uniform float vignetteRadius;
    varying vec2 vUv;
    
    void main() {
      vec4 color = texture2D(tDiffuse, vUv);
      
      // Brightness
      color.rgb += brightness;
      
      // Contrast
      color.rgb = (color.rgb - 0.5) * contrast + 0.5;
      
      // Saturation
      float luminance = dot(color.rgb, vec3(0.299, 0.587, 0.114));
      color.rgb = mix(vec3(luminance), color.rgb, saturation);
      
      // Vignette - darkens edges for cinematic feel
      vec2 center = vUv - 0.5;
      float dist = length(center);
      float vignette = smoothstep(vignetteRadius, vignetteRadius - 0.4, dist);
      color.rgb *= mix(1.0 - vignetteIntensity, 1.0, vignette);
      
      // Subtle warm color grading (fantasy atmosphere)
      color.r *= 1.02;
      color.b *= 0.95;
      
      gl_FragColor = color;
    }
  `},Fi=new nM({antialias:!0,preserveDrawingBuffer:!0});Fi.setSize(window.innerWidth,window.innerHeight);Fi.setPixelRatio(Math.min(window.devicePixelRatio,2));Fi.shadowMap.enabled=!0;Fi.shadowMap.type=Wf;Fi.toneMapping=Hl;Fi.toneMappingExposure=1;Fi.outputColorSpace=pi;document.body.appendChild(Fi.domElement);const Lt=new Ug;Lt.background=new H(8900331);const gi=new Wi(60,window.innerWidth/window.innerHeight,.1,500);gi.position.set(0,20,11);gi.lookAt(0,0,0);const co=new cM(Fi),yE=new hM(Lt,gi);co.addPass(yE);const s0=new eo(new le(window.innerWidth,window.innerHeight),.15,.2,.95);co.addPass(s0);const vE=new zm(gE);co.addPass(vE);const xE=new uM;co.addPass(xE);const zf=new km,fe=new mM,mr=new gS(fe);fe.manaManager=mr;const qi=new wS(fe);fe.spellManager=qi;const Oi=new _S(fe,qi,null,null);fe.spellCaster=Oi;const kt=new I1(Fi.domElement),bt=new aS(gi),Ks=new oS(Lt),Vs=new eS(fe),gn=WS(Lt),jl=XS(Lt,Fi);jl.initialize(gn);const gr=ZS(Lt,Ks,bt);gr.initialize(gn);const Kl=aT(fe);Kl.initialize();const Zl=lT(Lt);Zl.initialize();fe.timeManager=gn;fe.dayNightLighting=jl;fe.weatherManager=gr;fe.timeWeatherGameplay=Kl;fe.rareEventManager=Zl;const ts=dT(),Nn=mT(),to=xT(),Jl=IT();fe.questManager=ts;fe.questWorldHooks=Nn;fe.questUI=to;fe.questRewards=Jl;let Ff=!1;const Gl=async()=>{Ff||(await bt.init(),bt.startAmbientMusic(),Ff=!0,document.removeEventListener("click",Gl),document.removeEventListener("keydown",Gl))};document.addEventListener("click",Gl);document.addEventListener("keydown",Gl);const Oe=new T1(Lt),Uf=new E1(Lt);new A1(Lt,Oe.terrain);const Gf=new R1(Lt,Oe.terrain),Ts=new i1(Lt,fe);Ts.initItems(Oe.getItemSpawns());const Ii=new O1(Lt,fe),es=new W1(Lt,fe,Ii);Ii.equipmentManager=es;const gs=new fS(fe,es);es.weaponManager=gs;let ra=null;const vh=new K1(Lt,Oe.terrain,Oe.ruinsManager,Oe.caveManager,Ii,es,kt),zs=new sS(fe,Ii,es,kt),ho=new US(Lt,Oe.terrain,kt,{addMaterial:(l,e)=>{const t=JSON.parse(localStorage.getItem("ashen-materials")||"{}");t[l]=(t[l]||0)+e,localStorage.setItem("ashen-materials",JSON.stringify(t))},getMaterialCount:l=>JSON.parse(localStorage.getItem("ashen-materials")||"{}")[l]||0,getAllMaterials:()=>JSON.parse(localStorage.getItem("ashen-materials")||"{}")},Ks,bt),sa=new GS(fe,zs);fe.craftingManager=sa;fe.gatheringManager=ho;const Fa=new HS(fe,sa,kt),xe=new t1(Lt,fe,kt);xe.setWorld(Oe);const Ln=new nS(gi,xe.mesh,kt);Ln.setTerrain(Oe.terrain);xe.setCameraController(Ln);ra=new mS(es,gs,Ks,Ln);gs.onAttackStart=l=>{const e=fe.getAttackSpeedMultiplier?fe.getAttackSpeedMultiplier():1;ra.startAttack(l.attackType,e)};gs.onAttackEnd=()=>{};fe.attackAnimator=ra;const hs=new g1(Lt,fe,xe,Oe,Ks,Ii);Oi.setScene(Lt);Oi.setPlayer(xe);Oi.setEnemyManager(hs);Oi.particleManager=Ks;Oi.audioManager=bt;const n0=new aE(gi);n0.setEnemyManager(hs);const a0=new rE(gi),o0=new hE(Lt,gi);fe.damageNumbers=a0;fe.hitEffects=o0;const uo=new MS(Lt,Ks);uo.setPlayer(xe);fe.spellEffects=uo;Oi.spellEffects=uo;qi.onBuffExpired=l=>{uo.removeBuffAura(l)};qi.onShieldExpired=l=>{uo.removeShieldAura()};const na=new lS(Lt,gi,kt,Oe.npcManager,fe,bt),hn=new dS(fe,Ii,es,bt),Yi=new uS(Lt,gi,kt,fe,bt);Yi.setShopCallback(l=>{hn.open(l)});Yi.setEndCallback(()=>{na.closeInteraction()});na.setShopCallback(l=>{Yi.startDialogue(l)});na.setDialogueCallback(l=>{Yi.startDialogue(l)});const r0=new rS(gi);fe.setCheckpoint(Oe.bonfirePosition.clone());fe.setEntities(xe,hs,Lt,gi);fe.bonfirePosition=Oe.bonfirePosition;fe.audioManager=bt;fe.particleManager=Ks;fe.hud=Vs;fe.cameraController=Ln;fe.itemManager=Ts;fe.floatingText=r0;fe.lootManager=Ii;fe.equipmentManager=es;fe.weaponManager=gs;fe.attackAnimator=ra;Vs.setEnemyManager(hs);const Yn=new tS(fe,kt,xe),Fo=new iS(fe,kt,xe);Vs.setStatsUI(Fo);Vs.setManaManager(mr);Vs.setSpellManager(qi);const dn=new SS(fe);fe.bossUI=dn;const Vi=CS(Lt,Oe,hs,null);fe.bossSpawner=Vi;Vi.onBossActivate=l=>{console.log(`[Main] Boss fight started: ${l.name}`),dn.showBoss(l),bt&&bt.play("bossMusic",{volume:.6,loop:!0})};Vi.onBossDefeated=(l,e)=>{console.log(`[Main] Boss defeated: ${l.name}`),dn.hideBoss();const t=!localStorage.getItem(`boss_killed_${l.id}`);Ii&&Ii.generateBossLoot(l.id,e.position,t),t&&localStorage.setItem(`boss_killed_${l.id}`,"true"),bt&&(bt.stop("bossMusic"),bt.play("victory",{volume:.7}))};Vi.initialize(xe);const vn=FS(Lt,Oe,xe,fe,kt,bt);fe.dungeonManager=vn;ts.init({inventory:Ii,stats:fe,scene:Lt});Nn.init({questManager:ts,scene:Lt,enemyManager:hs,itemManager:Ts,npcManager:Oe.npcManager,bossManager:Vi,player:xe});to.init(ts);const $s=TT(Lt);$s.init(ts);fe.npcQuestGivers=$s;const l0=new fE(gi);l0.setNPCQuestGivers($s);Jl.init(ts,Lt);const ha=GT(),c0=i0(),pu=YT();ha.init({gameManager:fe,player:xe.mesh,inventoryUI:zs,equipmentManager:es,lootManager:Ii,questManager:ts,questRewards:Jl,timeManager:gn,weatherManager:gr,craftingManager:sa,gatheringManager:ho,shopManager:hn,bossSpawner:Vi,dungeonManager:vn,spellManager:qi,manaManager:mr,npcManager:$s,scene:Lt,hud:Vs,questUI:to,renderer:Fi,camera:gi,audioManager:bt,terrain:Oe.terrain,world:Oe});c0.init(ha,Fi,Lt,gi,bt);pu.init(ha,{gameManager:fe,player:xe.mesh,enemyManager:hs,renderer:Fi,scene:Lt,camera:gi,audioManager:bt,questManager:ts,timeManager:gn});fe.saveManager=ha;fe.saveIntegration=pu;hs.onEnemyDeath=(l,e,t)=>{Nn.onEnemyKilled(l,e)};const Hf=Vi.onBossDefeated;Vi.onBossDefeated=(l,e)=>{Nn.onBossKilled(l.id,l),Hf&&Hf(l,e)};Ii.onItemPickup=(l,e)=>{Nn.onItemPickup(l,e)};const bE=Yi.startDialogue.bind(Yi);Yi.startDialogue=l=>{if(Nn.onNpcInteraction(l.id||l.name,l),$s&&$s.getNPCById(l.id||l.name?.toLowerCase().replace(/\s+/g,"_"))){$s.interactWithNPC(l.id||l.name?.toLowerCase().replace(/\s+/g,"_"));return}bE(l)};const xn=jT({size:150,padding:15});xn.init({terrain:Oe.terrain,player:xe.mesh,camera:gi,enemyManager:hs,npcManager:Oe.npcManager,questManager:ts,villageManager:Oe.villages,dungeonManager:vn,gatheringManager:ho,bossSpawner:Vi,gameManager:fe});fe.minimapManager=xn;const yr=ZT();yr.init({player:xe.mesh,gameManager:fe,saveManager:ha,dungeonManager:vn,enemyManager:hs,terrain:Oe.terrain,world:Oe,audioManager:bt,minimapManager:xn});fe.fastTravelManager=yr;xn.setFastTravelManager(yr);const io=iE({revealRadius:50,chunkSize:20});io.init({player:xe.mesh,terrain:Oe.terrain,gameManager:fe,questManager:ts,villageManager:Oe.villages,dungeonManager:vn});fe.discoveryManager=io;const fu=eE();fu.init({terrain:Oe.terrain,player:xe.mesh,discoveryManager:io,questManager:ts,villageManager:Oe.villages,dungeonManager:vn,npcManager:Oe.npcManager,enemyManager:hs,bossSpawner:Vi,gatheringManager:ho,gameManager:fe,minimapManager:xn});fe.worldMapUI=fu;const wE=new mE({scene:Lt,camera:gi,renderer:Fi,player:xe.mesh,world:Oe,terrain:Oe.terrain,enemyManager:hs,gameManager:fe,minimapManager:xn,worldMapUI:fu,discoveryManager:io,fastTravelManager:yr,questManager:ts,saveManager:ha,inventoryUI:zs,combatSystem:fe,hud:Vs});fe.gameTester=wE;window.addEventListener("resize",()=>{gi.aspect=window.innerWidth/window.innerHeight,gi.updateProjectionMatrix(),Fi.setSize(window.innerWidth,window.innerHeight),co.setSize(window.innerWidth,window.innerHeight),s0.resolution.set(window.innerWidth,window.innerHeight)});sessionStorage.getItem("ashen_controls_shown")||(sessionStorage.setItem("ashen_controls_shown","1"),setTimeout(()=>{const l=document.createElement("div");l.style.cssText=`
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      font-family: 'Cinzel', serif;
      font-size: 14px;
      color: #e0d0b0;
      text-shadow: 0 0 6px rgba(0,0,0,0.9);
      background: rgba(0, 0, 0, 0.7);
      padding: 10px 24px;
      border: 1px solid rgba(200, 180, 140, 0.3);
      border-radius: 6px;
      z-index: 600;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s ease;
      text-align: center;
      letter-spacing: 1px;
    `,l.textContent="WASD to move    Click to attack    Tab for map    E to interact",document.body.appendChild(l),requestAnimationFrame(()=>{l.style.opacity="1"}),setTimeout(()=>{l.style.opacity="0",setTimeout(()=>l.remove(),600)},8e3)},2e3));let qf=60;function h0(){requestAnimationFrame(h0);const l=Math.min(zf.getDelta(),.05);if(qf>0&&(qf--,Oe.terrain)){const m=Oe.terrain.getTerrainHeight(xe.mesh.position.x,xe.mesh.position.z);if(!isNaN(m)&&isFinite(m)){const g=m+2;xe.mesh.position.y<g&&(xe.mesh.position.y=g,xe.velocity&&(xe.velocity.y=0))}}if(kt.update(l),fe.isDead||(kt.useHealthPotion&&(Ii.useItem("health-potion"),bt&&bt.play("itemPickup",{volume:.5})),kt.useStaminaPotion&&(Ii.useItem("stamina-potion"),bt&&bt.play("itemPickup",{volume:.5})),kt.useManaPotion&&(Ii.useItem("mana-potion"),bt&&bt.play("itemPickup",{volume:.5}))),fe.updateHitstop(l))Ks.update(l*.1);else{if(!hn.isShopOpen()&&!zs.isOpen&&!Yi.isDialogueActive()&&xe.update(l),hs.update(l,xe),Ks.update(l),Oe.terrain&&Oe.terrain.update&&Oe.terrain.update(xe.mesh.position.x,xe.mesh.position.z),Oe.foliage&&Oe.foliage.update&&Oe.foliage.update(xe.mesh.position.x,xe.mesh.position.z),Oe.villages&&Oe.villages.update&&Oe.villages.update(xe.mesh.position.x,xe.mesh.position.z),Uf&&Uf.update(l,xe.mesh.position.x,xe.mesh.position.z),Gf&&Gf.update(xe.mesh.position.x,xe.mesh.position.z),Oe.ruinsManager&&Oe.ruinsManager.update&&Oe.ruinsManager.update(xe.mesh.position.x,xe.mesh.position.z),Oe.caveManager&&Oe.caveManager.update&&Oe.caveManager.update(xe.mesh.position.x,xe.mesh.position.z),vh&&vh.update&&vh.update(xe.mesh.position.x,xe.mesh.position.z,l),vn&&vn.update(l),Vi){Vi.update(l);const m=Vi.getCurrentBossFight();if(m&&dn){dn.updateHealth(m.health,m.data.stats.maxHealth),dn.updatePosture(m.posture,m.data.stats.maxPosture);const g=m.health/m.data.stats.maxHealth,x=m.data.phases.filter(v=>g<=v.threshold).pop();x&&x.id!==m.currentPhase&&(Vi.updateBossPhase(m.id,x.id,x.visualChange),dn.setPhase(x.id,m.data.phases.length))}}if(Oe.bossArena&&Oe.bossArena.active){const m=Oe.updateBossArena(l,xe.mesh.position);m>0&&!xe.isInvincible&&(fe.takeDamage(m,"magical",0,!1),xe.flashDamage(),Vs&&Vs.flashDamage(.5),Ln&&Ln.shakeLight(),Ts.showNotification("Ritual Circle burns!","damage"))}}Ln.update(l),Ts.update(xe.mesh.position),Ii.update(xe.mesh.position),gs.update(l),ra&&ra.update(l);const t=zf.elapsedTime;if(es.updateWeaponGlow(l,t),!fe.isDead&&!hn.isShopOpen()&&!zs.isOpen&&!Yi.isDialogueActive()&&(kt.cycleWeapon&&(gs.cycleWeapon(),bt&&bt.play("itemPickup",{volume:.4})),kt.weaponSlot1&&(gs.switchToSlot(0),bt&&bt.play("itemPickup",{volume:.4})),kt.weaponSlot2&&(gs.switchToSlot(1),bt&&bt.play("itemPickup",{volume:.4})),kt.weaponSlot3&&(gs.switchToSlot(2),bt&&bt.play("itemPickup",{volume:.4})),kt.weaponSlot4&&(gs.switchToSlot(3),bt&&bt.play("itemPickup",{volume:.4})),!fe.isAttacking&&!fe.isRolling&&(kt.spellSlot1&&Oi.castFromSlot(0),kt.spellSlot2&&Oi.castFromSlot(1),kt.spellSlot3&&Oi.castFromSlot(2),kt.spellSlot4&&Oi.castFromSlot(3),kt.spellSlot5&&Oi.castFromSlot(4),kt.spellSlot6&&Oi.castFromSlot(5),kt.castSpell&&Oi.castFromSlot(qi.activeSlot)),kt.selectSpellSlot1&&qi.selectSlot(0),kt.selectSpellSlot2&&qi.selectSlot(1),kt.selectSpellSlot3&&qi.selectSlot(2),kt.selectSpellSlot4&&qi.selectSlot(3),kt.selectSpellSlot5&&qi.selectSlot(4),kt.selectSpellSlot6&&qi.selectSlot(5)),es.updateEquipmentDrops(xe.mesh.position,l),!fe.isDead&&!Yn.isOpen&&!Fo.isOpen&&!zs.isOpen&&!Fa.isOpen&&!hn.isShopOpen()&&!Yi.isDialogueActive()&&na.update(xe.mesh.position,l),!fe.isDead&&!Yn.isOpen&&!Fo.isOpen&&!zs.isOpen&&!Fa.isOpen&&!hn.isShopOpen()&&!Yi.isDialogueActive()&&ho.update(xe.mesh.position.x,xe.mesh.position.z,l),Oe.villages&&sa){const m=Oe.villages.getNearbyCraftingStation(xe.mesh.position.x,xe.mesh.position.z,3.5);m?(sa.setNearbyStation(m,m),localStorage.getItem("ashen-crafting-tutorial-shown")||Fa.showTutorialHint(m.name)):sa.clearNearbyStation()}Yi.update(l),!hn.isShopOpen()&&na.interactionMode==="shop"&&na.closeInteraction(),zs.update(),Fa.update(),Vs.update(),Yn.update(),Fo.update(),fe.update(l),mr.update(l),qi.update(l),Oi.update(l),uo.update(l),dn.update(l),hn.isShopOpen()||zs.isOpen||Yi.isDialogueActive()||Yn.isOpen||Fo.isOpen||Fa.isOpen?gn.pause():gn.resume(),gn.update(l),jl.update(l,xe.mesh.position),gr.update(l,xe.mesh.position),Zl.update(l,xe.mesh.position);const s=Oe.villages?Oe.villages.getCampfires():[];if(Kl.update(l,xe.mesh.position,s),Nn.update(l,xe.mesh.position),ts.updateQuestUI(),$s&&$s.update(l),to&&to.updatePlayerPosition(xe.mesh.position),bt.updateListener(),r0.update(l),n0.update(l,xe.mesh.position),a0.update(l),o0.update(l),l0.update(l,xe.mesh.position),xn&&xn.update(l),io&&io.update(l),fe.collectBloodstain(),xe.activeAttack){const m=Oe.checkHiddenWallHit(xe.activeAttack.position,xe.activeAttack.range);m&&!m.revealed&&Oe.revealHiddenWall(m.id)}const n=Oe.getNearbyDoor(xe.mesh.position),a=document.getElementById("door-prompt"),o=document.getElementById("door-name");n&&!Yn.isOpen?(a.style.display="block",o.textContent=n.name,Ts.hasKey(n.id)?(a.classList.remove("locked"),kt.interact&&(Oe.tryOpenDoor(n.id,Ts),Ts.showNotification(`${n.name} Opened`))):(a.classList.add("locked"),o.textContent=`${n.name} (Locked)`)):a.style.display="none";const r=Oe.getNearbyLadder(xe.mesh.position),c=document.getElementById("ladder-prompt"),h=document.getElementById("ladder-name");r&&!Yn.isOpen?(c.style.display="block",h.textContent=r.id==="shortcut-ladder"?"to Cathedral":"Ladder",kt.interact&&r.id==="shortcut-ladder"&&(xe.mesh.position.set(-15,0,-12),xe.velocity.set(0,0,0),Ts.showNotification("Climbed to Cathedral"),bt.playSound("footstep"))):c.style.display="none";const d=Oe.getNearbyShortcut(xe.mesh.position),u=document.getElementById("shortcut-prompt"),p=document.getElementById("shortcut-action"),f=document.getElementById("shortcut-name");d&&!Yn.isOpen?(u.style.display="block",p.textContent="remove bar from",f.textContent="Shortcut Door",kt.interact&&Oe.unlockShortcut(d.id)&&(Ts.showNotification("Shortcut Unlocked  Path to Cathedral opened!"),bt.playSound("hit"))):u.style.display="none";const y=Oe.checkInsideIllusoryWall(xe.mesh.position);if(y&&!y.revealed){Oe.revealHiddenWall(y.id);const m=document.getElementById("illusory-notification");m.style.display="block",setTimeout(()=>{m.style.display="none"},2500),bt.playSound("hit")}if(fe.bloodstainMesh){const m=.6+Math.sin(Date.now()*.005)*.3;fe.bloodstainMesh.material.opacity=m}co.render()}try{const l=xe.mesh.position.x,e=xe.mesh.position.z;Oe.terrain&&Oe.terrain.forceGenerateAt&&Oe.terrain.forceGenerateAt(l,e);const t=Oe.terrain?Oe.terrain.getTerrainHeight(l,e):0,i=!isNaN(t)&&isFinite(t)?t:0;xe.mesh.position.y=i+2,xe.velocity&&xe.velocity.set(0,0,0);{const s=xe.mesh.position.y+1,n=14,a=.53,o=xe.mesh.position.x,r=s+n*Math.sin(a),c=xe.mesh.position.z+n*Math.cos(a);Ln.forcePosition(o,r,c),gi.lookAt(xe.mesh.position.x,s,xe.mesh.position.z)}h0()}catch(l){console.error("[ASHEN FATAL] Spawn/animate init failed:",l),window.__ashenShowError&&window.__ashenShowError("Spawn/animate: "+l.message)}window.gameManager=fe;window.player=xe;window.world=Oe;window.itemManager=Ts;window.lootManager=Ii;window.equipmentManager=es;window.inventoryUI=zs;window.audioManager=bt;window.particleManager=Ks;window.interactionManager=na;window.shopManager=hn;window.dialogueManager=Yi;window.attackAnimator=ra;window.weaponManager=gs;window.manaManager=mr;window.spellManager=qi;window.spellCaster=Oi;window.bossUI=dn;window.dungeonManager=vn;window.timeManager=gn;window.rareEventManager=Zl;window.dayNightLighting=jl;window.weatherManager=gr;window.gatheringManager=ho;window.craftingManager=sa;window.craftingUI=Fa;window.timeWeatherGameplay=Kl;window.questManager=ts;window.questWorldHooks=Nn;window.questUI=to;window.questRewards=Jl;window.npcQuestGivers=$s;window.bossSpawner=Vi;window.saveManager=ha;window.saveIntegration=pu;window.saveUI=c0;window.minimapManager=xn;window.fastTravelManager=yr;fe.playerMesh=xe.mesh;es.applyEquipmentStats();es.updateWeaponVisual();
